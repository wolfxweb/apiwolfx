{% extends "base.html" %}

{% block title %}Dashboard - GVMIA{% endblock %}

{% block content %}
<style>
/* Tooltips alinhados √† esquerda */
.tooltip-inner {
    text-align: left !important;
    max-width: 300px !important;
}

/* Cards com hover effect */
.stat-card {
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

/* Gr√°ficos responsivos */
.chart-container {
    position: relative;
    height: 300px;
}
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">üìä Dashboard de Vendas</h1>
                    <p class="text-muted mb-0">
                        Bem-vindo, {{ user.first_name }}! Acompanhe suas vendas do MercadoLibre em tempo real
                    </p>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtro de Per√≠odo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <label class="form-label mb-0 fw-bold">Per√≠odo:</label>
                        </div>
                        <div class="col-auto">
                            <select class="form-select form-select-sm" id="period-selector" onchange="handlePeriodChange()">
                                <optgroup label="üìÖ Per√≠odos Espec√≠ficos">
                                    <option value="1">Hoje</option>
                                    <option value="current_month">M√™s Atual</option>
                                    <option value="last_month">M√™s Anterior</option>
                                    <option value="current_year">Ano Atual</option>
                                </optgroup>
                                <optgroup label="üìä √öltimos Dias">
                                    <option value="7">√öltimos 7 dias</option>
                                    <option value="15">√öltimos 15 dias</option>
                                    <option value="30" selected>√öltimos 30 dias</option>
                                    <option value="60">√öltimos 60 dias</option>
                                    <option value="90">√öltimos 90 dias</option>
                                </optgroup>
                                <optgroup label="üéØ Personalizado">
                                    <option value="custom">Per√≠odo Personalizado</option>
                                </optgroup>
                            </select>
                        </div>
                        <!-- Campos de data personalizada (inicialmente ocultos) -->
                        <div class="col-auto" id="custom-date-fields" style="display: none;">
                            <div class="row g-2">
                                <div class="col-auto">
                                    <label class="form-label mb-0 small">De:</label>
                                    <input type="date" class="form-control form-control-sm" id="date-from" onchange="loadDashboard()">
                                </div>
                                <div class="col-auto">
                                    <label class="form-label mb-0 small">At√©:</label>
                                    <input type="date" class="form-control form-control-sm" id="date-to" onchange="loadDashboard()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Principais -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm stat-card">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-currency-dollar text-success fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Receita Total</h6>
                    <h3 class="mb-0 text-success" id="kpi-revenue">R$ 0,00</h3>
                    <small class="text-muted">vendas brutas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm stat-card">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-cart-check text-primary fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Pedidos</h6>
                    <h3 class="mb-0 text-primary" id="kpi-orders">0</h3>
                    <small class="text-muted">pedidos confirmados</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm stat-card">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-box-seam text-info fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Produtos Vendidos</h6>
                    <h3 class="mb-0 text-info" id="kpi-units">0</h3>
                    <small class="text-muted">unidades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm stat-card">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-graph-up-arrow text-warning fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Ticket M√©dio</h6>
                    <h3 class="mb-0 text-warning" id="kpi-avg-ticket">R$ 0,00</h3>
                    <small class="text-muted">por pedido</small>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Secund√°rios -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card border-danger stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-return-left text-danger fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">
                        Devolu√ß√µes
                        <i class="bi bi-question-circle-fill text-secondary" 
                           style="font-size: 0.75rem; cursor: help;"
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           title="Vendas em que compradores abriram reclama√ß√£o (claim) solicitando devolu√ß√£o. Pode virar media√ß√£o (mediation) quando o MercadoLibre interv√©m."></i>
                    </h6>
                    <h4 class="mb-0 text-danger" id="kpi-returns-value">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-returns-count">0</span> devolu√ß√µes</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-warning stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-x-circle text-warning fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">
                        Canceladas
                        <i class="bi bi-question-circle-fill text-secondary" 
                           style="font-size: 0.75rem; cursor: help;"
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           title="Vendas que foram pagas ‚Üí entregues ‚Üí devolvidas ‚Üí reembolsadas"></i>
                    </h6>
                    <h4 class="mb-0 text-warning" id="kpi-cancelled-value">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-cancelled-count">0</span> pedidos</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-info stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-eye text-info fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Visitas</h6>
                    <h4 class="mb-0 text-info" id="kpi-visits">0</h4>
                    <small class="text-muted">visualiza√ß√µes</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-success stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-percent text-success fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Convers√£o</h6>
                    <h4 class="mb-0 text-success" id="kpi-conversion">0%</h4>
                    <small class="text-muted">vendas/visitas</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-primary stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-shop text-primary fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Contas ML</h6>
                    <h4 class="mb-0 text-primary">{{ total_accounts }}</h4>
                    <small class="text-muted">conectadas</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-secondary stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-box text-secondary fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Produtos</h6>
                    <h4 class="mb-0 text-secondary" id="kpi-products">0</h4>
                    <small class="text-muted">an√∫ncios ativos</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Cards de Custos -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="bi bi-calculator text-warning"></i> An√°lise de Custos
            </h5>
        </div>
        <div class="col-md-2">
            <div class="card border-warning stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-currency-dollar text-warning fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Taxas ML</h6>
                    <h4 class="mb-0 text-warning" id="kpi-ml-fees">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-ml-fees-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-info stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-truck text-info fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Frete</h6>
                    <h4 class="mb-0 text-info" id="kpi-shipping">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-shipping-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-primary stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-bullseye text-primary fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Marketing</h6>
                    <h4 class="mb-0 text-primary" id="kpi-marketing">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-marketing-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-secondary stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-box-seam text-secondary fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Custo Produtos</h6>
                    <h4 class="mb-0 text-secondary" id="kpi-product-cost">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-product-cost-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-dark stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-receipt text-dark fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Impostos</h6>
                    <h4 class="mb-0 text-dark" id="kpi-taxes">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-taxes-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card border-danger stat-card">
                <div class="card-body text-center">
                    <i class="bi bi-calculator text-danger fs-4"></i>
                    <h6 class="text-muted mt-2 mb-1">Outros Custos</h6>
                    <h4 class="mb-0 text-danger" id="kpi-other-costs">R$ 0,00</h4>
                    <small class="text-muted"><span id="kpi-other-costs-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumo Financeiro -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up-arrow text-success fs-1"></i>
                    <h6 class="text-muted mt-2 mb-1">Receita Bruta</h6>
                    <h3 class="mb-0 text-success" id="kpi-gross-revenue">R$ 0,00</h3>
                    <small class="text-muted">antes dos custos</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-calculator text-warning fs-1"></i>
                    <h6 class="text-muted mt-2 mb-1">Total de Custos</h6>
                    <h3 class="mb-0 text-warning" id="kpi-total-costs">R$ 0,00</h3>
                    <small class="text-muted"><span id="kpi-total-costs-percent">0%</span> da receita</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-trophy text-primary fs-1"></i>
                    <h6 class="text-muted mt-2 mb-1">Lucro L√≠quido</h6>
                    <h3 class="mb-0 text-primary" id="kpi-net-profit">R$ 0,00</h3>
                    <small class="text-muted"><span id="kpi-net-margin">0%</span> de margem</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <!-- Gr√°fico de Vendas ao Longo do Tempo -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Evolu√ß√£o de Vendas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°fico de Status de Pedidos -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart"></i> Status dos Pedidos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico de Distribui√ß√£o de Custos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart-fill"></i> Distribui√ß√£o de Custos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="costsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-bar-chart"></i> Custos por Categoria
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="costsBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Produtos e Categorias -->
    <div class="row mb-4">
        <!-- Top 5 Produtos -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy"></i> Top 5 Produtos por Receita
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top 5 Produtos por Quantidade -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-box-seam"></i> Top 5 Produtos por Unidades
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="topUnitsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Links R√°pidos -->
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-graph-up-arrow text-primary"></i> Analytics Detalhado
                    </h5>
                    <p class="card-text">Acesse an√°lises avan√ßadas com Pareto, margem de lucro e muito mais.</p>
                    <a href="/analytics" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-right"></i> Ver Analytics
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-shop text-success"></i> Gerenciar Contas
                    </h5>
                    <p class="card-text">Gerencie suas contas e integra√ß√µes do MercadoLibre.</p>
                    <a href="/ml/accounts" class="btn btn-success btn-sm">
                        <i class="bi bi-arrow-right"></i> Ver Contas
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-box text-info"></i> Produtos
                    </h5>
                    <p class="card-text">Visualize e gerencie seus produtos sincronizados.</p>
                    <a href="/products/imported" class="btn btn-info btn-sm">
                        <i class="bi bi-arrow-right"></i> Ver Produtos
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="spinner-border text-light" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Vari√°veis globais
let salesChart = null;
let statusChart = null;
let topProductsChart = null;
let topUnitsChart = null;
let costsChart = null;
let costsBarChart = null;

// Formatar moeda
function formatBRL(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value || 0);
}

// Formatar n√∫mero
function formatNumber(value) {
    return new Intl.NumberFormat('pt-BR').format(value || 0);
}

// Mostrar loading
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'block';
}

// Esconder loading
function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Manipular mudan√ßa de per√≠odo
function handlePeriodChange() {
    const period = document.getElementById('period-selector').value;
    const customFields = document.getElementById('custom-date-fields');
    
    if (period === 'custom') {
        customFields.style.display = 'block';
        // Definir datas padr√£o (√∫ltimos 30 dias)
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
        
        document.getElementById('date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('date-to').value = today.toISOString().split('T')[0];
    } else {
        customFields.style.display = 'none';
        loadDashboard();
    }
}

// Carregar dados do dashboard
function loadDashboard() {
    const period = document.getElementById('period-selector').value;
    
    console.log('üìä Carregando dashboard para per√≠odo:', period);
    showLoading();
    
    // Tratar per√≠odos especiais - enviar como par√¢metros especiais
    let url = `/api/analytics/sales-dashboard?period=${period}`;
    
    if (period === 'current_month') {
        url += '&current_month=true';
    } else if (period === 'last_month') {
        url += '&last_month=true';
    } else if (period === 'current_year') {
        url += '&current_year=true';
    } else if (period === 'custom') {
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;
        
        if (!dateFrom || !dateTo) {
            hideLoading();
            alert('Por favor, selecione as datas de in√≠cio e fim.');
            return;
        }
        
        url += `&date_from=${dateFrom}&date_to=${dateTo}`;
    }
    
    fetch(url, {
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 401) {
            console.warn('‚ö†Ô∏è N√£o autenticado, redirecionando...');
            window.location.href = '/login';
            return Promise.reject('not_authenticated');
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        
        if (data.success) {
            console.log('‚úÖ Dados carregados:', data);
            
            // Atualizar KPIs
            document.getElementById('kpi-revenue').textContent = formatBRL(data.kpis.total_revenue);
            document.getElementById('kpi-orders').textContent = formatNumber(data.kpis.total_orders);
            document.getElementById('kpi-units').textContent = formatNumber(data.kpis.total_sold);
            document.getElementById('kpi-avg-ticket').textContent = formatBRL(data.kpis.avg_ticket);
            document.getElementById('kpi-returns-value').textContent = formatBRL(data.kpis.returns_value || 0);
            document.getElementById('kpi-returns-count').textContent = formatNumber(data.kpis.returns_count || 0);
            document.getElementById('kpi-cancelled-value').textContent = formatBRL(data.kpis.cancelled_value || 0);
            document.getElementById('kpi-cancelled-count').textContent = formatNumber(data.kpis.cancelled_orders || 0);
            document.getElementById('kpi-visits').textContent = formatNumber(data.kpis.total_visits || 0);
            document.getElementById('kpi-products').textContent = formatNumber(data.kpis.total_products || 0);
            
            // Taxa de convers√£o
            const conversionRate = data.kpis.total_visits > 0 
                ? ((data.kpis.total_sold / data.kpis.total_visits) * 100).toFixed(2)
                : 0;
            document.getElementById('kpi-conversion').textContent = conversionRate + '%';
            
            // Atualizar cards de custos
            if (data.costs) {
                document.getElementById('kpi-ml-fees').textContent = formatBRL(data.costs.ml_fees || 0);
                document.getElementById('kpi-ml-fees-percent').textContent = (data.costs.ml_fees_percent || 0).toFixed(1) + '%';
                
                document.getElementById('kpi-shipping').textContent = formatBRL(data.costs.shipping_fees || 0);
                document.getElementById('kpi-shipping-percent').textContent = (data.costs.shipping_fees_percent || 0).toFixed(1) + '%';
                
                document.getElementById('kpi-marketing').textContent = formatBRL(data.costs.marketing_cost || 0);
                document.getElementById('kpi-marketing-percent').textContent = (data.costs.marketing_percent || 0).toFixed(1) + '%';
                
                document.getElementById('kpi-product-cost').textContent = formatBRL(data.costs.product_cost || 0);
                document.getElementById('kpi-product-cost-percent').textContent = (data.costs.product_cost_percent || 0).toFixed(1) + '%';
                
                document.getElementById('kpi-taxes').textContent = formatBRL(data.costs.taxes || 0);
                document.getElementById('kpi-taxes-percent').textContent = (data.costs.taxes_percent || 0).toFixed(1) + '%';
                
                document.getElementById('kpi-other-costs').textContent = formatBRL(data.costs.other_costs || 0);
                document.getElementById('kpi-other-costs-percent').textContent = (data.costs.other_costs_percent || 0).toFixed(1) + '%';
            }
            
            // Atualizar resumo financeiro
            if (data.profit) {
                document.getElementById('kpi-gross-revenue').textContent = formatBRL(data.kpis.total_revenue || 0);
                document.getElementById('kpi-total-costs').textContent = formatBRL(data.costs.total_costs || 0);
                document.getElementById('kpi-total-costs-percent').textContent = (data.costs.total_costs_percent || 0).toFixed(1) + '%';
                document.getElementById('kpi-net-profit').textContent = formatBRL(data.profit.net_profit || 0);
                document.getElementById('kpi-net-margin').textContent = (data.profit.net_margin || 0).toFixed(1) + '%';
            }
            
            // Renderizar gr√°ficos
            renderSalesChart(data.timeline || []);
            renderStatusChart(data.kpis);
            renderTopProductsCharts(data.products || []);
            renderCostsCharts(data.costs);
        } else {
            console.error('Erro:', data.error);
            alert('Erro ao carregar dados: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        hideLoading();
        if (error !== 'not_authenticated') {
            console.error('Erro:', error);
            alert('Erro ao carregar dashboard');
        }
    });
}

// Renderizar gr√°fico de vendas ao longo do tempo
function renderSalesChart(timeline) {
    const ctx = document.getElementById('salesChart');
    
    if (salesChart) {
        salesChart.destroy();
    }
    
    // Se n√£o h√° dados de timeline, criar dados agregados
    const labels = timeline.length > 0 
        ? timeline.map(t => t.date) 
        : ['Per√≠odo'];
    
    const revenues = timeline.length > 0 
        ? timeline.map(t => t.revenue) 
        : [0];
    
    const orders = timeline.length > 0 
        ? timeline.map(t => t.orders) 
        : [0];
    
    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Receita (R$)',
                    data: revenues,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Pedidos',
                    data: orders,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Receita (R$)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Pedidos'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// Renderizar gr√°fico de status
function renderStatusChart(kpis) {
    const ctx = document.getElementById('statusChart');
    
    if (statusChart) {
        statusChart.destroy();
    }
    
    const paid = kpis.total_orders || 0;
    const cancelled = kpis.cancelled_orders || 0;
    const returns = kpis.returns_count || 0;
    
    statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Confirmados', 'Cancelados', 'Devolu√ß√µes'],
            datasets: [{
                data: [paid, cancelled, returns],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 206, 86)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

// Renderizar gr√°ficos de top produtos
function renderTopProductsCharts(products) {
    // Ordenar por receita
    const topByRevenue = [...products]
        .sort((a, b) => (b.revenue || 0) - (a.revenue || 0))
        .slice(0, 5);
    
    // Ordenar por quantidade
    const topByUnits = [...products]
        .sort((a, b) => (b.sold_quantity || 0) - (a.sold_quantity || 0))
        .slice(0, 5);
    
    // Gr√°fico por receita
    const ctxRevenue = document.getElementById('topProductsChart');
    if (topProductsChart) {
        topProductsChart.destroy();
    }
    
    topProductsChart = new Chart(ctxRevenue, {
        type: 'bar',
        data: {
            labels: topByRevenue.map(p => (p.title || 'Sem t√≠tulo').substring(0, 30) + '...'),
            datasets: [{
                label: 'Receita (R$)',
                data: topByRevenue.map(p => p.revenue || 0),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Gr√°fico por unidades
    const ctxUnits = document.getElementById('topUnitsChart');
    if (topUnitsChart) {
        topUnitsChart.destroy();
    }
    
    topUnitsChart = new Chart(ctxUnits, {
        type: 'bar',
        data: {
            labels: topByUnits.map(p => (p.title || 'Sem t√≠tulo').substring(0, 30) + '...'),
            datasets: [{
                label: 'Unidades Vendidas',
                data: topByUnits.map(p => p.sold_quantity || 0),
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgb(255, 159, 64)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Renderizar gr√°ficos de custos
function renderCostsCharts(costs) {
    if (!costs) return;
    
    // Gr√°fico de pizza - Distribui√ß√£o de Custos
    const ctxPie = document.getElementById('costsChart');
    if (costsChart) {
        costsChart.destroy();
    }
    
    const costLabels = ['Taxas ML', 'Frete', 'Marketing', 'Custo Produtos', 'Impostos', 'Outros'];
    const costValues = [
        costs.ml_fees || 0,
        costs.shipping_fees || 0,
        costs.marketing_cost || 0,
        costs.product_cost || 0,
        costs.taxes || 0,
        costs.other_costs || 0
    ];
    
    // Filtrar apenas custos > 0
    const filteredLabels = [];
    const filteredValues = [];
    const filteredColors = [
        'rgba(255, 193, 7, 0.8)',   // Taxas ML - amarelo
        'rgba(13, 202, 240, 0.8)',  // Frete - azul
        'rgba(13, 110, 253, 0.8)',  // Marketing - azul escuro
        'rgba(108, 117, 125, 0.8)', // Custo Produtos - cinza
        'rgba(33, 37, 41, 0.8)',    // Impostos - preto
        'rgba(220, 53, 69, 0.8)'    // Outros - vermelho
    ];
    
    costValues.forEach((value, index) => {
        if (value > 0) {
            filteredLabels.push(costLabels[index]);
            filteredValues.push(value);
        }
    });
    
    costsChart = new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: filteredLabels,
            datasets: [{
                data: filteredValues,
                backgroundColor: filteredColors.slice(0, filteredValues.length),
                borderColor: filteredColors.slice(0, filteredValues.length).map(color => color.replace('0.8', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${formatBRL(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Gr√°fico de barras - Custos por Categoria
    const ctxBar = document.getElementById('costsBarChart');
    if (costsBarChart) {
        costsBarChart.destroy();
    }
    
    costsBarChart = new Chart(ctxBar, {
        type: 'bar',
        data: {
            labels: costLabels,
            datasets: [{
                label: 'Valor (R$)',
                data: costValues,
                backgroundColor: [
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(13, 202, 240, 0.8)',
                    'rgba(13, 110, 253, 0.8)',
                    'rgba(108, 117, 125, 0.8)',
                    'rgba(33, 37, 41, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgb(255, 193, 7)',
                    'rgb(13, 202, 240)',
                    'rgb(13, 110, 253)',
                    'rgb(108, 117, 125)',
                    'rgb(33, 37, 41)',
                    'rgb(220, 53, 69)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${formatBRL(context.parsed.x)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Refresh dashboard
function refreshDashboard() {
    loadDashboard();
}

// Inicializar ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Dashboard carregado');
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Carregar dados
    loadDashboard();
    
    // Auto-refresh a cada 5 minutos
    setInterval(loadDashboard, 5 * 60 * 1000);
});
</script>
{% endblock %}
