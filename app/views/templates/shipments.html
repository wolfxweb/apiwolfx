{% extends "base.html" %}

{% block title %}Expedi√ß√£o de Produtos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-box-seam"></i> Expedi√ß√£o de Produtos
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="loadStats()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar Stats
                    </button>
                    <button class="btn btn-primary" onclick="syncInvoices()">
                        <i class="bi bi-arrow-clockwise"></i> Sincronizar Notas Fiscais
                    </button>
                </div>
            </div>

            <!-- Estat√≠sticas -->
            <div class="row mb-4" id="stats-container">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total de Pedidos</h6>
                                    <h3 class="mb-0" id="total-orders">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-box-seam fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Com Nota Fiscal</h6>
                                    <h3 class="mb-0" id="orders-with-invoice">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-file-earmark-text fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Sem Nota Fiscal</h6>
                                    <h3 class="mb-0" id="orders-without-invoice">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-file-earmark-x fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">% Emitidas</h6>
                                    <h3 class="mb-0" id="invoice-percentage">-</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-percent fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Empresa</label>
                            <select class="form-select" id="company-filter">
                                <option value="">Todas as empresas</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status da Nota Fiscal</label>
                            <select class="form-select" id="invoice-status-filter">
                                <option value="">Todas</option>
                                <option value="emitted">Com Nota</option>
                                <option value="pending">Sem Nota</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Buscar</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="ID do pedido, comprador...">
                                <button class="btn btn-outline-secondary" onclick="loadOrders()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs por Status -->
            <div class="card">
                <div class="card-header">
                    <ul class="nav nav-tabs card-header-tabs" id="status-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                                Pendentes <span class="badge bg-secondary ms-1" id="pending-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                                Confirmados <span class="badge bg-secondary ms-1" id="confirmed-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="paid-tab" data-bs-toggle="tab" data-bs-target="#paid" type="button" role="tab">
                                Pagos <span class="badge bg-secondary ms-1" id="paid-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="shipped-tab" data-bs-toggle="tab" data-bs-target="#shipped" type="button" role="tab">
                                Enviados <span class="badge bg-secondary ms-1" id="shipped-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="delivered-tab" data-bs-toggle="tab" data-bs-target="#delivered" type="button" role="tab">
                                Entregues <span class="badge bg-secondary ms-1" id="delivered-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                                Cancelados <span class="badge bg-secondary ms-1" id="cancelled-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="refunded-tab" data-bs-toggle="tab" data-bs-target="#refunded" type="button" role="tab">
                                Reembolsados <span class="badge bg-secondary ms-1" id="refunded-count">0</span>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="status-tab-content">
                        <!-- Tab Pendentes -->
                        <div class="tab-pane fade show active" id="pending" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Confirmados -->
                        <div class="tab-pane fade" id="confirmed" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="confirmed-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Pagos -->
                        <div class="tab-pane fade" id="paid" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paid-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Enviados -->
                        <div class="tab-pane fade" id="shipped" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shipped-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Entregues -->
                        <div class="tab-pane fade" id="delivered" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="delivered-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Cancelados -->
                        <div class="tab-pane fade" id="cancelled" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cancelled-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Reembolsados -->
                        <div class="tab-pane fade" id="refunded" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refunded-orders">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">
                                                <i class="bi bi-hourglass-split"></i> Carregando...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progresso -->
<div class="modal fade" id="progressModal" tabindex="-1" aria-labelledby="progressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="progressModalLabel">Sincronizando Notas Fiscais</h5>
            </div>
            <div class="modal-body">
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progress-bar"></div>
                </div>
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
                <p class="text-center mt-3 mb-0" id="progress-text">Iniciando sincroniza√ß√£o...</p>
                <div class="mt-3" id="progress-details" style="display: none;">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-success">
                                <i class="bi bi-check-circle"></i>
                                <div class="fw-bold" id="updated-count">0</div>
                                <small>Atualizados</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-info">
                                <i class="bi bi-info-circle"></i>
                                <div class="fw-bold" id="synced-count">0</div>
                                <small>J√° Sincronizados</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-primary">
                                <i class="bi bi-list"></i>
                                <div class="fw-bold" id="total-count">0</div>
                                <small>Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentCompanyId = null;

// Carregar dados iniciais
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadOrders();
});

// Carregar estat√≠sticas
async function loadStats() {
    try {
        const response = await fetch('/api/shipments/stats', {
            credentials: 'include'
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('total-orders').textContent = data.total_orders;
            document.getElementById('orders-with-invoice').textContent = data.orders_with_invoice;
            document.getElementById('orders-without-invoice').textContent = data.orders_without_invoice;
            document.getElementById('invoice-percentage').textContent = data.invoice_percentage + '%';
        }
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
    }
}

// Carregar pedidos
async function loadOrders() {
    console.log('üîÑ Carregando pedidos...');
    
    try {
        // Obter valor do campo de busca
        const searchValue = document.getElementById('search-input').value || '';
        const invoiceStatus = document.getElementById('invoice-status-filter').value || '';
        
        const url = `/api/shipments/pending?invoice_status=${invoiceStatus}&search=${encodeURIComponent(searchValue)}&page=1&limit=3000`;
        console.log('üì° URL:', url);
        
        const response = await fetch(url, {
            credentials: 'include'
        });
        console.log('üìä Status:', response.status);
        
        if (response.status === 401) {
            console.log('üîí Usu√°rio n√£o autenticado, redirecionando para login...');
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        console.log('üì¶ Dados recebidos:', data);
        
        if (data.success) {
            console.log('‚úÖ Sucesso! Total de pedidos:', data.orders.length);
            
            // Separar pedidos por status
            const ordersByStatus = {
                'PENDING': [],
                'CONFIRMED': [],
                'PAID': [],
                'SHIPPED': [],
                'DELIVERED': [],
                'CANCELLED': [],
                'REFUNDED': []
            };
            
            data.orders.forEach(order => {
                console.log('üìã Pedido:', order.order_id, 'Status:', order.status);
                
                // Normalizar status para mai√∫sculo
                const normalizedStatus = order.status ? order.status.toUpperCase() : 'PENDING';
                
                // Mapear status para as tabs
                let tabKey = null;
                switch(normalizedStatus) {
                    case 'PENDING':
                        tabKey = 'PENDING';
                        break;
                    case 'CONFIRMED':
                        tabKey = 'CONFIRMED';
                        break;
                    case 'PAID':
                        tabKey = 'PAID';
                        break;
                    case 'SHIPPED':
                        tabKey = 'SHIPPED';
                        break;
                    case 'DELIVERED':
                        tabKey = 'DELIVERED';
                        break;
                    case 'CANCELLED':
                        tabKey = 'CANCELLED';
                        break;
                    case 'REFUNDED':
                        tabKey = 'REFUNDED';
                        break;
                    default:
                        console.log('‚ö†Ô∏è Status n√£o mapeado:', order.status);
                        tabKey = 'PENDING';
                }
                
                if (tabKey && ordersByStatus[tabKey]) {
                    ordersByStatus[tabKey].push(order);
                }
            });
            
            // Log de todos os status √∫nicos encontrados
            const uniqueStatuses = [...new Set(data.orders.map(o => o.status))];
            console.log('üìä Status √∫nicos encontrados:', uniqueStatuses);
            
            console.log('üìä Pedidos por status:', ordersByStatus);
            
            // Renderizar cada tab
            renderOrdersByStatus('pending', ordersByStatus['PENDING']);
            renderOrdersByStatus('confirmed', ordersByStatus['CONFIRMED']);
            renderOrdersByStatus('paid', ordersByStatus['PAID']);
            renderOrdersByStatus('shipped', ordersByStatus['SHIPPED']);
            renderOrdersByStatus('delivered', ordersByStatus['DELIVERED']);
            renderOrdersByStatus('cancelled', ordersByStatus['CANCELLED']);
            renderOrdersByStatus('refunded', ordersByStatus['REFUNDED']);
            
            // Atualizar contadores das tabs
            updateStatusCounts(ordersByStatus);
            
        } else {
            console.error('‚ùå Erro na API:', data.error);
            showError('Erro ao carregar pedidos: ' + data.error);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar pedidos:', error);
        showError('Erro ao carregar pedidos: ' + error.message);
    }
}

// Renderizar pedidos por status
function renderOrdersByStatus(status, orders) {
    const tbody = document.getElementById(`${status}-orders`);
    
    if (orders.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="bi bi-inbox"></i> Nenhum pedido encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    console.log('üìã Processando', orders.length, 'pedidos...');
    console.log('üîç Primeiro pedido:', orders[0]);
    
    tbody.innerHTML = orders.map(order => `
        <tr data-order-id="${order.ml_order_id}">
            <td>
                <div class="d-flex flex-column">
                    <!-- ID do Pedido -->
                    <div class="d-flex align-items-center mb-2">
                        <span class="fw-bold text-primary me-2">${order.ml_order_id}</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('${order.ml_order_id}')" title="Copiar ID">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                    
                    <!-- Comprador -->
                    <div class="mb-2">
                        <div class="fw-bold">${order.buyer_name || order.buyer_nickname || 'N/A'}</div>
                        <small class="text-muted">${order.buyer_nickname || ''}</small>
                    </div>
                    
                    <!-- Data da Compra -->
                    <div class="mb-2">
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>${formatDate(order.date_created)} ${formatTime(order.date_created)}
                        </small>
                    </div>
                    
                    <!-- Data de Envio -->
                    <div class="mb-2">
                        ${order.shipping_date ? `
                            <small class="text-success">
                                <i class="bi bi-truck me-1"></i>Enviado: ${formatDate(order.shipping_date)} ${formatTime(order.shipping_date)}
                            </small>
                        ` : `
                            <small class="text-warning">
                                <i class="bi bi-clock me-1"></i>Aguardando envio
                            </small>
                        `}
                    </div>
                </div>
            </td>
            
            <td>
                <div class="text-center">
                    <div class="fw-bold text-success fs-5">R$ ${order.total_amount.toFixed(2)}</div>
                </div>
            </td>
            
            <td>
                <div class="d-flex flex-column align-items-center">
                    <!-- Status da Nota Fiscal -->
                    ${order.invoice_emitted ? `
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <div class="text-center">
                                <div class="fw-bold text-success">NF: ${order.invoice_number || 'N/A'}</div>
                                <small class="text-muted">S√©rie: ${order.invoice_series || ''}</small>
                            </div>
                        </div>
                    ` : `
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-x-circle text-warning me-2"></i>
                            <span class="text-warning fw-bold">Sem nota fiscal</span>
                        </div>
                    `}
                    
                    <!-- Status do Pedido -->
                    <div class="mt-2">
                        <span class="badge ${getStatusBadgeClass(order.status)} fs-6">
                            ${getStatusLabel(order.status)}
                        </span>
                    </div>
                </div>
            </td>
            
            <td>
                <div class="d-flex flex-column gap-1">
                    ${!order.invoice_emitted ? `
                        <button class="btn btn-sm btn-outline-primary" onclick="syncSingleInvoice('${order.ml_order_id}')" title="Sincronizar Nota Fiscal">
                            <i class="bi bi-arrow-clockwise me-1"></i>NF
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-outline-success" onclick="syncOrderStatus('${order.ml_order_id}')" title="Sincronizar Status">
                        <i class="bi bi-arrow-repeat me-1"></i>Status
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="showInfo('${order.ml_order_id}')" title="Ver Detalhes">
                        <i class="bi bi-info-circle me-1"></i>Detalhes
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Fun√ß√µes auxiliares para badges de status
function getStatusLabel(status) {
    const statusLabels = {
        'PENDING': 'Pendente',
        'CONFIRMED': 'Confirmado', 
        'PAID': 'Pago',
        'SHIPPED': 'Enviado',
        'DELIVERED': 'Entregue',
        'CANCELLED': 'Cancelado',
        'REFUNDED': 'Reembolsado'
    };
    return statusLabels[status] || status || 'N/A';
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'PENDING': 'bg-warning',
        'CONFIRMED': 'bg-info',
        'PAID': 'bg-primary',
        'SHIPPED': 'bg-secondary',
        'DELIVERED': 'bg-success',
        'CANCELLED': 'bg-danger',
        'REFUNDED': 'bg-dark'
    };
    return statusClasses[status] || 'bg-secondary';
}

// Atualizar contadores das tabs
function updateStatusCounts(ordersByStatus) {
    document.getElementById('pending-count').textContent = ordersByStatus['PENDING'].length;
    document.getElementById('confirmed-count').textContent = ordersByStatus['CONFIRMED'].length;
    document.getElementById('paid-count').textContent = ordersByStatus['PAID'].length;
    document.getElementById('shipped-count').textContent = ordersByStatus['SHIPPED'].length;
    document.getElementById('delivered-count').textContent = ordersByStatus['DELIVERED'].length;
    document.getElementById('cancelled-count').textContent = ordersByStatus['CANCELLED'].length;
    document.getElementById('refunded-count').textContent = ordersByStatus['REFUNDED'].length;
}

// Sincronizar notas fiscais
async function syncInvoices() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sincronizando...';
        button.disabled = true;
        
        // Mostrar modal de progresso
        showProgressModal();
        
        const response = await fetch('/api/shipments/sync-invoices', {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.status === 401) {
            console.log('üîí Usu√°rio n√£o autenticado, redirecionando para login...');
            window.location.href = '/auth/login';
            return;
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            const message = `Sincroniza√ß√£o conclu√≠da! 
                - ${data.updated} pedidos atualizados
                - ${data.already_synced} j√° sincronizados
                - ${data.total_processed} processados no total`;
            
            hideProgressModal();
            showSuccess(message);
            
            setTimeout(() => {
                loadStats();
                loadOrders();
            }, 1000);
        } else {
            hideProgressModal();
            showError('Erro na sincroniza√ß√£o: ' + data.error);
        }
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o:', error);
        hideProgressModal();
        showError('Erro na sincroniza√ß√£o: ' + error.message);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Sincronizar nota fiscal individual
async function syncSingleInvoice(orderId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i>';
        button.disabled = true;
        
        const response = await fetch(`/api/shipments/sync-single-invoice/${orderId}`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess(`Pedido ${orderId} sincronizado com sucesso!`);
            
            // Atualizar apenas as estat√≠sticas sem recarregar tudo
            loadStats();
            
            // Atualizar apenas o pedido espec√≠fico na tabela
            updateSingleOrder(orderId, data.invoice_updated || data.status_updated);
        } else {
            showError('Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o individual:', error);
        showError('Erro na sincroniza√ß√£o: ' + error.message);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Sincronizar apenas o status do pedido (sem verificar NF)
async function syncOrderStatus(orderId) {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="bi bi-arrow-repeat spinner-border spinner-border-sm"></i>';
        button.disabled = true;
        
        const response = await fetch(`/api/shipments/sync-single-invoice/${orderId}`, {
            method: 'POST',
            credentials: 'include'
        });
        
        if (response.status === 401) {
            console.log('üîí Usu√°rio n√£o autenticado, redirecionando para login...');
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        console.log('üì¶ Resposta da API:', data);
        
        if (data.success) {
            showSuccess(`Status do pedido ${orderId} sincronizado com sucesso!`);
            
            // Atualizar apenas as estat√≠sticas e o pedido
            loadStats();
            // Atualizar se houve mudan√ßa no status OU na nota fiscal
            updateSingleOrder(orderId, data.status_updated || data.invoice_updated);
        } else {
            showError('Erro: ' + data.error);
        }
    } catch (error) {
        console.error('Erro ao sincronizar status:', error);
        showError('Erro ao sincronizar status: ' + error.message);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Atualizar apenas um pedido espec√≠fico na tabela
function updateSingleOrder(orderId, needsReload = true) {
    if (!needsReload) {
        console.log(`‚ö†Ô∏è Pedido ${orderId} n√£o precisa atualizar (j√° est√° atualizado)`);
        return; // Se nada mudou, n√£o precisa atualizar
    }
    
    console.log(`üîÑ Atualizando pedido ${orderId}...`);
    
    // Buscar dados atualizados do pedido
    fetch(`/api/shipments/pending?search=${orderId}&page=1&limit=1`, {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        console.log('üì¶ Dados recebidos:', data);
        if (data.success && data.orders && data.orders.length > 0) {
            const updatedOrder = data.orders[0];
            console.log('‚úÖ Pedido atualizado encontrado:', updatedOrder);
            console.log('üìÑ invoice_emitted:', updatedOrder.invoice_emitted);
            console.log('üìÑ invoice_number:', updatedOrder.invoice_number);
            console.log('üìÑ invoice_series:', updatedOrder.invoice_series);
            
            // Buscar a linha na tabela atual
            const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
            if (!orderRow) {
                console.log('‚ùå Pedido n√£o encontrado na tabela atual');
                return;
            }
            
            console.log('‚úÖ Linha da tabela encontrada:', orderRow);
            
            // Obter o status atual (da tab ativa)
            const currentTab = document.querySelector('.tab-pane.active').id;
            const currentStatus = currentTab.replace('tab-', '').toUpperCase();
            const newStatus = updatedOrder.status ? updatedOrder.status.toUpperCase() : 'N/A';
            
            // Atualizar coluna de status (3¬™ coluna) - inclui NF e status do pedido
            const statusCell = orderRow.querySelector('td:nth-child(3)'); // 3¬™ coluna √© status
            if (statusCell) {
                console.log(`üìÑ Atualizando coluna de status com NF: ${updatedOrder.invoice_number}`);
                statusCell.innerHTML = `
                    <div class="d-flex flex-column align-items-center">
                        <!-- Status da Nota Fiscal -->
                        ${updatedOrder.invoice_emitted ? `
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                <div class="text-center">
                                    <div class="fw-bold text-success">NF: ${updatedOrder.invoice_number || 'N/A'}</div>
                                    <small class="text-muted">S√©rie: ${updatedOrder.invoice_series || ''}</small>
                                </div>
                            </div>
                        ` : `
                            <div class="d-flex align-items-center mb-2">
                                <i class="bi bi-x-circle text-warning me-2"></i>
                                <span class="text-warning fw-bold">Sem nota fiscal</span>
                            </div>
                        `}
                        
                        <!-- Status do Pedido -->
                        <div class="mt-2">
                            <span class="badge ${getStatusBadgeClass(updatedOrder.status)} fs-6">
                                ${getStatusLabel(updatedOrder.status)}
                            </span>
                        </div>
                    </div>
                `;
                console.log('‚úÖ Coluna de status atualizada');
            }
            
            // Atualizar coluna de a√ß√µes (4¬™ coluna) - remover bot√£o "Sincronizar" se NF foi emitida
            const actionsCell = orderRow.querySelector('td:nth-child(4)'); // 4¬™ coluna √© a de a√ß√µes
            if (actionsCell && updatedOrder.invoice_emitted) {
                console.log('üîÑ Atualizando coluna de a√ß√µes (removendo bot√£o Sincronizar)');
                actionsCell.innerHTML = `
                    <div class="d-flex flex-column gap-1">
                        <button class="btn btn-sm btn-outline-success" onclick="syncOrderStatus('${updatedOrder.ml_order_id}')" title="Sincronizar Status">
                            <i class="bi bi-arrow-repeat me-1"></i>Status
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="showInfo('${updatedOrder.ml_order_id}')" title="Ver Detalhes">
                            <i class="bi bi-info-circle me-1"></i>Detalhes
                        </button>
                    </div>
                `;
            }
            
            // Se o status mudou e n√£o corresponde mais √† tab atual, remover da tab
            if (newStatus !== 'N/A' && newStatus !== currentStatus && statusCell) {
                console.log(`Status mudou de ${currentStatus} para ${newStatus}. Removendo da tab atual.`);
                
                // Remover a linha da tabela
                orderRow.remove();
                
                // Atualizar contador da aba
                updateTabCounts();
                
                // Mostrar mensagem informando que o pedido foi movido
                showSuccess(`Pedido ${orderId} movido para a aba: ${newStatus}`);
            }
        }
    })
    .catch(error => {
        console.error('Erro ao atualizar pedido:', error);
    });
}

// Atualizar contadores das abas
function updateTabCounts() {
    // Atualizar contador de cada aba
    const tabs = ['pending', 'confirmed', 'paid', 'shipped', 'delivered', 'cancelled'];
    tabs.forEach(tab => {
        const tabPane = document.getElementById(`tab-${tab}`);
        if (tabPane) {
            const count = tabPane.querySelectorAll('tbody tr').length;
            const tabLink = document.querySelector(`[href="#tab-${tab}"]`);
            if (tabLink) {
                // Atualizar badge com contador
                const badge = tabLink.querySelector('.badge');
                if (badge) {
                    badge.textContent = count;
                }
            }
        }
    });
}

// Mostrar modal de progresso
function showProgressModal() {
    const modal = new bootstrap.Modal(document.getElementById('progressModal'));
    modal.show();
    
    // Simular progresso
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        document.getElementById('progress-bar').style.width = progress + '%';
        document.getElementById('progress-text').textContent = 'Processando pedidos...';
    }, 500);
    
    // Salvar interval para limpar depois
    window.progressInterval = interval;
}

// Esconder modal de progresso
function hideProgressModal() {
    if (window.progressInterval) {
        clearInterval(window.progressInterval);
        window.progressInterval = null;
    }
    
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('progress-text').textContent = 'Conclu√≠do!';
    
    setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
        if (modal) modal.hide();
    }, 1000);
}

// Copiar para clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showSuccess('ID copiado: ' + text);
    }).catch(() => {
        showError('Erro ao copiar ID');
    });
}

// Mostrar informa√ß√µes
function showInfo(orderId) {
    showInfo(`Detalhes do pedido ${orderId}`);
}

// Formatar data
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

// Formatar hora
function formatTime(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

// Mostrar mensagem de sucesso
function showSuccess(message) {
    // Implementar toast de sucesso
    console.log('‚úÖ', message);
}

// Mostrar mensagem de erro
function showError(message) {
    // Implementar toast de erro
    console.error('‚ùå', message);
}
</script>
{% endblock %}

