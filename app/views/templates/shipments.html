{% extends "base.html" %}

{% block title %}Expedi√ß√£o de Produtos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-box-seam"></i> Expedi√ß√£o de Produtos
            </h1>

            <!-- Tabs de Status com Scroll Horizontal -->
            <div class="tabs-scroll-container mb-4" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
                <ul class="nav nav-tabs mb-0 flex-nowrap" id="statusTabs" role="tablist" style="display: flex; flex-wrap: nowrap; white-space: nowrap;">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                        Pendentes
                        <span class="badge bg-secondary ms-1" id="pending-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                        Confirmados
                        <span class="badge bg-secondary ms-1" id="confirmed-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ready-to-prepare-tab" data-bs-toggle="tab" data-bs-target="#ready-to-prepare" type="button" role="tab">
                        Pronto para Preparar
                        <span class="badge bg-secondary ms-1" id="ready-to-prepare-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-prepare-tab" data-bs-toggle="tab" data-bs-target="#manual-prepare" type="button" role="tab">
                        Separar Pedidos
                        <span class="badge bg-warning ms-1" id="manual-prepare-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="waiting-shipment-tab" data-bs-toggle="tab" data-bs-target="#waiting-shipment" type="button" role="tab">
                        Aguardando Envio
                        <span class="badge bg-secondary ms-1" id="waiting-shipment-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shipped-tab" data-bs-toggle="tab" data-bs-target="#shipped" type="button" role="tab">
                        Enviados
                        <span class="badge bg-secondary ms-1" id="shipped-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="delivered-tab" data-bs-toggle="tab" data-bs-target="#delivered" type="button" role="tab">
                        Entregues
                        <span class="badge bg-secondary ms-1" id="delivered-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                        Cancelados
                        <span class="badge bg-secondary ms-1" id="cancelled-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="refunded-tab" data-bs-toggle="tab" data-bs-target="#refunded" type="button" role="tab">
                        Reembolsados
                        <span class="badge bg-secondary ms-1" id="refunded-count">0</span>
                    </button>
                </li>
                </ul>
            </div>

            <style>
                .tabs-scroll-container {
                    scrollbar-width: thin;
                    scrollbar-color: #cbd5e0 #f7fafc;
                }
                
                .tabs-scroll-container::-webkit-scrollbar {
                    height: 8px;
                }
                
                .tabs-scroll-container::-webkit-scrollbar-track {
                    background: #f7fafc;
                    border-radius: 4px;
                }
                
                .tabs-scroll-container::-webkit-scrollbar-thumb {
                    background: #cbd5e0;
                    border-radius: 4px;
                }
                
                .tabs-scroll-container::-webkit-scrollbar-thumb:hover {
                    background: #a0aec0;
                }
                
                #statusTabs .nav-item {
                    flex-shrink: 0;
                }
                
                #statusTabs .nav-link {
                    white-space: nowrap;
                }
            </style>

            <!-- Conte√∫do das Tabs -->
            <div class="tab-content" id="statusTabsContent">
                <!-- Tab Pendentes -->
                <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Pendentes</h5>
                            <p class="text-muted">Pedidos aguardando confirma√ß√£o ou pagamento.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab Confirmados -->
                <div class="tab-pane fade" id="confirmed" role="tabpanel" aria-labelledby="confirmed-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Confirmados</h5>
                            <p class="text-muted">Pedidos confirmados mas ainda n√£o pagos.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab Pronto para Preparar -->
                <div class="tab-pane fade show active" id="ready-to-prepare" role="tabpanel" aria-labelledby="ready-to-prepare-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Pronto para Preparar</h5>
                            <p class="text-muted">Pedidos n√£o-Fulfillment prontos para prepara√ß√£o manual.</p>
                            
                            <!-- Bot√£o de Atualiza√ß√£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-selected-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="selected-count">0 selecionado(s)</span>
                            </div>
                            
                            <!-- Tabela de Pedidos -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-orders" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ready-to-prepare-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Separar Pedidos (Manual Status) -->
                <div class="tab-pane fade" id="manual-prepare" role="tabpanel" aria-labelledby="manual-prepare-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i> Separar Pedidos
                            </h5>
                            <p class="text-muted">Pedidos marcados manualmente para separa√ß√£o. Status: READY_TO_PREPARE</p>
                            
                            <!-- Tabela de Pedidos -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Data</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>Status Manual</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manual-prepare-orders">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Aguardando Envio -->
                <div class="tab-pane fade" id="waiting-shipment" role="tabpanel" aria-labelledby="waiting-shipment-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Aguardando Envio</h5>
                            <p class="text-muted">Pedidos pagos mas ainda n√£o enviados.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab Enviados -->
                <div class="tab-pane fade" id="shipped" role="tabpanel" aria-labelledby="shipped-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Enviados</h5>
                            <p class="text-muted">Pedidos que j√° foram enviados e est√£o em tr√¢nsito.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab Entregues -->
                <div class="tab-pane fade" id="delivered" role="tabpanel" aria-labelledby="delivered-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Entregues</h5>
                            <p class="text-muted">Pedidos que foram entregues ao cliente.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab Cancelados -->
                <div class="tab-pane fade" id="cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Cancelados</h5>
                            <p class="text-muted">Pedidos que foram cancelados.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>

                <!-- Tab Reembolsados -->
                <div class="tab-pane fade" id="refunded" role="tabpanel" aria-labelledby="refunded-tab">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Reembolsados</h5>
                            <p class="text-muted">Pedidos que foram reembolsados completamente ou parcialmente.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Carregar pedidos da aba "Pronto para Preparar" ao carregar a p√°gina
    loadReadyToPrepareOrders();
    
    // Carregar pedidos quando a aba for clicada
    const readyToPrepareTab = document.getElementById('ready-to-prepare-tab');
    if (readyToPrepareTab) {
        readyToPrepareTab.addEventListener('shown.bs.tab', function() {
            loadReadyToPrepareOrders();
        });
    }
    
    // Carregar pedidos da aba Separar Pedidos (Status Manual)
    const manualPrepareTab = document.getElementById('manual-prepare-tab');
    if (manualPrepareTab) {
        manualPrepareTab.addEventListener('shown.bs.tab', function() {
            loadManualPrepareOrders();
        });
    }
    
    async function loadReadyToPrepareOrders() {
        const tbody = document.getElementById('ready-to-prepare-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            // Buscar TODOS os pedidos com pagina√ß√£o
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    // Verificar se h√° mais p√°ginas
                    hasMore = data.total_pages > page;
                    page++;
                } else {
                    hasMore = false;
                }
                
                // Limite de seguran√ßa - n√£o buscar mais de 10 p√°ginas (10.000 pedidos)
                if (page > 10) {
                    hasMore = false;
                }
            }
            
            // Filtrar pedidos: status = PAID AND n√£o foi enviado
            const filteredOrders = allOrders.filter(order => {
                // Verificar se j√° foi enviado
                const hasTracking = order.shipping_status && order.shipping_status === 'shipped';
                const hasShippingDate = order.shipping_date;
                
                // N√£o mostrar se j√° foi enviado
                if (hasTracking || hasShippingDate) {
                    return false;
                }
                
                // Mostrar apenas pedidos PAID
                return order.status === 'PAID';
            });
            
            if (filteredOrders.length > 0) {
                renderOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            Nenhum pedido encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function loadManualPrepareOrders() {
        const tbody = document.getElementById('manual-prepare-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        // Buscar pedidos com status manual READY_TO_PREPARE (status que n√£o existe na API, apenas criado manualmente)
        fetch('/api/shipments/pending?status=READY_TO_PREPARE&page=1&limit=100')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.orders && data.orders.length > 0) {
                    renderManualOrders(tbody, data.orders);
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Nenhum pedido marcado para separa√ß√£o.
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar pedidos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            Erro ao carregar pedidos. Tente novamente.
                        </td>
                    </tr>
                `;
            });
    }
    
    function renderManualOrders(tbody, orders) {
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        Nenhum pedido marcado para separa√ß√£o.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const shippingType = order.shipping_type || 'N/A';
            
            return `
                <tr>
                    <td><strong>${orderId}</strong></td>
                    <td>${order.buyer_name || order.buyer_nickname || '-'}</td>
                    <td>${orderDate}</td>
                    <td>${totalAmount}</td>
                    <td><span class="badge bg-info">${shippingType}</span></td>
                    <td><span class="badge bg-warning">Status Manual</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="syncOrder('${orderId}')">
                            <i class="bi bi-arrow-clockwise"></i> Sincronizar
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function renderOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            // Data e hora formatadas
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            // Extrair informa√ß√µes de envio de shipping_details
            let shippingInfo = '';
            if (order.shipping_details) {
                const status = order.shipping_details.status;  // Status principal: "delivered", "shipped", "ready_to_ship", etc.
                const substatus = order.shipping_details.substatus;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                // Extrair datas importantes
                const statusHistory = order.shipping_details.status_history || {};
                const dateShipped = statusHistory.date_shipped;
                // Tentar m√∫ltiplas fontes para data prevista de entrega
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const shippedDate = dateShipped ? new Date(dateShipped).toLocaleDateString('pt-BR') : null;
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Montar badge com tipo de log√≠stica
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Adicionar STATUS PRINCIPAL (entrega finalizada ou em andamento)
                if (status) {
                    if (status === 'delivered') {
                        // Se foi entregue, mostrar apenas a data de entrega
                        shippingInfo += `<br><small class="text-success"><strong>‚úì Entregue</strong></small>`;
                        const dateDelivered = statusHistory.date_delivered;
                        if (dateDelivered) {
                            const deliveredDate = new Date(dateDelivered).toLocaleDateString('pt-BR');
                            shippingInfo += `<br><small class="text-success">üìÖ ${deliveredDate}</small>`;
                        }
                    } else if (status === 'shipped') {
                        shippingInfo += `<br><small class="text-info">üöö Em Tr√¢nsito</small>`;
                        // Mostrar data de envio e previs√£o de entrega
                        if (shippedDate) {
                            shippingInfo += `<br><small class="text-muted">üöõ Enviado: ${shippedDate}</small>`;
                        }
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    } else if (status === 'ready_to_ship' || status === 'ready_to_print' || status === 'printed' || status === 'packed') {
                        shippingInfo += `<br><small class="text-warning">üì¶ Pronto para Envio</small>`;
                        // Mostrar apenas previs√£o de entrega
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    } else if (status === 'pending') {
                        shippingInfo += `<br><small class="text-secondary">‚è≥ Pendente</small>`;
                        // Mostrar apenas previs√£o de entrega
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    } else {
                        shippingInfo += `<br><small class="text-muted">${status}</small>`;
                        // Para outros status, mostrar previs√£o se dispon√≠vel
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
                        ${order.sale_id ? `<br><small class="text-muted">Venda: ${order.sale_id}</small>` : ''}
                    </td>
                    <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            // Tentar destination primeiro (formato novo do ML)
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                // Nome do destinat√°rio est√° em destination.receiver_name
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                // Endere√ßo est√° em destination.shipping_address.address_line
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                // Cidade e estado
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            // Fallback para receiver_address ou shipping_address
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
                    </td>
                    <td>${totalAmount}</td>
                    <td>
                        ${shippingInfo}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes ap√≥s renderizar
        setupCheckboxEvents();
    }
    
    function setupCheckboxEvents() {
        // Checkbox "Selecionar todos"
        const selectAllCheckbox = document.getElementById('select-all-orders');
        const orderCheckboxes = document.querySelectorAll('.order-checkbox');
        const updateButton = document.getElementById('update-selected-orders');
        const selectedCount = document.getElementById('selected-count');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                orderCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });
        }
        
        // Checkboxes individuais
        orderCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Atualizar checkbox "Selecionar todos"
                if (selectAllCheckbox) {
                    const allChecked = Array.from(orderCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(orderCheckboxes).some(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                }
                updateSelectedCount();
            });
        });
        
        // Bot√£o de atualizar
        if (updateButton) {
            updateButton.addEventListener('click', function() {
                updateSelectedOrders();
            });
        }
    }
    
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const count = selectedCheckboxes.length;
        const selectedCountEl = document.getElementById('selected-count');
        const updateButton = document.getElementById('update-selected-orders');
        
        if (selectedCountEl) {
            selectedCountEl.textContent = `${count} selecionado(s)`;
        }
        
        if (updateButton) {
            updateButton.disabled = count === 0;
        }
    }
    
    function updateSelectedOrders() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const orderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        if (orderIds.length === 0) {
            alert('Selecione pelo menos um pedido para atualizar.');
            return;
        }
        
        if (!confirm(`Deseja atualizar ${orderIds.length} pedido(s)?\n\nIsso ir√° sincronizar o tipo de envio e status com o Mercado Livre.`)) {
            return;
        }
        
        const updateButton = document.getElementById('update-selected-orders');
        const originalText = updateButton.innerHTML;
        updateButton.disabled = true;
        updateButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Atualizando...';
        
        // Fazer requisi√ß√£o para atualizar os pedidos
        fetch('/api/shipments/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_ids: orderIds
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro ao atualizar pedidos');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(`‚úÖ ${data.updated || 0} pedido(s) atualizado(s) com sucesso!`);
                // Recarregar a lista
                loadReadyToPrepareOrders();
                // Desmarcar todos os checkboxes
                document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('select-all-orders').checked = false;
                updateSelectedCount();
            } else {
                throw new Error(data.error || 'Erro ao atualizar pedidos');
            }
        })
        .catch(error => {
            console.error('Erro ao atualizar pedidos:', error);
            alert('‚ùå Erro ao atualizar pedidos. Tente novamente.');
        })
        .finally(() => {
            updateButton.disabled = false;
            updateButton.innerHTML = originalText;
        });
    }
    
    // Fun√ß√£o para ver detalhes do pedido completo
    window.viewOrderDetails = function(orderId) {
        // Buscar o pedido no array de orders carregado
        const order = window.currentOrders?.find(o => o.order_id === orderId || o.ml_order_id === orderId);
        
        if (!order) {
            alert('Pedido n√£o encontrado');
            return;
        }
        
        // Exibir JSON formatado no modal
        const jsonContent = JSON.stringify(order, null, 2);
        document.getElementById('json-content').textContent = jsonContent;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
        modal.show();
    };
});
</script>

<!-- Modal para exibir JSON completo -->
<div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jsonModalLabel">
                    <i class="bi bi-code-slash"></i> JSON Completo do Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="json-content" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px;"><code></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copyJsonToClipboard()">
                    <i class="bi bi-clipboard"></i> Copiar JSON
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para copiar JSON para a √°rea de transfer√™ncia
function copyJsonToClipboard() {
    const jsonContent = document.getElementById('json-content').textContent;
    navigator.clipboard.writeText(jsonContent).then(() => {
        alert('‚úÖ JSON copiado para a √°rea de transfer√™ncia!');
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('‚ùå Erro ao copiar JSON');
    });
}
</script>
{% endblock %}
