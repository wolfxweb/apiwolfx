{% extends "base.html" %}

{% block title %}Pedidos{% endblock %}

{% block head %}
<!-- Cache buster para forÃ§ar atualizaÃ§Ã£o do JS - v2024.11.05 -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                    <i class="bi bi-box-seam"></i> Pedidos
                </h1>

            <!-- Card com Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Filtros rÃ¡pidos acima da listagem de pedidos -->
                    <form id="filter-form" class="row g-2 align-items-end">
                        <div class="col-auto">
                            <label for="filter-period" class="form-label mb-0 small">PerÃ­odo</label>
                            <select class="form-select" id="filter-period">
                                <option value="">Todos</option>
                                <option value="7_days" selected>Ãšltimos 7 dias</option>
                                <option value="15_days">Ãšltimos 15 dias</option>
                                <option value="30_days">Ãšltimos 30 dias</option>
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este MÃªs</option>
                                <option value="last_month">MÃªs Passado</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <label for="filter-customer" class="form-label mb-0 small">Buscar</label>
                            <input type="text" class="form-control" id="filter-customer" placeholder="Nome do cliente ou cÃ³digo do pedido" style="min-width: 280px;">
                        </div>
                        <div class="col-auto" id="custom-dates" style="display: none;">
                            <label for="filter-start-date" class="form-label mb-0 small">Data Inicial</label>
                            <input type="date" class="form-control" id="filter-start-date">
                            </div>
                        <div class="col-auto" id="custom-dates-end" style="display: none;">
                            <label for="filter-end-date" class="form-label mb-0 small">Data Final</label>
                            <input type="date" class="form-control" id="filter-end-date">
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-primary" id="sync-orders-btn">
                                <i class="bi bi-cloud-download"></i> Atualizar Pedidos
                            </button>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                    </div>
                    </form>
                </div>
            </div>

            <!-- Card com Tabs de Status -->
            <div class="card">
                <div class="card-body">
                    <!-- Tabs de Status com Scroll Horizontal -->
                    <div class="tabs-scroll-container mb-3" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
                        <ul class="nav nav-tabs mb-0 flex-nowrap" id="statusTabs" role="tablist" style="display: flex; flex-wrap: nowrap; white-space: nowrap;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                                Pendentes
                                <span class="badge bg-secondary ms-1" id="pending-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                                Confirmados
                                <span class="badge bg-secondary ms-1" id="confirmed-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ready-to-prepare-tab" data-bs-toggle="tab" data-bs-target="#ready-to-prepare" type="button" role="tab">
                                Preparando Envio
                                <span class="badge bg-secondary ms-1" id="ready-to-prepare-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-prepare-tab" data-bs-toggle="tab" data-bs-target="#manual-prepare" type="button" role="tab">
                                Separar Pedidos
                                <span class="badge bg-warning ms-1" id="manual-prepare-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="waiting-shipment-tab" data-bs-toggle="tab" data-bs-target="#waiting-shipment" type="button" role="tab">
                                Aguardando Envio
                                <span class="badge bg-secondary ms-1" id="waiting-shipment-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="shipped-tab" data-bs-toggle="tab" data-bs-target="#shipped" type="button" role="tab">
                                Enviados
                                <span class="badge bg-secondary ms-1" id="shipped-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="delivered-tab" data-bs-toggle="tab" data-bs-target="#delivered" type="button" role="tab">
                                Entregues
                                <span class="badge bg-secondary ms-1" id="delivered-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                                Cancelados
                                <span class="badge bg-secondary ms-1" id="cancelled-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="refunded-tab" data-bs-toggle="tab" data-bs-target="#refunded" type="button" role="tab">
                                Reembolsados
                                <span class="badge bg-secondary ms-1" id="refunded-count">0</span>
                            </button>
                        </li>
                    </ul>
                </div>

                    <!-- ConteÃºdo das Tabs -->
                    <div class="tab-content" id="statusTabsContent">

                        <!-- Tab Pendentes -->
                <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-pending-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="pending-selected-count">0 selecionado(s)</span>
                            </div>
                  
                            
                            <!-- Tabela de Pedidos Pendentes -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-pending" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tab Confirmados -->
                <div class="tab-pane fade" id="confirmed" role="tabpanel" aria-labelledby="confirmed-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-confirmed-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="confirmed-selected-count">0 selecionado(s)</span>
                            </div>
                            
                            <!-- Tabela de Pedidos Confirmados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-confirmed" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="confirmed-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                <!-- Tab Preparando Envio -->
                <div class="tab-pane fade show active" id="ready-to-prepare" role="tabpanel" aria-labelledby="ready-to-prepare-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-selected-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="selected-count">0 selecionado(s)</span>
                            </div>
                            
                            <!-- Tabela de Pedidos -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-orders" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ready-to-prepare-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                <!-- Tab Separar Pedidos (Manual Status) -->
                <div class="tab-pane fade" id="manual-prepare" role="tabpanel" aria-labelledby="manual-prepare-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-manual-prepare-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="manual-prepare-selected-count">0 selecionado(s)</span>
                            </div>
                            
                      
                            
                            <!-- Tabela de Pedidos -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-manual-prepare" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Data</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>Status Manual</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manual-prepare-orders">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                <!-- Tab Aguardando Envio -->
                <div class="tab-pane fade" id="waiting-shipment" role="tabpanel" aria-labelledby="waiting-shipment-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-waiting-shipment-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="waiting-shipment-selected-count">0 selecionado(s)</span>
                            </div>
                            
                       
                            
                            <!-- Tabela de Pedidos Aguardando Envio -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-waiting-shipment" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="waiting-shipment-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                <!-- Tab Enviados -->
                <div class="tab-pane fade" id="shipped" role="tabpanel" aria-labelledby="shipped-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-shipped-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="shipped-selected-count">0 selecionado(s)</span>
                            </div>
                            
         
                            
                            <!-- Tabela de Pedidos Enviados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-shipped" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shipped-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                <!-- Tab Entregues -->
                <div class="tab-pane fade" id="delivered" role="tabpanel" aria-labelledby="delivered-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-delivered-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="delivered-selected-count">0 selecionado(s)</span>
                            </div>
                            
                        
                            
                            <!-- Tabela de Pedidos Entregues -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-delivered" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="delivered-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                <!-- Tab Cancelados -->
                <div class="tab-pane fade" id="cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-cancelled-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="cancelled-selected-count">0 selecionado(s)</span>
                    </div>
                            
                 
                            
                            <!-- Tabela de Pedidos Cancelados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-cancelled" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cancelled-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
    </div>
</div>

                <!-- Tab Reembolsados -->
                <div class="tab-pane fade" id="refunded" role="tabpanel" aria-labelledby="refunded-tab">
                            <!-- BotÃ£o de AtualizaÃ§Ã£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-refunded-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="refunded-selected-count">0 selecionado(s)</span>
            </div>
                            
        
                            
                            <!-- Tabela de Pedidos Reembolsados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-refunded" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>AÃ§Ãµes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refunded-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .tabs-scroll-container {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }
    
    .tabs-scroll-container::-webkit-scrollbar {
        height: 8px;
    }
    
    .tabs-scroll-container::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }
    
    .tabs-scroll-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    
    .tabs-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    
    #statusTabs .nav-item {
        flex-shrink: 0;
    }
    
    #statusTabs .nav-link {
        white-space: nowrap;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // VariÃ¡vel global para armazenar todos os pedidos carregados
    let allOrdersLoaded = [];
    let ordersLoaded = false;
    let loadingPromise = null; // Promise para evitar carregamento duplicado

    // Carregar contadores de todas as abas ao iniciar
    loadTabCounts();
    
    // Configurar perÃ­odo padrÃ£o como "Ãšltimos 7 dias" ao carregar a pÃ¡gina
    const today = new Date();
    const formatDate = (date) => date.toISOString().split('T')[0];
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(today.getDate() - 7);
    
    document.getElementById('filter-period').value = '7_days';
    document.getElementById('filter-start-date').value = formatDate(sevenDaysAgo);
    document.getElementById('filter-end-date').value = formatDate(today);
    
    // Carregar pedidos da aba "Preparando Envio" ao carregar a pÃ¡gina
    // Como a aba estÃ¡ ativa por padrÃ£o (show active), precisamos carregar os pedidos
    // Agora com filtro de data aplicado, o carregamento serÃ¡ mais rÃ¡pido (apenas Ãºltimos 7 dias)
    loadReadyToPrepareOrders();
    
    // Carregar pedidos quando a aba for clicada
    const confirmedTab = document.getElementById('confirmed-tab');
    if (confirmedTab) {
        confirmedTab.addEventListener('shown.bs.tab', function() {
            loadConfirmedOrders();
        });
    }
    
    const readyToPrepareTab = document.getElementById('ready-to-prepare-tab');
    if (readyToPrepareTab) {
        readyToPrepareTab.addEventListener('shown.bs.tab', function() {
            loadReadyToPrepareOrders();
        });
    }
    
    // Carregar pedidos da aba Separar Pedidos (Status Manual)
    const manualPrepareTab = document.getElementById('manual-prepare-tab');
    if (manualPrepareTab) {
        manualPrepareTab.addEventListener('shown.bs.tab', function() {
            loadManualPrepareOrders();
        });
    }
    
    // Carregar pedidos da aba Entregues
    const deliveredTab = document.getElementById('delivered-tab');
    if (deliveredTab) {
        deliveredTab.addEventListener('shown.bs.tab', function() {
            loadDeliveredOrders();
        });
    }
    
    // Carregar pedidos da aba Pendentes
    const pendingTab = document.getElementById('pending-tab');
    if (pendingTab) {
        pendingTab.addEventListener('shown.bs.tab', function() {
            loadPendingOrders();
        });
    }
    
    // Carregar pedidos da aba Aguardando Envio
    const waitingShipmentTab = document.getElementById('waiting-shipment-tab');
    if (waitingShipmentTab) {
        waitingShipmentTab.addEventListener('shown.bs.tab', function() {
            loadWaitingShipmentOrders();
        });
    }
    
    // Carregar pedidos da aba Enviados
    const shippedTab = document.getElementById('shipped-tab');
    if (shippedTab) {
        shippedTab.addEventListener('shown.bs.tab', function() {
            loadShippedOrders();
        });
    }
    
    // Carregar pedidos da aba Cancelados
    const cancelledTab = document.getElementById('cancelled-tab');
    if (cancelledTab) {
        cancelledTab.addEventListener('shown.bs.tab', function() {
            loadCancelledOrders();
        });
    }
    
    // Carregar pedidos da aba Reembolsados
    const refundedTab = document.getElementById('refunded-tab');
    if (refundedTab) {
        refundedTab.addEventListener('shown.bs.tab', function() {
            loadRefundedOrders();
        });
    }
    
    // FunÃ§Ã£o para carregar contadores de todas as abas
    async function loadTabCounts() {
        try {
            // Buscar contadores do backend
            const response = await fetch('/api/shipments/tab-counts', {
                credentials: 'include'  // Enviar cookies (session_token)
            });
            
            // Tratar erro 401
            if (handle401Error(response)) {
            return;
            }
            
            if (!response.ok) {
                throw new Error('Erro ao carregar contadores');
        }
        
        const data = await response.json();
        
        if (data.success) {
                // Atualizar contadores de cada aba
                document.getElementById('pending-count').textContent = data.counts?.PENDING || 0;
                document.getElementById('confirmed-count').textContent = data.counts?.CONFIRMED || 0;
                document.getElementById('ready-to-prepare-count').textContent = data.counts?.READY_TO_PREPARE || 0;
                document.getElementById('manual-prepare-count').textContent = data.counts?.READY_TO_PREPARE || 0;
                document.getElementById('waiting-shipment-count').textContent = data.counts?.WAITING_SHIPMENT || 0;
                document.getElementById('shipped-count').textContent = data.counts?.SHIPPED || 0;
                document.getElementById('delivered-count').textContent = data.counts?.DELIVERED || 0;
                document.getElementById('cancelled-count').textContent = data.counts?.CANCELLED || 0;
                document.getElementById('refunded-count').textContent = data.counts?.REFUNDED || 0;
                
                console.log('ðŸ“Š Contadores recebidos:', data.counts);
        }
    } catch (error) {
            console.error('Erro ao carregar contadores:', error);
        }
    }
    
    // FunÃ§Ã£o para tratar erros 401 (nÃ£o autenticado)
    function handle401Error(response) {
        if (response && response.status === 401) {
            console.warn('âš ï¸ NÃ£o autenticado, redirecionando para login...');
            window.location.href = '/auth/login';
            return true;
        }
        return false;
    }
    
    // Listener para mudanÃ§a de perÃ­odo - preencher datas automaticamente
    document.getElementById('filter-period').addEventListener('change', function() {
        const period = this.value;
        const startDateInput = document.getElementById('filter-start-date');
        const endDateInput = document.getElementById('filter-end-date');
        const customDatesContainer = document.getElementById('custom-dates');
        const customDatesEndContainer = document.getElementById('custom-dates-end');
        
        const today = new Date();
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (period === 'custom') {
            customDatesContainer.style.display = 'block';
            customDatesEndContainer.style.display = 'block';
        } else {
            customDatesContainer.style.display = 'none';
            customDatesEndContainer.style.display = 'none';
            
            if (period === '7_days') {
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);
                startDateInput.value = formatDate(sevenDaysAgo);
                endDateInput.value = formatDate(today);
            } else if (period === '15_days') {
                const fifteenDaysAgo = new Date(today);
                fifteenDaysAgo.setDate(today.getDate() - 15);
                startDateInput.value = formatDate(fifteenDaysAgo);
                endDateInput.value = formatDate(today);
            } else if (period === '30_days') {
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                startDateInput.value = formatDate(thirtyDaysAgo);
                endDateInput.value = formatDate(today);
            } else if (period === 'today') {
                startDateInput.value = formatDate(today);
                endDateInput.value = formatDate(today);
            } else if (period === 'week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                startDateInput.value = formatDate(weekStart);
                endDateInput.value = formatDate(today);
            } else if (period === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                startDateInput.value = formatDate(monthStart);
                endDateInput.value = formatDate(today);
            } else if (period === 'last_month') {
                const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                startDateInput.value = formatDate(lastMonthStart);
                endDateInput.value = formatDate(lastMonthEnd);
            } else {
                // Todos
                startDateInput.value = '';
                endDateInput.value = '';
            }
            
            // Ao mudar perÃ­odo, recarregar os pedidos do servidor com novo filtro
            // Resetar flags para forÃ§ar novo carregamento
            ordersLoaded = false;
            allOrdersLoaded = [];
            loadingPromise = null;
            
            // Recarregar pedidos com novo perÃ­odo
            loadReadyToPrepareOrders();
        }
    });
    
    // Listener para buscar cliente ao digitar (debounce)
    let customerSearchTimeout;
    document.getElementById('filter-customer').addEventListener('input', function() {
        clearTimeout(customerSearchTimeout);
        customerSearchTimeout = setTimeout(() => {
            if (ordersLoaded) {
                applyFiltersToLoadedOrders();
            } else {
                loadReadyToPrepareOrders(1);
            }
        }, 500); // Aguarda 500ms apÃ³s parar de digitar
    });
    
    // BotÃ£o Atualizar Pedidos (Ãºltimos 2 dias) - OTIMIZADO
    document.getElementById('sync-orders-btn').addEventListener('click', async function() {
        const btn = this;
        const originalHtml = btn.innerHTML;
        
        // Contador de tempo para feedback visual
        let seconds = 0;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sincronizando... 0s';
        
        const timer = setInterval(() => {
            seconds++;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Sincronizando... ${seconds}s`;
        }, 1000);
        
        try {
            const response = await fetch('/api/shipments/sync-recent', {
                method: 'POST',
                credentials: 'include',  // IMPORTANTE: Enviar cookies (session_token)
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            clearInterval(timer);
            
            if (handle401Error(response)) {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                return;
            }
            
            // Verificar se a resposta Ã© vÃ¡lida antes de parsear JSON
            if (!response.ok) {
                throw new Error(`Erro ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                btn.innerHTML = `âœ… ConcluÃ­do em ${seconds}s!`;
                
                // Resetar flags para recarregar os dados
                ordersLoaded = false;
                allOrdersLoaded = [];
                loadingPromise = null;
                
                // Recarregar pedidos da aba atual
                setTimeout(async () => {
                    await loadReadyToPrepareOrders();
                    
                    // Mostrar feedback de sucesso em modal
                    showSyncModal('success', 'SincronizaÃ§Ã£o concluÃ­da!', 
                        `${data.total_saved || 0} novos pedidos, ${data.total_updated || 0} atualizados`, {
                        total_saved: data.total_saved || 0,
                        total_updated: data.total_updated || 0
                    });
                    
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }, 1500);
            } else {
                // Mostrar erro em modal
                showSyncModal('error', 'Erro na sincronizaÃ§Ã£o', data.error || 'Erro ao sincronizar pedidos');
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        } catch (error) {
            clearInterval(timer);
            console.error('Erro ao sincronizar pedidos:', error);
            
            // Mensagem de erro mais detalhada
            let errorMsg = 'Erro ao sincronizar pedidos. ';
            if (error.message.includes('503')) {
                errorMsg += 'O servidor demorou muito para responder (timeout). Tente novamente.';
            } else if (error.message.includes('JSON')) {
                errorMsg += 'Resposta invÃ¡lida do servidor. Tente novamente.';
            } else {
                errorMsg += error.message;
            }
            
            showSyncModal('error', 'Erro na sincronizaÃ§Ã£o', errorMsg);
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    });
    
    // BotÃ£o Limpar filtros
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('filter-period').value = '';
        document.getElementById('filter-customer').value = '';
        document.getElementById('filter-start-date').value = '';
        document.getElementById('filter-end-date').value = '';
        document.getElementById('custom-dates').style.display = 'none';
        document.getElementById('custom-dates-end').style.display = 'none';
        if (ordersLoaded) {
            applyFiltersToLoadedOrders();
        } else {
            loadReadyToPrepareOrders(1);
        }
    });

    // Modifique a loadReadyToPrepareOrders para aceitar pÃ¡gina e ler filtros:
    async function loadReadyToPrepareOrders(page = 1) {
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora (sem filtros do servidor)
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        // Aplicar filtros localmente
        applyFiltersToLoadedOrders();
    }

    // Carregar todos os pedidos UMA VEZ (sem filtros) e armazenar globalmente
    // Esta funÃ§Ã£o Ã© chamada quando o usuÃ¡rio clica em uma aba pela primeira vez
    // Carrega TODOS os pedidos em memÃ³ria para permitir filtragem rÃ¡pida no cliente
    async function loadAllOrdersOnce() {
        // Se jÃ¡ estÃ¡ carregando, aguardar a promise existente (evita carregamento duplicado)
        if (loadingPromise) {
            return await loadingPromise;
        }
        
        if (ordersLoaded) return; // JÃ¡ carregou anteriormente, nÃ£o precisa carregar novamente
        
        // Criar promise de carregamento para evitar duplicaÃ§Ã£o
        loadingPromise = (async () => {
            const tbody = document.getElementById('ready-to-prepare-orders');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted"><div class="spinner-border spinner-border-sm" role="status"></div> Carregando pedidos...</td></tr>`;
            let hasMore = true;
            let page = 1;
            const limit = 1000; // Carregar 1000 pedidos por pÃ¡gina
            
            // Resetar array para evitar duplicaÃ§Ãµes em recarregamentos
            allOrdersLoaded = [];

            // Buscar pedidos aplicando filtros de data por padrÃ£o
            // Removido limite de 10 pÃ¡ginas (10.000 pedidos) para suportar mais pedidos
            // O loop continuarÃ¡ atÃ© que nÃ£o haja mais pÃ¡ginas disponÃ­veis
            
            // Coletar filtros de data do formulÃ¡rio para aplicar na busca
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            
            while (hasMore) {
                // Construir URL com filtros de data
                let url = `/api/shipments/pending?page=${page}&limit=${limit}`;
                if (startDate) url += `&start_date=${startDate}`;
                if (endDate) url += `&end_date=${endDate}`;
                
                const response = await fetch(url, {
                    credentials: 'include'  // Enviar cookies (session_token)
                });
                if (handle401Error(response)) return;
                if (!response.ok) throw new Error('Erro ao carregar pedidos');
        const data = await response.json();
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrdersLoaded = allOrdersLoaded.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
                    console.log(`ðŸ“¦ Carregou pÃ¡gina ${page - 1}/${data.total_pages || '?'} - Total: ${allOrdersLoaded.length} pedidos`);
                } else {
                    hasMore = false;
                }
                // REMOVIDO: if (page > 10) hasMore = false; // Limite antigo de 10 pÃ¡ginas
            }
            ordersLoaded = true; // Marcar como carregado para evitar novos carregamentos
            console.log(`âœ… Carregamento concluÃ­do: ${allOrdersLoaded.length} pedidos carregados`);
        })();
        
        await loadingPromise;
        loadingPromise = null; // Limpar a promise apÃ³s carregar para permitir novo carregamento se necessÃ¡rio
    }

    // Aplicar filtros localmente nos pedidos jÃ¡ carregados
    function applyFiltersToLoadedOrders() {
        const tbody = document.getElementById('ready-to-prepare-orders');
        if (!tbody) return;
        
        // Coletar filtros do formulÃ¡rio
        const customerName = document.getElementById('filter-customer').value.trim();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        let filteredOrders = [...allOrdersLoaded];

        // Aplicar filtro de busca (cliente ou cÃ³digo pedido)
        if (customerName) {
            const searchLower = customerName.toLowerCase();
            filteredOrders = filteredOrders.filter(order => {
                const orderId = String(order.order_id || '');
                const mlOrderId = String(order.ml_order_id || '');
                const nickname = String(order.buyer_nickname || '').toLowerCase();
                const firstName = String(order.buyer_first_name || '').toLowerCase();
                return orderId.includes(searchLower) || 
                       mlOrderId.includes(searchLower) || 
                       nickname.includes(searchLower) || 
                       firstName.includes(searchLower);
            });
        }

        // Aplicar filtro de data
        if (startDate) {
            filteredOrders = filteredOrders.filter(order => {
                const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                return orderDate >= startDate;
            });
        }
        if (endDate) {
            filteredOrders = filteredOrders.filter(order => {
                const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                return orderDate <= endDate;
            });
        }

        // Aplicar filtro lÃ³gico da aba (Pronto para Preparar, etc)
        filteredOrders = filterReadyToPrepareOrders(filteredOrders);
        
        // Remover duplicatas por ID
        const uniqueOrders = [];
        const seenIds = new Set();
        for (const order of filteredOrders) {
            const orderId = order.ml_order_id || order.order_id;
            if (!seenIds.has(orderId)) {
                seenIds.add(orderId);
                uniqueOrders.push(order);
            }
        }

        const badge = document.getElementById('ready-to-prepare-count');
        if (badge) badge.textContent = uniqueOrders.length;

        if (uniqueOrders.length > 0) {
            renderOrders(tbody, uniqueOrders);
        } else {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Nenhum pedido encontrado.</td></tr>`;
        }
    }
    
    // FunÃ§Ã£o reutilizÃ¡vel que aplica o MESMO filtro da aba "Pronto para Preparar"
    function filterReadyToPrepareOrders(allOrders) {
        return allOrders.filter(order => {
            const shippingStatus = order.shipping_details?.status || order.shipping_status;
            const substatus = order.shipping_details?.substatus;
            
            // NÃ£o mostrar se jÃ¡ foi enviado
            const hasTracking = order.shipping_status && order.shipping_status === 'shipped';
            const hasShippingDate = order.shipping_date;
            if (hasTracking || hasShippingDate) {
                return false;
            }
            
            // NÃ£o mostrar se status shipping_status indica em trÃ¢nsito
            if (shippingStatus === 'shipped' || shippingStatus === 'in_transit' || shippingStatus === 'out_for_delivery' || shippingStatus === 'soon_deliver') {
                return false;
            }
            
            // NÃ£o mostrar se o substatus indica em trÃ¢nsito ou que jÃ¡ foi coletado (mesmo com status ready_to_ship)
            if (substatus === 'in_transit' || 
                substatus === 'picked_up' || 
                substatus === 'dropped_off' || 
                substatus === 'in_hub') {
                return false;
            }
            
            // NÃ£o mostrar se foi entregue
            if (shippingStatus === 'delivered' || shippingStatus === 'inferred' || order.status === 'DELIVERED') {
                return false;
            }
            
            // NÃ£o mostrar se estÃ¡ pendente (shipping_status = pending)
            if (shippingStatus === 'pending' || order.status === 'PENDING') {
                return false;
            }
            
            // NÃ£o mostrar se status do pedido Ã© SHIPPED
            if (order.status === 'SHIPPED') {
                return false;
            }
            
            // NÃƒO mostrar pedidos prontos para envio (estes vÃ£o para "Aguardando Envio")
            if (substatus === 'ready_to_ship' || 
                substatus === 'ready_to_print' ||
                substatus === 'printed' ||
                substatus === 'ready_to_pack' ||
                substatus === 'packed' ||
                substatus === 'ready_for_pickup' ||
                substatus === 'ready_for_dropoff') {
                return false;
            }
            
            // Mostrar apenas pedidos PAID que NÃƒO estÃ£o prontos para envio
            return order.status === 'PAID';
        });
    }

    // Apenas recalcula a contagem no frontend (sem renderizar a tabela)
    async function loadReadyToPrepareCountOnly() {
        try {
            // Se ainda nÃ£o carregou todos os pedidos, carregar agora
            if (!ordersLoaded) {
                await loadAllOrdersOnce();
            }
            
            // Aplicar filtros localmente para contar
            const customerName = document.getElementById('filter-customer').value.trim();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            let filteredOrders = [...allOrdersLoaded];

            // Aplicar filtro de busca
            if (customerName) {
                const searchLower = customerName.toLowerCase();
                filteredOrders = filteredOrders.filter(order => {
                    const orderId = String(order.order_id || '');
                    const mlOrderId = String(order.ml_order_id || '');
                    const nickname = String(order.buyer_nickname || '').toLowerCase();
                    const firstName = String(order.buyer_first_name || '').toLowerCase();
                    return orderId.includes(searchLower) || 
                           mlOrderId.includes(searchLower) || 
                           nickname.includes(searchLower) || 
                           firstName.includes(searchLower);
                });
            }

            // Aplicar filtro de data
            if (startDate) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                    return orderDate >= startDate;
                });
            }
            if (endDate) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                    return orderDate <= endDate;
                });
            }

            // Aplicar filtro lÃ³gico da aba
            filteredOrders = filterReadyToPrepareOrders(filteredOrders);
            
            const badge = document.getElementById('ready-to-prepare-count');
            if (badge) badge.textContent = filteredOrders.length;
        } catch (e) {
            // Em caso de erro, nÃ£o derrubar a pÃ¡gina; apenas logar
            console.warn('Falha ao calcular contador (frontend) de Pronto para Preparar:', e);
        }
    }

    function loadManualPrepareOrders() {
        const tbody = document.getElementById('manual-prepare-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        // Buscar pedidos com status manual READY_TO_PREPARE (status que nÃ£o existe na API, apenas criado manualmente)
        fetch('/api/shipments/pending?status=READY_TO_PREPARE&page=1&limit=100', {
            credentials: 'include'  // Enviar cookies (session_token)
        })
            .then(response => {
                // Tratar erro 401
                if (handle401Error(response)) {
                    return Promise.reject('not_authenticated');
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.orders && data.orders.length > 0) {
                    renderManualOrders(tbody, data.orders);
        } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Nenhum pedido marcado para separaÃ§Ã£o.
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar pedidos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            Erro ao carregar pedidos. Tente novamente.
                        </td>
                    </tr>
                `;
            });
    }
    
    async function loadDeliveredOrders() {
        const tbody = document.getElementById('delivered-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            // Filtrar pedidos: status = DELIVERED ou shipping_status com valores de entregue
            const filteredOrders = allOrdersLoaded.filter(order => {
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                
                // Mostrar pedidos com status DELIVERED
                if (order.status === 'DELIVERED') {
                    return true;
                }
                
                // TambÃ©m mostrar se shipping_status indica entregue
                if (shippingStatus === 'delivered' || shippingStatus === 'inferred') {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderDeliveredOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido entregue encontrado.
                        </td>
                    </tr>
                `;
        }
    } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderDeliveredOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                        Nenhum pedido entregue encontrado.
                </td>
            </tr>
        `;
        return;
    }
    
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            let isPickupPoint = false;
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const substatus = order.shipping_details.substatus;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                // Identificar se Ã© ponto de coleta
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
                
                // Debug: log para verificar detecÃ§Ã£o
                if (isPickupPoint) {
                    console.log(`ðŸ” [DEBUG] Pedido ${orderId} detectado como ponto de coleta:`, {
                        logisticType,
                        shipping_type: order.shipping_type,
                        substatus,
                        shipping_id: order.shipping_id,
                        has_shipping_id: !!order.shipping_id
                    });
                }
                
                const statusHistory = order.shipping_details.status_history || {};
                const dateDelivered = statusHistory.date_delivered;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de entrega
                if (status === 'delivered' || dateDelivered) {
                    shippingInfo += `<br><small class="text-success"><strong>âœ“ Entregue</strong></small>`;
                    if (dateDelivered) {
                        const deliveredDate = new Date(dateDelivered).toLocaleDateString('pt-BR');
                        shippingInfo += `<br><small class="text-muted">ðŸ“… ${deliveredDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
        <tr>
            <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
            <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
            </td>
            <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            // Tentar destination primeiro (formato novo do ML)
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
            </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                        <i class="bi bi-clipboard"></i>
                    </button>
                            ${order.invoice_pdf_url ? 
                                `<a href="/api/shipments/download-invoice/${orderId}" class="btn btn-sm btn-outline-success" title="Baixar Nota Fiscal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>` : 
                                '<button class="btn btn-sm btn-outline-secondary" disabled title="Nota Fiscal nÃ£o disponÃ­vel"><i class="bi bi-file-earmark-pdf"></i></button>'
                            }
                            ${isPickupPoint ? 
                                (order.shipping_id ? 
                                    `<div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir Etiqueta de Envio">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                                                <i class="bi bi-printer-fill"></i> ZPL2 (Impressora TÃ©rmica)
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                                                <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 â†’ PDF (Converter)
                                            </a></li>
                                        </ul>
                                    </div>` : 
                                    `<button class="btn btn-sm btn-outline-warning" disabled title="Etiqueta disponÃ­vel apÃ³s processamento do envio (sem shipping_id)">
                                        <i class="bi bi-printer"></i>
                                    </button>`
                                ) : 
                                ''
                            }
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                </div>
            </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-delivered', updateDeliveredCount);
    }
    
    async function loadConfirmedOrders() {
        const tbody = document.getElementById('confirmed-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            // Filtrar pedidos: status = CONFIRMED
            const filteredOrders = allOrdersLoaded.filter(order => {
                return order.status === 'CONFIRMED';
            });
            
            if (filteredOrders.length > 0) {
                renderConfirmedOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhum pedido confirmado encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    async function loadPendingOrders() {
        const tbody = document.getElementById('pending-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            // Filtrar pedidos: status = PAID AND shipping_status = pending (ou nÃ£o tem shipping_status)
            const filteredOrders = allOrdersLoaded.filter(order => {
                // Verificar shipping_status
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                
                // Mostrar apenas pedidos com status PAID e shipping_status = pending
                if (order.status === 'PAID' && (shippingStatus === 'pending' || !shippingStatus)) {
                    return true;
                }
                
                // TambÃ©m mostrar pedidos com status PENDING
                if (order.status === 'PENDING') {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderPendingOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhum pedido pendente encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderConfirmedOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido confirmado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            let isPickupPoint = false;
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                // Identificar se Ã© ponto de coleta
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
                
                // Debug: log para verificar detecÃ§Ã£o
                if (isPickupPoint) {
                    console.log(`ðŸ” [DEBUG] Pedido ${orderId} detectado como ponto de coleta:`, {
                        logisticType,
                        shipping_type: order.shipping_type,
                        substatus,
                        shipping_id: order.shipping_id,
                        has_shipping_id: !!order.shipping_id
                    });
                }
                
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de envio
                if (status === 'pending') {
                    shippingInfo += `<br><small class="text-secondary">â³ Pendente</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                } else if (status === 'ready_to_ship' || status === 'ready_to_print' || status === 'printed' || status === 'packed') {
                    shippingInfo += `<br><small class="text-warning">ðŸ“¦ Pronto para Envio</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                } else {
                    shippingInfo += `<br><small class="text-muted">${status}</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
            </td>
            <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
            </td>
            <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
            </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${order.invoice_pdf_url ?
                                `<a href="/api/shipments/download-invoice/${orderId}" class="btn btn-sm btn-outline-success" title="Baixar Nota Fiscal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>` : 
                                '<button class="btn btn-sm btn-outline-secondary" disabled title="Nota Fiscal nÃ£o disponÃ­vel"><i class="bi bi-file-earmark-pdf"></i></button>'
                            }
                            ${isPickupPoint ? 
                                (order.shipping_id ? 
                                    `<div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir Etiqueta de Envio">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                                                <i class="bi bi-printer-fill"></i> ZPL2 (Impressora TÃ©rmica)
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                                                <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 â†’ PDF (Converter)
                                            </a></li>
                                        </ul>
                                    </div>` : 
                                    `<button class="btn btn-sm btn-outline-warning" disabled title="Etiqueta disponÃ­vel apÃ³s processamento do envio (sem shipping_id)">
                                        <i class="bi bi-printer"></i>
                                    </button>`
                                ) : 
                                ''
                            }
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
            </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-confirmed', 'confirmed-orders', updateConfirmedCount);
    }
    
    function renderPendingOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido pendente encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            let isPickupPoint = false;
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                const substatus = order.shipping_details.substatus;
                
                // Identificar se Ã© ponto de coleta
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
                
                // Debug: log para verificar detecÃ§Ã£o
                if (isPickupPoint) {
                    console.log(`ðŸ” [DEBUG] Pedido ${orderId} detectado como ponto de coleta:`, {
                        logisticType,
                        shipping_type: order.shipping_type,
                        substatus,
                        shipping_id: order.shipping_id,
                        has_shipping_id: !!order.shipping_id
                    });
                }
                
                const statusHistory = order.shipping_details.status_history || {};
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de envio
                if (status === 'pending') {
                    shippingInfo += `<br><small class="text-secondary">â³ Pendente</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                } else if (status === 'ready_to_ship' || status === 'ready_to_print' || status === 'printed' || status === 'packed') {
                    shippingInfo += `<br><small class="text-warning">ðŸ“¦ Pronto para Envio</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                } else {
                    shippingInfo += `<br><small class="text-muted">${status}</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
            </td>
            <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
            </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
            <td>
                <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                        </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                                <i class="bi bi-clipboard"></i>
                    </button>
                            ${order.invoice_pdf_url ? 
                                `<a href="/api/shipments/download-invoice/${orderId}" class="btn btn-sm btn-outline-success" title="Baixar Nota Fiscal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>` : 
                                '<button class="btn btn-sm btn-outline-secondary" disabled title="Nota Fiscal nÃ£o disponÃ­vel"><i class="bi bi-file-earmark-pdf"></i></button>'
                            }
                            ${isPickupPoint ? 
                                (order.shipping_id ? 
                                    `<div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir Etiqueta de Envio">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                                                <i class="bi bi-printer-fill"></i> ZPL2 (Impressora TÃ©rmica)
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                                                <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 â†’ PDF (Converter)
                                            </a></li>
                                        </ul>
                                    </div>` : 
                                    `<button class="btn btn-sm btn-outline-warning" disabled title="Etiqueta disponÃ­vel apÃ³s processamento do envio (sem shipping_id)">
                                        <i class="bi bi-printer"></i>
                                    </button>`
                                ) : 
                                ''
                            }
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                </div>
            </td>
        </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-pending', updatePendingCount);
    }
    
    // FunÃ§Ã£o para copiar nÃºmero do pedido
    async function copyOrderNumber(orderId) {
        try {
            await navigator.clipboard.writeText(orderId);
            alert('âœ… NÃºmero do pedido copiado: ' + orderId);
        } catch (err) {
            console.error('Erro ao copiar:', err);
            alert('âŒ Erro ao copiar nÃºmero do pedido');
        }
    }
    
    async function loadWaitingShipmentOrders() {
        const tbody = document.getElementById('waiting-shipment-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            // Filtrar pedidos: status = PAID e READY_TO_SHIP (prontos para envio)
            const filteredOrders = allOrdersLoaded.filter(order => {
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                const substatus = order.shipping_details?.substatus;
                
                // Mostrar apenas pedidos com status PAID
                if (order.status !== 'PAID') {
                    return false;
                }
                
                // Verificar se tem substatus de ready_to_ship
                const is_ready_to_ship = substatus === 'ready_to_ship' || 
                                        substatus === 'ready_to_print' ||
                                        substatus === 'printed' ||
                                        substatus === 'ready_to_pack' ||
                                        substatus === 'packed' ||
                                        substatus === 'ready_for_pickup' ||
                                        substatus === 'ready_for_dropoff';
                
                // Mostrar apenas se TEM substatus de ready_to_ship
                return is_ready_to_ship;
            });
            
            if (filteredOrders.length > 0) {
                renderWaitingShipmentOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido aguardando envio encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderWaitingShipmentOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido aguardando envio encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        // Reutilizar renderPendingOrders que jÃ¡ tem a estrutura correta
        renderPendingOrders(tbody, orders);
    }
    
    async function loadShippedOrders() {
        const tbody = document.getElementById('shipped-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            // Filtrar pedidos: status = SHIPPED ou shipping_status com valores de em trÃ¢nsito
            const filteredOrders = allOrdersLoaded.filter(order => {
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                const substatus = order.shipping_details?.substatus;
                
                // Mostrar pedidos com status SHIPPED ou shipping_status indicando em trÃ¢nsito
                if (order.status === 'SHIPPED') {
                    return true;
                }
                
                // TambÃ©m mostrar se shipping_status indica em trÃ¢nsito
                if (shippingStatus === 'shipped' || 
                    shippingStatus === 'in_transit' || 
                    shippingStatus === 'out_for_delivery' || 
                    shippingStatus === 'soon_deliver') {
                    return true;
                }
                
                // Mostrar se substatus indica em trÃ¢nsito ou que jÃ¡ foi coletado (mesmo com status ready_to_ship)
                if (substatus === 'in_transit' || 
                    substatus === 'picked_up' || 
                    substatus === 'dropped_off' || 
                    substatus === 'in_hub') {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderShippedOrders(tbody, filteredOrders);
        } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido enviado encontrado.
                        </td>
                    </tr>
                `;
        }
    } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderShippedOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido enviado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            let isPickupPoint = false;
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                const substatus = order.shipping_details.substatus;
                
                // Identificar se Ã© ponto de coleta
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
                
                // Debug: log para verificar detecÃ§Ã£o
                if (isPickupPoint) {
                    console.log(`ðŸ” [DEBUG] Pedido ${orderId} detectado como ponto de coleta:`, {
                        logisticType,
                        shipping_type: order.shipping_type,
                        substatus,
                        shipping_id: order.shipping_id,
                        has_shipping_id: !!order.shipping_id
                    });
                }
                
                const statusHistory = order.shipping_details.status_history || {};
                const dateShipped = statusHistory.date_shipped;
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const shippedDate = dateShipped ? new Date(dateShipped).toLocaleDateString('pt-BR') : null;
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de envio - Mostrar como "Em TrÃ¢nsito"
                if (status === 'shipped' || status === 'in_transit' || status === 'out_for_delivery' || status === 'soon_deliver') {
                    shippingInfo += `<br><small class="text-info">ðŸšš Em TrÃ¢nsito</small>`;
                    if (shippedDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸš› Enviado: ${shippedDate}</small>`;
                    }
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                } else {
                    shippingInfo += `<br><small class="text-muted">${status}</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
                    </td>
                    <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
                    </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            ${order.invoice_pdf_url ? 
                                `<a href="/api/shipments/download-invoice/${orderId}" class="btn btn-sm btn-outline-success" title="Baixar Nota Fiscal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>` : 
                                '<button class="btn btn-sm btn-outline-secondary" disabled title="Nota Fiscal nÃ£o disponÃ­vel"><i class="bi bi-file-earmark-pdf"></i></button>'
                            }
                            ${isPickupPoint ? 
                                (order.shipping_id ? 
                                    `<div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir Etiqueta de Envio">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                                                <i class="bi bi-printer-fill"></i> ZPL2 (Impressora TÃ©rmica)
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                                                <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 â†’ PDF (Converter)
                                            </a></li>
                                        </ul>
                                    </div>` : 
                                    `<button class="btn btn-sm btn-outline-warning" disabled title="Etiqueta disponÃ­vel apÃ³s processamento do envio (sem shipping_id)">
                                        <i class="bi bi-printer"></i>
                                    </button>`
                                ) : 
                                ''
                            }
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-shipped', updateShippedCount);
    }
    
    function renderManualOrders(tbody, orders) {
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        Nenhum pedido marcado para separaÃ§Ã£o.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const shippingType = order.shipping_type || 'N/A';
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td><strong>${orderId}</strong></td>
                    <td>${order.buyer_name || order.buyer_nickname || '-'}</td>
                    <td>${orderDate}</td>
                    <td>${totalAmount}</td>
                    <td><span class="badge bg-info">${shippingType}</span></td>
                    <td><span class="badge bg-warning">Status Manual</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="syncOrder('${orderId}')">
                                <i class="bi bi-arrow-clockwise"></i> Sincronizar
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-manual-prepare', updateManualPrepareCount);
    }
    
    async function loadCancelledOrders() {
        const tbody = document.getElementById('cancelled-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            const filteredOrders = allOrdersLoaded.filter(order => {
                return order.status === 'CANCELLED' || order.status === 'PENDING_CANCEL';
            });
            
            if (filteredOrders.length > 0) {
                renderCancelledOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido cancelado encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderCancelledOrders(tbody, orders) {
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido cancelado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            const statusBadge = order.status === 'CANCELLED' ? 
                '<span class="badge bg-danger">Cancelado</span>' : 
                '<span class="badge bg-warning">Pendente Cancelamento</span>';
            
            let shippingInfo = '';
            let isPickupPoint = false;
            
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const substatus = order.shipping_details.substatus;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
                
                shippingInfo = '<span class="badge bg-secondary">Cancelado</span>';
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
                isPickupPoint = order.shipping_type === 'xd_drop_off' || order.shipping_type === 'drop_off';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                    </td>
                    <td>${order.buyer_first_name || order.buyer_nickname || '-'}</td>
                    <td>${totalAmount}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-cancelled', updateCancelledCount);
    }
    
    async function loadRefundedOrders() {
        const tbody = document.getElementById('refunded-orders');
        if (!tbody) return;
        
        // Se ainda nÃ£o carregou todos os pedidos, carregar agora
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        try {
            const filteredOrders = allOrdersLoaded.filter(order => {
                return order.status === 'REFUNDED' || order.status === 'PARTIALLY_REFUNDED';
            });
            
            if (filteredOrders.length > 0) {
                renderRefundedOrders(tbody, filteredOrders);
        } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido reembolsado encontrado.
                        </td>
                    </tr>
                `;
        }
    } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderRefundedOrders(tbody, orders) {
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido reembolsado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            
            const statusBadge = order.status === 'REFUNDED' ? 
                '<span class="badge bg-danger">Reembolsado</span>' : 
                '<span class="badge bg-warning">Parcialmente Reembolsado</span>';
            
            let isPickupPoint = false;
            if (order.shipping_details) {
                const logisticType = order.shipping_details.logistic_type;
                const substatus = order.shipping_details.substatus;
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
            } else {
                isPickupPoint = order.shipping_type === 'xd_drop_off' || order.shipping_type === 'drop_off';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                    </td>
                    <td>${order.buyer_first_name || order.buyer_nickname || '-'}</td>
                    <td>${totalAmount}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            ${order.invoice_pdf_url ? 
                                `<a href="/api/shipments/download-invoice/${orderId}" class="btn btn-sm btn-outline-success" title="Baixar Nota Fiscal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>` : 
                                '<button class="btn btn-sm btn-outline-secondary" disabled title="Nota Fiscal nÃ£o disponÃ­vel"><i class="bi bi-file-earmark-pdf"></i></button>'
                            }
                            ${isPickupPoint ? 
                                (order.shipping_id ? 
                                    `<div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir Etiqueta de Envio">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                                                <i class="bi bi-printer-fill"></i> ZPL2 (Impressora TÃ©rmica)
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                                                <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 â†’ PDF (Converter)
                                            </a></li>
                                        </ul>
                                    </div>` : 
                                    `<button class="btn btn-sm btn-outline-warning" disabled title="Etiqueta disponÃ­vel apÃ³s processamento do envio (sem shipping_id)">
                                        <i class="bi bi-printer"></i>
                                    </button>`
                                ) : 
                                ''
                            }
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEventsGeneric('select-all-refunded', updateRefundedCount);
    }
    
    function renderOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            // Data e hora formatadas
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            // Extrair informaÃ§Ãµes de envio de shipping_details
            let shippingInfo = '';
            let isPickupPoint = false;
            if (order.shipping_details) {
                const status = order.shipping_details.status;  // Status principal: "delivered", "shipped", "ready_to_ship", etc.
                const substatus = order.shipping_details.substatus;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                // Identificar se Ã© ponto de coleta
                isPickupPoint = (
                    logisticType === 'xd_drop_off' || 
                    logisticType === 'drop_off' || 
                    order.shipping_type === 'xd_drop_off' || 
                    order.shipping_type === 'drop_off' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff'
                );
                
                // Debug: log para verificar detecÃ§Ã£o
                if (isPickupPoint) {
                    console.log(`ðŸ” [DEBUG] Pedido ${orderId} detectado como ponto de coleta:`, {
                        logisticType,
                        shipping_type: order.shipping_type,
                        substatus,
                        shipping_id: order.shipping_id,
                        has_shipping_id: !!order.shipping_id
                    });
                }
                
                // Extrair datas importantes
                const statusHistory = order.shipping_details.status_history || {};
                const dateShipped = statusHistory.date_shipped;
                // Tentar mÃºltiplas fontes para data prevista de entrega
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const shippedDate = dateShipped ? new Date(dateShipped).toLocaleDateString('pt-BR') : null;
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Montar badge com tipo de logÃ­stica
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Adicionar STATUS PRINCIPAL (entrega finalizada ou em andamento)
                if (status) {
                    if (status === 'delivered') {
                        // Se foi entregue, mostrar apenas a data de entrega
                        shippingInfo += `<br><small class="text-success"><strong>âœ“ Entregue</strong></small>`;
                        const dateDelivered = statusHistory.date_delivered;
                        if (dateDelivered) {
                            const deliveredDate = new Date(dateDelivered).toLocaleDateString('pt-BR');
                            shippingInfo += `<br><small class="text-success">ðŸ“… ${deliveredDate}</small>`;
                        }
                    } else if (status === 'shipped') {
                        shippingInfo += `<br><small class="text-info">ðŸšš Em TrÃ¢nsito</small>`;
                        // Mostrar data de envio e previsÃ£o de entrega
                        if (shippedDate) {
                            shippingInfo += `<br><small class="text-muted">ðŸš› Enviado: ${shippedDate}</small>`;
                        }
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                        }
                    } else if (status === 'ready_to_ship' || status === 'ready_to_print' || status === 'printed' || status === 'packed') {
                        shippingInfo += `<br><small class="text-warning">ðŸ“¦ Pronto para Envio</small>`;
                        // Mostrar apenas previsÃ£o de entrega
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                        }
                    } else if (status === 'pending') {
                        shippingInfo += `<br><small class="text-secondary">â³ Pendente</small>`;
                        // Mostrar apenas previsÃ£o de entrega
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                        }
                    } else {
                        shippingInfo += `<br><small class="text-muted">${status}</small>`;
                        // Para outros status, mostrar previsÃ£o se disponÃ­vel
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">ðŸ“… PrevisÃ£o: ${deliveryDate}</small>`;
                        }
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
                // Verificar se Ã© ponto de coleta mesmo sem shipping_details
                isPickupPoint = order.shipping_type === 'xd_drop_off' || order.shipping_type === 'drop_off';
                
                // Debug: log para verificar detecÃ§Ã£o
                if (isPickupPoint) {
                    console.log(`ðŸ” [DEBUG] Pedido ${orderId} detectado como ponto de coleta (sem shipping_details):`, {
                        shipping_type: order.shipping_type,
                        shipping_id: order.shipping_id,
                        has_shipping_id: !!order.shipping_id
                    });
                }
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
                        ${order.sale_id ? `<br><small class="text-muted">Venda: ${order.sale_id}</small>` : ''}
                    </td>
                    <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            // Tentar destination primeiro (formato novo do ML)
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                // Nome do destinatÃ¡rio estÃ¡ em destination.receiver_name
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                // EndereÃ§o estÃ¡ em destination.shipping_address.address_line
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                // Cidade e estado
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            // Fallback para receiver_address ou shipping_address
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
                    </td>
                    <td>${totalAmount}</td>
                    <td>
                        ${shippingInfo}
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Visualizar detalhes">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="copyOrderNumber('${orderId}')" title="Copiar nÃºmero do pedido">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            ${order.invoice_pdf_url ? 
                                `<a href="/api/shipments/download-invoice/${orderId}" class="btn btn-sm btn-outline-success" title="Baixar Nota Fiscal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>` : 
                                '<button class="btn btn-sm btn-outline-secondary" disabled title="Nota Fiscal nÃ£o disponÃ­vel"><i class="bi bi-file-earmark-pdf"></i></button>'
                            }
                            ${isPickupPoint ? 
                                (order.shipping_id ? 
                                    `<div class="btn-group" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir Etiqueta de Envio">
                                            <i class="bi bi-printer"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                                                <i class="bi bi-printer-fill"></i> ZPL2 (Impressora TÃ©rmica)
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                                                <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 â†’ PDF (Converter)
                                            </a></li>
                                        </ul>
                                    </div>` : 
                                    `<button class="btn btn-sm btn-outline-warning" disabled title="Etiqueta disponÃ­vel apÃ³s processamento do envio (sem shipping_id)">
                                        <i class="bi bi-printer"></i>
                                    </button>`
                                ) : 
                                ''
                            }
                            <a href="/ml/orders/${orderId}" class="btn btn-sm btn-outline-info" title="Ver no Mercado Livre">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes apÃ³s renderizar
        setupCheckboxEvents();
    }
    
    // FunÃ§Ã£o genÃ©rica para configurar eventos de qualquer aba
    function setupCheckboxEventsGeneric(selectAllId, tbodyId, countUpdateFunc) {
        const selectAllCheckbox = document.getElementById(selectAllId);
        const tbody = document.getElementById(tbodyId);
        
        if (!tbody) return;
        
        // Buscar checkboxes APENAS dentro deste tbody especÃ­fico
        const orderCheckboxes = tbody.querySelectorAll('.order-checkbox');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                orderCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                countUpdateFunc();
            });
        }
        
        // Checkboxes individuais
        orderCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Atualizar checkbox "Selecionar todos"
                if (selectAllCheckbox) {
                    const allChecked = Array.from(orderCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(orderCheckboxes).some(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                }
                countUpdateFunc();
            });
        });
    }
    
    function setupCheckboxEvents() {
        setupCheckboxEventsGeneric('select-all-orders', 'ready-to-prepare-orders', updateSelectedCount);
    }
    
    // FunÃ§Ã£o genÃ©rica para atualizar contador de qualquer aba
    function updateSelectedCountGeneric(countId, buttonId, tbodyId) {
        const tbody = document.getElementById(tbodyId);
        let selectedCheckboxes = [];
        
        if (tbody) {
            // Buscar checkboxes APENAS dentro deste tbody especÃ­fico
            selectedCheckboxes = tbody.querySelectorAll('.order-checkbox:checked');
        }
        
        const count = selectedCheckboxes.length;
        const selectedCountEl = document.getElementById(countId);
        const updateButton = document.getElementById(buttonId);
        
        if (selectedCountEl) {
            selectedCountEl.textContent = `${count} selecionado(s)`;
        }
        
        if (updateButton) {
            updateButton.disabled = count === 0;
        }
    }
    
    function updateSelectedCount() {
        updateSelectedCountGeneric('selected-count', 'update-selected-orders', 'ready-to-prepare-orders');
    }
    
    // FunÃ§Ãµes para cada aba
    function updateConfirmedCount() {
        updateSelectedCountGeneric('confirmed-selected-count', 'update-confirmed-orders', 'confirmed-orders');
    }
    
    function updatePendingCount() {
        updateSelectedCountGeneric('pending-selected-count', 'update-pending-orders', 'pending-orders');
    }
    
    function updateWaitingShipmentCount() {
        updateSelectedCountGeneric('waiting-shipment-selected-count', 'update-waiting-shipment-orders', 'waiting-shipment-orders');
    }
    
    function updateShippedCount() {
        updateSelectedCountGeneric('shipped-selected-count', 'update-shipped-orders', 'shipped-orders');
    }
    
    function updateDeliveredCount() {
        updateSelectedCountGeneric('delivered-selected-count', 'update-delivered-orders', 'delivered-orders');
    }
    
    function updateCancelledCount() {
        updateSelectedCountGeneric('cancelled-selected-count', 'update-cancelled-orders', 'cancelled-orders');
    }
    
    function updateRefundedCount() {
        updateSelectedCountGeneric('refunded-selected-count', 'update-refunded-orders', 'refunded-orders');
    }
    
    function updateManualPrepareCount() {
        updateSelectedCountGeneric('manual-prepare-selected-count', 'update-manual-prepare-orders', 'manual-prepare-orders');
    }
    
    // FunÃ§Ã£o genÃ©rica para atualizar pedidos de qualquer aba
    function updateSelectedOrders(buttonId, selectAllId, checkboxClass, countId, reloadFunction, tbodyId) {
        let selectedCheckboxes = [];
        if (tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (tbody) {
                selectedCheckboxes = tbody.querySelectorAll(`${checkboxClass}:checked`);
            }
        } else {
            selectedCheckboxes = document.querySelectorAll(`${checkboxClass}:checked`);
        }
        const orderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        console.log('ðŸ”„ [FRONTEND] Iniciando atualizaÃ§Ã£o de pedidos selecionados');
        console.log(`ðŸ“‹ [FRONTEND] Pedidos selecionados: ${orderIds.length}`);
        console.log(`ðŸ“‹ [FRONTEND] IDs: ${orderIds.join(', ')}`);
        
        if (orderIds.length === 0) {
            console.warn('âš ï¸ [FRONTEND] Nenhum pedido selecionado');
            return;
        }
        
        const updateButton = document.getElementById(buttonId);
        const originalText = updateButton.innerHTML;
        updateButton.disabled = true;
        updateButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Atualizando...';
        
        // Criar AbortController para timeout de 5 minutos
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutos
        
        console.log('ðŸ“¡ [FRONTEND] Enviando requisiÃ§Ã£o POST para /api/shipments/bulk-update');
        
        // Fazer requisiÃ§Ã£o para atualizar os pedidos
        fetch('/api/shipments/bulk-update', {
            method: 'POST',
            credentials: 'include',  // Enviar cookies (session_token)
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_ids: orderIds
            }),
            signal: controller.signal
        })
        .then(response => {
            console.log(`ðŸ“¡ [FRONTEND] Resposta recebida: status=${response.status}`);
            clearTimeout(timeoutId);
            
            // Tratar erro 401
            if (handle401Error(response)) {
                return Promise.reject('not_authenticated');
            }
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.error(`âŒ [FRONTEND] Erro na resposta HTTP: status=${response.status}, body=${text}`);
                    throw new Error(`Erro HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('âœ… [FRONTEND] Dados recebidos:', data);
            
            if (data.success) {
                console.log(`âœ… [FRONTEND] ${data.success_count || 0} pedido(s) atualizado(s) com sucesso, ${data.failure_count || 0} falharam`);
                console.log('ðŸ”„ [FRONTEND] Recarregando lista de pedidos...');
                
                // Recarregar a lista usando a funÃ§Ã£o fornecida
                if (reloadFunction && typeof reloadFunction === 'function') {
                    reloadFunction();
                }
                
                // Desmarcar todos os checkboxes
                document.querySelectorAll(checkboxClass).forEach(cb => cb.checked = false);
                const selectAll = document.getElementById(selectAllId);
                if (selectAll) selectAll.checked = false;
                
                // Atualizar contador
                const countEl = document.getElementById(countId);
                if (countEl) countEl.textContent = '0 selecionado(s)';
                
                console.log('âœ… [FRONTEND] AtualizaÃ§Ã£o concluÃ­da com sucesso');
            } else {
                console.error('âŒ [FRONTEND] Resposta indicou erro:', data.error);
                throw new Error(data.error || 'Erro ao atualizar pedidos');
            }
        })
        .catch(error => {
            console.error('âŒ [FRONTEND] Erro ao atualizar pedidos:', error);
            if (error.name === 'AbortError') {
                console.error('âŒ [FRONTEND] Timeout na requisiÃ§Ã£o (5 minutos)');
            }
        })
        .finally(() => {
            console.log('ðŸ [FRONTEND] Finalizando atualizaÃ§Ã£o');
            updateButton.disabled = false;
            updateButton.innerHTML = originalText;
        });
    }
    
    // FunÃ§Ã£o para ver detalhes do pedido completo
    // FunÃ§Ã£o para mostrar modal de sincronizaÃ§Ã£o
    function showSyncModal(type, title, message, details = null) {
        const modal = document.getElementById('syncModal');
        const modalLabel = document.getElementById('syncModalLabel');
        const modalHeader = document.getElementById('syncModalHeader');
        const modalBody = document.getElementById('syncModalBody');
        const modalIcon = document.getElementById('syncModalIcon');
        
        // Limpar classes anteriores
        modalHeader.className = 'modal-header';
        modalIcon.className = '';
        
        if (type === 'success') {
            modalHeader.classList.add('bg-success', 'text-white');
            modalIcon.className = 'bi bi-check-circle-fill text-white me-2';
            modalLabel.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> ' + title;
        } else {
            modalHeader.classList.add('bg-danger', 'text-white');
            modalIcon.className = 'bi bi-x-circle-fill text-white me-2';
            modalLabel.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i> ' + title;
        }
        
        // Construir conteÃºdo do body
        let bodyContent = `<p class="mb-0">${message}</p>`;
        
        if (details && type === 'success') {
            bodyContent += '<hr class="my-3">';
            bodyContent += '<div class="row g-2">';
            if (details.total_saved > 0) {
                bodyContent += `
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="h4 mb-0 text-success">${details.total_saved}</div>
                            <small class="text-muted">Novos pedidos</small>
                        </div>
                    </div>
                `;
            }
            if (details.total_updated > 0) {
                bodyContent += `
                    <div class="col-6">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="h4 mb-0 text-primary">${details.total_updated}</div>
                            <small class="text-muted">Pedidos atualizados</small>
                        </div>
                    </div>
                `;
            }
            bodyContent += '</div>';
        }
        
        modalBody.innerHTML = bodyContent;
        
        // Mostrar modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }
    
    window.viewOrderDetails = function(orderId) {
        // Buscar o pedido no array de orders carregado
        const order = window.currentOrders?.find(o => o.order_id === orderId || o.ml_order_id === orderId);
        
        if (!order) {
            alert('Pedido nÃ£o encontrado');
            return;
        }
        
        // Criar conteÃºdo de texto com todos os campos
        let textContent = `DETALHES DO PEDIDO\n`;
        textContent += `${'='.repeat(50)}\n\n`;
        
        textContent += `ID do Pedido: ${order.order_id || order.ml_order_id || '-'}\n`;
        textContent += `Data de CriaÃ§Ã£o: ${order.date_created || '-'}\n`;
        textContent += `Status: ${order.status || '-'}\n`;
        textContent += `Total: R$ ${order.total_amount || '0.00'}\n\n`;
        
        textContent += `INFORMAÃ‡Ã•ES DO COMPRADOR\n`;
        textContent += `${'-'.repeat(50)}\n`;
        textContent += `Nome: ${order.buyer_first_name || order.buyer_nickname || '-'}\n`;
        textContent += `Nickname: ${order.buyer_nickname || '-'}\n`;
        textContent += `Email: ${order.buyer_email || '-'}\n\n`;
        
        if (order.shipping_address || order.shipping_details) {
            textContent += `ENDEREÃ‡O DE ENVIO\n`;
            textContent += `${'-'.repeat(50)}\n`;
            const dest = order.shipping_details?.destination;
            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
            const addr = dest?.shipping_address || fallback;
            if (addr) {
                textContent += `Nome: ${addr.receiver_name || dest?.receiver_name || '-'}\n`;
                textContent += `EndereÃ§o: ${addr.address_line || '-'}\n`;
                textContent += `Cidade: ${addr.city?.name || addr.city || '-'}\n`;
                textContent += `Estado: ${addr.state?.name || addr.state || '-'}\n`;
                textContent += `CEP: ${addr.zip_code || '-'}\n`;
            }
            textContent += `\n`;
        }
        
        textContent += `FORMA DE ENVIO\n`;
        textContent += `${'-'.repeat(50)}\n`;
        textContent += `Tipo: ${order.shipping_type || '-'}\n`;
        if (order.shipping_details) {
            textContent += `Status: ${order.shipping_details.status || '-'}\n`;
            textContent += `Substatus: ${order.shipping_details.substatus || '-'}\n`;
        }
        if (order.shipping_date) {
            textContent += `Data de Envio: ${order.shipping_date}\n`;
        }
        if (order.estimated_delivery_date) {
            textContent += `PrevisÃ£o de Entrega: ${order.estimated_delivery_date}\n`;
        }
        textContent += `\n`;
        
        if (order.invoice_emitted) {
            textContent += `NOTA FISCAL\n`;
            textContent += `${'-'.repeat(50)}\n`;
            textContent += `Emitida: Sim\n`;
            textContent += `NÃºmero: ${order.invoice_number || '-'}\n`;
            textContent += `SÃ©rie: ${order.invoice_series || '-'}\n`;
            textContent += `Chave: ${order.invoice_key || '-'}\n`;
            if (order.invoice_emitted_at) {
                textContent += `Data: ${order.invoice_emitted_at}\n`;
            }
            textContent += `\n`;
        }
        
        // JSON completo no final
        textContent += `JSON COMPLETO\n`;
        textContent += `${'-'.repeat(50)}\n`;
        textContent += JSON.stringify(order, null, 2);
        
        // Exibir no modal
        document.getElementById('json-content').textContent = textContent;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
        modal.show();
    };
    
    // ============================================
    // CONFIGURAR EVENTOS DE TODAS AS ABAS
    // ============================================
    
    // Helper para configurar uma aba completa
    function setupTab(selectAllId, buttonId, tbodyId, countUpdateFunc, reloadFunc) {
        const selectAllCheckbox = document.getElementById(selectAllId);
        const updateButton = document.getElementById(buttonId);
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const tbody = document.getElementById(tbodyId);
                if (tbody) {
                    tbody.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = this.checked);
                    countUpdateFunc();
                }
            });
        }
        
        if (updateButton) {
            updateButton.addEventListener('click', () => {
                updateSelectedOrders(
                    buttonId,
                    selectAllId,
                    '.order-checkbox',
                    buttonId.replace('update-', '').replace('-orders', '-selected-count'),
                    reloadFunc,
                    tbodyId
                );
            });
        }
    }
    
    // Configurar eventos para cada aba
    setupTab('select-all-confirmed', 'update-confirmed-orders', 'confirmed-orders', updateConfirmedCount, loadConfirmedOrders);
    setupTab('select-all-pending', 'update-pending-orders', 'pending-orders', updatePendingCount, loadPendingOrders);
    setupTab('select-all-waiting-shipment', 'update-waiting-shipment-orders', 'waiting-shipment-orders', updateWaitingShipmentCount, loadWaitingShipmentOrders);
    setupTab('select-all-shipped', 'update-shipped-orders', 'shipped-orders', updateShippedCount, loadShippedOrders);
    setupTab('select-all-delivered', 'update-delivered-orders', 'delivered-orders', updateDeliveredCount, loadDeliveredOrders);
    setupTab('select-all-cancelled', 'update-cancelled-orders', 'cancelled-orders', updateCancelledCount, loadCancelledOrders);
    setupTab('select-all-refunded', 'update-refunded-orders', 'refunded-orders', updateRefundedCount, loadRefundedOrders);
    setupTab('select-all-manual-prepare', 'update-manual-prepare-orders', 'manual-prepare-orders', updateManualPrepareCount, loadManualPrepareOrders);
});
</script>

<!-- Modal para mensagens de sincronizaÃ§Ã£o -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="syncModalHeader">
                <h5 class="modal-title" id="syncModalLabel">
                    <i class="bi bi-check-circle-fill text-success" id="syncModalIcon"></i> SincronizaÃ§Ã£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="syncModalBody">
                <!-- ConteÃºdo serÃ¡ preenchido dinamicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para exibir detalhes completos -->
<div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jsonModalLabel">
                    <i class="bi bi-eye"></i> Detalhes do Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="json-content" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copyJsonToClipboard()">
                    <i class="bi bi-clipboard"></i> Copiar Texto
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// FunÃ§Ã£o para copiar texto para a Ã¡rea de transferÃªncia
function copyJsonToClipboard() {
    const textContent = document.getElementById('json-content').textContent;
    navigator.clipboard.writeText(textContent).then(() => {
        alert('âœ… Texto copiado para a Ã¡rea de transferÃªncia!');
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('âŒ Erro ao copiar texto');
    });
}
</script>
{% endblock %}
