{% extends "base.html" %}

{% block title %}Expedi√ß√£o de Produtos{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                    <i class="bi bi-box-seam"></i> Expedi√ß√£o de Produtos
                </h1>

            <!-- Card com Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Filtros r√°pidos acima da listagem de pedidos -->
                    <form id="filter-form" class="row g-2 align-items-end">
                        <div class="col-auto">
                            <label for="filter-period" class="form-label mb-0 small">Per√≠odo</label>
                            <select class="form-select" id="filter-period">
                                <option value="">Todos</option>
                                <option value="15_days">√öltimos 15 dias</option>
                                <option value="30_days">√öltimos 30 dias</option>
                                <option value="today">Hoje</option>
                                <option value="week">Esta Semana</option>
                                <option value="month">Este M√™s</option>
                                <option value="last_month">M√™s Passado</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <label for="filter-customer" class="form-label mb-0 small">Buscar</label>
                            <input type="text" class="form-control" id="filter-customer" placeholder="Nome do cliente ou c√≥digo do pedido" style="min-width: 280px;">
                        </div>
                        <div class="col-auto" id="custom-dates" style="display: none;">
                            <label for="filter-start-date" class="form-label mb-0 small">Data Inicial</label>
                            <input type="date" class="form-control" id="filter-start-date">
                        </div>
                        <div class="col-auto" id="custom-dates-end" style="display: none;">
                            <label for="filter-end-date" class="form-label mb-0 small">Data Final</label>
                            <input type="date" class="form-control" id="filter-end-date">
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-outline-secondary" id="clear-filters">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Card com Tabs de Status -->
            <div class="card">
                <div class="card-body">
                    <!-- Tabs de Status com Scroll Horizontal -->
                    <div class="tabs-scroll-container mb-3" style="overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch;">
                        <ul class="nav nav-tabs mb-0 flex-nowrap" id="statusTabs" role="tablist" style="display: flex; flex-wrap: nowrap; white-space: nowrap;">
                                <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                                Pendentes
                                <span class="badge bg-secondary ms-1" id="pending-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                                Confirmados
                                <span class="badge bg-secondary ms-1" id="confirmed-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ready-to-prepare-tab" data-bs-toggle="tab" data-bs-target="#ready-to-prepare" type="button" role="tab">
                                Pronto para Preparar
                                <span class="badge bg-secondary ms-1" id="ready-to-prepare-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-prepare-tab" data-bs-toggle="tab" data-bs-target="#manual-prepare" type="button" role="tab">
                                Separar Pedidos
                                <span class="badge bg-warning ms-1" id="manual-prepare-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="waiting-shipment-tab" data-bs-toggle="tab" data-bs-target="#waiting-shipment" type="button" role="tab">
                                Aguardando Envio
                                <span class="badge bg-secondary ms-1" id="waiting-shipment-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="shipped-tab" data-bs-toggle="tab" data-bs-target="#shipped" type="button" role="tab">
                                Enviados
                                <span class="badge bg-secondary ms-1" id="shipped-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="delivered-tab" data-bs-toggle="tab" data-bs-target="#delivered" type="button" role="tab">
                                Entregues
                                <span class="badge bg-secondary ms-1" id="delivered-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                                Cancelados
                                <span class="badge bg-secondary ms-1" id="cancelled-count">0</span>
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="refunded-tab" data-bs-toggle="tab" data-bs-target="#refunded" type="button" role="tab">
                                Reembolsados
                                <span class="badge bg-secondary ms-1" id="refunded-count">0</span>
                                    </button>
                                </li>
                            </ul>
                        </div>

                    <!-- Conte√∫do das Tabs -->
                    <div class="tab-content" id="statusTabsContent">

                        <!-- Tab Pendentes -->
                <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                            <h5 class="card-title">Pendentes</h5>
                            <p class="text-muted">Pedidos aguardando confirma√ß√£o ou pagamento.</p>
                            
                            <!-- Tabela de Pedidos Pendentes -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pending-orders">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                </div>

                        <!-- Tab Confirmados -->
                <div class="tab-pane fade" id="confirmed" role="tabpanel" aria-labelledby="confirmed-tab">
                            <h5 class="card-title">Confirmados</h5>
                            <p class="text-muted">Pedidos confirmados mas ainda n√£o pagos.</p>
                            <!-- Tabela ser√° adicionada aqui -->
                </div>

                <!-- Tab Pronto para Preparar -->
                <div class="tab-pane fade show active" id="ready-to-prepare" role="tabpanel" aria-labelledby="ready-to-prepare-tab">
                            <!-- Bot√£o de Atualiza√ß√£o -->
                            <div class="mb-3">
                                <button class="btn btn-primary" id="update-selected-orders" disabled>
                                    <i class="bi bi-arrow-clockwise"></i> Atualizar Selecionados
                                </button>
                                <span class="ms-2 text-muted" id="selected-count">0 selecionado(s)</span>
                            </div>
                            
                            <!-- Tabela de Pedidos -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="select-all-orders" title="Selecionar todos">
                                            </th>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ready-to-prepare-orders">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                </div>

                <!-- Tab Separar Pedidos (Manual Status) -->
                <div class="tab-pane fade" id="manual-prepare" role="tabpanel" aria-labelledby="manual-prepare-tab">
                            <h5 class="card-title">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i> Separar Pedidos
                            </h5>
                            <p class="text-muted">Pedidos marcados manualmente para separa√ß√£o. Status: READY_TO_PREPARE</p>
                            
                            <!-- Tabela de Pedidos -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Data</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>Status Manual</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="manual-prepare-orders">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                <!-- Tab Aguardando Envio -->
                <div class="tab-pane fade" id="waiting-shipment" role="tabpanel" aria-labelledby="waiting-shipment-tab">
                            <h5 class="card-title">Aguardando Envio</h5>
                            <p class="text-muted">Pedidos pagos e prontos para envio.</p>
                            
                            <!-- Tabela de Pedidos Aguardando Envio -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="waiting-shipment-orders">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        <!-- Tab Enviados -->
                <div class="tab-pane fade" id="shipped" role="tabpanel" aria-labelledby="shipped-tab">
                            <h5 class="card-title">Enviados</h5>
                            <p class="text-muted">Pedidos que j√° foram enviados e est√£o em tr√¢nsito.</p>
                            
                            <!-- Tabela de Pedidos Enviados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shipped-orders">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        <!-- Tab Entregues -->
                <div class="tab-pane fade" id="delivered" role="tabpanel" aria-labelledby="delivered-tab">
                            <h5 class="card-title">Entregues</h5>
                            <p class="text-muted">Pedidos que foram entregues ao cliente.</p>
                            
                            <!-- Tabela de Pedidos Entregues -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Forma de Envio</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="delivered-orders">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        <!-- Tab Cancelados -->
                <div class="tab-pane fade" id="cancelled" role="tabpanel" aria-labelledby="cancelled-tab">
                            <h5 class="card-title">Cancelados</h5>
                            <p class="text-muted">Pedidos que foram cancelados.</p>
                            
                            <!-- Tabela de Pedidos Cancelados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cancelled-orders">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        <!-- Tab Reembolsados -->
                <div class="tab-pane fade" id="refunded" role="tabpanel" aria-labelledby="refunded-tab">
                            <h5 class="card-title">Reembolsados</h5>
                            <p class="text-muted">Pedidos que foram reembolsados completamente ou parcialmente.</p>
                            
                            <!-- Tabela de Pedidos Reembolsados -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Pedido</th>
                                            <th>Comprador</th>
                                            <th>Valor</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="refunded-orders">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                Carregando pedidos...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .tabs-scroll-container {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }
    
    .tabs-scroll-container::-webkit-scrollbar {
        height: 8px;
    }
    
    .tabs-scroll-container::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }
    
    .tabs-scroll-container::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    
    .tabs-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    
    #statusTabs .nav-item {
        flex-shrink: 0;
    }
    
    #statusTabs .nav-link {
        white-space: nowrap;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Vari√°vel global para armazenar todos os pedidos carregados
    let allOrdersLoaded = [];
    let ordersLoaded = false;
    let loadingPromise = null; // Promise para evitar carregamento duplicado

    // Carregar contadores de todas as abas ao iniciar
    loadTabCounts();
    
    // Carregar pedidos da aba "Pronto para Preparar" ao carregar a p√°gina
    // Isso j√° vai calcular o contador tamb√©m
    loadReadyToPrepareOrders();
    
    // Carregar pedidos quando a aba for clicada
    const readyToPrepareTab = document.getElementById('ready-to-prepare-tab');
    if (readyToPrepareTab) {
        readyToPrepareTab.addEventListener('shown.bs.tab', function() {
            loadReadyToPrepareOrders();
        });
    }
    
    // Carregar pedidos da aba Separar Pedidos (Status Manual)
    const manualPrepareTab = document.getElementById('manual-prepare-tab');
    if (manualPrepareTab) {
        manualPrepareTab.addEventListener('shown.bs.tab', function() {
            loadManualPrepareOrders();
        });
    }
    
    // Carregar pedidos da aba Entregues
    const deliveredTab = document.getElementById('delivered-tab');
    if (deliveredTab) {
        deliveredTab.addEventListener('shown.bs.tab', function() {
            loadDeliveredOrders();
        });
    }
    
    // Carregar pedidos da aba Pendentes
    const pendingTab = document.getElementById('pending-tab');
    if (pendingTab) {
        pendingTab.addEventListener('shown.bs.tab', function() {
            loadPendingOrders();
        });
    }
    
    // Carregar pedidos da aba Aguardando Envio
    const waitingShipmentTab = document.getElementById('waiting-shipment-tab');
    if (waitingShipmentTab) {
        waitingShipmentTab.addEventListener('shown.bs.tab', function() {
            loadWaitingShipmentOrders();
        });
    }
    
    // Carregar pedidos da aba Enviados
    const shippedTab = document.getElementById('shipped-tab');
    if (shippedTab) {
        shippedTab.addEventListener('shown.bs.tab', function() {
            loadShippedOrders();
        });
    }
    
    // Carregar pedidos da aba Cancelados
    const cancelledTab = document.getElementById('cancelled-tab');
    if (cancelledTab) {
        cancelledTab.addEventListener('shown.bs.tab', function() {
            loadCancelledOrders();
        });
    }
    
    // Carregar pedidos da aba Reembolsados
    const refundedTab = document.getElementById('refunded-tab');
    if (refundedTab) {
        refundedTab.addEventListener('shown.bs.tab', function() {
            loadRefundedOrders();
        });
    }
    
    // Fun√ß√£o para carregar contadores de todas as abas
    async function loadTabCounts() {
        try {
            // Buscar contadores do backend
            const response = await fetch('/api/shipments/tab-counts');
            
            // Tratar erro 401
            if (handle401Error(response)) {
            return;
            }
            
            if (!response.ok) {
                throw new Error('Erro ao carregar contadores');
        }
        
        const data = await response.json();
        
        if (data.success) {
                // Atualizar contadores de cada aba
                document.getElementById('pending-count').textContent = data.counts?.PENDING || 0;
                document.getElementById('confirmed-count').textContent = data.counts?.CONFIRMED || 0;
                document.getElementById('ready-to-prepare-count').textContent = data.counts?.READY_TO_PREPARE || 0;
                document.getElementById('manual-prepare-count').textContent = data.counts?.READY_TO_PREPARE || 0;
                document.getElementById('waiting-shipment-count').textContent = data.counts?.WAITING_SHIPMENT || 0;
                document.getElementById('shipped-count').textContent = data.counts?.SHIPPED || 0;
                document.getElementById('delivered-count').textContent = data.counts?.DELIVERED || 0;
                document.getElementById('cancelled-count').textContent = data.counts?.CANCELLED || 0;
                document.getElementById('refunded-count').textContent = data.counts?.REFUNDED || 0;
                
                console.log('üìä Contadores recebidos:', data.counts);
        }
    } catch (error) {
            console.error('Erro ao carregar contadores:', error);
        }
    }
    
    // Fun√ß√£o para tratar erros 401 (n√£o autenticado)
    function handle401Error(response) {
        if (response && response.status === 401) {
            console.warn('‚ö†Ô∏è N√£o autenticado, redirecionando para login...');
            window.location.href = '/auth/login';
            return true;
        }
        return false;
    }
    
    // Listener para mudan√ßa de per√≠odo - preencher datas automaticamente
    document.getElementById('filter-period').addEventListener('change', function() {
        const period = this.value;
        const startDateInput = document.getElementById('filter-start-date');
        const endDateInput = document.getElementById('filter-end-date');
        const customDatesContainer = document.getElementById('custom-dates');
        const customDatesEndContainer = document.getElementById('custom-dates-end');
        
        const today = new Date();
        const formatDate = (date) => date.toISOString().split('T')[0];
        
        if (period === 'custom') {
            customDatesContainer.style.display = 'block';
            customDatesEndContainer.style.display = 'block';
        } else {
            customDatesContainer.style.display = 'none';
            customDatesEndContainer.style.display = 'none';
            
            if (period === '15_days') {
                const fifteenDaysAgo = new Date(today);
                fifteenDaysAgo.setDate(today.getDate() - 15);
                startDateInput.value = formatDate(fifteenDaysAgo);
                endDateInput.value = formatDate(today);
            } else if (period === '30_days') {
                const thirtyDaysAgo = new Date(today);
                thirtyDaysAgo.setDate(today.getDate() - 30);
                startDateInput.value = formatDate(thirtyDaysAgo);
                endDateInput.value = formatDate(today);
            } else if (period === 'today') {
                startDateInput.value = formatDate(today);
                endDateInput.value = formatDate(today);
            } else if (period === 'week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                startDateInput.value = formatDate(weekStart);
                endDateInput.value = formatDate(today);
            } else if (period === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                startDateInput.value = formatDate(monthStart);
                endDateInput.value = formatDate(today);
            } else if (period === 'last_month') {
                const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                startDateInput.value = formatDate(lastMonthStart);
                endDateInput.value = formatDate(lastMonthEnd);
            } else {
                // Todos
                startDateInput.value = '';
                endDateInput.value = '';
            }
            
            // Aplicar filtros automaticamente ao mudar per√≠odo
            if (ordersLoaded) {
                applyFiltersToLoadedOrders();
            } else {
                loadReadyToPrepareOrders(1);
            }
        }
    });
    
    // Listener para buscar cliente ao digitar (debounce)
    let customerSearchTimeout;
    document.getElementById('filter-customer').addEventListener('input', function() {
        clearTimeout(customerSearchTimeout);
        customerSearchTimeout = setTimeout(() => {
            if (ordersLoaded) {
                applyFiltersToLoadedOrders();
            } else {
                loadReadyToPrepareOrders(1);
            }
        }, 500); // Aguarda 500ms ap√≥s parar de digitar
    });
    
    // Bot√£o Limpar filtros
    document.getElementById('clear-filters').addEventListener('click', function() {
        document.getElementById('filter-period').value = '';
        document.getElementById('filter-customer').value = '';
        document.getElementById('filter-start-date').value = '';
        document.getElementById('filter-end-date').value = '';
        document.getElementById('custom-dates').style.display = 'none';
        document.getElementById('custom-dates-end').style.display = 'none';
        if (ordersLoaded) {
            applyFiltersToLoadedOrders();
        } else {
            loadReadyToPrepareOrders(1);
        }
    });

    // Modifique a loadReadyToPrepareOrders para aceitar p√°gina e ler filtros:
    async function loadReadyToPrepareOrders(page = 1) {
        // Se ainda n√£o carregou todos os pedidos, carregar agora (sem filtros do servidor)
        if (!ordersLoaded) {
            await loadAllOrdersOnce();
        }
        
        // Aplicar filtros localmente
        applyFiltersToLoadedOrders();
    }

    // Carregar todos os pedidos UMA VEZ (sem filtros) e armazenar globalmente
    async function loadAllOrdersOnce() {
        // Se j√° est√° carregando, aguardar a promise existente
        if (loadingPromise) {
            return await loadingPromise;
        }
        
        if (ordersLoaded) return; // J√° carregou
        
        // Criar promise de carregamento para evitar duplica√ß√£o
        loadingPromise = (async () => {
            const tbody = document.getElementById('ready-to-prepare-orders');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted"><div class="spinner-border spinner-border-sm" role="status"></div> Carregando pedidos...</td></tr>`;
            let hasMore = true;
            let page = 1;
            const limit = 1000;
            
            // Resetar array para evitar duplica√ß√µes
            allOrdersLoaded = [];

            // Buscar TODOS os pedidos (SEM filtros)
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=${limit}`);
                if (handle401Error(response)) return;
                if (!response.ok) throw new Error('Erro ao carregar pedidos');
                const data = await response.json();
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrdersLoaded = allOrdersLoaded.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
                } else {
                    hasMore = false;
                }
                if (page > 10) hasMore = false;
            }
            ordersLoaded = true;
        })();
        
        await loadingPromise;
        loadingPromise = null; // Limpar a promise ap√≥s carregar
    }

    // Aplicar filtros localmente nos pedidos j√° carregados
    function applyFiltersToLoadedOrders() {
        const tbody = document.getElementById('ready-to-prepare-orders');
        if (!tbody) return;
        
        // Coletar filtros do formul√°rio
        const customerName = document.getElementById('filter-customer').value.trim();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        let filteredOrders = [...allOrdersLoaded];

        // Aplicar filtro de busca (cliente ou c√≥digo pedido)
        if (customerName) {
            const searchLower = customerName.toLowerCase();
            filteredOrders = filteredOrders.filter(order => {
                const orderId = String(order.order_id || '');
                const mlOrderId = String(order.ml_order_id || '');
                const nickname = String(order.buyer_nickname || '').toLowerCase();
                const firstName = String(order.buyer_first_name || '').toLowerCase();
                return orderId.includes(searchLower) || 
                       mlOrderId.includes(searchLower) || 
                       nickname.includes(searchLower) || 
                       firstName.includes(searchLower);
            });
        }

        // Aplicar filtro de data
        if (startDate) {
            filteredOrders = filteredOrders.filter(order => {
                const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                return orderDate >= startDate;
            });
        }
        if (endDate) {
            filteredOrders = filteredOrders.filter(order => {
                const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                return orderDate <= endDate;
            });
        }

        // Aplicar filtro l√≥gico da aba (Pronto para Preparar, etc)
        filteredOrders = filterReadyToPrepareOrders(filteredOrders);
        
        // Remover duplicatas por ID
        const uniqueOrders = [];
        const seenIds = new Set();
        for (const order of filteredOrders) {
            const orderId = order.ml_order_id || order.order_id;
            if (!seenIds.has(orderId)) {
                seenIds.add(orderId);
                uniqueOrders.push(order);
            }
        }

        const badge = document.getElementById('ready-to-prepare-count');
        if (badge) badge.textContent = uniqueOrders.length;

        if (uniqueOrders.length > 0) {
            renderOrders(tbody, uniqueOrders);
        } else {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Nenhum pedido encontrado.</td></tr>`;
        }
    }
    
    // Fun√ß√£o reutiliz√°vel que aplica o MESMO filtro da aba "Pronto para Preparar"
    function filterReadyToPrepareOrders(allOrders) {
        return allOrders.filter(order => {
            const shippingStatus = order.shipping_details?.status || order.shipping_status;
            const substatus = order.shipping_details?.substatus;
            
            // N√£o mostrar se j√° foi enviado
            const hasTracking = order.shipping_status && order.shipping_status === 'shipped';
            const hasShippingDate = order.shipping_date;
            if (hasTracking || hasShippingDate) {
                return false;
            }
            
            // N√£o mostrar se est√° em tr√¢nsito (prioridade alta)
            if (shippingStatus === 'shipped' || shippingStatus === 'in_transit' || shippingStatus === 'out_for_delivery' || shippingStatus === 'soon_deliver') {
                return false;
            }
            
            // N√£o mostrar se foi entregue
            if (shippingStatus === 'delivered' || shippingStatus === 'inferred' || order.status === 'DELIVERED') {
                return false;
            }
            
            // N√£o mostrar se est√° pendente (shipping_status = pending)
            if (shippingStatus === 'pending' || order.status === 'PENDING') {
                return false;
            }
            
            // N√£o mostrar se status do pedido √© SHIPPED
            if (order.status === 'SHIPPED') {
                return false;
            }
            
            // N√ÉO mostrar pedidos prontos para envio (estes v√£o para "Aguardando Envio")
            if (substatus === 'ready_to_ship' || 
                substatus === 'ready_to_print' ||
                substatus === 'printed' ||
                substatus === 'ready_to_pack' ||
                substatus === 'packed' ||
                substatus === 'ready_for_pickup' ||
                substatus === 'ready_for_dropoff') {
                return false;
            }
            
            // Mostrar apenas pedidos PAID que N√ÉO est√£o prontos para envio
            return order.status === 'PAID';
        });
    }

    // Apenas recalcula a contagem no frontend (sem renderizar a tabela)
    async function loadReadyToPrepareCountOnly() {
        try {
            // Se ainda n√£o carregou todos os pedidos, carregar agora
            if (!ordersLoaded) {
                await loadAllOrdersOnce();
            }
            
            // Aplicar filtros localmente para contar
            const customerName = document.getElementById('filter-customer').value.trim();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;

            let filteredOrders = [...allOrdersLoaded];

            // Aplicar filtro de busca
            if (customerName) {
                const searchLower = customerName.toLowerCase();
                filteredOrders = filteredOrders.filter(order => {
                    const orderId = String(order.order_id || '');
                    const mlOrderId = String(order.ml_order_id || '');
                    const nickname = String(order.buyer_nickname || '').toLowerCase();
                    const firstName = String(order.buyer_first_name || '').toLowerCase();
                    return orderId.includes(searchLower) || 
                           mlOrderId.includes(searchLower) || 
                           nickname.includes(searchLower) || 
                           firstName.includes(searchLower);
                });
            }

            // Aplicar filtro de data
            if (startDate) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                    return orderDate >= startDate;
                });
            }
            if (endDate) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = new Date(order.date_created).toISOString().split('T')[0];
                    return orderDate <= endDate;
                });
            }

            // Aplicar filtro l√≥gico da aba
            filteredOrders = filterReadyToPrepareOrders(filteredOrders);
            
            const badge = document.getElementById('ready-to-prepare-count');
            if (badge) badge.textContent = filteredOrders.length;
        } catch (e) {
            // Em caso de erro, n√£o derrubar a p√°gina; apenas logar
            console.warn('Falha ao calcular contador (frontend) de Pronto para Preparar:', e);
        }
    }

    function loadManualPrepareOrders() {
        const tbody = document.getElementById('manual-prepare-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        // Buscar pedidos com status manual READY_TO_PREPARE (status que n√£o existe na API, apenas criado manualmente)
        fetch('/api/shipments/pending?status=READY_TO_PREPARE&page=1&limit=100')
            .then(response => {
                // Tratar erro 401
                if (handle401Error(response)) {
                    return Promise.reject('not_authenticated');
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.orders && data.orders.length > 0) {
                    renderManualOrders(tbody, data.orders);
        } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Nenhum pedido marcado para separa√ß√£o.
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Erro ao carregar pedidos:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            Erro ao carregar pedidos. Tente novamente.
                        </td>
                    </tr>
                `;
            });
    }
    
    async function loadDeliveredOrders() {
        const tbody = document.getElementById('delivered-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            // Buscar TODOS os pedidos com pagina√ß√£o
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
                
                // Tratar erro 401
                if (handle401Error(response)) {
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
        } else {
                    hasMore = false;
                }
                
                if (page > 10) {
                    hasMore = false;
                }
            }
            
            // Filtrar pedidos: status = DELIVERED ou shipping_status com valores de entregue
            const filteredOrders = allOrders.filter(order => {
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                
                // Mostrar pedidos com status DELIVERED
                if (order.status === 'DELIVERED') {
                    return true;
                }
                
                // Tamb√©m mostrar se shipping_status indica entregue
                if (shippingStatus === 'delivered' || shippingStatus === 'inferred') {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderDeliveredOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido entregue encontrado.
                        </td>
                    </tr>
                `;
        }
    } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderDeliveredOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
        tbody.innerHTML = `
            <tr>
                    <td colspan="5" class="text-center text-muted">
                        Nenhum pedido entregue encontrado.
                </td>
            </tr>
        `;
        return;
    }
    
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const substatus = order.shipping_details.substatus;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                const statusHistory = order.shipping_details.status_history || {};
                const dateDelivered = statusHistory.date_delivered;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de entrega
                if (status === 'delivered' || dateDelivered) {
                    shippingInfo += `<br><small class="text-success"><strong>‚úì Entregue</strong></small>`;
                    if (dateDelivered) {
                        const deliveredDate = new Date(dateDelivered).toLocaleDateString('pt-BR');
                        shippingInfo += `<br><small class="text-muted">üìÖ ${deliveredDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
        <tr>
            <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
            </td>
            <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            // Tentar destination primeiro (formato novo do ML)
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
            </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async function loadPendingOrders() {
        const tbody = document.getElementById('pending-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                </div>
                    Carregando pedidos...
            </td>
            </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            // Buscar TODOS os pedidos com pagina√ß√£o
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
                
                // Tratar erro 401
                if (handle401Error(response)) {
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
                } else {
                    hasMore = false;
                }
                
                if (page > 10) {
                    hasMore = false;
                }
            }
            
            // Filtrar pedidos: status = PAID AND shipping_status = pending (ou n√£o tem shipping_status)
            const filteredOrders = allOrders.filter(order => {
                // Verificar shipping_status
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                
                // Mostrar apenas pedidos com status PAID e shipping_status = pending
                if (order.status === 'PAID' && (shippingStatus === 'pending' || !shippingStatus)) {
                    return true;
                }
                
                // Tamb√©m mostrar pedidos com status PENDING
                if (order.status === 'PENDING') {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderPendingOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido pendente encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderPendingOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        Nenhum pedido pendente encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                const statusHistory = order.shipping_details.status_history || {};
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de envio
                if (status === 'pending') {
                    shippingInfo += `<br><small class="text-secondary">‚è≥ Pendente</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                    }
                } else if (status === 'ready_to_ship' || status === 'ready_to_print' || status === 'printed' || status === 'packed') {
                    shippingInfo += `<br><small class="text-warning">üì¶ Pronto para Envio</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                    }
                } else {
                    shippingInfo += `<br><small class="text-muted">${status}</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
            </td>
            <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
            </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async function loadWaitingShipmentOrders() {
        const tbody = document.getElementById('waiting-shipment-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                </div>
                    Carregando pedidos...
            </td>
        </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            // Buscar TODOS os pedidos com pagina√ß√£o
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
                
                // Tratar erro 401
                if (handle401Error(response)) {
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
                }
                
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
                } else {
                    hasMore = false;
                }
                
                if (page > 10) {
                    hasMore = false;
                }
            }
            
            // Filtrar pedidos: status = PAID e READY_TO_SHIP (prontos para envio)
            const filteredOrders = allOrders.filter(order => {
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                const substatus = order.shipping_details?.substatus;
                
                // Mostrar apenas pedidos com status PAID
                if (order.status !== 'PAID') {
                    return false;
                }
                
                // N√£o mostrar se j√° foi enviado
                if (shippingStatus === 'shipped' || 
                    shippingStatus === 'in_transit' || 
                    shippingStatus === 'out_for_delivery' || 
                    shippingStatus === 'soon_deliver' ||
                    order.status === 'SHIPPED') {
                    return false;
                }
                
                // N√£o mostrar se foi entregue
                if (shippingStatus === 'delivered' || 
                    shippingStatus === 'inferred' || 
                    order.status === 'DELIVERED') {
                    return false;
                }
                
                // N√£o mostrar se est√° pendente
                if (shippingStatus === 'pending' || order.status === 'PENDING') {
                    return false;
                }
                
                // Mostrar pedidos com substatus de ready_to_ship (prontos para envio)
                if (substatus === 'ready_to_ship' || 
                    substatus === 'ready_to_print' ||
                    substatus === 'printed' ||
                    substatus === 'ready_to_pack' ||
                    substatus === 'packed' ||
                    substatus === 'ready_for_pickup' ||
                    substatus === 'ready_for_dropoff') {
                    return true;
                }
                
                // Mostrar pedidos sem shipping_status (prontos para envio)
                if (!shippingStatus) {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderWaitingShipmentOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido aguardando envio encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderWaitingShipmentOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        Nenhum pedido aguardando envio encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        // Reutilizar renderPendingOrders que j√° tem a estrutura correta
        renderPendingOrders(tbody, orders);
    }
    
    async function loadShippedOrders() {
        const tbody = document.getElementById('shipped-orders');
        if (!tbody) return;
        
        // Mostrar loading
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            // Buscar TODOS os pedidos com pagina√ß√£o
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
        
                // Tratar erro 401
                if (handle401Error(response)) {
            return;
        }
        
        if (!response.ok) {
                    throw new Error('Erro ao carregar pedidos');
        }
        
        const data = await response.json();
        
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
                } else {
                    hasMore = false;
                }
                
                if (page > 10) {
                    hasMore = false;
                }
            }
            
            // Filtrar pedidos: status = SHIPPED ou shipping_status com valores de em tr√¢nsito
            const filteredOrders = allOrders.filter(order => {
                const shippingStatus = order.shipping_details?.status || order.shipping_status;
                
                // Mostrar pedidos com status SHIPPED ou shipping_status indicando em tr√¢nsito
                if (order.status === 'SHIPPED') {
                    return true;
                }
                
                // Tamb√©m mostrar se shipping_status indica em tr√¢nsito
                if (shippingStatus === 'shipped' || 
                    shippingStatus === 'in_transit' || 
                    shippingStatus === 'out_for_delivery' || 
                    shippingStatus === 'soon_deliver') {
                    return true;
                }
                
                return false;
            });
            
            if (filteredOrders.length > 0) {
                renderShippedOrders(tbody, filteredOrders);
        } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido enviado encontrado.
                        </td>
                    </tr>
                `;
        }
    } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderShippedOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        Nenhum pedido enviado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            let shippingInfo = '';
            if (order.shipping_details) {
                const status = order.shipping_details.status;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                const statusHistory = order.shipping_details.status_history || {};
                const dateShipped = statusHistory.date_shipped;
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const shippedDate = dateShipped ? new Date(dateShipped).toLocaleDateString('pt-BR') : null;
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Badge do tipo de envio
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Status de envio - Mostrar como "Em Tr√¢nsito"
                if (status === 'shipped' || status === 'in_transit' || status === 'out_for_delivery' || status === 'soon_deliver') {
                    shippingInfo += `<br><small class="text-info">üöö Em Tr√¢nsito</small>`;
                    if (shippedDate) {
                        shippingInfo += `<br><small class="text-muted">üöõ Enviado: ${shippedDate}</small>`;
                    }
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                    }
                } else {
                    shippingInfo += `<br><small class="text-muted">${status}</small>`;
                    if (deliveryDate) {
                        shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
                    </td>
                    <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
                    </td>
                    <td>${totalAmount}</td>
                    <td>${shippingInfo}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function renderManualOrders(tbody, orders) {
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        Nenhum pedido marcado para separa√ß√£o.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const shippingType = order.shipping_type || 'N/A';
            
            return `
                <tr>
                    <td><strong>${orderId}</strong></td>
                    <td>${order.buyer_name || order.buyer_nickname || '-'}</td>
                    <td>${orderDate}</td>
                    <td>${totalAmount}</td>
                    <td><span class="badge bg-info">${shippingType}</span></td>
                    <td><span class="badge bg-warning">Status Manual</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="syncOrder('${orderId}')">
                            <i class="bi bi-arrow-clockwise"></i> Sincronizar
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async function loadCancelledOrders() {
        const tbody = document.getElementById('cancelled-orders');
        if (!tbody) return;
        
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
                if (!response.ok) throw new Error('Erro ao carregar pedidos');
                
                const data = await response.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
                } else {
                    hasMore = false;
                }
                
                if (page > 10) hasMore = false;
            }
            
            const filteredOrders = allOrders.filter(order => {
                return order.status === 'CANCELLED' || order.status === 'PENDING_CANCEL';
            });
            
            if (filteredOrders.length > 0) {
                renderCancelledOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido cancelado encontrado.
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderCancelledOrders(tbody, orders) {
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        Nenhum pedido cancelado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            
            const statusBadge = order.status === 'CANCELLED' ? 
                '<span class="badge bg-danger">Cancelado</span>' : 
                '<span class="badge bg-warning">Pendente Cancelamento</span>';
            
            return `
                <tr>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                    </td>
                    <td>${order.buyer_first_name || order.buyer_nickname || '-'}</td>
                    <td>${totalAmount}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    async function loadRefundedOrders() {
        const tbody = document.getElementById('refunded-orders');
        if (!tbody) return;
        
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    Carregando pedidos...
                </td>
            </tr>
        `;
        
        try {
            let allOrders = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
                const response = await fetch(`/api/shipments/pending?page=${page}&limit=1000`);
                
                // Tratar erro 401
                if (handle401Error(response)) {
                    return;
                }
                
                if (!response.ok) throw new Error('Erro ao carregar pedidos');
        
        const data = await response.json();
        
                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = allOrders.concat(data.orders);
                    hasMore = data.total_pages > page;
                    page++;
        } else {
                    hasMore = false;
                }
                
                if (page > 10) hasMore = false;
            }
            
            const filteredOrders = allOrders.filter(order => {
                return order.status === 'REFUNDED' || order.status === 'PARTIALLY_REFUNDED';
            });
            
            if (filteredOrders.length > 0) {
                renderRefundedOrders(tbody, filteredOrders);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            Nenhum pedido reembolsado encontrado.
                        </td>
                    </tr>
                `;
        }
    } catch (error) {
            console.error('Erro ao carregar pedidos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        Erro ao carregar pedidos. Tente novamente.
                    </td>
                </tr>
            `;
        }
    }
    
    function renderRefundedOrders(tbody, orders) {
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        Nenhum pedido reembolsado encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            
            const statusBadge = order.status === 'REFUNDED' ? 
                '<span class="badge bg-danger">Reembolsado</span>' : 
                '<span class="badge bg-warning">Parcialmente Reembolsado</span>';
            
            return `
                <tr>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                    </td>
                    <td>${order.buyer_first_name || order.buyer_nickname || '-'}</td>
                    <td>${totalAmount}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function renderOrders(tbody, orders) {
        // Salvar pedidos globalmente para acesso no modal
        window.currentOrders = orders;
        
        if (!orders || orders.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        Nenhum pedido encontrado.
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = orders.map(order => {
            const orderId = order.ml_order_id || order.order_id || '-';
            // Data e hora formatadas
            const orderDate = order.date_created ? new Date(order.date_created).toLocaleDateString('pt-BR') : '-';
            const orderTime = order.date_created ? new Date(order.date_created).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}) : '-';
            const orderDateTime = `${orderDate} ${orderTime}`;
            const totalAmount = order.total_amount ? `R$ ${parseFloat(order.total_amount).toFixed(2).replace('.', ',')}` : '-';
            const invoiceNumber = order.invoice_number ? `${order.invoice_number}${order.invoice_series ? '/' + order.invoice_series : ''}` : 'Sem NF';
            
            // Extrair informa√ß√µes de envio de shipping_details
            let shippingInfo = '';
            if (order.shipping_details) {
                const status = order.shipping_details.status;  // Status principal: "delivered", "shipped", "ready_to_ship", etc.
                const substatus = order.shipping_details.substatus;
                const logistic = order.shipping_details.logistic;
                const logisticType = order.shipping_details.logistic_type || (logistic && logistic.type);
                
                // Extrair datas importantes
                const statusHistory = order.shipping_details.status_history || {};
                const dateShipped = statusHistory.date_shipped;
                // Tentar m√∫ltiplas fontes para data prevista de entrega
                const estimatedDelivery = order.shipping_details.shipping_option?.estimated_delivery_final?.date 
                                       || order.shipping_details.shipping_option?.estimated_delivery_limit?.date
                                       || order.shipping_details.estimated_delivery
                                       || order.estimated_delivery_date;
                
                const shippedDate = dateShipped ? new Date(dateShipped).toLocaleDateString('pt-BR') : null;
                const deliveryDate = estimatedDelivery ? new Date(estimatedDelivery).toLocaleDateString('pt-BR') : null;
                
                // Montar badge com tipo de log√≠stica
                if (logisticType === 'fulfillment') {
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                } else if (logisticType === 'cross_docking') {
                    shippingInfo = '<span class="badge bg-info">Cross Docking</span>';
                } else if (logisticType === 'xd_drop_off' || logisticType === 'drop_off') {
                    shippingInfo = '<span class="badge bg-secondary">Ponto de Coleta</span>';
                } else if (logisticType === 'me2') {
                    shippingInfo = '<span class="badge bg-warning">Mercado Envios</span>';
                } else {
                    shippingInfo = `<span class="badge bg-secondary">${logisticType || 'N/A'}</span>`;
                }
                
                // Adicionar STATUS PRINCIPAL (entrega finalizada ou em andamento)
                if (status) {
                    if (status === 'delivered') {
                        // Se foi entregue, mostrar apenas a data de entrega
                        shippingInfo += `<br><small class="text-success"><strong>‚úì Entregue</strong></small>`;
                        const dateDelivered = statusHistory.date_delivered;
                        if (dateDelivered) {
                            const deliveredDate = new Date(dateDelivered).toLocaleDateString('pt-BR');
                            shippingInfo += `<br><small class="text-success">üìÖ ${deliveredDate}</small>`;
                        }
                    } else if (status === 'shipped') {
                        shippingInfo += `<br><small class="text-info">üöö Em Tr√¢nsito</small>`;
                        // Mostrar data de envio e previs√£o de entrega
                        if (shippedDate) {
                            shippingInfo += `<br><small class="text-muted">üöõ Enviado: ${shippedDate}</small>`;
                        }
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    } else if (status === 'ready_to_ship' || status === 'ready_to_print' || status === 'printed' || status === 'packed') {
                        shippingInfo += `<br><small class="text-warning">üì¶ Pronto para Envio</small>`;
                        // Mostrar apenas previs√£o de entrega
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    } else if (status === 'pending') {
                        shippingInfo += `<br><small class="text-secondary">‚è≥ Pendente</small>`;
                        // Mostrar apenas previs√£o de entrega
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    } else {
                        shippingInfo += `<br><small class="text-muted">${status}</small>`;
                        // Para outros status, mostrar previs√£o se dispon√≠vel
                        if (deliveryDate) {
                            shippingInfo += `<br><small class="text-muted">üìÖ Previs√£o: ${deliveryDate}</small>`;
                        }
                    }
                }
            } else {
                shippingInfo = '<span class="badge bg-secondary">N/A</span>';
            }
            
            return `
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="${orderId}" data-order-id="${orderId}">
                    </td>
                    <td>
                        <strong>${orderId}</strong><br>
                        <small class="text-muted">${orderDateTime}</small>
                        ${order.invoice_emitted ? 
                            `<br><span class="badge bg-success">NF: ${invoiceNumber}</span>` : 
                            `<br><span class="badge bg-secondary">Sem NF</span>`
                        }
                        ${order.sale_id ? `<br><small class="text-muted">Venda: ${order.sale_id}</small>` : ''}
                    </td>
                    <td>
                        ${order.buyer_first_name || order.buyer_nickname || '-'}
                        ${(() => {
                            // Tentar destination primeiro (formato novo do ML)
                            const dest = order.shipping_details?.destination;
                            if (dest) {
                                let html = '';
                                // Nome do destinat√°rio est√° em destination.receiver_name
                                if (dest.receiver_name) {
                                    html += `<br><small class="text-muted">${dest.receiver_name}</small>`;
                                }
                                // Endere√ßo est√° em destination.shipping_address.address_line
                                const shippingAddr = dest.shipping_address;
                                if (shippingAddr && shippingAddr.address_line) {
                                    html += `<br><small class="text-muted">${shippingAddr.address_line}</small>`;
                                }
                                // Cidade e estado
                                const city = shippingAddr?.city?.name || shippingAddr?.city;
                                const state = shippingAddr?.state?.name || shippingAddr?.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            // Fallback para receiver_address ou shipping_address
                            const fallback = order.shipping_details?.receiver_address || order.shipping_address;
                            if (fallback) {
                                let html = '';
                                if (fallback.receiver_name) {
                                    html += `<br><small class="text-muted">${fallback.receiver_name}</small>`;
                                }
                                if (fallback.address_line) {
                                    html += `<br><small class="text-muted">${fallback.address_line}</small>`;
                                }
                                const city = fallback.city?.name || fallback.city;
                                const state = fallback.state?.name || fallback.state;
                                if (city && state) {
                                    html += `<br><small class="text-muted">${city} - ${state}</small>`;
                                } else if (city) {
                                    html += `<br><small class="text-muted">${city}</small>`;
                                }
                                return html;
                            }
                            return '';
                        })()}
                    </td>
                    <td>${totalAmount}</td>
                    <td>
                        ${shippingInfo}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetails('${orderId}')">
                            <i class="bi bi-eye"></i> Detalhes
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
        // Configurar eventos dos checkboxes ap√≥s renderizar
        setupCheckboxEvents();
    }
    
    function setupCheckboxEvents() {
        // Checkbox "Selecionar todos"
        const selectAllCheckbox = document.getElementById('select-all-orders');
        const orderCheckboxes = document.querySelectorAll('.order-checkbox');
        const updateButton = document.getElementById('update-selected-orders');
        const selectedCount = document.getElementById('selected-count');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                orderCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateSelectedCount();
            });
        }
        
        // Checkboxes individuais
        orderCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Atualizar checkbox "Selecionar todos"
                if (selectAllCheckbox) {
                    const allChecked = Array.from(orderCheckboxes).every(cb => cb.checked);
                    const someChecked = Array.from(orderCheckboxes).some(cb => cb.checked);
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                }
                updateSelectedCount();
            });
        });
        
        // Bot√£o de atualizar
        if (updateButton) {
            updateButton.addEventListener('click', function() {
                updateSelectedOrders();
            });
        }
    }
    
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const count = selectedCheckboxes.length;
        const selectedCountEl = document.getElementById('selected-count');
        const updateButton = document.getElementById('update-selected-orders');
        
        if (selectedCountEl) {
            selectedCountEl.textContent = `${count} selecionado(s)`;
        }
        
        if (updateButton) {
            updateButton.disabled = count === 0;
        }
    }
    
    function updateSelectedOrders() {
        const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
        const orderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        console.log('üîÑ [FRONTEND] Iniciando atualiza√ß√£o de pedidos selecionados');
        console.log(`üìã [FRONTEND] Pedidos selecionados: ${orderIds.length}`);
        console.log(`üìã [FRONTEND] IDs: ${orderIds.join(', ')}`);
        
        if (orderIds.length === 0) {
            console.warn('‚ö†Ô∏è [FRONTEND] Nenhum pedido selecionado');
            return;
        }
        
        const updateButton = document.getElementById('update-selected-orders');
        const originalText = updateButton.innerHTML;
        updateButton.disabled = true;
        updateButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Atualizando...';
        
        // Criar AbortController para timeout de 5 minutos
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minutos
        
        console.log('üì° [FRONTEND] Enviando requisi√ß√£o POST para /api/shipments/bulk-update');
        
        // Fazer requisi√ß√£o para atualizar os pedidos
        fetch('/api/shipments/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                order_ids: orderIds
            }),
            signal: controller.signal
        })
        .then(response => {
            console.log(`üì° [FRONTEND] Resposta recebida: status=${response.status}`);
            clearTimeout(timeoutId);
            
            // Tratar erro 401
            if (handle401Error(response)) {
                return Promise.reject('not_authenticated');
            }
            
            if (!response.ok) {
                return response.text().then(text => {
                    console.error(`‚ùå [FRONTEND] Erro na resposta HTTP: status=${response.status}, body=${text}`);
                    throw new Error(`Erro HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ [FRONTEND] Dados recebidos:', data);
            
            if (data.success) {
                console.log(`‚úÖ [FRONTEND] ${data.success_count || 0} pedido(s) atualizado(s) com sucesso, ${data.failure_count || 0} falharam`);
                console.log('üîÑ [FRONTEND] Recarregando lista de pedidos...');
                
                // Recarregar a lista
                loadReadyToPrepareOrders();
                
                // Desmarcar todos os checkboxes
                document.querySelectorAll('.order-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('select-all-orders').checked = false;
                updateSelectedCount();
                
                console.log('‚úÖ [FRONTEND] Atualiza√ß√£o conclu√≠da com sucesso');
            } else {
                console.error('‚ùå [FRONTEND] Resposta indicou erro:', data.error);
                throw new Error(data.error || 'Erro ao atualizar pedidos');
            }
        })
        .catch(error => {
            console.error('‚ùå [FRONTEND] Erro ao atualizar pedidos:', error);
            if (error.name === 'AbortError') {
                console.error('‚ùå [FRONTEND] Timeout na requisi√ß√£o (5 minutos)');
            }
        })
        .finally(() => {
            console.log('üèÅ [FRONTEND] Finalizando atualiza√ß√£o');
            updateButton.disabled = false;
            updateButton.innerHTML = originalText;
        });
    }
    
    // Fun√ß√£o para ver detalhes do pedido completo
    window.viewOrderDetails = function(orderId) {
        // Buscar o pedido no array de orders carregado
        const order = window.currentOrders?.find(o => o.order_id === orderId || o.ml_order_id === orderId);
        
        if (!order) {
            alert('Pedido n√£o encontrado');
            return;
        }
        
        // Exibir JSON formatado no modal
        const jsonContent = JSON.stringify(order, null, 2);
        document.getElementById('json-content').textContent = jsonContent;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
        modal.show();
    };
});
</script>

<!-- Modal para exibir JSON completo -->
<div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jsonModalLabel">
                    <i class="bi bi-code-slash"></i> JSON Completo do Pedido
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="json-content" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-size: 12px;"><code></code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copyJsonToClipboard()">
                    <i class="bi bi-clipboard"></i> Copiar JSON
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para copiar JSON para a √°rea de transfer√™ncia
function copyJsonToClipboard() {
    const jsonContent = document.getElementById('json-content').textContent;
    navigator.clipboard.writeText(jsonContent).then(() => {
        alert('‚úÖ JSON copiado para a √°rea de transfer√™ncia!');
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('‚ùå Erro ao copiar JSON');
    });
}
</script>
{% endblock %}
