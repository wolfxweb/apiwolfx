{% extends "base.html" %}

{% block title %}Análise do Produto - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-calculator text-success"></i>
                        Análise do Produto
                    </h1>
                    <p class="text-muted mb-0">Análise completa de custos e rentabilidade</p>
                </div>
                <div>
                    <a href="/ml/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar aos Produtos
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">Carregando análise do produto...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="alert alert-danger d-none">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar análise:</strong>
                <span id="error-message"></span>
            </div>

            <!-- Analysis Content -->
            <div id="analysis-content" class="d-none">
                <!-- Product Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-box"></i> Informações do Produto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img id="product-thumbnail" src="" alt="Produto" class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h4 id="product-title" class="mb-2"></h4>
                                <p id="product-description" class="text-muted mb-3"></p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>ID:</strong> <span id="product-ml-id"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Preço:</strong> <div id="product-price"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Status:</strong> <span id="product-status"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="row">
                    <!-- Marketplace Fees -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-percent"></i> Taxas do Mercado Livre
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="marketplace-fees">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando taxas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Costs -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-truck"></i> Custos de Envio
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="shipping-costs">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando envios...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profitability Analysis -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> Análise de Rentabilidade
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="profitability-analysis">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando rentabilidade...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="bi bi-lightbulb"></i> Recomendações
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="recommendations">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Gerando recomendações...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productId = window.location.pathname.split('/').pop();
    loadProductAnalysis(productId);
});

function loadProductAnalysis(productId) {
    // Mostrar loading
    document.getElementById('loading-state').classList.remove('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.add('d-none');

    // Carregar dados do produto
    fetch(`/ml/products/api/product/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderProductInfo(data.product);
                loadMarketplaceFees(data.product);
                loadShippingCosts(data.product);
                loadProfitabilityAnalysis(data.product);
                loadRecommendations(data.product);
                
                // Mostrar conteúdo
                document.getElementById('loading-state').classList.add('d-none');
                document.getElementById('analysis-content').classList.remove('d-none');
            } else {
                showError(data.error || 'Erro ao carregar produto');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('Erro ao carregar análise do produto');
        });
}

function renderProductInfo(product) {
    document.getElementById('product-thumbnail').src = product.thumbnail || '/static/images/no-image.png';
    document.getElementById('product-title').textContent = product.title;
    document.getElementById('product-description').textContent = product.subtitle || 'Sem descrição';
    document.getElementById('product-ml-id').textContent = product.ml_item_id;
    document.getElementById('product-price').innerHTML = formatProductPriceForAnalysis(product);
    document.getElementById('product-status').innerHTML = getStatusBadge(product.status);
}

function loadMarketplaceFees(product) {
    const feesContainer = document.getElementById('marketplace-fees');
    
    // Buscar taxas reais da API
    fetch(`/ml/products/api/product/${product.id}/fees`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fees.success) {
                const fees = data.fees.data;
                renderMarketplaceFees(fees);
            } else {
                showFeesError(data.fees?.error || 'Erro ao carregar taxas');
            }
        })
        .catch(error => {
            console.error('Erro ao buscar taxas:', error);
            showFeesError('Erro de conexão');
        });
}

           function renderMarketplaceFees(fees) {
               const feesContainer = document.getElementById('marketplace-fees');
               
               if (!fees || (Array.isArray(fees) && fees.length === 0)) {
                   feesContainer.innerHTML = `
                       <div class="alert alert-warning">
                           <i class="bi bi-exclamation-triangle"></i>
                           Nenhuma taxa encontrada para este produto.
                       </div>
                   `;
                   return;
               }
               
               // Se fees é um array, mostrar comparação entre tipos de anúncio
               // Se fees é um objeto, usar diretamente
               if (Array.isArray(fees)) {
                   renderMultipleListingTypes(fees);
               } else {
                   renderSingleListingType(fees);
               }
           }
           
           function renderSingleListingType(fee) {
               const feesContainer = document.getElementById('marketplace-fees');
               const calculatedFees = fee.calculated_fees || {};
               const saleFeeDetails = fee.sale_fee_details || {};
               const shippingInfo = fee.shipping_info || {};
               
               // Buscar preço do produto
               const productPrice = parseFloat(document.getElementById('product-price').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
               
               feesContainer.innerHTML = `
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-tag"></i> ${fee.listing_type_name || 'Tipo de Anúncio'}
                       </h6>
                       <div class="d-flex justify-content-between">
                           <span>Taxa de Publicação:</span>
                           <strong class="${(fee.listing_fee_amount || 0) === 0 ? 'text-success' : 'text-primary'}">
                               ${formatPrice(fee.listing_fee_amount || 0)}
                           </strong>
                       </div>
                       <small class="text-muted">
                           Exposição: ${fee.listing_exposure || 'N/A'}
                       </small>
                   </div>
                   
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-cart-check"></i> Taxa de Venda
                       </h6>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Taxa Fixa:</span>
                           <span class="text-primary">${formatPrice(calculatedFees.fixed_fee_amount || 0)}</span>
                       </div>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Comissão ML (${saleFeeDetails.percentage_fee || 0}%):</span>
                           <span class="text-primary">${formatPrice(calculatedFees.percentage_fee_amount || 0)}</span>
                       </div>
                       
                       ${saleFeeDetails.financing_add_on_fee > 0 ? `
                           <div class="d-flex justify-content-between mb-1">
                               <span class="text-muted">Taxa de Financiamento (${saleFeeDetails.financing_add_on_fee}%):</span>
                               <span class="text-primary">${formatPrice(calculatedFees.financing_fee_amount || 0)}</span>
                           </div>
                       ` : ''}
                       
                       <hr class="my-2">
                       <div class="d-flex justify-content-between fw-bold">
                           <span>Subtotal Taxa de Venda:</span>
                           <span class="text-primary">${formatPrice(calculatedFees.total_sale_fees || 0)}</span>
                       </div>
                   </div>
                   
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-truck"></i> Frete
                       </h6>
                       <div class="d-flex justify-content-between mb-1">
                           <span>Frete:</span>
                           <strong class="${shippingInfo.free_shipping ? 'text-success' : 'text-primary'}">
                               ${shippingInfo.free_shipping ? 'GRÁTIS (R$ 0,00)' : formatPrice(calculatedFees.shipping_cost || 0)}
                           </strong>
                       </div>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Tipo Logístico:</span>
                           <span class="text-info">${shippingInfo.logistic_type || 'N/A'}</span>
                       </div>
                   </div>
                   
                   <hr class="my-3">
                   <div class="d-flex justify-content-between fw-bold fs-5">
                       <span class="text-dark">TOTAL DE CUSTOS:</span>
                       <span class="text-danger">${formatPrice(calculatedFees.total_cost_with_shipping || 0)}</span>
                   </div>
                   
                   <div class="mt-3">
                       <div class="row text-center">
                           <div class="col-6">
                               <small class="text-muted">Margem de Lucro</small>
                               <div class="fw-bold ${(calculatedFees.profit_margin_percentage || 0) >= 20 ? 'text-success' : (calculatedFees.profit_margin_percentage || 0) >= 10 ? 'text-warning' : 'text-danger'}">
                                   ${(calculatedFees.profit_margin_percentage || 0).toFixed(1)}%
                               </div>
                           </div>
                           <div class="col-6">
                               <small class="text-muted">Lucro Líquido</small>
                               <div class="fw-bold ${(calculatedFees.net_profit || 0) > 0 ? 'text-success' : 'text-danger'}">
                                   ${formatPrice(calculatedFees.net_profit || 0)}
                               </div>
                           </div>
                       </div>
                   </div>
               `;
           }
           
           function renderMultipleListingTypes(fees) {
               const feesContainer = document.getElementById('marketplace-fees');
               const productPrice = parseFloat(document.getElementById('product-price').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
               
               let html = '<h6 class="text-primary mb-3"><i class="bi bi-bar-chart"></i> Comparação de Tipos de Anúncio</h6>';
               
               // Ordenar por custo total crescente
               fees.sort((a, b) => {
                   const costA = (a.calculated_fees?.total_cost_with_shipping || 0);
                   const costB = (b.calculated_fees?.total_cost_with_shipping || 0);
                   return costA - costB;
               });
               
               fees.forEach((fee, index) => {
                   const calculatedFees = fee.calculated_fees || {};
                   const shippingInfo = fee.shipping_info || {};
                   const isBestOption = index === 0;
                   
                   html += `
                       <div class="card mb-2 ${isBestOption ? 'border-success' : ''}">
                           <div class="card-body py-2">
                               <div class="d-flex justify-content-between align-items-center">
                                   <div>
                                       <h6 class="mb-0 ${isBestOption ? 'text-success' : ''}">
                                           ${fee.listing_type_name || 'N/A'}
                                           ${isBestOption ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                       </h6>
                                       <small class="text-muted">${fee.listing_exposure || 'N/A'} • ${fee.requires_picture ? 'Com foto' : 'Sem foto'}</small>
                                   </div>
                                   <div class="text-end">
                                       <div class="fw-bold ${isBestOption ? 'text-success' : 'text-primary'}">
                                           ${formatPrice(calculatedFees.total_cost_with_shipping || 0)}
                                       </div>
                                       <small class="text-muted">
                                           Lucro: ${formatPrice(calculatedFees.net_profit || 0)}
                                           (${(calculatedFees.profit_margin_percentage || 0).toFixed(1)}%)
                                       </small>
                                   </div>
                               </div>
                           </div>
                       </div>
                   `;
               });
               
               // Adicionar resumo
               const bestOption = fees[0];
               const worstOption = fees[fees.length - 1];
               const bestFees = bestOption.calculated_fees || {};
               const worstFees = worstOption.calculated_fees || {};
               
               html += `
                   <div class="mt-3 p-3 bg-light rounded">
                       <h6 class="text-success mb-2">
                           <i class="bi bi-lightbulb"></i> Recomendação
                       </h6>
                       <p class="mb-1">
                           <strong>Melhor opção:</strong> ${bestOption.listing_type_name} 
                           - Custo total: ${formatPrice(bestFees.total_cost_with_shipping || 0)}
                           - Lucro: ${formatPrice(bestFees.net_profit || 0)}
                       </p>
                       <p class="mb-0">
                           <strong>Economia:</strong> ${formatPrice((worstFees.total_cost_with_shipping || 0) - (bestFees.total_cost_with_shipping || 0))} 
                           comparado ao ${worstOption.listing_type_name}
                       </p>
                   </div>
               `;
               
               feesContainer.innerHTML = html;
           }

function showFeesError(message) {
    const feesContainer = document.getElementById('marketplace-fees');
    feesContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao carregar taxas:</strong> ${message}
        </div>
    `;
}

function loadShippingCosts(product) {
    // Simular carregamento de custos de envio
    setTimeout(() => {
        const shippingContainer = document.getElementById('shipping-costs');
        shippingContainer.innerHTML = `
            <div class="mb-3">
                <label class="form-label">CEP de Destino:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="destination-zip" placeholder="00000-000">
                    <button class="btn btn-outline-primary" onclick="calculateShipping()">
                        <i class="bi bi-calculator"></i> Calcular
                    </button>
                </div>
            </div>
            <div id="shipping-results" class="d-none">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Selecione um CEP para calcular os custos de envio.
                </div>
            </div>
        `;
    }, 1500);
}

function loadProfitabilityAnalysis(product) {
    // Aguardar que as taxas sejam carregadas primeiro
    setTimeout(() => {
        const profitabilityContainer = document.getElementById('profitability-analysis');
        const productPrice = parseFloat(product.price) || 0;
        
        // Tentar obter os custos das taxas já calculadas
        const feesContainer = document.getElementById('marketplace-fees');
        let totalFees = 0;
        let profitMargin = 0;
        let roi = 0;
        
        // Extrair custos totais se já estiverem calculados
        const totalCostsElement = feesContainer.querySelector('[class*="total-cost"]') || 
                                  feesContainer.querySelector('*:contains("TOTAL DE CUSTOS")');
        
        if (totalCostsElement) {
            const costText = totalCostsElement.textContent;
            const costMatch = costText.match(/R\$\s*([0-9,]+\.?[0-9]*)/);
            if (costMatch) {
                totalFees = parseFloat(costMatch[1].replace(',', '.'));
            }
        }
        
        // Se não encontrou os custos, usar valor padrão baseado no produto
        if (totalFees === 0) {
            // Estimativa baseada no preço (taxa média do Mercado Livre ~15%)
            totalFees = productPrice * 0.15;
        }
        
        const netProfit = productPrice - totalFees;
        profitMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
        roi = totalFees > 0 ? (netProfit / totalFees) * 100 : 0;
        
        profitabilityContainer.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Preço de Venda</h6>
                        <h4 class="text-primary">${formatPrice(productPrice)}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Custos Totais</h6>
                        <h4 class="text-danger">${formatPrice(totalFees)}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Lucro Líquido</h6>
                        <h4 class="text-success">${formatPrice(netProfit)}</h4>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span>Margem de Lucro:</span>
                        <strong class="${profitMargin >= 20 ? 'text-success' : profitMargin >= 10 ? 'text-warning' : 'text-danger'}">
                            ${profitMargin.toFixed(1)}%
                        </strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span>ROI:</span>
                        <strong class="${roi >= 50 ? 'text-success' : roi >= 25 ? 'text-warning' : 'text-danger'}">
                            ${roi.toFixed(1)}%
                        </strong>
                    </div>
                </div>
            </div>
        `;
    }, 3000); // Aumentar tempo para aguardar cálculo das taxas
}

function loadRecommendations(product) {
    // Simular carregamento de recomendações
    setTimeout(() => {
        const recommendationsContainer = document.getElementById('recommendations');
        recommendationsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-lightbulb"></i>
                <strong>Recomendação:</strong> Este produto tem boa rentabilidade. 
                Considere aumentar o preço em 10% para maximizar o lucro.
            </div>
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Atenção:</strong> Monitore os custos de envio para diferentes regiões.
            </div>
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i>
                <strong>Oportunidade:</strong> Produto com boa demanda. 
                Considere investir em anúncios premium.
            </div>
        `;
    }, 2500);
}

function calculateShipping() {
    const zipCode = document.getElementById('destination-zip').value;
    if (!zipCode) {
        alert('Por favor, digite um CEP válido');
        return;
    }
    
    const productId = window.location.pathname.split('/').pop();
    const resultsContainer = document.getElementById('shipping-results');
    
    // Mostrar loading
    resultsContainer.classList.remove('d-none');
    resultsContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Calculando...</span>
            </div>
            <p class="mt-2 mb-0">Calculando custos de envio...</p>
        </div>
    `;
    
    // Buscar opções de envio reais
    fetch(`/ml/products/api/product/${productId}/shipping?zip_code=${zipCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.shipping.success) {
                renderShippingOptions(data.shipping.data, zipCode);
            } else {
                showShippingError(data.shipping?.error || 'Erro ao calcular envio');
            }
        })
        .catch(error => {
            console.error('Erro ao calcular envio:', error);
            showShippingError('Erro de conexão');
        });
}

function renderShippingOptions(shippingData, zipCode) {
    const resultsContainer = document.getElementById('shipping-results');
    
    if (!shippingData.options || shippingData.options.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Nenhuma opção de envio encontrada para o CEP ${zipCode}.
            </div>
        `;
        return;
    }
    
    let optionsHtml = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Opções de envio para CEP ${zipCode}</strong>
        </div>
        <div class="row">
    `;
    
    shippingData.options.forEach(option => {
        const cost = option.cost || 0;
        const listCost = option.list_cost || 0;
        const name = option.name || 'Opção de Envio';
        const isFree = cost === 0;
        
        optionsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${name}</h6>
                        <div class="d-flex justify-content-between">
                            <span>Custo:</span>
                            <strong class="${isFree ? 'text-success' : 'text-primary'}">
                                ${isFree ? 'GRÁTIS' : formatPrice(cost)}
                            </strong>
                        </div>
                        ${listCost > 0 ? `
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Custo original:</small>
                                <small class="text-muted">${formatPrice(listCost)}</small>
                            </div>
                        ` : ''}
                        ${option.estimated_delivery_time ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i>
                                    Entrega: ${option.estimated_delivery_time.shipping || 'N/A'}h
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    optionsHtml += '</div>';
    resultsContainer.innerHTML = optionsHtml;
}

function showShippingError(message) {
    const resultsContainer = document.getElementById('shipping-results');
    resultsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao calcular envio:</strong> ${message}
        </div>
    `;
}

function showError(message) {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.remove('d-none');
    document.getElementById('error-message').textContent = message;
}

function formatPrice(price, currency = 'BRL') {
    // Converter para número
    const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
    
    // Se não for um número válido, retornar R$ 0,00
    if (isNaN(numericPrice) || numericPrice === null || numericPrice === undefined) {
        return 'R$ 0,00';
    }
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericPrice);
}

function formatProductPriceForAnalysis(product) {
    if (!product.price) return '<span class="text-muted">N/A</span>';
    
    const currentPrice = parseFloat(product.price);
    const originalPrice = product.original_price ? parseFloat(product.original_price) : null;
    const basePrice = product.base_price ? parseFloat(product.base_price) : null;
    
    // Se há preço original e é diferente do preço atual, mostrar desconto
    if (originalPrice && originalPrice > currentPrice && originalPrice > 0) {
        const discountPercent = Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
        
        return `
            <div class="d-flex flex-column">
                <div class="text-success fw-bold">
                    ${formatPrice(currentPrice, product.currency_id)}
                </div>
                <div class="text-decoration-line-through text-muted small">
                    ${formatPrice(originalPrice, product.currency_id)}
                </div>
                <div class="badge bg-danger small">
                    -${discountPercent}%
                </div>
            </div>
        `;
    }
    
    // Se há base_price diferente do preço atual, mostrar promoção
    if (basePrice && basePrice > currentPrice && basePrice > 0) {
        const discountPercent = Math.round(((basePrice - currentPrice) / basePrice) * 100);
        
        return `
            <div class="d-flex flex-column">
                <div class="text-success fw-bold">
                    ${formatPrice(currentPrice, product.currency_id)}
                </div>
                <div class="text-decoration-line-through text-muted small">
                    ${formatPrice(basePrice, product.currency_id)}
                </div>
                <div class="badge bg-warning text-dark small">
                    -${discountPercent}%
                </div>
            </div>
        `;
    }
    
    // Preço normal sem desconto
    return `
        <div class="text-primary fw-bold">
            ${formatPrice(currentPrice, product.currency_id)}
        </div>
    `;
}

function getStatusBadge(status) {
    const statusMap = {
        'active': '<span class="badge bg-success">Ativo</span>',
        'paused': '<span class="badge bg-warning">Pausado</span>',
        'closed': '<span class="badge bg-danger">Fechado</span>',
        'under_review': '<span class="badge bg-info">Em Revisão</span>',
        'inactive': '<span class="badge bg-secondary">Inativo</span>'
    };
    return statusMap[status] || '<span class="badge bg-secondary">Desconhecido</span>';
}
</script>
{% endblock %}
