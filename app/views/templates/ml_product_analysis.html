{% extends "base.html" %}

{% block title %}An√°lise do Produto - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-calculator text-success"></i>
                        An√°lise do Produto
                    </h1>
                    <p class="text-muted mb-0">An√°lise completa de custos e rentabilidade</p>
                </div>
                <div>
                    <a href="/ml/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar aos Produtos
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">Carregando an√°lise do produto...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="alert alert-danger d-none">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar an√°lise:</strong>
                <span id="error-message"></span>
            </div>

            <!-- Analysis Content -->
            <div id="analysis-content" class="d-none">
                <!-- Product Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-box"></i> Informa√ß√µes do Produto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img id="product-thumbnail" src="" alt="Produto" class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h4 id="product-title" class="mb-2"></h4>
                                <p id="product-description" class="text-muted mb-3"></p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>ID:</strong> <span id="product-ml-id"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Pre√ßo:</strong> <div id="product-price"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Status:</strong> <span id="product-status"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="row">
                    <!-- Marketplace Fees -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-percent"></i> Taxas do Mercado Livre
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="marketplace-fees">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando taxas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- Catalog Information -->
        <div class="col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0" id="catalog-shipping-header">
                        <i class="bi bi-truck"></i> Custos de Envio
                    </h5>
                </div>
                <div class="card-body">
                    <div id="catalog-shipping-content">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 mb-0">Verificando informa√ß√µes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Resumo Card (placeholder) -->
        <div class="col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Resumo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">Card de resumo ser√° implementado aqui</p>
                    </div>
                </div>
            </div>
        </div>
                </div>

                <!-- Profitability Analysis -->
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> An√°lise de Rentabilidade
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="profitability-analysis">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando rentabilidade...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="bi bi-lightbulb"></i> Recomenda√ß√µes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="recommendations">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Gerando recomenda√ß√µes...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productId = window.location.pathname.split('/').pop();
    loadProductAnalysis(productId);
});

function loadProductAnalysis(productId) {
    // Mostrar loading
    document.getElementById('loading-state').classList.remove('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.add('d-none');

    // Carregar dados do produto
    fetch(`/ml/products/api/product/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderProductInfo(data.product);
                loadMarketplaceFees(data.product);
                checkCatalogInfo(data.product);
                loadProfitabilityAnalysis(data.product);
                loadRecommendations(data.product);
                
                // Mostrar conte√∫do
                document.getElementById('loading-state').classList.add('d-none');
                document.getElementById('analysis-content').classList.remove('d-none');
            } else {
                showError(data.error || 'Erro ao carregar produto');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('Erro ao carregar an√°lise do produto');
        });
}

function renderProductInfo(product) {
    document.getElementById('product-thumbnail').src = product.thumbnail || '/static/images/no-image.png';
    document.getElementById('product-title').textContent = product.title;
    document.getElementById('product-description').textContent = product.subtitle || 'Sem descri√ß√£o';
    document.getElementById('product-ml-id').textContent = product.ml_item_id;
    document.getElementById('product-price').innerHTML = formatProductPriceForAnalysis(product);
    document.getElementById('product-status').innerHTML = getStatusBadge(product.status);
}

function loadMarketplaceFees(product) {
    const feesContainer = document.getElementById('marketplace-fees');
    
    // Buscar taxas reais da API
    fetch(`/ml/products/api/product/${product.id}/fees`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fees.success) {
                const fees = data.fees.data;
                renderMarketplaceFees(fees);
            } else {
                showFeesError(data.fees?.error || 'Erro ao carregar taxas');
            }
        })
        .catch(error => {
            console.error('Erro ao buscar taxas:', error);
            showFeesError('Erro de conex√£o');
        });
}

           function renderMarketplaceFees(fees) {
               const feesContainer = document.getElementById('marketplace-fees');
               
               if (!fees || (Array.isArray(fees) && fees.length === 0)) {
                   feesContainer.innerHTML = `
                       <div class="alert alert-warning">
                           <i class="bi bi-exclamation-triangle"></i>
                           Nenhuma taxa encontrada para este produto.
                       </div>
                   `;
                   return;
               }
               
               // Se fees √© um array, mostrar compara√ß√£o entre tipos de an√∫ncio
               // Se fees √© um objeto, usar diretamente
               if (Array.isArray(fees)) {
                   renderMultipleListingTypes(fees);
               } else {
                   renderSingleListingType(fees);
               }
           }
           
           function renderSingleListingType(fee) {
               const feesContainer = document.getElementById('marketplace-fees');
               const calculatedFees = fee.calculated_fees || {};
               const saleFeeDetails = fee.sale_fee_details || {};
               const shippingInfo = fee.shipping_info || {};
               
               // Buscar pre√ßo do produto
               const productPrice = parseFloat(document.getElementById('product-price').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
               
               feesContainer.innerHTML = `
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-tag"></i> ${fee.listing_type_name || 'Tipo de An√∫ncio'}
                       </h6>
                       <div class="d-flex justify-content-between">
                           <span>Taxa de Publica√ß√£o:</span>
                           <strong class="${(fee.listing_fee_amount || 0) === 0 ? 'text-success' : 'text-primary'}">
                               ${formatPrice(fee.listing_fee_amount || 0)}
                           </strong>
                       </div>
                       <small class="text-muted">
                           Exposi√ß√£o: ${fee.listing_exposure || 'N/A'}
                       </small>
                   </div>
                   
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-cart-check"></i> Taxa de Venda
                       </h6>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Taxa Fixa:</span>
                           <span class="text-primary">${formatPrice(calculatedFees.fixed_fee_amount || 0)}</span>
                       </div>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Comiss√£o ML (${saleFeeDetails.percentage_fee || 0}%):</span>
                           <span class="text-primary">${formatPrice(calculatedFees.percentage_fee_amount || 0)}</span>
                       </div>
                       
                       ${saleFeeDetails.financing_add_on_fee > 0 ? `
                           <div class="d-flex justify-content-between mb-1">
                               <span class="text-muted">Taxa de Financiamento (${saleFeeDetails.financing_add_on_fee}%):</span>
                               <span class="text-primary">${formatPrice(calculatedFees.financing_fee_amount || 0)}</span>
                           </div>
                       ` : ''}
                       
                       <hr class="my-2">
                       <div class="d-flex justify-content-between fw-bold">
                           <span>Subtotal Taxa de Venda:</span>
                           <span class="text-primary">${formatPrice(calculatedFees.total_sale_fees || 0)}</span>
                       </div>
                   </div>
                   
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-truck"></i> Frete
                       </h6>
                       <div class="d-flex justify-content-between mb-1">
                           <span>Frete:</span>
                           <strong class="${shippingInfo.free_shipping ? 'text-success' : 'text-primary'}">
                               ${shippingInfo.free_shipping ? 'GR√ÅTIS (R$ 0,00)' : formatPrice(calculatedFees.shipping_cost || 0)}
                           </strong>
                       </div>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Tipo Log√≠stico:</span>
                           <span class="text-info">${shippingInfo.logistic_type || 'N/A'}</span>
                       </div>
                   </div>
                   
                   <hr class="my-3">
                   <div class="d-flex justify-content-between fw-bold fs-5">
                       <span class="text-dark">TOTAL DE CUSTOS:</span>
                       <span class="text-danger">${formatPrice(calculatedFees.total_cost_with_shipping || 0)}</span>
                   </div>
                   
                   <div class="mt-3">
                       <div class="row text-center">
                           <div class="col-6">
                               <small class="text-muted">Margem de Lucro</small>
                               <div class="fw-bold ${(calculatedFees.profit_margin_percentage || 0) >= 20 ? 'text-success' : (calculatedFees.profit_margin_percentage || 0) >= 10 ? 'text-warning' : 'text-danger'}">
                                   ${(calculatedFees.profit_margin_percentage || 0).toFixed(1)}%
                               </div>
                           </div>
                           <div class="col-6">
                               <small class="text-muted">Lucro L√≠quido</small>
                               <div class="fw-bold ${(calculatedFees.net_profit || 0) > 0 ? 'text-success' : 'text-danger'}">
                                   ${formatPrice(calculatedFees.net_profit || 0)}
                               </div>
                           </div>
                       </div>
                   </div>
               `;
           }
           
           function renderMultipleListingTypes(fees) {
               const feesContainer = document.getElementById('marketplace-fees');
               const productPrice = parseFloat(document.getElementById('product-price').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
               
               let html = '<h6 class="text-primary mb-3"><i class="bi bi-bar-chart"></i> Compara√ß√£o de Tipos de An√∫ncio</h6>';
               
               // Ordenar por custo total crescente
               fees.sort((a, b) => {
                   const costA = (a.calculated_fees?.total_cost_with_shipping || 0);
                   const costB = (b.calculated_fees?.total_cost_with_shipping || 0);
                   return costA - costB;
               });
               
               fees.forEach((fee, index) => {
                   const calculatedFees = fee.calculated_fees || {};
                   const shippingInfo = fee.shipping_info || {};
                   const isBestOption = index === 0;
                   
                   html += `
                       <div class="card mb-2 ${isBestOption ? 'border-success' : ''}">
                           <div class="card-body py-2">
                               <div class="d-flex justify-content-between align-items-center">
                                   <div>
                                       <h6 class="mb-0 ${isBestOption ? 'text-success' : ''}">
                                           ${fee.listing_type_name || 'N/A'}
                                           ${isBestOption ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                       </h6>
                                       <small class="text-muted">${fee.listing_exposure || 'N/A'} ‚Ä¢ ${fee.requires_picture ? 'Com foto' : 'Sem foto'}</small>
                                   </div>
                                   <div class="text-end">
                                       <div class="fw-bold ${isBestOption ? 'text-success' : 'text-primary'}">
                                           ${formatPrice(calculatedFees.total_cost_with_shipping || 0)}
                                       </div>
                                       <small class="text-muted">
                                           Lucro: ${formatPrice(calculatedFees.net_profit || 0)}
                                           (${(calculatedFees.profit_margin_percentage || 0).toFixed(1)}%)
                                       </small>
                                   </div>
                               </div>
                           </div>
                       </div>
                   `;
               });
               
               // Adicionar resumo
               const bestOption = fees[0];
               const worstOption = fees[fees.length - 1];
               const bestFees = bestOption.calculated_fees || {};
               const worstFees = worstOption.calculated_fees || {};
               
               html += `
                   <div class="mt-3 p-3 bg-light rounded">
                       <h6 class="text-success mb-2">
                           <i class="bi bi-lightbulb"></i> Recomenda√ß√£o
                       </h6>
                       <p class="mb-1">
                           <strong>Melhor op√ß√£o:</strong> ${bestOption.listing_type_name} 
                           - Custo total: ${formatPrice(bestFees.total_cost_with_shipping || 0)}
                           - Lucro: ${formatPrice(bestFees.net_profit || 0)}
                       </p>
                       <p class="mb-0">
                           <strong>Economia:</strong> ${formatPrice((worstFees.total_cost_with_shipping || 0) - (bestFees.total_cost_with_shipping || 0))} 
                           comparado ao ${worstOption.listing_type_name}
                       </p>
                   </div>
               `;
               
               feesContainer.innerHTML = html;
           }

function showFeesError(message) {
    const feesContainer = document.getElementById('marketplace-fees');
    feesContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao carregar taxas:</strong> ${message}
        </div>
    `;
}

function loadShippingCosts(product) {
    // Simular carregamento de custos de envio
    setTimeout(() => {
        const shippingContainer = document.getElementById('shipping-costs');
        shippingContainer.innerHTML = `
            <div class="mb-3">
                <label class="form-label">CEP de Destino:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="destination-zip" placeholder="00000-000">
                    <button class="btn btn-outline-primary" onclick="calculateShipping()">
                        <i class="bi bi-calculator"></i> Calcular
                    </button>
                </div>
            </div>
            <div id="shipping-results" class="d-none">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Selecione um CEP para calcular os custos de envio.
                </div>
            </div>
        `;
    }, 1500);
}

function loadProfitabilityAnalysis(product) {
    // Aguardar que as taxas sejam carregadas primeiro
    setTimeout(() => {
        const profitabilityContainer = document.getElementById('profitability-analysis');
        const productPrice = parseFloat(product.price) || 0;
        
        // Tentar obter os custos das taxas j√° calculadas
        const feesContainer = document.getElementById('marketplace-fees');
        let totalFees = 0;
        let profitMargin = 0;
        let roi = 0;
        
        // Extrair custos totais se j√° estiverem calculados
        const totalCostsElement = feesContainer.querySelector('[class*="total-cost"]') || 
                                  Array.from(feesContainer.querySelectorAll('*')).find(el => el.textContent.includes('TOTAL DE CUSTOS'));
        
        if (totalCostsElement) {
            const costText = totalCostsElement.textContent;
            const costMatch = costText.match(/R\$\s*([0-9,]+\.?[0-9]*)/);
            if (costMatch) {
                totalFees = parseFloat(costMatch[1].replace(',', '.'));
            }
        }
        
        // Se n√£o encontrou os custos, usar valor padr√£o baseado no produto
        if (totalFees === 0) {
            // Estimativa baseada no pre√ßo (taxa m√©dia do Mercado Livre ~15%)
            totalFees = productPrice * 0.15;
        }
        
        const netProfit = productPrice - totalFees;
        profitMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
        roi = totalFees > 0 ? (netProfit / totalFees) * 100 : 0;
        
        profitabilityContainer.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Pre√ßo de Venda</h6>
                        <h4 class="text-primary">${formatPrice(productPrice)}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Custos Totais</h6>
                        <h4 class="text-danger">${formatPrice(totalFees)}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Lucro L√≠quido</h6>
                        <h4 class="text-success">${formatPrice(netProfit)}</h4>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span>Margem de Lucro:</span>
                        <strong class="${profitMargin >= 20 ? 'text-success' : profitMargin >= 10 ? 'text-warning' : 'text-danger'}">
                            ${profitMargin.toFixed(1)}%
                        </strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span>ROI:</span>
                        <strong class="${roi >= 50 ? 'text-success' : roi >= 25 ? 'text-warning' : 'text-danger'}">
                            ${roi.toFixed(1)}%
                        </strong>
                    </div>
                </div>
            </div>
        `;
    }, 3000); // Aumentar tempo para aguardar c√°lculo das taxas
}

function loadRecommendations(product) {
    // Simular carregamento de recomenda√ß√µes
    setTimeout(() => {
        const recommendationsContainer = document.getElementById('recommendations');
        recommendationsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-lightbulb"></i>
                <strong>Recomenda√ß√£o:</strong> Este produto tem boa rentabilidade. 
                Considere aumentar o pre√ßo em 10% para maximizar o lucro.
            </div>
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Aten√ß√£o:</strong> Monitore os custos de envio para diferentes regi√µes.
            </div>
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i>
                <strong>Oportunidade:</strong> Produto com boa demanda. 
                Considere investir em an√∫ncios premium.
            </div>
        `;
    }, 2500);
}

function calculateShipping() {
    const zipCode = document.getElementById('destination-zip').value;
    if (!zipCode) {
        alert('Por favor, digite um CEP v√°lido');
        return;
    }
    
    const productId = window.location.pathname.split('/').pop();
    const resultsContainer = document.getElementById('shipping-results');
    
    // Mostrar loading
    resultsContainer.classList.remove('d-none');
    resultsContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Calculando...</span>
            </div>
            <p class="mt-2 mb-0">Calculando custos de envio...</p>
        </div>
    `;
    
    // Buscar op√ß√µes de envio reais
    fetch(`/ml/products/api/product/${productId}/shipping?zip_code=${zipCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.shipping.success) {
                renderShippingOptions(data.shipping.data, zipCode);
            } else {
                showShippingError(data.shipping?.error || 'Erro ao calcular envio');
            }
        })
        .catch(error => {
            console.error('Erro ao calcular envio:', error);
            showShippingError('Erro de conex√£o');
        });
}

function renderShippingOptions(shippingData, zipCode) {
    const resultsContainer = document.getElementById('shipping-results');
    
    if (!shippingData.options || shippingData.options.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Nenhuma op√ß√£o de envio encontrada para o CEP ${zipCode}.
            </div>
        `;
        return;
    }
    
    let optionsHtml = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Op√ß√µes de envio para CEP ${zipCode}</strong>
        </div>
        <div class="row">
    `;
    
    shippingData.options.forEach(option => {
        const cost = option.cost || 0;
        const listCost = option.list_cost || 0;
        const name = option.name || 'Op√ß√£o de Envio';
        const isFree = cost === 0;
        
        optionsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${name}</h6>
                        <div class="d-flex justify-content-between">
                            <span>Custo:</span>
                            <strong class="${isFree ? 'text-success' : 'text-primary'}">
                                ${isFree ? 'GR√ÅTIS' : formatPrice(cost)}
                            </strong>
                        </div>
                        ${listCost > 0 ? `
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Custo original:</small>
                                <small class="text-muted">${formatPrice(listCost)}</small>
                            </div>
                        ` : ''}
                        ${option.estimated_delivery_time ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i>
                                    Entrega: ${option.estimated_delivery_time.shipping || 'N/A'}h
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    optionsHtml += '</div>';
    resultsContainer.innerHTML = optionsHtml;
}

function showShippingError(message) {
    const resultsContainer = document.getElementById('shipping-results');
    resultsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao calcular envio:</strong> ${message}
        </div>
    `;
}

function showError(message) {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.remove('d-none');
    document.getElementById('error-message').textContent = message;
}

function formatPrice(price, currency = 'BRL') {
    // Converter para n√∫mero
    const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
    
    // Se n√£o for um n√∫mero v√°lido, retornar R$ 0,00
    if (isNaN(numericPrice) || numericPrice === null || numericPrice === undefined) {
        return 'R$ 0,00';
    }
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericPrice);
}

function formatProductPriceForAnalysis(product) {
    if (!product.price) return '<span class="text-muted">N/A</span>';
    
    const currentPrice = parseFloat(product.price);
    const originalPrice = product.original_price ? parseFloat(product.original_price) : null;
    const basePrice = product.base_price ? parseFloat(product.base_price) : null;
    
    // Se h√° pre√ßo original e √© diferente do pre√ßo atual, mostrar desconto
    if (originalPrice && originalPrice > currentPrice && originalPrice > 0) {
        const discountPercent = Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
        
        return `
            <div class="d-flex flex-column">
                <div class="text-success fw-bold">
                    ${formatPrice(currentPrice, product.currency_id)}
                </div>
                <div class="text-decoration-line-through text-muted small">
                    ${formatPrice(originalPrice, product.currency_id)}
                </div>
                <div class="badge bg-danger small">
                    -${discountPercent}%
                </div>
            </div>
        `;
    }
    
    // Se h√° base_price diferente do pre√ßo atual, mostrar promo√ß√£o
    if (basePrice && basePrice > currentPrice && basePrice > 0) {
        const discountPercent = Math.round(((basePrice - currentPrice) / basePrice) * 100);
        
        return `
            <div class="d-flex flex-column">
                <div class="text-success fw-bold">
                    ${formatPrice(currentPrice, product.currency_id)}
                </div>
                <div class="text-decoration-line-through text-muted small">
                    ${formatPrice(basePrice, product.currency_id)}
                </div>
                <div class="badge bg-warning text-dark small">
                    -${discountPercent}%
                </div>
            </div>
        `;
    }
    
    // Pre√ßo normal sem desconto
    return `
        <div class="text-primary fw-bold">
            ${formatPrice(currentPrice, product.currency_id)}
        </div>
    `;
}

function getStatusBadge(status) {
    const statusMap = {
        'active': '<span class="badge bg-success">Ativo</span>',
        'paused': '<span class="badge bg-warning">Pausado</span>',
        'closed': '<span class="badge bg-danger">Fechado</span>',
        'under_review': '<span class="badge bg-info">Em Revis√£o</span>',
        'inactive': '<span class="badge bg-secondary">Inativo</span>'
    };
    return statusMap[status] || '<span class="badge bg-secondary">Desconhecido</span>';
}

function checkCatalogInfo(product) {
    // Verificar se o produto √© de cat√°logo
    if (product.catalog_listing) {
        loadCatalogInfo(product.id);
    } else {
        loadShippingCosts(product);
    }
}

function loadCatalogInfo(productId) {
    // Atualizar header
    document.getElementById('catalog-shipping-header').innerHTML = `
        <i class="bi bi-collection"></i> Informa√ß√µes de Cat√°logo
    `;
    
    // Buscar informa√ß√µes de cat√°logo
    fetch(`/ml/products/api/product/${productId}/catalog`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.is_catalog) {
                renderCatalogInfo(data);
            } else {
                // Se n√£o √© cat√°logo, mostrar custos de envio
                loadShippingCosts();
            }
        })
        .catch(error => {
            console.error('Erro ao buscar informa√ß√µes de cat√°logo:', error);
            loadShippingCosts();
        });
}

function renderCatalogInfo(data) {
    const container = document.getElementById('catalog-shipping-content');
    
    if (data.catalog_products.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Este produto √© de cat√°logo, mas n√£o h√° outros anunciantes encontrados.
            </div>
        `;
        return;
    }
    
    // Ordenar por pre√ßo
    const sortedProducts = data.catalog_products.sort((a, b) => a.price - b.price);
    
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Cat√°logo ID: ${data.catalog_product_id}</h6>
                    <span class="badge bg-primary">${data.total_announcers} Anunciantes</span>
                </div>
                <a href="https://www.mercadolivre.com.br/catalogo/explorar/" 
                   target="_blank" 
                   class="btn btn-outline-primary btn-sm"
                   title="Abrir cat√°logo do Mercado Livre">
                    <i class="bi bi-box-arrow-up-right"></i> Ver Cat√°logo
                </a>
                <button type="button" class="btn btn-outline-success btn-sm ms-2" onclick="syncCatalog()" id="sync-catalog-btn">
                    <i class="bi bi-arrow-clockwise"></i> Sincronizar Cat√°logo
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                <th>Anunciante</th>
                <th>Pre√ßo</th>
                <th>Vendas</th>
                <th>Posi√ß√£o</th>
                <th>Envio</th>
                <th>Reputa√ß√£o</th>
                <th>Loja Oficial</th>
                <th>Desconto</th>
                <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    sortedProducts.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informa√ß√µes de envio
        let shippingInfo = "N/A";
        
        if (product.shipping && product.shipping.free_shipping) {
            shippingInfo = '<span class="badge bg-success">Frete Gr√°tis</span>';
        } else if (product.shipping && product.shipping.logistic_type) {
            // Usar logistic_type do objeto shipping
            switch(product.shipping.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Entrega Direta</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                case 'default':
                    shippingInfo = '<span class="badge bg-secondary">Padr√£o</span>';
                    break;
                default:
                    shippingInfo = `<span class="badge bg-light text-dark">${product.shipping.logistic_type}</span>`;
                    break;
            }
        } else if (product.logistic_type) {
            // Fallback para logistic_type do produto
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Entrega Direta</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                case 'default':
                    shippingInfo = '<span class="badge bg-secondary">Padr√£o</span>';
                    break;
                default:
                    shippingInfo = `<span class="badge bg-light text-dark">${product.logistic_type}</span>`;
                    break;
            }
        } else {
            // Se n√£o tem logistic_type, mostrar "N/A"
            shippingInfo = '<span class="badge bg-light text-dark">N/A</span>';
        }
        
        // Informa√ß√µes de garantia
        let warrantyInfo = product.warranty || "";
        if (warrantyInfo && warrantyInfo !== "N/A" && warrantyInfo.length > 30) {
            warrantyInfo = warrantyInfo.substring(0, 30) + "...";
        } else if (!warrantyInfo || warrantyInfo === "N/A") {
            warrantyInfo = "";
        }
        
        // Tags do produto
        let productTags = "";
        if (product.tags && product.tags.length > 0) {
            const importantTags = product.tags.filter(tag => 
                ['good_quality_picture', 'immediate_payment', 'cart_eligible'].includes(tag)
            );
            if (importantTags.length > 0) {
                // Fun√ß√£o para traduzir tags para portugu√™s
                const translateTag = (tag) => {
                    const translations = {
                        'good_quality_picture': 'Imagem de Qualidade',
                        'immediate_payment': 'Pagamento Imediato',
                        'cart_eligible': 'Eleg√≠vel para Carrinho'
                    };
                    return translations[tag] || tag.replace(/_/g, ' ');
                };
                
                productTags = `<div class="mt-1">${importantTags.map(tag => 
                    `<span class="badge bg-light text-dark me-1">${translateTag(tag)}</span>`
                ).join('')}</div>`;
            }
        }
        
        // Total de vendas do vendedor
        const vendasInfo = product.seller_transactions_total > 0 ? 
            `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
            '<span class="badge bg-secondary">0</span>';
        
        // Informa√ß√µes sobre posi√ß√£o no cat√°logo
        let positionInfo = "";
        if (product.buy_box_winner) {
            positionInfo = '<span class="badge bg-success">üèÜ Vencedor</span>';
        } else if (product.position) {
            if (product.position === 1) {
                positionInfo = '<span class="badge bg-success">ü•á 1¬∫ Lugar</span>';
            } else if (product.position === 2) {
                positionInfo = '<span class="badge bg-secondary">ü•à 2¬∫ Lugar</span>';
            } else if (product.position === 3) {
                positionInfo = '<span class="badge bg-warning">ü•â 3¬∫ Lugar</span>';
            } else {
                positionInfo = `<span class="badge bg-light text-dark">#${product.position}</span>`;
            }
        }
        
        // Reputa√ß√£o do vendedor com medalhas
        let reputationBadge = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationBadge = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "YELLOW":
                    reputationBadge = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "RED":
                    reputationBadge = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                default:
                    reputationBadge = '<span class="badge bg-secondary">‚ö™ Neutro</span>';
                    break;
            }
        } else {
            reputationBadge = '<span class="badge bg-light text-dark">‚ùì Desconhecida</span>';
        }
        
        // N√≠vel de reputa√ß√£o do item (current_level)
        let currentLevelBadge = "";
        if (product.current_level && product.current_level !== "unknown") {
            switch(product.current_level.toLowerCase()) {
                case "green":
                    currentLevelBadge = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "yellow":
                    currentLevelBadge = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "red":
                    currentLevelBadge = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                case "newbie":
                    currentLevelBadge = '<span class="badge bg-info">üÜï Iniciante</span>';
                    break;
                default:
                    currentLevelBadge = `<span class="badge bg-secondary">${product.current_level}</span>`;
                    break;
            }
        } else {
            currentLevelBadge = '<span class="badge bg-light text-dark">‚ùì Desconhecido</span>';
        }
        
        // Medalhas do vendedor
        let sellerMedals = "";
        if (product.seller_power_seller_status) {
            let powerSellerText = "";
            let powerSellerClass = "";
            if (product.seller_power_seller_status === "silver") {
                powerSellerText = "MercadoL√≠der";
                powerSellerClass = "bg-secondary"; // Cinza para Silver
            } else if (product.seller_power_seller_status === "gold") {
                powerSellerText = "MercadoL√≠der Gold";
                powerSellerClass = "bg-warning"; // Amarelo/Dourado para Gold
            } else if (product.seller_power_seller_status === "platinum") {
                powerSellerText = "MercadoL√≠der Platinum";
                powerSellerClass = "bg-info"; // Azul para Platinum
            } else {
                powerSellerText = "MercadoL√≠der";
                powerSellerClass = "bg-secondary"; // Cinza padr√£o
            }
            sellerMedals += `<span class="badge ${powerSellerClass} me-1">${powerSellerText}</span>`;
        }
        if (product.seller_experience && product.seller_experience !== "N/A") {
            let experienceText = product.seller_experience;
            if (product.seller_experience === "ADVANCED") {
                experienceText = "Avan√ßado";
            } else if (product.seller_experience === "INTERMEDIATE") {
                experienceText = "Intermedi√°rio";
            } else if (product.seller_experience === "BEGINNER") {
                experienceText = "Iniciante";
            }
            sellerMedals += `<span class="badge bg-info me-1">${experienceText}</span>`;
        }
        
        // Informa√ß√µes adicionais do vendedor
        let sellerInfo = "";
        if (product.accepts_mercadopago) {
            sellerInfo += '<span class="badge bg-primary me-1">MercadoPago</span>';
        }
        if (product.official_store_id) {
            sellerInfo += '<span class="badge bg-info me-1">Loja Oficial</span>';
        }
        if (product.original_price && product.original_price > product.price) {
            const discount = Math.round(((product.original_price - product.price) / product.original_price) * 100);
            sellerInfo += `<span class="badge bg-success me-1">-${discount}%</span>`;
        }
        
        // Badges individuais para as colunas
        // Debug: verificar official_store_id
        console.log('Debug official_store_id:', {
            official_store_id: product.official_store_id,
            type: typeof product.official_store_id
        });
        
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">N√£o</span>';
            
        const descontoBadge = (product.original_price && product.original_price > product.price) ? 
            `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
            '';
        
        // Debug: verificar URL do produto
        console.log(`Produto ${product.ml_item_id}: ${product.permalink}`);
        
        html += `
            <tr>
                <td>
                    <div>
                        <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                        ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                            `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                        <small class="text-muted d-block">${product.ml_item_id}</small>
                        ${sellerMedals ? `<div class="mt-1">${sellerMedals}</div>` : ''}
                        ${productTags}
                    </div>
                </td>
                <td class="fw-bold">${priceFormatted}</td>
                <td>${vendasInfo}</td>
                <td>${positionInfo}</td>
                <td>${shippingInfo}</td>
                <td>${reputationBadge}</td>
                <td>${lojaOficialBadge}</td>
                <td>${descontoBadge}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm" 
                       title="Ver an√∫ncio: ${product.permalink}"
                       onclick="console.log('Clicando em: ${product.permalink}')">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Compara√ß√£o de pre√ßos entre anunciantes do mesmo cat√°logo
            </small>
        </div>
    `;
    
    container.innerHTML = html;
}
</script>
{% endblock %}
