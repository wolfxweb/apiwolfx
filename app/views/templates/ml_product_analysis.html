{% extends "base.html" %}

{% block title %}Análise do Produto - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-calculator text-success"></i>
                        Análise do Produto
                    </h1>
                    <p class="text-muted mb-0">Análise completa de custos e rentabilidade</p>
                </div>
                <div>
                    <a href="/ml/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar aos Produtos
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-5 d-none">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">Carregando análise do produto...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="alert alert-danger d-none">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar análise:</strong>
                <span id="error-message"></span>
            </div>

            <!-- Analysis Content -->
            <div id="analysis-content">
                <!-- Product Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-box"></i> Informações do Produto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img id="product-thumbnail" src="" alt="Produto" class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h4 id="product-title" class="mb-2"></h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>ID:</strong> <span id="product-ml-id"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Status:</strong> <span id="product-status"></span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <a href="https://www.mercadolivre.com.br/catalogo/explorar/" 
                                       target="_blank" 
                                       class="btn btn-outline-primary btn-sm"
                                       title="Abrir catálogo do Mercado Livre">
                                        <i class="bi bi-box-arrow-up-right"></i> Ver Catálogo
                                    </a>
                                    <button type="button" class="btn btn-outline-success btn-sm ms-2" onclick="syncCatalog()" id="sync-catalog-btn">
                                        <i class="bi bi-arrow-clockwise"></i> Sincronizar Catálogo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="row">
                    <!-- Marketplace Fees -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-calculator"></i> Análise de Preços e Taxas
                                </h5>
                            </div>
                <div class="card-body">
                    <div id="marketplace-fees">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 mb-0">Carregando análise de preços...</p>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>

                    <!-- Profitability Analysis -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> Análise de Rentabilidade
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="profitability-analysis">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando rentabilidade...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Analysis Card -->
                <div class="col-md-12 mb-4" id="sales-analysis-card">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up-arrow"></i> Análise de Vendas
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs" id="salesAnalysisTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="product-analysis-tab" data-bs-toggle="tab" 
                                            data-bs-target="#product-analysis" type="button" role="tab" 
                                            aria-controls="product-analysis" aria-selected="true">
                                        <i class="bi bi-box"></i> Análise do Produto
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="sku-sales-tab" data-bs-toggle="tab" 
                                            data-bs-target="#sku-sales" type="button" role="tab" 
                                            aria-controls="sku-sales" aria-selected="false">
                                        <i class="bi bi-bar-chart"></i> Vendas pelo SKU
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="salesAnalysisTabContent">
                                <!-- Product Analysis Tab -->
                                <div class="tab-pane fade show active" id="product-analysis" role="tabpanel" 
                                     aria-labelledby="product-analysis-tab">
                                    <div class="mt-3">
                                        <div id="product-analysis-content">
                                            <div class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <p class="mt-2 mb-0">Carregando análise do produto...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- SKU Sales Tab -->
                                <div class="tab-pane fade" id="sku-sales" role="tabpanel" 
                                     aria-labelledby="sku-sales-tab">
                                    <div class="mt-3">
                                        <div id="sku-sales-content">
                                            <div class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <p class="mt-2 mb-0">Carregando vendas por SKU...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Análise Card -->
                <div class="col-md-12 mb-4" id="competitive-analysis-card">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up"></i> Análise Competitiva
                            </h5>
                        </div>
                       <div class="card-body">
                           <div id="catalog-analysis-content">
                               <div class="text-center py-3">
                                   <div class="spinner-border spinner-border-sm" role="status">
                                       <span class="visually-hidden">Carregando...</span>
                                   </div>
                                   <p class="mt-2 mb-0">Analisando dados...</p>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>

                <!-- Catalog Information -->
                <div class="col-md-12 mb-4" id="catalog-info-card">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0" id="catalog-shipping-header">
                                <i class="bi bi-truck"></i> Custos de Envio
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="catalog-shipping-content">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Verificando informações...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para obter token de sessão
function getSessionToken() {
    // Tentar pegar do cookie primeiro
    const cookies = document.cookie.split(';');
    
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'session_token') {
            return value;
        }
    }
    
    // Fallback para localStorage/sessionStorage
    const localToken = localStorage.getItem('session_token');
    const sessionToken = sessionStorage.getItem('session_token');
    
    return localToken || sessionToken;
}

// Função para verificar se a sessão expirou
function checkSessionExpired(response) {
    if (response.status === 401) {
        // Sessão expirada, redirecionar para login
        window.location.href = '/auth/login';
        return true;
    }
    return false;
}

// Função para ocultar elementos quando sessão expira
function hideUserElements() {
    // Ocultar elementos que requerem autenticação
    const elementsToHide = document.querySelectorAll('.auth-required');
    elementsToHide.forEach(element => {
        element.style.display = 'none';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const productId = window.location.pathname.split('/').pop();
    console.log('🚀 Página carregada, ID do produto:', productId);
    console.log('🍪 Cookies disponíveis:', document.cookie);
    console.log('🔑 Token de sessão:', getSessionToken());
    loadProductAnalysis(productId);
});

function loadProductAnalysis(productId) {
    console.log('🔍 Carregando produto ID:', productId);
    
    // Verificar se o usuário está logado
    const sessionToken = getSessionToken();
    if (!sessionToken || sessionToken === 'null') {
        console.log('🔒 Usuário não logado, redirecionando para login...');
        window.location.href = '/auth/login';
        return;
    }
    
    // Carregar dados do produto
    fetch(`/ml/products/api/product/${productId}`, {
        credentials: 'include'
    })
        .then(response => {
            console.log('📡 Resposta recebida:', response.status);
            if (checkSessionExpired(response)) {
                hideUserElements();
                return;
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 Dados recebidos:', data);
            console.log('📊 Tipo dos dados:', typeof data);
            console.log('📊 Success:', data?.success);
            console.log('📊 Product:', data?.product);
            
            if (data && data.success) {
                console.log('✅ Produto carregado com sucesso');
                console.log('📦 Dados do produto:', data.product);
                renderProductInfo(data.product);
                checkCatalogInfo(data.product);
                loadProfitabilityAnalysis(data.product);
                loadPricingAnalysis(data.product);
                loadSalesAnalysis(data.product);
                
                // Mostrar conteúdo
                document.getElementById('loading-state').classList.add('d-none');
                document.getElementById('analysis-content').classList.remove('d-none');
            } else {
                console.log('❌ Erro ao carregar produto:', data?.error);
                console.log('❌ Dados completos:', data);
                showError(data?.error || 'Erro ao carregar produto');
            }
        })
        .catch(error => {
            console.error('❌ Erro na requisição:', error);
            showError('Erro ao carregar análise do produto');
        });
}

function renderProductInfo(product) {
    console.log('🎨 Renderizando informações do produto:', product);
    
    try {
        // Testar se os elementos existem
        const thumbnail = document.getElementById('product-thumbnail');
        const title = document.getElementById('product-title');
        const mlId = document.getElementById('product-ml-id');
        const status = document.getElementById('product-status');
        
        console.log('🔍 Elementos encontrados:', {
            thumbnail: !!thumbnail,
            title: !!title,
            mlId: !!mlId,
            status: !!status
        });
        
        console.log('📝 Dados do produto para renderizar:', {
            thumbnail: product.thumbnail,
            title: product.title,
            ml_item_id: product.ml_item_id,
            status: product.status
        });
        
        if (thumbnail) {
            thumbnail.src = product.thumbnail || '/static/images/no-image.png';
            console.log('🖼️ Thumbnail definido:', thumbnail.src);
        }
        if (title) {
            title.textContent = product.title || 'Sem título';
            console.log('📝 Título definido:', title.textContent);
        }
        if (mlId) {
            mlId.textContent = product.ml_item_id || 'N/A';
            console.log('🆔 ID definido:', mlId.textContent);
        }
        if (status) {
            status.innerHTML = getStatusBadge(product.status);
            console.log('🏷️ Status definido:', status.innerHTML);
        }
        
        // Mostrar/ocultar botões de catálogo baseado no tipo do produto
        const catalogButtons = document.querySelectorAll('#sync-catalog-btn, a[href*="catalogo"]');
        if (product.catalog_listing) {
            catalogButtons.forEach(btn => btn.style.display = 'inline-block');
        } else {
            catalogButtons.forEach(btn => btn.style.display = 'none');
        }
        
        console.log('✅ Informações do produto renderizadas com sucesso');
    } catch (error) {
        console.error('❌ Erro ao renderizar informações do produto:', error);
    }
}

function getStatusBadge(status) {
    console.log('🏷️ Gerando badge para status:', status);
    
    const statusMap = {
        'active': '<span class="badge bg-success">Ativo</span>',
        'paused': '<span class="badge bg-warning">Pausado</span>',
        'closed': '<span class="badge bg-danger">Fechado</span>',
        'under_review': '<span class="badge bg-info">Em Revisão</span>',
        'inactive': '<span class="badge bg-secondary">Inativo</span>'
    };
    
    const result = statusMap[status] || '<span class="badge bg-secondary">Desconhecido</span>';
    console.log('🏷️ Badge gerado:', result);
    
    return result;
}

function checkCatalogInfo(product) {
    console.log('📋 Verificando informações de catálogo:', product);
    
    try {
        // Verificar se o produto é de catálogo
        if (product.catalog_listing) {
            console.log('📋 Produto é de catálogo, carregando informações...');
            loadCatalogInfo(product.id);
            loadCompetitiveAnalysis(product.id, product);
            // Mostrar cards de catálogo
            const competitiveCard = document.getElementById('competitive-analysis-card');
            const catalogCard = document.getElementById('catalog-info-card');
            if (competitiveCard) competitiveCard.style.display = 'block';
            if (catalogCard) catalogCard.style.display = 'block';
        } else {
            console.log('📋 Produto não é de catálogo, carregando custos de envio...');
            loadShippingCosts(product);
            // Ocultar cards de catálogo
            const competitiveCard = document.getElementById('competitive-analysis-card');
            const catalogCard = document.getElementById('catalog-info-card');
            if (competitiveCard) competitiveCard.style.display = 'none';
            if (catalogCard) catalogCard.style.display = 'none';
        }
        
        console.log('✅ Informações de catálogo verificadas com sucesso');
    } catch (error) {
        console.error('❌ Erro ao verificar informações de catálogo:', error);
    }
}

function loadCatalogInfo(productId) {
    console.log('📋 Carregando informações de catálogo para produto:', productId);
    
    // Atualizar header
    document.getElementById('catalog-shipping-header').innerHTML = `
        <i class="bi bi-collection"></i> Informações de Catálogo
    `;
    
    // Primeiro tenta buscar do banco de dados
    fetch(`/ml/products/api/product/${productId}/catalog/database`, {
        credentials: 'include'
    })
        .then(response => {
            console.log('📡 Resposta do catálogo:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Dados do catálogo recebidos:', data);
            if (handleSessionError(null, data)) return;
            if (data.success && data.is_catalog && data.catalog_products.length > 0) {
                console.log('✅ Dados de catálogo encontrados, renderizando...');
                // Mostrar dados do banco com data da última atualização
                renderCatalogInfo(data);
            } else {
                console.log('⚠️ Nenhum dado de catálogo encontrado');
                // Se não tem dados no banco, mostrar mensagem para sincronizar
                const container = document.getElementById('catalog-shipping-content');
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle fs-1"></i>
                        <h5 class="mt-3">Nenhum Dado Sincronizado</h5>
                        <p>Este catálogo ainda não foi sincronizado com o banco de dados.</p>
                        <p>Clique em "Sincronizar Catálogo" para importar os dados.</p>
                        <button type="button" class="btn btn-success" onclick="syncCatalog()" id="sync-catalog-btn">
                            <i class="bi bi-arrow-clockwise"></i> Sincronizar Catálogo
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('❌ Erro ao carregar informações de catálogo do banco:', error);
            // Mostrar mensagem de erro
            const container = document.getElementById('catalog-shipping-content');
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <h5 class="mt-3">Erro ao Carregar Dados</h5>
                    <p>Não foi possível carregar os dados do catálogo do banco de dados.</p>
                    <p>Verifique sua conexão e tente novamente.</p>
                    <button type="button" class="btn btn-primary" onclick="loadCatalogInfo(${productId})">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </div>
            `;
        });
}

function renderCatalogInfo(data) {
    console.log('🎨 Renderizando informações de catálogo:', data);
    
    const container = document.getElementById('catalog-shipping-content');
    
    if (!data.catalog_products || data.catalog_products.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Este produto é de catálogo, mas não há outros anunciantes encontrados.
            </div>
        `;
        return;
    }
    
    // Ordenar por preço
    const sortedProducts = data.catalog_products.sort((a, b) => a.price - b.price);
    
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Anunciantes do Catálogo (${sortedProducts.length})</h6>
                <small class="text-muted">Última atualização: ${data.last_updated || 'N/A'}</small>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label small">Posição:</label>
                <select class="form-select form-select-sm" id="filter-position" onchange="filterCatalog()">
                    <option value="">Todas</option>
                    <option value="1">1º Lugar</option>
                    <option value="2">2º Lugar</option>
                    <option value="3">3º Lugar</option>
                    <option value="top3">Top 3</option>
                    <option value="winner">Vencedor</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Faixa de Preço:</label>
                <select class="form-select form-select-sm" id="filter-price" onchange="filterCatalog()">
                    <option value="">Todas</option>
                    <option value="lowest">Menor Preço</option>
                    <option value="highest">Maior Preço</option>
                    <option value="below_avg">Abaixo da Média</option>
                    <option value="above_avg">Acima da Média</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Tipo de Envio:</label>
                <select class="form-select form-select-sm" id="filter-shipping" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="free">Frete Grátis</option>
                    <option value="full">Full Mercado Livre</option>
                    <option value="correios">Correios</option>
                    <option value="mercado_envios">Mercado Envios</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">MercadoLíder:</label>
                <select class="form-select form-select-sm" id="filter-mercadolider" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="platinum">Platinum</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="none">Sem Medalha</option>
                </select>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div id="filter-results">
                <small class="text-muted">${sortedProducts.length} resultados</small>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                <i class="bi bi-x-circle"></i> Limpar Filtros
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-primary text-white">
                    <tr>
                        <th>Vendedor</th>
                        <th>Preço</th>
                        <th>Vendas</th>
                        <th>Posição</th>
                        <th>Envio</th>
                        <th>Reputação</th>
                        <th>Loja Oficial</th>
                        <th>Desconto</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    sortedProducts.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informações de envio
        let shippingInfo = "Não disponível";
        
        if (product.shipping_free) {
            shippingInfo = '<span class="badge bg-success">Frete Grátis</span>';
        } else if (product.logistic_type && product.logistic_type !== 'default') {
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = `<span class="badge bg-light text-dark">${getShippingTypeLabel(product.logistic_type)}</span>`;
                    break;
            }
        }
        
        // Informações de reputação
        let reputationBadge = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationBadge = '<span class="badge bg-success">🟢 Verde</span>';
                    break;
                case "YELLOW":
                    reputationBadge = '<span class="badge bg-warning">🟡 Amarelo</span>';
                    break;
                case "RED":
                    reputationBadge = '<span class="badge bg-danger">🔴 Vermelho</span>';
                    break;
                default:
                    reputationBadge = '<span class="badge bg-secondary">⚪ Neutro</span>';
                    break;
            }
        } else {
            reputationBadge = '<span class="badge bg-light text-dark">❓ Desconhecida</span>';
        }
        
        // Loja oficial
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">Não</span>';
        
        // Desconto
        const descontoBadge = (product.original_price && product.original_price > product.price) ? 
            `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
            '';
        
        // Posição
        let positionInfo = "";
        if (product.buy_box_winner) {
            positionInfo = '<span class="badge bg-success">🏆 Vencedor</span>';
        } else if (product.position) {
            if (product.position === 1) {
                positionInfo = '<span class="badge bg-success">🥇 1º Lugar</span>';
            } else if (product.position === 2) {
                positionInfo = '<span class="badge bg-secondary">🥈 2º Lugar</span>';
            } else if (product.position === 3) {
                positionInfo = '<span class="badge bg-warning">🥉 3º Lugar</span>';
            } else {
                positionInfo = `<span class="badge bg-light text-dark">#${product.position}</span>`;
            }
        }
        
        // Total de vendas
        const vendasInfo = product.seller_transactions_total > 0 ? 
            `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
            '<span class="badge bg-secondary">0</span>';
        
        html += `
            <tr>
                <td>
                    <div>
                        <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                        ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                            `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                        <small class="text-muted d-block">${product.ml_item_id}</small>
                    </div>
                </td>
                <td class="fw-bold">${priceFormatted}</td>
                <td>${vendasInfo}</td>
                <td>${positionInfo}</td>
                <td>${shippingInfo}</td>
                <td>${reputationBadge}</td>
                <td>${lojaOficialBadge}</td>
                <td>${descontoBadge}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm" 
                       title="Ver anúncio">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Comparação de preços entre anunciantes do mesmo catálogo
            </small>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Armazenar dados originais para filtros
    window.catalogData = data;
    
    console.log('✅ Informações de catálogo renderizadas com sucesso');
}

function getShippingTypeLabel(logisticType) {
    const translations = {
        'fulfillment': 'Full Mercado Livre',
        'xd_drop_off': 'Correios',
        'drop_off': 'Correios',
        'cross_docking': 'Coleta ML',
        'me2': 'Mercado Envios',
        'standard': 'Mercado Envios',
        'default': 'Não disponível'
    };
    return translations[logisticType] || logisticType;
}

function loadCompetitiveAnalysis(productId, product) {
    console.log('📊 Carregando análise competitiva para produto:', productId);
    
    fetch(`/ml/products/api/product/${productId}/catalog/database`, {
        credentials: 'include'
    })
        .then(response => {
            console.log('📡 Resposta da análise competitiva:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Dados da análise competitiva recebidos:', data);
            if (handleSessionError(null, data)) return;
            
            if (data && data.success && data.catalog_products) {
                console.log('✅ Dados de análise competitiva encontrados, renderizando...');
                renderCompetitiveAnalysis(data.catalog_products, product);
            } else {
                console.log('⚠️ Nenhum dado de análise competitiva encontrado');
                document.getElementById('catalog-analysis-content').innerHTML = 
                    '<div class="text-center py-3"><p class="text-muted mb-0">Nenhum dado de catálogo disponível</p></div>';
            }
        })
        .catch(error => {
            console.error('❌ Erro ao carregar análise competitiva:', error);
            document.getElementById('catalog-analysis-content').innerHTML = 
                '<div class="text-center py-3"><p class="text-danger mb-0">Erro ao carregar análise</p></div>';
        });
}

function renderCompetitiveAnalysis(products, currentProduct) {
    console.log('🎨 Renderizando análise competitiva:', products, 'Produto atual:', currentProduct);
    
    const analysisContent = document.getElementById('catalog-analysis-content');
    
    if (!products || products.length === 0) {
        analysisContent.innerHTML = `
            <div class="text-center py-3">
                <p class="text-muted mb-0">Nenhum dado de catálogo disponível</p>
            </div>
        `;
        return;
    }
    
    // Análise por tipo de envio
    const shippingAnalysis = analyzeShippingTypes(products);
    
    // Top 3 anunciantes
    const top3 = getTop3Announcers(products);
    
    // Análise de posicionamento
    const positioningAnalysis = analyzePositioning(products, currentProduct);
    
    // Análise de MercadoLíder
    const mercadoLiderAnalysis = analyzeMercadoLider(products);
    
    // Análise de faixas de valor
    const priceRangesAnalysis = analyzePriceRanges(products);
    
    // Métricas gerais
    const metrics = calculateMetrics(products);
    
    analysisContent.innerHTML = `
        <div class="row">
            <!-- Análise por Tipo de Envio -->
            <div class="col-md-6 mb-4">
                <h6 class="text-primary mb-3">
                    <i class="bi bi-truck"></i> Distribuição por Envio
                </h6>
                <div class="row">
                    ${Object.entries(shippingAnalysis).map(([type, count]) => `
                        <div class="col-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">${getShippingTypeLabel(type)}</span>
                                <span class="badge bg-primary">${count}</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Top 3 Anunciantes -->
            <div class="col-md-6 mb-4">
                <h6 class="text-success mb-3">
                    <i class="bi bi-trophy"></i> Top 3 Anunciantes
                </h6>
                ${top3.map((announcer, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 ${index === 0 ? 'bg-light rounded' : ''}">
                        <div>
                            <span class="badge ${index === 0 ? 'bg-warning' : index === 1 ? 'bg-secondary' : 'bg-dark'}">${announcer.position || (index + 1)}º</span>
                            <strong>${getSellerDisplayName(announcer)}</strong>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted">R$ ${(announcer.price).toFixed(2)}</div>
                            <div class="small">${announcer.shipping_type}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Análise por Faixas de Valor e MercadoLíder -->
        <div class="row">
            <!-- Análise por Faixas de Valor -->
            <div class="col-md-6 mb-4">
                <h6 class="text-success mb-3">
                    <i class="bi bi-currency-dollar"></i> Distribuição por Faixas de Valor
                </h6>
                <div class="row">
                    ${Object.entries(analyzePriceRanges(products)).map(([range, count]) => `
                        <div class="col-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">${getPriceRangeLabel(range)}</span>
                                <span class="badge ${getPriceRangeBadgeClass(range)}">${count}</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar ${getPriceRangeProgressClass(range)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Distribuição por MercadoLíder -->
            <div class="col-md-6 mb-4">
                <h6 class="text-warning mb-3">
                    <i class="bi bi-award"></i> Distribuição por MercadoLíder
                </h6>
                <div class="row">
                    ${Object.entries(analyzeMercadoLider(products)).map(([level, count]) => `
                        <div class="col-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">${getMercadoLiderLabel(level)}</span>
                                <span class="badge ${getMercadoLiderBadgeClass(level)}">${count}</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar ${getMercadoLiderProgressClass(level)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <!-- Análise de Posicionamento -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <h6 class="text-info mb-3">
                    <i class="bi bi-graph-up"></i> Análise de Posicionamento
                </h6>
                <div class="row">
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="text-primary">${metrics.total_announcers}</h5>
                                <small class="text-muted">Total de Anunciantes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="text-warning">${positioningAnalysis.your_position || 'N/A'}</h5>
                                <small class="text-muted">Sua Posição</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-success">R$ ${parseFloat(metrics.min_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                <small class="text-muted">Menor Preço</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-info">R$ ${parseFloat(metrics.avg_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                <small class="text-muted">Preço Médio</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    console.log('✅ Análise competitiva renderizada com sucesso');
}

// Funções auxiliares para análise competitiva
function analyzeShippingTypes(products) {
    const shippingTypes = {};
    products.forEach(product => {
        const shippingType = getShippingTypeFromProduct(product);
        shippingTypes[shippingType] = (shippingTypes[shippingType] || 0) + 1;
    });
    return shippingTypes;
}

function getShippingTypeFromProduct(product) {
    if (product.shipping_free) return 'frete_gratis';
    if (product.logistic_type === 'fulfillment') return 'full';
    if (product.logistic_type === 'cross_docking') return 'coleta_ml';
    if (product.shipping_method === 'me2') return 'mercado_envios';
    if (product.shipping_method === 'drop_off' || product.shipping_method === 'xd_drop_off') return 'correios';
    return 'outros';
}

function getSellerDisplayName(seller) {
    if (seller.seller_name && seller.seller_name !== 'N/A') {
        return seller.seller_name;
    }
    if (seller.seller_nickname && seller.seller_nickname !== 'N/A') {
        return seller.seller_nickname;
    }
    return seller.seller_id || 'N/A';
}

function getTop3Announcers(products) {
    const sorted = products
        .sort((a, b) => (a.position || 999) - (b.position || 999))
        .slice(0, 3);
    
    return sorted.map(product => ({
        ...product,
        shipping_type: getShippingTypeLabel(getShippingTypeFromProduct(product))
    }));
}

function analyzePositioning(products, currentProduct) {
    if (!products || products.length === 0) {
        return {
            your_position: null,
            total_competitors: 0,
            best_position: null,
            your_price: null
        };
    }
    
    // Buscar pelo produto atual usando o ml_item_id
    const yourProduct = products.find(p => p.ml_item_id === currentProduct.ml_item_id);
    
    // Encontrar a melhor posição geral
    const positions = products.map(p => parseInt(p.position) || 999);
    const bestPosition = Math.min(...positions);
    
    return {
        your_position: yourProduct ? (parseInt(yourProduct.position) || null) : null,
        total_competitors: products.length - 1,
        best_position: bestPosition,
        your_price: yourProduct ? (parseFloat(yourProduct.price) || null) : null
    };
}

function calculateMetrics(products) {
    const totalPrice = products.reduce((sum, product) => sum + product.price, 0);
    const avgPrice = (totalPrice / products.length).toFixed(2);
    
    return {
        total_announcers: products.length,
        avg_price: avgPrice,
        min_price: (Math.min(...products.map(p => p.price))).toFixed(2),
        max_price: (Math.max(...products.map(p => p.price))).toFixed(2)
    };
}

function analyzeMercadoLider(products) {
    const levels = {};
    products.forEach(product => {
        const level = getMercadoLiderLevel(product);
        levels[level] = (levels[level] || 0) + 1;
    });
    return levels;
}

function analyzePriceRanges(products) {
    const ranges = {};
    products.forEach(product => {
        const range = getPriceRange(product.price);
        ranges[range] = (ranges[range] || 0) + 1;
    });
    return ranges;
}

function getPriceRange(price) {
    if (price <= 10) return 'ate_10';
    if (price <= 20) return '10_20';
    if (price <= 30) return '20_30';
    if (price <= 50) return '30_50';
    if (price <= 100) return '50_100';
    return 'acima_100';
}

function getPriceRangeLabel(range) {
    const labels = {
        'ate_10': 'Até R$ 10',
        '10_20': 'R$ 10 - R$ 20',
        '20_30': 'R$ 20 - R$ 30',
        '30_50': 'R$ 30 - R$ 50',
        '50_100': 'R$ 50 - R$ 100',
        'acima_100': 'Acima de R$ 100'
    };
    return labels[range] || range;
}

function getPriceRangeBadgeClass(range) {
    const classes = {
        'ate_10': 'bg-success',
        '10_20': 'bg-primary',
        '20_30': 'bg-info',
        '30_50': 'bg-warning',
        '50_100': 'bg-danger',
        'acima_100': 'bg-dark'
    };
    return classes[range] || 'bg-secondary';
}

function getPriceRangeProgressClass(range) {
    const classes = {
        'ate_10': 'bg-success',
        '10_20': 'bg-primary',
        '20_30': 'bg-info',
        '30_50': 'bg-warning',
        '50_100': 'bg-danger',
        'acima_100': 'bg-dark'
    };
    return classes[range] || 'bg-secondary';
}

function getMercadoLiderLevel(product) {
    const status = product.seller_power_seller_status;
    if (!status || status === 'N/A') {
        return 'sem_medalha';
    }
    
    if (status === 'platinum') {
        return 'platinum';
    } else if (status === 'gold') {
        return 'gold';
    } else if (status === 'silver') {
        return 'silver';
    }
    
    return 'sem_medalha';
}

function getMercadoLiderLabel(level) {
    const labels = {
        'platinum': '🥇 MercadoLíder Platinum',
        'gold': '🥈 MercadoLíder Gold',
        'silver': '🥉 MercadoLíder',
        'sem_medalha': '⚪ Sem Medalha'
    };
    return labels[level] || level;
}

function getMercadoLiderBadgeClass(level) {
    const classes = {
        'platinum': 'bg-info',
        'gold': 'bg-warning',
        'silver': 'bg-secondary',
        'sem_medalha': 'bg-success text-white'
    };
    return classes[level] || 'bg-secondary';
}

function getMercadoLiderProgressClass(level) {
    const classes = {
        'platinum': 'bg-info',
        'gold': 'bg-warning',
        'silver': 'bg-secondary',
        'sem_medalha': 'bg-success'
    };
    return classes[level] || 'bg-secondary';
}

function loadProfitabilityAnalysis(product) {
    console.log('💰 Carregando análise de rentabilidade para produto:', product);
    
    const profitabilityContainer = document.getElementById('profitability-analysis');
    const productPrice = parseFloat(product.price) || 0;
    
    // Simular cálculo de rentabilidade baseado no preço
    // Taxa média do Mercado Livre ~15%
    const totalFees = productPrice * 0.15;
    const netProfit = productPrice - totalFees;
    const profitMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
    const roi = totalFees > 0 ? (netProfit / totalFees) * 100 : 0;
    
    console.log('💰 Cálculos de rentabilidade:', {
        productPrice,
        totalFees,
        netProfit,
        profitMargin,
        roi
    });
    
    profitabilityContainer.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                    <h6 class="text-muted">Preço de Venda</h6>
                    <h4 class="text-primary">${formatPrice(productPrice)}</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                    <h6 class="text-muted">Custos Totais</h6>
                    <h4 class="text-danger">${formatPrice(totalFees)}</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                    <h6 class="text-muted">Lucro Líquido</h6>
                    <h4 class="text-success">${formatPrice(netProfit)}</h4>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <div class="d-flex justify-content-between">
                    <span>Margem de Lucro:</span>
                    <strong class="${profitMargin >= 20 ? 'text-success' : profitMargin >= 10 ? 'text-warning' : 'text-danger'}">
                        ${profitMargin.toFixed(1)}%
                    </strong>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-between">
                    <span>ROI:</span>
                    <strong class="${roi >= 50 ? 'text-success' : roi >= 25 ? 'text-warning' : 'text-danger'}">
                        ${roi.toFixed(1)}%
                    </strong>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Análise Estimada:</strong> Baseada em taxa média do Mercado Livre (~15%).
                Para análise precisa, configure os custos internos do produto.
            </div>
        </div>
    `;
    
    console.log('✅ Análise de rentabilidade renderizada com sucesso');
}

async function loadPricingAnalysis(product) {
    console.log('💰 Carregando análise de preços para produto:', product);
    
    // Verificar se o produto tem SKU
    const sku = product.seller_custom_field || product.sku || product.seller_sku;
    
    if (!sku) {
        console.log('⚠️ Produto sem SKU - mostrando mensagem informativa');
        const feesContainer = document.getElementById('marketplace-fees');
        feesContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Produto sem SKU associado</strong><br>
                Para ver a análise completa de preços, é necessário associar um SKU interno a este produto.
            </div>
        `;
        return;
    }
    
    console.log('🔍 Buscando dados internos para SKU:', sku);
    
    try {
        // Buscar dados do produto interno
        const internalResponse = await fetch(`/api/pricing/analysis/sku/${sku}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('📡 Resposta da análise de preços:', internalResponse.status);
        const internalData = await internalResponse.json();
        console.log('📊 Dados da análise de preços recebidos:', internalData);
        
        if (internalData && internalData.success && internalData.analysis && internalData.analysis.internal_product) {
            console.log('✅ Dados internos encontrados, buscando taxas ML...');
            
            // Buscar taxas reais do Mercado Livre
            const mlFeesUrl = `/api/ml-pricing/fees?price=${product.price}&category_id=${product.category_id}&item_id=${product.ml_item_id}`;
            console.log('🔗 URL da API ML:', mlFeesUrl);
            
            const mlFeesResponse = await fetch(mlFeesUrl, {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('📡 Status da resposta ML:', mlFeesResponse.status);
            
            let mlFeesData = null;
            if (mlFeesResponse.ok) {
                mlFeesData = await mlFeesResponse.json();
                console.log('📊 Taxas ML obtidas:', mlFeesData);
            } else {
                const errorText = await mlFeesResponse.text();
                console.log('⚠️ Erro ao obter taxas ML:', mlFeesResponse.status, errorText);
            }
            
            // O custo do frete já está incluído em mlFeesData.fees.shipping_cost
            
            renderPricingAnalysis(internalData, product, mlFeesData);
        } else {
            console.log('⚠️ Nenhum dado interno encontrado');
            const feesContainer = document.getElementById('marketplace-fees');
            feesContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Produto interno não encontrado</strong><br>
                    SKU "${sku}" não foi encontrado na base de dados interna.
                </div>
            `;
        }
    } catch (error) {
        console.error('❌ Erro ao carregar análise de preços:', error);
        const feesContainer = document.getElementById('marketplace-fees');
        feesContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar análise</strong><br>
                Não foi possível carregar os dados de preços do produto.
            </div>
        `;
    }
}

function renderPricingAnalysis(data, product, mlFeesData = null) {
    console.log('🎨 Renderizando análise de preços:', data, 'Taxas ML:', mlFeesData);
    
    const feesContainer = document.getElementById('marketplace-fees');
    const internalProduct = data.analysis.internal_product;
    const productPrice = parseFloat(product.price) || 0;
    
    // Calcular valores
    const costPrice = parseFloat(internalProduct.cost_price) || 0;
    const taxPercentage = parseFloat(internalProduct.tax_rate) || 0;
    const marketingPercentage = parseFloat(internalProduct.marketing_cost) || 0;
    const otherCosts = parseFloat(internalProduct.other_costs) || 0;
    const expectedMargin = parseFloat(internalProduct.expected_profit_margin) || 0;
    
    // Calcular valores monetários
    const taxAmount = (productPrice * taxPercentage / 100);
    const marketingAmount = (productPrice * marketingPercentage / 100);
    
    // Custos internos
    const totalInternalCosts = costPrice + taxAmount + marketingAmount + otherCosts;
    
    // Custos do Mercado Livre (usar taxas reais se disponíveis)
    let mlFixedFee, mlPercentageFee, mlShipping, mlAdditionalFees;
    
    if (mlFeesData && mlFeesData.success) {
        // Usar taxas reais da API
        mlFixedFee = parseFloat(mlFeesData.fees.fixed_fee) || 0;
        mlPercentageFee = parseFloat(mlFeesData.fees.percentage_amount) || 0;
        mlShipping = parseFloat(mlFeesData.fees.shipping_cost) || 0;
        mlAdditionalFees = parseFloat(mlFeesData.fees.listing_fee) || 0;
        console.log('✅ Usando taxas reais da API ML:', mlFeesData.fees);
    } else {
        // Usar valores padrão como fallback
        if (productPrice < 79.90) {
            mlFixedFee = 6.25;
            mlPercentageFee = productPrice * 0.13;
            mlShipping = 15.0; // Frete para produtos baratos
        } else {
            mlFixedFee = 0;
            mlPercentageFee = productPrice * 0.12;
            mlShipping = 0; // Frete gratuito para produtos >= R$ 79,90
        }
        mlAdditionalFees = 0;
        console.log('⚠️ Usando taxas padrão como fallback');
    }
    
    // Total de todos os custos
    const totalAllCosts = totalInternalCosts + mlFixedFee + mlPercentageFee + mlShipping + mlAdditionalFees;
    
    // Lucro final
    const netProfit = productPrice - totalAllCosts;
    const actualMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
    
    console.log('💰 Cálculos de preços:', {
        productPrice,
        costPrice,
        taxPercentage,
        taxAmount,
        marketingPercentage,
        marketingAmount,
        otherCosts,
        totalInternalCosts,
        mlFixedFee,
        mlPercentageFee,
        mlShipping,
        mlAdditionalFees,
        totalAllCosts,
        netProfit,
        actualMargin,
        expectedMargin
    });
    
    feesContainer.innerHTML = `
        <div class="list-group list-group-flush">
            <div class="list-group-item d-flex justify-content-between text-success">
                <span>💰 Preço de Venda:</span>
                <span>+R$ ${productPrice.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>📦 Preço Custo Produto:</span>
                <span>-R$ ${costPrice.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>📢 Marketing (${marketingPercentage.toFixed(1)}%):</span>
                <span>-R$ ${marketingAmount.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>💼 Outros Custos:</span>
                <span>-R$ ${otherCosts.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>🏛️ Impostos (${taxPercentage.toFixed(1)}%):</span>
                <span>-R$ ${taxAmount.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>🏪 Taxa Fixa ML:</span>
                <span>-R$ ${mlFixedFee.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>📊 Taxa Percentual ML (${mlFeesData && mlFeesData.success ? mlFeesData.fees.percentage_fee : (productPrice < 79.90 ? 13 : 12)}%):</span>
                <span>-R$ ${mlPercentageFee.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>🚚 Frete:</span>
                <span>-R$ ${mlShipping.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>📋 Taxas Adicionais:</span>
                <span>-R$ 0,00</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between bg-primary text-white">
                <span>💰 Lucro Final:</span>
                <span>R$ ${netProfit.toFixed(2)}</span>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="row text-center">
                <div class="col-6">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="text-muted mb-1">Margem Atual</h6>
                            <h5 class="${actualMargin >= expectedMargin ? 'text-success' : 'text-danger'} mb-0">
                                ${actualMargin.toFixed(1)}%
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="text-muted mb-1">Margem Esperada</h6>
                            <h5 class="text-info mb-0">${expectedMargin.toFixed(1)}%</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    `;
    
    console.log('✅ Análise de preços renderizada com sucesso');
}

// Função para filtrar catálogo
async function filterCatalog() {
    const positionFilter = document.getElementById('filter-position').value;
    const priceFilter = document.getElementById('filter-price').value;
    const shippingFilter = document.getElementById('filter-shipping').value;
    const mercadoliderFilter = document.getElementById('filter-mercadolider').value;
    
    console.log('🔍 Aplicando filtros:', {
        position: positionFilter,
        price: priceFilter,
        shipping: shippingFilter,
        mercadolider: mercadoliderFilter
    });
    
    // Se não há dados originais carregados, carregar primeiro
    if (!window.catalogData || !window.catalogData.catalog_products) {
        console.log('📊 Carregando dados originais para filtro...');
        const currentPath = window.location.pathname;
        const productId = currentPath.split('/').pop();
        
        try {
            const response = await fetch(`/ml/products/api/product/${productId}/catalog/database`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success && data.catalog_products) {
                window.catalogData = data;
            } else {
                console.error('Erro ao carregar dados para filtro:', data.error);
                return;
            }
        } catch (error) {
            console.error('Erro ao carregar dados para filtro:', error);
            return;
        }
    }
    
    // Aplicar filtros no frontend
    let filteredProducts = [...window.catalogData.catalog_products];
    
    // Filtro por posição
    if (positionFilter) {
        console.log('🔍 Aplicando filtro de posição:', positionFilter);
        filteredProducts = filteredProducts.filter(product => {
            switch (positionFilter) {
                case '1':
                    return product.position === 1;
                case '2':
                    return product.position === 2;
                case '3':
                    return product.position === 3;
                case 'top3':
                    return product.position >= 1 && product.position <= 3;
                case 'winner':
                    return product.buy_box_winner === true;
                default:
                    return true;
            }
        });
        console.log('📊 Produtos após filtro de posição:', filteredProducts.length);
    }
    
    // Filtro por preço
    if (priceFilter) {
        console.log('🔍 Aplicando filtro de preço:', priceFilter);
        const prices = filteredProducts.map(p => p.price);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
        
        filteredProducts = filteredProducts.filter(product => {
            switch (priceFilter) {
                case 'lowest':
                    return product.price === minPrice;
                case 'highest':
                    return product.price === maxPrice;
                case 'below_avg':
                    return product.price < avgPrice;
                case 'above_avg':
                    return product.price > avgPrice;
                default:
                    return true;
            }
        });
        console.log('📊 Produtos após filtro de preço:', filteredProducts.length);
    }
    
    // Filtro por envio
    if (shippingFilter) {
        console.log('🔍 Aplicando filtro de envio:', shippingFilter);
        filteredProducts = filteredProducts.filter(product => {
            switch (shippingFilter) {
                case 'free':
                    return product.shipping_free === true;
                case 'full':
                    return product.logistic_type === 'fulfillment';
                case 'correios':
                    return product.logistic_type === 'drop_off' || product.logistic_type === 'xd_drop_off';
                case 'mercado_envios':
                    return product.shipping_method === 'me2' || product.logistic_type === 'me2';
                default:
                    return true;
            }
        });
        console.log('📊 Produtos após filtro de envio:', filteredProducts.length);
    }
    
    // Filtro por MercadoLíder
    if (mercadoliderFilter) {
        console.log('🔍 Aplicando filtro de MercadoLíder:', mercadoliderFilter);
        filteredProducts = filteredProducts.filter(product => {
            switch (mercadoliderFilter) {
                case 'platinum':
                    return product.seller_power_seller_status === 'platinum';
                case 'gold':
                    return product.seller_power_seller_status === 'gold';
                case 'silver':
                    return product.seller_power_seller_status === 'silver';
                case 'none':
                    return !product.seller_power_seller_status || product.seller_power_seller_status === 'N/A';
                default:
                    return true;
            }
        });
        console.log('📊 Produtos após filtro de MercadoLíder:', filteredProducts.length);
    }
    
    // Atualizar contador de resultados
    document.getElementById('filter-results').innerHTML = `<small class="text-muted">${filteredProducts.length} resultados</small>`;
    
    // Renderizar tabela filtrada
    renderFilteredTable(filteredProducts);
    
    console.log('✅ Filtros aplicados com sucesso');
}

// Função para limpar filtros
async function clearFilters() {
    console.log('🧹 Limpando filtros');
    
    // Resetar todos os filtros
    document.getElementById('filter-position').value = '';
    document.getElementById('filter-price').value = '';
    document.getElementById('filter-shipping').value = '';
    document.getElementById('filter-mercadolider').value = '';
    
    // Se não há dados originais carregados, carregar primeiro
    if (!window.catalogData || !window.catalogData.catalog_products) {
        console.log('📊 Carregando dados originais para limpeza...');
        const currentPath = window.location.pathname;
        const productId = currentPath.split('/').pop();
        
        try {
            const response = await fetch(`/ml/products/api/product/${productId}/catalog/database`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success && data.catalog_products) {
                window.catalogData = data;
            } else {
                console.error('Erro ao carregar dados para limpeza:', data.error);
                return;
            }
        } catch (error) {
            console.error('Erro ao carregar dados para limpeza:', error);
            return;
        }
    }
    
    // Atualizar contador de resultados
    document.getElementById('filter-results').innerHTML = `<small class="text-muted">${window.catalogData.catalog_products.length} resultados</small>`;
    
    // Renderizar tabela original
    renderFilteredTable(window.catalogData.catalog_products);
    
    console.log('✅ Filtros limpos com sucesso');
}

// Função para renderizar tabela filtrada
function renderFilteredTable(products) {
    console.log('🎨 Renderizando tabela filtrada com', products.length, 'produtos');
    
    const tbody = document.querySelector('#catalog-shipping-content tbody');
    if (!tbody) return;
    
    let html = '';
    
    products.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informações de envio - usar a mesma lógica da função original
        let shippingInfo = "Não disponível";
        
        if (product.shipping_free) {
            shippingInfo = '<span class="badge bg-success">Frete Grátis</span>';
        } else if (product.logistic_type && product.logistic_type !== 'default') {
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = '<span class="badge bg-secondary">Outros</span>';
            }
        } else if (product.shipping_method && product.shipping_method !== 'standard') {
            switch(product.shipping_method) {
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = '<span class="badge bg-secondary">Outros</span>';
            }
        }
        
        // Informações de reputação - usar a mesma lógica da função original
        let reputationInfo = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationInfo = '<span class="badge bg-success">🟢 Verde</span>';
                    break;
                case "YELLOW":
                    reputationInfo = '<span class="badge bg-warning">🟡 Amarelo</span>';
                    break;
                case "RED":
                    reputationInfo = '<span class="badge bg-danger">🔴 Vermelho</span>';
                    break;
                default:
                    reputationInfo = '<span class="badge bg-secondary">⚪ Neutro</span>';
                    break;
            }
        } else {
            reputationInfo = '<span class="badge bg-light text-dark">❓ Desconhecida</span>';
        }
        
        // Loja oficial - usar a mesma lógica da função original
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">Não</span>';
        
        // Usar exatamente a mesma estrutura HTML da função original
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                            ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                                `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                            <small class="text-muted d-block">${product.ml_item_id}</small>
                        </div>
                    </div>
                </td>
                <td><strong>${priceFormatted}</strong></td>
                <td>${product.seller_transactions_total > 0 ? 
                    `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
                    '<span class="badge bg-secondary">0</span>'}</td>
                <td>${product.buy_box_winner ? 
                    '<span class="badge bg-success">🏆 Vencedor</span>' : 
                    (product.position === 1 ? 
                        '<span class="badge bg-success">🥇 1º Lugar</span>' : 
                        (product.position === 2 ? 
                            '<span class="badge bg-secondary">🥈 2º Lugar</span>' : 
                            (product.position === 3 ? 
                                '<span class="badge bg-warning">🥉 3º Lugar</span>' : 
                                `<span class="badge bg-light text-dark">#${product.position}</span>`)))}</td>
                <td>${shippingInfo}</td>
                <td>${reputationInfo}</td>
                <td>${lojaOficialBadge}</td>
                <td>${(product.original_price && product.original_price > product.price) ? 
                    `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
                    ''}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm"
                       title="Ver anúncio"
                       onclick="console.log('Clicando em: ${product.permalink}')">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    // Apenas substituir o conteúdo do tbody, mantendo toda a estrutura da tabela
    tbody.innerHTML = html;
    
    console.log('✅ Tabela filtrada renderizada com sucesso');
}

function loadShippingCosts(product) {
    // Simular carregamento de custos de envio
    setTimeout(() => {
        const shippingContainer = document.getElementById('catalog-shipping-content');
        if (shippingContainer) {
            shippingContainer.innerHTML = `
            <div class="mb-3">
                <label class="form-label">CEP de Destino:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="destination-zip" placeholder="00000-000">
                    <button class="btn btn-outline-primary" onclick="calculateShipping()">
                        <i class="bi bi-calculator"></i> Calcular
                    </button>
                </div>
            </div>
            <div id="shipping-results" class="d-none">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Selecione um CEP para calcular os custos de envio.
                </div>
            </div>
        `;
        }
    }, 1500);
}

function calculateShipping() {
    const zipCode = document.getElementById('destination-zip').value;
    if (!zipCode) {
        alert('Por favor, digite um CEP válido');
        return;
    }
    
    const productId = window.location.pathname.split('/').pop();
    const resultsContainer = document.getElementById('shipping-results');
    
    // Mostrar loading
    resultsContainer.classList.remove('d-none');
    resultsContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Calculando...</span>
            </div>
            <p class="mt-2 mb-0">Calculando custos de envio...</p>
        </div>
    `;
    
    // Buscar opções de envio reais
    fetch(`/ml/products/api/product/${productId}/shipping?zip_code=${zipCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.shipping.success) {
                renderShippingOptions(data.shipping.data, zipCode);
            } else {
                showShippingError(data.shipping?.error || 'Erro ao calcular envio');
            }
        })
        .catch(error => {
            console.error('Erro ao calcular envio:', error);
            showShippingError('Erro de conexão');
        });
}

function renderShippingOptions(shippingData, zipCode) {
    const resultsContainer = document.getElementById('shipping-results');
    
    if (!shippingData.options || shippingData.options.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Nenhuma opção de envio encontrada para o CEP ${zipCode}.
            </div>
        `;
        return;
    }
    
    let optionsHtml = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Opções de envio para CEP ${zipCode}</strong>
        </div>
        <div class="row">
    `;
    
    shippingData.options.forEach(option => {
        const cost = option.cost || 0;
        const listCost = option.list_cost || 0;
        const name = option.name || 'Opção de Envio';
        const isFree = cost === 0;
        
        optionsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${name}</h6>
                        <div class="d-flex justify-content-between">
                            <span>Custo:</span>
                            <strong class="${isFree ? 'text-success' : 'text-primary'}">
                                ${isFree ? 'GRÁTIS' : formatPrice(cost)}
                            </strong>
                        </div>
                        ${listCost > 0 ? `
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Custo original:</small>
                                <small class="text-muted">${formatPrice(listCost)}</small>
                            </div>
                        ` : ''}
                        ${option.estimated_delivery_time ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i>
                                    Entrega: ${option.estimated_delivery_time.shipping || 'N/A'}h
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    optionsHtml += '</div>';
    resultsContainer.innerHTML = optionsHtml;
}

function showShippingError(message) {
    const resultsContainer = document.getElementById('shipping-results');
    resultsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao calcular envio:</strong> ${message}
        </div>
    `;
}

function showError(message) {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.remove('d-none');
    document.getElementById('error-message').textContent = message;
}

function formatPrice(price, currency = 'BRL') {
    // Converter para número
    const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
    
    // Se não for um número válido, retornar R$ 0,00
    if (isNaN(numericPrice) || numericPrice === null || numericPrice === undefined) {
        return 'R$ 0,00';
    }
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericPrice);
}

// Função para sincronizar catálogo
// Sales Analysis Functions
function loadSalesAnalysis(product) {
    console.log('📊 Carregando análise de vendas para produto:', product);
    
    // Carregar análise do produto (aba ativa por padrão)
    loadProductSalesAnalysis(product);
    
    // Configurar eventos das abas
    setupSalesAnalysisTabs(product);
}

function setupSalesAnalysisTabs(product) {
    // Event listener para aba "Análise do Produto"
    document.getElementById('product-analysis-tab').addEventListener('click', function() {
        loadProductSalesAnalysis(product);
    });
    
    // Event listener para aba "Vendas pelo SKU"
    document.getElementById('sku-sales-tab').addEventListener('click', function() {
        loadSkuSalesAnalysis(product);
    });
}

async function loadProductSalesAnalysis(product) {
    console.log('📦 Carregando análise do produto:', product);
    
    const contentContainer = document.getElementById('product-analysis-content');
    
    try {
        // Mostrar loading
        contentContainer.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 mb-0">Carregando análise do produto...</p>
            </div>
        `;
        
        // Buscar dados de vendas por ML item ID e company_id
        const response = await fetch(`/api/sales/analysis/product/${product.ml_item_id}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 Dados de análise do produto recebidos:', data);
        
        renderProductSalesAnalysis(data, product);
        
    } catch (error) {
        console.error('❌ Erro ao carregar análise do produto:', error);
        contentContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar análise do produto:</strong><br>
                ${error.message}
            </div>
        `;
    }
}

async function loadSkuSalesAnalysis(product) {
    console.log('📈 Carregando vendas por SKU:', product);
    
    const contentContainer = document.getElementById('sku-sales-content');
    
    // Verificar se o produto tem SKU
    const sku = product.seller_custom_field || product.sku || product.seller_sku;
    
    if (!sku) {
        contentContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Produto sem SKU associado</strong><br>
                Este produto não possui SKU configurado para análise de vendas.
            </div>
        `;
        return;
    }
    
    try {
        // Mostrar loading
        contentContainer.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 mb-0">Carregando vendas por SKU...</p>
            </div>
        `;
        
        // Buscar dados de vendas por SKU e company_id
        const response = await fetch(`/api/sales/analysis/sku/${encodeURIComponent(sku)}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('📊 Dados de vendas por SKU recebidos:', data);
        
        renderSkuSalesAnalysis(data, sku);
        
    } catch (error) {
        console.error('❌ Erro ao carregar vendas por SKU:', error);
        contentContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar vendas por SKU:</strong><br>
                ${error.message}
            </div>
        `;
    }
}

function renderProductSalesAnalysis(data, product) {
    console.log('🎨 Renderizando análise do produto:', data);
    
    const contentContainer = document.getElementById('product-analysis-content');
    
    if (!data || !data.success) {
        contentContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i>
                <strong>Nenhum dado encontrado</strong><br>
                Não foram encontrados dados de vendas para este produto.
            </div>
        `;
        return;
    }
    
    const analysis = data.analysis || {};
    const stats = analysis.stats || {};
    
    contentContainer.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Estatísticas Gerais</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary mb-0">${stats.total_orders || 0}</h4>
                                    <small class="text-muted">Total de Pedidos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success mb-0">${stats.total_quantity || 0}</h4>
                                <small class="text-muted">Quantidade Vendida</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-12">
                                <h4 class="text-warning mb-0">R$ ${(stats.total_revenue || 0).toFixed(2)}</h4>
                                <small class="text-muted">Receita Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Preços</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h5 class="text-success mb-0">R$ ${(stats.avg_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Preço Médio</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-info mb-0">R$ ${(stats.min_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Preço Mínimo</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger mb-0">R$ ${(stats.max_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Preço Máximo</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Últimos Pedidos</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Comprador</th>
                                        <th>Preço</th>
                                        <th>Qtd</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(analysis.recent_orders || []).map(order => `
                                        <tr>
                                            <td>${new Date(order.date_created).toLocaleDateString('pt-BR')}</td>
                                            <td>${order.buyer_nickname || 'N/A'}</td>
                                            <td>R$ ${order.unit_price.toFixed(2)}</td>
                                            <td>${order.quantity}</td>
                                            <td><span class="badge ${order.status === 'PAID' ? 'bg-success' : 'bg-warning'}">${order.status}</span></td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="5" class="text-center text-muted">Nenhum pedido encontrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderSkuSalesAnalysis(data, sku) {
    console.log('🎨 Renderizando vendas por SKU:', data);
    
    const contentContainer = document.getElementById('sku-sales-content');
    
    if (!data || !data.success) {
        contentContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i>
                <strong>Nenhum dado encontrado</strong><br>
                Não foram encontrados dados de vendas para o SKU "${sku}".
            </div>
        `;
        return;
    }
    
    const analysis = data.analysis || {};
    const stats = analysis.stats || {};
    
    contentContainer.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>SKU Analisado:</strong> ${sku}
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Estatísticas por SKU</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary mb-0">${stats.total_orders || 0}</h4>
                                    <small class="text-muted">Total de Pedidos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success mb-0">${stats.total_quantity || 0}</h4>
                                <small class="text-muted">Quantidade Vendida</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-12">
                                <h4 class="text-warning mb-0">R$ ${(stats.total_revenue || 0).toFixed(2)}</h4>
                                <small class="text-muted">Receita Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Análise de Preços</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h5 class="text-success mb-0">R$ ${(stats.avg_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Preço Médio</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-info mb-0">R$ ${(stats.min_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Preço Mínimo</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger mb-0">R$ ${(stats.max_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Preço Máximo</small>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <h6 class="text-muted">Status dos Pedidos</h6>
                            <div class="d-flex justify-content-around">
                                <span class="badge bg-success">${stats.paid_orders || 0} PAGOS</span>
                                <span class="badge bg-warning">${stats.cancelled_orders || 0} CANCELADOS</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Histórico de Vendas</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>ID do Pedido</th>
                                        <th>Comprador</th>
                                        <th>Preço Unit.</th>
                                        <th>Qtd</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(analysis.orders || []).map(order => `
                                        <tr>
                                            <td>${new Date(order.date_created).toLocaleDateString('pt-BR')}</td>
                                            <td><small class="text-muted">${order.ml_order_id}</small></td>
                                            <td>${order.buyer_nickname || 'N/A'}</td>
                                            <td>R$ ${order.unit_price.toFixed(2)}</td>
                                            <td>${order.quantity}</td>
                                            <td>R$ ${(order.unit_price * order.quantity).toFixed(2)}</td>
                                            <td><span class="badge ${order.status === 'PAID' ? 'bg-success' : 'bg-warning'}">${order.status}</span></td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="7" class="text-center text-muted">Nenhum pedido encontrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function syncCatalog() {
    console.log('syncCatalog chamada');
    const productId = window.location.pathname.split('/').pop();
    const syncBtn = document.getElementById('sync-catalog-btn');
    
    if (!syncBtn) {
        console.error('Botão sync-catalog-btn não encontrado!');
        return;
    }
    
    const originalText = syncBtn.innerHTML;
    
    // Mostrar loading
    syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Sincronizando...';
    syncBtn.disabled = true;
    
    fetch(`/ml/products/api/product/${productId}/catalog/sync`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (handleSessionError(null, data)) return;
        if (data.success) {
            // Mostrar sucesso
            syncBtn.innerHTML = '<i class="bi bi-check-circle"></i> Sincronizado!';
            syncBtn.classList.remove('btn-outline-success');
            syncBtn.classList.add('btn-success');
            
            // Recarregar dados do catálogo do banco
            setTimeout(() => {
                loadCatalogInfo(productId);
            }, 1000);
            
            // Restaurar botão após 3 segundos
            setTimeout(() => {
                syncBtn.innerHTML = originalText;
                syncBtn.classList.remove('btn-success');
                syncBtn.classList.add('btn-outline-success');
                syncBtn.disabled = false;
            }, 3000);
        } else {
            throw new Error(data.error || 'Erro na sincronização');
        }
    })
    .catch(error => {
        console.error('Erro ao sincronizar catálogo:', error);
        syncBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erro';
        syncBtn.classList.remove('btn-outline-success');
        syncBtn.classList.add('btn-danger');
        
        // Restaurar botão após 3 segundos
        setTimeout(() => {
            syncBtn.innerHTML = originalText;
            syncBtn.classList.remove('btn-danger');
            syncBtn.classList.add('btn-outline-success');
            syncBtn.disabled = false;
        }, 3000);
    });
}

// Função global para tratar erros de sessão
function handleSessionError(response, data) {
    if (response && response.status === 401) {
        // Sessão expirada - redirecionar para login
        window.location.href = '/auth/login';
        return true;
    }
    if (data && data.detail === "Sessão não encontrada") {
        // Sessão inválida - redirecionar para login
        window.location.href = '/auth/login';
        return true;
    }
    return false;
}

// CSS para animação de loading
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

</script>
{% endblock %}