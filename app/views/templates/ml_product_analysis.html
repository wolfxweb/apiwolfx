{% extends "base.html" %}

{% block title %}An√°lise do Produto - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-calculator text-success"></i>
                        An√°lise do Produto
                    </h1>
                    <p class="text-muted mb-0">An√°lise completa de custos e rentabilidade</p>
                </div>
                <div>
                    <a href="/ml/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar aos Produtos
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">Carregando an√°lise do produto...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="alert alert-danger d-none">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar an√°lise:</strong>
                <span id="error-message"></span>
            </div>

            <!-- Analysis Content -->
            <div id="analysis-content" class="d-none">
                <!-- Product Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-box"></i> Informa√ß√µes do Produto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img id="product-thumbnail" src="" alt="Produto" class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h4 id="product-title" class="mb-2"></h4>
                                <p id="product-description" class="text-muted mb-3"></p>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>ID:</strong> <span id="product-ml-id"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Pre√ßo:</strong> <div id="product-price"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Status:</strong> <span id="product-status"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="row">
                    <!-- Marketplace Fees -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-percent"></i> Taxas do Mercado Livre
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="marketplace-fees">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando taxas...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profitability Analysis -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> An√°lise de Rentabilidade
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="profitability-analysis">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando rentabilidade...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

       <!-- An√°lise Card -->
       <div class="col-md-12 mb-4">
           <div class="card h-100">
               <div class="card-header bg-primary text-white">
                   <h5 class="mb-0">
                       <i class="bi bi-graph-up"></i> An√°lise Competitiva
                   </h5>
               </div>
               <div class="card-body">
                   <div id="catalog-analysis-content">
                       <div class="text-center py-3">
                           <div class="spinner-border spinner-border-sm" role="status">
                               <span class="visually-hidden">Carregando...</span>
                           </div>
                           <p class="mt-2 mb-0">Analisando dados...</p>
                       </div>
                   </div>
               </div>
           </div>
       </div>


        <!-- Catalog Information -->
        <div class="col-md-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0" id="catalog-shipping-header">
                        <i class="bi bi-truck"></i> Custos de Envio
                    </h5>
                </div>
                <div class="card-body">
                    <div id="catalog-shipping-content">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 mb-0">Verificando informa√ß√µes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                </div>


                <!-- Recommendations -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="bi bi-lightbulb"></i> Recomenda√ß√µes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="recommendations">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Gerando recomenda√ß√µes...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const productId = window.location.pathname.split('/').pop();
    loadProductAnalysis(productId);
});

function loadProductAnalysis(productId) {
    // Mostrar loading
    document.getElementById('loading-state').classList.remove('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.add('d-none');

    // Carregar dados do produto
    fetch(`/ml/products/api/product/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderProductInfo(data.product);
                loadMarketplaceFees(data.product);
                checkCatalogInfo(data.product);
                loadCompetitiveAnalysis(data.product.id);
                loadProfitabilityAnalysis(data.product);
                loadRecommendations(data.product);
                
                // Mostrar conte√∫do
                document.getElementById('loading-state').classList.add('d-none');
                document.getElementById('analysis-content').classList.remove('d-none');
            } else {
                showError(data.error || 'Erro ao carregar produto');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showError('Erro ao carregar an√°lise do produto');
        });
}

function renderProductInfo(product) {
    document.getElementById('product-thumbnail').src = product.thumbnail || '/static/images/no-image.png';
    document.getElementById('product-title').textContent = product.title;
    document.getElementById('product-description').textContent = product.subtitle || 'Sem descri√ß√£o';
    document.getElementById('product-ml-id').textContent = product.ml_item_id;
    document.getElementById('product-price').innerHTML = formatProductPriceForAnalysis(product);
    document.getElementById('product-status').innerHTML = getStatusBadge(product.status);
}

function loadMarketplaceFees(product) {
    const feesContainer = document.getElementById('marketplace-fees');
    
    // Buscar taxas reais da API
    fetch(`/ml/products/api/product/${product.id}/fees`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.fees.success) {
                const fees = data.fees.data;
                renderMarketplaceFees(fees);
            } else {
                showFeesError(data.fees?.error || 'Erro ao carregar taxas');
            }
        })
        .catch(error => {
            console.error('Erro ao buscar taxas:', error);
            showFeesError('Erro de conex√£o');
        });
}

           function renderMarketplaceFees(fees) {
               const feesContainer = document.getElementById('marketplace-fees');
               
               if (!fees || (Array.isArray(fees) && fees.length === 0)) {
                   feesContainer.innerHTML = `
                       <div class="alert alert-warning">
                           <i class="bi bi-exclamation-triangle"></i>
                           Nenhuma taxa encontrada para este produto.
                       </div>
                   `;
                   return;
               }
               
               // Se fees √© um array, mostrar compara√ß√£o entre tipos de an√∫ncio
               // Se fees √© um objeto, usar diretamente
               if (Array.isArray(fees)) {
                   renderMultipleListingTypes(fees);
               } else {
                   renderSingleListingType(fees);
               }
           }
           
           function renderSingleListingType(fee) {
               const feesContainer = document.getElementById('marketplace-fees');
               const calculatedFees = fee.calculated_fees || {};
               const saleFeeDetails = fee.sale_fee_details || {};
               const shippingInfo = fee.shipping_info || {};
               
               // Buscar pre√ßo do produto
               const productPrice = parseFloat(document.getElementById('product-price').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
               
               feesContainer.innerHTML = `
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-tag"></i> ${fee.listing_type_name || 'Tipo de An√∫ncio'}
                       </h6>
                       <div class="d-flex justify-content-between">
                           <span>Taxa de Publica√ß√£o:</span>
                           <strong class="${(fee.listing_fee_amount || 0) === 0 ? 'text-success' : 'text-primary'}">
                               ${formatPrice(fee.listing_fee_amount || 0)}
                           </strong>
                       </div>
                       <small class="text-muted">
                           Exposi√ß√£o: ${fee.listing_exposure || 'N/A'}
                       </small>
                   </div>
                   
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-cart-check"></i> Taxa de Venda
                       </h6>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Taxa Fixa:</span>
                           <span class="text-primary">${formatPrice(calculatedFees.fixed_fee_amount || 0)}</span>
                       </div>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Comiss√£o ML (${saleFeeDetails.percentage_fee || 0}%):</span>
                           <span class="text-primary">${formatPrice(calculatedFees.percentage_fee_amount || 0)}</span>
                       </div>
                       
                       ${saleFeeDetails.financing_add_on_fee > 0 ? `
                           <div class="d-flex justify-content-between mb-1">
                               <span class="text-muted">Taxa de Financiamento (${saleFeeDetails.financing_add_on_fee}%):</span>
                               <span class="text-primary">${formatPrice(calculatedFees.financing_fee_amount || 0)}</span>
                           </div>
                       ` : ''}
                       
                       <hr class="my-2">
                       <div class="d-flex justify-content-between fw-bold">
                           <span>Subtotal Taxa de Venda:</span>
                           <span class="text-primary">${formatPrice(calculatedFees.total_sale_fees || 0)}</span>
                       </div>
                   </div>
                   
                   <div class="mb-3">
                       <h6 class="text-primary mb-2">
                           <i class="bi bi-truck"></i> Frete
                       </h6>
                       <div class="d-flex justify-content-between mb-1">
                           <span>Frete:</span>
                           <strong class="${shippingInfo.free_shipping ? 'text-success' : 'text-primary'}">
                               ${shippingInfo.free_shipping ? 'GR√ÅTIS (R$ 0,00)' : formatPrice(calculatedFees.shipping_cost || 0)}
                           </strong>
                       </div>
                       
                       <div class="d-flex justify-content-between mb-1">
                           <span class="text-muted">Tipo Log√≠stico:</span>
                           <span class="text-info">${shippingInfo.logistic_type || 'N/A'}</span>
                       </div>
                   </div>
                   
                   <hr class="my-3">
                   <div class="d-flex justify-content-between fw-bold fs-5">
                       <span class="text-dark">TOTAL DE CUSTOS:</span>
                       <span class="text-danger">${formatPrice(calculatedFees.total_cost_with_shipping || 0)}</span>
                   </div>
                   
                   <div class="mt-3">
                       <div class="row text-center">
                           <div class="col-6">
                               <small class="text-muted">Margem de Lucro</small>
                               <div class="fw-bold ${(calculatedFees.profit_margin_percentage || 0) >= 20 ? 'text-success' : (calculatedFees.profit_margin_percentage || 0) >= 10 ? 'text-warning' : 'text-danger'}">
                                   ${(calculatedFees.profit_margin_percentage || 0).toFixed(1)}%
                               </div>
                           </div>
                           <div class="col-6">
                               <small class="text-muted">Lucro L√≠quido</small>
                               <div class="fw-bold ${(calculatedFees.net_profit || 0) > 0 ? 'text-success' : 'text-danger'}">
                                   ${formatPrice(calculatedFees.net_profit || 0)}
                               </div>
                           </div>
                       </div>
                   </div>
               `;
           }
           
           function renderMultipleListingTypes(fees) {
               const feesContainer = document.getElementById('marketplace-fees');
               const productPrice = parseFloat(document.getElementById('product-price').textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
               
               let html = '<h6 class="text-primary mb-3"><i class="bi bi-bar-chart"></i> Compara√ß√£o de Tipos de An√∫ncio</h6>';
               
               // Ordenar por custo total crescente
               fees.sort((a, b) => {
                   const costA = (a.calculated_fees?.total_cost_with_shipping || 0);
                   const costB = (b.calculated_fees?.total_cost_with_shipping || 0);
                   return costA - costB;
               });
               
               fees.forEach((fee, index) => {
                   const calculatedFees = fee.calculated_fees || {};
                   const shippingInfo = fee.shipping_info || {};
                   const isBestOption = index === 0;
                   
                   html += `
                       <div class="card mb-2 ${isBestOption ? 'border-success' : ''}">
                           <div class="card-body py-2">
                               <div class="d-flex justify-content-between align-items-center">
                                   <div>
                                       <h6 class="mb-0 ${isBestOption ? 'text-success' : ''}">
                                           ${fee.listing_type_name || 'N/A'}
                                           ${isBestOption ? '<i class="bi bi-star-fill text-warning ms-1"></i>' : ''}
                                       </h6>
                                       <small class="text-muted">${fee.listing_exposure || 'N/A'} ‚Ä¢ ${fee.requires_picture ? 'Com foto' : 'Sem foto'}</small>
                                   </div>
                                   <div class="text-end">
                                       <div class="fw-bold ${isBestOption ? 'text-success' : 'text-primary'}">
                                           ${formatPrice(calculatedFees.total_cost_with_shipping || 0)}
                                       </div>
                                       <small class="text-muted">
                                           Lucro: ${formatPrice(calculatedFees.net_profit || 0)}
                                           (${(calculatedFees.profit_margin_percentage || 0).toFixed(1)}%)
                                       </small>
                                   </div>
                               </div>
                           </div>
                       </div>
                   `;
               });
               
               // Adicionar resumo
               const bestOption = fees[0];
               const worstOption = fees[fees.length - 1];
               const bestFees = bestOption.calculated_fees || {};
               const worstFees = worstOption.calculated_fees || {};
               
               html += `
                   <div class="mt-3 p-3 bg-light rounded">
                       <h6 class="text-success mb-2">
                           <i class="bi bi-lightbulb"></i> Recomenda√ß√£o
                       </h6>
                       <p class="mb-1">
                           <strong>Melhor op√ß√£o:</strong> ${bestOption.listing_type_name} 
                           - Custo total: ${formatPrice(bestFees.total_cost_with_shipping || 0)}
                           - Lucro: ${formatPrice(bestFees.net_profit || 0)}
                       </p>
                       <p class="mb-0">
                           <strong>Economia:</strong> ${formatPrice((worstFees.total_cost_with_shipping || 0) - (bestFees.total_cost_with_shipping || 0))} 
                           comparado ao ${worstOption.listing_type_name}
                       </p>
                   </div>
               `;
               
               feesContainer.innerHTML = html;
           }

function showFeesError(message) {
    const feesContainer = document.getElementById('marketplace-fees');
    feesContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao carregar taxas:</strong> ${message}
        </div>
    `;
}

function loadShippingCosts(product) {
    // Simular carregamento de custos de envio
    setTimeout(() => {
        const shippingContainer = document.getElementById('shipping-costs');
        shippingContainer.innerHTML = `
            <div class="mb-3">
                <label class="form-label">CEP de Destino:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="destination-zip" placeholder="00000-000">
                    <button class="btn btn-outline-primary" onclick="calculateShipping()">
                        <i class="bi bi-calculator"></i> Calcular
                    </button>
                </div>
            </div>
            <div id="shipping-results" class="d-none">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Selecione um CEP para calcular os custos de envio.
                </div>
            </div>
        `;
    }, 1500);
}

function loadProfitabilityAnalysis(product) {
    // Aguardar que as taxas sejam carregadas primeiro
    setTimeout(() => {
        const profitabilityContainer = document.getElementById('profitability-analysis');
        const productPrice = parseFloat(product.price) || 0;
        
        // Tentar obter os custos das taxas j√° calculadas
        const feesContainer = document.getElementById('marketplace-fees');
        let totalFees = 0;
        let profitMargin = 0;
        let roi = 0;
        
        // Extrair custos totais se j√° estiverem calculados
        const totalCostsElement = feesContainer.querySelector('[class*="total-cost"]') || 
                                  Array.from(feesContainer.querySelectorAll('*')).find(el => el.textContent.includes('TOTAL DE CUSTOS'));
        
        if (totalCostsElement) {
            const costText = totalCostsElement.textContent;
            const costMatch = costText.match(/R\$\s*([0-9,]+\.?[0-9]*)/);
            if (costMatch) {
                totalFees = parseFloat(costMatch[1].replace(',', '.'));
            }
        }
        
        // Se n√£o encontrou os custos, usar valor padr√£o baseado no produto
        if (totalFees === 0) {
            // Estimativa baseada no pre√ßo (taxa m√©dia do Mercado Livre ~15%)
            totalFees = productPrice * 0.15;
        }
        
        const netProfit = productPrice - totalFees;
        profitMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
        roi = totalFees > 0 ? (netProfit / totalFees) * 100 : 0;
        
        profitabilityContainer.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Pre√ßo de Venda</h6>
                        <h4 class="text-primary">${formatPrice(productPrice)}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Custos Totais</h6>
                        <h4 class="text-danger">${formatPrice(totalFees)}</h4>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-3 border rounded">
                        <h6 class="text-muted">Lucro L√≠quido</h6>
                        <h4 class="text-success">${formatPrice(netProfit)}</h4>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span>Margem de Lucro:</span>
                        <strong class="${profitMargin >= 20 ? 'text-success' : profitMargin >= 10 ? 'text-warning' : 'text-danger'}">
                            ${profitMargin.toFixed(1)}%
                        </strong>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between">
                        <span>ROI:</span>
                        <strong class="${roi >= 50 ? 'text-success' : roi >= 25 ? 'text-warning' : 'text-danger'}">
                            ${roi.toFixed(1)}%
                        </strong>
                    </div>
                </div>
            </div>
        `;
    }, 3000); // Aumentar tempo para aguardar c√°lculo das taxas
}

function loadRecommendations(product) {
    // Simular carregamento de recomenda√ß√µes
    setTimeout(() => {
        const recommendationsContainer = document.getElementById('recommendations');
        recommendationsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-lightbulb"></i>
                <strong>Recomenda√ß√£o:</strong> Este produto tem boa rentabilidade. 
                Considere aumentar o pre√ßo em 10% para maximizar o lucro.
            </div>
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Aten√ß√£o:</strong> Monitore os custos de envio para diferentes regi√µes.
            </div>
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i>
                <strong>Oportunidade:</strong> Produto com boa demanda. 
                Considere investir em an√∫ncios premium.
            </div>
        `;
    }, 2500);
}

function calculateShipping() {
    const zipCode = document.getElementById('destination-zip').value;
    if (!zipCode) {
        alert('Por favor, digite um CEP v√°lido');
        return;
    }
    
    const productId = window.location.pathname.split('/').pop();
    const resultsContainer = document.getElementById('shipping-results');
    
    // Mostrar loading
    resultsContainer.classList.remove('d-none');
    resultsContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Calculando...</span>
            </div>
            <p class="mt-2 mb-0">Calculando custos de envio...</p>
        </div>
    `;
    
    // Buscar op√ß√µes de envio reais
    fetch(`/ml/products/api/product/${productId}/shipping?zip_code=${zipCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.shipping.success) {
                renderShippingOptions(data.shipping.data, zipCode);
            } else {
                showShippingError(data.shipping?.error || 'Erro ao calcular envio');
            }
        })
        .catch(error => {
            console.error('Erro ao calcular envio:', error);
            showShippingError('Erro de conex√£o');
        });
}

function renderShippingOptions(shippingData, zipCode) {
    const resultsContainer = document.getElementById('shipping-results');
    
    if (!shippingData.options || shippingData.options.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Nenhuma op√ß√£o de envio encontrada para o CEP ${zipCode}.
            </div>
        `;
        return;
    }
    
    let optionsHtml = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Op√ß√µes de envio para CEP ${zipCode}</strong>
        </div>
        <div class="row">
    `;
    
    shippingData.options.forEach(option => {
        const cost = option.cost || 0;
        const listCost = option.list_cost || 0;
        const name = option.name || 'Op√ß√£o de Envio';
        const isFree = cost === 0;
        
        optionsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${name}</h6>
                        <div class="d-flex justify-content-between">
                            <span>Custo:</span>
                            <strong class="${isFree ? 'text-success' : 'text-primary'}">
                                ${isFree ? 'GR√ÅTIS' : formatPrice(cost)}
                            </strong>
                        </div>
                        ${listCost > 0 ? `
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Custo original:</small>
                                <small class="text-muted">${formatPrice(listCost)}</small>
                            </div>
                        ` : ''}
                        ${option.estimated_delivery_time ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i>
                                    Entrega: ${option.estimated_delivery_time.shipping || 'N/A'}h
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    optionsHtml += '</div>';
    resultsContainer.innerHTML = optionsHtml;
}

function showShippingError(message) {
    const resultsContainer = document.getElementById('shipping-results');
    resultsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao calcular envio:</strong> ${message}
        </div>
    `;
}

function showError(message) {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.remove('d-none');
    document.getElementById('error-message').textContent = message;
}

function formatPrice(price, currency = 'BRL') {
    // Converter para n√∫mero
    const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
    
    // Se n√£o for um n√∫mero v√°lido, retornar R$ 0,00
    if (isNaN(numericPrice) || numericPrice === null || numericPrice === undefined) {
        return 'R$ 0,00';
    }
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericPrice);
}

function formatProductPriceForAnalysis(product) {
    if (!product.price) return '<span class="text-muted">N/A</span>';
    
    const currentPrice = parseFloat(product.price);
    const originalPrice = product.original_price ? parseFloat(product.original_price) : null;
    const basePrice = product.base_price ? parseFloat(product.base_price) : null;
    
    // Se h√° pre√ßo original e √© diferente do pre√ßo atual, mostrar desconto
    if (originalPrice && originalPrice > currentPrice && originalPrice > 0) {
        const discountPercent = Math.round(((originalPrice - currentPrice) / originalPrice) * 100);
        
        return `
            <div class="d-flex flex-column">
                <div class="text-success fw-bold">
                    ${formatPrice(currentPrice, product.currency_id)}
                </div>
                <div class="text-decoration-line-through text-muted small">
                    ${formatPrice(originalPrice, product.currency_id)}
                </div>
                <div class="badge bg-danger small">
                    -${discountPercent}%
                </div>
            </div>
        `;
    }
    
    // Se h√° base_price diferente do pre√ßo atual, mostrar promo√ß√£o
    if (basePrice && basePrice > currentPrice && basePrice > 0) {
        const discountPercent = Math.round(((basePrice - currentPrice) / basePrice) * 100);
        
        return `
            <div class="d-flex flex-column">
                <div class="text-success fw-bold">
                    ${formatPrice(currentPrice, product.currency_id)}
                </div>
                <div class="text-decoration-line-through text-muted small">
                    ${formatPrice(basePrice, product.currency_id)}
                </div>
                <div class="badge bg-warning text-dark small">
                    -${discountPercent}%
                </div>
            </div>
        `;
    }
    
    // Pre√ßo normal sem desconto
    return `
        <div class="text-primary fw-bold">
            ${formatPrice(currentPrice, product.currency_id)}
        </div>
    `;
}

function getStatusBadge(status) {
    const statusMap = {
        'active': '<span class="badge bg-success">Ativo</span>',
        'paused': '<span class="badge bg-warning">Pausado</span>',
        'closed': '<span class="badge bg-danger">Fechado</span>',
        'under_review': '<span class="badge bg-info">Em Revis√£o</span>',
        'inactive': '<span class="badge bg-secondary">Inativo</span>'
    };
    return statusMap[status] || '<span class="badge bg-secondary">Desconhecido</span>';
}

function checkCatalogInfo(product) {
    // Verificar se o produto √© de cat√°logo
    if (product.catalog_listing) {
        loadCatalogInfo(product.id);
    } else {
        loadShippingCosts(product);
    }
}

function loadCatalogInfo(productId) {
    // Atualizar header
    document.getElementById('catalog-shipping-header').innerHTML = `
        <i class="bi bi-collection"></i> Informa√ß√µes de Cat√°logo
    `;
    
    // Primeiro tenta buscar do banco de dados
    fetch(`/ml/products/api/product/${productId}/catalog/database`)
        .then(response => response.json())
        .then(data => {
            if (handleSessionError(null, data)) return;
            if (data.success && data.is_catalog && data.catalog_products.length > 0) {
                // Mostrar dados do banco com data da √∫ltima atualiza√ß√£o
                renderCatalogInfo(data);
            } else {
                // Se n√£o tem dados no banco, mostrar mensagem para sincronizar
                const container = document.getElementById('catalog-shipping-content');
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle fs-1"></i>
                        <h5 class="mt-3">Nenhum Dado Sincronizado</h5>
                        <p>Este cat√°logo ainda n√£o foi sincronizado com o banco de dados.</p>
                        <p>Clique em "Sincronizar Cat√°logo" para importar os dados.</p>
                        <button type="button" class="btn btn-success" onclick="syncCatalog()" id="sync-catalog-btn">
                            <i class="bi bi-arrow-clockwise"></i> Sincronizar Cat√°logo
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar informa√ß√µes de cat√°logo do banco:', error);
            // Mostrar mensagem de erro
            const container = document.getElementById('catalog-shipping-content');
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <h5 class="mt-3">Erro ao Carregar Dados</h5>
                    <p>N√£o foi poss√≠vel carregar os dados do cat√°logo do banco de dados.</p>
                    <p>Verifique sua conex√£o e tente novamente.</p>
                    <button type="button" class="btn btn-primary" onclick="loadCatalogInfo(${productId})">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </div>
            `;
        });
}

function renderCatalogInfo(data, fromDatabase = true) {
    const container = document.getElementById('catalog-shipping-content');
    
    if (data.catalog_products.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Este produto √© de cat√°logo, mas n√£o h√° outros anunciantes encontrados.
            </div>
        `;
        return;
    }
    
    // Ordenar por pre√ßo
    const sortedProducts = data.catalog_products.sort((a, b) => a.price - b.price);
    
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Cat√°logo ID: ${data.catalog_product_id}</h6>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary">${data.total_announcers} Anunciantes</span>
                        ${fromDatabase && data.last_sync ? `
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> √öltima atualiza√ß√£o: ${new Date(data.last_sync).toLocaleString('pt-BR')}
                            </small>
                        ` : ''}
                        ${fromDatabase ? `
                            <span class="badge bg-success">Dados Locais</span>
                        ` : `
                            <span class="badge bg-warning">Dados da API</span>
                        `}
                    </div>
                </div>
                <a href="https://www.mercadolivre.com.br/catalogo/explorar/" 
                   target="_blank" 
                   class="btn btn-outline-primary btn-sm"
                   title="Abrir cat√°logo do Mercado Livre">
                    <i class="bi bi-box-arrow-up-right"></i> Ver Cat√°logo
                </a>
                <button type="button" class="btn btn-outline-success btn-sm ms-2" onclick="syncCatalog()" id="sync-catalog-btn">
                    <i class="bi bi-arrow-clockwise"></i> Sincronizar Cat√°logo
                </button>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-2">
                <label class="form-label small">Posi√ß√£o</label>
                <select class="form-select form-select-sm" id="filter-position" onchange="filterCatalog()">
                    <option value="">Todas</option>
                    <option value="1-5">1¬∫ - 5¬∫</option>
                    <option value="6-10">6¬∫ - 10¬∫</option>
                    <option value="11-20">11¬∫ - 20¬∫</option>
                    <option value="21+">21¬∫+</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Pre√ßo</label>
                <select class="form-select form-select-sm" id="filter-price" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="0-50">At√© R$ 50</option>
                    <option value="50-100">R$ 50 - R$ 100</option>
                    <option value="100+">Acima de R$ 100</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Envio</label>
                <select class="form-select form-select-sm" id="filter-shipping" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="full">Full Mercado Livre</option>
                    <option value="correios">Correios</option>
                    <option value="coleta">Coleta ML</option>
                    <option value="mercado_envios">Mercado Envios</option>
                    <option value="frete_gratis">Frete Gr√°tis</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">MercadoL√≠der</label>
                <select class="form-select form-select-sm" id="filter-mercadolider" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="platinum">Platinum</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="sem_medalha">Sem Medalha</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">&nbsp;</label>
                <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Limpar Filtros
                </button>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Resultados</label>
                <div class="form-control form-control-sm bg-light text-center" id="filter-results">
                    <small class="text-muted">Carregando...</small>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                <th>Anunciante</th>
                <th>Pre√ßo</th>
                <th>Vendas</th>
                <th>Posi√ß√£o</th>
                <th>Envio</th>
                <th>Reputa√ß√£o</th>
                <th>Loja Oficial</th>
                <th>Desconto</th>
                <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    sortedProducts.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informa√ß√µes de envio - usar dados reais da API
        let shippingInfo = "N√£o dispon√≠vel";
        
        // Debug: verificar valores
        console.log('Debug shipping:', {
            shipping_free: product.shipping_free,
            shipping_method: product.shipping_method,
            logistic_type: product.logistic_type,
            shipping_tags: product.shipping_tags
        });
        
        if (product.shipping_free) {
            shippingInfo = '<span class="badge bg-success">Frete Gr√°tis</span>';
        } else if (product.logistic_type && product.logistic_type !== 'default') {
            // Priorizar logistic_type (tipo real de envio)
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = `<span class="badge bg-light text-dark">${product.logistic_type}</span>`;
                    break;
            }
        } else if (product.shipping_method && product.shipping_method !== 'standard') {
            // Fallback para shipping_method (mode da API)
            switch(product.shipping_method) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = `<span class="badge bg-light text-dark">${product.shipping_method}</span>`;
                    break;
            }
        } else {
            // Se n√£o tem informa√ß√µes espec√≠ficas, mostrar "N/A"
            shippingInfo = '<span class="badge bg-light text-dark">N√£o dispon√≠vel</span>';
        }
        
        // Informa√ß√µes de garantia
        let warrantyInfo = product.warranty || "";
        if (warrantyInfo && warrantyInfo !== "N/A" && warrantyInfo.length > 30) {
            warrantyInfo = warrantyInfo.substring(0, 30) + "...";
        } else if (!warrantyInfo || warrantyInfo === "N/A") {
            warrantyInfo = "";
        }
        
        // Tags do produto
        let productTags = "";
        if (product.tags && product.tags.length > 0) {
            const importantTags = product.tags.filter(tag => 
                ['good_quality_picture', 'immediate_payment', 'cart_eligible'].includes(tag)
            );
            if (importantTags.length > 0) {
                // Fun√ß√£o para traduzir tags para portugu√™s
                const translateTag = (tag) => {
                    const translations = {
                        'good_quality_picture': 'Imagem de Qualidade',
                        'immediate_payment': 'Pagamento Imediato',
                        'cart_eligible': 'Eleg√≠vel para Carrinho'
                    };
                    return translations[tag] || tag.replace(/_/g, ' ');
                };
                
                productTags = `<div class="mt-1">${importantTags.map(tag => 
                    `<span class="badge bg-light text-dark me-1">${translateTag(tag)}</span>`
                ).join('')}</div>`;
            }
        }
        
        // Total de vendas do vendedor
        const vendasInfo = product.seller_transactions_total > 0 ? 
            `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
            '<span class="badge bg-secondary">0</span>';
        
        // Informa√ß√µes sobre posi√ß√£o no cat√°logo
        let positionInfo = "";
        if (product.buy_box_winner) {
            positionInfo = '<span class="badge bg-success">üèÜ Vencedor</span>';
        } else if (product.position) {
            if (product.position === 1) {
                positionInfo = '<span class="badge bg-success">ü•á 1¬∫ Lugar</span>';
            } else if (product.position === 2) {
                positionInfo = '<span class="badge bg-secondary">ü•à 2¬∫ Lugar</span>';
            } else if (product.position === 3) {
                positionInfo = '<span class="badge bg-warning">ü•â 3¬∫ Lugar</span>';
            } else {
                positionInfo = `<span class="badge bg-light text-dark">#${product.position}</span>`;
            }
        }
        
        // Reputa√ß√£o do vendedor com medalhas
        let reputationBadge = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationBadge = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "YELLOW":
                    reputationBadge = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "RED":
                    reputationBadge = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                default:
                    reputationBadge = '<span class="badge bg-secondary">‚ö™ Neutro</span>';
                    break;
            }
        } else {
            reputationBadge = '<span class="badge bg-light text-dark">‚ùì Desconhecida</span>';
        }
        
        // N√≠vel de reputa√ß√£o do item (current_level)
        let currentLevelBadge = "";
        if (product.current_level && product.current_level !== "unknown") {
            switch(product.current_level.toLowerCase()) {
                case "green":
                    currentLevelBadge = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "yellow":
                    currentLevelBadge = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "red":
                    currentLevelBadge = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                case "newbie":
                    currentLevelBadge = '<span class="badge bg-info">üÜï Iniciante</span>';
                    break;
                default:
                    currentLevelBadge = `<span class="badge bg-secondary">${product.current_level}</span>`;
                    break;
            }
        } else {
            currentLevelBadge = '<span class="badge bg-light text-dark">‚ùì Desconhecido</span>';
        }
        
        // Medalhas do vendedor
        let sellerMedals = "";
        if (product.seller_power_seller_status) {
            let powerSellerText = "";
            let powerSellerClass = "";
            if (product.seller_power_seller_status === "silver") {
                powerSellerText = "MercadoL√≠der";
                powerSellerClass = "bg-secondary"; // Cinza para Silver
            } else if (product.seller_power_seller_status === "gold") {
                powerSellerText = "MercadoL√≠der Gold";
                powerSellerClass = "bg-warning"; // Amarelo/Dourado para Gold
            } else if (product.seller_power_seller_status === "platinum") {
                powerSellerText = "MercadoL√≠der Platinum";
                powerSellerClass = "bg-info"; // Azul para Platinum
            } else {
                powerSellerText = "MercadoL√≠der";
                powerSellerClass = "bg-secondary"; // Cinza padr√£o
            }
            sellerMedals += `<span class="badge ${powerSellerClass} me-1">${powerSellerText}</span>`;
        }
        if (product.seller_experience && product.seller_experience !== "N/A") {
            let experienceText = product.seller_experience;
            if (product.seller_experience === "ADVANCED") {
                experienceText = "Avan√ßado";
            } else if (product.seller_experience === "INTERMEDIATE") {
                experienceText = "Intermedi√°rio";
            } else if (product.seller_experience === "BEGINNER") {
                experienceText = "Iniciante";
            }
            sellerMedals += `<span class="badge bg-info me-1">${experienceText}</span>`;
        }
        
        // Informa√ß√µes adicionais do vendedor
        let sellerInfo = "";
        if (product.accepts_mercadopago) {
            sellerInfo += '<span class="badge bg-primary me-1">MercadoPago</span>';
        }
        if (product.official_store_id) {
            sellerInfo += '<span class="badge bg-info me-1">Loja Oficial</span>';
        }
        if (product.original_price && product.original_price > product.price) {
            const discount = Math.round(((product.original_price - product.price) / product.original_price) * 100);
            sellerInfo += `<span class="badge bg-success me-1">-${discount}%</span>`;
        }
        
        // Badges individuais para as colunas
        // Debug: verificar official_store_id
        console.log('Debug official_store_id:', {
            official_store_id: product.official_store_id,
            type: typeof product.official_store_id
        });
        
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">N√£o</span>';
            
        const descontoBadge = (product.original_price && product.original_price > product.price) ? 
            `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
            '';
        
        // Badge para quem paga o frete
        let shippingPaidByBadge = '';
        if (product.shipping_paid_by && product.shipping_paid_by !== 'N√£o dispon√≠vel') {
            let badgeClass = 'bg-secondary';
            let icon = 'üë§';
            
            switch(product.shipping_paid_by) {
                case 'Comprador':
                    badgeClass = 'bg-primary';
                    icon = 'üõí';
                    break;
                case 'Vendedor':
                    badgeClass = 'bg-success';
                    icon = 'üè™';
                    break;
                case 'Mercado Livre':
                    badgeClass = 'bg-info';
                    icon = 'üè¢';
                    break;
                case 'Vendedor/Mercado Livre':
                    badgeClass = 'bg-warning';
                    icon = 'ü§ù';
                    break;
                default:
                    badgeClass = 'bg-light text-dark';
                    icon = '‚ùì';
                    break;
            }
            
            shippingPaidByBadge = `<span class="badge ${badgeClass}">${icon} ${product.shipping_paid_by}</span>`;
        } else {
            shippingPaidByBadge = '<span class="badge bg-light text-dark">‚ùì N√£o dispon√≠vel</span>';
        }
        
        // Debug: verificar URL do produto
        console.log(`Produto ${product.ml_item_id}: ${product.permalink}`);
        
        html += `
            <tr>
                <td>
                    <div>
                        <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                        ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                            `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                        <small class="text-muted d-block">${product.ml_item_id}</small>
                        ${sellerMedals ? `<div class="mt-1">${sellerMedals}</div>` : ''}
                        ${productTags}
                    </div>
                </td>
                <td class="fw-bold">${priceFormatted}</td>
                <td>${vendasInfo}</td>
                <td>${positionInfo}</td>
                <td>${shippingInfo}</td>
                <td>${reputationBadge}</td>
                <td>${lojaOficialBadge}</td>
                <td>${descontoBadge}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm" 
                       title="Ver an√∫ncio: ${product.permalink}"
                       onclick="console.log('Clicando em: ${product.permalink}')">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Compara√ß√£o de pre√ßos entre anunciantes do mesmo cat√°logo
            </small>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Armazenar dados originais para filtros
    window.catalogData = data;
    
    // Inicializar contador de resultados
    document.getElementById('filter-results').innerHTML = `<small class="text-muted">${data.catalog_products.length} resultados</small>`;
}

// Fun√ß√£o para filtrar cat√°logo
async function filterCatalog() {
    const positionFilter = document.getElementById('filter-position').value;
    const priceFilter = document.getElementById('filter-price').value;
    const shippingFilter = document.getElementById('filter-shipping').value;
    const mercadoliderFilter = document.getElementById('filter-mercadolider').value;
    
    // Construir URL com par√¢metros de filtro
    const currentPath = window.location.pathname;
    const productId = currentPath.split('/').pop();
    
    let filterUrl = `/ml/products/api/product/${productId}/catalog/filter?`;
    const params = [];
    
    if (positionFilter) params.push(`position=${encodeURIComponent(positionFilter)}`);
    if (priceFilter) params.push(`price=${encodeURIComponent(priceFilter)}`);
    if (shippingFilter) params.push(`shipping=${encodeURIComponent(shippingFilter)}`);
    if (mercadoliderFilter) params.push(`mercadolider=${encodeURIComponent(mercadoliderFilter)}`);
    
    filterUrl += params.join('&');
    
    try {
        // Mostrar loading
        document.getElementById('filter-results').innerHTML = `<small class="text-muted">Carregando...</small>`;
        
        const response = await fetch(filterUrl);
        const data = await response.json();
        
        // Verificar se houve erro de sess√£o
        if (handleSessionError(response, data)) {
            return;
        }
        
        if (data.success) {
            // Atualizar contador de resultados
            document.getElementById('filter-results').innerHTML = `<small class="text-muted">${data.catalog_products.length} resultados</small>`;
            
            // Renderizar tabela filtrada
            renderFilteredTable(data.catalog_products);
        } else {
            console.error('Erro ao filtrar cat√°logo:', data.error);
            document.getElementById('filter-results').innerHTML = `<small class="text-danger">Erro ao filtrar</small>`;
        }
    } catch (error) {
        console.error('Erro na requisi√ß√£o de filtro:', error);
        document.getElementById('filter-results').innerHTML = `<small class="text-danger">Erro na requisi√ß√£o</small>`;
    }
}

// Fun√ß√£o para limpar filtros
async function clearFilters() {
    // Resetar todos os filtros
    document.getElementById('filter-position').value = '';
    document.getElementById('filter-price').value = '';
    document.getElementById('filter-shipping').value = '';
    document.getElementById('filter-mercadolider').value = '';
    
    // Buscar dados originais do backend (sem filtros)
    const currentPath = window.location.pathname;
    const productId = currentPath.split('/').pop();
    
    try {
        // Mostrar loading
        document.getElementById('filter-results').innerHTML = `<small class="text-muted">Carregando...</small>`;
        
        const response = await fetch(`/ml/products/api/product/${productId}/catalog/database`);
        const data = await response.json();
        
        // Verificar se houve erro de sess√£o
        if (handleSessionError(response, data)) {
            return;
        }
        
        if (data.success) {
            // Atualizar contador de resultados
            document.getElementById('filter-results').innerHTML = `<small class="text-muted">${data.catalog_products.length} resultados</small>`;
            
            // Renderizar tabela original
            renderFilteredTable(data.catalog_products);
        } else {
            console.error('Erro ao limpar filtros:', data.error);
            document.getElementById('filter-results').innerHTML = `<small class="text-danger">Erro ao carregar dados</small>`;
        }
    } catch (error) {
        console.error('Erro na requisi√ß√£o de limpeza:', error);
        document.getElementById('filter-results').innerHTML = `<small class="text-danger">Erro na requisi√ß√£o</small>`;
    }
}

// Fun√ß√£o para renderizar tabela filtrada
function renderFilteredTable(products) {
    const tbody = document.querySelector('#catalog-shipping-content tbody');
    if (!tbody) return;
    
    let html = '';
    
    products.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informa√ß√µes de envio - usar a mesma l√≥gica da fun√ß√£o original
        let shippingInfo = "N√£o dispon√≠vel";
        
        if (product.shipping_free) {
            shippingInfo = '<span class="badge bg-success">Frete Gr√°tis</span>';
        } else if (product.logistic_type && product.logistic_type !== 'default') {
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = '<span class="badge bg-secondary">Outros</span>';
            }
        } else if (product.shipping_method && product.shipping_method !== 'standard') {
            switch(product.shipping_method) {
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = '<span class="badge bg-secondary">Outros</span>';
            }
        }
        
        // Informa√ß√µes de reputa√ß√£o - usar a mesma l√≥gica da fun√ß√£o original
        let reputationInfo = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationInfo = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "YELLOW":
                    reputationInfo = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "RED":
                    reputationInfo = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                default:
                    reputationInfo = '<span class="badge bg-secondary">‚ö™ Neutro</span>';
                    break;
            }
        } else {
            reputationInfo = '<span class="badge bg-light text-dark">‚ùì Desconhecida</span>';
        }
        
        // Loja oficial - usar a mesma l√≥gica da fun√ß√£o original
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">N√£o</span>';
        
        // Usar exatamente a mesma estrutura HTML da fun√ß√£o original
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                            ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                                `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                            <small class="text-muted d-block">${product.ml_item_id}</small>
                        </div>
                    </div>
                </td>
                <td><strong>${priceFormatted}</strong></td>
                <td>${product.seller_transactions_total > 0 ? 
                    `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
                    '<span class="badge bg-secondary">0</span>'}</td>
                <td>${product.buy_box_winner ? 
                    '<span class="badge bg-success">üèÜ Vencedor</span>' : 
                    (product.position === 1 ? 
                        '<span class="badge bg-success">ü•á 1¬∫ Lugar</span>' : 
                        (product.position === 2 ? 
                            '<span class="badge bg-secondary">ü•à 2¬∫ Lugar</span>' : 
                            (product.position === 3 ? 
                                '<span class="badge bg-warning">ü•â 3¬∫ Lugar</span>' : 
                                `<span class="badge bg-light text-dark">#${product.position}</span>`)))}</td>
                <td>${shippingInfo}</td>
                <td>${reputationInfo}</td>
                <td>${lojaOficialBadge}</td>
                <td>${(product.original_price && product.original_price > product.price) ? 
                    `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
                    ''}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm"
                       title="Ver an√∫ncio"
                       onclick="console.log('Clicando em: ${product.permalink}')">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    // Apenas substituir o conte√∫do do tbody, mantendo toda a estrutura da tabela
    tbody.innerHTML = html;
}

// Fun√ß√£o para sincronizar cat√°logo
function syncCatalog() {
    console.log('syncCatalog chamada');
    const productId = window.location.pathname.split('/').pop();
    const syncBtn = document.getElementById('sync-catalog-btn');
    
    if (!syncBtn) {
        console.error('Bot√£o sync-catalog-btn n√£o encontrado!');
        return;
    }
    
    const originalText = syncBtn.innerHTML;
    
    // Mostrar loading
    syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Sincronizando...';
    syncBtn.disabled = true;
    
    fetch(`/ml/products/api/product/${productId}/catalog/sync`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (handleSessionError(null, data)) return;
        if (data.success) {
            // Mostrar sucesso
            syncBtn.innerHTML = '<i class="bi bi-check-circle"></i> Sincronizado!';
            syncBtn.classList.remove('btn-outline-success');
            syncBtn.classList.add('btn-success');
            
            // Recarregar dados do cat√°logo do banco
            setTimeout(() => {
                loadCatalogInfo(productId);
            }, 1000);
            
            // Restaurar bot√£o ap√≥s 3 segundos
            setTimeout(() => {
                syncBtn.innerHTML = originalText;
                syncBtn.classList.remove('btn-success');
                syncBtn.classList.add('btn-outline-success');
                syncBtn.disabled = false;
            }, 3000);
        } else {
            throw new Error(data.error || 'Erro na sincroniza√ß√£o');
        }
    })
    .catch(error => {
        console.error('Erro ao sincronizar cat√°logo:', error);
        syncBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erro';
        syncBtn.classList.remove('btn-outline-success');
        syncBtn.classList.add('btn-danger');
        
        // Restaurar bot√£o ap√≥s 3 segundos
        setTimeout(() => {
            syncBtn.innerHTML = originalText;
            syncBtn.classList.remove('btn-danger');
            syncBtn.classList.add('btn-outline-success');
            syncBtn.disabled = false;
        }, 3000);
    });
}

// CSS para anima√ß√£o de loading
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

    // Fun√ß√£o global para tratar erros de sess√£o
    function handleSessionError(response, data) {
        if (response && response.status === 401) {
            // Sess√£o expirada - redirecionar para login
            window.location.href = '/auth/login';
            return true;
        }
        if (data && data.detail === "Sess√£o n√£o encontrada") {
            // Sess√£o inv√°lida - redirecionar para login
            window.location.href = '/auth/login';
            return true;
        }
        return false;
    }

    // Fun√ß√£o para carregar an√°lise competitiva
    function loadCompetitiveAnalysis(productId) {
        fetch(`/ml/products/api/product/${productId}/catalog/database`)
            .then(response => response.json())
            .then(data => {
                if (handleSessionError(null, data)) return;
                
                if (data && data.success && data.catalog_products) {
                    renderCompetitiveAnalysis(data.catalog_products);
                } else {
                    document.getElementById('catalog-analysis-content').innerHTML = 
                        '<div class="text-center py-3"><p class="text-muted mb-0">Nenhum dado de cat√°logo dispon√≠vel</p></div>';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar an√°lise competitiva:', error);
                document.getElementById('catalog-analysis-content').innerHTML = 
                    '<div class="text-center py-3"><p class="text-danger mb-0">Erro ao carregar an√°lise</p></div>';
            });
    }

    // Fun√ß√£o para renderizar an√°lise competitiva
    function renderCompetitiveAnalysis(products) {
        const analysisContent = document.getElementById('catalog-analysis-content');
        
        // An√°lise por tipo de envio
        const shippingAnalysis = analyzeShippingTypes(products);
        
        // Top 3 anunciantes
        const top3 = getTop3Announcers(products);
        
        // An√°lise de posicionamento
        const positioningAnalysis = analyzePositioning(products);
        
        // An√°lise de MercadoL√≠der
        const mercadoLiderAnalysis = analyzeMercadoLider(products);
        
        // An√°lise de faixas de valor
        const priceRangesAnalysis = analyzePriceRanges(products);
        
        // M√©tricas gerais
        const metrics = calculateMetrics(products);
        
        analysisContent.innerHTML = `
            <div class="row">
                <!-- An√°lise por Tipo de Envio -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-primary mb-3">
                        <i class="bi bi-truck"></i> Distribui√ß√£o por Envio
                    </h6>
                    <div class="row">
                        ${Object.entries(shippingAnalysis).map(([type, count]) => `
                            <div class="col-6 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span class="small">${getShippingTypeLabel(type)}</span>
                                    <span class="badge bg-primary">${count}</span>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Top 3 Anunciantes -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-success mb-3">
                        <i class="bi bi-trophy"></i> Top 3 Anunciantes
                    </h6>
                    ${top3.map((announcer, index) => `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 ${index === 0 ? 'bg-light rounded' : ''}">
                            <div>
                                <span class="badge ${index === 0 ? 'bg-warning' : index === 1 ? 'bg-secondary' : 'bg-dark'}">${announcer.position || (index + 1)}¬∫</span>
                                <strong>${getSellerDisplayName(announcer)}</strong>
                            </div>
                            <div class="text-end">
                                <div class="small text-muted">R$ ${(announcer.price).toFixed(2)}</div>
                                <div class="small">${announcer.shipping_type}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- An√°lise por Faixas de Valor e MercadoL√≠der -->
            <div class="row">
                <!-- An√°lise por Faixas de Valor -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-success mb-3">
                        <i class="bi bi-currency-dollar"></i> Distribui√ß√£o por Faixas de Valor
                    </h6>
                    <div class="row">
                        ${Object.entries(analyzePriceRanges(products)).map(([range, count]) => `
                            <div class="col-6 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span class="small">${getPriceRangeLabel(range)}</span>
                                    <span class="badge ${getPriceRangeBadgeClass(range)}">${count}</span>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar ${getPriceRangeProgressClass(range)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Distribui√ß√£o por MercadoL√≠der -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-award"></i> Distribui√ß√£o por MercadoL√≠der
                    </h6>
                    <div class="row">
                        ${Object.entries(analyzeMercadoLider(products)).map(([level, count]) => `
                            <div class="col-6 mb-2">
                                <div class="d-flex justify-content-between">
                                    <span class="small">${getMercadoLiderLabel(level)}</span>
                                    <span class="badge ${getMercadoLiderBadgeClass(level)}">${count}</span>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar ${getMercadoLiderProgressClass(level)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <!-- An√°lise de MercadoL√≠der (continua√ß√£o) -->
            <div class="row">
                
                <!-- An√°lise de Posicionamento -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-info mb-3">
                        <i class="bi bi-graph-up"></i> An√°lise de Posicionamento
                    </h6>
                    <div class="row">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-primary">${metrics.total_announcers}</h5>
                                    <small class="text-muted">Total de Anunciantes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h5 class="text-warning">${positioningAnalysis.your_position || 'N/A'}</h5>
                                    <small class="text-muted">Sua Posi√ß√£o</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-success">R$ ${parseFloat(metrics.min_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                    <small class="text-muted">Menor Pre√ßo</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-info">R$ ${parseFloat(metrics.avg_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                    <small class="text-muted">Pre√ßo M√©dio</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-danger">R$ ${parseFloat(metrics.max_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                    <small class="text-muted">Maior Pre√ßo</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h6 class="text-white">R$ ${positioningAnalysis.your_price ? positioningAnalysis.your_price.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 'N/A'}</h6>
                                    <small class="text-white-50">Seu Pre√ßo</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recomenda√ß√µes -->
                <div class="col-md-6 mb-4">
                    <h6 class="text-warning mb-3">
                        <i class="bi bi-lightbulb"></i> Recomenda√ß√µes
                    </h6>
                    <div class="alert alert-info">
                        ${generateRecommendations(shippingAnalysis, positioningAnalysis, metrics, mercadoLiderAnalysis, priceRangesAnalysis)}
                    </div>
                </div>
            </div>
        `;
        
    }

    // Fun√ß√£o para analisar tipos de envio
    function analyzeShippingTypes(products) {
        const shippingTypes = {};
        products.forEach(product => {
            const shippingType = getShippingTypeFromProduct(product);
            shippingTypes[shippingType] = (shippingTypes[shippingType] || 0) + 1;
        });
        return shippingTypes;
    }

    // Fun√ß√£o para obter tipo de envio do produto
    function getShippingTypeFromProduct(product) {
        if (product.shipping_free) return 'frete_gratis';
        if (product.logistic_type === 'fulfillment') return 'full';
        if (product.logistic_type === 'cross_docking') return 'coleta_ml';
        if (product.shipping_method === 'me2') return 'mercado_envios';
        if (product.shipping_method === 'drop_off' || product.shipping_method === 'xd_drop_off') return 'correios';
        return 'outros';
    }

    // Fun√ß√£o para obter label do tipo de envio
    function getShippingTypeLabel(type) {
        const labels = {
            'frete_gratis': 'Frete Gr√°tis',
            'full': 'Full Mercado Livre',
            'coleta_ml': 'Coleta ML',
            'mercado_envios': 'Mercado Envios',
            'correios': 'Correios',
            'outros': 'Outros'
        };
        return labels[type] || type;
    }

    // Fun√ß√£o para obter nome de exibi√ß√£o do vendedor
    function getSellerDisplayName(seller) {
        if (seller.seller_name && seller.seller_name !== 'N/A') {
            return seller.seller_name;
        }
        if (seller.seller_nickname && seller.seller_nickname !== 'N/A') {
            return seller.seller_nickname;
        }
        return seller.seller_id || 'N/A';
    }

    // Fun√ß√£o para obter top 3 anunciantes baseado na posi√ß√£o
    function getTop3Announcers(products) {
        const sorted = products
            .sort((a, b) => (a.position || 999) - (b.position || 999))  // Ordenar por posi√ß√£o
            .slice(0, 3);
        
        // Debug: verificar dados
        console.log('Top 3 anunciantes:', sorted.map(p => ({
            position: p.position,
            seller_name: p.seller_name,
            seller_nickname: p.seller_nickname,
            seller_id: p.seller_id,
            price: p.price
        })));
        
        return sorted.map(product => ({
            ...product,
            shipping_type: getShippingTypeLabel(getShippingTypeFromProduct(product))
        }));
    }

    // Fun√ß√£o para analisar posicionamento
    function analyzePositioning(products) {
        if (!products || products.length === 0) {
            return {
                your_position: null,
                total_competitors: 0,
                best_position: null,
                your_price: null
            };
        }
        
        // Buscar especificamente pelo seu produto MLB5588063084
        const yourProduct = products.find(p => p.ml_item_id === 'MLB5588063084');
        
        // Encontrar a melhor posi√ß√£o geral
        const positions = products.map(p => parseInt(p.position) || 999);
        const bestPosition = Math.min(...positions);
        
        return {
            your_position: yourProduct ? (parseInt(yourProduct.position) || null) : null,
            total_competitors: products.length - 1,
            best_position: bestPosition,
            your_price: yourProduct ? (parseFloat(yourProduct.price) || null) : null
        };
    }

    // Fun√ß√£o para calcular m√©tricas
    function calculateMetrics(products) {
        const totalPrice = products.reduce((sum, product) => sum + product.price, 0);
        const avgPrice = (totalPrice / products.length).toFixed(2);
        
        return {
            total_announcers: products.length,
            avg_price: avgPrice,
            min_price: (Math.min(...products.map(p => p.price))).toFixed(2),
            max_price: (Math.max(...products.map(p => p.price))).toFixed(2)
        };
    }

    // Fun√ß√£o para analisar n√≠veis de MercadoL√≠der
    function analyzeMercadoLider(products) {
        const levels = {};
        products.forEach(product => {
            const level = getMercadoLiderLevel(product);
            levels[level] = (levels[level] || 0) + 1;
        });
        return levels;
    }

    // Fun√ß√£o para analisar faixas de valor
    function analyzePriceRanges(products) {
        const ranges = {};
        products.forEach(product => {
            const range = getPriceRange(product.price);
            ranges[range] = (ranges[range] || 0) + 1;
        });
        return ranges;
    }

    // Fun√ß√£o para obter faixa de valor do produto
    function getPriceRange(price) {
        if (price <= 10) return 'ate_10';
        if (price <= 20) return '10_20';
        if (price <= 30) return '20_30';
        if (price <= 50) return '30_50';
        if (price <= 100) return '50_100';
        return 'acima_100';
    }

    // Fun√ß√£o para obter label da faixa de valor
    function getPriceRangeLabel(range) {
        const labels = {
            'ate_10': 'At√© R$ 10',
            '10_20': 'R$ 10 - R$ 20',
            '20_30': 'R$ 20 - R$ 30',
            '30_50': 'R$ 30 - R$ 50',
            '50_100': 'R$ 50 - R$ 100',
            'acima_100': 'Acima de R$ 100'
        };
        return labels[range] || range;
    }

    // Fun√ß√£o para obter classe do badge da faixa de valor
    function getPriceRangeBadgeClass(range) {
        const classes = {
            'ate_10': 'bg-success',
            '10_20': 'bg-primary',
            '20_30': 'bg-info',
            '30_50': 'bg-warning',
            '50_100': 'bg-danger',
            'acima_100': 'bg-dark'
        };
        return classes[range] || 'bg-secondary';
    }

    // Fun√ß√£o para obter classe da barra de progresso da faixa de valor
    function getPriceRangeProgressClass(range) {
        const classes = {
            'ate_10': 'bg-success',
            '10_20': 'bg-primary',
            '20_30': 'bg-info',
            '30_50': 'bg-warning',
            '50_100': 'bg-danger',
            'acima_100': 'bg-dark'
        };
        return classes[range] || 'bg-secondary';
    }

    // Fun√ß√£o para obter anunciantes por n√≠vel de MercadoL√≠der
    function getAnnouncersByLevel(products, level) {
        return products.filter(product => getMercadoLiderLevel(product) === level)
                      .sort((a, b) => (a.position || 999) - (b.position || 999));
    }

    // Fun√ß√£o para renderizar cards de MercadoL√≠der
    function renderMercadoLiderCards(products) {
        const container = document.getElementById('mercado-lider-cards');
        const mercadoLiderAnalysis = analyzeMercadoLider(products);
        
        const levels = Object.entries(mercadoLiderAnalysis);
        
        // Organizar em grupos de 2 para garantir 2 por linha
        const rows = [];
        for (let i = 0; i < levels.length; i += 2) {
            rows.push(levels.slice(i, i + 2));
        }
        
        container.innerHTML = `
            ${rows.map(row => `
                <div class="row">
                    ${row.map(([level, count], index) => `
                        <div class="col-md-6 mb-4 ${row.length === 1 ? 'offset-md-6' : ''}">
                            <div class="card h-100">
                                <div class="card-header ${getMercadoLiderBadgeClass(level)} text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-award"></i> ${getMercadoLiderLabel(level)}
                                        <span class="badge bg-light text-dark ms-2">${count}</span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <span class="small">${count} anunciantes</span>
                                            <span class="small">${(count / products.length * 100).toFixed(1)}%</span>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar ${getMercadoLiderProgressClass(level)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                                        </div>
                                    </div>
                                    <div class="announcers-list" style="max-height: 200px; overflow-y: auto;">
                                        ${getAnnouncersByLevel(products, level).map(announcer => `
                                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                                <div>
                                                    <div class="fw-bold small">${getSellerDisplayName(announcer)}</div>
                                                    <div class="text-muted small">R$ ${(announcer.price).toFixed(2)}</div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="badge bg-primary">#${announcer.position || 'N/A'}</div>
                                                    <div class="small text-muted">${getShippingTypeLabel(getShippingTypeFromProduct(announcer))}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `).join('')}
        `;
        
        // Mostrar os cards
        container.style.display = 'block';
    }

    // Fun√ß√£o para obter n√≠vel de MercadoL√≠der do produto
    function getMercadoLiderLevel(product) {
        const status = product.seller_power_seller_status;
        if (!status || status === 'N/A') {
            return 'sem_medalha';
        }
        
        if (status === 'platinum') {
            return 'platinum';
        } else if (status === 'gold') {
            return 'gold';
        } else if (status === 'silver') {
            return 'silver';
        }
        
        return 'sem_medalha';
    }

    // Fun√ß√£o para obter label do n√≠vel de MercadoL√≠der
    function getMercadoLiderLabel(level) {
        const labels = {
            'platinum': 'ü•á MercadoL√≠der Platinum',
            'gold': 'ü•à MercadoL√≠der Gold',
            'silver': 'ü•â MercadoL√≠der',
            'sem_medalha': '‚ö™ Sem Medalha'
        };
        return labels[level] || level;
    }

    // Fun√ß√£o para obter classe do badge
    function getMercadoLiderBadgeClass(level) {
        const classes = {
            'platinum': 'bg-info',
            'gold': 'bg-warning',
            'silver': 'bg-secondary',
            'sem_medalha': 'bg-success text-white'
        };
        return classes[level] || 'bg-secondary';
    }

    // Fun√ß√£o para obter classe da barra de progresso
    function getMercadoLiderProgressClass(level) {
        const classes = {
            'platinum': 'bg-info',
            'gold': 'bg-warning',
            'silver': 'bg-secondary',
            'sem_medalha': 'bg-success'
        };
        return classes[level] || 'bg-secondary';
    }

    // Fun√ß√£o para gerar recomenda√ß√µes
    function generateRecommendations(shippingAnalysis, positioningAnalysis, metrics, mercadoLiderAnalysis, priceRangesAnalysis) {
        const recommendations = [];
        
        // Recomenda√ß√£o baseada em tipo de envio
        const fullCount = shippingAnalysis.full || 0;
        const totalCount = Object.values(shippingAnalysis).reduce((sum, count) => sum + count, 0);
        const fullPercentage = (fullCount / totalCount * 100).toFixed(1);
        
        if (fullPercentage > 50) {
            recommendations.push(`<strong>Full √© dominante (${fullPercentage}%)</strong> - Considere usar Full para competir.`);
        }
        
        
        // Recomenda√ß√£o baseada em faixas de valor
        const ate10Count = priceRangesAnalysis.ate_10 || 0;
        const faixa10_20Count = priceRangesAnalysis['10_20'] || 0;
        const faixa20_30Count = priceRangesAnalysis['20_30'] || 0;
        const faixa30_50Count = priceRangesAnalysis['30_50'] || 0;
        const faixa50_100Count = priceRangesAnalysis['50_100'] || 0;
        const acima100Count = priceRangesAnalysis.acima_100 || 0;
        const totalPriceRanges = Object.values(priceRangesAnalysis).reduce((sum, count) => sum + count, 0);
        
        // Encontrar a faixa mais popular
        const mostPopularRange = Object.entries(priceRangesAnalysis).reduce((a, b) => priceRangesAnalysis[a[0]] > priceRangesAnalysis[b[0]] ? a : b);
        const mostPopularPercentage = (mostPopularRange[1] / totalPriceRanges * 100).toFixed(1);
        
        if (mostPopularRange[1] > 0) {
            recommendations.push(`<strong>üí∞ Faixa mais popular: ${getPriceRangeLabel(mostPopularRange[0])} (${mostPopularPercentage}%)</strong> - Concentra√ß√£o de ofertas.`);
        }
        
        // Alertas sobre faixas espec√≠ficas
        if (ate10Count > 0) {
            const ate10Percentage = (ate10Count / totalPriceRanges * 100).toFixed(1);
            recommendations.push(`<strong>üü¢ ${ate10Count} an√∫ncios at√© R$ 10 (${ate10Percentage}%)</strong> - Mercado de baixo valor.`);
        }
        
        if (acima100Count > 0) {
            const acima100Percentage = (acima100Count / totalPriceRanges * 100).toFixed(1);
            recommendations.push(`<strong>üî¥ ${acima100Count} an√∫ncios acima de R$ 100 (${acima100Percentage}%)</strong> - Mercado premium.`);
        }
        
        // Recomenda√ß√£o baseada em pre√ßo
        recommendations.push(`<strong>Pre√ßo m√©dio:</strong> ${metrics.avg_price} - Analise se seu pre√ßo est√° competitivo.`);
        
        // Recomenda√ß√£o baseada em posicionamento
        if (positioningAnalysis.your_position && positioningAnalysis.your_position > 3) {
            recommendations.push(`<strong>Posi√ß√£o:</strong> Voc√™ est√° em ${positioningAnalysis.your_position}¬∫ lugar - Melhore seu posicionamento.`);
        }
        
        return recommendations.length > 0 ? recommendations.join('<br>') : 'Continue monitorando a concorr√™ncia.';
    }
</script>
{% endblock %}
