{% extends "base.html" %}

{% block title %}An√°lise do Produto - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-calculator text-success"></i>
                        An√°lise do Produto
                    </h1>
                    <p class="text-muted mb-0">An√°lise completa de custos e rentabilidade</p>
                </div>
                <div>
                    <a href="/ml/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Voltar aos Produtos
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="text-center py-5 d-none">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-3">Carregando an√°lise do produto...</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="alert alert-danger d-none">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar an√°lise:</strong>
                <span id="error-message"></span>
            </div>

            <!-- Analysis Content -->
            <div id="analysis-content">
                <!-- Product Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-box"></i> Informa√ß√µes do Produto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <img id="product-thumbnail" src="" alt="Produto" class="img-fluid rounded">
                            </div>
                            <div class="col-md-9">
                                <h4 id="product-title" class="mb-2"></h4>
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>ID:</strong> <span id="product-ml-id"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Status:</strong> <span id="product-status"></span>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <a href="https://www.mercadolivre.com.br/catalogo/explorar/" 
                                       target="_blank" 
                                       class="btn btn-outline-primary btn-sm"
                                       title="Abrir cat√°logo do Mercado Livre">
                                        <i class="bi bi-box-arrow-up-right"></i> Ver Cat√°logo
                                    </a>
                                    <button type="button" class="btn btn-outline-success btn-sm ms-2" onclick="syncCatalog()" id="sync-catalog-btn">
                                        <i class="bi bi-arrow-clockwise"></i> Sincronizar Cat√°logo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Analysis -->
                <div class="row">
                    <!-- Marketplace Fees -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-calculator"></i> An√°lise de Pre√ßos e Taxas
                                </h5>
                            </div>
                <div class="card-body">
                    <div id="marketplace-fees">
                        <div class="text-center py-3">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 mb-0">Carregando an√°lise de pre√ßos...</p>
                        </div>
                    </div>
                </div>
                        </div>
                    </div>

                    <!-- Profitability Analysis -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-graph-up"></i> An√°lise de Rentabilidade
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="profitability-analysis">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Calculando rentabilidade...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Analysis Card -->
                <div class="col-md-12 mb-4" id="sales-analysis-card">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up-arrow"></i> An√°lise de Vendas
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs" id="salesAnalysisTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="product-analysis-tab" data-bs-toggle="tab" 
                                            data-bs-target="#product-analysis" type="button" role="tab" 
                                            aria-controls="product-analysis" aria-selected="true">
                                        <i class="bi bi-box"></i> An√°lise do Produto
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="sku-sales-tab" data-bs-toggle="tab" 
                                            data-bs-target="#sku-sales" type="button" role="tab" 
                                            aria-controls="sku-sales" aria-selected="false">
                                        <i class="bi bi-bar-chart"></i> Vendas pelo SKU
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="salesAnalysisTabContent">
                                <!-- Product Analysis Tab -->
                                <div class="tab-pane fade show active" id="product-analysis" role="tabpanel" 
                                     aria-labelledby="product-analysis-tab">
                                    <div class="mt-3">
                                        <div id="product-analysis-content">
                                            <div class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <p class="mt-2 mb-0">Carregando an√°lise do produto...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- SKU Sales Tab -->
                                <div class="tab-pane fade" id="sku-sales" role="tabpanel" 
                                     aria-labelledby="sku-sales-tab">
                                    <div class="mt-3">
                                        <div id="sku-sales-content">
                                            <div class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                                <p class="mt-2 mb-0">Carregando vendas por SKU...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- An√°lise Card -->
                <div class="col-md-12 mb-4" id="competitive-analysis-card">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up"></i> An√°lise Competitiva
                            </h5>
                        </div>
                       <div class="card-body">
                           <div id="catalog-analysis-content">
                               <div class="text-center py-3">
                                   <div class="spinner-border spinner-border-sm" role="status">
                                       <span class="visually-hidden">Carregando...</span>
                                   </div>
                                   <p class="mt-2 mb-0">Analisando dados...</p>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>

                <!-- Catalog Information -->
                <div class="col-md-12 mb-4" id="catalog-info-card">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0" id="catalog-shipping-header">
                                <i class="bi bi-truck"></i> Custos de Envio
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="catalog-shipping-content">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-2 mb-0">Verificando informa√ß√µes...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Fun√ß√£o para obter token de sess√£o
function getSessionToken() {
    // Tentar pegar do cookie primeiro
    const cookies = document.cookie.split(';');
    
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'session_token') {
            return value;
        }
    }
    
    // Fallback para localStorage/sessionStorage
    const localToken = localStorage.getItem('session_token');
    const sessionToken = sessionStorage.getItem('session_token');
    
    return localToken || sessionToken;
}

// Fun√ß√£o para verificar se a sess√£o expirou
function checkSessionExpired(response) {
    if (response.status === 401) {
        // Sess√£o expirada, redirecionar para login
        window.location.href = '/auth/login';
        return true;
    }
    return false;
}

// Fun√ß√£o para ocultar elementos quando sess√£o expira
function hideUserElements() {
    // Ocultar elementos que requerem autentica√ß√£o
    const elementsToHide = document.querySelectorAll('.auth-required');
    elementsToHide.forEach(element => {
        element.style.display = 'none';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const productId = window.location.pathname.split('/').pop();
    console.log('üöÄ P√°gina carregada, ID do produto:', productId);
    console.log('üç™ Cookies dispon√≠veis:', document.cookie);
    console.log('üîë Token de sess√£o:', getSessionToken());
    loadProductAnalysis(productId);
});

function loadProductAnalysis(productId) {
    console.log('üîç Carregando produto ID:', productId);
    
    // Verificar se o usu√°rio est√° logado
    const sessionToken = getSessionToken();
    if (!sessionToken || sessionToken === 'null') {
        console.log('üîí Usu√°rio n√£o logado, redirecionando para login...');
        window.location.href = '/auth/login';
        return;
    }
    
    // Carregar dados do produto
    fetch(`/ml/products/api/product/${productId}`, {
        credentials: 'include'
    })
        .then(response => {
            console.log('üì° Resposta recebida:', response.status);
            if (checkSessionExpired(response)) {
                hideUserElements();
                return;
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Dados recebidos:', data);
            console.log('üìä Tipo dos dados:', typeof data);
            console.log('üìä Success:', data?.success);
            console.log('üìä Product:', data?.product);
            
            if (data && data.success) {
                console.log('‚úÖ Produto carregado com sucesso');
                console.log('üì¶ Dados do produto:', data.product);
                renderProductInfo(data.product);
                checkCatalogInfo(data.product);
                loadProfitabilityAnalysis(data.product);
                loadPricingAnalysis(data.product);
                loadSalesAnalysis(data.product);
                
                // Mostrar conte√∫do
                document.getElementById('loading-state').classList.add('d-none');
                document.getElementById('analysis-content').classList.remove('d-none');
            } else {
                console.log('‚ùå Erro ao carregar produto:', data?.error);
                console.log('‚ùå Dados completos:', data);
                showError(data?.error || 'Erro ao carregar produto');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            showError('Erro ao carregar an√°lise do produto');
        });
}

function renderProductInfo(product) {
    console.log('üé® Renderizando informa√ß√µes do produto:', product);
    
    try {
        // Testar se os elementos existem
        const thumbnail = document.getElementById('product-thumbnail');
        const title = document.getElementById('product-title');
        const mlId = document.getElementById('product-ml-id');
        const status = document.getElementById('product-status');
        
        console.log('üîç Elementos encontrados:', {
            thumbnail: !!thumbnail,
            title: !!title,
            mlId: !!mlId,
            status: !!status
        });
        
        console.log('üìù Dados do produto para renderizar:', {
            thumbnail: product.thumbnail,
            title: product.title,
            ml_item_id: product.ml_item_id,
            status: product.status
        });
        
        if (thumbnail) {
            thumbnail.src = product.thumbnail || '/static/images/no-image.png';
            console.log('üñºÔ∏è Thumbnail definido:', thumbnail.src);
        }
        if (title) {
            title.textContent = product.title || 'Sem t√≠tulo';
            console.log('üìù T√≠tulo definido:', title.textContent);
        }
        if (mlId) {
            mlId.textContent = product.ml_item_id || 'N/A';
            console.log('üÜî ID definido:', mlId.textContent);
        }
        if (status) {
            status.innerHTML = getStatusBadge(product.status);
            console.log('üè∑Ô∏è Status definido:', status.innerHTML);
        }
        
        // Mostrar/ocultar bot√µes de cat√°logo baseado no tipo do produto
        const catalogButtons = document.querySelectorAll('#sync-catalog-btn, a[href*="catalogo"]');
        if (product.catalog_listing) {
            catalogButtons.forEach(btn => btn.style.display = 'inline-block');
        } else {
            catalogButtons.forEach(btn => btn.style.display = 'none');
        }
        
        console.log('‚úÖ Informa√ß√µes do produto renderizadas com sucesso');
    } catch (error) {
        console.error('‚ùå Erro ao renderizar informa√ß√µes do produto:', error);
    }
}

function getStatusBadge(status) {
    console.log('üè∑Ô∏è Gerando badge para status:', status);
    
    const statusMap = {
        'active': '<span class="badge bg-success">Ativo</span>',
        'paused': '<span class="badge bg-warning">Pausado</span>',
        'closed': '<span class="badge bg-danger">Fechado</span>',
        'under_review': '<span class="badge bg-info">Em Revis√£o</span>',
        'inactive': '<span class="badge bg-secondary">Inativo</span>'
    };
    
    const result = statusMap[status] || '<span class="badge bg-secondary">Desconhecido</span>';
    console.log('üè∑Ô∏è Badge gerado:', result);
    
    return result;
}

function checkCatalogInfo(product) {
    console.log('üìã Verificando informa√ß√µes de cat√°logo:', product);
    
    try {
        // Verificar se o produto √© de cat√°logo
        if (product.catalog_listing) {
            console.log('üìã Produto √© de cat√°logo, carregando informa√ß√µes...');
            loadCatalogInfo(product.id);
            loadCompetitiveAnalysis(product.id, product);
            // Mostrar cards de cat√°logo
            const competitiveCard = document.getElementById('competitive-analysis-card');
            const catalogCard = document.getElementById('catalog-info-card');
            if (competitiveCard) competitiveCard.style.display = 'block';
            if (catalogCard) catalogCard.style.display = 'block';
        } else {
            console.log('üìã Produto n√£o √© de cat√°logo, carregando custos de envio...');
            loadShippingCosts(product);
            // Ocultar cards de cat√°logo
            const competitiveCard = document.getElementById('competitive-analysis-card');
            const catalogCard = document.getElementById('catalog-info-card');
            if (competitiveCard) competitiveCard.style.display = 'none';
            if (catalogCard) catalogCard.style.display = 'none';
        }
        
        console.log('‚úÖ Informa√ß√µes de cat√°logo verificadas com sucesso');
    } catch (error) {
        console.error('‚ùå Erro ao verificar informa√ß√µes de cat√°logo:', error);
    }
}

function loadCatalogInfo(productId) {
    console.log('üìã Carregando informa√ß√µes de cat√°logo para produto:', productId);
    
    // Atualizar header
    document.getElementById('catalog-shipping-header').innerHTML = `
        <i class="bi bi-collection"></i> Informa√ß√µes de Cat√°logo
    `;
    
    // Primeiro tenta buscar do banco de dados
    fetch(`/ml/products/api/product/${productId}/catalog/database`, {
        credentials: 'include'
    })
        .then(response => {
            console.log('üì° Resposta do cat√°logo:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Dados do cat√°logo recebidos:', data);
            if (handleSessionError(null, data)) return;
            if (data.success && data.is_catalog && data.catalog_products.length > 0) {
                console.log('‚úÖ Dados de cat√°logo encontrados, renderizando...');
                // Mostrar dados do banco com data da √∫ltima atualiza√ß√£o
                renderCatalogInfo(data);
            } else {
                console.log('‚ö†Ô∏è Nenhum dado de cat√°logo encontrado');
                // Se n√£o tem dados no banco, mostrar mensagem para sincronizar
                const container = document.getElementById('catalog-shipping-content');
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="bi bi-info-circle fs-1"></i>
                        <h5 class="mt-3">Nenhum Dado Sincronizado</h5>
                        <p>Este cat√°logo ainda n√£o foi sincronizado com o banco de dados.</p>
                        <p>Clique em "Sincronizar Cat√°logo" para importar os dados.</p>
                        <button type="button" class="btn btn-success" onclick="syncCatalog()" id="sync-catalog-btn">
                            <i class="bi bi-arrow-clockwise"></i> Sincronizar Cat√°logo
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar informa√ß√µes de cat√°logo do banco:', error);
            // Mostrar mensagem de erro
            const container = document.getElementById('catalog-shipping-content');
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="bi bi-exclamation-triangle fs-1"></i>
                    <h5 class="mt-3">Erro ao Carregar Dados</h5>
                    <p>N√£o foi poss√≠vel carregar os dados do cat√°logo do banco de dados.</p>
                    <p>Verifique sua conex√£o e tente novamente.</p>
                    <button type="button" class="btn btn-primary" onclick="loadCatalogInfo(${productId})">
                        <i class="bi bi-arrow-clockwise"></i> Tentar Novamente
                    </button>
                </div>
            `;
        });
}

function renderCatalogInfo(data) {
    console.log('üé® Renderizando informa√ß√µes de cat√°logo:', data);
    
    const container = document.getElementById('catalog-shipping-content');
    
    if (!data.catalog_products || data.catalog_products.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Este produto √© de cat√°logo, mas n√£o h√° outros anunciantes encontrados.
            </div>
        `;
        return;
    }
    
    // Ordenar por pre√ßo
    const sortedProducts = data.catalog_products.sort((a, b) => a.price - b.price);
    
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Anunciantes do Cat√°logo (${sortedProducts.length})</h6>
                <small class="text-muted">√öltima atualiza√ß√£o: ${data.last_updated || 'N/A'}</small>
            </div>
        </div>
        
        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label small">Posi√ß√£o:</label>
                <select class="form-select form-select-sm" id="filter-position" onchange="filterCatalog()">
                    <option value="">Todas</option>
                    <option value="1">1¬∫ Lugar</option>
                    <option value="2">2¬∫ Lugar</option>
                    <option value="3">3¬∫ Lugar</option>
                    <option value="top3">Top 3</option>
                    <option value="winner">Vencedor</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Faixa de Pre√ßo:</label>
                <select class="form-select form-select-sm" id="filter-price" onchange="filterCatalog()">
                    <option value="">Todas</option>
                    <option value="lowest">Menor Pre√ßo</option>
                    <option value="highest">Maior Pre√ßo</option>
                    <option value="below_avg">Abaixo da M√©dia</option>
                    <option value="above_avg">Acima da M√©dia</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">Tipo de Envio:</label>
                <select class="form-select form-select-sm" id="filter-shipping" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="free">Frete Gr√°tis</option>
                    <option value="full">Full Mercado Livre</option>
                    <option value="correios">Correios</option>
                    <option value="mercado_envios">Mercado Envios</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small">MercadoL√≠der:</label>
                <select class="form-select form-select-sm" id="filter-mercadolider" onchange="filterCatalog()">
                    <option value="">Todos</option>
                    <option value="platinum">Platinum</option>
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="none">Sem Medalha</option>
                </select>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div id="filter-results">
                <small class="text-muted">${sortedProducts.length} resultados</small>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()">
                <i class="bi bi-x-circle"></i> Limpar Filtros
            </button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-primary text-white">
                    <tr>
                        <th>Vendedor</th>
                        <th>Pre√ßo</th>
                        <th>Vendas</th>
                        <th>Posi√ß√£o</th>
                        <th>Envio</th>
                        <th>Reputa√ß√£o</th>
                        <th>Loja Oficial</th>
                        <th>Desconto</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    sortedProducts.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informa√ß√µes de envio
        let shippingInfo = "N√£o dispon√≠vel";
        
        if (product.shipping_free) {
            shippingInfo = '<span class="badge bg-success">Frete Gr√°tis</span>';
        } else if (product.logistic_type && product.logistic_type !== 'default') {
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = `<span class="badge bg-light text-dark">${getShippingTypeLabel(product.logistic_type)}</span>`;
                    break;
            }
        }
        
        // Informa√ß√µes de reputa√ß√£o
        let reputationBadge = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationBadge = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "YELLOW":
                    reputationBadge = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "RED":
                    reputationBadge = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                default:
                    reputationBadge = '<span class="badge bg-secondary">‚ö™ Neutro</span>';
                    break;
            }
        } else {
            reputationBadge = '<span class="badge bg-light text-dark">‚ùì Desconhecida</span>';
        }
        
        // Loja oficial
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">N√£o</span>';
        
        // Desconto
        const descontoBadge = (product.original_price && product.original_price > product.price) ? 
            `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
            '';
        
        // Posi√ß√£o
        let positionInfo = "";
        if (product.buy_box_winner) {
            positionInfo = '<span class="badge bg-success">üèÜ Vencedor</span>';
        } else if (product.position) {
            if (product.position === 1) {
                positionInfo = '<span class="badge bg-success">ü•á 1¬∫ Lugar</span>';
            } else if (product.position === 2) {
                positionInfo = '<span class="badge bg-secondary">ü•à 2¬∫ Lugar</span>';
            } else if (product.position === 3) {
                positionInfo = '<span class="badge bg-warning">ü•â 3¬∫ Lugar</span>';
            } else {
                positionInfo = `<span class="badge bg-light text-dark">#${product.position}</span>`;
            }
        }
        
        // Total de vendas
        const vendasInfo = product.seller_transactions_total > 0 ? 
            `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
            '<span class="badge bg-secondary">0</span>';
        
        html += `
            <tr>
                <td>
                    <div>
                        <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                        ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                            `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                        <small class="text-muted d-block">${product.ml_item_id}</small>
                    </div>
                </td>
                <td class="fw-bold">${priceFormatted}</td>
                <td>${vendasInfo}</td>
                <td>${positionInfo}</td>
                <td>${shippingInfo}</td>
                <td>${reputationBadge}</td>
                <td>${lojaOficialBadge}</td>
                <td>${descontoBadge}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm" 
                       title="Ver an√∫ncio">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i>
                Compara√ß√£o de pre√ßos entre anunciantes do mesmo cat√°logo
            </small>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Armazenar dados originais para filtros
    window.catalogData = data;
    
    console.log('‚úÖ Informa√ß√µes de cat√°logo renderizadas com sucesso');
}

function getShippingTypeLabel(logisticType) {
    const translations = {
        'fulfillment': 'Full Mercado Livre',
        'xd_drop_off': 'Correios',
        'drop_off': 'Correios',
        'cross_docking': 'Coleta ML',
        'me2': 'Mercado Envios',
        'standard': 'Mercado Envios',
        'default': 'N√£o dispon√≠vel'
    };
    return translations[logisticType] || logisticType;
}

function loadCompetitiveAnalysis(productId, product) {
    console.log('üìä Carregando an√°lise competitiva para produto:', productId);
    
    fetch(`/ml/products/api/product/${productId}/catalog/database`, {
        credentials: 'include'
    })
        .then(response => {
            console.log('üì° Resposta da an√°lise competitiva:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Dados da an√°lise competitiva recebidos:', data);
            if (handleSessionError(null, data)) return;
            
            if (data && data.success && data.catalog_products) {
                console.log('‚úÖ Dados de an√°lise competitiva encontrados, renderizando...');
                renderCompetitiveAnalysis(data.catalog_products, product);
            } else {
                console.log('‚ö†Ô∏è Nenhum dado de an√°lise competitiva encontrado');
                document.getElementById('catalog-analysis-content').innerHTML = 
                    '<div class="text-center py-3"><p class="text-muted mb-0">Nenhum dado de cat√°logo dispon√≠vel</p></div>';
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar an√°lise competitiva:', error);
            document.getElementById('catalog-analysis-content').innerHTML = 
                '<div class="text-center py-3"><p class="text-danger mb-0">Erro ao carregar an√°lise</p></div>';
        });
}

function renderCompetitiveAnalysis(products, currentProduct) {
    console.log('üé® Renderizando an√°lise competitiva:', products, 'Produto atual:', currentProduct);
    
    const analysisContent = document.getElementById('catalog-analysis-content');
    
    if (!products || products.length === 0) {
        analysisContent.innerHTML = `
            <div class="text-center py-3">
                <p class="text-muted mb-0">Nenhum dado de cat√°logo dispon√≠vel</p>
            </div>
        `;
        return;
    }
    
    // An√°lise por tipo de envio
    const shippingAnalysis = analyzeShippingTypes(products);
    
    // Top 3 anunciantes
    const top3 = getTop3Announcers(products);
    
    // An√°lise de posicionamento
    const positioningAnalysis = analyzePositioning(products, currentProduct);
    
    // An√°lise de MercadoL√≠der
    const mercadoLiderAnalysis = analyzeMercadoLider(products);
    
    // An√°lise de faixas de valor
    const priceRangesAnalysis = analyzePriceRanges(products);
    
    // M√©tricas gerais
    const metrics = calculateMetrics(products);
    
    analysisContent.innerHTML = `
        <div class="row">
            <!-- An√°lise por Tipo de Envio -->
            <div class="col-md-6 mb-4">
                <h6 class="text-primary mb-3">
                    <i class="bi bi-truck"></i> Distribui√ß√£o por Envio
                </h6>
                <div class="row">
                    ${Object.entries(shippingAnalysis).map(([type, count]) => `
                        <div class="col-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">${getShippingTypeLabel(type)}</span>
                                <span class="badge bg-primary">${count}</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Top 3 Anunciantes -->
            <div class="col-md-6 mb-4">
                <h6 class="text-success mb-3">
                    <i class="bi bi-trophy"></i> Top 3 Anunciantes
                </h6>
                ${top3.map((announcer, index) => `
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 ${index === 0 ? 'bg-light rounded' : ''}">
                        <div>
                            <span class="badge ${index === 0 ? 'bg-warning' : index === 1 ? 'bg-secondary' : 'bg-dark'}">${announcer.position || (index + 1)}¬∫</span>
                            <strong>${getSellerDisplayName(announcer)}</strong>
                        </div>
                        <div class="text-end">
                            <div class="small text-muted">R$ ${(announcer.price).toFixed(2)}</div>
                            <div class="small">${announcer.shipping_type}</div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- An√°lise por Faixas de Valor e MercadoL√≠der -->
        <div class="row">
            <!-- An√°lise por Faixas de Valor -->
            <div class="col-md-6 mb-4">
                <h6 class="text-success mb-3">
                    <i class="bi bi-currency-dollar"></i> Distribui√ß√£o por Faixas de Valor
                </h6>
                <div class="row">
                    ${Object.entries(analyzePriceRanges(products)).map(([range, count]) => `
                        <div class="col-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">${getPriceRangeLabel(range)}</span>
                                <span class="badge ${getPriceRangeBadgeClass(range)}">${count}</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar ${getPriceRangeProgressClass(range)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- Distribui√ß√£o por MercadoL√≠der -->
            <div class="col-md-6 mb-4">
                <h6 class="text-warning mb-3">
                    <i class="bi bi-award"></i> Distribui√ß√£o por MercadoL√≠der
                </h6>
                <div class="row">
                    ${Object.entries(analyzeMercadoLider(products)).map(([level, count]) => `
                        <div class="col-6 mb-2">
                            <div class="d-flex justify-content-between">
                                <span class="small">${getMercadoLiderLabel(level)}</span>
                                <span class="badge ${getMercadoLiderBadgeClass(level)}">${count}</span>
                            </div>
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar ${getMercadoLiderProgressClass(level)}" style="width: ${(count / products.length * 100).toFixed(1)}%"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <!-- An√°lise de Posicionamento -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <h6 class="text-info mb-3">
                    <i class="bi bi-graph-up"></i> An√°lise de Posicionamento
                </h6>
                <div class="row">
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="text-primary">${metrics.total_announcers}</h5>
                                <small class="text-muted">Total de Anunciantes</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h5 class="text-warning">${positioningAnalysis.your_position || 'N/A'}</h5>
                                <small class="text-muted">Sua Posi√ß√£o</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-success">R$ ${parseFloat(metrics.min_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                <small class="text-muted">Menor Pre√ßo</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6 class="text-info">R$ ${parseFloat(metrics.avg_price).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h6>
                                <small class="text-muted">Pre√ßo M√©dio</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    console.log('‚úÖ An√°lise competitiva renderizada com sucesso');
}

// Fun√ß√µes auxiliares para an√°lise competitiva
function analyzeShippingTypes(products) {
    const shippingTypes = {};
    products.forEach(product => {
        const shippingType = getShippingTypeFromProduct(product);
        shippingTypes[shippingType] = (shippingTypes[shippingType] || 0) + 1;
    });
    return shippingTypes;
}

function getShippingTypeFromProduct(product) {
    if (product.shipping_free) return 'frete_gratis';
    if (product.logistic_type === 'fulfillment') return 'full';
    if (product.logistic_type === 'cross_docking') return 'coleta_ml';
    if (product.shipping_method === 'me2') return 'mercado_envios';
    if (product.shipping_method === 'drop_off' || product.shipping_method === 'xd_drop_off') return 'correios';
    return 'outros';
}

function getSellerDisplayName(seller) {
    if (seller.seller_name && seller.seller_name !== 'N/A') {
        return seller.seller_name;
    }
    if (seller.seller_nickname && seller.seller_nickname !== 'N/A') {
        return seller.seller_nickname;
    }
    return seller.seller_id || 'N/A';
}

function getTop3Announcers(products) {
    const sorted = products
        .sort((a, b) => (a.position || 999) - (b.position || 999))
        .slice(0, 3);
    
    return sorted.map(product => ({
        ...product,
        shipping_type: getShippingTypeLabel(getShippingTypeFromProduct(product))
    }));
}

function analyzePositioning(products, currentProduct) {
    if (!products || products.length === 0) {
        return {
            your_position: null,
            total_competitors: 0,
            best_position: null,
            your_price: null
        };
    }
    
    // Buscar pelo produto atual usando o ml_item_id
    const yourProduct = products.find(p => p.ml_item_id === currentProduct.ml_item_id);
    
    // Encontrar a melhor posi√ß√£o geral
    const positions = products.map(p => parseInt(p.position) || 999);
    const bestPosition = Math.min(...positions);
    
    return {
        your_position: yourProduct ? (parseInt(yourProduct.position) || null) : null,
        total_competitors: products.length - 1,
        best_position: bestPosition,
        your_price: yourProduct ? (parseFloat(yourProduct.price) || null) : null
    };
}

function calculateMetrics(products) {
    const totalPrice = products.reduce((sum, product) => sum + product.price, 0);
    const avgPrice = (totalPrice / products.length).toFixed(2);
    
    return {
        total_announcers: products.length,
        avg_price: avgPrice,
        min_price: (Math.min(...products.map(p => p.price))).toFixed(2),
        max_price: (Math.max(...products.map(p => p.price))).toFixed(2)
    };
}

function analyzeMercadoLider(products) {
    const levels = {};
    products.forEach(product => {
        const level = getMercadoLiderLevel(product);
        levels[level] = (levels[level] || 0) + 1;
    });
    return levels;
}

function analyzePriceRanges(products) {
    const ranges = {};
    products.forEach(product => {
        const range = getPriceRange(product.price);
        ranges[range] = (ranges[range] || 0) + 1;
    });
    return ranges;
}

function getPriceRange(price) {
    if (price <= 10) return 'ate_10';
    if (price <= 20) return '10_20';
    if (price <= 30) return '20_30';
    if (price <= 50) return '30_50';
    if (price <= 100) return '50_100';
    return 'acima_100';
}

function getPriceRangeLabel(range) {
    const labels = {
        'ate_10': 'At√© R$ 10',
        '10_20': 'R$ 10 - R$ 20',
        '20_30': 'R$ 20 - R$ 30',
        '30_50': 'R$ 30 - R$ 50',
        '50_100': 'R$ 50 - R$ 100',
        'acima_100': 'Acima de R$ 100'
    };
    return labels[range] || range;
}

function getPriceRangeBadgeClass(range) {
    const classes = {
        'ate_10': 'bg-success',
        '10_20': 'bg-primary',
        '20_30': 'bg-info',
        '30_50': 'bg-warning',
        '50_100': 'bg-danger',
        'acima_100': 'bg-dark'
    };
    return classes[range] || 'bg-secondary';
}

function getPriceRangeProgressClass(range) {
    const classes = {
        'ate_10': 'bg-success',
        '10_20': 'bg-primary',
        '20_30': 'bg-info',
        '30_50': 'bg-warning',
        '50_100': 'bg-danger',
        'acima_100': 'bg-dark'
    };
    return classes[range] || 'bg-secondary';
}

function getMercadoLiderLevel(product) {
    const status = product.seller_power_seller_status;
    if (!status || status === 'N/A') {
        return 'sem_medalha';
    }
    
    if (status === 'platinum') {
        return 'platinum';
    } else if (status === 'gold') {
        return 'gold';
    } else if (status === 'silver') {
        return 'silver';
    }
    
    return 'sem_medalha';
}

function getMercadoLiderLabel(level) {
    const labels = {
        'platinum': 'ü•á MercadoL√≠der Platinum',
        'gold': 'ü•à MercadoL√≠der Gold',
        'silver': 'ü•â MercadoL√≠der',
        'sem_medalha': '‚ö™ Sem Medalha'
    };
    return labels[level] || level;
}

function getMercadoLiderBadgeClass(level) {
    const classes = {
        'platinum': 'bg-info',
        'gold': 'bg-warning',
        'silver': 'bg-secondary',
        'sem_medalha': 'bg-success text-white'
    };
    return classes[level] || 'bg-secondary';
}

function getMercadoLiderProgressClass(level) {
    const classes = {
        'platinum': 'bg-info',
        'gold': 'bg-warning',
        'silver': 'bg-secondary',
        'sem_medalha': 'bg-success'
    };
    return classes[level] || 'bg-secondary';
}

function loadProfitabilityAnalysis(product) {
    console.log('üí∞ Carregando an√°lise de rentabilidade para produto:', product);
    
    const profitabilityContainer = document.getElementById('profitability-analysis');
    const productPrice = parseFloat(product.price) || 0;
    
    // Simular c√°lculo de rentabilidade baseado no pre√ßo
    // Taxa m√©dia do Mercado Livre ~15%
    const totalFees = productPrice * 0.15;
    const netProfit = productPrice - totalFees;
    const profitMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
    const roi = totalFees > 0 ? (netProfit / totalFees) * 100 : 0;
    
    console.log('üí∞ C√°lculos de rentabilidade:', {
        productPrice,
        totalFees,
        netProfit,
        profitMargin,
        roi
    });
    
    profitabilityContainer.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                    <h6 class="text-muted">Pre√ßo de Venda</h6>
                    <h4 class="text-primary">${formatPrice(productPrice)}</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                    <h6 class="text-muted">Custos Totais</h6>
                    <h4 class="text-danger">${formatPrice(totalFees)}</h4>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center p-3 border rounded">
                    <h6 class="text-muted">Lucro L√≠quido</h6>
                    <h4 class="text-success">${formatPrice(netProfit)}</h4>
                </div>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <div class="d-flex justify-content-between">
                    <span>Margem de Lucro:</span>
                    <strong class="${profitMargin >= 20 ? 'text-success' : profitMargin >= 10 ? 'text-warning' : 'text-danger'}">
                        ${profitMargin.toFixed(1)}%
                    </strong>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-between">
                    <span>ROI:</span>
                    <strong class="${roi >= 50 ? 'text-success' : roi >= 25 ? 'text-warning' : 'text-danger'}">
                        ${roi.toFixed(1)}%
                    </strong>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>An√°lise Estimada:</strong> Baseada em taxa m√©dia do Mercado Livre (~15%).
                Para an√°lise precisa, configure os custos internos do produto.
            </div>
        </div>
    `;
    
    console.log('‚úÖ An√°lise de rentabilidade renderizada com sucesso');
}

async function loadPricingAnalysis(product) {
    console.log('üí∞ Carregando an√°lise de pre√ßos para produto:', product);
    
    // Verificar se o produto tem SKU
    const sku = product.seller_custom_field || product.sku || product.seller_sku;
    
    if (!sku) {
        console.log('‚ö†Ô∏è Produto sem SKU - mostrando mensagem informativa');
        const feesContainer = document.getElementById('marketplace-fees');
        feesContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Produto sem SKU associado</strong><br>
                Para ver a an√°lise completa de pre√ßos, √© necess√°rio associar um SKU interno a este produto.
            </div>
        `;
        return;
    }
    
    console.log('üîç Buscando dados internos para SKU:', sku);
    
    try {
        // Buscar dados do produto interno
        const internalResponse = await fetch(`/api/pricing/analysis/sku/${sku}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('üì° Resposta da an√°lise de pre√ßos:', internalResponse.status);
        const internalData = await internalResponse.json();
        console.log('üìä Dados da an√°lise de pre√ßos recebidos:', internalData);
        
        if (internalData && internalData.success && internalData.analysis && internalData.analysis.internal_product) {
            console.log('‚úÖ Dados internos encontrados, buscando taxas ML...');
            
            // Buscar taxas reais do Mercado Livre
            const mlFeesUrl = `/api/ml-pricing/fees?price=${product.price}&category_id=${product.category_id}&item_id=${product.ml_item_id}`;
            console.log('üîó URL da API ML:', mlFeesUrl);
            
            const mlFeesResponse = await fetch(mlFeesUrl, {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('üì° Status da resposta ML:', mlFeesResponse.status);
            
            let mlFeesData = null;
            if (mlFeesResponse.ok) {
                mlFeesData = await mlFeesResponse.json();
                console.log('üìä Taxas ML obtidas:', mlFeesData);
            } else {
                const errorText = await mlFeesResponse.text();
                console.log('‚ö†Ô∏è Erro ao obter taxas ML:', mlFeesResponse.status, errorText);
            }
            
            // O custo do frete j√° est√° inclu√≠do em mlFeesData.fees.shipping_cost
            
            renderPricingAnalysis(internalData, product, mlFeesData);
        } else {
            console.log('‚ö†Ô∏è Nenhum dado interno encontrado');
            const feesContainer = document.getElementById('marketplace-fees');
            feesContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Produto interno n√£o encontrado</strong><br>
                    SKU "${sku}" n√£o foi encontrado na base de dados interna.
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar an√°lise de pre√ßos:', error);
        const feesContainer = document.getElementById('marketplace-fees');
        feesContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar an√°lise</strong><br>
                N√£o foi poss√≠vel carregar os dados de pre√ßos do produto.
            </div>
        `;
    }
}

function renderPricingAnalysis(data, product, mlFeesData = null) {
    console.log('üé® Renderizando an√°lise de pre√ßos:', data, 'Taxas ML:', mlFeesData);
    
    const feesContainer = document.getElementById('marketplace-fees');
    const internalProduct = data.analysis.internal_product;
    const productPrice = parseFloat(product.price) || 0;
    
    // Calcular valores
    const costPrice = parseFloat(internalProduct.cost_price) || 0;
    const taxPercentage = parseFloat(internalProduct.tax_rate) || 0;
    const marketingPercentage = parseFloat(internalProduct.marketing_cost) || 0;
    const otherCosts = parseFloat(internalProduct.other_costs) || 0;
    const expectedMargin = parseFloat(internalProduct.expected_profit_margin) || 0;
    
    // Calcular valores monet√°rios
    const taxAmount = (productPrice * taxPercentage / 100);
    const marketingAmount = (productPrice * marketingPercentage / 100);
    
    // Custos internos
    const totalInternalCosts = costPrice + taxAmount + marketingAmount + otherCosts;
    
    // Custos do Mercado Livre (usar taxas reais se dispon√≠veis)
    let mlFixedFee, mlPercentageFee, mlShipping, mlAdditionalFees;
    
    if (mlFeesData && mlFeesData.success) {
        // Usar taxas reais da API
        mlFixedFee = parseFloat(mlFeesData.fees.fixed_fee) || 0;
        mlPercentageFee = parseFloat(mlFeesData.fees.percentage_amount) || 0;
        mlShipping = parseFloat(mlFeesData.fees.shipping_cost) || 0;
        mlAdditionalFees = parseFloat(mlFeesData.fees.listing_fee) || 0;
        console.log('‚úÖ Usando taxas reais da API ML:', mlFeesData.fees);
    } else {
        // Usar valores padr√£o como fallback
        if (productPrice < 79.90) {
            mlFixedFee = 6.25;
            mlPercentageFee = productPrice * 0.13;
            mlShipping = 15.0; // Frete para produtos baratos
        } else {
            mlFixedFee = 0;
            mlPercentageFee = productPrice * 0.12;
            mlShipping = 0; // Frete gratuito para produtos >= R$ 79,90
        }
        mlAdditionalFees = 0;
        console.log('‚ö†Ô∏è Usando taxas padr√£o como fallback');
    }
    
    // Total de todos os custos
    const totalAllCosts = totalInternalCosts + mlFixedFee + mlPercentageFee + mlShipping + mlAdditionalFees;
    
    // Lucro final
    const netProfit = productPrice - totalAllCosts;
    const actualMargin = productPrice > 0 ? (netProfit / productPrice) * 100 : 0;
    
    console.log('üí∞ C√°lculos de pre√ßos:', {
        productPrice,
        costPrice,
        taxPercentage,
        taxAmount,
        marketingPercentage,
        marketingAmount,
        otherCosts,
        totalInternalCosts,
        mlFixedFee,
        mlPercentageFee,
        mlShipping,
        mlAdditionalFees,
        totalAllCosts,
        netProfit,
        actualMargin,
        expectedMargin
    });
    
    feesContainer.innerHTML = `
        <div class="list-group list-group-flush">
            <div class="list-group-item d-flex justify-content-between text-success">
                <span>üí∞ Pre√ßo de Venda:</span>
                <span>+R$ ${productPrice.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üì¶ Pre√ßo Custo Produto:</span>
                <span>-R$ ${costPrice.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üì¢ Marketing (${marketingPercentage.toFixed(1)}%):</span>
                <span>-R$ ${marketingAmount.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üíº Outros Custos:</span>
                <span>-R$ ${otherCosts.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üèõÔ∏è Impostos (${taxPercentage.toFixed(1)}%):</span>
                <span>-R$ ${taxAmount.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üè™ Taxa Fixa ML:</span>
                <span>-R$ ${mlFixedFee.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üìä Taxa Percentual ML (${mlFeesData && mlFeesData.success ? mlFeesData.fees.percentage_fee : (productPrice < 79.90 ? 13 : 12)}%):</span>
                <span>-R$ ${mlPercentageFee.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üöö Frete:</span>
                <span>-R$ ${mlShipping.toFixed(2)}</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between text-danger">
                <span>üìã Taxas Adicionais:</span>
                <span>-R$ 0,00</span>
            </div>
            
            <div class="list-group-item d-flex justify-content-between bg-primary text-white">
                <span>üí∞ Lucro Final:</span>
                <span>R$ ${netProfit.toFixed(2)}</span>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="row text-center">
                <div class="col-6">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="text-muted mb-1">Margem Atual</h6>
                            <h5 class="${actualMargin >= expectedMargin ? 'text-success' : 'text-danger'} mb-0">
                                ${actualMargin.toFixed(1)}%
                            </h5>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="text-muted mb-1">Margem Esperada</h6>
                            <h5 class="text-info mb-0">${expectedMargin.toFixed(1)}%</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    `;
    
    console.log('‚úÖ An√°lise de pre√ßos renderizada com sucesso');
}

// Fun√ß√£o para filtrar cat√°logo
async function filterCatalog() {
    const positionFilter = document.getElementById('filter-position').value;
    const priceFilter = document.getElementById('filter-price').value;
    const shippingFilter = document.getElementById('filter-shipping').value;
    const mercadoliderFilter = document.getElementById('filter-mercadolider').value;
    
    console.log('üîç Aplicando filtros:', {
        position: positionFilter,
        price: priceFilter,
        shipping: shippingFilter,
        mercadolider: mercadoliderFilter
    });
    
    // Se n√£o h√° dados originais carregados, carregar primeiro
    if (!window.catalogData || !window.catalogData.catalog_products) {
        console.log('üìä Carregando dados originais para filtro...');
        const currentPath = window.location.pathname;
        const productId = currentPath.split('/').pop();
        
        try {
            const response = await fetch(`/ml/products/api/product/${productId}/catalog/database`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success && data.catalog_products) {
                window.catalogData = data;
            } else {
                console.error('Erro ao carregar dados para filtro:', data.error);
                return;
            }
        } catch (error) {
            console.error('Erro ao carregar dados para filtro:', error);
            return;
        }
    }
    
    // Aplicar filtros no frontend
    let filteredProducts = [...window.catalogData.catalog_products];
    
    // Filtro por posi√ß√£o
    if (positionFilter) {
        console.log('üîç Aplicando filtro de posi√ß√£o:', positionFilter);
        filteredProducts = filteredProducts.filter(product => {
            switch (positionFilter) {
                case '1':
                    return product.position === 1;
                case '2':
                    return product.position === 2;
                case '3':
                    return product.position === 3;
                case 'top3':
                    return product.position >= 1 && product.position <= 3;
                case 'winner':
                    return product.buy_box_winner === true;
                default:
                    return true;
            }
        });
        console.log('üìä Produtos ap√≥s filtro de posi√ß√£o:', filteredProducts.length);
    }
    
    // Filtro por pre√ßo
    if (priceFilter) {
        console.log('üîç Aplicando filtro de pre√ßo:', priceFilter);
        const prices = filteredProducts.map(p => p.price);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const avgPrice = prices.reduce((sum, price) => sum + price, 0) / prices.length;
        
        filteredProducts = filteredProducts.filter(product => {
            switch (priceFilter) {
                case 'lowest':
                    return product.price === minPrice;
                case 'highest':
                    return product.price === maxPrice;
                case 'below_avg':
                    return product.price < avgPrice;
                case 'above_avg':
                    return product.price > avgPrice;
                default:
                    return true;
            }
        });
        console.log('üìä Produtos ap√≥s filtro de pre√ßo:', filteredProducts.length);
    }
    
    // Filtro por envio
    if (shippingFilter) {
        console.log('üîç Aplicando filtro de envio:', shippingFilter);
        filteredProducts = filteredProducts.filter(product => {
            switch (shippingFilter) {
                case 'free':
                    return product.shipping_free === true;
                case 'full':
                    return product.logistic_type === 'fulfillment';
                case 'correios':
                    return product.logistic_type === 'drop_off' || product.logistic_type === 'xd_drop_off';
                case 'mercado_envios':
                    return product.shipping_method === 'me2' || product.logistic_type === 'me2';
                default:
                    return true;
            }
        });
        console.log('üìä Produtos ap√≥s filtro de envio:', filteredProducts.length);
    }
    
    // Filtro por MercadoL√≠der
    if (mercadoliderFilter) {
        console.log('üîç Aplicando filtro de MercadoL√≠der:', mercadoliderFilter);
        filteredProducts = filteredProducts.filter(product => {
            switch (mercadoliderFilter) {
                case 'platinum':
                    return product.seller_power_seller_status === 'platinum';
                case 'gold':
                    return product.seller_power_seller_status === 'gold';
                case 'silver':
                    return product.seller_power_seller_status === 'silver';
                case 'none':
                    return !product.seller_power_seller_status || product.seller_power_seller_status === 'N/A';
                default:
                    return true;
            }
        });
        console.log('üìä Produtos ap√≥s filtro de MercadoL√≠der:', filteredProducts.length);
    }
    
    // Atualizar contador de resultados
    document.getElementById('filter-results').innerHTML = `<small class="text-muted">${filteredProducts.length} resultados</small>`;
    
    // Renderizar tabela filtrada
    renderFilteredTable(filteredProducts);
    
    console.log('‚úÖ Filtros aplicados com sucesso');
}

// Fun√ß√£o para limpar filtros
async function clearFilters() {
    console.log('üßπ Limpando filtros');
    
    // Resetar todos os filtros
    document.getElementById('filter-position').value = '';
    document.getElementById('filter-price').value = '';
    document.getElementById('filter-shipping').value = '';
    document.getElementById('filter-mercadolider').value = '';
    
    // Se n√£o h√° dados originais carregados, carregar primeiro
    if (!window.catalogData || !window.catalogData.catalog_products) {
        console.log('üìä Carregando dados originais para limpeza...');
        const currentPath = window.location.pathname;
        const productId = currentPath.split('/').pop();
        
        try {
            const response = await fetch(`/ml/products/api/product/${productId}/catalog/database`, {
                credentials: 'include'
            });
            const data = await response.json();
            
            if (data.success && data.catalog_products) {
                window.catalogData = data;
            } else {
                console.error('Erro ao carregar dados para limpeza:', data.error);
                return;
            }
        } catch (error) {
            console.error('Erro ao carregar dados para limpeza:', error);
            return;
        }
    }
    
    // Atualizar contador de resultados
    document.getElementById('filter-results').innerHTML = `<small class="text-muted">${window.catalogData.catalog_products.length} resultados</small>`;
    
    // Renderizar tabela original
    renderFilteredTable(window.catalogData.catalog_products);
    
    console.log('‚úÖ Filtros limpos com sucesso');
}

// Fun√ß√£o para renderizar tabela filtrada
function renderFilteredTable(products) {
    console.log('üé® Renderizando tabela filtrada com', products.length, 'produtos');
    
    const tbody = document.querySelector('#catalog-shipping-content tbody');
    if (!tbody) return;
    
    let html = '';
    
    products.forEach(product => {
        const priceFormatted = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(product.price);
        
        // Informa√ß√µes de envio - usar a mesma l√≥gica da fun√ß√£o original
        let shippingInfo = "N√£o dispon√≠vel";
        
        if (product.shipping_free) {
            shippingInfo = '<span class="badge bg-success">Frete Gr√°tis</span>';
        } else if (product.logistic_type && product.logistic_type !== 'default') {
            switch(product.logistic_type) {
                case 'fulfillment':
                    shippingInfo = '<span class="badge bg-primary">Full Mercado Livre</span>';
                    break;
                case 'xd_drop_off':
                case 'drop_off':
                    shippingInfo = '<span class="badge bg-warning">Correios</span>';
                    break;
                case 'cross_docking':
                    shippingInfo = '<span class="badge bg-info">Coleta ML</span>';
                    break;
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = '<span class="badge bg-secondary">Outros</span>';
            }
        } else if (product.shipping_method && product.shipping_method !== 'standard') {
            switch(product.shipping_method) {
                case 'me2':
                    shippingInfo = '<span class="badge bg-info">Mercado Envios</span>';
                    break;
                default:
                    shippingInfo = '<span class="badge bg-secondary">Outros</span>';
            }
        }
        
        // Informa√ß√µes de reputa√ß√£o - usar a mesma l√≥gica da fun√ß√£o original
        let reputationInfo = "";
        if (product.seller_reputation_level && product.seller_reputation_level !== "UNKNOWN") {
            switch(product.seller_reputation_level) {
                case "GREEN":
                    reputationInfo = '<span class="badge bg-success">üü¢ Verde</span>';
                    break;
                case "YELLOW":
                    reputationInfo = '<span class="badge bg-warning">üü° Amarelo</span>';
                    break;
                case "RED":
                    reputationInfo = '<span class="badge bg-danger">üî¥ Vermelho</span>';
                    break;
                default:
                    reputationInfo = '<span class="badge bg-secondary">‚ö™ Neutro</span>';
                    break;
            }
        } else {
            reputationInfo = '<span class="badge bg-light text-dark">‚ùì Desconhecida</span>';
        }
        
        // Loja oficial - usar a mesma l√≥gica da fun√ß√£o original
        const lojaOficialBadge = product.official_store_id ? 
            '<span class="badge bg-info">Sim</span>' : 
            '<span class="badge bg-secondary">N√£o</span>';
        
        // Usar exatamente a mesma estrutura HTML da fun√ß√£o original
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <div class="fw-bold">${(product.seller_name && product.seller_name !== 'N/A') ? product.seller_name : product.seller_id}</div>
                            ${product.seller_nickname && product.seller_nickname !== 'N/A' ? 
                                `<small class="text-muted">${product.seller_nickname}</small>` : ''}
                            <small class="text-muted d-block">${product.ml_item_id}</small>
                        </div>
                    </div>
                </td>
                <td><strong>${priceFormatted}</strong></td>
                <td>${product.seller_transactions_total > 0 ? 
                    `<span class="badge bg-primary">${product.seller_transactions_total}</span>` : 
                    '<span class="badge bg-secondary">0</span>'}</td>
                <td>${product.buy_box_winner ? 
                    '<span class="badge bg-success">üèÜ Vencedor</span>' : 
                    (product.position === 1 ? 
                        '<span class="badge bg-success">ü•á 1¬∫ Lugar</span>' : 
                        (product.position === 2 ? 
                            '<span class="badge bg-secondary">ü•à 2¬∫ Lugar</span>' : 
                            (product.position === 3 ? 
                                '<span class="badge bg-warning">ü•â 3¬∫ Lugar</span>' : 
                                `<span class="badge bg-light text-dark">#${product.position}</span>`)))}</td>
                <td>${shippingInfo}</td>
                <td>${reputationInfo}</td>
                <td>${lojaOficialBadge}</td>
                <td>${(product.original_price && product.original_price > product.price) ? 
                    `<span class="badge bg-success">-${Math.round(((product.original_price - product.price) / product.original_price) * 100)}%</span>` : 
                    ''}</td>
                <td>
                    <a href="${product.permalink}" 
                       target="_blank" 
                       class="btn btn-outline-primary btn-sm"
                       title="Ver an√∫ncio"
                       onclick="console.log('Clicando em: ${product.permalink}')">
                        <i class="bi bi-eye"></i>
                    </a>
                </td>
            </tr>
        `;
    });
    
    // Apenas substituir o conte√∫do do tbody, mantendo toda a estrutura da tabela
    tbody.innerHTML = html;
    
    console.log('‚úÖ Tabela filtrada renderizada com sucesso');
}

function loadShippingCosts(product) {
    // Simular carregamento de custos de envio
    setTimeout(() => {
        const shippingContainer = document.getElementById('catalog-shipping-content');
        if (shippingContainer) {
            shippingContainer.innerHTML = `
            <div class="mb-3">
                <label class="form-label">CEP de Destino:</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="destination-zip" placeholder="00000-000">
                    <button class="btn btn-outline-primary" onclick="calculateShipping()">
                        <i class="bi bi-calculator"></i> Calcular
                    </button>
                </div>
            </div>
            <div id="shipping-results" class="d-none">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Selecione um CEP para calcular os custos de envio.
                </div>
            </div>
        `;
        }
    }, 1500);
}

function calculateShipping() {
    const zipCode = document.getElementById('destination-zip').value;
    if (!zipCode) {
        alert('Por favor, digite um CEP v√°lido');
        return;
    }
    
    const productId = window.location.pathname.split('/').pop();
    const resultsContainer = document.getElementById('shipping-results');
    
    // Mostrar loading
    resultsContainer.classList.remove('d-none');
    resultsContainer.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Calculando...</span>
            </div>
            <p class="mt-2 mb-0">Calculando custos de envio...</p>
        </div>
    `;
    
    // Buscar op√ß√µes de envio reais
    fetch(`/ml/products/api/product/${productId}/shipping?zip_code=${zipCode}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.shipping.success) {
                renderShippingOptions(data.shipping.data, zipCode);
            } else {
                showShippingError(data.shipping?.error || 'Erro ao calcular envio');
            }
        })
        .catch(error => {
            console.error('Erro ao calcular envio:', error);
            showShippingError('Erro de conex√£o');
        });
}

function renderShippingOptions(shippingData, zipCode) {
    const resultsContainer = document.getElementById('shipping-results');
    
    if (!shippingData.options || shippingData.options.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Nenhuma op√ß√£o de envio encontrada para o CEP ${zipCode}.
            </div>
        `;
        return;
    }
    
    let optionsHtml = `
        <div class="alert alert-success">
            <i class="bi bi-check-circle"></i>
            <strong>Op√ß√µes de envio para CEP ${zipCode}</strong>
        </div>
        <div class="row">
    `;
    
    shippingData.options.forEach(option => {
        const cost = option.cost || 0;
        const listCost = option.list_cost || 0;
        const name = option.name || 'Op√ß√£o de Envio';
        const isFree = cost === 0;
        
        optionsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${name}</h6>
                        <div class="d-flex justify-content-between">
                            <span>Custo:</span>
                            <strong class="${isFree ? 'text-success' : 'text-primary'}">
                                ${isFree ? 'GR√ÅTIS' : formatPrice(cost)}
                            </strong>
                        </div>
                        ${listCost > 0 ? `
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Custo original:</small>
                                <small class="text-muted">${formatPrice(listCost)}</small>
                            </div>
                        ` : ''}
                        ${option.estimated_delivery_time ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i>
                                    Entrega: ${option.estimated_delivery_time.shipping || 'N/A'}h
                                </small>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    optionsHtml += '</div>';
    resultsContainer.innerHTML = optionsHtml;
}

function showShippingError(message) {
    const resultsContainer = document.getElementById('shipping-results');
    resultsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Erro ao calcular envio:</strong> ${message}
        </div>
    `;
}

function showError(message) {
    document.getElementById('loading-state').classList.add('d-none');
    document.getElementById('analysis-content').classList.add('d-none');
    document.getElementById('error-state').classList.remove('d-none');
    document.getElementById('error-message').textContent = message;
}

function formatPrice(price, currency = 'BRL') {
    // Converter para n√∫mero
    const numericPrice = typeof price === 'string' ? parseFloat(price) : price;
    
    // Se n√£o for um n√∫mero v√°lido, retornar R$ 0,00
    if (isNaN(numericPrice) || numericPrice === null || numericPrice === undefined) {
        return 'R$ 0,00';
    }
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(numericPrice);
}

// Fun√ß√£o para sincronizar cat√°logo
// Sales Analysis Functions
function loadSalesAnalysis(product) {
    console.log('üìä Carregando an√°lise de vendas para produto:', product);
    
    // Carregar an√°lise do produto (aba ativa por padr√£o)
    loadProductSalesAnalysis(product);
    
    // Configurar eventos das abas
    setupSalesAnalysisTabs(product);
}

function setupSalesAnalysisTabs(product) {
    // Event listener para aba "An√°lise do Produto"
    document.getElementById('product-analysis-tab').addEventListener('click', function() {
        loadProductSalesAnalysis(product);
    });
    
    // Event listener para aba "Vendas pelo SKU"
    document.getElementById('sku-sales-tab').addEventListener('click', function() {
        loadSkuSalesAnalysis(product);
    });
}

async function loadProductSalesAnalysis(product) {
    console.log('üì¶ Carregando an√°lise do produto:', product);
    
    const contentContainer = document.getElementById('product-analysis-content');
    
    try {
        // Mostrar loading
        contentContainer.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 mb-0">Carregando an√°lise do produto...</p>
            </div>
        `;
        
        // Buscar dados de vendas por ML item ID e company_id
        const response = await fetch(`/api/sales/analysis/product/${product.ml_item_id}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Dados de an√°lise do produto recebidos:', data);
        
        renderProductSalesAnalysis(data, product);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar an√°lise do produto:', error);
        contentContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar an√°lise do produto:</strong><br>
                ${error.message}
            </div>
        `;
    }
}

async function loadSkuSalesAnalysis(product) {
    console.log('üìà Carregando vendas por SKU:', product);
    
    const contentContainer = document.getElementById('sku-sales-content');
    
    // Verificar se o produto tem SKU
    const sku = product.seller_custom_field || product.sku || product.seller_sku;
    
    if (!sku) {
        contentContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Produto sem SKU associado</strong><br>
                Este produto n√£o possui SKU configurado para an√°lise de vendas.
            </div>
        `;
        return;
    }
    
    try {
        // Mostrar loading
        contentContainer.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 mb-0">Carregando vendas por SKU...</p>
            </div>
        `;
        
        // Buscar dados de vendas por SKU e company_id
        const response = await fetch(`/api/sales/analysis/sku/${encodeURIComponent(sku)}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìä Dados de vendas por SKU recebidos:', data);
        
        renderSkuSalesAnalysis(data, sku);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar vendas por SKU:', error);
        contentContainer.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Erro ao carregar vendas por SKU:</strong><br>
                ${error.message}
            </div>
        `;
    }
}

function renderProductSalesAnalysis(data, product) {
    console.log('üé® Renderizando an√°lise do produto:', data);
    
    const contentContainer = document.getElementById('product-analysis-content');
    
    if (!data || !data.success) {
        contentContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i>
                <strong>Nenhum dado encontrado</strong><br>
                N√£o foram encontrados dados de vendas para este produto.
            </div>
        `;
        return;
    }
    
    const analysis = data.analysis || {};
    const stats = analysis.stats || {};
    
    contentContainer.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Estat√≠sticas Gerais</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary mb-0">${stats.total_orders || 0}</h4>
                                    <small class="text-muted">Total de Pedidos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success mb-0">${stats.total_quantity || 0}</h4>
                                <small class="text-muted">Quantidade Vendida</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-12">
                                <h4 class="text-warning mb-0">R$ ${(stats.total_revenue || 0).toFixed(2)}</h4>
                                <small class="text-muted">Receita Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Pre√ßos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h5 class="text-success mb-0">R$ ${(stats.avg_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Pre√ßo M√©dio</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-info mb-0">R$ ${(stats.min_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Pre√ßo M√≠nimo</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger mb-0">R$ ${(stats.max_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Pre√ßo M√°ximo</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> √öltimos Pedidos</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>Comprador</th>
                                        <th>Pre√ßo</th>
                                        <th>Qtd</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(analysis.recent_orders || []).map(order => `
                                        <tr>
                                            <td>${new Date(order.date_created).toLocaleDateString('pt-BR')}</td>
                                            <td>${order.buyer_nickname || 'N/A'}</td>
                                            <td>R$ ${order.unit_price.toFixed(2)}</td>
                                            <td>${order.quantity}</td>
                                            <td><span class="badge ${order.status === 'PAID' ? 'bg-success' : 'bg-warning'}">${order.status}</span></td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="5" class="text-center text-muted">Nenhum pedido encontrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderSkuSalesAnalysis(data, sku) {
    console.log('üé® Renderizando vendas por SKU:', data);
    
    const contentContainer = document.getElementById('sku-sales-content');
    
    if (!data || !data.success) {
        contentContainer.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-info-circle"></i>
                <strong>Nenhum dado encontrado</strong><br>
                N√£o foram encontrados dados de vendas para o SKU "${sku}".
            </div>
        `;
        return;
    }
    
    const analysis = data.analysis || {};
    const stats = analysis.stats || {};
    
    contentContainer.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>SKU Analisado:</strong> ${sku}
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Estat√≠sticas por SKU</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h4 class="text-primary mb-0">${stats.total_orders || 0}</h4>
                                    <small class="text-muted">Total de Pedidos</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h4 class="text-success mb-0">${stats.total_quantity || 0}</h4>
                                <small class="text-muted">Quantidade Vendida</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-12">
                                <h4 class="text-warning mb-0">R$ ${(stats.total_revenue || 0).toFixed(2)}</h4>
                                <small class="text-muted">Receita Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> An√°lise de Pre√ßos</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-4">
                                <h5 class="text-success mb-0">R$ ${(stats.avg_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Pre√ßo M√©dio</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-info mb-0">R$ ${(stats.min_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Pre√ßo M√≠nimo</small>
                            </div>
                            <div class="col-4">
                                <h5 class="text-danger mb-0">R$ ${(stats.max_price || 0).toFixed(2)}</h5>
                                <small class="text-muted">Pre√ßo M√°ximo</small>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <h6 class="text-muted">Status dos Pedidos</h6>
                            <div class="d-flex justify-content-around">
                                <span class="badge bg-success">${stats.paid_orders || 0} PAGOS</span>
                                <span class="badge bg-warning">${stats.cancelled_orders || 0} CANCELADOS</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Hist√≥rico de Vendas</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Data</th>
                                        <th>ID do Pedido</th>
                                        <th>Comprador</th>
                                        <th>Pre√ßo Unit.</th>
                                        <th>Qtd</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(analysis.orders || []).map(order => `
                                        <tr>
                                            <td>${new Date(order.date_created).toLocaleDateString('pt-BR')}</td>
                                            <td><small class="text-muted">${order.ml_order_id}</small></td>
                                            <td>${order.buyer_nickname || 'N/A'}</td>
                                            <td>R$ ${order.unit_price.toFixed(2)}</td>
                                            <td>${order.quantity}</td>
                                            <td>R$ ${(order.unit_price * order.quantity).toFixed(2)}</td>
                                            <td><span class="badge ${order.status === 'PAID' ? 'bg-success' : 'bg-warning'}">${order.status}</span></td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="7" class="text-center text-muted">Nenhum pedido encontrado</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function syncCatalog() {
    console.log('syncCatalog chamada');
    const productId = window.location.pathname.split('/').pop();
    const syncBtn = document.getElementById('sync-catalog-btn');
    
    if (!syncBtn) {
        console.error('Bot√£o sync-catalog-btn n√£o encontrado!');
        return;
    }
    
    const originalText = syncBtn.innerHTML;
    
    // Mostrar loading
    syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Sincronizando...';
    syncBtn.disabled = true;
    
    fetch(`/ml/products/api/product/${productId}/catalog/sync`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (handleSessionError(null, data)) return;
        if (data.success) {
            // Mostrar sucesso
            syncBtn.innerHTML = '<i class="bi bi-check-circle"></i> Sincronizado!';
            syncBtn.classList.remove('btn-outline-success');
            syncBtn.classList.add('btn-success');
            
            // Recarregar dados do cat√°logo do banco
            setTimeout(() => {
                loadCatalogInfo(productId);
            }, 1000);
            
            // Restaurar bot√£o ap√≥s 3 segundos
            setTimeout(() => {
                syncBtn.innerHTML = originalText;
                syncBtn.classList.remove('btn-success');
                syncBtn.classList.add('btn-outline-success');
                syncBtn.disabled = false;
            }, 3000);
        } else {
            throw new Error(data.error || 'Erro na sincroniza√ß√£o');
        }
    })
    .catch(error => {
        console.error('Erro ao sincronizar cat√°logo:', error);
        syncBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erro';
        syncBtn.classList.remove('btn-outline-success');
        syncBtn.classList.add('btn-danger');
        
        // Restaurar bot√£o ap√≥s 3 segundos
        setTimeout(() => {
            syncBtn.innerHTML = originalText;
            syncBtn.classList.remove('btn-danger');
            syncBtn.classList.add('btn-outline-success');
            syncBtn.disabled = false;
        }, 3000);
    });
}

// Fun√ß√£o global para tratar erros de sess√£o
function handleSessionError(response, data) {
    if (response && response.status === 401) {
        // Sess√£o expirada - redirecionar para login
        window.location.href = '/auth/login';
        return true;
    }
    if (data && data.detail === "Sess√£o n√£o encontrada") {
        // Sess√£o inv√°lida - redirecionar para login
        window.location.href = '/auth/login';
        return true;
    }
    return false;
}

// CSS para anima√ß√£o de loading
const style = document.createElement('style');
style.textContent = `
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);

</script>
{% endblock %}