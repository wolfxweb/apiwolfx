{% extends "base.html" %}

{% block title %}Contas a Pagar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-arrow-up-circle text-danger"></i> Contas a Pagar</h2>
                    <p class="text-muted">Gerencie suas contas a pagar e despesas</p>
                </div>
                <a href="/financial/payables/nova" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Nova Conta a Pagar
                </a>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Busca -->
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Fornecedor, descri√ß√£o, NF..." onkeyup="filterPayables()">
                        </div>
                        
                        <!-- Status -->
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter" onchange="filterPayables()">
                                <option value="">Todos</option>
                                <option value="pending">Pendente</option>
                                <option value="paid">Pago</option>
                                <option value="overdue">Vencido</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        
                        <!-- Categoria -->
                        <div class="col-md-2">
                            <label for="categoryFilter" class="form-label">Categoria</label>
                            <select class="form-select" id="categoryFilter" onchange="filterPayables()">
                                <option value="">Todas</option>
                            </select>
                        </div>
                        
                        <!-- Centro de Custo -->
                        <div class="col-md-2">
                            <label for="costCenterFilter" class="form-label">Centro de Custo</label>
                            <select class="form-select" id="costCenterFilter" onchange="filterPayables()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        
                        <!-- Per√≠odo -->
                        <div class="col-md-2">
                            <label for="periodFilter" class="form-label">Per√≠odo</label>
                            <select class="form-select" id="periodFilter" onchange="toggleCustomPeriod(); filterPayables();">
                                <option value="">Todos</option>
                                <option value="today">Hoje</option>
                                <option value="this_week">Esta semana</option>
                                <option value="this_month" selected>Este m√™s</option>
                                <option value="last_month">M√™s anterior</option>
                                <option value="next_month">Pr√≥ximo m√™s</option>
                                <option value="next_30_days">Pr√≥ximos 30 dias</option>
                                <option value="next_60_days">Pr√≥ximos 60 dias</option>
                                <option value="next_90_days">Pr√≥ximos 90 dias</option>
                                <option value="this_year">Este ano</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <!-- A√ß√µes -->
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()" style="white-space: nowrap;">
                                    <i class="bi bi-x-circle"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Per√≠odo personalizado (oculto por padr√£o) -->
                    <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
                        <div class="col-md-3">
                            <label for="dueDateFrom" class="form-label">Data inicial</label>
                            <input type="date" class="form-control" id="dueDateFrom" onchange="filterPayables()">
                        </div>
                        <div class="col-md-3">
                            <label for="dueDateTo" class="form-label">Data final</label>
                            <input type="date" class="form-control" id="dueDateTo" onchange="filterPayables()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estat√≠sticas R√°pidas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total a Pagar</h6>
                                    <div class="d-flex align-items-center">
                                        <div id="totalAmountSpinner" class="spinner-border spinner-border-sm text-light me-2" role="status"></div>
                                        <h4 class="mb-0 d-none" id="totalAmount">R$ 0,00</h4>
                                    </div>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-arrow-up-circle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Pago</h6>
                                    <div class="d-flex align-items-center">
                                        <div id="paidAmountSpinner" class="spinner-border spinner-border-sm text-light me-2" role="status"></div>
                                        <h4 class="mb-0 d-none" id="paidAmount">R$ 0,00</h4>
                                    </div>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-check-circle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Vencido</h6>
                                    <div class="d-flex align-items-center">
                                        <div id="overdueAmountSpinner" class="spinner-border spinner-border-sm text-light me-2" role="status"></div>
                                        <h4 class="mb-0 d-none" id="overdueAmount">R$ 0,00</h4>
                                    </div>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-exclamation-triangle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white stats-card" style="background-color: #FF8C00;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Pendente</h6>
                                    <div class="d-flex align-items-center">
                                        <div id="pendingAmountSpinner" class="spinner-border spinner-border-sm text-light me-2" role="status"></div>
                                        <h4 class="mb-0 d-none" id="pendingAmount">R$ 0,00</h4>
                                    </div>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-clock fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fornecedor</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Categoria</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="payablesTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagina√ß√£o -->
                    <nav aria-label="Pagina√ß√£o de contas a pagar">
                        <ul class="pagination justify-content-center" id="payablesPagination">
                            <!-- Pagina√ß√£o ser√° inserida via JavaScript -->
                        </ul>
                    </nav>
                    
                    <!-- Contadores -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <small class="text-muted">
                                Mostrando <span id="payablesShowing">0</span> de <span id="payablesTotal">0</span> contas a pagar
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o para Exclus√£o -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="deleteModalBody">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                <div id="deleteInstallmentOptions" style="display: none;" class="mt-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="deleteFutureInstallments" value="true">
                        <label class="form-check-label" for="deleteFutureInstallments">
                            <strong>Excluir parcelas futuras</strong>
                        </label>
                        <small class="form-text text-muted d-block">
                            Se marcado, todas as parcelas futuras desta conta parcelada tamb√©m ser√£o exclu√≠das
                        </small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o para Pagamento -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Confirmar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="paymentModalBody">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmPaymentBtn" onclick="confirmPayment()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let payables = [];
let filteredPayables = [];
let currentDeleteId = null;
let currentPaymentId = null;
let currentPaymentAction = null; // 'mark_paid' ou 'mark_pending'
let currentPage = 1;
let itemsPerPage = 10;

// Carregar dados ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadCostCenters();
    loadPayables();
});

// Fun√ß√£o para carregar categorias
async function loadCategories() {
    try {
        const response = await fetch('/api/financial/categories', {
            credentials: 'include'
        });
        if (response.ok) {
            const categories = await response.json();
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Todas</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categoryFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

// Fun√ß√£o para carregar centros de custo
async function loadCostCenters() {
    try {
        const response = await fetch('/api/financial/cost-centers', {
            credentials: 'include'
        });
        if (response.ok) {
            const costCenters = await response.json();
            const costCenterFilter = document.getElementById('costCenterFilter');
            costCenterFilter.innerHTML = '<option value="">Todos</option>';
            costCenters.forEach(costCenter => {
                const option = document.createElement('option');
                option.value = costCenter.id;
                option.textContent = costCenter.name;
                costCenterFilter.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erro ao carregar centros de custo:', error);
    }
}

// Fun√ß√£o para carregar contas a pagar
async function loadPayables() {
    try {
        const response = await fetch('/api/financial/payables', {
            credentials: 'include'
        });
        if (response.ok) {
            payables = await response.json();
            filteredPayables = [...payables];
            
            // Aplicar filtro do m√™s atual automaticamente
            console.log('üîç Aplicando filtro autom√°tico do m√™s atual...');
            filterPayables();
        } else {
            showAlert('Erro ao carregar contas a pagar', 'danger');
        }
    } catch (error) {
        console.error('Erro ao carregar contas a pagar:', error);
        showAlert('Erro ao carregar contas a pagar', 'danger');
    }
}

// Fun√ß√£o para renderizar tabela
function renderPayablesTable() {
    const tbody = document.getElementById('payablesTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pagePayables = filteredPayables.slice(startIndex, endIndex);
    
    if (pagePayables.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">Nenhuma conta a pagar encontrada</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pagePayables.map(payable => `
            <tr>
                <td>${payable.supplier_name || 'N/A'}</td>
                <td>${payable.description}</td>
                <td>R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>${new Date(payable.due_date).toLocaleDateString('pt-BR')}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(payable.status)}">
                        ${getStatusText(payable.status)}
                    </span>
                </td>
                <td>${payable.category_name || 'N/A'}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editPayable(${payable.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="markAsPaid(${payable.id})" title="Marcar como Pago" ${payable.status === 'paid' ? 'disabled' : ''}>
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="markAsPending(${payable.id})" title="Marcar como Pendente" ${payable.status === 'pending' ? 'disabled' : ''}>
                            <i class="bi bi-clock"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayable(${payable.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // Atualizar contadores
    document.getElementById('payablesShowing').textContent = pagePayables.length;
    document.getElementById('payablesTotal').textContent = filteredPayables.length;
}

// Fun√ß√£o para renderizar pagina√ß√£o
function renderPagination() {
    const pagination = document.getElementById('payablesPagination');
    const totalPages = Math.ceil(filteredPayables.length / itemsPerPage);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Bot√£o Anterior
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    paginationHTML += `
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
        </li>
    `;
    
    // N√∫meros das p√°ginas
    for (let i = 1; i <= totalPages; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        paginationHTML += `
            <li class="page-item ${activeClass}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Bot√£o Pr√≥xima
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    paginationHTML += `
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Pr√≥xima</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Fun√ß√£o para mudar p√°gina
function changePage(page) {
    const totalPages = Math.ceil(filteredPayables.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderPayablesTable();
        renderPagination();
    }
}

// Fun√ß√£o para aplicar filtros
function applyFilters() {
    filterPayables();
}

// Fun√ß√£o para mostrar/ocultar per√≠odo personalizado
function toggleCustomPeriod() {
    const periodFilter = document.getElementById('periodFilter').value;
    const customPeriodRow = document.getElementById('customPeriodRow');
    
    if (periodFilter === 'custom') {
        customPeriodRow.style.display = 'block';
    } else {
        customPeriodRow.style.display = 'none';
    }
}

// Fun√ß√£o para filtrar contas a pagar
function filterPayables() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const costCenterFilter = document.getElementById('costCenterFilter').value;
    const periodFilter = document.getElementById('periodFilter').value;
    const dueDateFrom = document.getElementById('dueDateFrom').value;
    const dueDateTo = document.getElementById('dueDateTo').value;
    
    console.log('üîç Filtros aplicados:', {
        searchTerm,
        statusFilter,
        categoryFilter,
        costCenterFilter,
        periodFilter,
        dueDateFrom,
        dueDateTo
    });
    
    // Mostrar spinners enquanto filtramos e recalculamos
    setStatsLoading(true);
    filteredPayables = payables.filter(payable => {
        // Filtro de busca
        const matchesSearch = !searchTerm || 
            payable.description.toLowerCase().includes(searchTerm) ||
            (payable.supplier_name && payable.supplier_name.toLowerCase().includes(searchTerm)) ||
            (payable.ordem_compra_numero && payable.ordem_compra_numero.toLowerCase().includes(searchTerm));
        
        // Filtro de status
        const matchesStatus = !statusFilter || payable.status === statusFilter;
        
        // Filtro de categoria
        const matchesCategory = !categoryFilter || payable.category_id == categoryFilter;
        
        // Filtro de centro de custo
        const matchesCostCenter = !costCenterFilter || payable.cost_center_id == costCenterFilter;
        
        // Filtro de per√≠odo
        let matchesPeriod = true;
        if (periodFilter && payable.due_date) {
            const dueDate = new Date(payable.due_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            switch (periodFilter) {
                case 'today':
                    matchesPeriod = dueDate.toDateString() === today.toDateString();
                    break;
                case 'this_week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    matchesPeriod = dueDate >= startOfWeek && dueDate <= endOfWeek;
                    break;
                case 'this_month':
                    matchesPeriod = dueDate.getMonth() === today.getMonth() && dueDate.getFullYear() === today.getFullYear();
                    break;
                case 'last_month':
                    const lastMonth = new Date(today);
                    lastMonth.setMonth(today.getMonth() - 1);
                    matchesPeriod = dueDate.getMonth() === lastMonth.getMonth() && dueDate.getFullYear() === lastMonth.getFullYear();
                    break;
                case 'next_month':
                    const nextMonth = new Date(today);
                    nextMonth.setMonth(today.getMonth() + 1);
                    matchesPeriod = dueDate.getMonth() === nextMonth.getMonth() && dueDate.getFullYear() === nextMonth.getFullYear();
                    break;
                case 'next_30_days':
                    const next30Days = new Date(today);
                    next30Days.setDate(today.getDate() + 30);
                    matchesPeriod = dueDate >= today && dueDate <= next30Days;
                    break;
                case 'next_60_days':
                    const next60Days = new Date(today);
                    next60Days.setDate(today.getDate() + 60);
                    matchesPeriod = dueDate >= today && dueDate <= next60Days;
                    break;
                case 'next_90_days':
                    const next90Days = new Date(today);
                    next90Days.setDate(today.getDate() + 90);
                    matchesPeriod = dueDate >= today && dueDate <= next90Days;
                    break;
                case 'this_year':
                    matchesPeriod = dueDate.getFullYear() === today.getFullYear();
                    break;
                case 'custom':
                    matchesPeriod = (!dueDateFrom || payable.due_date >= dueDateFrom) && 
                                   (!dueDateTo || payable.due_date <= dueDateTo);
                    break;
            }
        }
        
        return matchesSearch && matchesStatus && matchesCategory && matchesCostCenter && matchesPeriod;
    });
    
    // Reset para primeira p√°gina
    currentPage = 1;
    renderPayablesTable();
    renderPagination();
    updateStats();
}

// Fun√ß√£o para limpar filtros
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('costCenterFilter').value = '';
    document.getElementById('periodFilter').value = '';
    document.getElementById('dueDateFrom').value = '';
    document.getElementById('dueDateTo').value = '';
    
    // Ocultar per√≠odo personalizado
    document.getElementById('customPeriodRow').style.display = 'none';
    
    filterPayables();
}

// Controla exibi√ß√£o de spinners nos cards de estat√≠sticas
function setStatsLoading(isLoading) {
    const pairs = [
        { spinner: 'totalAmountSpinner', value: 'totalAmount' },
        { spinner: 'paidAmountSpinner', value: 'paidAmount' },
        { spinner: 'overdueAmountSpinner', value: 'overdueAmount' },
        { spinner: 'pendingAmountSpinner', value: 'pendingAmount' },
    ];
    pairs.forEach(p => {
        const sp = document.getElementById(p.spinner);
        const val = document.getElementById(p.value);
        if (!sp || !val) return;
        if (isLoading) {
            sp.classList.remove('d-none');
            val.classList.add('d-none');
        } else {
            sp.classList.add('d-none');
            val.classList.remove('d-none');
        }
    });
}

// Fun√ß√£o para obter classe do badge de status
function getStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'bg-warning';
        case 'paid': return 'bg-success';
        case 'overdue': return 'bg-danger';
        case 'cancelled': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

// Fun√ß√£o para obter texto do status
function getStatusText(status) {
    switch (status) {
        case 'pending': return 'Pendente';
        case 'paid': return 'Pago';
        case 'overdue': return 'Vencido';
        case 'cancelled': return 'Cancelado';
        default: return 'Desconhecido';
    }
}

// Fun√ß√£o para editar conta a pagar
function editPayable(id) {
    // Redirecionar para p√°gina de edi√ß√£o (implementar se necess√°rio)
    showAlert('Funcionalidade de edi√ß√£o ser√° implementada em breve', 'info');
}

// Fun√ß√£o para marcar como pago
async function markAsPaid(id) {
    try {
        const response = await fetch(`/api/financial/payables/${id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: 'paid'
            })
        });
        
        if (response.ok) {
            showAlert('Conta marcada como paga com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao marcar como pago', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao marcar como pago', 'danger');
    }
}

// Fun√ß√£o para marcar como pendente
async function markAsPending(id) {
    try {
        const response = await fetch(`/api/financial/payables/${id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: 'pending'
            })
        });
        
        if (response.ok) {
            showAlert('Conta marcada como pendente com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao marcar como pendente', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao marcar como pendente', 'danger');
    }
}

// Fun√ß√£o para confirmar pagamento
async function confirmPayment() {
    if (!currentPaymentId || !currentPaymentAction) return;
    
    try {
        const response = await fetch(`/api/financial/payables/${currentPaymentId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: currentPaymentAction === 'mark_paid' ? 'paid' : 'pending'
            })
        });
        
        if (response.ok) {
            showAlert('Status da conta atualizado com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao atualizar status', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao atualizar status', 'danger');
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
}

// Fun√ß√£o para editar conta a pagar
function editPayable(id) {
    window.location.href = `/financial/payables/editar/${id}`;
}

// Fun√ß√£o para excluir conta a pagar
function deletePayable(id) {
    currentDeleteId = id;
    
    const payable = payables.find(p => p.id === id);
    
    // Verificar se √© uma conta parcelada
    const isInstallment = payable.total_installments && payable.total_installments > 1;
    
    document.getElementById('deleteModalBody').innerHTML = `
        <p>Tem certeza que deseja excluir esta conta a pagar?</p>
        <div class="alert alert-danger">
            <strong>Conta:</strong> ${payable.description}<br>
            <strong>Valor:</strong> R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
            <strong>Fornecedor:</strong> ${payable.supplier_name || 'N/A'}
            ${isInstallment ? `<br><strong>Parcelamento:</strong> ${payable.installment_number || 1}/${payable.total_installments} parcelas` : ''}
        </div>
        <p class="text-danger"><strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!</p>
    `;
    
    // Mostrar op√ß√£o de parcelas futuras se for uma conta parcelada
    const installmentOptions = document.getElementById('deleteInstallmentOptions');
    if (isInstallment) {
        installmentOptions.style.display = 'block';
        // Resetar checkbox
        document.getElementById('deleteFutureInstallments').checked = false;
    } else {
        installmentOptions.style.display = 'none';
    }
    
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Fun√ß√£o para confirmar exclus√£o
async function confirmDelete() {
    if (!currentDeleteId) return;
    
    // Desabilitar bot√£o para evitar duplo clique
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...';
    
    try {
        // Verificar se deve excluir parcelas futuras
        const deleteFutureInstallments = document.getElementById('deleteFutureInstallments').checked;
        
        const response = await fetch(`/api/financial/payables/${currentDeleteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                remove_future_entries: deleteFutureInstallments
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            const message = result.deleted_count && result.deleted_count > 1 
                ? `${result.deleted_count} contas exclu√≠das com sucesso!`
                : 'Conta a pagar exclu√≠da com sucesso!';
            showAlert(message, 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao excluir conta', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao excluir conta', 'danger');
    } finally {
        // Reabilitar bot√£o
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
}

// Fun√ß√£o para mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remover automaticamente ap√≥s 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Fun√ß√£o para atualizar estat√≠sticas
function updateStats() {
    // Usar dados filtrados (filteredPayables sempre cont√©m os dados corretos ap√≥s filtro)
    const dataToUse = filteredPayables;
    
    if (!dataToUse || dataToUse.length === 0) {
    // Mostrar spinners e ocultar valores
    setStatsLoading(true);
        return;
    }
    
    let totalAmount = 0;
    let paidAmount = 0;
    let overdueAmount = 0;
    let pendingAmount = 0;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    dataToUse.forEach(payable => {
        const amount = parseFloat(payable.amount) || 0;
        totalAmount += amount;
        
        if (payable.status === 'paid') {
            paidAmount += amount;
        } else if (payable.status === 'overdue') {
            overdueAmount += amount;
        } else if (payable.status === 'pending') {
            pendingAmount += amount;
        }
    });
    
    document.getElementById('totalAmount').textContent = `R$ ${totalAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('paidAmount').textContent = `R$ ${paidAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('overdueAmount').textContent = `R$ ${overdueAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('pendingAmount').textContent = `R$ ${pendingAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    // Esconder spinners e mostrar valores
    setStatsLoading(false);
}
</script>
{% endblock %}