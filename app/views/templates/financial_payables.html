{% extends "base.html" %}

{% block title %}Contas a Pagar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-arrow-up-circle text-danger"></i> Contas a Pagar</h2>
                    <p class="text-muted">Gerencie suas contas a pagar e despesas</p>
                </div>
                <a href="/financial/payables/nova" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Nova Conta a Pagar
                </a>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Buscar por descrição, fornecedor..." onkeyup="filterPayables()">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter" onchange="filterPayables()">
                                <option value="">Todos os Status</option>
                                <option value="pending">Pendente</option>
                                <option value="paid">Pago</option>
                                <option value="overdue">Vencido</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" id="supplierFilter" placeholder="Filtrar por fornecedor" onkeyup="filterPayables()">
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="dueDateFrom" placeholder="Vencimento de" onchange="filterPayables()">
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="dueDateTo" placeholder="Vencimento até" onchange="filterPayables()">
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()" title="Limpar filtros">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas Rápidas -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Total a Pagar</h6>
                                    <h4 class="mb-0" id="totalAmount">R$ 0,00</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-arrow-up-circle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Pago</h6>
                                    <h4 class="mb-0" id="paidAmount">R$ 0,00</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-check-circle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Vencido</h6>
                                    <h4 class="mb-0" id="overdueAmount">R$ 0,00</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-exclamation-triangle fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info stats-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h6 class="card-title">Pendente</h6>
                                    <h4 class="mb-0" id="pendingAmount">R$ 0,00</h4>
                                </div>
                                <div class="align-self-center">
                                    <i class="bi bi-clock fs-1"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fornecedor</th>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Categoria</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="payablesTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <nav aria-label="Paginação de contas a pagar">
                        <ul class="pagination justify-content-center" id="payablesPagination">
                            <!-- Paginação será inserida via JavaScript -->
                        </ul>
                    </nav>
                    
                    <!-- Contadores -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <small class="text-muted">
                                Mostrando <span id="payablesShowing">0</span> de <span id="payablesTotal">0</span> contas a pagar
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="deleteModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Pagamento -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Confirmar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="paymentModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmPaymentBtn" onclick="confirmPayment()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let payables = [];
let filteredPayables = [];
let currentDeleteId = null;
let currentPaymentId = null;
let currentPaymentAction = null; // 'mark_paid' ou 'mark_pending'
let currentPage = 1;
let itemsPerPage = 10;

// Carregar dados ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadPayables();
});

// Função para carregar contas a pagar
async function loadPayables() {
    try {
        const response = await fetch('/api/financial/payables', {
            credentials: 'include'
        });
        if (response.ok) {
            payables = await response.json();
            filteredPayables = [...payables];
            renderPayablesTable();
            renderPagination();
            updateStats();
        } else {
            showAlert('Erro ao carregar contas a pagar', 'danger');
        }
    } catch (error) {
        console.error('Erro ao carregar contas a pagar:', error);
        showAlert('Erro ao carregar contas a pagar', 'danger');
    }
}

// Função para renderizar tabela
function renderPayablesTable() {
    const tbody = document.getElementById('payablesTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pagePayables = filteredPayables.slice(startIndex, endIndex);
    
    if (pagePayables.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">Nenhuma conta a pagar encontrada</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pagePayables.map(payable => `
            <tr>
                <td>${payable.supplier_name || 'N/A'}</td>
                <td>${payable.description}</td>
                <td>R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                <td>${new Date(payable.due_date).toLocaleDateString('pt-BR')}</td>
                <td>
                    <span class="badge ${getStatusBadgeClass(payable.status)}">
                        ${getStatusText(payable.status)}
                    </span>
                </td>
                <td>${payable.category_name || 'N/A'}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editPayable(${payable.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="markAsPaid(${payable.id})" title="Marcar como Pago" ${payable.status === 'paid' ? 'disabled' : ''}>
                            <i class="bi bi-check-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="markAsPending(${payable.id})" title="Marcar como Pendente" ${payable.status === 'pending' ? 'disabled' : ''}>
                            <i class="bi bi-clock"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePayable(${payable.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // Atualizar contadores
    document.getElementById('payablesShowing').textContent = pagePayables.length;
    document.getElementById('payablesTotal').textContent = filteredPayables.length;
}

// Função para renderizar paginação
function renderPagination() {
    const pagination = document.getElementById('payablesPagination');
    const totalPages = Math.ceil(filteredPayables.length / itemsPerPage);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Botão Anterior
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    paginationHTML += `
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
        </li>
    `;
    
    // Números das páginas
    for (let i = 1; i <= totalPages; i++) {
        const activeClass = i === currentPage ? 'active' : '';
        paginationHTML += `
            <li class="page-item ${activeClass}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Botão Próxima
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    paginationHTML += `
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Próxima</a>
        </li>
    `;
    
    pagination.innerHTML = paginationHTML;
}

// Função para mudar página
function changePage(page) {
    const totalPages = Math.ceil(filteredPayables.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderPayablesTable();
        renderPagination();
    }
}

// Função para filtrar contas a pagar
function filterPayables() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const supplierFilter = document.getElementById('supplierFilter').value.toLowerCase();
    const dueDateFrom = document.getElementById('dueDateFrom').value;
    const dueDateTo = document.getElementById('dueDateTo').value;
    
    filteredPayables = payables.filter(payable => {
        const matchesSearch = !searchTerm || 
            payable.description.toLowerCase().includes(searchTerm) ||
            (payable.supplier_name && payable.supplier_name.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || payable.status === statusFilter;
        
        const matchesSupplier = !supplierFilter || 
            (payable.supplier_name && payable.supplier_name.toLowerCase().includes(supplierFilter));
        
        const matchesDateFrom = !dueDateFrom || new Date(payable.due_date) >= new Date(dueDateFrom);
        const matchesDateTo = !dueDateTo || new Date(payable.due_date) <= new Date(dueDateTo);
        
        return matchesSearch && matchesStatus && matchesSupplier && matchesDateFrom && matchesDateTo;
    });
    
    currentPage = 1;
    renderPayablesTable();
    renderPagination();
}

// Função para limpar filtros
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('supplierFilter').value = '';
    document.getElementById('dueDateFrom').value = '';
    document.getElementById('dueDateTo').value = '';
    filterPayables();
}

// Função para obter classe do badge de status
function getStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'bg-warning';
        case 'paid': return 'bg-success';
        case 'overdue': return 'bg-danger';
        case 'cancelled': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

// Função para obter texto do status
function getStatusText(status) {
    switch (status) {
        case 'pending': return 'Pendente';
        case 'paid': return 'Pago';
        case 'overdue': return 'Vencido';
        case 'cancelled': return 'Cancelado';
        default: return 'Desconhecido';
    }
}

// Função para editar conta a pagar
function editPayable(id) {
    // Redirecionar para página de edição (implementar se necessário)
    showAlert('Funcionalidade de edição será implementada em breve', 'info');
}

// Função para marcar como pago
async function markAsPaid(id) {
    try {
        const response = await fetch(`/api/financial/payables/${id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: 'paid'
            })
        });
        
        if (response.ok) {
            showAlert('Conta marcada como paga com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao marcar como pago', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao marcar como pago', 'danger');
    }
}

// Função para marcar como pendente
async function markAsPending(id) {
    try {
        const response = await fetch(`/api/financial/payables/${id}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: 'pending'
            })
        });
        
        if (response.ok) {
            showAlert('Conta marcada como pendente com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao marcar como pendente', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao marcar como pendente', 'danger');
    }
}

// Função para confirmar pagamento
async function confirmPayment() {
    if (!currentPaymentId || !currentPaymentAction) return;
    
    try {
        const response = await fetch(`/api/financial/payables/${currentPaymentId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                status: currentPaymentAction === 'mark_paid' ? 'paid' : 'pending'
            })
        });
        
        if (response.ok) {
            showAlert('Status da conta atualizado com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao atualizar status', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao atualizar status', 'danger');
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
}

// Função para editar conta a pagar
function editPayable(id) {
    window.location.href = `/financial/payables/editar/${id}`;
}

// Função para excluir conta a pagar
function deletePayable(id) {
    currentDeleteId = id;
    
    const payable = payables.find(p => p.id === id);
    document.getElementById('deleteModalBody').innerHTML = `
        <p>Tem certeza que deseja excluir esta conta a pagar?</p>
        <div class="alert alert-danger">
            <strong>Conta:</strong> ${payable.description}<br>
            <strong>Valor:</strong> R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
            <strong>Fornecedor:</strong> ${payable.supplier_name || 'N/A'}
        </div>
        <p class="text-danger"><strong>Atenção:</strong> Esta ação não pode ser desfeita!</p>
    `;
    
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// Função para confirmar exclusão
async function confirmDelete() {
    if (!currentDeleteId) return;
    
    // Desabilitar botão para evitar duplo clique
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...';
    
    try {
        const response = await fetch(`/api/financial/payables/${currentDeleteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                remove_future_entries: false
            })
        });
        
        if (response.ok) {
            showAlert('Conta a pagar excluída com sucesso!', 'success');
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao excluir conta', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao excluir conta', 'danger');
    } finally {
        // Reabilitar botão
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
    }
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
}

// Função para mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Função para atualizar estatísticas
function updateStats() {
    if (!payables || payables.length === 0) {
        document.getElementById('totalAmount').textContent = 'R$ 0,00';
        document.getElementById('paidAmount').textContent = 'R$ 0,00';
        document.getElementById('overdueAmount').textContent = 'R$ 0,00';
        document.getElementById('pendingAmount').textContent = 'R$ 0,00';
        return;
    }
    
    let totalAmount = 0;
    let paidAmount = 0;
    let overdueAmount = 0;
    let pendingAmount = 0;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    payables.forEach(payable => {
        const amount = parseFloat(payable.amount) || 0;
        totalAmount += amount;
        
        if (payable.status === 'paid') {
            paidAmount += amount;
        } else if (payable.status === 'overdue') {
            overdueAmount += amount;
        } else if (payable.status === 'pending') {
            pendingAmount += amount;
        }
    });
    
    document.getElementById('totalAmount').textContent = `R$ ${totalAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('paidAmount').textContent = `R$ ${paidAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('overdueAmount').textContent = `R$ ${overdueAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('pendingAmount').textContent = `R$ ${pendingAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
}
</script>
{% endblock %}