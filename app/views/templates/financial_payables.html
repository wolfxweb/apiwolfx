{% extends "base.html" %}

{% block title %}Contas a Pagar{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-arrow-up-circle text-danger"></i> Contas a Pagar</h2>
                    <p class="text-muted">Gerencie suas contas a pagar e despesas</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#payableModal" onclick="newPayable()">
                    <i class="bi bi-plus-circle"></i> Nova Conta a Pagar
                </button>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Buscar por descrição, fornecedor..." onkeyup="filterPayables()">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter" onchange="filterPayables()">
                                <option value="">Todos os Status</option>
                                <option value="pending">Pendente</option>
                                <option value="paid">Pago</option>
                                <option value="overdue">Vencido</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" id="supplierFilter" placeholder="Filtrar por fornecedor" onkeyup="filterPayables()">
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="dueDateFrom" placeholder="Vencimento de" onchange="filterPayables()">
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="dueDateTo" placeholder="Vencimento até" onchange="filterPayables()">
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()" title="Limpar filtros">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fornecedor</th>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Categoria</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="payablesTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Paginação -->
                    <nav aria-label="Paginação de contas a pagar">
                        <ul class="pagination justify-content-center" id="payablesPagination">
                            <!-- Paginação será inserida via JavaScript -->
                        </ul>
                    </nav>
                    
                    <!-- Contadores -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <small class="text-muted">
                                Mostrando <span id="payablesShowing">0</span> de <span id="payablesTotal">0</span> contas a pagar
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Nova/Editar Conta a Pagar -->
<div class="modal fade" id="payableModal" tabindex="-1" aria-labelledby="payableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="payableModalTitle">Nova Conta a Pagar</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="payableForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="supplierName" class="form-label">Fornecedor</label>
                                <div class="position-relative">
                                    <input type="text" class="form-control" id="supplierName" placeholder="Digite para buscar fornecedor..." autocomplete="off">
                                    <input type="hidden" id="fornecedorId" value="">
                                    <div id="supplierDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                        <!-- Resultados da busca aparecerão aqui -->
                                    </div>
                                </div>
                                <small class="form-text text-muted">Digite para buscar fornecedores cadastrados ou deixe em branco para fornecedor manual</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="invoiceNumber" class="form-label">Número da Nota</label>
                                <input type="text" class="form-control" id="invoiceNumber" placeholder="Ex: NF-001">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="description" class="form-label">Descrição *</label>
                                <input type="text" class="form-control" id="description" required placeholder="Descrição da despesa">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor *</label>
                                <input type="number" class="form-control" id="amount" step="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dueDate" class="form-label">Data de Vencimento *</label>
                                <input type="date" class="form-control" id="dueDate" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="categoryId" class="form-label">Categoria</label>
                                <select class="form-select" id="categoryId">
                                    <option value="">Selecione a categoria</option>
                                    <!-- Categorias carregadas via JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="costCenterId" class="form-label">Centro de Custo</label>
                                <select class="form-select" id="costCenterId">
                                    <option value="">Selecione o centro de custo</option>
                                    <!-- Centros de custo carregados via JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="accountId" class="form-label">Conta Bancária</label>
                                <select class="form-select" id="accountId">
                                    <option value="">Selecione a conta</option>
                                    <!-- Contas bancárias carregadas via JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isFixed">
                                    <label class="form-check-label" for="isFixed">
                                        Despesa fixa
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opções de Tipo de Despesa -->
                    <div class="mb-3">
                        <label class="form-label">Tipo de Despesa</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="expenseType" id="expenseTypeSingle" value="single" checked>
                            <label class="form-check-label" for="expenseTypeSingle">
                                Despesa única
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="expenseType" id="expenseTypeRecurring" value="recurring">
                            <label class="form-check-label" for="expenseTypeRecurring">
                                Despesa recorrente
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="expenseType" id="expenseTypeInstallment" value="installment">
                            <label class="form-check-label" for="expenseTypeInstallment">
                                Parcelamento
                            </label>
                        </div>
                    </div>
                    
                    <!-- Opções para Despesa Recorrente -->
                    <div class="row" id="recurringOptions" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recurringFrequency" class="form-label">Frequência</label>
                                <select class="form-select" id="recurringFrequency">
                                    <option value="monthly">Mensal</option>
                                    <option value="quarterly">Trimestral</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="recurringEndDate" class="form-label">Data de Término</label>
                                <input type="date" class="form-control" id="recurringEndDate">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Opções para Parcelamento -->
                    <div class="row" id="installmentOptions" style="display: none;">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="totalInstallments" class="form-label">Quantidade de Parcelas</label>
                                <input type="number" class="form-control" id="totalInstallments" min="2" max="60" placeholder="Ex: 12">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="installmentDueDate" class="form-label">Vencimento da 1ª Parcela</label>
                                <input type="date" class="form-control" id="installmentDueDate">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Observações</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Observações adicionais"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="savePayable()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Exclusão -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="deleteModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
                <div id="deleteFutureEntries" style="display: none;" class="mt-3">
                    <div class="alert alert-warning">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="removeFutureEntries">
                            <label class="form-check-label" for="removeFutureEntries">
                                <strong>Remover também os lançamentos futuros</strong><br>
                                <small class="text-muted">Marque esta opção se deseja excluir todas as parcelas ou recorrências futuras desta conta.</small>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Pagamento -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Confirmar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="paymentModalBody">
                    <!-- Conteúdo será preenchido dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="confirmPaymentBtn" onclick="confirmPayment()">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let payables = [];
let filteredPayables = [];
let categories = [];
let costCenters = [];
let accounts = [];
let currentEditId = null;
let currentDeleteId = null;
let currentPaymentId = null;
let currentPaymentAction = null; // 'mark_paid' ou 'mark_pending'
let currentPage = 1;
let itemsPerPage = 10;

// Carregar dados ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadPayables();
    loadCategories();
    loadCostCenters();
    loadAccounts();
});

// Função para carregar contas a pagar
async function loadPayables() {
    try {
        const response = await fetch('/api/financial/payables', {
            credentials: 'include'
        });
        if (response.ok) {
            payables = await response.json();
            filteredPayables = [...payables];
            renderPayablesTable();
            renderPagination();
        } else {
            showAlert('Erro ao carregar contas a pagar', 'danger');
        }
    } catch (error) {
        console.error('Erro ao carregar contas a pagar:', error);
        showAlert('Erro ao carregar contas a pagar', 'danger');
    }
}

// Função para carregar categorias
async function loadCategories() {
    try {
        const response = await fetch('/api/financial/categories', {
            credentials: 'include'
        });
        if (response.ok) {
            categories = await response.json();
            updateCategorySelects();
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

// Função para carregar centros de custo
async function loadCostCenters() {
    try {
        const response = await fetch('/api/financial/cost-centers', {
            credentials: 'include'
        });
        if (response.ok) {
            costCenters = await response.json();
            updateCostCenterSelects();
        }
    } catch (error) {
        console.error('Erro ao carregar centros de custo:', error);
    }
}

// Função para carregar contas bancárias
async function loadAccounts() {
    try {
        const response = await fetch('/api/financial/accounts', {
            credentials: 'include'
        });
        if (response.ok) {
            accounts = await response.json();
            updateAccountSelects();
        }
    } catch (error) {
        console.error('Erro ao carregar contas bancárias:', error);
    }
}

// Função para renderizar tabela
function renderPayablesTable() {
    const tbody = document.getElementById('payablesTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const payablesToShow = filteredPayables.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    payablesToShow.forEach(payable => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${payable.supplier_name || '-'}</td>
            <td>
                <div class="d-flex flex-column">
                    <span class="fw-bold">${payable.description}</span>
                    ${payable.invoice_number ? `<small class="text-muted">NF: ${payable.invoice_number}</small>` : ''}
                </div>
            </td>
            <td>
                <span class="fw-bold text-danger">R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
            </td>
            <td>${formatDate(payable.due_date)}</td>
            <td>${getStatusBadge(payable.status)}</td>
            <td>${payable.category_name || '-'}</td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm ${payable.status === 'pending' ? 'btn-outline-success' : 'btn-warning'}" onclick="togglePaymentStatus(${payable.id})" title="${payable.status === 'pending' ? 'Marcar como Pago' : 'Marcar como Pendente'}">
                        <i class="bi bi-check-circle"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="editPayable(${payable.id})" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePayable(${payable.id})" title="Excluir">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar contadores
    document.getElementById('payablesShowing').textContent = payablesToShow.length;
    document.getElementById('payablesTotal').textContent = filteredPayables.length;
}

// Função para filtrar contas a pagar
function filterPayables() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const supplierFilter = document.getElementById('supplierFilter').value.toLowerCase();
    const dueDateFrom = document.getElementById('dueDateFrom').value;
    const dueDateTo = document.getElementById('dueDateTo').value;
    
    filteredPayables = payables.filter(payable => {
        const matchesSearch = !searchTerm || 
            (payable.description && payable.description.toLowerCase().includes(searchTerm)) ||
            (payable.supplier_name && payable.supplier_name.toLowerCase().includes(searchTerm)) ||
            (payable.invoice_number && payable.invoice_number.toLowerCase().includes(searchTerm));
        
        const matchesStatus = !statusFilter || payable.status === statusFilter;
        
        const matchesSupplier = !supplierFilter || (payable.supplier_name && payable.supplier_name.toLowerCase().includes(supplierFilter));
        
        const matchesDateFrom = !dueDateFrom || payable.due_date >= dueDateFrom;
        const matchesDateTo = !dueDateTo || payable.due_date <= dueDateTo;
        
        return matchesSearch && matchesStatus && matchesSupplier && matchesDateFrom && matchesDateTo;
    });
    
    currentPage = 1;
    renderPayablesTable();
    renderPagination();
}

// Função para limpar filtros
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('supplierFilter').value = '';
    document.getElementById('dueDateFrom').value = '';
    document.getElementById('dueDateTo').value = '';
    filterPayables();
}

// Função para nova conta a pagar
function newPayable() {
    currentEditId = null;
    document.getElementById('payableModalTitle').textContent = 'Nova Conta a Pagar';
    document.getElementById('payableForm').reset();
    
    // Selecionar despesa única por padrão
    document.getElementById('expenseTypeSingle').checked = true;
    document.getElementById('recurringOptions').style.display = 'none';
    document.getElementById('installmentOptions').style.display = 'none';
}

// Função para editar conta a pagar
function editPayable(id) {
    const payable = payables.find(p => p.id === id);
    if (!payable) return;
    
    currentEditId = id;
    document.getElementById('payableModalTitle').textContent = 'Editar Conta a Pagar';
    
    // Abrir o modal
    const modal = new bootstrap.Modal(document.getElementById('payableModal'));
    modal.show();
    
    // Preencher formulário
    document.getElementById('supplierName').value = payable.supplier_name || '';
    document.getElementById('invoiceNumber').value = payable.invoice_number || '';
    document.getElementById('description').value = payable.description || '';
    document.getElementById('amount').value = payable.amount || '';
    document.getElementById('dueDate').value = payable.due_date || '';
    document.getElementById('categoryId').value = payable.category_id || '';
    document.getElementById('costCenterId').value = payable.cost_center_id || '';
    document.getElementById('accountId').value = payable.account_id || '';
    document.getElementById('isFixed').checked = payable.is_fixed || false;
    document.getElementById('notes').value = payable.notes || '';
    
    // Determinar tipo de despesa e preencher campos correspondentes
    if (payable.is_recurring) {
        document.getElementById('expenseTypeRecurring').checked = true;
        document.getElementById('recurringFrequency').value = payable.recurring_frequency || '';
        document.getElementById('recurringEndDate').value = payable.recurring_end_date || '';
        document.getElementById('recurringOptions').style.display = 'block';
        document.getElementById('installmentOptions').style.display = 'none';
    } else if (payable.total_installments > 1) {
        document.getElementById('expenseTypeInstallment').checked = true;
        document.getElementById('totalInstallments').value = payable.total_installments || '';
        document.getElementById('installmentDueDate').value = payable.due_date || '';
        document.getElementById('installmentOptions').style.display = 'block';
        document.getElementById('recurringOptions').style.display = 'none';
    } else {
        document.getElementById('expenseTypeSingle').checked = true;
        document.getElementById('recurringOptions').style.display = 'none';
        document.getElementById('installmentOptions').style.display = 'none';
    }
}

// Função para salvar conta a pagar
async function savePayable() {
    const expenseType = document.querySelector('input[name="expenseType"]:checked').value;
    
    const formData = {
        supplier_name: document.getElementById('supplierName').value,
        fornecedor_id: document.getElementById('fornecedorId').value || null,
        invoice_number: document.getElementById('invoiceNumber').value || null,
        description: document.getElementById('description').value,
        amount: document.getElementById('amount').value,
        due_date: document.getElementById('dueDate').value,
        category_id: document.getElementById('categoryId').value || null,
        cost_center_id: document.getElementById('costCenterId').value || null,
        account_id: document.getElementById('accountId').value || null,
        is_fixed: document.getElementById('isFixed').checked,
        notes: document.getElementById('notes').value || null
    };
    
    // Adicionar campos específicos baseado no tipo de despesa
    if (expenseType === 'recurring') {
        formData.is_recurring = true;
        formData.recurring_frequency = document.getElementById('recurringFrequency').value;
        formData.recurring_end_date = document.getElementById('recurringEndDate').value;
        
        // Validações para despesa recorrente
        if (!formData.recurring_frequency) {
            showAlert('Frequência é obrigatória para despesa recorrente', 'danger');
            return;
        }
        if (!formData.recurring_end_date) {
            showAlert('Data de término é obrigatória para despesa recorrente', 'danger');
            return;
        }
    } else if (expenseType === 'installment') {
        const totalInstallments = parseInt(document.getElementById('totalInstallments').value);
        const installmentDueDate = document.getElementById('installmentDueDate').value;
        
        // Validações para parcelamento
        if (!totalInstallments || totalInstallments < 2) {
            showAlert('Quantidade de parcelas deve ser pelo menos 2', 'danger');
            return;
        }
        if (!installmentDueDate) {
            showAlert('Vencimento da primeira parcela é obrigatório', 'danger');
            return;
        }
        
        formData.total_installments = totalInstallments;
        formData.installment_due_date = installmentDueDate;
    } else {
        // Despesa única
        formData.is_recurring = false;
    }
    
    try {
        const url = currentEditId ? `/api/financial/payables/${currentEditId}` : '/api/financial/payables';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert(result.message || 'Conta a pagar salva com sucesso!', 'success');
            document.getElementById('payableModal').querySelector('.btn-close').click();
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao salvar conta a pagar', 'danger');
        }
    } catch (error) {
        console.error('Erro ao salvar conta a pagar:', error);
        showAlert('Erro ao salvar conta a pagar', 'danger');
    }
}

// Função para alternar status de pagamento
function togglePaymentStatus(id) {
    const payable = payables.find(p => p.id === id);
    if (!payable) return;
    
    currentPaymentId = id;
    
    if (payable.status === 'pending') {
        // Marcar como pago
        currentPaymentAction = 'mark_paid';
        document.getElementById('paymentModalLabel').textContent = 'Confirmar Pagamento';
        document.getElementById('paymentModalBody').innerHTML = `
            <p>Deseja marcar esta conta como <strong>paga</strong>?</p>
            <div class="alert alert-info">
                <strong>Conta:</strong> ${payable.description}<br>
                <strong>Fornecedor:</strong> ${payable.supplier_name || '-'}<br>
                <strong>Valor:</strong> R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                <strong>Vencimento:</strong> ${formatDate(payable.due_date)}
            </div>
        `;
        document.getElementById('confirmPaymentBtn').className = 'btn btn-success';
        document.getElementById('confirmPaymentBtn').textContent = 'Marcar como Pago';
    } else {
        // Marcar como pendente
        currentPaymentAction = 'mark_pending';
        document.getElementById('paymentModalLabel').textContent = 'Confirmar Alteração';
        document.getElementById('paymentModalBody').innerHTML = `
            <p>Deseja marcar esta conta como <strong>pendente</strong>?</p>
            <div class="alert alert-warning">
                <strong>Conta:</strong> ${payable.description}<br>
                <strong>Fornecedor:</strong> ${payable.supplier_name || '-'}<br>
                <strong>Valor:</strong> R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                <strong>Data de Pagamento:</strong> ${payable.paid_date ? formatDate(payable.paid_date) : '-'}
            </div>
        `;
        document.getElementById('confirmPaymentBtn').className = 'btn btn-warning';
        document.getElementById('confirmPaymentBtn').textContent = 'Marcar como Pendente';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

// Função para confirmar pagamento
async function confirmPayment() {
    if (!currentPaymentId || !currentPaymentAction) return;
    
    try {
        let url, body, successMessage;
        
        if (currentPaymentAction === 'mark_paid') {
            url = `/api/financial/payables/${currentPaymentId}/mark-paid`;
            body = {
                paid_date: new Date().toISOString().split('T')[0], // Data atual
                paid_amount: null // Usar o valor original da conta
            };
            successMessage = 'Conta marcada como paga com sucesso!';
        } else {
            url = `/api/financial/payables/${currentPaymentId}/mark-pending`;
            body = {};
            successMessage = 'Conta marcada como pendente com sucesso!';
        }
        
        const response = await fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(body)
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert(result.message || successMessage, 'success');
            document.getElementById('paymentModal').querySelector('.btn-close').click();
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao alterar status da conta', 'danger');
        }
    } catch (error) {
        console.error('Erro ao alterar status da conta:', error);
        showAlert('Erro ao alterar status da conta', 'danger');
    }
}

// Função para excluir conta a pagar
function deletePayable(id) {
    const payable = payables.find(p => p.id === id);
    if (!payable) return;
    
    currentDeleteId = id;
    
    // Verificar se é conta parcelada ou recorrente
    const isInstallment = payable.total_installments > 1;
    const isRecurring = payable.is_recurring;
    
    // Configurar o modal baseado no tipo de conta
    if (isInstallment || isRecurring) {
        document.getElementById('deleteModalLabel').textContent = 'Confirmar Exclusão';
        document.getElementById('deleteModalBody').innerHTML = `
            <p>Tem certeza que deseja excluir esta conta?</p>
            <div class="alert alert-info">
                <strong>Conta:</strong> ${payable.description}<br>
                <strong>Fornecedor:</strong> ${payable.supplier_name || '-'}<br>
                <strong>Valor:</strong> R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>
                ${isInstallment ? `<strong>Parcelas:</strong> ${payable.installment_number || 1}/${payable.total_installments}<br>` : ''}
                ${isRecurring ? `<strong>Tipo:</strong> Despesa Recorrente (${payable.recurring_frequency})<br>` : ''}
            </div>
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> <strong>Atenção:</strong> Esta ação não pode ser desfeita.
            </div>
        `;
        
        // Mostrar opção para remover lançamentos futuros
        document.getElementById('deleteFutureEntries').style.display = 'block';
        document.getElementById('removeFutureEntries').checked = false;
    } else {
        // Conta simples
        document.getElementById('deleteModalLabel').textContent = 'Confirmar Exclusão';
        document.getElementById('deleteModalBody').innerHTML = `
            <p>Tem certeza que deseja excluir esta conta a pagar?</p>
            <div class="alert alert-info">
                <strong>Conta:</strong> ${payable.description}<br>
                <strong>Fornecedor:</strong> ${payable.supplier_name || '-'}<br>
                <strong>Valor:</strong> R$ ${parseFloat(payable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}
            </div>
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> <strong>Atenção:</strong> Esta ação não pode ser desfeita.
            </div>
        `;
        
        // Ocultar opção para remover lançamentos futuros
        document.getElementById('deleteFutureEntries').style.display = 'none';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Função para confirmar exclusão
async function confirmDelete() {
    if (!currentDeleteId) return;
    
    try {
        // Verificar se deve remover lançamentos futuros
        const removeFutureEntries = document.getElementById('removeFutureEntries').checked;
        
        // Preparar dados para envio
        const deleteData = {
            remove_future_entries: removeFutureEntries
        };
        
        const response = await fetch(`/api/financial/payables/${currentDeleteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(deleteData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert(result.message || 'Conta a pagar excluída com sucesso!', 'success');
            document.getElementById('deleteModal').querySelector('.btn-close').click();
            loadPayables();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao excluir conta a pagar', 'danger');
        }
    } catch (error) {
        console.error('Erro ao excluir conta a pagar:', error);
        showAlert('Erro ao excluir conta a pagar', 'danger');
    }
    
    currentDeleteId = null;
}

// Função para renderizar paginação
function renderPagination() {
    const totalPages = Math.ceil(filteredPayables.length / itemsPerPage);
    const pagination = document.getElementById('payablesPagination');
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // Botão anterior
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>`;
    pagination.appendChild(prevLi);
    
    // Páginas
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // Botão próximo
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Próximo</a>`;
    pagination.appendChild(nextLi);
}

// Função para mudar página
function changePage(page) {
    const totalPages = Math.ceil(filteredPayables.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderPayablesTable();
        renderPagination();
    }
}

// Funções auxiliares
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Pendente</span>',
        'paid': '<span class="badge bg-success">Pago</span>',
        'overdue': '<span class="badge bg-danger">Vencido</span>',
        'cancelled': '<span class="badge bg-secondary">Cancelado</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">Desconhecido</span>';
}

function updateCategorySelects() {
    const select = document.getElementById('categoryId');
    if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione a categoria</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            select.appendChild(option);
        });
        select.value = currentValue;
    }
}

function updateCostCenterSelects() {
    const select = document.getElementById('costCenterId');
    if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione o centro de custo</option>';
        costCenters.forEach(costCenter => {
            const option = document.createElement('option');
            option.value = costCenter.id;
            option.textContent = costCenter.name;
            select.appendChild(option);
        });
        select.value = currentValue;
    }
}

function updateAccountSelects() {
    const select = document.getElementById('accountId');
    if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione a conta</option>';
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.bank_name} - ${account.account_name}`;
            select.appendChild(option);
        });
        select.value = currentValue;
    }
}

// Autocomplete de fornecedores
let supplierSearchTimeout;

document.getElementById('supplierName').addEventListener('input', function() {
    const query = this.value.trim();
    const dropdown = document.getElementById('supplierDropdown');
    const fornecedorIdInput = document.getElementById('fornecedorId');
    
    // Limpar timeout anterior
    if (supplierSearchTimeout) {
        clearTimeout(supplierSearchTimeout);
    }
    
    // Se campo estiver vazio, limpar seleção
    if (query === '') {
        fornecedorIdInput.value = '';
        dropdown.style.display = 'none';
        return;
    }
    
    // Debounce da busca
    supplierSearchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/fornecedores/search?q=${encodeURIComponent(query)}&limit=10`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                displaySupplierResults(data.fornecedores);
            }
        } catch (error) {
            console.error('Erro ao buscar fornecedores:', error);
        }
    }, 300);
});

function displaySupplierResults(fornecedores) {
    const dropdown = document.getElementById('supplierDropdown');
    
    if (fornecedores.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item text-muted">Nenhum fornecedor encontrado</div>';
    } else {
        dropdown.innerHTML = '';
        fornecedores.forEach(fornecedor => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="fw-bold">${fornecedor.nome}</div>
                ${fornecedor.nome_fantasia ? `<small class="text-muted">${fornecedor.nome_fantasia}</small><br>` : ''}
                ${fornecedor.cnpj ? `<small class="text-muted">CNPJ: ${fornecedor.cnpj}</small>` : ''}
            `;
            
            item.addEventListener('click', function() {
                selectSupplier(fornecedor);
            });
            
            dropdown.appendChild(item);
        });
    }
    
    dropdown.style.display = 'block';
}

function selectSupplier(fornecedor) {
    const supplierNameInput = document.getElementById('supplierName');
    const fornecedorIdInput = document.getElementById('fornecedorId');
    const dropdown = document.getElementById('supplierDropdown');
    
    supplierNameInput.value = fornecedor.display_name;
    fornecedorIdInput.value = fornecedor.id;
    dropdown.style.display = 'none';
}

// Ocultar dropdown ao clicar fora
document.addEventListener('click', function(event) {
    const supplierContainer = document.querySelector('#supplierName').closest('.position-relative');
    if (!supplierContainer.contains(event.target)) {
        document.getElementById('supplierDropdown').style.display = 'none';
    }
});

// Controlar exibição das opções baseado no tipo de despesa
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para os radio buttons de tipo de despesa
    document.querySelectorAll('input[name="expenseType"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const expenseType = this.value;
            
            // Ocultar todas as opções primeiro
            document.getElementById('recurringOptions').style.display = 'none';
            document.getElementById('installmentOptions').style.display = 'none';
            
            // Mostrar opções baseado no tipo selecionado
            if (expenseType === 'recurring') {
                document.getElementById('recurringOptions').style.display = 'block';
            } else if (expenseType === 'installment') {
                document.getElementById('installmentOptions').style.display = 'block';
            }
        });
    });
});

// Função para mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Remover alerta após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
