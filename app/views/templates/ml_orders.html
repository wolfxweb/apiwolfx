{% extends "base.html" %}

{% block title %}Pedidos - GVMIA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between flex-wrap gap-3 align-items-start">
                <div>
                <h1 class="h3 mb-1"><i class="bi bi-cart-check"></i> Pedidos Mercado Livre</h1>
                    <p class="text-muted mb-0">
                    Acompanhe todos os pedidos importados
                    <span id="orders-count" class="ms-2 small text-secondary">
                            <i class="bi bi-info-circle"></i> Carregando...
                        </span>
                    </p>
                </div>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-primary" onclick="syncOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar pedidos
                        </button>
                <button type="button" class="btn btn-outline-secondary" onclick="importOrders()">
                    <i class="bi bi-download"></i> Importar pedidos
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="showDeleteOrdersModal()">
                    <i class="bi bi-trash"></i> Remover pedidos
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3" id="alerts-container"></div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <form class="row g-3 align-items-end" id="ordersFiltersForm">
                        <div class="col-12 col-lg-4 col-xl-3">
                            <label for="search_query" class="form-label small text-uppercase text-muted">Busca rápida</label>
                            <div class="input-group">
                                <input type="text" name="search_query" id="search_query" class="form-control" placeholder="Código, comprador ou produto" onkeydown="handleSearchKey(event)" />
                                <button type="button" class="btn btn-outline-primary" onclick="applyFilters()">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="account_filter" class="form-label small text-uppercase text-muted">Conta</label>
                            <select name="account_filter" id="account_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="status_filter" class="form-label small text-uppercase text-muted">Status do envio</label>
                            <select name="status_filter" id="status_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todos os status</option>
                                <option value="ready_to_ship">Pronto para envio</option>
                                <option value="shipped">Enviado</option>
                                <option value="in_transit">Em trânsito</option>
                                <option value="out_for_delivery">Saiu para entrega</option>
                                <option value="delivered">Entregue</option>
                                <option value="pending">Pendente</option>
                                <option value="buffered">Aguardando...</option>
                                <option value="in_warehouse">No armazém</option>
                                <option value="receiver_absent">Comprador ausente</option>
                                <option value="cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="logistic_filter" class="form-label small text-uppercase text-muted">Modalidade de envio</label>
                            <select name="logistic_filter" id="logistic_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todas</option>
                                <option value="fulfillment">Fulfillment</option>
                                <option value="cross_docking">Cross Docking</option>
                                <option value="me2">Mercado Envios</option>
                                <option value="me1">Correios</option>
                                <option value="xd_drop_off">Ponto de Coleta</option>
                                <option value="self_service">Envio próprio</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="period_filter" class="form-label small text-uppercase text-muted">Período</label>
                            <select name="period_filter" id="period_filter" class="form-select" onchange="toggleCustomPeriod(); applyFilters();">
                                <option value="">Todos</option>
                                <option value="today">Hoje</option>
                                <option value="last_7_days">Últimos 7 dias</option>
                                <option value="last_15_days" selected>Últimos 15 dias</option>
                                <option value="last_30_days">Últimos 30 dias</option>
                                <option value="last_60_days">Últimos 60 dias</option>
                                <option value="last_90_days">Últimos 90 dias</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="date_from" class="form-label small text-uppercase text-muted">Data inicial</label>
                            <input type="date" name="date_from" id="date_from" class="form-control" onchange="applyFilters()">
                            </div>
                        <div class="col-12 col-md-3">
                            <label for="date_to" class="form-label small text-uppercase text-muted">Data final</label>
                            <input type="date" name="date_to" id="date_to" class="form-control" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-auto">
                            <label class="form-label small text-uppercase text-muted">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="bi bi-x-circle"></i> Limpar filtros
                                </button>
                    </div>
                        </div>
                    </form>
                    
                    <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
                        <div class="col-12 col-md-3">
                            <label for="customDateFrom" class="form-label small text-uppercase text-muted">Data inicial</label>
                            <input type="date" class="form-control" id="customDateFrom" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="customDateTo" class="form-label small text-uppercase text-muted">Data final</label>
                            <input type="date" class="form-control" id="customDateTo" onchange="applyFilters()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="row mb-4" id="loading-container" style="display: none;">
        <div class="col-12">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando pedidos...</p>
            </div>
        </div>
    </div>

    <!-- Lista de Orders -->
    <div class="row">
        <div class="col-12">
            <div id="orders-cards-container" class="orders-card-list d-flex flex-column gap-3">
                <div class="text-center text-muted py-4">
                                        <i class="bi bi-info-circle"></i> Carregando pedidos...
                </div>
            </div>
        </div>
    </div>

    <!-- Paginação -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    <span id="pagination-info">Mostrando 0 de 0 pedidos</span>
                </div>
                <nav aria-label="Navegação de pedidos">
                    <ul class="pagination mb-0" id="pagination">
                        <!-- Paginação será inserida aqui dinamicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Importação -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="bi bi-download text-success me-2"></i>Importação Inteligente de Pedidos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeImportModal"></button>
            </div>
            <div class="modal-body">
                <!-- Tela 1: Configuração -->
                <div id="import-config" style="display: block;">
                    <div class="text-center mb-4">
                        <i class="bi bi-cloud-download text-primary" style="font-size: 3rem;"></i>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Pedidos disponíveis:</strong> <span id="total-orders-available">Verificando...</span>
                    </div>
                    
                    <h6 class="mb-3">Estratégia de Importação:</h6>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-gear text-primary me-2"></i>Importação em Lotes Inteligentes
                            </h6>
                            <p class="card-text small">
                                Para importar todos os pedidos sem sobrecarregar o sistema, 
                                faremos a importação em lotes de <strong>50 pedidos</strong> com pausas automáticas entre cada lote.
                            </p>
                            <ul class="small mb-0">
                                <li>Lote: 50 pedidos por vez</li>
                                <li>Pausa entre pedidos: 5 segundos</li>
                                <li>Pausa entre lotes: 10 segundos</li>
                                <li>Tempo estimado: <span id="estimated-time">Calculando...</span></li>
                                <li>Você pode cancelar a qualquer momento</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Importação em Background:</strong> A importação rodará no servidor. Você pode fechar esta janela e até mesmo o navegador! O processo continuará executando.
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-laptop me-2"></i>
                        <strong>Dica:</strong> Após iniciar, você pode continuar usando o sistema normalmente. A lista de pedidos será atualizada automaticamente conforme novos pedidos forem importados.
                    </div>
                </div>
                
                <!-- Tela 2: Progresso -->
                <div id="import-progress" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-hourglass-split text-primary" style="font-size: 3rem;"></i>
                    </div>
                    
                    <h6 class="text-center mb-4">Importando pedidos...</h6>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Progresso Geral</span>
                            <span class="small"><strong id="progress-text">0 / 0 (0%)</strong></span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%">
                                <span id="progress-percentage">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-success" id="imported-count">0</h4>
                                    <small class="text-muted">Importados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-warning" id="updated-count">0</h4>
                                    <small class="text-muted">Atualizados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-primary" id="current-batch">1</h4>
                                    <small class="text-muted">Lote Atual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small">
                        <div id="import-status">Preparando importação...</div>
                        <div id="import-eta" class="mt-2 text-muted"></div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelImport()" id="cancel-import-btn">
                            <i class="bi bi-x-circle me-1"></i>Cancelar Importação
                        </button>
                    </div>
                </div>
                
                <!-- Tela 3: Conclusão -->
                <div id="import-complete" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    
                    <h5 class="text-center mb-4 text-success">Importação Concluída!</h5>
                    
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="card bg-success text-white">
                                <div class="card-body py-3">
                                    <h3 class="mb-0" id="final-imported">0</h3>
                                    <small>Pedidos Importados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-warning text-white">
                                <div class="card-body py-3">
                                    <h3 class="mb-0" id="final-updated">0</h3>
                                    <small>Pedidos Atualizados</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <div id="final-message">Todos os pedidos foram importados com sucesso!</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-modal-btn">
                    <i class="bi bi-x-circle me-1"></i>Fechar
                </button>
                <button type="button" class="btn btn-success" onclick="startBatchImport()" id="start-import-btn">
                    <i class="bi bi-download me-1"></i>Iniciar Importação
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderJsonModal" tabindex="-1" aria-labelledby="orderJsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderJsonModalLabel"><i class="bi bi-code-slash"></i> JSON do Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <pre id="orderJsonContent" class="bg-light p-3 rounded small" style="max-height: 60vh; overflow: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="invoiceReleaseModal" tabindex="-1" aria-labelledby="invoiceReleaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="invoiceReleaseModalLabel">
                    <i class="bi bi-clock-history text-warning me-2"></i>
                    Emissão indisponível
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="invoiceReleaseModalMessage">Esse pedido ainda não está liberado para emissão de nota fiscal.</p>
                <div id="invoiceReleaseModalDate" class="alert alert-warning d-flex align-items-center gap-2 d-none">
                    <i class="bi bi-calendar-event"></i>
                    <span>Disponível após <strong></strong>.</span>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="labelErrorModal" tabindex="-1" aria-labelledby="labelErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="labelErrorModalLabel">
                    <i class="bi bi-printer-x text-danger me-2"></i>
                    Etiqueta indisponível
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="labelErrorModalMessage">Não foi possível baixar a etiqueta.</p>
                <div id="labelErrorModalDetails" class="d-none"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Entendi</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade product-image-modal" id="productImageModal" tabindex="-1" aria-labelledby="productImageModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-dark text-white border-0">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="productImageModalTitle">Imagem do produto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body text-center">
                <img id="productImageModalImg" src="" alt="Imagem do produto" class="img-fluid rounded shadow-lg">
            </div>
        </div>
    </div>
</div>

<style>

/* Estilos para botões em loading */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.btn .spinner-border {
    color: currentColor;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

/* Estilos para o modal de importação */
#importModal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

#importModal .modal-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 12px 12px 0 0;
    border: none;
}

#importModal .modal-header .btn-close {
    filter: invert(1);
}

#importModal .modal-body {
    padding: 2rem;
}

#importModal .alert-info {
    border-left: 4px solid #17a2b8;
    background-color: #f8f9fa;
}

#importModal .list-unstyled li {
    padding: 0.5rem 0;
    font-size: 0.9rem;
}

#importModal .modal-footer {
    border: none;
    padding: 1rem 2rem 2rem 2rem;
}

#loading-container .card {
     border: none;
     box-shadow: 0 10px 30px rgba(0,0,0,0.12);
 }

.orders-card-list {
    margin: 0;
}

.order-card {
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    background: #fff;
    overflow: hidden;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.16);
}

.order-card .card-header {
    background: #fff;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    padding: 1rem 1.25rem;
}

.order-card .card-body {
    padding: 1rem 1.25rem 1.25rem;
}

.order-image-thumb {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: none;
}

.order-image-thumb img {
    transition: transform 0.18s ease, box-shadow 0.18s ease;
}

.order-image-thumb:hover img {
    transform: scale(1.08);
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.2);
}

.product-image-modal .modal-dialog {
    max-width: min(1100px, 95vw);
}

.product-image-modal .modal-content {
    background: rgba(0, 0, 0, 0.92);
}

.product-image-modal .modal-body {
    padding: 1.5rem;
}

.product-image-modal img {
    max-height: 85vh;
    max-width: 100%;
    width: auto;
    object-fit: contain;
}

.order-card-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.25rem;
    width: 100%;
    flex-wrap: wrap;
}

.order-summary {
    min-width: 0;
    flex: 1 1 auto;
}

.order-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-left: auto;
    min-width: 220px;
}

.order-summary-inline {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.order-summary-inline .summary-segment {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
}

.order-summary-inline .summary-segment:not(:last-child)::after {
    content: '•';
    color: #6c757d;
}

.order-shipping-inline .shipping-header {
    font-weight: 600;
}

.shipping-detail-list {
    list-style: none;
    margin: 0;
    padding-left: 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.shipping-detail-list li {
    position: relative;
    padding-left: 1.1rem;
}

.shipping-detail-list li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: #6c757d;
}

.order-actions .btn-group {
    flex-wrap: wrap;
}

.order-actions .btn-group .btn {
    margin-bottom: 0.25rem;
}

.order-details {
    padding-top: 0.5rem;
}

.order-card .form-check-input {
    cursor: pointer;
}

@media (max-width: 992px) {
    .order-card-top {
        flex-direction: column;
        gap: 1rem;
    }

    .order-actions {
        justify-content: flex-start;
    }
}

.order-empty-state {
    border: 1px dashed rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 2rem;
    background: #f8fafc;
}

.item-line {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.item-thumb {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.item-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-thumb.placeholder {
    color: #6c757d;
    font-size: 1.25rem;
}

.item-info {
    min-width: 0;
}

.item-info .item-title {
    font-weight: 500;
    display: block;
}

.item-info .item-meta {
    font-size: 0.75rem;
    color: #6c757d;
}

</style>

<script>
let currentPage = 1;
let currentLimit = 50;
let currentFilters = {};
let ordersCache = {};
const INTERNAL_STATUS_OPTIONS = [
    { value: 'separacao', label: 'Separação' },
    { value: 'expedicao', label: 'Expedição' },
    { value: 'pronto_envio', label: 'Pronto para envio' }
];
const INTERNAL_STATUS_LABEL_MAP = INTERNAL_STATUS_OPTIONS.reduce((accumulator, option) => {
    accumulator[option.value] = option.label;
    return accumulator;
}, {});

function showLoading(isLoading) {
    const loadingContainer = document.getElementById('loading-container');
    const cardsContainer = document.getElementById('orders-cards-container');

    if (loadingContainer) {
        loadingContainer.style.display = isLoading ? '' : 'none';
    }

    if (isLoading && cardsContainer) {
        cardsContainer.innerHTML = '';
    }

    updateSelectedOrdersCount();
}

function getSelectedOrderIds() {
    return Array.from(document.querySelectorAll('.order-checkbox:checked'))
        .map(input => input.value)
        .filter(Boolean);
}

function updateSelectedOrdersCount() {
    const deleteBtn = document.querySelector('button[onclick="showDeleteOrdersModal()"]');
    if (deleteBtn) {
        deleteBtn.disabled = getSelectedOrderIds().length === 0;
    }
}

function toggleCustomPeriod(skipClear = false) {
    const periodSelect = document.getElementById('period_filter');
    const customRow = document.getElementById('customPeriodRow');

    if (!periodSelect || !customRow) {
        return;
    }

    const isCustom = periodSelect.value === 'custom';
    customRow.style.display = isCustom ? '' : 'none';

    if (!isCustom && !skipClear) {
        const customFrom = document.getElementById('customDateFrom');
        const customTo = document.getElementById('customDateTo');
        if (customFrom) customFrom.value = '';
        if (customTo) customTo.value = '';
    }
}

const VALID_SHIPPING_STATUS = [
    'ready_to_ship',
    'shipped',
    'in_transit',
    'out_for_delivery',
    'delivered',
    'pending',
    'buffered',
    'in_warehouse',
    'receiver_absent',
    'cancelled'
];

const VALID_LOGISTICS = [
    'fulfillment',
    'full',
    'xd_drop_off',
    'drop_off',
    'ponto_de_coleta',
    'me2',
    'me1',
    'cross_docking',
    'self_service'
];

function setSelectValue(selectId, value) {
    const select = document.getElementById(selectId);
    if (!select) {
        return false;
    }
    const normalized = value ?? '';
    if ([...select.options].some(option => option.value === normalized)) {
        select.value = normalized;
        return true;
    }
    select.value = '';
    return false;
}

function syncFiltersWithUrl() {
    const params = new URLSearchParams(window.location.search);
    let paramsChanged = false;

    const rawStatus = params.get('shipping_status_filter') || '';
    const normalizedStatus = rawStatus.toLowerCase();
    const statusValid = normalizedStatus && VALID_SHIPPING_STATUS.includes(normalizedStatus);
    if (statusValid) {
        setSelectValue('status_filter', normalizedStatus);
        if (rawStatus !== normalizedStatus) {
            params.set('shipping_status_filter', normalizedStatus);
            paramsChanged = true;
        }
    } else if (rawStatus) {
        params.delete('shipping_status_filter');
        paramsChanged = true;
        setSelectValue('status_filter', '');
    } else {
        setSelectValue('status_filter', '');
    }

    const rawLogistic = params.get('logistic_filter') || '';
    const logisticValid = rawLogistic && VALID_LOGISTICS.includes(rawLogistic);
    if (logisticValid) {
        setSelectValue('logistic_filter', rawLogistic);
    } else if (rawLogistic) {
        params.delete('logistic_filter');
        paramsChanged = true;
        setSelectValue('logistic_filter', '');
    } else {
        setSelectValue('logistic_filter', '');
    }

    const periodValue = params.get('period_filter') || '';
    const periodValid = setSelectValue('period_filter', periodValue);
    if (!periodValid && periodValue) {
        params.delete('period_filter');
        paramsChanged = true;
    }

    const accountValue = params.get('account_filter') || '';
    const accountSelect = document.getElementById('account_filter');
    if (accountSelect && accountValue) {
        accountSelect.value = accountValue;
    }

    const searchValue = params.get('search_query') || '';
    const searchInput = document.getElementById('search_query');
    if (searchInput !== null) {
        searchInput.value = searchValue;
    }

    const dateFrom = params.get('date_from') || '';
    const dateTo = params.get('date_to') || '';
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    const customFromInput = document.getElementById('customDateFrom');
    const customToInput = document.getElementById('customDateTo');

    toggleCustomPeriod(true);

    const currentPeriodValue = document.getElementById('period_filter')?.value;
    if (currentPeriodValue === 'custom') {
        if (customFromInput) customFromInput.value = dateFrom;
        if (customToInput) customToInput.value = dateTo;
    } else {
        if (dateFromInput) dateFromInput.value = dateFrom;
        if (dateToInput) dateToInput.value = dateTo;
        if (customFromInput) customFromInput.value = '';
        if (customToInput) customToInput.value = '';
    }

    if (paramsChanged) {
        const newQuery = params.toString();
        const newUrl = newQuery ? `${window.location.pathname}?${newQuery}` : window.location.pathname;
        history.replaceState(null, '', newUrl);
    }

    // Atualizar inputs de data quando período automático é escolhido
    if (currentPeriodValue && currentPeriodValue !== 'custom') {
        const periodDates = getPeriodDates(currentPeriodValue);
        if (periodDates) {
            if (dateFromInput) dateFromInput.value = periodDates.from;
            if (dateToInput) dateToInput.value = periodDates.to;
        }
    }
}

function handleSearchKey(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        applyFilters();
    }
}

function applyFilters() {
    const params = new URLSearchParams();

    const accountValue = document.getElementById('account_filter')?.value || '';
    const statusValue = document.getElementById('status_filter')?.value || '';
    const logisticValue = document.getElementById('logistic_filter')?.value || '';
    const selectedPeriodValue = document.getElementById('period_filter')?.value || '';
    const searchValue = document.getElementById('search_query')?.value.trim() || '';
    const dateFromInput = document.getElementById('date_from');
    const dateToInput = document.getElementById('date_to');
    const customFromInput = document.getElementById('customDateFrom');
    const customToInput = document.getElementById('customDateTo');

    if (accountValue) params.set('account_filter', accountValue);
    if (searchValue) params.set('search_query', searchValue);
    if (statusValue) params.set('shipping_status_filter', statusValue);
    if (logisticValue) params.set('logistic_filter', logisticValue);
    const finalPeriodValue = selectedPeriodValue || 'last_15_days';
    if (finalPeriodValue) params.set('period_filter', finalPeriodValue);

    if (finalPeriodValue && finalPeriodValue !== 'custom') {
        const periodDates = getPeriodDates(finalPeriodValue);
        if (periodDates) {
            params.set('date_from', periodDates.from);
            params.set('date_to', periodDates.to);
        }
    } else if (finalPeriodValue === 'custom') {
        const customFromValue = customFromInput?.value || '';
        const customToValue = customToInput?.value || '';
        if (customFromValue) params.set('date_from', customFromValue);
        if (customToValue) params.set('date_to', customToValue);
    } else {
        const dateFromValue = dateFromInput?.value || '';
        const dateToValue = dateToInput?.value || '';
        if (dateFromValue) params.set('date_from', dateFromValue);
        if (dateToValue) params.set('date_to', dateToValue);
    }

    const newQuery = params.toString();
    const newUrl = newQuery ? `${window.location.pathname}?${newQuery}` : window.location.pathname;
    history.replaceState(null, '', newUrl);

    currentPage = 1;
    loadOrders(1);
}

function clearFilters() {
    const form = document.getElementById('ordersFiltersForm');
    if (form) {
        form.reset();
    }

    toggleCustomPeriod();
    history.replaceState(null, '', window.location.pathname);
    syncFiltersWithUrl();
    currentPage = 1;
    loadOrders(1);
}

// Função utilitária para formatar datas em pt-BR com hora padrão
function formatDate(dateString) {
    if (!dateString) {
        return 'N/A';
    }
    try {
        const date = new Date(dateString);
        return `${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
    } catch (err) {
        console.warn('Não foi possível formatar data:', dateString, err);
        return String(dateString);
    }
}

function formatCurrency(amount, currency = 'BRL') {
    if (amount === null || amount === undefined) {
        amount = 0;
    }
    try {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: currency || 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Number(amount));
    } catch (err) {
        console.warn('Não foi possível formatar valor:', amount, err);
        return `R$ ${Number(amount).toFixed(2)}`;
    }
}

function formatDateTime(dateString) {
    if (!dateString) {
        return '';
    }
    try {
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) {
            return String(dateString);
        }
        return date.toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    } catch (err) {
        console.warn('Não foi possível formatar data/hora:', dateString, err);
        return String(dateString);
    }
}

function formatDateOnly(dateString) {
    if (!dateString) {
        return '';
    }
    try {
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) {
            return String(dateString);
        }
        return date.toLocaleDateString('pt-BR');
    } catch (err) {
        console.warn('Não foi possível formatar data:', dateString, err);
        return String(dateString);
    }
}

function showError(message) {
    const alertContainer = document.getElementById('alerts-container');
    if (!alertContainer) {
        alert(message);
        return;
    }
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function showInvoiceReleaseModal(releaseDateIso, message) {
    const modalElement = document.getElementById('invoiceReleaseModal');
    const messageElement = document.getElementById('invoiceReleaseModalMessage');
    const dateElement = document.getElementById('invoiceReleaseModalDate');

    if (!modalElement || !messageElement || !dateElement) {
        showError(message);
        return;
    }

    messageElement.textContent = message || 'Esse pedido ainda não está liberado para emissão de nota fiscal.';

    if (releaseDateIso) {
        const formatted = formatDateTime(releaseDateIso) || formatDateOnly(releaseDateIso) || releaseDateIso;
        dateElement.classList.remove('d-none');
        dateElement.querySelector('strong').textContent = formatted;
    } else {
        dateElement.classList.add('d-none');
    }

    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

const LABEL_STATUS_HINTS = {
    pending: 'O envio ainda está pendente. Aguarde a liberação do Mercado Livre para gerar a etiqueta.',
    ready_to_ship: 'O envio está pronto para despacho. Assim que o substatus estiver como "Pronto para imprimir" ou "Etiqueta impressa", a etiqueta ficará disponível.',
    ready_to_print: 'O Mercado Livre já liberou a etiqueta. Atualize a página ou tente gerar novamente em instantes.',
    printed: 'A etiqueta já foi emitida no Mercado Livre. Utilize a versão disponível no painel do ML.',
    shipped: 'O envio já foi despachado. Utilize a etiqueta gerada anteriormente ou consulte o Mercado Livre.',
    delivered: 'O envio já foi entregue. O Mercado Livre não disponibiliza a etiqueta após a entrega.'
};

const STATUS_TRANSLATIONS_INLINE = {
    pending: 'Pendente',
    ready_to_ship: 'Pronto para envio',
    ready_to_print: 'Pronto para imprimir',
    printed: 'Etiqueta impressa',
    shipped: 'Enviado',
    delivered: 'Entregue',
    dropped_off: 'Postado no ponto de coleta'
};

function translateStatusesInText(text) {
    if (!text || typeof text !== 'string') {
        return '';
    }
    let result = text;
    Object.entries(STATUS_TRANSLATIONS_INLINE).forEach(([key, value]) => {
        const regex = new RegExp(`\\b${key}\\b`, 'gi');
        result = result.replace(regex, value);
    });
    return result;
}

function showLabelErrorModal(message, details = null) {
    const modalElement = document.getElementById('labelErrorModal');
    const messageElement = document.getElementById('labelErrorModalMessage');
    const detailsElement = document.getElementById('labelErrorModalDetails');

    if (!modalElement || !messageElement || !detailsElement) {
        showError(message || 'Erro ao baixar etiqueta.');
        return;
    }

    const fallbackMessage = 'Não foi possível baixar a etiqueta. Verifique o status do envio no Mercado Livre.';
    const mainMessage = message || fallbackMessage;
    messageElement.textContent = mainMessage;

    const buildDetailItem = (label, value) => {
        if (!value) return null;
        const safeValue = sanitizeText(String(value));
        return `<li><strong>${label}:</strong> ${safeValue}</li>`;
    };

    const detailItems = [];

    if (details && typeof details === 'object') {
        const rawStatus = (details.raw_status || details.status || details.shipping_status || '').toString().toLowerCase();
        const statusLabel = details.translated_status || (rawStatus ? translateShippingLabel(rawStatus) : null);
        if (statusLabel) {
            detailItems.push(buildDetailItem('Status do envio', statusLabel));
        }

        const rawSubstatus = (details.raw_substatus || details.substatus || details.shipping_substatus || '').toString().toLowerCase();
        const substatusLabel = details.translated_substatus || (rawSubstatus ? translateShippingLabel(rawSubstatus) : null);
        if (substatusLabel && substatusLabel !== statusLabel) {
            detailItems.push(buildDetailItem('Substatus', substatusLabel));
        }

        const hint = details.hint || LABEL_STATUS_HINTS[rawStatus] || '';
        if (hint) {
            detailItems.push(buildDetailItem('Orientação', hint));
        }

        const technicalDetailRaw = details.raw_detail || details.detail || details.error || details.message || '';
        const technicalDetail = translateStatusesInText(technicalDetailRaw);
        if (technicalDetail && technicalDetail !== mainMessage) {
            detailItems.push(buildDetailItem('Detalhe', technicalDetail));
        }

        const statusCode = details.status_code || details.code || null;
        if (statusCode) {
            detailItems.push(buildDetailItem('Código', statusCode));
        }
    } else if (details) {
        const maybeCode = details.status_code || details.code;
        if (maybeCode) {
            detailItems.push(buildDetailItem('Código', maybeCode));
        }
        if (details.error) {
            detailItems.push(buildDetailItem('Detalhe', details.error));
        }
        if (details.status) {
            detailItems.push(buildDetailItem('Status do envio', details.status));
        }
    }

    const filteredItems = detailItems.filter(Boolean);

    if (filteredItems.length) {
        detailsElement.innerHTML = `
            <div class="alert alert-warning mb-0">
                <ul class="mb-0 ps-3">
                    ${filteredItems.join('')}
                </ul>
            </div>
        `;
        detailsElement.classList.remove('d-none');
    } else {
        detailsElement.classList.add('d-none');
        detailsElement.innerHTML = '';
    }

    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function showSuccess(message) {
    const alertContainer = document.getElementById('alerts-container');
    if (!alertContainer) {
        alert(message);
        return;
    }
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

// Função para verificar se a resposta indica sessão expirada
function checkSessionExpired(response) {
    if (response.status === 401 || response.status === 403) {
        const redirectUrl = `/auth/login?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
        window.location.replace(redirectUrl);
        return true;
    }
    return false;
}

// Função para ocultar elementos de usuário logado
function hideUserElements() {
    // Ocultar botões de ação
    const syncBtn = document.getElementById('sync-btn');
    const importBtn = document.getElementById('import-btn');
    const deleteBtn = document.querySelector('button[onclick="showDeleteOrdersModal()"]');
    
    if (syncBtn) syncBtn.style.display = 'none';
    if (importBtn) importBtn.style.display = 'none';
    if (deleteBtn) deleteBtn.style.display = 'none';
    
    // Ocultar filtros
    const filtersSection = document.querySelector('.row:has(.card .card-header h5)');
    if (filtersSection) {
        const filtersCard = filtersSection.querySelector('.card');
        if (filtersCard && filtersCard.textContent.includes('Filtros')) {
            filtersSection.style.display = 'none';
        }
    }
    
    // Ocultar tabela
    const tableSection = document.querySelector('.row:has(.card .card-header h5)');
    if (tableSection) {
        const tableCard = tableSection.querySelector('.card');
        if (tableCard && tableCard.textContent.includes('Lista de Pedidos')) {
            tableSection.style.display = 'none';
        }
    }
    
    // Mostrar mensagem de sessão expirada
    const alertContainer = document.getElementById('alerts-container');
    if (alertContainer) {
        alertContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning text-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Sessão expirada!</strong> Faça login novamente para continuar.
                </div>
            </div>
        `;
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    syncFiltersWithUrl();
    loadOrders();
});


function loadOrders(page = 1) {
    showLoading(true);
    currentPage = page;
    
    var urlParams = new URLSearchParams(window.location.search);
    
    // Coletar filtros
    var selectedLimit = 50;  // Limite fixo de 50 pedidos por página
    
    if (!urlParams.get('period_filter')) {
        const defaultPeriod = 'last_15_days';
        urlParams.set('period_filter', defaultPeriod);
        const periodDates = getPeriodDates(defaultPeriod);
        if (periodDates) {
            urlParams.set('date_from', periodDates.from);
            urlParams.set('date_to', periodDates.to);
        }
        urlParamsChanged = true;
    }
    
    const rawStatus = urlParams.get('shipping_status_filter') || '';
    const normalizedStatus = rawStatus.toLowerCase();
    const statusForApi = VALID_SHIPPING_STATUS.includes(normalizedStatus) ? normalizedStatus : '';

    var filters = {
        ml_account_id: urlParams.get('account_filter') || '',
        shipping_status_filter: statusForApi,
        logistic_filter: (urlParams.get('logistic_filter') || '').toLowerCase(),
        date_from: urlParams.get('date_from') || '',
        date_to: urlParams.get('date_to') || '',
        period_filter: urlParams.get('period_filter') || '',
        search_query: (urlParams.get('search_query') || '').trim(),
        limit: selectedLimit,
        offset: (page - 1) * selectedLimit
    };
    
    // Construir URL da API (com prefixo /ml)
    var apiUrl = `/ml/api/orders?page=${page}&limit=${filters.limit}&offset=${filters.offset}`;
    
    if (filters.ml_account_id) apiUrl += `&ml_account_id=${encodeURIComponent(filters.ml_account_id)}`;
    if (filters.shipping_status_filter) apiUrl += `&shipping_status_filter=${encodeURIComponent(filters.shipping_status_filter)}`;
    if (filters.logistic_filter) apiUrl += `&logistic_filter=${encodeURIComponent(filters.logistic_filter)}`;
    if (filters.date_from) apiUrl += `&date_from=${encodeURIComponent(filters.date_from)}`;
    if (filters.date_to) apiUrl += `&date_to=${encodeURIComponent(filters.date_to)}`;
    if (filters.period_filter) apiUrl += `&period_filter=${encodeURIComponent(filters.period_filter)}`;
    if (filters.search_query) apiUrl += `&search_query=${encodeURIComponent(filters.search_query)}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => {
        if (checkSessionExpired(response)) {
            return;
        }
        return response.json();
    })
    .then(data => {
        console.log('Resposta da API:', data);
        if (data && data.success) {
            renderOrders(data.orders);
            updateOrdersCount(data.total);
            renderPagination(data.total, filters.limit, page);
            loadAccountsFilter(data.accounts || []);
        } else {
            console.error('Erro na API:', data);
            showError('Erro ao carregar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        showError('Erro ao carregar pedidos: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function renderOrders(orders) {
    const container = document.getElementById('orders-cards-container');
    if (!container) {
        return;
    }
    
    if (!orders || orders.length === 0) {
        container.innerHTML = `
            <div class="order-empty-state text-center text-muted">
                <i class="bi bi-archive"></i>
                <div class="mt-2">Nenhum pedido encontrado para os filtros selecionados.</div>
            </div>
        `;
        ordersCache = {};
        updateSelectedOrdersCount();
        return;
    }
    
    ordersCache = {};
    container.innerHTML = orders.map(order => {
        const cacheKey = order.id || order.ml_order_id || order.order_id;
        if (cacheKey) {
            ordersCache[cacheKey] = order;
        }

        const checkboxValue = cacheKey || '';
        const actions = renderOrderActions(order) || '';

        return `
            <div class="card order-card border-0">
                <div class="card-header order-card-header">
                    <div class="order-card-top flex-wrap">
                        <div class="d-flex align-items-start gap-3 flex-grow-1">
                            <div class="form-check mt-1">
                                <input class="form-check-input order-checkbox" type="checkbox" value="${checkboxValue}" onchange="updateSelectedOrdersCount()">
                            </div>
                            <div class="order-summary">${renderOrderSummary(order)}</div>
                        </div>
                     </div>
                 </div>
                 <div class="card-body">
                     <div class="order-details">${renderDetailsSummary(order)}</div>
                 </div>
                <div class="card-footer bg-white border-top-0 pt-0">
                    <div class="order-actions">${actions}</div>
                </div>
            </div>
        `;
    }).join('');

    updateSelectedOrdersCount();
}

function updateOrdersCount(total) {
    const ordersCountElement = document.getElementById('orders-count');
    if (ordersCountElement) {
        ordersCountElement.innerHTML = `<i class="bi bi-info-circle"></i> ${total} pedido(s) encontrado(s)`;
    }

    const totalOrdersElement = document.getElementById('total-orders');
    if (totalOrdersElement) {
        totalOrdersElement.textContent = `${total} pedidos`;
    }
}

function renderOrderSummary(order) {
    if (!order) {
        return '<span class="text-muted small">N/A</span>';
    }

    const orderId = order.ml_order_id || order.order_id || '-';
    const createdAt = formatDate(order.date_created);
    const accountLabel = order.account_nickname || order.account_name;
    const segments = [];

    if (orderId) {
        segments.push(`<span class="fw-semibold">${orderId}</span>`);
    }

    if (accountLabel) {
        segments.push(`<span class="text-muted">${sanitizeText(accountLabel)}</span>`);
    }

    if (createdAt) {
        segments.push(`<span class="text-muted">${createdAt}</span>`);
    }

    return `<div class="order-summary-inline">${segments.join('<span class="text-muted">•</span>')}</div>`;
}

function renderPagination(total, limit, currentPage) {
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');
    const totalPages = Math.ceil(total / limit);
    
    if (paginationInfo) {
    const startItem = (currentPage - 1) * limit + 1;
    const endItem = Math.min(currentPage * limit, total);
        paginationInfo.textContent = totalPages > 0
            ? `Mostrando ${startItem} a ${endItem} de ${total} pedidos`
            : 'Nenhum pedido encontrado';
    }

    if (!pagination) {
        return;
    }
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';

    const addPageButton = (page, label, disabled = false, active = false) => {
        html += `
            <li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                <a class="page-link" href="#" ${disabled ? 'tabindex="-1" aria-disabled="true"' : `onclick="loadOrders(${page})"`}>${label}</a>
            </li>
        `;
    };

    addPageButton(1, '<i class="bi bi-chevron-double-left"></i>', currentPage === 1);
    addPageButton(Math.max(1, currentPage - 1), '<i class="bi bi-chevron-left"></i>', currentPage === 1);

    const start = Math.max(1, currentPage - 2);
    const end = Math.min(totalPages, currentPage + 2);

    for (let page = start; page <= end; page++) {
        addPageButton(page, page, false, page === currentPage);
    }

    addPageButton(Math.min(totalPages, currentPage + 1), '<i class="bi bi-chevron-right"></i>', currentPage === totalPages);
    addPageButton(totalPages, '<i class="bi bi-chevron-double-right"></i>', currentPage === totalPages);

    pagination.innerHTML = html;
}

function loadAccountsFilter(accounts) {
    const select = document.getElementById('account_filter');
    if (!select) {
        return;
    }
    
    const currentValue = new URLSearchParams(window.location.search).get('account_filter') || '';
    select.innerHTML = '<option value="">Todas as contas</option>';
    
    (accounts || []).forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.nickname || 'Conta'} (${account.country_id || 'BR'})`;
        option.selected = String(currentValue) === String(account.id);
        select.appendChild(option);
    });
}

function renderInvoiceDropdown(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    if (!orderId) {
        return '';
    }

    let shippingDetailsParsed = {};
    if (order.shipping_details) {
        if (typeof order.shipping_details === 'string') {
            try {
                shippingDetailsParsed = JSON.parse(order.shipping_details);
            } catch (err) {
                shippingDetailsParsed = {};
            }
        } else {
            shippingDetailsParsed = order.shipping_details;
        }
    }

    const hasInvoice = Boolean(
        (order.invoice_pdf_url && order.invoice_pdf_url.trim()) ||
        (order.invoice_xml_url && order.invoice_xml_url.trim()) ||
        order.invoice_emitted ||
        (order.invoice_number && String(order.invoice_number).trim()) ||
        (order.invoice_key && order.invoice_key.trim())
    );

    const candidateShippingId = shippingDetailsParsed?.id || shippingDetailsParsed?.shipping_id;

    const downloadItem = hasInvoice
        ? `<li><a class="dropdown-item" href="/api/shipments/download-invoice/${orderId}" target="_blank"><i class="bi bi-file-earmark-pdf"></i> Baixar nota</a></li>`
        : `<li><button class="dropdown-item disabled" type="button"><i class="bi bi-file-earmark"></i> Nota indisponível</button></li>`;

    const emitButton = hasInvoice
        ? `<li><button class="dropdown-item disabled" type="button" title="Nota já emitida"><i class="bi bi-check2-circle"></i> Nota já emitida</button></li>`
        : `<li><button class="dropdown-item" type="button" onclick="emitInvoiceForOrder('${orderId}', this)"><i class="bi bi-file-earmark-plus"></i> Emitir pelo ML</button></li>`;

    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Opções de nota fiscal">
                <i class="bi bi-file-earmark-text"></i>
            </button>
            <ul class="dropdown-menu">
                <li><button class="dropdown-item" type="button" onclick="syncInvoiceForOrder('${orderId}', this)"><i class="bi bi-arrow-repeat"></i> Sincronizar com ML</button></li>
                ${emitButton}
                <li><hr class="dropdown-divider"></li>
                ${downloadItem}
            </ul>
        </div>
    `;
}

function renderLabelDropdown(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    const shippingId = order.shipping_id || (order.shipping_details && order.shipping_details.id);
    const logisticType = (order.shipping_type || order.shipping_logistic_type || '').toString().toLowerCase();
    const shippingStatus = (order.shipping_status || (order.shipping_details && order.shipping_details.status) || '').toString().toLowerCase();

    if (!orderId || logisticType === 'fulfillment' || logisticType === 'full') {
        return '';
    }

    const hiddenStatuses = new Set(['shipped', 'in_transit', 'out_for_delivery', 'soon_deliver', 'delivered']);
    if (hiddenStatuses.has(shippingStatus)) {
        return '';
    }

    if (!shippingId) {
        return `<button class="btn btn-outline-secondary" type="button" title="Etiqueta indisponível" disabled><i class="bi bi-printer"></i></button>`;
    }

    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir etiqueta">
                <i class="bi bi-printer"></i>
            </button>
            <ul class="dropdown-menu">
                <li><button class="dropdown-item" type="button" onclick="downloadShippingLabel('${orderId}', 'pdf', this)"><i class="bi bi-filetype-pdf"></i> PDF</button></li>
                <li><button class="dropdown-item" type="button" onclick="downloadShippingLabel('${orderId}', 'zpl2', this)"><i class="bi bi-printer-fill"></i> ZPL2</button></li>
                <li><button class="dropdown-item" type="button" onclick="downloadShippingLabel('${orderId}', 'zpl2pdf', this)"><i class="bi bi-file-earmark-pdf"></i> ZPL2 → PDF</button></li>
            </ul>
        </div>
    `;
}

async function syncInvoiceForOrder(orderId, triggerElement) {
    if (!orderId) return;

    const button = triggerElement;
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sincronizando...';

    try {
        const response = await fetch(`/api/shipments/sync-single-invoice/${orderId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.error || `Erro ${response.status}`);
        }

        showSuccess(`Nota fiscal do pedido ${orderId} sincronizada.`);
    } catch (error) {
        console.error('Erro ao sincronizar nota:', error);
        showError(error.message || 'Erro ao sincronizar nota fiscal.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

async function emitInvoiceForOrder(orderId, triggerElement) {
    if (!orderId) return;

    const button = triggerElement;
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Emitindo...';

    try {
        const response = await fetch(`/api/shipments/emit-invoice/${orderId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const data = await response.json();
        if (!response.ok || !data.success) {
            let errorMessage = data.error || data.message || `Erro ${response.status}`;
            if (data.details && typeof data.details === 'object') {
                const mlMessage = data.details.message || data.details.error;
                if (mlMessage && mlMessage !== errorMessage) {
                    errorMessage += ` (${mlMessage})`;
                }
            }
            if (data.release_date || /ainda não está liberado para emissão de NF/i.test(errorMessage)) {
                showInvoiceReleaseModal(data.release_date, errorMessage);
            } else {
                showError(errorMessage);
            }
            return;
        }

        showSuccess(data.message || `Nota fiscal do pedido ${orderId} emitida com sucesso.`);
        loadOrders(currentPage);
    } catch (error) {
        console.error('Erro ao emitir nota:', error);
        showError(error.message || 'Erro ao emitir nota fiscal.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

async function syncSingleOrder(orderId, triggerElement) {
    if (!orderId) return;

    const button = triggerElement;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    try {
        const response = await fetch(`/api/shipments/sync-single-order/${orderId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.error || data.message || `Erro ${response.status}`);
        }

        showSuccess(data.message || `Pedido ${orderId} sincronizado com sucesso.`);
        loadOrders(currentPage);
    } catch (error) {
        console.error('Erro ao sincronizar pedido:', error);
        showError(error.message || 'Erro ao sincronizar pedido.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function updateInternalStatus(orderId, statusValue, triggerElement) {
    if (!orderId) return;

    const dropdownMenu = triggerElement.closest('.dropdown-menu');
    const toggleButton = dropdownMenu ? dropdownMenu.previousElementSibling : null;
    const originalToggleContent = toggleButton ? toggleButton.innerHTML : null;

    if (toggleButton) {
        toggleButton.disabled = true;
        toggleButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    }

    try {
        const response = await fetch(`/api/orders/${orderId}/internal-status`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: statusValue })
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.error || data.message || `Erro ${response.status}`);
        }

        const statusKey = data.status || null;
        const label = data.status_label || 'Sem status';
        if (statusKey) {
            showSuccess(`Status interno atualizado para ${label}.`);
        } else {
            showSuccess('Status interno removido.');
        }

        const dropdownInstance = toggleButton ? bootstrap.Dropdown.getOrCreateInstance(toggleButton) : null;
        if (dropdownInstance) {
            dropdownInstance.hide();
        }

        loadOrders(currentPage);
    } catch (error) {
        console.error('Erro ao atualizar status interno:', error);
        showError(error.message || 'Erro ao atualizar status interno.');
    } finally {
        if (toggleButton) {
            toggleButton.disabled = false;
            if (originalToggleContent !== null) {
                toggleButton.innerHTML = originalToggleContent;
            }
        }
    }
}

async function downloadShippingLabel(orderId, format = 'pdf', triggerElement) {
    if (!orderId) return;

    const button = triggerElement;
    const originalHtml = button.innerHTML;
    const formatLabels = {
        pdf: 'PDF',
        zpl2: 'ZPL2',
        zpl2pdf: 'ZPL2 → PDF'
    };

    button.disabled = true;
    button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Gerando ${formatLabels[format] || ''}...`;

    try {
        const response = await fetch(`/api/shipments/download-label/${orderId}?format=${format}`, {
            method: 'GET',
            credentials: 'include'
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const contentType = response.headers.get('content-type') || '';

        if (!response.ok) {
            if (contentType.includes('application/json')) {
                const data = await response.json();
                handleLabelJsonError(data, response.status);
            } else {
                showLabelErrorModal(`Erro ao baixar etiqueta (HTTP ${response.status}).`);
            }
            return;
        }

        if (contentType.includes('application/json')) {
            const data = await response.json();
            handleLabelJsonError(data, response.status);
            return;
        }

        const blob = await response.blob();
        const extensionMap = {
            pdf: 'pdf',
            zpl2: 'zpl',
            zpl2pdf: 'pdf'
        };
        const extension = extensionMap[format] || 'pdf';
        const fileName = `etiqueta-${orderId}.${extension}`;

        const blobUrl = window.URL.createObjectURL(blob);
        const downloadLink = document.createElement('a');
        downloadLink.href = blobUrl;
        downloadLink.download = fileName;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);

        setTimeout(() => {
            window.URL.revokeObjectURL(blobUrl);
        }, 1000);

        showSuccess('Etiqueta gerada com sucesso.');
    } catch (error) {
        console.error('Erro ao baixar etiqueta:', error);
        showLabelErrorModal(error.message || 'Erro ao baixar etiqueta.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

function handleLabelJsonError(data, statusCode) {
    const result = buildFriendlyLabelMessage(data, statusCode);
    showLabelErrorModal(result.message, result.details);
}

function buildFriendlyLabelMessage(data, statusCode) {
    const baseMessage = `Segundo o Mercado Livre, apenas envios em "Pronto para envio" com etiqueta liberada ("Pronto para imprimir" ou "Etiqueta impressa") permitem gerar a etiqueta.`;
    if (!data || typeof data !== 'object') {
        return {
            message: baseMessage,
            details: {
                status_code: statusCode || null,
                hint: 'Verifique o status do envio no Mercado Livre e tente novamente.',
                raw_detail: null
            }
        };
    }

    const normalize = (value) => {
        if (!value) return '';
        return value.toString().toLowerCase();
    };

    const statusRaw = normalize(data.status || data.shipping_status);
    const substatusRaw = normalize(data.substatus || data.shipping_substatus);

    const translatedStatus = statusRaw ? translateShippingLabel(statusRaw) : null;
    const translatedSubstatus = substatusRaw ? translateShippingLabel(substatusRaw) : null;

    const rawDetail = data.error || data.message || data.detail || '';
    const detailTextRaw = typeof rawDetail === 'string' ? rawDetail : JSON.stringify(rawDetail);
    const detailText = translateStatusesInText(detailTextRaw);

    let hint = LABEL_STATUS_HINTS[statusRaw] || '';
    if (!hint && translatedSubstatus) {
        hint = `Substatus atual: ${translatedSubstatus}. Aguarde a liberação do Mercado Livre para gerar a etiqueta.`;
    }
    if (!hint) {
        hint = 'Verifique o painel do Mercado Livre e tente novamente quando a etiqueta estiver liberada.';
    }

    const statusCodeValue = statusCode || data.status_code || data.code || null;

    return {
        message: baseMessage,
        details: {
            status_code: statusCodeValue,
            raw_status: statusRaw || null,
            translated_status: translatedStatus || null,
            raw_substatus: substatusRaw || null,
            translated_substatus: translatedSubstatus || null,
            hint,
            raw_detail: detailText,
            error: detailText
        }
    };
}

function openOrderJson(orderKey) {
    if (!orderKey || !ordersCache[orderKey]) {
        showError('Dados do pedido não encontrados.');
        return;
    }

    const modalElement = document.getElementById('orderJsonModal');
    const modalBody = document.getElementById('orderJsonContent');
    if (!modalElement || !modalBody) {
        showError('Modal de visualização não disponível.');
        return;
    }

    modalBody.textContent = JSON.stringify(ordersCache[orderKey], null, 2);
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function renderBuyerSummary(order) {
    const nickname = order.buyer_nickname ? sanitizeText(order.buyer_nickname) : '';
    const nameParts = [order.buyer_first_name, order.buyer_last_name].filter(Boolean).join(' ');
    const email = order.buyer_email || '';
    const phone = order.buyer_phone || order.buyer_phone_number || '';
    const address = order.shipping_address || order.buyer_address || {};

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.id || '';
        }
        return String(value);
    };

    const street = sanitizeText(address.address_line || address.street_name || address.street_address || '');
    const comment = sanitizeText(address.comment || address.suburb || '');
    const city = sanitizeText(extractValue(address.city));
    const state = sanitizeText(extractValue(address.state));
    const district = sanitizeText(extractValue(address.neighborhood));
    const postalCode = sanitizeText(address.zip_code || address.postal_code);

    let receiverName = '';
    const shippingDetails = order.shipping_details;
    if (shippingDetails && typeof shippingDetails === 'object') {
        const destination = shippingDetails.destination || {};
        receiverName = destination.receiver_name || extractValue(destination.receiverName);
        if (!receiverName) {
            const shippingAddr = destination.shipping_address || {};
            receiverName = extractValue(shippingAddr.receiver_name);
        }
        if (!receiverName) {
            const receiverAddress = shippingDetails.receiver_address || {};
            receiverName = extractValue(receiverAddress.receiver_name);
        }
    }

    if (!receiverName && address.receiver_name) {
        receiverName = sanitizeText(extractValue(address.receiver_name));
    }

    const formattedNameParts = sanitizeText(nameParts);
    const mainName = formattedNameParts || receiverName || nickname || 'Comprador';
    const showDistinctReceiver = receiverName && receiverName !== mainName && receiverName !== nickname;

    const locationLine = [city, state].filter(Boolean).join(' - ');

    const addressLines = [street, comment, district, locationLine, postalCode ? `CEP: ${postalCode}` : null].filter(Boolean);

    const lines = [];
    const namePartsInline = [
        `<span class="fw-semibold">${mainName}</span>`
    ];
    if (nickname) {
        namePartsInline.push(`<span class="text-muted">(${nickname})</span>`);
    }
    lines.push(`<div class="d-flex flex-wrap gap-2 align-items-center">${namePartsInline.join(' ')}</div>`);

    if (showDistinctReceiver) {
        lines.push(`<div class="text-muted small">${receiverName}</div>`);
    }
    lines.push(email ? `<div class="text-muted small"><i class="bi bi-envelope me-1"></i>${email}</div>` : '');
    lines.push(phone ? `<div class="text-muted small"><i class="bi bi-telephone me-1"></i>${phone}</div>` : '');
    lines.push(addressLines.length ? `<div class="text-muted small">${addressLines.join(' <span class="text-muted">•</span> ')}</div>` : '');

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}


function getItemQuantity(entry) {
    if (!entry) {
        return 0;
    }
    if (typeof entry.quantity === 'number') {
        return entry.quantity;
    }
    if (entry.requested_quantity && typeof entry.requested_quantity.value === 'number') {
        return entry.requested_quantity.value;
    }
    if (entry.available_quantity && typeof entry.available_quantity === 'number') {
        return entry.available_quantity;
    }
    return 0;
}

function extractGtinFromAttributes(attributes) {
    if (!attributes) {
        return '';
    }

    let attrs = attributes;
    if (typeof attrs === 'string') {
        try {
            attrs = JSON.parse(attrs);
        } catch (error) {
            return '';
        }
    }

    if (!Array.isArray(attrs) && typeof attrs === 'object') {
        attrs = Object.values(attrs);
    }

    if (!Array.isArray(attrs)) {
        return '';
    }

    const gtinKeys = new Set(['GTIN', 'EAN', 'UPC', 'BARCODE']);
    for (const attr of attrs) {
        if (!attr || typeof attr !== 'object') {
            continue;
        }
        const attrId = (attr.id || attr.name || '').toString().toUpperCase();
        if (gtinKeys.has(attrId)) {
            if (attr.value_name) {
                return attr.value_name;
            }
            if (attr.value_id) {
                return attr.value_id;
            }
            if (attr.value) {
                return attr.value;
            }
            if (attr.value_struct && typeof attr.value_struct === 'object' && attr.value_struct.number) {
                return attr.value_struct.number;
            }
        }
    }

    return '';
}

function handleProductImageClick(button) {
    if (!button) {
        return;
    }
    const imageUrl = button.dataset?.imageUrl;
    if (!imageUrl) {
        return;
    }
    const imageTitle = button.dataset?.imageTitle || 'Imagem do produto';
    showProductImage(imageUrl, imageTitle);
}

function showProductImage(imageUrl, title) {
    const modalElement = document.getElementById('productImageModal');
    const modalImage = document.getElementById('productImageModalImg');
    const modalTitle = document.getElementById('productImageModalTitle');

    if (!modalElement || !modalImage) {
        return;
    }

    modalImage.src = imageUrl;
    modalImage.alt = title || 'Imagem do produto';
    if (modalTitle) {
        modalTitle.textContent = title || 'Imagem do produto';
    }

    const modalInstance = bootstrap.Modal.getOrCreateInstance(modalElement);
    modalInstance.show();
}

function normalizeItemImageUrl(url) {
    if (!url) {
        return '';
    }
    let normalized = String(url).trim();
    if (!normalized) {
        return '';
    }
    if (normalized.startsWith('//')) {
        normalized = 'https:' + normalized;
    }
    if (normalized.startsWith('http://')) {
        normalized = 'https://' + normalized.slice(7);
    }
    return normalized;
}

function sanitizeText(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function getItemThumbnail(itemData) {
    if (!itemData || typeof itemData !== 'object') {
        return '';
    }

    if (itemData.thumbnail) {
        return normalizeItemImageUrl(itemData.thumbnail);
    }

    if (Array.isArray(itemData.pictures) && itemData.pictures.length) {
        const firstPicture = itemData.pictures[0];
        if (typeof firstPicture === 'string') {
            return normalizeItemImageUrl(firstPicture);
        }
        if (firstPicture && typeof firstPicture === 'object') {
            return normalizeItemImageUrl(firstPicture.url || firstPicture.secure_url);
        }
    }

    if (itemData.picture_url) {
        return normalizeItemImageUrl(itemData.picture_url);
    }

    if (Array.isArray(itemData.picture_urls) && itemData.picture_urls.length) {
        return normalizeItemImageUrl(itemData.picture_urls[0]);
    }

    if (Array.isArray(itemData.picture_ids) && itemData.picture_ids.length) {
        return `https://http2.mlstatic.com/D_${itemData.picture_ids[0]}-O.jpg`;
    }

    return '';
}

function renderAmountSummary(order) {
    const totalAmount = order.total_amount || 0;
    const saleFees = order.sale_fees || 0;
    const shippingCost = order.shipping_cost || 0;
    const couponAmount = order.coupon_amount || 0;
    const advertisingCost = order.advertising_cost || 0;
    const currency = order.currency_id || 'BRL';

    const netAmount = totalAmount - saleFees - shippingCost - couponAmount;

    const lines = [
        `<div class="fw-semibold text-primary">${formatCurrency(totalAmount, currency)}</div>`,
        `<div class="text-muted small">Comissão: ${formatCurrency(saleFees, currency)}</div>`,
        `<div class="text-muted small">Frete: ${formatCurrency(shippingCost, currency)}</div>`
    ];

    if (couponAmount > 0) {
        lines.push(`<div class="text-muted small">Desconto: -${formatCurrency(couponAmount, currency)}</div>`);
    }

    if (advertisingCost > 0) {
        lines.push(`<div class="text-muted small">Publicidade: ${formatCurrency(advertisingCost, currency)}</div>`);
    }

    lines.push(`<div class="fw-semibold text-success mt-1">${formatCurrency(netAmount, currency)}</div>`);

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}

function renderDetailsSummary(order) {
    const buyerDetails = renderBuyerSummary(order);
    const defaultCurrency = order.currency_id || 'BRL';
    const enrichedItems = Array.isArray(order.order_items_enriched) ? order.order_items_enriched : [];
    const itemsToRender = [];

    if (enrichedItems.length > 0) {
        enrichedItems.forEach(item => {
            const quantity = Number(item.quantity ?? 1) || 1;
            const unitPrice = Number(item.unit_price ?? item.unitPrice ?? 0) || 0;
            const totalPrice = Number(item.total_price ?? (unitPrice * quantity)) || 0;
            const currency = item.currency || defaultCurrency;
            const thumbnail = item.thumbnail ? normalizeItemImageUrl(item.thumbnail) : '';
            const sellerSku = item.seller_sku || item.sku || '';
            const gtin = item.gtin || '';
            const permalink = item.permalink ? normalizeItemImageUrl(item.permalink) : '';
            const title = item.title || 'Item sem título';

            itemsToRender.push({
                title,
                quantity,
                unitPrice,
                totalPrice,
                currency,
                thumbnail,
                sellerSku,
                gtin,
                permalink
            });
        });
    }

    if (!itemsToRender.length) {
        let itemsRaw = order.order_items;
    if (!itemsRaw) {
        return `${buyerDetails || ''}<span class="text-muted small">N/A</span>`;
    }
    
    if (typeof itemsRaw === 'string') {
        try {
            itemsRaw = JSON.parse(itemsRaw);
    } catch (error) {
            console.warn('Não foi possível parsear order_items:', error);
            itemsRaw = [];
        }
    }
    
    if (!Array.isArray(itemsRaw) || itemsRaw.length === 0) {
        return '<span class="text-muted small">N/A</span>';
    }
    
        itemsRaw.forEach(entry => {
            const itemData = (entry && typeof entry === 'object' && entry.item && typeof entry.item === 'object')
                ? entry.item
                : (entry && typeof entry === 'object' ? entry : {});

            const title = itemData?.title || itemData?.name || entry?.title || entry?.name || 'Item sem título';
            const quantity = getItemQuantity(entry) || 1;
            const unitPrice = Number(entry.unit_price ?? itemData?.unit_price ?? 0) || 0;
            const totalPrice = unitPrice * quantity;
            const currency = entry.currency_id || itemData?.currency_id || defaultCurrency;
            const thumbnail = normalizeItemImageUrl(getItemThumbnail(itemData));
            const sellerSku = itemData?.seller_sku
                || itemData?.seller_custom_field
                || entry?.seller_sku
                || entry?.seller_custom_field
                || '';
            const gtin = extractGtinFromAttributes(itemData?.attributes)
                || extractGtinFromAttributes(entry?.attributes)
                || itemData?.gtin
                || itemData?.ean
                || '';
            const permalink = itemData?.permalink ? normalizeItemImageUrl(itemData.permalink) : '';

            itemsToRender.push({
                title,
                quantity,
                unitPrice,
                totalPrice,
                currency,
                thumbnail,
                sellerSku,
                gtin,
                permalink
            });
        });
    }

    if (!itemsToRender.length) {
        return '<span class="text-muted small">N/A</span>';
    }

    const totalAmount = order.total_amount || 0;
    const currencyForTotal = order.currency_id || defaultCurrency;

    const rows = itemsToRender.map(item => {
        const quantityValue = item.quantity || 1;
        const unitPrice = item.unitPrice || 0;
        const totalLine = item.totalPrice || (unitPrice * quantityValue);
        const currency = item.currency || defaultCurrency;
        const sanitizedThumbUrlAttr = sanitizeText(item.thumbnail || '');
        const sanitizedTitleAttr = sanitizeText(item.title || 'Imagem do produto');
        const thumbnailHtml = item.thumbnail
            ? `<button type="button" class="order-image-thumb btn btn-link p-0 border-0" data-image-url="${sanitizedThumbUrlAttr}" data-image-title="${sanitizedTitleAttr}" onclick="handleProductImageClick(this)">
                    <img src="${sanitizedThumbUrlAttr}" alt="${sanitizedTitleAttr}" class="img-fluid rounded" style="width:48px;height:48px;object-fit:cover;">
               </button>`
            : '<span class="text-muted">—</span>';
        const infoSegments = [];
        if (item.sellerSku) {
            infoSegments.push(`SKU: <span class="text-dark">${sanitizeText(item.sellerSku)}</span>`);
        }
        if (item.gtin) {
            infoSegments.push(`GTIN: <span class="text-dark">${sanitizeText(item.gtin)}</span>`);
        }
        const infoHtml = infoSegments.length
            ? `<div class="text-muted small d-flex flex-wrap gap-2">${infoSegments.join('<span class="text-muted">•</span>')}</div>`
            : '';
        const normalizedPermalink = item.permalink ? normalizeItemImageUrl(item.permalink) : '';
        const titleContent = normalizedPermalink
            ? `<a href="${normalizedPermalink}" target="_blank" rel="noopener" class="link-primary link-underline-opacity-0 link-underline-opacity-75-hover">${sanitizeText(item.title)}</a>`
            : sanitizeText(item.title);

        return `
            <tr>
                <td class="text-center align-middle" style="width:60px;">${thumbnailHtml}</td>
                <td class="align-middle">
                    <div class="fw-semibold small">${titleContent}</div>
                    ${infoHtml}
                </td>
                <td class="text-end align-middle" style="width:120px;">
                    ${formatCurrency(unitPrice, currency)}
                </td>
                <td class="text-end align-middle" style="width:80px;">
                    ${quantityValue}
                </td>
                <td class="text-end align-middle" style="width:120px;">
                    ${formatCurrency(totalLine, currency)}
                </td>
            </tr>
        `;
    });

    const shippingInline = renderShippingSummary(order);

    return `
        <div class="d-flex flex-column gap-3">
            ${buyerDetails ? `<div class="buyer-summary">${buyerDetails}</div>` : ''}
            <div class="table-responsive">
                <table class="table table-sm table-borderless align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width:60px;">Imagem</th>
                            <th>Descrição</th>
                            <th class="text-end" style="width:120px;">Valor unitário</th>
                            <th class="text-end" style="width:80px;">Quantidade</th>
                            <th class="text-end" style="width:120px;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.join('')}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="4" class="text-end fw-semibold">Total:</td>
                            <td class="text-end fw-semibold text-primary">${formatCurrency(totalAmount, currencyForTotal)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            ${shippingInline ? `<div class="pt-2 border-top">${shippingInline}</div>` : ''}
        </div>
    `;
}

function renderShippingSummary(order) {
    let shipping = order.shipping_details || order.shipping || {};
    if (typeof shipping === 'string') {
        try {
            shipping = JSON.parse(shipping);
        } catch (err) {
            shipping = {};
        }
    }

    const logisticTypeRaw = shipping.shipping_option?.logistic_type
        || shipping.logistic_type
        || shipping.logistic?.type
        || order.logistic_type
        || order.shipping_logistic_type
        || order.shipping_type;

    const logisticLabel = getLogisticLabel(logisticTypeRaw);
    const statusRaw = shipping.status || order.shipping_status || '';
    const substatusRaw = shipping.substatus || order.shipping_substatus || '';
    const status = (statusRaw || '').toString().toLowerCase();
    const substatus = (substatusRaw || '').toString().toLowerCase();
    const translatedStatus = status ? translateShippingLabel(status) : null;
    const translatedSubstatus = substatus ? translateShippingLabel(substatus) : null;
    const statusHistory = shipping.status_history || {};

    const shippedDate = shipping.date_shipped || statusHistory.date_shipped || order.date_shipped;
    const deliveredDate = statusHistory.date_delivered || shipping.date_delivered || order.date_delivered;
    const estimatedDate = shipping.shipping_option?.estimated_delivery_final?.date
        || shipping.shipping_option?.estimated_delivery_limit?.date
        || shipping.estimated_delivery
        || order.estimated_delivery_date;

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.description || value.id || '';
        }
        return String(value);
    };

    const shippingMethodSource = logisticLabel
        || extractValue(order.shipping_method)
        || extractValue(order.shipping_mode)
        || extractValue(shipping.shipping_option?.shipping_method)
        || extractValue(shipping.shipping_option?.name)
        || extractValue(logisticTypeRaw);

    const shippingMethod = getLogisticLabel(shippingMethodSource) || logisticLabel || extractValue(logisticTypeRaw) || null;
    const isPickup = ['xd_drop_off', 'drop_off'].includes((logisticTypeRaw || '').toString().toLowerCase());

    const segments = [];
    const badgeClass = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
    if (shippingMethod) {
        segments.push(`<span class="badge ${badgeClass}">${shippingMethod}</span>`);
    }

    if (order.internal_status_label) {
        const internalLabel = sanitizeText(order.internal_status_label);
        segments.push(`<span class="badge bg-dark text-uppercase">${internalLabel}</span>`);
    }

    if (translatedStatus) {
        const readyStatuses = new Set(['ready_to_ship', 'ready_to_print', 'printed', 'packed', 'ready_to_pack']);
        const transitStatuses = new Set(['shipped', 'in_transit', 'out_for_delivery', 'soon_deliver']);

        if (status === 'pending') {
            segments.push(`<span class="text-secondary">⏳ ${translatedStatus}</span>`);
        } else if (readyStatuses.has(status)) {
            segments.push(`<span class="text-warning">📦 ${translatedStatus}</span>`);
        } else if (status === 'delivered') {
            segments.push(`<span class="text-success fw-semibold">✓ ${translatedStatus}</span>`);
        } else if (transitStatuses.has(status)) {
            segments.push(`<span class="text-info">🚚 ${translatedStatus}</span>`);
        } else {
            const icon = shippingStatusIcons[status] || '🚚';
            const statusClass = getShippingStatusClass(status);
            const baseClass = statusClass ? `${statusClass} small` : 'text-muted';
            segments.push(`<span class="${baseClass}">${icon} ${translatedStatus}</span>`);
        }
    }

    const isPointCollection = logisticTypeRaw && logisticTypeRaw.toString().toLowerCase() === 'xd_drop_off';
    const isBuffered = substatus === 'buffered';

    if (translatedSubstatus && translatedSubstatus !== '-' && translatedSubstatus !== translatedStatus) {
        segments.push(`<span class="text-muted">📍 ${translatedSubstatus}</span>`);
    }

    let bufferingDateUsed = null;
    if (isPointCollection) {
        const bufferingDateRaw =
            shipping.lead_time?.buffering?.date ||
            shipping.lead_time?.estimated_schedule_limit?.date ||
            shipping.lead_time?.estimated_delivery_time?.pay_before ||
            shipping.shipping_option?.buffering?.date ||
            shipping.lead_time?.pickup_promise?.from;

        if (isBuffered) {
            let bufferingMessage = '⚠️ Aguardando liberação do Mercado Livre para levar ao ponto de coleta.';
            if (bufferingDateRaw) {
                const bufferingDateFormatted = formatDateTime(bufferingDateRaw) || formatDateOnly(bufferingDateRaw);
                if (bufferingDateFormatted) {
                    bufferingMessage = `⚠️ Leve ao ponto de coleta a partir de ${bufferingDateFormatted}.`;
                    bufferingDateUsed = bufferingDateFormatted;
                }
            }
            segments.push(`<span class="text-warning small">${bufferingMessage}</span>`);
        } else if (bufferingDateRaw) {
            const bufferingDateFormatted = formatDateOnly(bufferingDateRaw);
            if (bufferingDateFormatted) {
                bufferingDateUsed = bufferingDateFormatted;
            }
        }
    }

    if (status === 'delivered' && deliveredDate) {
        const deliveredFormatted = formatDateOnly(deliveredDate);
        if (deliveredFormatted) {
            segments.push(`<span class="text-success">📅 ${deliveredFormatted}</span>`);
        }
    }

    if (status !== 'delivered' && shippedDate && !isPickup) {
        const shippedFormatted = formatDateOnly(shippedDate);
        if (shippedFormatted) {
            segments.push(`<span class="text-muted">📦 Registrado: ${shippedFormatted}</span>`);
        }
    }

    const dropOffDate = shipping.status_history?.date_handling || shipping.date_created || order.shipping_date;
    if (isPickup) {
        const dropOffFormatted = formatDateTime(dropOffDate);
        if (dropOffFormatted) {
            const dropOffLabel = (status === 'ready_to_ship' && substatus === 'dropped_off')
                ? '📦 Postado:'
                : '📦 Registrado:';
            segments.push(`<span class="text-muted">${dropOffLabel} ${dropOffFormatted}</span>`);
        }

        const bufferingDate = shipping.shipping_option?.buffering?.date;
        const bufferingFormatted = formatDateOnly(bufferingDate);
        if (bufferingFormatted && bufferingFormatted !== bufferingDateUsed) {
            segments.push(`<span class="text-muted">🗓 Liberado para envio em: ${bufferingFormatted}</span>`);
        }
    }

    if (estimatedDate && status !== 'delivered') {
        const estimatedFormatted = formatDateOnly(estimatedDate);
        if (estimatedFormatted) {
            segments.push(`<span class="text-muted">📅 Previsão: ${estimatedFormatted}</span>`);
        }
    }

    if (!segments.length && (logisticLabel || shippingMethod)) {
        const fallbackBadge = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
        const label = logisticLabel || shippingMethod || 'N/A';
        return `<div class="order-shipping-inline small"><span class="badge ${fallbackBadge}">${label}</span></div>`;
    }

    return segments.length
        ? `<div class="order-shipping-inline small text-muted d-flex flex-column gap-1"><div class="d-flex flex-wrap align-items-center gap-2">${segments.join('<span class="text-muted">•</span>')}</div></div>`
        : `<div class="order-shipping-inline small text-muted"><span class="badge bg-secondary">N/A</span></div>`;
}

function getLogisticLabel(logisticType) {
    const normalized = (logisticType || '').toString().toLowerCase();
    switch (normalized) {
        case 'fulfillment':
        case 'full':
            return 'Fulfillment';
        case 'cross_docking':
            return 'Cross Docking';
        case 'me2':
            return 'Mercado Envios';
        case 'me1':
            return 'Correios';
        case 'xd_drop_off':
        case 'drop_off':
        case 'ponto de coleta':
            return 'Ponto de Coleta';
        case 'self_service':
            return 'Envio próprio';
        default:
            return logisticType || 'N/A';
    }
}

function translateShippingLabel(value) {
    if (!value) return '-';
    const labels = {
        pending: 'Pendente',
        ready_to_ship: 'Pronto para envio',
        ready_to_print: 'Pronto para imprimir',
        printed: 'Etiqueta impressa',
        ready_to_pack: 'Pronto para embalar',
        packed: 'Pacote pronto',
        shipped: 'Enviado',
        in_transit: 'Em trânsito',
        out_for_delivery: 'Saiu para entrega',
        soon_deliver: 'Próximo da entrega',
        delivered: 'Entregue',
        not_delivered: 'Não entregue',
        cancelled: 'Cancelado',
        to_be_agreed: 'A combinar',
        error: 'Erro',
        buffered: 'Aguardando...',
        receiver_absent: 'Comprador ausente',
        receiver_absent_twice: 'Comprador ausente (2x)',
        in_warehouse: 'No armazém',
        in_packing_list: 'Na fila de embalagem',
        drop_off: 'Ponto de coleta',
        xd_drop_off: 'Ponto de coleta',
        dropped_off: 'Postado no ponto de coleta'
    };
    const normalized = value.toString().toLowerCase();
    if (labels[normalized]) {
        return labels[normalized];
    }
    return value.replace(/_/g, ' ');
}

const shippingStatusIcons = {
    pending: '⏳',
    ready_to_ship: '📦',
    ready_to_print: '📦',
    printed: '📦',
    ready_to_pack: '📦',
    packed: '📦',
    shipped: '🚚',
    in_transit: '🚚',
    out_for_delivery: '🚚',
    soon_deliver: '🚚',
    delivered: '✓',
    not_delivered: '⚠️',
    cancelled: '⛔',
    to_be_agreed: 'ℹ️',
    error: '⚠️',
    buffered: '⏳',
    receiver_absent: '📍',
    receiver_absent_twice: '📍',
    in_warehouse: '🏬',
    in_packing_list: '📦'
};

function getShippingStatusClass(status) {
    switch ((status || '').toString().toLowerCase()) {
        case 'delivered':
            return 'text-success fw-semibold';
        case 'shipped':
        case 'in_transit':
        case 'out_for_delivery':
            return 'text-info';
        case 'ready_to_ship':
        case 'ready_to_print':
        case 'ready_to_pack':
        case 'packed':
        case 'printed':
            return 'text-warning';
        case 'pending':
            return 'text-secondary';
        case 'not_delivered':
        case 'cancelled':
        case 'canceled':
            return 'text-danger';
        default:
            return 'text-muted';
    }
}

function getLogisticBadgeClass(logisticType) {
    const normalized = (logisticType || '').toString().toLowerCase();
    switch (normalized) {
        case 'fulfillment':
        case 'full':
            return 'badge bg-primary';
        case 'cross_docking':
            return 'badge bg-info';
        case 'me2':
            return 'badge bg-warning';
        case 'me1':
            return 'badge bg-secondary';
        case 'xd_drop_off':
        case 'drop_off':
        case 'ponto de coleta':
            return 'badge bg-secondary';
        case 'self_service':
            return 'badge bg-secondary';
        default:
            return 'badge bg-secondary';
    }
}

function renderInternalStatusDropdown(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    const shippingStatus = (order.shipping_status || '').toString().toLowerCase();
    const logisticType = (order.shipping_logistic_type || order.shipping_type || '').toString().toLowerCase();
    if (!orderId || shippingStatus !== 'ready_to_ship' || logisticType === 'fulfillment' || logisticType === 'full') {
        return '';
    }

    const currentStatus = order.internal_status || null;
    const currentLabel = currentStatus
        ? (order.internal_status_label || INTERNAL_STATUS_LABEL_MAP[currentStatus] || 'Status interno')
        : 'Status interno';

    const optionsItems = INTERNAL_STATUS_OPTIONS.map(option => {
        const isActive = currentStatus === option.value ? 'active' : '';
        const label = sanitizeText(option.label);
        return `
            <li>
                <button class="dropdown-item ${isActive}" type="button" onclick="updateInternalStatus('${orderId}', '${option.value}', this)">
                    ${label}
                </button>
            </li>
        `;
    }).join('');

    const clearActive = currentStatus ? '' : 'active';

    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Status interno do pedido">
                <i class="bi bi-flag"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li>
                    <button class="dropdown-item ${clearActive}" type="button" onclick="updateInternalStatus('${orderId}', null, this)">
                        Sem status
                    </button>
                </li>
                <li><hr class="dropdown-divider"></li>
                ${optionsItems}
            </ul>
        </div>
    `;
}

function renderOrderActions(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    const permalink = order.permalink || '';
    const segments = [];

    segments.push(`
        <button type="button" class="btn btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Ver detalhes do pedido">
            <i class="bi bi-eye"></i>
        </button>
    `);

    segments.push(`
        <button type="button" class="btn btn-outline-success" onclick="syncSingleOrder('${orderId}', this)" title="Sincronizar pedido com Mercado Livre">
            <i class="bi bi-arrow-repeat"></i>
        </button>
    `);

    segments.push(`
        <button type="button" class="btn btn-outline-secondary" onclick="copyOrderId('${orderId}')" title="Copiar ID do pedido">
            <i class="bi bi-clipboard"></i>
        </button>
    `);

    const internalStatusDropdown = renderInternalStatusDropdown(order);
    if (internalStatusDropdown) {
        segments.push(internalStatusDropdown);
    }

    const invoiceDropdown = renderInvoiceDropdown(order);
    if (invoiceDropdown) {
        segments.push(invoiceDropdown);
    }

    const labelDropdown = renderLabelDropdown(order);
    if (labelDropdown) {
        segments.push(labelDropdown);
    }

    const cacheKey = order.id || orderId;
    segments.push(`
        <button class="btn btn-outline-dark" onclick="openOrderJson('${cacheKey || orderId}')" title="Ver JSON do pedido">
            <i class="bi bi-code-slash"></i>
        </button>
    `);

    if (permalink) {
        segments.push(`
            <a href="${permalink}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-info" title="Ver no Mercado Livre">
                <i class="bi bi-box-arrow-up-right"></i>
            </a>
        `);
    }

    return `<div class="btn-group btn-group-sm flex-wrap" role="group">${segments.join('')}</div>`;
}

function viewOrderDetails(orderId) {
    if (!orderId) return;
    window.location.href = `/ml/orders/${orderId}`;
}

function copyOrderId(orderId) {
    if (!orderId) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(orderId).then(() => console.log(`ID do pedido ${orderId} copiado.`)).catch(err => {
            console.warn('Falha ao copiar ID:', err);
            alert(`ID do pedido: ${orderId}`);
        });
        } else {
        alert(`ID do pedido: ${orderId}`);
    }
}

function getPeriodDates(periodValue) {
    const today = new Date();
    const end = formatDateToISO(today);

    let startDate = null;
    switch (periodValue) {
        case 'today':
            startDate = today;
            break;
        case 'last_7_days':
            startDate = addDays(today, -6);
            break;
        case 'last_15_days':
            startDate = addDays(today, -14);
            break;
        case 'last_30_days':
            startDate = addDays(today, -29);
            break;
        case 'last_60_days':
            startDate = addDays(today, -59);
            break;
        case 'last_90_days':
            startDate = addDays(today, -89);
            break;
        default:
            return null;
    }

    return {
        from: formatDateToISO(startDate),
        to: end
    };
}

function addDays(date, days) {
    const newDate = new Date(date);
    newDate.setDate(newDate.getDate() + days);
    return newDate;
}

function formatDateToISO(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

</script>

{% endblock %}
