{% extends "base.html" %}

{% block title %}Pedidos - GVMIA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between flex-wrap gap-3 align-items-start">
            <div>
                <h1 class="h3 mb-1"><i class="bi bi-cart-check"></i> Pedidos Mercado Livre</h1>
                <p class="text-muted mb-0">
                    Acompanhe todos os pedidos importados
                    <span id="orders-count" class="ms-2 small text-secondary">
                        <i class="bi bi-info-circle"></i> Carregando...
                    </span>
                </p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-primary" onclick="syncOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar pedidos
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="importOrders()">
                    <i class="bi bi-download"></i> Importar pedidos
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="showDeleteOrdersModal()">
                    <i class="bi bi-trash"></i> Remover pedidos
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3" id="alerts-container"></div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <form class="row g-3 align-items-end">
                        <div class="col-12 col-md-3">
                            <label for="account_filter" class="form-label small text-uppercase text-muted">Conta</label>
                            <select name="account_filter" id="account_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="status_filter" class="form-label small text-uppercase text-muted">Status</label>
                            <select name="status_filter" id="status_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todos os status</option>
                                <option value="pending">Pendente</option>
                                <option value="confirmed">Confirmado</option>
                                <option value="paid">Pago</option>
                                <option value="shipped">Enviado</option>
                                <option value="delivered">Entregue</option>
                                <option value="cancelled">Cancelado</option>
                                <option value="refunded">Reembolsado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="period_filter" class="form-label small text-uppercase text-muted">Per√≠odo</label>
                            <select name="period_filter" id="period_filter" class="form-select" onchange="toggleCustomPeriod(); applyFilters();">
                                <option value="">Todos</option>
                                <option value="today">Hoje</option>
                                <option value="this_week">Esta semana</option>
                                <option value="this_month">Este m√™s</option>
                                <option value="last_month">M√™s anterior</option>
                                <option value="next_month">Pr√≥ximo m√™s</option>
                                <option value="next_30_days">Pr√≥ximos 30 dias</option>
                                <option value="next_60_days">Pr√≥ximos 60 dias</option>
                                <option value="next_90_days">Pr√≥ximos 90 dias</option>
                                <option value="this_year">Este ano</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="date_from" class="form-label small text-uppercase text-muted">Data inicial</label>
                            <input type="date" name="date_from" id="date_from" class="form-control" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="date_to" class="form-label small text-uppercase text-muted">Data final</label>
                            <input type="date" name="date_to" id="date_to" class="form-control" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-auto">
                            <label class="form-label small text-uppercase text-muted">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="bi bi-x-circle"></i> Limpar filtros
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
                        <div class="col-12 col-md-3">
                            <label for="customDateFrom" class="form-label small text-uppercase text-muted">Data inicial</label>
                            <input type="date" class="form-control" id="customDateFrom" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="customDateTo" class="form-label small text-uppercase text-muted">Data final</label>
                            <input type="date" class="form-control" id="customDateTo" onchange="applyFilters()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="row mb-4" id="loading-container" style="display: none;">
        <div class="col-12">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando pedidos...</p>
            </div>
        </div>
    </div>

    <!-- Lista de Orders -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 42px;">
                                        <input type="checkbox" id="select-all-orders" onchange="toggleSelectAllOrders()">
                                    </th>
                                    <th style="min-width: 200px;">Pedido</th>
                                    <th style="min-width: 200px;">Comprador</th>
                                    <th style="min-width: 180px;">Valores</th>
                                    <th style="min-width: 180px;">Envio</th>
                                    <th class="text-end" style="width: 120px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="bi bi-info-circle"></i> Carregando pedidos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagina√ß√£o -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    <span id="pagination-info">Mostrando 0 de 0 pedidos</span>
                </div>
                <nav aria-label="Navega√ß√£o de pedidos">
                    <ul class="pagination mb-0" id="pagination">
                        <!-- Pagina√ß√£o ser√° inserida aqui dinamicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o para Importa√ß√£o -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="bi bi-download text-success me-2"></i>Importa√ß√£o Inteligente de Pedidos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeImportModal"></button>
            </div>
            <div class="modal-body">
                <!-- Tela 1: Configura√ß√£o -->
                <div id="import-config" style="display: block;">
                    <div class="text-center mb-4">
                        <i class="bi bi-cloud-download text-primary" style="font-size: 3rem;"></i>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Pedidos dispon√≠veis:</strong> <span id="total-orders-available">Verificando...</span>
                    </div>
                    
                    <h6 class="mb-3">Estrat√©gia de Importa√ß√£o:</h6>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-gear text-primary me-2"></i>Importa√ß√£o em Lotes Inteligentes
                            </h6>
                            <p class="card-text small">
                                Para importar todos os pedidos sem sobrecarregar o sistema, 
                                faremos a importa√ß√£o em lotes de <strong>50 pedidos</strong> com pausas autom√°ticas entre cada lote.
                            </p>
                            <ul class="small mb-0">
                                <li>Lote: 50 pedidos por vez</li>
                                <li>Pausa entre pedidos: 5 segundos</li>
                                <li>Pausa entre lotes: 10 segundos</li>
                                <li>Tempo estimado: <span id="estimated-time">Calculando...</span></li>
                                <li>Voc√™ pode cancelar a qualquer momento</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Importa√ß√£o em Background:</strong> A importa√ß√£o rodar√° no servidor. Voc√™ pode fechar esta janela e at√© mesmo o navegador! O processo continuar√° executando.
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-laptop me-2"></i>
                        <strong>Dica:</strong> Ap√≥s iniciar, voc√™ pode continuar usando o sistema normalmente. A lista de pedidos ser√° atualizada automaticamente conforme novos pedidos forem importados.
                    </div>
                </div>
                
                <!-- Tela 2: Progresso -->
                <div id="import-progress" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-hourglass-split text-primary" style="font-size: 3rem;"></i>
                    </div>
                    
                    <h6 class="text-center mb-4">Importando pedidos...</h6>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Progresso Geral</span>
                            <span class="small"><strong id="progress-text">0 / 0 (0%)</strong></span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%">
                                <span id="progress-percentage">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-success" id="imported-count">0</h4>
                                    <small class="text-muted">Importados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-warning" id="updated-count">0</h4>
                                    <small class="text-muted">Atualizados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-primary" id="current-batch">1</h4>
                                    <small class="text-muted">Lote Atual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small">
                        <div id="import-status">Preparando importa√ß√£o...</div>
                        <div id="import-eta" class="mt-2 text-muted"></div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelImport()" id="cancel-import-btn">
                            <i class="bi bi-x-circle me-1"></i>Cancelar Importa√ß√£o
                        </button>
                    </div>
                </div>
                
                <!-- Tela 3: Conclus√£o -->
                <div id="import-complete" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    
                    <h5 class="text-center mb-4 text-success">Importa√ß√£o Conclu√≠da!</h5>
                    
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="card bg-success text-white">
                                <div class="card-body py-3">
                                    <h3 class="mb-0" id="final-imported">0</h3>
                                    <small>Pedidos Importados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-warning text-white">
                                <div class="card-body py-3">
                                    <h3 class="mb-0" id="final-updated">0</h3>
                                    <small>Pedidos Atualizados</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <div id="final-message">Todos os pedidos foram importados com sucesso!</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-modal-btn">
                    <i class="bi bi-x-circle me-1"></i>Fechar
                </button>
                <button type="button" class="btn btn-success" onclick="startBatchImport()" id="start-import-btn">
                    <i class="bi bi-download me-1"></i>Iniciar Importa√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

<style>

/* Estilos para bot√µes em loading */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.btn .spinner-border {
    color: currentColor;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

/* Estilos para o modal de importa√ß√£o */
#importModal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

#importModal .modal-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 12px 12px 0 0;
    border: none;
}

#importModal .modal-header .btn-close {
    filter: invert(1);
}

#importModal .modal-body {
    padding: 2rem;
}

#importModal .alert-info {
    border-left: 4px solid #17a2b8;
    background-color: #f8f9fa;
}

#importModal .list-unstyled li {
    padding: 0.5rem 0;
    font-size: 0.9rem;
}

#importModal .modal-footer {
    border: none;
    padding: 1rem 2rem 2rem 2rem;
}
</style>

<script>
let currentPage = 1;
let currentLimit = 50;
let currentFilters = {};
let ordersCache = {};

// Fun√ß√£o para verificar se a resposta indica sess√£o expirada
function checkSessionExpired(response) {
    if (response.status === 401) {
        showError('Sess√£o expirada. Redirecionando para login...');
        
        // Ocultar elementos de usu√°rio logado
        hideUserElements();
        
        setTimeout(() => {
            window.location.href = '/auth/login';
        }, 2000);
        return true;
    }
    return false;
}

// Fun√ß√£o para ocultar elementos de usu√°rio logado
function hideUserElements() {
    // Ocultar bot√µes de a√ß√£o
    const syncBtn = document.getElementById('sync-btn');
    const importBtn = document.getElementById('import-btn');
    const deleteBtn = document.querySelector('button[onclick="showDeleteOrdersModal()"]');
    
    if (syncBtn) syncBtn.style.display = 'none';
    if (importBtn) importBtn.style.display = 'none';
    if (deleteBtn) deleteBtn.style.display = 'none';
    
    // Ocultar filtros
    const filtersSection = document.querySelector('.row:has(.card .card-header h5)');
    if (filtersSection) {
        const filtersCard = filtersSection.querySelector('.card');
        if (filtersCard && filtersCard.textContent.includes('Filtros')) {
            filtersSection.style.display = 'none';
        }
    }
    
    // Ocultar tabela
    const tableSection = document.querySelector('.row:has(.card .card-header h5)');
    if (tableSection) {
        const tableCard = tableSection.querySelector('.card');
        if (tableCard && tableCard.textContent.includes('Lista de Pedidos')) {
            tableSection.style.display = 'none';
        }
    }
    
    // Mostrar mensagem de sess√£o expirada
    const alertContainer = document.getElementById('alerts-container');
    if (alertContainer) {
        alertContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning text-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Sess√£o expirada!</strong> Fa√ßa login novamente para continuar.
                </div>
            </div>
        `;
    }
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    loadOrders();
});


function loadOrders(page = 1) {
    showLoading(true);
    
    const urlParams = new URLSearchParams(window.location.search);
    
    // Coletar filtros
    const selectedLimit = 50;  // Limite fixo de 50 pedidos por p√°gina
    
    const filters = {
        ml_account_id: urlParams.get('account_filter') || '',
        status_filter: urlParams.get('status_filter') || '',
        date_from: urlParams.get('date_from') || '',
        date_to: urlParams.get('date_to') || '',
        period_filter: urlParams.get('period_filter') || '',
        limit: selectedLimit,
        offset: (page - 1) * selectedLimit
    };
    
    // Construir URL da API (com prefixo /ml)
    let apiUrl = `/ml/api/orders?page=${page}&limit=${filters.limit}&offset=${filters.offset}`;
    
    if (filters.ml_account_id) apiUrl += `&ml_account_id=${encodeURIComponent(filters.ml_account_id)}`;
    if (filters.status_filter) apiUrl += `&status_filter=${encodeURIComponent(filters.status_filter)}`;
    if (filters.date_from) apiUrl += `&date_from=${encodeURIComponent(filters.date_from)}`;
    if (filters.date_to) apiUrl += `&date_to=${encodeURIComponent(filters.date_to)}`;
    if (filters.period_filter) apiUrl += `&period_filter=${encodeURIComponent(filters.period_filter)}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => {
        if (checkSessionExpired(response)) {
            return;
        }
        return response.json();
    })
    .then(data => {
        console.log('Resposta da API:', data);
        if (data && data.success) {
            renderOrders(data.orders);
            updateOrdersCount(data.total);
            renderPagination(data.total, filters.limit, page);
            loadAccountsFilter(data.accounts || []);
        } else {
            console.error('Erro na API:', data);
            showError('Erro ao carregar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisi√ß√£o:', error);
        showError('Erro ao carregar pedidos: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function renderOrders(orders) {
    const tbody = document.getElementById('orders-table-body');

    if (!orders || orders.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="bi bi-info-circle"></i> Nenhum pedido encontrado
                </td>
            </tr>
        `;
        return;
    }

    ordersCache = {};
    tbody.innerHTML = orders.map(order => {
        const cacheKey = order.id || order.ml_order_id || order.order_id;
        if (cacheKey) {
            ordersCache[cacheKey] = order;
        }
        return `
        <tr>
            <td class="align-middle">
                <input type="checkbox" class="order-checkbox" value="${order.id}" onchange="updateSelectedOrdersCount()">
            </td>
            <td class="align-middle">${renderOrderSummary(order)}</td>
            <td class="align-middle">${renderBuyerSummary(order)}</td>
            <td class="align-middle">${renderAmountSummary(order)}</td>
            <td class="align-middle">${renderShippingSummary(order)}</td>
            <td class="align-middle text-end">${renderOrderActions(order)}</td>
        </tr>
    `}).join('');
}

function renderOrderSummary(order) {
    if (!order) {
        return '<span class="text-muted small">N/A</span>';
    }

    const orderId = order.ml_order_id || order.order_id || '-';
    const createdAt = formatDate(order.date_created);
    const accountLabel = order.account_nickname || order.account_name;
    const statusBadge = `<span class="badge ${getStatusBadgeClass(order.status)}">${getStatusLabel(order.status)}</span>`;

    const lines = [
        `<div class="fw-semibold">${orderId}</div>`,
        accountLabel ? `<div class="text-muted small">${accountLabel}</div>` : '',
        createdAt ? `<div class="text-muted small">${createdAt}</div>` : '',
        `<div class="mt-1">${statusBadge}</div>`
    ].filter(Boolean);

    return `<div class="d-flex flex-column gap-1">${lines.join('')}</div>`;
}

function renderBuyerSummary(order) {
    const nickname = order.buyer_nickname || 'N/A';
    const nameParts = [order.buyer_first_name, order.buyer_last_name].filter(Boolean).join(' ');
    const email = order.buyer_email || '';
    const phone = order.buyer_phone || order.buyer_phone_number || '';
    const address = order.shipping_address || order.buyer_address || {};

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.id || '';
        }
        return String(value);
    };

    const street = address.address_line || address.street_name || address.street_address || '';
    const comment = address.comment || address.suburb || '';
    const city = extractValue(address.city);
    const state = extractValue(address.state);
    const district = extractValue(address.neighborhood);
    const postalCode = address.zip_code || address.postal_code;

    const locationLine = [city, state].filter(Boolean).join(' - ');

    const addressLines = [street, comment, district, locationLine, postalCode ? `CEP: ${postalCode}` : null].filter(Boolean);

    const lines = [
        `<div class="fw-semibold">${nickname}</div>`,
        nameParts ? `<div class="text-muted small">${nameParts}</div>` : '',
        email ? `<div class="text-muted small"><i class="bi bi-envelope me-1"></i>${email}</div>` : '',
        phone ? `<div class="text-muted small"><i class="bi bi-telephone me-1"></i>${phone}</div>` : '',
        addressLines.length ? `<div class="text-muted small">${addressLines.join('<br>')}</div>` : ''
    ].filter(Boolean);

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}

function renderAmountSummary(order) {
    const totalAmount = order.total_amount || 0;
    const saleFees = order.sale_fees || 0;
    const shippingCost = order.shipping_cost || 0;
    const couponAmount = order.coupon_amount || 0;
    const advertisingCost = order.advertising_cost || 0;
    const currency = order.currency_id || 'BRL';

    const netAmount = totalAmount - saleFees - shippingCost - couponAmount;

    const lines = [
        `<div class="fw-semibold text-primary">${formatCurrency(totalAmount, currency)}</div>`,
        `<div class="text-muted small">Comiss√£o: ${formatCurrency(saleFees, currency)}</div>`,
        `<div class="text-muted small">Frete: ${formatCurrency(shippingCost, currency)}</div>`
    ];

    if (couponAmount > 0) {
        lines.push(`<div class="text-muted small">Desconto: -${formatCurrency(couponAmount, currency)}</div>`);
    }

    if (advertisingCost > 0) {
        lines.push(`<div class="text-muted small">Publicidade: ${formatCurrency(advertisingCost, currency)}</div>`);
    }

    lines.push(`<div class="fw-semibold text-success mt-1">${formatCurrency(netAmount, currency)}</div>`);

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}

function getShippingStatusClass(status) {
    switch (status) {
        case 'delivered':
            return 'text-success fw-semibold';
        case 'shipped':
        case 'in_transit':
        case 'out_for_delivery':
            return 'text-info';
        case 'ready_to_ship':
        case 'ready_to_print':
        case 'ready_to_pack':
        case 'packed':
        case 'printed':
            return 'text-warning';
        case 'pending':
            return 'text-secondary';
        case 'not_delivered':
            return 'text-danger';
        default:
            return 'text-muted';
    }
}

function renderShippingSummary(order) {
    let shipping = order.shipping_details || order.shipping || {};
    if (typeof shipping === 'string') {
        try {
            shipping = JSON.parse(shipping);
        } catch (err) {
            shipping = {};
        }
    }
    const logisticTypeRaw = shipping.shipping_option?.logistic_type
        || shipping.logistic_type
        || shipping.logistic?.type
        || order.logistic_type
        || order.shipping_logistic_type
        || order.shipping_type;
    const logisticLabel = getLogisticLabel(logisticTypeRaw);
    const statusRaw = shipping.status || order.shipping_status || '';
    const substatusRaw = shipping.substatus || order.shipping_substatus || '';
    const status = (statusRaw || '').toString().toLowerCase();
    const statusDisplay = getShippingStatusDisplay(status);
    const substatus = translateShippingSubstatus((substatusRaw || '').toString().toLowerCase());
    const statusHistory = shipping.status_history || {};

    const shippedDate = shipping.date_shipped || statusHistory.date_shipped || order.date_shipped;
    const deliveredDate = statusHistory.date_delivered || shipping.date_delivered || order.date_delivered;
    const estimatedDate = shipping.shipping_option?.estimated_delivery_final?.date
        || shipping.shipping_option?.estimated_delivery_limit?.date
        || shipping.estimated_delivery
        || order.estimated_delivery_date;

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.description || value.id || '';
        }
        return String(value);
    };

    const shippingMethodSource = extractValue(order.shipping_method)
        || extractValue(order.shipping_mode)
        || extractValue(shipping.shipping_option?.shipping_method)
        || extractValue(shipping.shipping_option?.name)
        || logisticLabel
        || extractValue(logisticTypeRaw);

    const shippingMethod = getLogisticLabel(shippingMethodSource) || 'N/A';
    const shippingId = order.shipping_id || shipping.id;

    const lines = [];
    const badgeClass = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
    if (shippingMethod) {
        lines.push(`<span class="badge ${badgeClass}">${shippingMethod}</span>`);
    }

    if (statusDisplay) {
        const statusClass = getShippingStatusClass(status);
        lines.push(`<div class="${statusClass}">${statusDisplay.icon} ${statusDisplay.label}</div>`);
    }

    if (substatus && substatus !== statusDisplay?.label) {
        lines.push(`<div class="text-muted small">üìç ${substatus}</div>`);
    }

    if (status === 'delivered' && deliveredDate) {
        lines.push(`<div class="text-success small">üìÖ ${formatDateOnly(deliveredDate)}</div>`);
    }

    if (status !== 'delivered' && shippedDate) {
        lines.push(`<div class="text-muted small">üì¶ Enviado: ${formatDateOnly(shippedDate)}</div>`);
    }

    if (estimatedDate && status !== 'delivered') {
        const estimatedLabel = logisticLabel ? `${formatDateOnly(estimatedDate)} ‚Üí ${logisticLabel}` : formatDateOnly(estimatedDate);
        lines.push(`<div class="text-muted small">üìÖ Previs√£o: ${estimatedLabel}</div>`);
    }

    if (shippingId) {
        lines.push(`<div class="text-muted small">Envio: ${shippingId}</div>`);
    }

    if (!lines.length) {
        lines.push('<span class="text-muted small">N/A</span>');
    }

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}

function renderOrderActions(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    const cacheKey = order.id || orderId;
    const shipping = order.shipping_details || order.shipping || {};
    const logisticType = shipping.logistic_type || shipping.logistic?.type || order.shipping_type;
    const hasShippingId = Boolean(order.shipping_id || shipping.id);

    return `
        <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Ver detalhes">
                <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-secondary" onclick="copyOrderId('${orderId}')" title="Copiar ID do pedido">
                <i class="bi bi-clipboard"></i>
            </button>
            ${renderInvoiceDropdown(orderId)}
            ${renderLabelDropdown(orderId, hasShippingId, logisticType)}
            <button class="btn btn-outline-dark" onclick="openOrderJson('${cacheKey || orderId}')" title="Ver JSON do pedido">
                <i class="bi bi-code-slash"></i>
            </button>
            <a href="/ml/orders/${orderId}" class="btn btn-outline-info" title="Abrir detalhes no painel">
                <i class="bi bi-box-arrow-up-right"></i>
            </a>
        </div>
    `;
}

function renderPagination(total, limit, currentPage) {
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');
    const totalPages = Math.ceil(total / limit);
    
    // Atualizar informa√ß√µes da pagina√ß√£o
    const startItem = (currentPage - 1) * limit + 1;
    const endItem = Math.min(currentPage * limit, total);
    paginationInfo.textContent = `Mostrando ${startItem} a ${endItem} de ${total} pedidos`;
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Bot√£o primeira p√°gina
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(1)" title="Primeira p√°gina">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
        `;
    }
    
    // Bot√£o anterior
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(${currentPage - 1})" title="P√°gina anterior">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // P√°ginas
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    // Adicionar retic√™ncias no in√≠cio se necess√°rio
    if (startPage > 1) {
        paginationHTML += `
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
        `;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${i})">${i}</a>
            </li>
        `;
    }
    
    // Adicionar retic√™ncias no final se necess√°rio
    if (endPage < totalPages) {
        paginationHTML += `
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
        `;
    }
    
    // Bot√£o pr√≥ximo
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(${currentPage + 1})" title="Pr√≥xima p√°gina">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    // Bot√£o √∫ltima p√°gina
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(${totalPages})" title="√öltima p√°gina">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
        `;
    }
    
    pagination.innerHTML = paginationHTML;
}

function loadAccountsFilter(accounts) {
    const select = document.getElementById('account_filter');
    const currentValue = new URLSearchParams(window.location.search).get('account_filter') || '';
    
    select.innerHTML = '<option value="">Todas as contas</option>';
    
    accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.nickname} (${account.country_id})`;
        option.selected = currentValue == account.id;
        select.appendChild(option);
    });
}

function toggleCustomPeriod() {
    const periodFilter = document.getElementById('period_filter').value;
    const customPeriodRow = document.getElementById('customPeriodRow');
    
    if (periodFilter === 'custom') {
        customPeriodRow.style.display = 'block';
    } else {
        customPeriodRow.style.display = 'none';
    }
}

function getPeriodDates(period) {
    const today = new Date();
    const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };
    
    console.log('Calculando per√≠odo:', period, 'Data atual:', formatDate(today));
    
    switch (period) {
        case 'today':
            const todayFormatted = formatDate(today);
            console.log('Per√≠odo hoje:', todayFormatted, 'a', todayFormatted);
            return { from: todayFormatted, to: todayFormatted };
        
        case 'this_week':
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            return { from: formatDate(startOfWeek), to: formatDate(endOfWeek) };
        
        case 'this_month':
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            return { from: formatDate(startOfMonth), to: formatDate(endOfMonth) };
        
        case 'last_month':
            const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            return { from: formatDate(startOfLastMonth), to: formatDate(endOfLastMonth) };
        
        case 'next_month':
            const startOfNextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const endOfNextMonth = new Date(today.getFullYear(), today.getMonth() + 2, 0);
            return { from: formatDate(startOfNextMonth), to: formatDate(endOfNextMonth) };
        
        case 'next_30_days':
            const next30Days = new Date(today);
            next30Days.setDate(today.getDate() + 30);
            return { from: formatDate(today), to: formatDate(next30Days) };
        
        case 'next_60_days':
            const next60Days = new Date(today);
            next60Days.setDate(today.getDate() + 60);
            return { from: formatDate(today), to: formatDate(next60Days) };
        
        case 'next_90_days':
            const next90Days = new Date(today);
            next90Days.setDate(today.getDate() + 90);
            return { from: formatDate(today), to: formatDate(next90Days) };
        
        case 'this_year':
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            const endOfYear = new Date(today.getFullYear(), 11, 31);
            return { from: formatDate(startOfYear), to: formatDate(endOfYear) };
        
        default:
            return null;
    }
}

function clearFilters() {
    // Limpar todos os filtros
    document.getElementById('account_filter').value = '';
    document.getElementById('status_filter').value = '';
    document.getElementById('date_from').value = '';
    document.getElementById('date_to').value = '';
    document.getElementById('period_filter').value = '';
    document.getElementById('customDateFrom').value = '';
    document.getElementById('customDateTo').value = '';
    
    // Ocultar per√≠odo personalizado
    document.getElementById('customPeriodRow').style.display = 'none';
    
    // Limpar URL e recarregar
    const url = new URL(window.location);
    url.search = '';
    window.history.pushState({}, '', url);
    
    // Recarregar pedidos
    loadOrders(1);
}

function applyFilters() {
    const periodFilter = document.getElementById('period_filter').value;
    let dateFrom = document.getElementById('date_from').value;
    let dateTo = document.getElementById('date_to').value;
    
    console.log('Aplicando filtros - Per√≠odo selecionado:', periodFilter);
    console.log('Datas iniciais - De:', dateFrom, 'At√©:', dateTo);
    
    // Se per√≠odo personalizado est√° selecionado, usar as datas customizadas
    if (periodFilter === 'custom') {
        const customDateFrom = document.getElementById('customDateFrom').value;
        const customDateTo = document.getElementById('customDateTo').value;
        if (customDateFrom) dateFrom = customDateFrom;
        if (customDateTo) dateTo = customDateTo;
        console.log('Per√≠odo personalizado - De:', dateFrom, 'At√©:', dateTo);
    } else if (periodFilter) {
        // Processar per√≠odo autom√°tico
        const dates = getPeriodDates(periodFilter);
        if (dates) {
            dateFrom = dates.from;
            dateTo = dates.to;
            console.log('Per√≠odo calculado - De:', dateFrom, 'At√©:', dateTo);
            // Atualizar os campos de data visualmente
            document.getElementById('date_from').value = dateFrom;
            document.getElementById('date_to').value = dateTo;
        }
    }
    
    const filters = {
        account_filter: document.getElementById('account_filter').value,
        status_filter: document.getElementById('status_filter').value,
        date_from: dateFrom,
        date_to: dateTo,
        period_filter: periodFilter,
        limit: 50  // Limite fixo de 50 pedidos por p√°gina
    };
    
    console.log('Filtros finais:', filters);
    
    // Atualizar URL
    const url = new URL(window.location);
    Object.keys(filters).forEach(key => {
        if (filters[key]) {
            url.searchParams.set(key, filters[key]);
        } else {
            url.searchParams.delete(key);
        }
    });
    
    window.history.pushState({}, '', url);
    loadOrders(1);
}

function syncOrders() {
    console.log('üîÑ Iniciando sincroniza√ß√£o de pedidos...');
    console.log('üåê URL:', window.location.origin + '/ml/api/orders/sync');
    
    // Mostrar loading
    showLoading(true);
    
    // Mostrar alerta de in√≠cio
    showSuccess('Iniciando sincroniza√ß√£o de pedidos...');
    
    console.log('üì§ Enviando requisi√ß√£o...');
    
    fetch('/ml/api/orders/sync', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(async response => {
        console.log('üì° Resposta recebida!');
        console.log('   Status:', response.status);
        console.log('   Status Text:', response.statusText);
        console.log('   Content-Type:', response.headers.get('content-type'));
        console.log('   Headers:', [...response.headers.entries()]);
        
        if (checkSessionExpired(response)) {
            console.log('‚ö†Ô∏è Sess√£o expirada, parando...');
            showLoading(false);
            return null;
        }
        
        // Verificar se √© JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('‚ùå Resposta n√£o √© JSON!');
            console.error('   Content-Type:', contentType);
            console.error('   Primeiros 500 caracteres:', text.substring(0, 500));
            throw new Error('Servidor retornou resposta inv√°lida (n√£o JSON)');
        }
        
        console.log('‚úÖ Resposta √© JSON, fazendo parse...');
        return response.json();
    })
    .then(data => {
        if (!data) {
            console.log('‚ö†Ô∏è Sem dados (sess√£o expirada?)');
            return; // Sess√£o expirada ou erro
        }
        
        console.log('üìä Dados da sincroniza√ß√£o:', data);
        if (data && data.success) {
            if (data.status === 'processing') {
                showSuccess(`üöÄ ${data.message || 'Sincroniza√ß√£o iniciada! Aguarde 1-2 minutos e atualize a p√°gina.'}`);
                // Auto-atualizar ap√≥s 60 segundos
                setTimeout(() => {
                    console.log('üîÑ Auto-atualizando p√°gina...');
                    loadOrders(currentPage);
                }, 60000);
            } else {
                showSuccess(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${data.total_saved || 0} pedidos novos, ${data.total_updated || 0} atualizados`);
                loadOrders(currentPage);
            }
        } else {
            showError('‚ùå Erro ao sincronizar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
        showLoading(false);
    })
    .catch(error => {
        console.error('‚ùå Erro capturado no catch:', error);
        console.error('   Mensagem:', error.message);
        console.error('   Stack:', error.stack);
        showError('Erro ao sincronizar pedidos: ' + error.message);
        showLoading(false);
    });
}

function refreshOrders() {
    loadOrders(currentPage);
}

// Vari√°veis de controle de importa√ß√£o
let importCancelled = false;
let totalOrdersToImport = 0;
let currentJobId = null;
let statusInterval = null;

function importOrders() {
    // Resetar vari√°veis
    importCancelled = false;
    
    // Mostrar modal de configura√ß√£o
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
    
    // Resetar telas
    document.getElementById('import-config').style.display = 'block';
    document.getElementById('import-progress').style.display = 'none';
    document.getElementById('import-complete').style.display = 'none';
    document.getElementById('start-import-btn').style.display = 'inline-block';
    
    // Verificar total de pedidos dispon√≠veis
    checkAvailableOrders();
}

function checkAvailableOrders() {
    document.getElementById('total-orders-available').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verificando...';
    
    fetch('/ml/api/orders/count', {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            const total = data.total_available || 0;
            const imported = data.total_imported || 0;
            const remaining = total - imported;
            
            totalOrdersToImport = remaining;
            
            document.getElementById('total-orders-available').innerHTML = 
                `<strong>${total}</strong> pedidos no ML | 
                 <strong>${imported}</strong> j√° importados | 
                 <strong class="text-primary">${remaining}</strong> restantes`;
            
            // Calcular tempo estimado 
            // (50 pedidos * 5seg cada) + 10seg pausa entre lotes = ~260 segundos por lote
            const totalBatches = Math.ceil(remaining / 50);
            const estimatedSeconds = (totalBatches * 260); // 260 segundos por lote
            const estimatedMinutes = Math.ceil(estimatedSeconds / 60);
            document.getElementById('estimated-time').textContent = 
                estimatedMinutes > 0 ? `~${estimatedMinutes} minuto(s)` : 'Menos de 1 minuto';
        } else {
            document.getElementById('total-orders-available').textContent = 'Erro ao verificar';
        }
    })
    .catch(error => {
        console.error('Erro ao verificar pedidos:', error);
        document.getElementById('total-orders-available').textContent = 'Erro ao verificar';
    });
}

async function startBatchImport() {
    // Esconder bot√£o de iniciar
    document.getElementById('start-import-btn').style.display = 'none';
    
    // Mostrar tela de progresso
    document.getElementById('import-config').style.display = 'none';
    document.getElementById('import-progress').style.display = 'block';
    
    // Permitir fechar modal (job roda em background)
    document.getElementById('closeImportModal').disabled = false;
    document.getElementById('close-modal-btn').disabled = false;
    document.getElementById('close-modal-btn').innerHTML = 
        '<i class="bi bi-x-circle me-1"></i>Fechar (continua em background)';
    
    // Iniciar importa√ß√£o em background
    document.getElementById('import-status').innerHTML = 
        '<i class="bi bi-rocket me-2"></i>Iniciando importa√ß√£o em background...';
    
    try {
        const response = await fetch('/ml/api/orders/import-background', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            currentJobId = data.job_id;
            
            // Mostrar mensagem de sucesso
            showSuccess(`Importa√ß√£o iniciada em background! Job ID: ${currentJobId}`);
            
            // Iniciar monitoramento do status
            startJobMonitoring(currentJobId);
            
        } else {
            showError('Erro ao iniciar importa√ß√£o: ' + (data.error || 'Erro desconhecido'));
            // Voltar para tela de configura√ß√£o
            document.getElementById('import-progress').style.display = 'none';
            document.getElementById('import-config').style.display = 'block';
            document.getElementById('start-import-btn').style.display = 'inline-block';
        }
        
    } catch (error) {
        console.error('Erro ao iniciar importa√ß√£o:', error);
        showError('Erro ao iniciar importa√ß√£o: ' + error.message);
        // Voltar para tela de configura√ß√£o
        document.getElementById('import-progress').style.display = 'none';
        document.getElementById('import-config').style.display = 'block';
        document.getElementById('start-import-btn').style.display = 'inline-block';
    }
}

function startJobMonitoring(jobId) {
    // Limpar intervalo anterior se existir
    if (statusInterval) {
        clearInterval(statusInterval);
    }
    
    // Atualizar status a cada 3 segundos
    statusInterval = setInterval(() => {
        updateJobStatus(jobId);
    }, 3000);
    
    // Primeira atualiza√ß√£o imediata
    updateJobStatus(jobId);
}

async function updateJobStatus(jobId) {
    try {
        const response = await fetch(`/ml/api/orders/import-status/${jobId}`, {
            method: 'GET',
            credentials: 'include'
        });
        
        if (response.status === 404) {
            // Job n√£o existe mais (container reiniciado ou job perdido)
            clearInterval(statusInterval);
            document.getElementById('import-status').innerHTML = 
                '<i class="bi bi-exclamation-triangle me-2 text-warning"></i>' +
                'Job n√£o encontrado. O servidor pode ter sido reiniciado.<br>' +
                '<button class="btn btn-sm btn-primary mt-2" onclick="closeImportModal()">Fechar e Verificar Pedidos</button>';
            document.getElementById('cancel-import-btn').style.display = 'none';
            showWarning('Job de importa√ß√£o n√£o encontrado. Verifique se os pedidos foram importados.');
            return;
        }
        
        if (!response.ok) {
            throw new Error(`Erro HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.job) {
            const job = data.job;
            
            // Atualizar contadores
            document.getElementById('imported-count').textContent = job.imported || 0;
            document.getElementById('updated-count').textContent = job.updated || 0;
            document.getElementById('current-batch').textContent = 
                `${job.current_batch || 0}/${job.total_batches || 0}`;
            
            // Atualizar barra de progresso
            const percentage = job.total_orders > 0 
                ? Math.round((job.processed / job.total_orders) * 100) 
                : 0;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-percentage').textContent = percentage + '%';
            document.getElementById('progress-text').textContent = 
                `${job.processed || 0} / ${job.total_orders || 0} (${percentage}%)`;
            
            // Atualizar status
            const statusMessages = {
                'running': '<i class="bi bi-hourglass-split me-2"></i>Importa√ß√£o em andamento...',
                'completed': '<i class="bi bi-check-circle me-2 text-success"></i>Importa√ß√£o conclu√≠da!',
                'cancelled': '<i class="bi bi-x-circle me-2 text-warning"></i>Importa√ß√£o cancelada',
                'error': '<i class="bi bi-exclamation-triangle me-2 text-danger"></i>Erro na importa√ß√£o'
            };
            
            document.getElementById('import-status').innerHTML = 
                statusMessages[job.status] || 'Processando...';
            
            // Se completou, cancelou ou erro, parar monitoramento
            if (['completed', 'cancelled', 'error'].includes(job.status)) {
                clearInterval(statusInterval);
                
                if (job.status === 'completed') {
                    showImportComplete(job.imported, job.updated);
                } else if (job.status === 'cancelled') {
                    showImportCancelled(job.imported, job.updated);
                } else {
                    showImportError(job.error_message || 'Erro desconhecido');
                }
                
                // Recarregar pedidos
                loadOrders(1);
            }
        }
        
    } catch (error) {
        console.error('Erro ao verificar status do job:', error);
    }
}

function closeImportModal() {
    // Parar monitoramento se estiver ativo
    if (statusInterval) {
        clearInterval(statusInterval);
        statusInterval = null;
    }
    
    // Resetar estado
    currentJobId = null;
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
    if (modal) {
        modal.hide();
    }
    
    // Recarregar pedidos para ver se algum foi importado
    loadOrders(1);
}

async function cancelImport() {
    if (!currentJobId) {
        closeImportModal();
        return;
    }
    
    if (confirm('Deseja realmente cancelar a importa√ß√£o em background?')) {
        document.getElementById('cancel-import-btn').disabled = true;
        document.getElementById('import-status').innerHTML = 
            '<i class="bi bi-x-circle me-2 text-danger"></i>Cancelando importa√ß√£o...';
        
        try {
            const response = await fetch(`/ml/api/orders/import-cancel/${currentJobId}`, {
                method: 'POST',
                credentials: 'include'
            });
            
            if (response.status === 404) {
                // Job n√£o existe mais (container reiniciado)
                showWarning('Job n√£o encontrado. Fechando modal...');
                closeImportModal();
                return;
            }
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    showSuccess('Importa√ß√£o cancelada com sucesso');
                }
            }
        } catch (error) {
            console.error('Erro ao cancelar importa√ß√£o:', error);
        }
    }
}

function showImportError(errorMessage) {
    // Esconder progresso
    document.getElementById('import-progress').style.display = 'none';
    
    // Mostrar conclus√£o com erro
    document.getElementById('import-complete').style.display = 'block';
    document.getElementById('final-message').innerHTML = 
        `<i class="bi bi-exclamation-triangle me-2"></i>Erro na importa√ß√£o: ${errorMessage}`;
    
    // Mudar cor do alerta
    const alertDiv = document.querySelector('#import-complete .alert');
    alertDiv.classList.remove('alert-success');
    alertDiv.classList.add('alert-danger');
    
    // Habilitar bot√£o de fechar
    document.getElementById('closeImportModal').disabled = false;
    document.getElementById('close-modal-btn').disabled = false;
    document.getElementById('close-modal-btn').innerHTML = '<i class="bi bi-x-circle me-1"></i>Fechar';
}

function showImportComplete(imported, updated) {
    // Esconder progresso
    document.getElementById('import-progress').style.display = 'none';
    
    // Mostrar conclus√£o
    document.getElementById('import-complete').style.display = 'block';
    document.getElementById('final-imported').textContent = imported;
    document.getElementById('final-updated').textContent = updated;
    document.getElementById('final-message').textContent = 
        `${imported} pedidos foram importados e ${updated} foram atualizados com sucesso!`;
    
    // Habilitar bot√£o de fechar
    document.getElementById('closeImportModal').disabled = false;
    document.getElementById('close-modal-btn').disabled = false;
    
    // Esconder bot√£o de iniciar
    document.getElementById('start-import-btn').style.display = 'none';
}

function showImportCancelled(imported, updated) {
    // Esconder progresso
    document.getElementById('import-progress').style.display = 'none';
    
    // Mostrar conclus√£o com aviso de cancelamento
    document.getElementById('import-complete').style.display = 'block';
    document.getElementById('final-imported').textContent = imported;
    document.getElementById('final-updated').textContent = updated;
    document.getElementById('final-message').innerHTML = 
        `<i class="bi bi-exclamation-triangle me-2"></i>Importa√ß√£o cancelada pelo usu√°rio. ${imported} pedidos foram importados antes do cancelamento.`;
    
    // Mudar cor do alerta
    const alertDiv = document.querySelector('#import-complete .alert');
    alertDiv.classList.remove('alert-success');
    alertDiv.classList.add('alert-warning');
    
    // Habilitar bot√£o de fechar
    document.getElementById('closeImportModal').disabled = false;
    document.getElementById('close-modal-btn').disabled = false;
    
    // Esconder bot√£o de iniciar
    document.getElementById('start-import-btn').style.display = 'none';
}

function viewOrderDetails(orderId) {
    // Navegar para a p√°gina de detalhes do pedido
    window.location.href = `/ml/orders/${orderId}`;
}

function copyOrderId(orderId) {
    navigator.clipboard.writeText(orderId).then(() => {
        showSuccess('ID do pedido copiado!');
    });
}

function updateOrdersCount(total) {
    const ordersCountElement = document.getElementById('orders-count');
    if (ordersCountElement) {
        ordersCountElement.innerHTML = `<i class="bi bi-info-circle"></i> ${total} pedido(s) encontrado(s)`;
    }
    
    const totalOrdersElement = document.getElementById('total-orders');
    if (totalOrdersElement) {
        totalOrdersElement.textContent = `${total} pedidos`;
    }
}

function showLoading(show) {
    document.getElementById('loading-container').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const alertContainer = document.getElementById('alerts-container');
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function showSuccess(message) {
    const alertContainer = document.getElementById('alerts-container');
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function showAlert(type, message) {
    const classes = {
        success: { alert: 'alert-success', icon: 'bi-check-circle-fill' },
        danger: { alert: 'alert-danger', icon: 'bi-exclamation-triangle-fill' },
        warning: { alert: 'alert-warning', icon: 'bi-exclamation-triangle-fill' },
        info: { alert: 'alert-info', icon: 'bi-info-circle-fill' }
    };

    const current = classes[type] || classes.info;
    const alertContainer = document.getElementById('alerts-container');
    if (!alertContainer) return;

    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert ${current.alert} alert-dismissible fade show" role="alert">
                <i class="bi ${current.icon}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'pending': 'bg-warning',
        'confirmed': 'bg-info',
        'paid': 'bg-primary',
        'shipped': 'bg-secondary',
        'delivered': 'bg-success',
        'cancelled': 'bg-danger',
        'refunded': 'bg-dark'
    };
    return statusClasses[status] || 'bg-secondary';
}

function getStatusLabel(status) {
    const statusLabels = {
        'pending': 'Pendente',
        'confirmed': 'Confirmado',
        'paid': 'Pago',
        'shipped': 'Enviado',
        'delivered': 'Entregue',
        'cancelled': 'Cancelado',
        'refunded': 'Reembolsado'
    };
    return statusLabels[status] || status;
}

function translateShippingStatus(status) {
    const shippingLabels = {
        'pending': 'Pendente',
        'ready_to_ship': 'Pronto para envio',
        'ready_to_print': 'Pronto para imprimir',
        'printed': 'Etiqueta impressa',
        'packed': 'Pacote pronto',
        'shipped': 'Enviado',
        'in_transit': 'Em tr√¢nsito',
        'delivered': 'Entregue',
        'not_delivered': 'N√£o entregue',
        'cancelled': 'Cancelado'
    };
    return shippingLabels[status] || status;
}

function translateShippingSubstatus(substatus) {
    const mapping = {
        'receiver_absent': 'Comprador ausente',
        'receiver_absent_twice': 'Comprador ausente (2x)',
        'damaged_package': 'Pacote danificado',
        'processing': 'Em processamento',
        'waiting_for_withdrawal': 'Aguardando retirada',
        'waiting_for_carrier_authorization': 'Aguardando transportadora',
        'contact_customer': 'Contatar comprador',
        'need_review': 'Necess√°rio revisar',
        'returned_to_sender': 'Devolvido ao remetente',
        'stolen': 'Roubado'
    };
    if (mapping[substatus]) {
        return mapping[substatus];
    }
    return substatus ? substatus.replace(/_/g, ' ') : '';
}

const shippingStatusLabels = {
    'pending': 'Pendente',
    'ready_to_print': 'Pronto para imprimir',
    'ready_to_pack': 'Pronto para embalar',
    'ready_to_ship': 'Pronto para envio',
    'printed': 'Etiqueta impressa',
    'packed': 'Pacote pronto',
    'shipped': 'Enviado',
    'in_transit': 'Em tr√¢nsito',
    'out_for_delivery': 'Saiu para entrega',
    'soon_deliver': 'Pr√≥ximo da entrega',
    'delivered': 'Entregue',
    'not_delivered': 'N√£o entregue',
    'cancelled': 'Cancelado',
    'error': 'Erro',
    'waiting_for_carrier_authorization': 'Aguardando transportadora',
    'ready_for_pickup': 'Pronto para retirada',
    'ready_for_dropoff': 'Pronto para postagem',
    'to_be_agreed': 'A combinar'
};

const shippingStatusIcons = {
    'pending': '‚è≥',
    'ready_to_print': 'üì¶',
    'ready_to_pack': 'üì¶',
    'ready_to_ship': 'üì¶',
    'printed': 'üì¶',
    'packed': 'üì¶',
    'shipped': 'üöö',
    'in_transit': 'üöö',
    'out_for_delivery': 'üöö',
    'soon_deliver': 'üöö',
    'delivered': '‚úì',
    'not_delivered': '‚ö†Ô∏è',
    'cancelled': '‚õî',
    'error': '‚ö†Ô∏è',
    'waiting_for_carrier_authorization': 'üöö',
    'ready_for_pickup': 'üì¶',
    'ready_for_dropoff': 'üì¶',
    'to_be_agreed': 'üõà'
};

function getLogisticLabel(logisticType) {
    const normalized = (logisticType || '').toString().toLowerCase();
    switch (normalized) {
        case 'full':
        case 'fulfillment':
            return 'Full';
        case 'cross_docking':
            return 'Cross Docking';
        case 'me2':
            return 'Mercado Envios';
        case 'ponto de coleta':
        case 'xd_drop_off':
        case 'drop_off':
            return 'Ponto de Coleta';
        case 'self_service':
            return 'Envio pr√≥prio';
        default:
            return logisticType || '';
    }
}

function getLogisticBadgeClass(logisticType) {
    const normalized = (logisticType || '').toString().toLowerCase();
    switch (normalized) {
        case 'full':
        case 'fulfillment':
            return 'bg-primary';
        case 'cross_docking':
            return 'bg-info';
        case 'ponto de coleta':
        case 'xd_drop_off':
        case 'drop_off':
            return 'bg-secondary';
        case 'me2':
            return 'bg-warning';
        default:
            return 'bg-secondary';
    }
}

function formatDateOnly(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR');
    } catch (err) {
        return dateString;
    }
}

function getShippingStatusDisplay(status) {
    const normalized = (status || '').toString().toLowerCase();
    const label = shippingStatusLabels[normalized] || (normalized ? normalized.replace(/_/g, ' ') : null);
    if (!label) {
        return null;
    }
    const icon = shippingStatusIcons[normalized] || 'üöö';
    return { icon, label };
}

function formatCurrency(amount, currency = 'BRL') {
    if (!amount) return 'R$ 0,00';
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: currency || 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount); // Valor j√° est√° em reais
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    } catch (e) {
        return dateString;
    }
}

function sortTable(column) {
    // Implementar ordena√ß√£o se necess√°rio
    console.log('Ordenar por:', column);
}


// Fun√ß√µes para remo√ß√£o de pedidos
function showDeleteOrdersModal() {
    // Atualizar contador de pedidos selecionados
    updateSelectedOrdersCount();
    
    // Limpar campo de confirma√ß√£o
    document.getElementById('confirmationTextOrders').value = '';
    document.getElementById('deleteOrdersButton').disabled = true;
    
    // Configurar op√ß√µes de remo√ß√£o
    setupDeleteOptions();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('deleteOrdersModal'));
    modal.show();
}

function setupDeleteOptions() {
    const deleteSelected = document.getElementById('deleteSelected');
    const deleteAll = document.getElementById('deleteAll');
    const deleteSelectedButton = document.getElementById('deleteOrdersButton');
    const deleteAllButton = document.getElementById('deleteAllOrdersButton');
    
    // Fun√ß√£o para alternar entre os bot√µes
    function toggleButtons() {
        if (deleteSelected.checked) {
            deleteSelectedButton.style.display = 'inline-block';
            deleteAllButton.style.display = 'none';
            updateSelectedOrdersCount();
        } else if (deleteAll.checked) {
            deleteSelectedButton.style.display = 'none';
            deleteAllButton.style.display = 'inline-block';
            deleteAllButton.disabled = false;
        }
    }
    
    // Adicionar event listeners
    deleteSelected.addEventListener('change', toggleButtons);
    deleteAll.addEventListener('change', toggleButtons);
    
    // Configura√ß√£o inicial
    toggleButtons();
}

function toggleSelectAllOrders() {
    const selectAllCheckbox = document.getElementById('select-all-orders');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    
    orderCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedOrdersCount();
}

function updateSelectedOrdersCount() {
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    
    document.getElementById('selectedOrdersCount').textContent = selectedCount;
    
    // Habilitar/desabilitar bot√£o de remo√ß√£o
    const deleteButton = document.getElementById('deleteOrdersButton');
    if (deleteButton) {
        deleteButton.disabled = selectedCount === 0;
    }
}

function confirmDeleteOrders() {
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedOrderIds.length === 0) {
        showAlert('warning', 'Selecione pelo menos um pedido para remover');
        return;
    }
    
    const confirmationText = document.getElementById('confirmationTextOrders').value;
    if (confirmationText !== 'CONFIRMAR') {
        showAlert('danger', 'Digite "CONFIRMAR" para prosseguir com a remo√ß√£o');
        return;
    }
    
    // Desabilitar bot√£o durante a opera√ß√£o
    const deleteButton = document.getElementById('deleteOrdersButton');
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';
    
    fetch('/ml/api/orders/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
            order_ids: selectedOrderIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('deleteOrdersModal')).hide();
            
            // Recarregar pedidos
            setTimeout(() => {
                loadOrders(currentPage);
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Erro ao remover pedidos');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao remover pedidos: ' + error.message);
    })
    .finally(() => {
        // Reabilitar bot√£o
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="bi bi-trash"></i> Confirmar Remo√ß√£o';
    });
}

function confirmDeleteAllOrders() {
    const confirmationText = document.getElementById('confirmationTextOrders').value;
    if (confirmationText !== 'CONFIRMAR') {
        showAlert('danger', 'Digite "CONFIRMAR" para prosseguir com a remo√ß√£o');
        return;
    }
    
    // Desabilitar bot√£o durante a opera√ß√£o
    const deleteButton = document.getElementById('deleteAllOrdersButton');
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';
    
    fetch('/ml/api/orders/delete-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('deleteOrdersModal')).hide();
            
            // Recarregar pedidos
            setTimeout(() => {
                loadOrders(currentPage);
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Erro ao remover todos os pedidos');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao remover todos os pedidos: ' + error.message);
    })
    .finally(() => {
        // Reabilitar bot√£o
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="bi bi-trash"></i> Remover Todos';
    });
}

function renderInvoiceDropdown(orderId) {
    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Op√ß√µes de nota fiscal">
                <i class="bi bi-file-earmark-text"></i>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <button class="dropdown-item" type="button" onclick="syncInvoiceForOrder('${orderId}', this)">
                        <i class="bi bi-arrow-repeat"></i> Sincronizar nota
                    </button>
                </li>
                <li>
                    <a class="dropdown-item" href="/api/shipments/download-invoice/${orderId}" target="_blank">
                        <i class="bi bi-file-earmark-pdf"></i> Baixar PDF
                    </a>
                </li>
            </ul>
        </div>
    `;
}

function renderLabelDropdown(orderId, hasShippingId, logisticType) {
    if (!hasShippingId) {
        return `
            <button class="btn btn-outline-warning" type="button" title="Etiqueta dispon√≠vel ap√≥s gera√ß√£o do envio" disabled>
                <i class="bi bi-printer"></i>
            </button>
        `;
    }

    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir etiqueta de envio">
                <i class="bi bi-printer"></i>
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank">
                        <i class="bi bi-file-earmark-pdf"></i> PDF
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank">
                        <i class="bi bi-printer-fill"></i> ZPL2 (t√©rmica)
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank">
                        <i class="bi bi-file-earmark-pdf-fill"></i> ZPL2 ‚Üí PDF
                    </a>
                </li>
            </ul>
        </div>
    `;
}

async function syncInvoiceForOrder(orderId, triggerElement) {
    if (!orderId) return;

    const button = triggerElement;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sincronizando...';

    try {
        const response = await fetch(`/api/shipments/sync-single-invoice/${orderId}`, {
            method: 'POST',
            credentials: 'include',
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const data = await response.json();

        if (!response.ok || !data.success) {
            throw new Error(data.error || 'Erro ao sincronizar nota fiscal.');
        }

        showSuccess(`Nota fiscal do pedido ${orderId} sincronizada com sucesso.`);
        loadOrders(currentPage);
    } catch (error) {
        console.error('Erro ao sincronizar nota:', error);
        showAlert('danger', error.message || 'Falha ao sincronizar nota fiscal.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

function openOrderJson(cacheKey) {
    const order = ordersCache[cacheKey];
    if (!order) {
        showAlert('warning', 'N√£o foi poss√≠vel localizar os dados deste pedido.');
        return;
    }

    const modalBody = document.getElementById('orderJsonContent');
    if (!modalBody) return;

    modalBody.textContent = JSON.stringify(order, null, 2);
    const modal = new bootstrap.Modal(document.getElementById('orderJsonModal'));
    modal.show();
}

</script>

<div class="modal fade" id="orderJsonModal" tabindex="-1" aria-labelledby="orderJsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderJsonModalLabel"><i class="bi bi-code-slash"></i> JSON do Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre class="bg-light p-3 rounded" style="max-height: 60vh; white-space: pre-wrap; word-break: break-word;" id="orderJsonContent"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="copyJsonToClipboard()">
                    <i class="bi bi-clipboard"></i> Copiar JSON
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function copyJsonToClipboard() {
    const content = document.getElementById('orderJsonContent')?.textContent || '';
    navigator.clipboard.writeText(content).then(() => {
        showAlert('success', 'JSON copiado com sucesso!');
    }).catch(() => {
        showAlert('danger', 'N√£o foi poss√≠vel copiar o JSON.');
    });
}

</script>

<!-- Modal de Remo√ß√£o de Pedidos -->
<div class="modal fade" id="deleteOrdersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Remover Pedidos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!
                </div>
                
                <div class="mb-3">
                    <h6>Op√ß√µes de Remo√ß√£o:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteSelected" value="selected" checked>
                        <label class="form-check-label" for="deleteSelected">
                            Remover pedidos selecionados (<span id="selectedOrdersCount">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteAll" value="all">
                        <label class="form-check-label" for="deleteAll">
                            Remover TODOS os pedidos
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="confirmationTextOrders" class="form-label">
                        Para confirmar, digite <strong>CONFIRMAR</strong>:
                    </label>
                    <input type="text" id="confirmationTextOrders" class="form-control" placeholder="Digite CONFIRMAR aqui">
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Importante:</strong> Os pedidos ser√£o removidos apenas do banco de dados local. 
                    Os pedidos originais no Mercado Libre n√£o ser√£o afetados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="deleteOrdersButton" onclick="confirmDeleteOrders()" disabled>
                    <i class="bi bi-trash"></i> Remover Selecionados
                </button>
                <button type="button" class="btn btn-danger" id="deleteAllOrdersButton" onclick="confirmDeleteAllOrders()" style="display: none;">
                    <i class="bi bi-trash"></i> Remover Todos
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
