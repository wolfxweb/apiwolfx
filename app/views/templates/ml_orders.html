{% extends "base.html" %}

{% block title %}Pedidos Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Pedidos Mercado Livre</h1>
                    <p class="text-muted mb-0">
                        Gerencie seus pedidos do Mercado Livre
                        <span id="orders-count" class="ms-2">
                            <i class="bi bi-info-circle"></i> Carregando...
                        </span>
                    </p>
                </div>
                <div>
                    <button id="sync-btn" class="btn btn-primary me-2" onclick="syncOrders()">
                        <i class="bi bi-arrow-clockwise"></i> Sincronizar
                    </button>
                    <button id="import-btn" class="btn btn-success me-2" onclick="importOrders()">
                        <i class="bi bi-download"></i> Importar Pedidos
                    </button>
                    <button class="btn btn-danger" onclick="showDeleteOrdersModal()">
                        <i class="bi bi-trash"></i> Remover Pedidos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div class="row mb-4" id="alerts-container">
        <!-- Alerts serão inseridos aqui dinamicamente -->
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <label for="account_filter" class="form-label">Conta</label>
                            <select name="account_filter" id="account_filter" class="form-select">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="status_filter" class="form-label">Status</label>
                            <select name="status_filter" id="status_filter" class="form-select">
                                <option value="">Todos os status</option>
                                <option value="pending">Pendente</option>
                                <option value="confirmed">Confirmado</option>
                                <option value="paid">Pago</option>
                                <option value="shipped">Enviado</option>
                                <option value="delivered">Entregue</option>
                                <option value="cancelled">Cancelado</option>
                                <option value="refunded">Reembolsado</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="date_from" class="form-label">Data Inicial</label>
                            <input type="date" name="date_from" id="date_from" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="date_to" class="form-label">Data Final</label>
                            <input type="date" name="date_to" id="date_to" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <label for="limit" class="form-label">Por página</label>
                            <select name="limit" id="limit" class="form-select">
                                <option value="20">20</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-primary" onclick="applyFilters()">
                                <i class="bi bi-search"></i> Aplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="row mb-4" id="loading-container" style="display: none;">
        <div class="col-12">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando pedidos...</p>
            </div>
        </div>
    </div>

    <!-- Lista de Orders -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Lista de Pedidos</h5>
                    <span class="badge bg-primary" id="total-orders">
                        0 pedidos
                    </span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 table-sm">
                            <thead class="table-primary text-white">
                                <tr>
                                    <th width="50">
                                        <input type="checkbox" id="select-all-orders" onchange="toggleSelectAllOrders()">
                                    </th>
                                    <th class="sortable" data-sort="buyer_nickname" onclick="sortTable('buyer_nickname')">
                                        Comprador <i class="bi bi-arrow-down-up ms-1"></i>
                                    </th>
                                    <th class="sortable" data-sort="date_created" onclick="sortTable('date_created')">
                                        Dados de Billing <i class="bi bi-arrow-down-up ms-1"></i>
                                    </th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="bi bi-info-circle"></i> Carregando pedidos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginação -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    <span id="pagination-info">Mostrando 0 de 0 pedidos</span>
                </div>
                <nav aria-label="Navegação de pedidos">
                    <ul class="pagination mb-0" id="pagination">
                        <!-- Paginação será inserida aqui dinamicamente -->
                    </ul>
                </nav>
                <div class="d-flex align-items-center">
                    <label for="page-size" class="form-label me-2 mb-0 small">Por página:</label>
                    <select id="page-size" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize()">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Importação -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="bi bi-download text-success me-2"></i>Importar Pedidos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="bi bi-cloud-download text-primary" style="font-size: 3rem;"></i>
                </div>
                <h6 class="text-center mb-3">Deseja importar pedidos da conta?</h6>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Importação limitada:</strong> Para evitar sobrecarga, serão importados até 50 pedidos por vez.
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Atenção:</strong> Esta operação pode demorar alguns minutos. O sistema fará pausas automáticas.
                </div>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success me-2"></i>Serão importados todos os pedidos históricos</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Pedidos já existentes serão atualizados</li>
                    <li><i class="bi bi-check-circle text-success me-2"></i>Novos pedidos serão adicionados ao banco</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="confirmImport()">
                    <i class="bi bi-download me-1"></i>Confirmar Importação
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para botões em loading */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.btn .spinner-border {
    color: currentColor;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

/* Estilos para o modal de importação */
#importModal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

#importModal .modal-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 12px 12px 0 0;
    border: none;
}

#importModal .modal-header .btn-close {
    filter: invert(1);
}

#importModal .modal-body {
    padding: 2rem;
}

#importModal .alert-info {
    border-left: 4px solid #17a2b8;
    background-color: #f8f9fa;
}

#importModal .list-unstyled li {
    padding: 0.5rem 0;
    font-size: 0.9rem;
}

#importModal .modal-footer {
    border: none;
    padding: 1rem 2rem 2rem 2rem;
}
</style>

<script>
let currentPage = 1;
let currentLimit = 50;
let currentFilters = {};

// Função para verificar se a resposta indica sessão expirada
function checkSessionExpired(response) {
    if (response.status === 401) {
        showError('Sessão expirada. Redirecionando para login...');
        
        // Ocultar elementos de usuário logado
        hideUserElements();
        
        setTimeout(() => {
            window.location.href = '/auth/login';
        }, 2000);
        return true;
    }
    return false;
}

// Função para ocultar elementos de usuário logado
function hideUserElements() {
    // Ocultar botões de ação
    const syncBtn = document.getElementById('sync-btn');
    const importBtn = document.getElementById('import-btn');
    const deleteBtn = document.querySelector('button[onclick="showDeleteOrdersModal()"]');
    
    if (syncBtn) syncBtn.style.display = 'none';
    if (importBtn) importBtn.style.display = 'none';
    if (deleteBtn) deleteBtn.style.display = 'none';
    
    // Ocultar filtros
    const filtersSection = document.querySelector('.row:has(.card .card-header h5)');
    if (filtersSection) {
        const filtersCard = filtersSection.querySelector('.card');
        if (filtersCard && filtersCard.textContent.includes('Filtros')) {
            filtersSection.style.display = 'none';
        }
    }
    
    // Ocultar tabela
    const tableSection = document.querySelector('.row:has(.card .card-header h5)');
    if (tableSection) {
        const tableCard = tableSection.querySelector('.card');
        if (tableCard && tableCard.textContent.includes('Lista de Pedidos')) {
            tableSection.style.display = 'none';
        }
    }
    
    // Mostrar mensagem de sessão expirada
    const alertContainer = document.getElementById('alerts-container');
    if (alertContainer) {
        alertContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning text-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Sessão expirada!</strong> Faça login novamente para continuar.
                </div>
            </div>
        `;
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    loadOrders();
});


function loadOrders(page = 1) {
    showLoading(true);
    
    const urlParams = new URLSearchParams(window.location.search);
    
    // Coletar filtros
    const pageSizeSelect = document.getElementById('page-size');
    const selectedLimit = pageSizeSelect ? parseInt(pageSizeSelect.value) : currentLimit;
    
    const filters = {
        ml_account_id: urlParams.get('account_filter') || '',
        status_filter: urlParams.get('status_filter') || '',
        date_from: urlParams.get('date_from') || '',
        date_to: urlParams.get('date_to') || '',
        limit: selectedLimit,
        offset: (page - 1) * selectedLimit
    };
    
    // Construir URL da API (com prefixo /ml)
    let apiUrl = `/ml/api/orders?page=${page}&limit=${filters.limit}&offset=${filters.offset}`;
    
    if (filters.ml_account_id) apiUrl += `&ml_account_id=${encodeURIComponent(filters.ml_account_id)}`;
    if (filters.status_filter) apiUrl += `&status_filter=${encodeURIComponent(filters.status_filter)}`;
    if (filters.date_from) apiUrl += `&date_from=${encodeURIComponent(filters.date_from)}`;
    if (filters.date_to) apiUrl += `&date_to=${encodeURIComponent(filters.date_to)}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => {
        if (checkSessionExpired(response)) {
            return;
        }
        return response.json();
    })
    .then(data => {
        console.log('Resposta da API:', data);
        if (data && data.success) {
            renderOrders(data.orders);
            updateOrdersCount(data.total);
            renderPagination(data.total, filters.limit, page);
            loadAccountsFilter(data.accounts || []);
        } else {
            console.error('Erro na API:', data);
            showError('Erro ao carregar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        showError('Erro ao carregar pedidos: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function renderOrders(orders) {
    const tbody = document.getElementById('orders-table-body');
    
    if (!orders || orders.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-info-circle"></i> Nenhum pedido encontrado
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = orders.map(order => `
        <tr class="small">
            <td class="align-middle">
                <input type="checkbox" class="order-checkbox" value="${order.id}" onchange="updateSelectedOrdersCount()">
            </td>
            <td class="align-middle">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle text-success me-2 fs-4"></i>
                    <div>
                        <strong class="d-block">${order.buyer_nickname || 'N/A'}</strong>
                        ${order.buyer_email ? `<small class="text-muted d-block">${order.buyer_email}</small>` : ''}
                        <small class="text-muted d-block">
                            <i class="bi bi-hash"></i> ${order.ml_order_id || order.order_id}
                        </small>
                        <small class="text-muted d-block">
                            <i class="bi bi-calendar3"></i> ${formatDate(order.date_created)}
                        </small>
                        <small class="d-block">
                            ${order.is_advertising_sale ? 
                                '<span class="badge bg-warning text-dark"><i class="bi bi-megaphone"></i> Anúncio Pago</span>' : 
                                '<span class="badge bg-success"><i class="bi bi-search"></i> Busca Orgânica</span>'}
                        </small>
                    </div>
                </div>
            </td>
            <td class="align-middle">
                ${renderBillingData(order)}
            </td>
            <td class="align-middle text-nowrap">
                <button class="btn btn-outline-primary btn-sm me-1" onclick="viewOrderDetails('${order.ml_order_id}')" title="Ver detalhes">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="copyOrderId('${order.ml_order_id}')" title="Copiar ID">
                    <i class="bi bi-clipboard"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderBillingData(order) {
    if (!order) return '<span class="text-muted">N/A</span>';
    
    const totalAmount = order.total_amount || 0;
    const saleFees = order.sale_fees || 0;
    const shippingCost = order.shipping_cost || 0;
    const couponAmount = order.coupon_amount || 0;
    const advertisingCost = order.advertising_cost || 0;
    const currency = order.currency_id || 'BRL';
    
    // Calcular líquido para o vendedor
    const netAmount = totalAmount - saleFees;
    
    // Calcular percentual de comissão
    const feePercentage = totalAmount > 0 ? ((saleFees / totalAmount) * 100).toFixed(1) : 0;
    
    // Formato compacto com ícones e quebras de linha
    let items = [];
    
    // Valor total (sempre aparece)
    items.push(`💰 Valor Total: <strong class="text-primary">${formatCurrency(totalAmount, currency)}</strong>`);
    
    // Comissão ML (sempre aparece)
    items.push(`💸 Comissão ML: <strong class="text-warning">${formatCurrency(saleFees, currency)}</strong> <small class="text-muted">(${feePercentage}%)</small>`);
    
    // Frete (aparece se > 0)
    if (shippingCost > 0) {
        items.push(`🚚 Frete: <strong class="text-info">${formatCurrency(shippingCost, currency)}</strong>`);
    }
    
    // Desconto (aparece se > 0)
    if (couponAmount > 0) {
        items.push(`🎫 Desconto: <strong class="text-danger">-${formatCurrency(couponAmount, currency)}</strong>`);
    }
    
    // Publicidade (aparece se > 0)
    if (advertisingCost > 0) {
        items.push(`📢 Publicidade: <strong class="text-danger">${formatCurrency(advertisingCost, currency)}</strong>`);
    }
    
    // Líquido vendedor (sempre aparece, destacado)
    items.push(`<hr class="my-2">💵 Líquido Vendedor: <strong class="text-success fs-6">${formatCurrency(netAmount, currency)}</strong>`);
    
    // Juntar com quebras de linha
    return '<div class="small" style="line-height: 1.8;">' + items.join('<br>') + '</div>';
}

function renderPagination(total, limit, currentPage) {
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');
    const totalPages = Math.ceil(total / limit);
    
    // Atualizar informações da paginação
    const startItem = (currentPage - 1) * limit + 1;
    const endItem = Math.min(currentPage * limit, total);
    paginationInfo.textContent = `Mostrando ${startItem} a ${endItem} de ${total} pedidos`;
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Botão primeira página
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(1)" title="Primeira página">
                    <i class="bi bi-chevron-double-left"></i>
                </a>
            </li>
        `;
    }
    
    // Botão anterior
    if (currentPage > 1) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(${currentPage - 1})" title="Página anterior">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
        `;
    }
    
    // Páginas
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    // Adicionar reticências no início se necessário
    if (startPage > 1) {
        paginationHTML += `
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
        `;
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadOrders(${i})">${i}</a>
            </li>
        `;
    }
    
    // Adicionar reticências no final se necessário
    if (endPage < totalPages) {
        paginationHTML += `
            <li class="page-item disabled">
                <span class="page-link">...</span>
            </li>
        `;
    }
    
    // Botão próximo
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(${currentPage + 1})" title="Próxima página">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;
    }
    
    // Botão última página
    if (currentPage < totalPages) {
        paginationHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="loadOrders(${totalPages})" title="Última página">
                    <i class="bi bi-chevron-double-right"></i>
                </a>
            </li>
        `;
    }
    
    pagination.innerHTML = paginationHTML;
}

function loadAccountsFilter(accounts) {
    const select = document.getElementById('account_filter');
    const currentValue = new URLSearchParams(window.location.search).get('account_filter') || '';
    
    select.innerHTML = '<option value="">Todas as contas</option>';
    
    accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.nickname} (${account.country_id})`;
        option.selected = currentValue == account.id;
        select.appendChild(option);
    });
}

function applyFilters() {
    const pageSizeSelect = document.getElementById('page-size');
    const selectedLimit = pageSizeSelect ? parseInt(pageSizeSelect.value) : 50;
    
    const filters = {
        account_filter: document.getElementById('account_filter').value,
        status_filter: document.getElementById('status_filter').value,
        date_from: document.getElementById('date_from').value,
        date_to: document.getElementById('date_to').value,
        limit: selectedLimit
    };
    
    // Atualizar URL
    const url = new URL(window.location);
    Object.keys(filters).forEach(key => {
        if (filters[key]) {
            url.searchParams.set(key, filters[key]);
        } else {
            url.searchParams.delete(key);
        }
    });
    
    window.history.pushState({}, '', url);
    loadOrders(1);
}

function syncOrders() {
    const syncBtn = document.getElementById('sync-btn');
    const importBtn = document.getElementById('import-btn');
    
    // Desabilitar botões e mostrar loading
    syncBtn.disabled = true;
    importBtn.disabled = true;
    syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Sincronizando...';
    
    showLoading(true);
    
    fetch('/ml/api/orders/sync', {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => {
        if (checkSessionExpired(response)) {
            return;
        }
        return response.json();
    })
    .then(data => {
        console.log('Resposta da sincronização:', data);
        if (data && data.success) {
            showSuccess(`Sincronização concluída: ${data.total_saved || 0} pedidos criados, ${data.total_updated || 0} pedidos atualizados`);
            loadOrders(currentPage);
        } else {
            showError('Erro ao sincronizar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('Erro ao sincronizar pedidos');
    })
    .finally(() => {
        // Reabilitar botões e restaurar texto
        syncBtn.disabled = false;
        importBtn.disabled = false;
        syncBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sincronizar';
        showLoading(false);
    });
}

function refreshOrders() {
    loadOrders(currentPage);
}

function importOrders() {
    // Mostrar modal de confirmação
    const modal = new bootstrap.Modal(document.getElementById('importModal'));
    modal.show();
}

function confirmImport() {
    // Fechar o modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('importModal'));
    modal.hide();
    
    const syncBtn = document.getElementById('sync-btn');
    const importBtn = document.getElementById('import-btn');
    
    // Desabilitar botões e mostrar loading
    syncBtn.disabled = true;
    importBtn.disabled = true;
    importBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Importando...';
    
    showLoading(true);
    
    fetch('/ml/api/orders/import', {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => {
        console.log('Status da resposta:', response.status);
        if (checkSessionExpired(response)) {
            return;
        }
        
        // Verificar se a resposta é JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            // Se não for JSON, tentar ler como texto para debug
            return response.text().then(text => {
                console.error('Status da resposta:', response.status);
                console.error('Content-Type:', contentType);
                console.error('Resposta completa:', text);
                throw new Error('Resposta não é JSON válido. Status: ' + response.status);
            });
        }
    })
    .then(data => {
        console.log('Resposta da importação:', data);
        if (data && data.success) {
            showSuccess(`Importação concluída: ${data.total_saved || 0} pedidos criados, ${data.total_updated || 0} pedidos atualizados. Importação limitada a 50 pedidos para evitar sobrecarga.`);
            loadOrders(currentPage);
        } else {
            showError('Erro ao importar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showError('Erro ao importar pedidos: ' + error.message);
    })
    .finally(() => {
        // Reabilitar botões e restaurar texto
        syncBtn.disabled = false;
        importBtn.disabled = false;
        importBtn.innerHTML = '<i class="bi bi-download"></i> Importar Pedidos';
        showLoading(false);
    });
}

function viewOrderDetails(orderId) {
    // Navegar para a página de detalhes do pedido
    window.location.href = `/ml/orders/${orderId}`;
}

function copyOrderId(orderId) {
    navigator.clipboard.writeText(orderId).then(() => {
        showSuccess('ID do pedido copiado!');
    });
}

function updateOrdersCount(total) {
    document.getElementById('orders-count').innerHTML = `<i class="bi bi-info-circle"></i> ${total} pedido(s) encontrado(s)`;
    document.getElementById('total-orders').textContent = `${total} pedidos`;
}

function showLoading(show) {
    document.getElementById('loading-container').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const alertContainer = document.getElementById('alerts-container');
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function showSuccess(message) {
    const alertContainer = document.getElementById('alerts-container');
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function getStatusBadgeClass(status) {
    const statusClasses = {
        'pending': 'bg-warning',
        'confirmed': 'bg-info',
        'paid': 'bg-primary',
        'shipped': 'bg-secondary',
        'delivered': 'bg-success',
        'cancelled': 'bg-danger',
        'refunded': 'bg-dark'
    };
    return statusClasses[status] || 'bg-secondary';
}

function getStatusLabel(status) {
    const statusLabels = {
        'pending': 'Pendente',
        'confirmed': 'Confirmado',
        'paid': 'Pago',
        'shipped': 'Enviado',
        'delivered': 'Entregue',
        'cancelled': 'Cancelado',
        'refunded': 'Reembolsado'
    };
    return statusLabels[status] || status;
}

function formatCurrency(amount, currency = 'BRL') {
    if (!amount) return 'R$ 0,00';
    
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: currency || 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount); // Valor já está em reais
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    } catch (e) {
        return dateString;
    }
}

function sortTable(column) {
    // Implementar ordenação se necessário
    console.log('Ordenar por:', column);
}

function changePageSize() {
    const pageSize = document.getElementById('page-size').value;
    currentLimit = parseInt(pageSize);
    loadOrders(1); // Recarregar na primeira página
}

// Funções para remoção de pedidos
function showDeleteOrdersModal() {
    // Atualizar contador de pedidos selecionados
    updateSelectedOrdersCount();
    
    // Limpar campo de confirmação
    document.getElementById('confirmationTextOrders').value = '';
    document.getElementById('deleteOrdersButton').disabled = true;
    
    // Configurar opções de remoção
    setupDeleteOptions();
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('deleteOrdersModal'));
    modal.show();
}

function setupDeleteOptions() {
    const deleteSelected = document.getElementById('deleteSelected');
    const deleteAll = document.getElementById('deleteAll');
    const deleteSelectedButton = document.getElementById('deleteOrdersButton');
    const deleteAllButton = document.getElementById('deleteAllOrdersButton');
    
    // Função para alternar entre os botões
    function toggleButtons() {
        if (deleteSelected.checked) {
            deleteSelectedButton.style.display = 'inline-block';
            deleteAllButton.style.display = 'none';
            updateSelectedOrdersCount();
        } else if (deleteAll.checked) {
            deleteSelectedButton.style.display = 'none';
            deleteAllButton.style.display = 'inline-block';
            deleteAllButton.disabled = false;
        }
    }
    
    // Adicionar event listeners
    deleteSelected.addEventListener('change', toggleButtons);
    deleteAll.addEventListener('change', toggleButtons);
    
    // Configuração inicial
    toggleButtons();
}

function toggleSelectAllOrders() {
    const selectAllCheckbox = document.getElementById('select-all-orders');
    const orderCheckboxes = document.querySelectorAll('.order-checkbox');
    
    orderCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateSelectedOrdersCount();
}

function updateSelectedOrdersCount() {
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    
    document.getElementById('selectedOrdersCount').textContent = selectedCount;
    
    // Habilitar/desabilitar botão de remoção
    const deleteButton = document.getElementById('deleteOrdersButton');
    if (deleteButton) {
        deleteButton.disabled = selectedCount === 0;
    }
}

function confirmDeleteOrders() {
    const selectedCheckboxes = document.querySelectorAll('.order-checkbox:checked');
    const selectedOrderIds = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    if (selectedOrderIds.length === 0) {
        showAlert('warning', 'Selecione pelo menos um pedido para remover');
        return;
    }
    
    const confirmationText = document.getElementById('confirmationTextOrders').value;
    if (confirmationText !== 'CONFIRMAR') {
        showAlert('danger', 'Digite "CONFIRMAR" para prosseguir com a remoção');
        return;
    }
    
    // Desabilitar botão durante a operação
    const deleteButton = document.getElementById('deleteOrdersButton');
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';
    
    fetch('/ml/api/orders/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
            order_ids: selectedOrderIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('deleteOrdersModal')).hide();
            
            // Recarregar pedidos
            setTimeout(() => {
                loadOrders(currentPage);
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Erro ao remover pedidos');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao remover pedidos: ' + error.message);
    })
    .finally(() => {
        // Reabilitar botão
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="bi bi-trash"></i> Confirmar Remoção';
    });
}

function confirmDeleteAllOrders() {
    const confirmationText = document.getElementById('confirmationTextOrders').value;
    if (confirmationText !== 'CONFIRMAR') {
        showAlert('danger', 'Digite "CONFIRMAR" para prosseguir com a remoção');
        return;
    }
    
    // Desabilitar botão durante a operação
    const deleteButton = document.getElementById('deleteAllOrdersButton');
    deleteButton.disabled = true;
    deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Removendo...';
    
    fetch('/ml/api/orders/delete-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('deleteOrdersModal')).hide();
            
            // Recarregar pedidos
            setTimeout(() => {
                loadOrders(currentPage);
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Erro ao remover todos os pedidos');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao remover todos os pedidos: ' + error.message);
    })
    .finally(() => {
        // Reabilitar botão
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="bi bi-trash"></i> Remover Todos';
    });
}
</script>

<!-- Modal de Remoção de Pedidos -->
<div class="modal fade" id="deleteOrdersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Remover Pedidos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Atenção:</strong> Esta ação não pode ser desfeita!
                </div>
                
                <div class="mb-3">
                    <h6>Opções de Remoção:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteSelected" value="selected" checked>
                        <label class="form-check-label" for="deleteSelected">
                            Remover pedidos selecionados (<span id="selectedOrdersCount">0</span>)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="deleteOption" id="deleteAll" value="all">
                        <label class="form-check-label" for="deleteAll">
                            Remover TODOS os pedidos
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="confirmationTextOrders" class="form-label">
                        Para confirmar, digite <strong>CONFIRMAR</strong>:
                    </label>
                    <input type="text" id="confirmationTextOrders" class="form-control" placeholder="Digite CONFIRMAR aqui">
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Importante:</strong> Os pedidos serão removidos apenas do banco de dados local. 
                    Os pedidos originais no Mercado Libre não serão afetados.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="deleteOrdersButton" onclick="confirmDeleteOrders()" disabled>
                    <i class="bi bi-trash"></i> Remover Selecionados
                </button>
                <button type="button" class="btn btn-danger" id="deleteAllOrdersButton" onclick="confirmDeleteAllOrders()" style="display: none;">
                    <i class="bi bi-trash"></i> Remover Todos
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
