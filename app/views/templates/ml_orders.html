{% extends "base.html" %}

{% block title %}Pedidos - GVMIA{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4 d-flex justify-content-between flex-wrap gap-3 align-items-start">
                <div>
                <h1 class="h3 mb-1"><i class="bi bi-cart-check"></i> Pedidos Mercado Livre</h1>
                    <p class="text-muted mb-0">
                    Acompanhe todos os pedidos importados
                    <span id="orders-count" class="ms-2 small text-secondary">
                            <i class="bi bi-info-circle"></i> Carregando...
                        </span>
                    </p>
                </div>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-primary" onclick="syncOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar pedidos
                        </button>
                <button type="button" class="btn btn-outline-secondary" onclick="importOrders()">
                    <i class="bi bi-download"></i> Importar pedidos
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="showDeleteOrdersModal()">
                    <i class="bi bi-trash"></i> Remover pedidos
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3" id="alerts-container"></div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <form class="row g-3 align-items-end">
                        <div class="col-12 col-md-3">
                            <label for="account_filter" class="form-label small text-uppercase text-muted">Conta</label>
                            <select name="account_filter" id="account_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="status_filter" class="form-label small text-uppercase text-muted">Status</label>
                            <select name="status_filter" id="status_filter" class="form-select" onchange="applyFilters()">
                                <option value="">Todos os status</option>
                                <option value="pending">Pendente</option>
                                <option value="confirmed">Confirmado</option>
                                <option value="paid">Pago</option>
                                <option value="shipped">Enviado</option>
                                <option value="delivered">Entregue</option>
                                <option value="cancelled">Cancelado</option>
                                <option value="refunded">Reembolsado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="period_filter" class="form-label small text-uppercase text-muted">Período</label>
                            <select name="period_filter" id="period_filter" class="form-select" onchange="toggleCustomPeriod(); applyFilters();">
                                <option value="">Todos</option>
                                <option value="today">Hoje</option>
                                <option value="this_week">Esta semana</option>
                                <option value="this_month">Este mês</option>
                                <option value="last_month">Mês anterior</option>
                                <option value="next_month">Próximo mês</option>
                                <option value="next_30_days">Próximos 30 dias</option>
                                <option value="next_60_days">Próximos 60 dias</option>
                                <option value="next_90_days">Próximos 90 dias</option>
                                <option value="this_year">Este ano</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-2">
                            <label for="date_from" class="form-label small text-uppercase text-muted">Data inicial</label>
                            <input type="date" name="date_from" id="date_from" class="form-control" onchange="applyFilters()">
                            </div>
                        <div class="col-12 col-md-2">
                            <label for="date_to" class="form-label small text-uppercase text-muted">Data final</label>
                            <input type="date" name="date_to" id="date_to" class="form-control" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-auto">
                            <label class="form-label small text-uppercase text-muted">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="bi bi-x-circle"></i> Limpar filtros
                                </button>
                    </div>
                        </div>
                    </form>
                    
                    <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
                        <div class="col-12 col-md-3">
                            <label for="customDateFrom" class="form-label small text-uppercase text-muted">Data inicial</label>
                            <input type="date" class="form-control" id="customDateFrom" onchange="applyFilters()">
                        </div>
                        <div class="col-12 col-md-3">
                            <label for="customDateTo" class="form-label small text-uppercase text-muted">Data final</label>
                            <input type="date" class="form-control" id="customDateTo" onchange="applyFilters()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="row mb-4" id="loading-container" style="display: none;">
        <div class="col-12">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando pedidos...</p>
            </div>
        </div>
    </div>

    <!-- Lista de Orders -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div id="orders-cards-container" class="orders-card-list d-flex flex-column gap-3">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-info-circle"></i> Carregando pedidos...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginação -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    <span id="pagination-info">Mostrando 0 de 0 pedidos</span>
                </div>
                <nav aria-label="Navegação de pedidos">
                    <ul class="pagination mb-0" id="pagination">
                        <!-- Paginação será inserida aqui dinamicamente -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação para Importação -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">
                    <i class="bi bi-download text-success me-2"></i>Importação Inteligente de Pedidos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeImportModal"></button>
            </div>
            <div class="modal-body">
                <!-- Tela 1: Configuração -->
                <div id="import-config" style="display: block;">
                    <div class="text-center mb-4">
                        <i class="bi bi-cloud-download text-primary" style="font-size: 3rem;"></i>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Pedidos disponíveis:</strong> <span id="total-orders-available">Verificando...</span>
                    </div>
                    
                    <h6 class="mb-3">Estratégia de Importação:</h6>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-gear text-primary me-2"></i>Importação em Lotes Inteligentes
                            </h6>
                            <p class="card-text small">
                                Para importar todos os pedidos sem sobrecarregar o sistema, 
                                faremos a importação em lotes de <strong>50 pedidos</strong> com pausas automáticas entre cada lote.
                            </p>
                            <ul class="small mb-0">
                                <li>Lote: 50 pedidos por vez</li>
                                <li>Pausa entre pedidos: 5 segundos</li>
                                <li>Pausa entre lotes: 10 segundos</li>
                                <li>Tempo estimado: <span id="estimated-time">Calculando...</span></li>
                                <li>Você pode cancelar a qualquer momento</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Importação em Background:</strong> A importação rodará no servidor. Você pode fechar esta janela e até mesmo o navegador! O processo continuará executando.
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-laptop me-2"></i>
                        <strong>Dica:</strong> Após iniciar, você pode continuar usando o sistema normalmente. A lista de pedidos será atualizada automaticamente conforme novos pedidos forem importados.
                    </div>
                </div>
                
                <!-- Tela 2: Progresso -->
                <div id="import-progress" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-hourglass-split text-primary" style="font-size: 3rem;"></i>
                    </div>
                    
                    <h6 class="text-center mb-4">Importando pedidos...</h6>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="small">Progresso Geral</span>
                            <span class="small"><strong id="progress-text">0 / 0 (0%)</strong></span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%">
                                <span id="progress-percentage">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-success" id="imported-count">0</h4>
                                    <small class="text-muted">Importados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-warning" id="updated-count">0</h4>
                                    <small class="text-muted">Atualizados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <h4 class="mb-0 text-primary" id="current-batch">1</h4>
                                    <small class="text-muted">Lote Atual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small">
                        <div id="import-status">Preparando importação...</div>
                        <div id="import-eta" class="mt-2 text-muted"></div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-danger btn-sm" onclick="cancelImport()" id="cancel-import-btn">
                            <i class="bi bi-x-circle me-1"></i>Cancelar Importação
                        </button>
                    </div>
                </div>
                
                <!-- Tela 3: Conclusão -->
                <div id="import-complete" style="display: none;">
                    <div class="text-center mb-4">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    
                    <h5 class="text-center mb-4 text-success">Importação Concluída!</h5>
                    
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="card bg-success text-white">
                                <div class="card-body py-3">
                                    <h3 class="mb-0" id="final-imported">0</h3>
                                    <small>Pedidos Importados</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-warning text-white">
                                <div class="card-body py-3">
                                    <h3 class="mb-0" id="final-updated">0</h3>
                                    <small>Pedidos Atualizados</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        <div id="final-message">Todos os pedidos foram importados com sucesso!</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-modal-btn">
                    <i class="bi bi-x-circle me-1"></i>Fechar
                </button>
                <button type="button" class="btn btn-success" onclick="startBatchImport()" id="start-import-btn">
                    <i class="bi bi-download me-1"></i>Iniciar Importação
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderJsonModal" tabindex="-1" aria-labelledby="orderJsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orderJsonModalLabel"><i class="bi bi-code-slash"></i> JSON do Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <pre id="orderJsonContent" class="bg-light p-3 rounded small" style="max-height: 60vh; overflow: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<style>

/* Estilos para botões em loading */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.btn .spinner-border {
    color: currentColor;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}

/* Estilos para o modal de importação */
#importModal .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

#importModal .modal-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-radius: 12px 12px 0 0;
    border: none;
}

#importModal .modal-header .btn-close {
    filter: invert(1);
}

#importModal .modal-body {
    padding: 2rem;
}

#importModal .alert-info {
    border-left: 4px solid #17a2b8;
    background-color: #f8f9fa;
}

#importModal .list-unstyled li {
    padding: 0.5rem 0;
    font-size: 0.9rem;
}

#importModal .modal-footer {
    border: none;
    padding: 1rem 2rem 2rem 2rem;
}

#loading-container .card {
     border: none;
     box-shadow: 0 10px 30px rgba(0,0,0,0.12);
 }

.orders-card-list {
    margin: 0;
}

.order-card {
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 24px rgba(15, 23, 42, 0.16);
}

.order-card .card-body {
    padding: 1.5rem;
}

.order-card-header {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.order-card-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
    width: 100%;
    flex-wrap: wrap;
}

.order-summary {
    min-width: 0;
    flex: 1 1 auto;
}

.order-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-left: auto;
    min-width: 220px;
}

.order-summary-inline {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.order-summary-inline .summary-segment {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
}

.order-summary-inline .summary-segment:not(:last-child)::after {
    content: '•';
    color: #6c757d;
}

.order-actions .btn-group {
    flex-wrap: wrap;
}

.order-actions .btn-group .btn {
    margin-bottom: 0.25rem;
}

.order-details {
    border-top: 1px dashed rgba(0, 0, 0, 0.1);
    padding-top: 1.25rem;
}

.order-card .form-check-input {
    cursor: pointer;
}

@media (max-width: 992px) {
    .order-card-top {
        flex-direction: column;
        gap: 1rem;
    }

    .order-actions {
        justify-content: flex-start;
    }
}

.order-empty-state {
    border: 1px dashed rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    padding: 2rem;
    background: #f8fafc;
}

.item-line {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.item-thumb {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    border: 1px solid rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.item-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-thumb.placeholder {
    color: #6c757d;
    font-size: 1.25rem;
}

.item-info {
    min-width: 0;
}

.item-info .item-title {
    font-weight: 500;
    display: block;
}

.item-info .item-meta {
    font-size: 0.75rem;
    color: #6c757d;
}

</style>

<script>
let currentPage = 1;
let currentLimit = 50;
let currentFilters = {};
let ordersCache = {};

function showLoading(isLoading) {
    const loadingContainer = document.getElementById('loading-container');
    const cardsContainer = document.getElementById('orders-cards-container');

    if (loadingContainer) {
        loadingContainer.style.display = isLoading ? '' : 'none';
    }

    if (isLoading && cardsContainer) {
        cardsContainer.innerHTML = '';
    }

    updateSelectedOrdersCount();
}

function getSelectedOrderIds() {
    return Array.from(document.querySelectorAll('.order-checkbox:checked'))
        .map(input => input.value)
        .filter(Boolean);
}

function updateSelectedOrdersCount() {
    const deleteBtn = document.querySelector('button[onclick="showDeleteOrdersModal()"]');
    if (deleteBtn) {
        deleteBtn.disabled = getSelectedOrderIds().length === 0;
    }
}

// Função utilitária para formatar datas em pt-BR com hora padrão
function formatDate(dateString) {
    if (!dateString) {
        return 'N/A';
    }
    try {
        const date = new Date(dateString);
        return `${date.toLocaleDateString('pt-BR')} ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
    } catch (err) {
        console.warn('Não foi possível formatar data:', dateString, err);
        return String(dateString);
    }
}

function formatCurrency(amount, currency = 'BRL') {
    if (amount === null || amount === undefined) {
        amount = 0;
    }
    try {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: currency || 'BRL',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(Number(amount));
    } catch (err) {
        console.warn('Não foi possível formatar valor:', amount, err);
        return `R$ ${Number(amount).toFixed(2)}`;
    }
}

function formatDateTime(dateString) {
    if (!dateString) {
        return '';
    }
    try {
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) {
            return String(dateString);
        }
        return date.toLocaleString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    } catch (err) {
        console.warn('Não foi possível formatar data/hora:', dateString, err);
        return String(dateString);
    }
}

function formatDateOnly(dateString) {
    if (!dateString) {
        return '';
    }
    try {
        const date = new Date(dateString);
        if (Number.isNaN(date.getTime())) {
            return String(dateString);
        }
        return date.toLocaleDateString('pt-BR');
    } catch (err) {
        console.warn('Não foi possível formatar data:', dateString, err);
        return String(dateString);
    }
}

function showError(message) {
    const alertContainer = document.getElementById('alerts-container');
    if (!alertContainer) {
        alert(message);
        return;
    }
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

function showSuccess(message) {
    const alertContainer = document.getElementById('alerts-container');
    if (!alertContainer) {
        alert(message);
        return;
    }
    alertContainer.innerHTML = `
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        </div>
    `;
}

// Função para verificar se a resposta indica sessão expirada
function checkSessionExpired(response) {
    if (response.status === 401 || response.status === 403) {
        const redirectUrl = `/auth/login?next=${encodeURIComponent(window.location.pathname + window.location.search)}`;
        window.location.replace(redirectUrl);
        return true;
    }
    return false;
}

// Função para ocultar elementos de usuário logado
function hideUserElements() {
    // Ocultar botões de ação
    const syncBtn = document.getElementById('sync-btn');
    const importBtn = document.getElementById('import-btn');
    const deleteBtn = document.querySelector('button[onclick="showDeleteOrdersModal()"]');
    
    if (syncBtn) syncBtn.style.display = 'none';
    if (importBtn) importBtn.style.display = 'none';
    if (deleteBtn) deleteBtn.style.display = 'none';
    
    // Ocultar filtros
    const filtersSection = document.querySelector('.row:has(.card .card-header h5)');
    if (filtersSection) {
        const filtersCard = filtersSection.querySelector('.card');
        if (filtersCard && filtersCard.textContent.includes('Filtros')) {
            filtersSection.style.display = 'none';
        }
    }
    
    // Ocultar tabela
    const tableSection = document.querySelector('.row:has(.card .card-header h5)');
    if (tableSection) {
        const tableCard = tableSection.querySelector('.card');
        if (tableCard && tableCard.textContent.includes('Lista de Pedidos')) {
            tableSection.style.display = 'none';
        }
    }
    
    // Mostrar mensagem de sessão expirada
    const alertContainer = document.getElementById('alerts-container');
    if (alertContainer) {
        alertContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning text-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Sessão expirada!</strong> Faça login novamente para continuar.
                </div>
            </div>
        `;
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    loadOrders();
});


function loadOrders(page = 1) {
    showLoading(true);
    
    var urlParams = new URLSearchParams(window.location.search);
    
    // Coletar filtros
    var selectedLimit = 50;  // Limite fixo de 50 pedidos por página
    
    var filters = {
        ml_account_id: urlParams.get('account_filter') || '',
        status_filter: urlParams.get('status_filter') || '',
        date_from: urlParams.get('date_from') || '',
        date_to: urlParams.get('date_to') || '',
        period_filter: urlParams.get('period_filter') || '',
        limit: selectedLimit,
        offset: (page - 1) * selectedLimit
    };
    
    // Construir URL da API (com prefixo /ml)
    var apiUrl = `/ml/api/orders?page=${page}&limit=${filters.limit}&offset=${filters.offset}`;
    
    if (filters.ml_account_id) apiUrl += `&ml_account_id=${encodeURIComponent(filters.ml_account_id)}`;
    if (filters.status_filter) apiUrl += `&status_filter=${encodeURIComponent(filters.status_filter)}`;
    if (filters.date_from) apiUrl += `&date_from=${encodeURIComponent(filters.date_from)}`;
    if (filters.date_to) apiUrl += `&date_to=${encodeURIComponent(filters.date_to)}`;
    if (filters.period_filter) apiUrl += `&period_filter=${encodeURIComponent(filters.period_filter)}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => {
        if (checkSessionExpired(response)) {
            return;
        }
        return response.json();
    })
    .then(data => {
        console.log('Resposta da API:', data);
        if (data && data.success) {
            renderOrders(data.orders);
            updateOrdersCount(data.total);
            renderPagination(data.total, filters.limit, page);
            loadAccountsFilter(data.accounts || []);
        } else {
            console.error('Erro na API:', data);
            showError('Erro ao carregar pedidos: ' + (data?.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        showError('Erro ao carregar pedidos: ' + error.message);
    })
    .finally(() => {
        showLoading(false);
    });
}

function renderOrders(orders) {
    const container = document.getElementById('orders-cards-container');
    if (!container) {
        return;
    }

    if (!orders || orders.length === 0) {
        container.innerHTML = `
            <div class="order-empty-state text-center text-muted">
                <i class="bi bi-archive"></i>
                <div class="mt-2">Nenhum pedido encontrado para os filtros selecionados.</div>
            </div>
        `;
        ordersCache = {};
        updateSelectedOrdersCount();
        return;
    }

    ordersCache = {};
    container.innerHTML = orders.map(order => {
        const cacheKey = order.id || order.ml_order_id || order.order_id;
        if (cacheKey) {
            ordersCache[cacheKey] = order;
        }

        const checkboxValue = cacheKey || '';
        const actions = renderOrderActions(order) || '';

        return `
            <div class="order-card card shadow-sm">
                <div class="card-body">
                    <div class="order-card-header">
                        <div class="order-card-top flex-wrap">
                            <div class="d-flex align-items-start gap-3 flex-grow-1">
                                <div class="form-check mt-1">
                                    <input class="form-check-input order-checkbox" type="checkbox" value="${checkboxValue}" onchange="updateSelectedOrdersCount()">
                                </div>
                                <div class="order-summary">${renderOrderSummary(order)}</div>
                            </div>
                            <div class="order-actions">${actions}</div>
                        </div>
                        <div class="order-details">${renderDetailsSummary(order)}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    updateSelectedOrdersCount();
}

function updateOrdersCount(total) {
    const ordersCountElement = document.getElementById('orders-count');
    if (ordersCountElement) {
        ordersCountElement.innerHTML = `<i class="bi bi-info-circle"></i> ${total} pedido(s) encontrado(s)`;
    }

    const totalOrdersElement = document.getElementById('total-orders');
    if (totalOrdersElement) {
        totalOrdersElement.textContent = `${total} pedidos`;
    }
}

function renderOrderSummary(order) {
    if (!order) {
        return '<span class="text-muted small">N/A</span>';
    }

    const orderId = order.ml_order_id || order.order_id || '-';
    const createdAt = formatDate(order.date_created);
    const accountLabel = order.account_nickname || order.account_name;
    const summarySegments = [];

    summarySegments.push(`<span class="summary-segment"><span class="fw-semibold">${orderId}</span></span>`);

    if (accountLabel) {
        summarySegments.push(`<span class="summary-segment text-muted">${sanitizeText(accountLabel)}</span>`);
    }

    if (createdAt) {
        summarySegments.push(`<span class="summary-segment text-muted"><i class="bi bi-clock-history me-1"></i>${createdAt}</span>`);
    }

    const summaryLine = summarySegments.join('');

    const buyerDetails = renderBuyerSummary(order);
    if (buyerDetails) {
        return `
            <div class="d-flex flex-column gap-2">
                <div class="order-summary-inline">${summaryLine}</div>
                <div class="pt-2 border-top">${buyerDetails}</div>
            </div>
        `;
    }

    return `<div class="order-summary-inline">${summaryLine}</div>`;
}

function renderPagination(total, limit, currentPage) {
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('pagination-info');
    const totalPages = Math.ceil(total / limit);
    
    if (paginationInfo) {
    const startItem = (currentPage - 1) * limit + 1;
    const endItem = Math.min(currentPage * limit, total);
        paginationInfo.textContent = totalPages > 0
            ? `Mostrando ${startItem} a ${endItem} de ${total} pedidos`
            : 'Nenhum pedido encontrado';
    }

    if (!pagination) {
        return;
    }
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';

    const addPageButton = (page, label, disabled = false, active = false) => {
        html += `
            <li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
                <a class="page-link" href="#" ${disabled ? 'tabindex="-1" aria-disabled="true"' : `onclick="loadOrders(${page})"`}>${label}</a>
            </li>
        `;
    };

    addPageButton(1, '<i class="bi bi-chevron-double-left"></i>', currentPage === 1);
    addPageButton(Math.max(1, currentPage - 1), '<i class="bi bi-chevron-left"></i>', currentPage === 1);

    const start = Math.max(1, currentPage - 2);
    const end = Math.min(totalPages, currentPage + 2);

    for (let page = start; page <= end; page++) {
        addPageButton(page, page, false, page === currentPage);
    }

    addPageButton(Math.min(totalPages, currentPage + 1), '<i class="bi bi-chevron-right"></i>', currentPage === totalPages);
    addPageButton(totalPages, '<i class="bi bi-chevron-double-right"></i>', currentPage === totalPages);

    pagination.innerHTML = html;
}

function loadAccountsFilter(accounts) {
    const select = document.getElementById('account_filter');
    if (!select) {
        return;
    }
    
    const currentValue = new URLSearchParams(window.location.search).get('account_filter') || '';
    select.innerHTML = '<option value="">Todas as contas</option>';
    
    (accounts || []).forEach(account => {
        const option = document.createElement('option');
        option.value = account.id;
        option.textContent = `${account.nickname || 'Conta'} (${account.country_id || 'BR'})`;
        option.selected = String(currentValue) === String(account.id);
        select.appendChild(option);
    });
}

function renderInvoiceDropdown(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    if (!orderId) {
        return '';
    }

    const hasInvoice = Boolean(order.invoice_pdf_url);
    const downloadItem = hasInvoice
        ? `<li><a class="dropdown-item" href="/api/shipments/download-invoice/${orderId}" target="_blank"><i class="bi bi-file-earmark-pdf"></i> Baixar nota</a></li>`
        : `<li><button class="dropdown-item disabled" type="button"><i class="bi bi-file-earmark"></i> Nota indisponível</button></li>`;

    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Opções de nota fiscal">
                <i class="bi bi-file-earmark-text"></i>
            </button>
            <ul class="dropdown-menu">
                <li><button class="dropdown-item" type="button" onclick="syncInvoiceForOrder('${orderId}', this)"><i class="bi bi-arrow-repeat"></i> Sincronizar com ML</button></li>
                ${downloadItem}
            </ul>
        </div>
    `;
}

function renderLabelDropdown(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    const shippingId = order.shipping_id || (order.shipping_details && order.shipping_details.id);

    if (!orderId) {
        return '';
    }

    if (!shippingId) {
        return `<button class="btn btn-outline-secondary" type="button" title="Etiqueta indisponível" disabled><i class="bi bi-printer"></i></button>`;
    }

    return `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Imprimir etiqueta">
                <i class="bi bi-printer"></i>
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=pdf" target="_blank"><i class="bi bi-filetype-pdf"></i> PDF</a></li>
                <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2" target="_blank"><i class="bi bi-printer-fill"></i> ZPL2</a></li>
                <li><a class="dropdown-item" href="/api/shipments/download-label/${orderId}?format=zpl2pdf" target="_blank"><i class="bi bi-file-earmark-pdf"></i> ZPL2 → PDF</a></li>
            </ul>
        </div>
    `;
}

async function syncInvoiceForOrder(orderId, triggerElement) {
    if (!orderId) return;

    const button = triggerElement;
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sincronizando...';

    try {
        const response = await fetch(`/api/shipments/sync-single-invoice/${orderId}`, {
            method: 'POST',
            credentials: 'include'
        });

        if (checkSessionExpired(response)) {
            return;
        }

        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.error || `Erro ${response.status}`);
        }

        showSuccess(`Nota fiscal do pedido ${orderId} sincronizada.`);
    } catch (error) {
        console.error('Erro ao sincronizar nota:', error);
        showError(error.message || 'Erro ao sincronizar nota fiscal.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

function openOrderJson(orderKey) {
    if (!orderKey || !ordersCache[orderKey]) {
        showError('Dados do pedido não encontrados.');
        return;
    }

    const modalElement = document.getElementById('orderJsonModal');
    const modalBody = document.getElementById('orderJsonContent');
    if (!modalElement || !modalBody) {
        showError('Modal de visualização não disponível.');
        return;
    }

    modalBody.textContent = JSON.stringify(ordersCache[orderKey], null, 2);
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

function renderBuyerSummary(order) {
    const nickname = order.buyer_nickname ? sanitizeText(order.buyer_nickname) : '';
    const nameParts = [order.buyer_first_name, order.buyer_last_name].filter(Boolean).join(' ');
    const email = order.buyer_email || '';
    const phone = order.buyer_phone || order.buyer_phone_number || '';
    const address = order.shipping_address || order.buyer_address || {};

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.id || '';
        }
        return String(value);
    };

    const street = sanitizeText(address.address_line || address.street_name || address.street_address || '');
    const comment = sanitizeText(address.comment || address.suburb || '');
    const city = sanitizeText(extractValue(address.city));
    const state = sanitizeText(extractValue(address.state));
    const district = sanitizeText(extractValue(address.neighborhood));
    const postalCode = sanitizeText(address.zip_code || address.postal_code);

    let receiverName = '';
    const shippingDetails = order.shipping_details;
    if (shippingDetails && typeof shippingDetails === 'object') {
        const destination = shippingDetails.destination || {};
        receiverName = destination.receiver_name || extractValue(destination.receiverName);
        if (!receiverName) {
            const shippingAddr = destination.shipping_address || {};
            receiverName = extractValue(shippingAddr.receiver_name);
        }
        if (!receiverName) {
            const receiverAddress = shippingDetails.receiver_address || {};
            receiverName = extractValue(receiverAddress.receiver_name);
        }
    }

    if (!receiverName && address.receiver_name) {
        receiverName = sanitizeText(extractValue(address.receiver_name));
    }

    const formattedNameParts = sanitizeText(nameParts);
    const mainName = formattedNameParts || receiverName || nickname || 'Comprador';
    const showDistinctReceiver = receiverName && receiverName !== mainName && receiverName !== nickname;

    const locationLine = [city, state].filter(Boolean).join(' - ');

    const addressLines = [street, comment, district, locationLine, postalCode ? `CEP: ${postalCode}` : null].filter(Boolean);

    const lines = [];
    const namePartsInline = [
        `<span class="fw-semibold">${mainName}</span>`
    ];
    if (nickname) {
        namePartsInline.push(`<span class="text-muted">(${nickname})</span>`);
    }
    lines.push(`<div class="d-flex flex-wrap gap-2 align-items-center">${namePartsInline.join(' ')}</div>`);

    if (showDistinctReceiver) {
        lines.push(`<div class="text-muted small">${receiverName}</div>`);
    }
    lines.push(email ? `<div class="text-muted small"><i class="bi bi-envelope me-1"></i>${email}</div>` : '');
    lines.push(phone ? `<div class="text-muted small"><i class="bi bi-telephone me-1"></i>${phone}</div>` : '');
    lines.push(addressLines.length ? `<div class="text-muted small">${addressLines.join(' <span class="text-muted">•</span> ')}</div>` : '');

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}


function getItemQuantity(entry) {
    if (!entry) {
        return 0;
    }
    if (typeof entry.quantity === 'number') {
        return entry.quantity;
    }
    if (entry.requested_quantity && typeof entry.requested_quantity.value === 'number') {
        return entry.requested_quantity.value;
    }
    if (entry.available_quantity && typeof entry.available_quantity === 'number') {
        return entry.available_quantity;
    }
    return 0;
}

function normalizeItemImageUrl(url) {
    if (!url) {
        return '';
    }
    let normalized = String(url).trim();
    if (!normalized) {
        return '';
    }
    if (normalized.startsWith('//')) {
        normalized = 'https:' + normalized;
    }
    if (normalized.startsWith('http://')) {
        normalized = 'https://' + normalized.slice(7);
    }
    return normalized;
}

function sanitizeText(value) {
    if (value === null || value === undefined) {
        return '';
    }
    return String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function getItemThumbnail(itemData) {
    if (!itemData || typeof itemData !== 'object') {
        return '';
    }

    if (itemData.thumbnail) {
        return normalizeItemImageUrl(itemData.thumbnail);
    }

    if (Array.isArray(itemData.pictures) && itemData.pictures.length) {
        const firstPicture = itemData.pictures[0];
        if (typeof firstPicture === 'string') {
            return normalizeItemImageUrl(firstPicture);
        }
        if (firstPicture && typeof firstPicture === 'object') {
            return normalizeItemImageUrl(firstPicture.url || firstPicture.secure_url);
        }
    }

    if (itemData.picture_url) {
        return normalizeItemImageUrl(itemData.picture_url);
    }

    if (Array.isArray(itemData.picture_urls) && itemData.picture_urls.length) {
        return normalizeItemImageUrl(itemData.picture_urls[0]);
    }

    if (Array.isArray(itemData.picture_ids) && itemData.picture_ids.length) {
        return `https://http2.mlstatic.com/D_${itemData.picture_ids[0]}-O.jpg`;
    }

    return '';
}

function renderAmountSummary(order) {
    const totalAmount = order.total_amount || 0;
    const saleFees = order.sale_fees || 0;
    const shippingCost = order.shipping_cost || 0;
    const couponAmount = order.coupon_amount || 0;
    const advertisingCost = order.advertising_cost || 0;
    const currency = order.currency_id || 'BRL';

    const netAmount = totalAmount - saleFees - shippingCost - couponAmount;

    const lines = [
        `<div class="fw-semibold text-primary">${formatCurrency(totalAmount, currency)}</div>`,
        `<div class="text-muted small">Comissão: ${formatCurrency(saleFees, currency)}</div>`,
        `<div class="text-muted small">Frete: ${formatCurrency(shippingCost, currency)}</div>`
    ];

    if (couponAmount > 0) {
        lines.push(`<div class="text-muted small">Desconto: -${formatCurrency(couponAmount, currency)}</div>`);
    }

    if (advertisingCost > 0) {
        lines.push(`<div class="text-muted small">Publicidade: ${formatCurrency(advertisingCost, currency)}</div>`);
    }

    lines.push(`<div class="fw-semibold text-success mt-1">${formatCurrency(netAmount, currency)}</div>`);

    return `<div class="d-flex flex-column gap-1 small">${lines.join('')}</div>`;
}

function renderDetailsSummary(order) {
    let itemsRaw = order.order_items;
    
    if (!itemsRaw) {
        return '<span class="text-muted small">N/A</span>';
    }
    
    if (typeof itemsRaw === 'string') {
        try {
            itemsRaw = JSON.parse(itemsRaw);
        } catch (error) {
            console.warn('Não foi possível parsear order_items:', error);
            itemsRaw = [];
        }
    }
    
    if (!Array.isArray(itemsRaw) || itemsRaw.length === 0) {
        return '<span class="text-muted small">N/A</span>';
    }
    
    let totalAmount = order.total_amount || 0;
    const currency = order.currency_id || 'BRL';

    const rows = itemsRaw.map(entry => {
        const itemData = entry.item || entry;
        const title = sanitizeText(itemData?.title || itemData?.name || 'Item sem título');
        const quantityValue = getItemQuantity(entry) || 1;
        const thumbnail = getItemThumbnail(itemData);
        const unitPrice = entry.unit_price || itemData?.unit_price || 0;
        const currency = order.currency_id || itemData?.currency_id || 'BRL';
        const totalLine = unitPrice * quantityValue;

        const imageCell = thumbnail
            ? `<img src="${thumbnail}" alt="${title}" class="img-fluid rounded" style="width:48px;height:48px;object-fit:cover;">`
            : '<span class="text-muted">—</span>';

        return `
            <tr>
                <td class="text-center align-middle" style="width:60px;">${imageCell}</td>
                <td class="align-middle">
                    <div class="fw-semibold small">${title}</div>
                </td>
                <td class="text-end align-middle" style="width:120px;">
                    ${formatCurrency(unitPrice, currency)}
                </td>
                <td class="text-end align-middle" style="width:80px;">
                    ${quantityValue}
                </td>
                <td class="text-end align-middle" style="width:120px;">
                    ${formatCurrency(totalLine, currency)}
                </td>
            </tr>
        `;
    });

    const shippingInline = renderShippingSummary(order);

    return `
        <div class="d-flex flex-column gap-2">
            <div class="table-responsive">
                <table class="table table-sm table-borderless align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width:60px;">Imagem</th>
                            <th>Descrição</th>
                            <th class="text-end" style="width:120px;">Valor unitário</th>
                            <th class="text-end" style="width:80px;">Quantidade</th>
                            <th class="text-end" style="width:120px;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.join('')}
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="4" class="text-end fw-semibold">Total:</td>
                            <td class="text-end fw-semibold text-primary">${formatCurrency(totalAmount, currency)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            ${shippingInline ? `<div class="pt-2 border-top">${shippingInline}</div>` : ''}
        </div>
    `;
}

function renderShippingSummary(order) {
    let shipping = order.shipping_details || order.shipping || {};
    if (typeof shipping === 'string') {
        try {
            shipping = JSON.parse(shipping);
        } catch (err) {
            shipping = {};
        }
    }

    const logisticTypeRaw = shipping.shipping_option?.logistic_type
        || shipping.logistic_type
        || shipping.logistic?.type
        || order.logistic_type
        || order.shipping_logistic_type
        || order.shipping_type;

    const logisticLabel = getLogisticLabel(logisticTypeRaw);
    const statusRaw = shipping.status || order.shipping_status || '';
    const substatusRaw = shipping.substatus || order.shipping_substatus || '';
    const status = (statusRaw || '').toString().toLowerCase();
    const substatus = (substatusRaw || '').toString().toLowerCase();
    const translatedStatus = status ? translateShippingLabel(status) : null;
    const translatedSubstatus = substatus ? translateShippingLabel(substatus) : null;
    const statusHistory = shipping.status_history || {};

    const shippedDate = shipping.date_shipped || statusHistory.date_shipped || order.date_shipped;
    const deliveredDate = statusHistory.date_delivered || shipping.date_delivered || order.date_delivered;
    const estimatedDate = shipping.shipping_option?.estimated_delivery_final?.date
        || shipping.shipping_option?.estimated_delivery_limit?.date
        || shipping.estimated_delivery
        || order.estimated_delivery_date;

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.description || value.id || '';
        }
        return String(value);
    };

    const shippingMethodSource = logisticLabel
        || extractValue(order.shipping_method)
        || extractValue(order.shipping_mode)
        || extractValue(shipping.shipping_option?.shipping_method)
        || extractValue(shipping.shipping_option?.name)
        || extractValue(logisticTypeRaw);

    const shippingMethod = getLogisticLabel(shippingMethodSource) || logisticLabel || extractValue(logisticTypeRaw) || null;

    const segments = [];
    const badgeClass = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
    if (shippingMethod) {
        segments.push(`<span class="badge ${badgeClass}">${shippingMethod}</span>`);
    }

    if (translatedStatus) {
        const readyStatuses = new Set(['ready_to_ship', 'ready_to_print', 'printed', 'packed', 'ready_to_pack']);
        const transitStatuses = new Set(['shipped', 'in_transit', 'out_for_delivery', 'soon_deliver']);

        if (status === 'pending') {
            segments.push(`<span class="text-secondary">⏳ ${translatedStatus}</span>`);
        } else if (readyStatuses.has(status)) {
            segments.push(`<span class="text-warning">📦 ${translatedStatus}</span>`);
        } else if (status === 'delivered') {
            segments.push(`<span class="text-success fw-semibold">✓ ${translatedStatus}</span>`);
        } else if (transitStatuses.has(status)) {
            segments.push(`<span class="text-info">🚚 ${translatedStatus}</span>`);
        } else {
            const icon = shippingStatusIcons[status] || '🚚';
            const statusClass = getShippingStatusClass(status);
            const baseClass = statusClass ? `${statusClass} small` : 'text-muted';
            segments.push(`<span class="${baseClass}">${icon} ${translatedStatus}</span>`);
        }
    }

    if (translatedSubstatus && translatedSubstatus !== '-' && translatedSubstatus !== translatedStatus) {
        segments.push(`<span class="text-muted">📍 ${translatedSubstatus}</span>`);
    }

    if (status === 'delivered' && deliveredDate) {
        const deliveredFormatted = formatDateOnly(deliveredDate);
        if (deliveredFormatted) {
            segments.push(`<span class="text-success">📅 ${deliveredFormatted}</span>`);
        }
    }

    if (status !== 'delivered' && shippedDate) {
        const shippedFormatted = formatDateOnly(shippedDate);
        if (shippedFormatted) {
            segments.push(`<span class="text-muted">📦 Enviado: ${shippedFormatted}</span>`);
        }
    }

    const isPickup = ['xd_drop_off', 'drop_off'].includes((logisticTypeRaw || '').toString().toLowerCase());
    const dropOffDate = shipping.status_history?.date_handling || shipping.date_created || order.shipping_date;
    if (isPickup) {
        const dropOffFormatted = formatDateTime(dropOffDate);
        if (dropOffFormatted) {
            segments.push(`<span class="text-muted">📦 Registrado: ${dropOffFormatted}</span>`);
        }

        const bufferingDate = shipping.shipping_option?.buffering?.date;
        const bufferingFormatted = formatDateOnly(bufferingDate);
        if (bufferingFormatted) {
            segments.push(`<span class="text-muted">🗓 Liberado para envio em: ${bufferingFormatted}</span>`);
        }
    }

    if (estimatedDate && status !== 'delivered') {
        const estimatedFormatted = formatDateOnly(estimatedDate);
        if (estimatedFormatted) {
            segments.push(`<span class="text-muted">📅 Previsão: ${estimatedFormatted}</span>`);
        }
    }

    if (!segments.length && (logisticLabel || shippingMethod)) {
        const fallbackBadge = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
        const label = logisticLabel || shippingMethod || 'N/A';
        return `<div class="order-shipping-inline small"><span class="badge ${fallbackBadge}">${label}</span></div>`;
    }

    return segments.length
        ? `<div class="order-shipping-inline small text-muted d-flex flex-column gap-1"><div class="d-flex flex-wrap align-items-center gap-2">${segments.join('<span class="text-muted">•</span>')}</div></div>`
        : `<div class="order-shipping-inline small text-muted"><span class="badge bg-secondary">N/A</span></div>`;
}

function getStatusBadgeClass(status) {
    switch ((status || '').toString().toLowerCase()) {
        case 'paid':
            return 'badge bg-primary';
        case 'shipped':
            return 'badge bg-info';
        case 'delivered':
            return 'badge bg-success';
        case 'cancelled':
        case 'canceled':
            return 'badge bg-danger';
        case 'ready_to_ship':
            return 'badge bg-warning text-dark';
        default:
            return 'badge bg-secondary';
    }
}

function getStatusLabel(status) {
    const normalized = (status || '').toString().toLowerCase();
    const labels = {
        paid: 'Pago',
        shipped: 'Enviado',
        delivered: 'Entregue',
        cancelled: 'Cancelado',
        canceled: 'Cancelado',
        ready_to_ship: 'Pronto para envio'
    };
    return labels[normalized] || (normalized ? normalized : 'Desconhecido');
}

function renderShippingSummary(order) {
    let shipping = order.shipping_details || order.shipping || {};
    if (typeof shipping === 'string') {
        try {
            shipping = JSON.parse(shipping);
        } catch (err) {
            shipping = {};
        }
    }

    const logisticTypeRaw = shipping.shipping_option?.logistic_type
        || shipping.logistic_type
        || shipping.logistic?.type
        || order.logistic_type
        || order.shipping_logistic_type
        || order.shipping_type;

    const logisticLabel = getLogisticLabel(logisticTypeRaw);
    const statusRaw = shipping.status || order.shipping_status || '';
    const substatusRaw = shipping.substatus || order.shipping_substatus || '';
    const status = (statusRaw || '').toString().toLowerCase();
    const substatus = (substatusRaw || '').toString().toLowerCase();
    const translatedStatus = status ? translateShippingLabel(status) : null;
    const translatedSubstatus = substatus ? translateShippingLabel(substatus) : null;
    const statusHistory = shipping.status_history || {};

    const shippedDate = shipping.date_shipped || statusHistory.date_shipped || order.date_shipped;
    const deliveredDate = statusHistory.date_delivered || shipping.date_delivered || order.date_delivered;
    const estimatedDate = shipping.shipping_option?.estimated_delivery_final?.date
        || shipping.shipping_option?.estimated_delivery_limit?.date
        || shipping.estimated_delivery
        || order.estimated_delivery_date;

    const extractValue = (value) => {
        if (!value) return '';
        if (typeof value === 'string') return value;
        if (typeof value === 'object') {
            return value.name || value.display_name || value.label || value.description || value.id || '';
        }
        return String(value);
    };

    const shippingMethodSource = logisticLabel
        || extractValue(order.shipping_method)
        || extractValue(order.shipping_mode)
        || extractValue(shipping.shipping_option?.shipping_method)
        || extractValue(shipping.shipping_option?.name)
        || extractValue(logisticTypeRaw);

    const shippingMethod = getLogisticLabel(shippingMethodSource) || logisticLabel || extractValue(logisticTypeRaw) || null;

    const segments = [];
    const badgeClass = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
    if (shippingMethod) {
        segments.push(`<span class="badge ${badgeClass}">${shippingMethod}</span>`);
    }

    if (translatedStatus) {
        const readyStatuses = new Set(['ready_to_ship', 'ready_to_print', 'printed', 'packed', 'ready_to_pack']);
        const transitStatuses = new Set(['shipped', 'in_transit', 'out_for_delivery', 'soon_deliver']);

        if (status === 'pending') {
            segments.push(`<span class="text-secondary">⏳ ${translatedStatus}</span>`);
        } else if (readyStatuses.has(status)) {
            segments.push(`<span class="text-warning">📦 ${translatedStatus}</span>`);
        } else if (status === 'delivered') {
            segments.push(`<span class="text-success fw-semibold">✓ ${translatedStatus}</span>`);
        } else if (transitStatuses.has(status)) {
            segments.push(`<span class="text-info">🚚 ${translatedStatus}</span>`);
        } else {
            const icon = shippingStatusIcons[status] || '🚚';
            const statusClass = getShippingStatusClass(status);
            const baseClass = statusClass ? `${statusClass} small` : 'text-muted';
            segments.push(`<span class="${baseClass}">${icon} ${translatedStatus}</span>`);
        }
    }

    if (translatedSubstatus && translatedSubstatus !== '-' && translatedSubstatus !== translatedStatus) {
        segments.push(`<span class="text-muted">📍 ${translatedSubstatus}</span>`);
    }

    if (status === 'delivered' && deliveredDate) {
        const deliveredFormatted = formatDateOnly(deliveredDate);
        if (deliveredFormatted) {
            segments.push(`<span class="text-success">📅 ${deliveredFormatted}</span>`);
        }
    }

    if (status !== 'delivered' && shippedDate) {
        const shippedFormatted = formatDateOnly(shippedDate);
        if (shippedFormatted) {
            segments.push(`<span class="text-muted">📦 Registrado: ${shippedFormatted}</span>`);
        }
    }

    const isPickup = ['xd_drop_off', 'drop_off'].includes((logisticTypeRaw || '').toString().toLowerCase());
    const dropOffDate = shipping.status_history?.date_handling || shipping.date_created || order.shipping_date;
    if (isPickup) {
        const dropOffFormatted = formatDateTime(dropOffDate);
        if (dropOffFormatted) {
            segments.push(`<span class="text-muted">📦 Registrado: ${dropOffFormatted}</span>`);
        }

        const bufferingDate = shipping.shipping_option?.buffering?.date;
        const bufferingFormatted = formatDateOnly(bufferingDate);
        if (bufferingFormatted) {
            segments.push(`<span class="text-muted">🗓 Liberado para envio em: ${bufferingFormatted}</span>`);
        }
    }

    if (estimatedDate && status !== 'delivered') {
        const estimatedFormatted = formatDateOnly(estimatedDate);
        if (estimatedFormatted) {
            segments.push(`<span class="text-muted">📅 Previsão: ${estimatedFormatted}</span>`);
        }
    }

    if (!segments.length && (logisticLabel || shippingMethod)) {
        const fallbackBadge = getLogisticBadgeClass(logisticTypeRaw || shippingMethod);
        const label = logisticLabel || shippingMethod || 'N/A';
        return `<div class="order-shipping-inline small"><span class="badge ${fallbackBadge}">${label}</span></div>`;
    }

    return segments.length
        ? `<div class="order-shipping-inline small text-muted d-flex flex-column gap-1"><div class="d-flex flex-wrap align-items-center gap-2">${segments.join('<span class="text-muted">•</span>')}</div></div>`
        : `<div class="order-shipping-inline small text-muted"><span class="badge bg-secondary">N/A</span></div>`;
}

function getLogisticLabel(logisticType) {
    const normalized = (logisticType || '').toString().toLowerCase();
    switch (normalized) {
        case 'fulfillment':
        case 'full':
            return 'Fulfillment';
        case 'cross_docking':
            return 'Cross Docking';
        case 'me2':
            return 'Mercado Envios';
        case 'me1':
            return 'Correios';
        case 'xd_drop_off':
        case 'drop_off':
        case 'ponto de coleta':
            return 'Ponto de Coleta';
        case 'self_service':
            return 'Envio próprio';
        default:
            return logisticType || 'N/A';
    }
}

function translateShippingLabel(value) {
    if (!value) return '-';
    const labels = {
        pending: 'Pendente',
        ready_to_ship: 'Pronto para envio',
        ready_to_print: 'Pronto para imprimir',
        printed: 'Etiqueta impressa',
        ready_to_pack: 'Pronto para embalar',
        packed: 'Pacote pronto',
        shipped: 'Enviado',
        in_transit: 'Em trânsito',
        out_for_delivery: 'Saiu para entrega',
        soon_deliver: 'Próximo da entrega',
        delivered: 'Entregue',
        not_delivered: 'Não entregue',
        cancelled: 'Cancelado',
        to_be_agreed: 'A combinar',
        error: 'Erro',
        buffered: 'Aguardando...',
        receiver_absent: 'Comprador ausente',
        receiver_absent_twice: 'Comprador ausente (2x)',
        in_warehouse: 'No armazém',
        in_packing_list: 'Na fila de embalagem'
    };
    const normalized = value.toString().toLowerCase();
    if (labels[normalized]) {
        return labels[normalized];
    }
    return value.replace(/_/g, ' ');
}

const shippingStatusIcons = {
    pending: '⏳',
    ready_to_ship: '📦',
    ready_to_print: '📦',
    printed: '📦',
    ready_to_pack: '📦',
    packed: '📦',
    shipped: '🚚',
    in_transit: '🚚',
    out_for_delivery: '🚚',
    soon_deliver: '🚚',
    delivered: '✓',
    not_delivered: '⚠️',
    cancelled: '⛔',
    to_be_agreed: 'ℹ️',
    error: '⚠️',
    buffered: '⏳',
    receiver_absent: '📍',
    receiver_absent_twice: '📍',
    in_warehouse: '🏬',
    in_packing_list: '📦'
};

function getShippingStatusClass(status) {
    switch ((status || '').toString().toLowerCase()) {
        case 'delivered':
            return 'text-success fw-semibold';
        case 'shipped':
        case 'in_transit':
        case 'out_for_delivery':
            return 'text-info';
        case 'ready_to_ship':
        case 'ready_to_print':
        case 'ready_to_pack':
        case 'packed':
        case 'printed':
            return 'text-warning';
        case 'pending':
            return 'text-secondary';
        case 'not_delivered':
        case 'cancelled':
        case 'canceled':
            return 'text-danger';
        default:
            return 'text-muted';
    }
}

function getLogisticBadgeClass(logisticType) {
    const normalized = (logisticType || '').toString().toLowerCase();
    switch (normalized) {
        case 'fulfillment':
        case 'full':
            return 'badge bg-primary';
        case 'cross_docking':
            return 'badge bg-info';
        case 'me2':
            return 'badge bg-warning';
        case 'me1':
            return 'badge bg-secondary';
        case 'xd_drop_off':
        case 'drop_off':
        case 'ponto de coleta':
            return 'badge bg-secondary';
        case 'self_service':
            return 'badge bg-secondary';
        default:
            return 'badge bg-secondary';
    }
}

function renderOrderActions(order) {
    const orderId = order.ml_order_id || order.order_id || '';
    const permalink = order.permalink || '';
    const segments = [
        `<button class="btn btn-outline-primary" onclick="viewOrderDetails('${orderId}')" title="Ver detalhes">
            <i class="bi bi-eye"></i>
        </button>`,
        `<button class="btn btn-outline-secondary" onclick="copyOrderId('${orderId}')" title="Copiar ID do pedido">
            <i class="bi bi-clipboard"></i>
        </button>`
    ];

    const invoiceDropdown = renderInvoiceDropdown(order);
    if (invoiceDropdown) {
        segments.push(invoiceDropdown);
    }

    const labelDropdown = renderLabelDropdown(order);
    if (labelDropdown) {
        segments.push(labelDropdown);
    }

    const cacheKey = order.id || orderId;
    segments.push(`
        <button class="btn btn-outline-dark" onclick="openOrderJson('${cacheKey || orderId}')" title="Ver JSON do pedido">
            <i class="bi bi-code-slash"></i>
        </button>
    `);

    if (permalink) {
        segments.push(`
            <a href="${permalink}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-info" title="Ver no Mercado Livre">
                <i class="bi bi-box-arrow-up-right"></i>
            </a>
        `);
    }

    segments.push(`
        <a href="/ml/orders/${orderId}" class="btn btn-outline-secondary" title="Abrir no painel">
            <i class="bi bi-window-sidebar"></i>
        </a>
    `);

    return `<div class="btn-group btn-group-sm flex-wrap" role="group">${segments.join('')}</div>`;
}

function viewOrderDetails(orderId) {
    if (!orderId) return;
    window.location.href = `/ml/orders/${orderId}`;
}

function copyOrderId(orderId) {
    if (!orderId) return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(orderId).then(() => console.log(`ID do pedido ${orderId} copiado.`)).catch(err => {
            console.warn('Falha ao copiar ID:', err);
            alert(`ID do pedido: ${orderId}`);
        });
        } else {
        alert(`ID do pedido: ${orderId}`);
    }
}

</script>

{% endblock %}
