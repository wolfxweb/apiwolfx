{% extends "base.html" %}

{% block title %}Contas a Receber - GIVM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-arrow-down-circle"></i> Contas a Receber</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-primary" onclick="showCreateReceivableModal()">
                <i class="bi bi-plus-circle"></i> Nova Conta
            </button>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <!-- Busca -->
            <div class="col-md-5">
                <label for="searchInput" class="form-label">Buscar</label>
                <input type="text" class="form-control" id="searchInput" placeholder="Cliente, descrição, NF..." onkeyup="filterReceivables()">
            </div>
            
            <!-- Tipo -->
            <div class="col-md-2">
                <label for="typeFilter" class="form-label">Tipo</label>
                <select class="form-select" id="typeFilter" onchange="filterReceivables()">
                    <option value="">Todos</option>
                    <option value="normal">Lançamento Manual</option>
                    <option value="ml_order">Mercado Livre</option>
                </select>
            </div>
            
            <!-- Status -->
            <div class="col-md-2">
                <label for="statusFilter" class="form-label">Status</label>
                <select class="form-select" id="statusFilter" onchange="filterReceivables()">
                    <option value="">Todos</option>
                    <option value="pending">Pendente</option>
                    <option value="paid">Pago</option>
                    <option value="received">Recebido</option>
                    <option value="overdue">Vencido</option>
                </select>
            </div>
            
            <!-- Período -->
            <div class="col-md-2">
                <label for="periodFilter" class="form-label">Período</label>
                <select class="form-select" id="periodFilter" onchange="toggleCustomPeriod(); filterReceivables();">
                    <option value="">Todos os períodos</option>
                    <option value="today">Hoje</option>
                    <option value="this_week">Esta semana</option>
                    <option value="this_month">Este mês</option>
                    <option value="last_month">Mês anterior</option>
                    <option value="next_month">Próximo mês</option>
                    <option value="next_30_days">Próximos 30 dias</option>
                    <option value="next_60_days">Próximos 60 dias</option>
                    <option value="next_90_days">Próximos 90 dias</option>
                    <option value="this_year">Este ano</option>
                    <option value="custom">Período personalizado</option>
                </select>
            </div>
            
            <!-- Ações -->
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()" style="white-space: nowrap;">
                        <i class="bi bi-x-circle"></i> Limpar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Período personalizado (oculto por padrão) -->
        <div class="row g-3 mt-2" id="customPeriodRow" style="display: none;">
            <div class="col-md-3">
                <label for="dueDateFrom" class="form-label">Data inicial</label>
                <input type="date" class="form-control" id="dueDateFrom" onchange="filterReceivables()">
            </div>
            <div class="col-md-3">
                <label for="dueDateTo" class="form-label">Data final</label>
                <input type="date" class="form-control" id="dueDateTo" onchange="filterReceivables()">
            </div>
        </div>
    </div>
</div>

<!-- Estatísticas Rápidas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Total a Receber 
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Valor líquido (já descontado comissão e frete do ML)"></i>
                        </h6>
                        <h4 class="mb-0" id="totalAmount">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-arrow-down-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Recebido 
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Valor líquido já recebido (descontado comissão e frete)"></i>
                        </h6>
                        <h4 class="mb-0" id="paidAmount">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger stats-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Vencido 
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Valor líquido vencido (descontado comissão e frete)"></i>
                        </h6>
                        <h4 class="mb-0" id="overdueAmount">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white stats-card" style="background-color: #FF8C00;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Pendente 
                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Valor líquido pendente (descontado comissão e frete)"></i>
                        </h6>
                        <h4 class="mb-0" id="pendingAmount">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Tabela de Contas a Receber -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="receivablesTable">
                <thead class="table-dark">
                    <tr>
                        <th>Cliente</th>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="receivablesTableBody">
                    <!-- Dados carregados via JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Footer com paginação e contadores -->
    <div class="card-footer bg-light">
        <div class="row align-items-center">
            <div class="col-md-6">
                <small class="text-muted">
                    Mostrando <span id="showing-start">1</span> a <span id="showing-end">10</span> 
                    de <span id="showing-total">0</span> conta(s) a receber
                </small>
            </div>
            <div class="col-md-6">
                <nav aria-label="Paginação de contas a receber">
                    <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination">
                        <!-- Paginação gerada via JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Criar/Editar Conta a Receber -->
<div class="modal fade" id="receivableModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="receivableModalTitle">Nova Conta a Receber</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="receivableForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customerName" class="form-label">Cliente *</label>
                                <input type="text" class="form-control" id="customerName" required placeholder="Nome do cliente">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="invoiceNumber" class="form-label">Número da Nota</label>
                                <input type="text" class="form-control" id="invoiceNumber" placeholder="Ex: NF-001">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="description" class="form-label">Descrição *</label>
                                <textarea class="form-control" id="description" rows="3" required placeholder="Descrição da conta a receber"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Valor *</label>
                                <input type="number" class="form-control" id="amount" step="0.01" required placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dueDate" class="form-label">Data de Vencimento *</label>
                                <input type="date" class="form-control" id="dueDate" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="categoryId" class="form-label">Categoria</label>
                                <select class="form-select" id="categoryId">
                                    <option value="">Selecione a categoria</option>
                                    <!-- Categorias carregadas via JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="costCenterId" class="form-label">Centro de Custo</label>
                                <select class="form-select" id="costCenterId">
                                    <option value="">Selecione o centro de custo</option>
                                    <!-- Centros de custo carregados via JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="accountId" class="form-label">Conta Bancária</label>
                                <select class="form-select" id="accountId">
                                    <option value="">Selecione a conta</option>
                                    <!-- Contas bancárias carregadas via JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isRecurring">
                                    <label class="form-check-label" for="isRecurring">
                                        Conta recorrente
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3" id="recurringFields" style="display: none;">
                                <label for="recurringFrequency" class="form-label">Frequência</label>
                                <select class="form-select" id="recurringFrequency">
                                    <option value="monthly">Mensal</option>
                                    <option value="quarterly">Trimestral</option>
                                    <option value="yearly">Anual</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Observações</label>
                                <textarea class="form-control" id="notes" rows="2" placeholder="Observações adicionais"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveReceivable()">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Confirmar Exclusão -->
<div class="modal fade" id="deleteReceivableModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta conta a receber?</p>
                <p class="text-danger"><small>Esta ação não pode ser desfeita e pode afetar parcelas associadas.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteReceivable()">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Reverter para Pendente -->
<div class="modal fade" id="revertToPendingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Reversão</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Deseja marcar esta conta como pendente?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Esta ação irá reverter o status da conta de "Recebido" para "Pendente".
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="confirmRevertToPending()">Sim, Reverter</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let receivables = [];
let filteredReceivables = [];
// Removido array of customers - agora usando campo de texto livre
let categories = [];
let currentRevertId = null;
let costCenters = [];
let accounts = [];
let currentEditId = null;
let currentDeleteId = null;
let currentPaidId = null;
let currentPage = 1;
let itemsPerPage = 10;

// Carregar dados ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    loadReceivables();
    // Removido loadCustomers() - agora usando campo de texto livre
    loadCategories();
    loadCostCenters();
    loadAccounts();
    
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Configurar filtro automático do mês atual
    document.getElementById('periodFilter').value = 'this_month';
});

// Função para carregar contas a receber
async function loadReceivables() {
    try {
        const response = await fetch('/api/financial/receivables', {
            credentials: 'include'
        });
        if (response.ok) {
            receivables = await response.json();
            // Aplicar filtro automático do mês atual
            filterReceivables();
            updateStats();
        } else {
            showAlert('Erro ao carregar contas a receber', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao carregar contas a receber', 'danger');
    }
}

// Função para carregar clientes
// Função removida - agora usando campo de texto livre para cliente

// Função para carregar categorias
async function loadCategories() {
    try {
        const response = await fetch('/api/financial/categories', {
            credentials: 'include'
        });
        if (response.ok) {
            categories = await response.json();
            updateCategorySelects();
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

// Função para carregar centros de custo
async function loadCostCenters() {
    try {
        const response = await fetch('/api/financial/cost-centers', {
            credentials: 'include'
        });
        if (response.ok) {
            costCenters = await response.json();
            updateCostCenterSelects();
        }
    } catch (error) {
        console.error('Erro ao carregar centros de custo:', error);
    }
}

// Função para carregar contas bancárias
async function loadAccounts() {
    try {
        const response = await fetch('/api/financial/accounts', {
            credentials: 'include'
        });
        if (response.ok) {
            accounts = await response.json();
            updateAccountSelects();
        }
    } catch (error) {
        console.error('Erro ao carregar contas bancárias:', error);
    }
}

// Função para renderizar contas a receber na tabela
function renderReceivables() {
    const tbody = document.getElementById('receivablesTableBody');
    
    if (filteredReceivables.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <i class="bi bi-arrow-down-circle display-1 text-muted"></i>
                    <h4 class="mt-3">Nenhuma conta a receber encontrada</h4>
                    <p class="text-muted">
                        Nenhuma conta a receber foi encontrada com os filtros aplicados.
                        <br>
                        <button class="btn btn-primary mt-2" onclick="showCreateReceivableModal()">
                            <i class="bi bi-plus-circle"></i> Nova Conta a Receber
                        </button>
                    </p>
                </td>
            </tr>
        `;
        updatePaginationCounters(0);
        return;
    }
    
    // Calcular página atual
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const receivablesToShow = filteredReceivables.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    receivablesToShow.forEach(receivable => {
        const row = document.createElement('tr');
        
        // Determinar se é pedido ML
        const isMLOrder = receivable.type === 'ml_order';
        
        // Criar conteúdo da coluna de valor
        let valueContent = '';
        if (isMLOrder) {
            // Para pedidos ML, mostrar detalhes do valor
            const totalAmount = receivable.total_amount || 0;
            const totalFees = receivable.total_fees || 0;
            const netAmount = receivable.amount || 0;
            const feePercentage = totalAmount > 0 ? ((totalFees / totalAmount) * 100).toFixed(1) : '0.0';
            
            valueContent = `
                <div class="d-flex flex-column">
                    <span class="fw-bold text-success">R$ ${parseFloat(netAmount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    <small class="text-muted">
                        Total: R$ ${parseFloat(totalAmount).toLocaleString('pt-BR', {minimumFractionDigits: 2})} | 
                        Comissão: R$ ${parseFloat(totalFees).toLocaleString('pt-BR', {minimumFractionDigits: 2})} (${feePercentage}%)
                    </small>
                </div>
            `;
        } else {
            // Para contas normais, mostrar valor simples
            valueContent = `<span class="fw-bold">R$ ${parseFloat(receivable.amount).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>`;
        }
        
        // Criar conteúdo da coluna de ações
        let actionsContent = '';
        if (isMLOrder) {
            // Para pedidos ML, mostrar link para detalhes do pedido
            const mlOrderId = receivable.ml_order_id;
            actionsContent = `
                <div class="d-flex justify-content-center">
                    <a href="/ml/orders/${mlOrderId}" target="_blank" class="badge text-decoration-none" style="background-color: #FFD700; color: #000000;" title="Ver detalhes do pedido no Mercado Livre">
                        <i class="bi bi-cart-check"></i> ML
                    </a>
                </div>
            `;
        } else {
            // Para contas normais, mostrar botões de ação
            actionsContent = `
                <div class="btn-group btn-group-sm">
                    <button type="button" 
                            class="btn btn-sm ${(receivable.status === 'paid' || receivable.status === 'received') ? 'btn-warning' : 'btn-outline-success'}" 
                            onclick="togglePaymentStatus('${receivable.id}')"
                            title="${(receivable.status === 'paid' || receivable.status === 'received') ? 'Marcar como pendente' : 'Marcar como recebido'}"
                            data-status="${receivable.status}">
                        <i class="fas ${(receivable.status === 'paid' || receivable.status === 'received') ? 'fa-undo' : 'fa-check'}"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="editReceivable('${receivable.id}')" title="Editar"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-outline-danger" onclick="deleteReceivable('${receivable.id}')" title="Excluir"><i class="bi bi-trash"></i></button>
                </div>
            `;
        }
        
        row.innerHTML = `
            <td>${receivable.customer_name || receivable.description || '-'}</td>
            <td>
                <div class="d-flex flex-column">
                    <span class="fw-bold">${receivable.description}</span>
                    ${receivable.invoice_number ? `<small class="text-muted">NF: ${receivable.invoice_number}</small>` : ''}
                    ${isMLOrder && receivable.notes ? `<small class="text-info">${receivable.notes}</small>` : ''}
                </div>
            </td>
            <td>${valueContent}</td>
            <td>
                <span class="${getDateClass(receivable.due_date, receivable.status)}">${formatDate(receivable.due_date)}</span>
            </td>
            <td><span class="badge ${getStatusBadgeClass(receivable.status)}">${getStatusLabel(receivable.status)}</span></td>
            <td>${actionsContent}</td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar contadores e paginação
    updatePaginationCounters(filteredReceivables.length);
    renderPagination(filteredReceivables.length);
}

// Função para atualizar estatísticas
function updateStats() {
    // Usar dados filtrados em vez de todos os dados
    const dataToUse = filteredReceivables.length > 0 ? filteredReceivables : receivables;
    
    // Total a receber: excluir pedidos ML já recebidos e contas normais já pagas
    const totalAmount = dataToUse.filter(r => {
        // Excluir pedidos ML com status "received"
        if (r.type === 'ml_order' && r.status === 'received') {
            return false;
        }
        // Excluir contas normais já pagas
        if (r.type === 'normal' && (r.status === 'paid' || r.status === 'received')) {
            return false;
        }
        return true;
    }).reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
    
    // Para pedidos ML com status "received", usar o amount. Para contas normais, usar paid_amount
    const receivedAmount = dataToUse.filter(r => r.status === 'paid' || r.status === 'received').reduce((sum, r) => {
        if (r.type === 'ml_order' && r.status === 'received') {
            return sum + (parseFloat(r.amount) || 0);
        } else {
            return sum + (parseFloat(r.paid_amount) || 0);
        }
    }, 0);
    
    const overdueAmount = dataToUse.filter(r => r.status === 'overdue').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
    const pendingAmount = dataToUse.filter(r => r.status === 'pending').reduce((sum, r) => sum + (parseFloat(r.amount) || 0), 0);
    
    document.getElementById('totalAmount').textContent = 'R$ ' + totalAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('paidAmount').textContent = 'R$ ' + receivedAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('overdueAmount').textContent = 'R$ ' + overdueAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('pendingAmount').textContent = 'R$ ' + pendingAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2});
}

// Função para filtrar contas a receber
function filterReceivables() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const periodFilter = document.getElementById('periodFilter').value;
    const dueDateFrom = document.getElementById('dueDateFrom').value;
    const dueDateTo = document.getElementById('dueDateTo').value;
    
    filteredReceivables = receivables.filter(receivable => {
        // Filtro de busca
        const matchesSearch = !searchTerm || 
            receivable.description.toLowerCase().includes(searchTerm) ||
            (receivable.customer_name && receivable.customer_name.toLowerCase().includes(searchTerm)) ||
            (receivable.invoice_number && receivable.invoice_number.toLowerCase().includes(searchTerm));
        
        // Filtro de tipo
        const matchesType = !typeFilter || receivable.type === typeFilter;
        
        // Filtro de status
        const matchesStatus = !statusFilter || receivable.status === statusFilter;
        
        // Filtro de período
        let matchesPeriod = true;
        if (periodFilter && receivable.due_date) {
            const dueDate = new Date(receivable.due_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            switch (periodFilter) {
                case 'today':
                    matchesPeriod = dueDate.toDateString() === today.toDateString();
                    break;
                case 'this_week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    matchesPeriod = dueDate >= startOfWeek && dueDate <= endOfWeek;
                    break;
                case 'this_month':
                    matchesPeriod = dueDate.getMonth() === today.getMonth() && dueDate.getFullYear() === today.getFullYear();
                    break;
                case 'last_month':
                    const lastMonth = new Date(today);
                    lastMonth.setMonth(today.getMonth() - 1);
                    matchesPeriod = dueDate.getMonth() === lastMonth.getMonth() && dueDate.getFullYear() === lastMonth.getFullYear();
                    break;
                case 'next_month':
                    const nextMonth = new Date(today);
                    nextMonth.setMonth(today.getMonth() + 1);
                    matchesPeriod = dueDate.getMonth() === nextMonth.getMonth() && dueDate.getFullYear() === nextMonth.getFullYear();
                    break;
                case 'next_30_days':
                    const next30Days = new Date(today);
                    next30Days.setDate(today.getDate() + 30);
                    matchesPeriod = dueDate >= today && dueDate <= next30Days;
                    break;
                case 'next_60_days':
                    const next60Days = new Date(today);
                    next60Days.setDate(today.getDate() + 60);
                    matchesPeriod = dueDate >= today && dueDate <= next60Days;
                    break;
                case 'next_90_days':
                    const next90Days = new Date(today);
                    next90Days.setDate(today.getDate() + 90);
                    matchesPeriod = dueDate >= today && dueDate <= next90Days;
                    break;
                case 'this_year':
                    matchesPeriod = dueDate.getFullYear() === today.getFullYear();
                    break;
                case 'custom':
                    matchesPeriod = (!dueDateFrom || receivable.due_date >= dueDateFrom) && 
                                   (!dueDateTo || receivable.due_date <= dueDateTo);
                    break;
            }
        }
        
        return matchesSearch && matchesType && matchesStatus && matchesPeriod;
    });
    
    // Reset para primeira página
    currentPage = 1;
    
    // Atualizar estatísticas com dados filtrados
    updateStats();
    
    // Renderizar contas filtradas
    renderReceivables();
}

// Função para limpar filtros
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('periodFilter').value = '';
    document.getElementById('dueDateFrom').value = '';
    document.getElementById('dueDateTo').value = '';
    
    // Ocultar período personalizado
    document.getElementById('customPeriodRow').style.display = 'none';
    
    filterReceivables();
}

// Função para aplicar filtros
function applyFilters() {
    filterReceivables();
}

// Função para mostrar/ocultar período personalizado
function toggleCustomPeriod() {
    const periodFilter = document.getElementById('periodFilter').value;
    const customPeriodRow = document.getElementById('customPeriodRow');
    
    if (periodFilter === 'custom') {
        customPeriodRow.style.display = 'block';
    } else {
        customPeriodRow.style.display = 'none';
    }
}

// Função para mostrar modal de criação
function showCreateReceivableModal() {
    currentEditId = null;
    document.getElementById('receivableModalTitle').textContent = 'Nova Conta a Receber';
    document.getElementById('receivableForm').reset();
    document.getElementById('dueDate').value = new Date().toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('receivableModal'));
    modal.show();
}

// Função para editar conta a receber
function editReceivable(id) {
    // Verificar se é pedido ML (não permitir edição)
    if (id.startsWith('ml_')) {
        showAlert('Pedidos do Mercado Livre não podem ser editados', 'warning');
        return;
    }
    
    const receivable = receivables.find(r => r.id === id);
    if (!receivable) return;
    
    // Extrair ID real para contas normais
    currentEditId = id.replace('normal_', '');
    document.getElementById('receivableModalTitle').textContent = 'Editar Conta a Receber';
    
    // Preencher formulário
    document.getElementById('customerName').value = receivable.customer_name || '';
    document.getElementById('invoiceNumber').value = receivable.invoice_number || '';
    document.getElementById('description').value = receivable.description || '';
    document.getElementById('amount').value = receivable.amount || '';
    document.getElementById('dueDate').value = receivable.due_date || '';
    document.getElementById('categoryId').value = receivable.category_id || '';
    document.getElementById('costCenterId').value = receivable.cost_center_id || '';
    document.getElementById('accountId').value = receivable.account_id || '';
    document.getElementById('isRecurring').checked = receivable.is_recurring || false;
    document.getElementById('recurringFrequency').value = receivable.recurring_frequency || 'monthly';
    document.getElementById('notes').value = receivable.notes || '';
    
    // Mostrar campos de recorrência se necessário
    toggleRecurringFields();
    
    const modal = new bootstrap.Modal(document.getElementById('receivableModal'));
    modal.show();
}

// Função para salvar conta a receber
async function saveReceivable() {
    const formData = {
        customer_name: document.getElementById('customerName').value,
        invoice_number: document.getElementById('invoiceNumber').value || null,
        description: document.getElementById('description').value,
        amount: document.getElementById('amount').value,
        due_date: document.getElementById('dueDate').value,
        category_id: document.getElementById('categoryId').value || null,
        cost_center_id: document.getElementById('costCenterId').value || null,
        account_id: document.getElementById('accountId').value || null,
        is_recurring: document.getElementById('isRecurring').checked,
        recurring_frequency: document.getElementById('recurringFrequency').value || null,
        notes: document.getElementById('notes').value || null
    };
    
    try {
        const url = currentEditId ? `/api/financial/receivables/${currentEditId}` : '/api/financial/receivables';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showAlert('Conta a receber salva com sucesso!', 'success');
            loadReceivables();
            bootstrap.Modal.getInstance(document.getElementById('receivableModal')).hide();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao salvar conta a receber', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao salvar conta a receber', 'danger');
    }
}

// Função para excluir conta a receber
function deleteReceivable(id) {
    // Verificar se é pedido ML (não permitir exclusão)
    if (id.startsWith('ml_')) {
        showAlert('Pedidos do Mercado Livre não podem ser excluídos', 'warning');
        return;
    }
    
    currentDeleteId = id.replace('normal_', '');
    const modal = new bootstrap.Modal(document.getElementById('deleteReceivableModal'));
    modal.show();
}

// Função para confirmar exclusão
async function confirmDeleteReceivable() {
    // Desabilitar botão para evitar duplo clique
    const deleteBtn = document.querySelector('#deleteReceivableModal .btn-danger');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...';
    
    try {
        const response = await fetch(`/api/financial/receivables/${currentDeleteId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (response.ok) {
            showAlert('Conta a receber excluída com sucesso!', 'success');
            loadReceivables();
            bootstrap.Modal.getInstance(document.getElementById('deleteReceivableModal')).hide();
        } else {
            const error = await response.json();
            showAlert(error.detail || 'Erro ao excluir conta a receber', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        showAlert('Erro ao excluir conta a receber', 'danger');
    } finally {
        // Reabilitar botão
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
    }
}

// Função para marcar como pago
function togglePaymentStatus(id) {
    // Verificar se é pedido ML (não permitir alteração)
    if (id.startsWith('ml_')) {
        showAlert('Pedidos do Mercado Livre não podem ser alterados manualmente', 'warning');
        return;
    }
    
    const receivable = receivables.find(r => r.id === id);
    
    if (receivable) {
        if (receivable.status === 'paid' || receivable.status === 'received') {
            // Se está recebido, mostrar modal para confirmar reversão
            currentRevertId = id;
            const modal = new bootstrap.Modal(document.getElementById('revertToPendingModal'));
            modal.show();
        } else {
            // Se está pendente, marcar diretamente como recebido
            markAsReceived(id);
        }
    } else {
        alert('Erro: Conta não encontrada!');
    }
}

function markAsReceived(id) {
    // Extrair ID real para contas normais
    const realId = id.replace('normal_', '');
    
    fetch(`/api/financial/receivables/${realId}/mark-received`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({
            received_date: new Date().toISOString().split('T')[0]
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showAlert(data.message, 'success');
            loadReceivables();
        } else {
            showAlert('Erro ao marcar como recebido', 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao marcar como recebido', 'danger');
    });
}

function markAsPending(id) {
    // Extrair ID real para contas normais
    const realId = id.replace('normal_', '');
    
    fetch(`/api/financial/receivables/${realId}/mark-pending`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            showAlert(data.message, 'success');
            loadReceivables();
        } else {
            showAlert('Erro ao marcar como pendente', 'danger');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('Erro ao marcar como pendente', 'danger');
    });
}

function confirmRevertToPending() {
    if (currentRevertId) {
        markAsPending(currentRevertId);
        bootstrap.Modal.getInstance(document.getElementById('revertToPendingModal')).hide();
        currentRevertId = null;
    }
}


// Funções auxiliares
function getStatusBadgeClass(status) {
    switch(status) {
        case 'pending': return 'bg-warning';
        case 'paid': return 'bg-success';
        case 'received': return 'bg-success';
        case 'overdue': return 'bg-danger';
        case 'cancelled': return 'bg-secondary';
        default: return 'bg-secondary';
    }
}

function getStatusLabel(status) {
    switch(status) {
        case 'pending': return 'Pendente';
        case 'paid': return 'Recebido';
        case 'received': return 'Recebido';
        case 'overdue': return 'Vencido';
        case 'cancelled': return 'Cancelado';
        default: return status;
    }
}

function getDateClass(dueDate, status) {
    const today = new Date();
    const due = new Date(dueDate);
    
    if (status === 'paid' || status === 'received') return 'text-success';
    if (status === 'overdue' || (due < today && status === 'pending')) return 'text-danger fw-bold';
    return 'text-dark';
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

// Função removida - agora usando campo de texto livre para cliente

function updateCategorySelects() {
    const select = document.getElementById('categoryId');
    if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione a categoria</option>';
        categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = `${category.code} - ${category.name}`;
            select.appendChild(option);
        });
        select.value = currentValue;
    }
}

function updateCostCenterSelects() {
    const select = document.getElementById('costCenterId');
    if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione o centro de custo</option>';
        costCenters.forEach(costCenter => {
            const option = document.createElement('option');
            option.value = costCenter.id;
            option.textContent = `${costCenter.code} - ${costCenter.name}`;
            select.appendChild(option);
        });
        select.value = currentValue;
    }
}

function updateAccountSelects() {
    const select = document.getElementById('accountId');
    if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Selecione a conta</option>';
        accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.bank_name} - ${account.account_name}`;
            select.appendChild(option);
        });
        select.value = currentValue;
    }
}

function toggleRecurringFields() {
    const isRecurring = document.getElementById('isRecurring');
    const recurringFields = document.getElementById('recurringFields');
    if (isRecurring.checked) {
        recurringFields.style.display = 'block';
    } else {
        recurringFields.style.display = 'none';
    }
}

// Event listener para checkbox de recorrência
document.addEventListener('DOMContentLoaded', function() {
    const isRecurring = document.getElementById('isRecurring');
    if (isRecurring) {
        isRecurring.addEventListener('change', toggleRecurringFields);
    }
});

// Funções de paginação
function updatePaginationCounters(total) {
    const start = total === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
    const end = Math.min(currentPage * itemsPerPage, total);
    
    document.getElementById('showing-start').textContent = start;
    document.getElementById('showing-end').textContent = end;
    document.getElementById('showing-total').textContent = total;
}

function renderPagination(total) {
    const pagination = document.getElementById('pagination');
    const totalPages = Math.ceil(total / itemsPerPage);
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Botão anterior
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Anterior</a>
        </li>
    `;
    
    // Páginas
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
    }
    
    // Botão próximo
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Próximo</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    const totalPages = Math.ceil(filteredReceivables.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderReceivables();
    }
}

function showAlert(message, type) {
    // Criar alerta Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Tentar encontrar container adequado
    let container = document.querySelector('.container-fluid');
    if (!container) {
        container = document.querySelector('.container');
    }
    if (!container) {
        container = document.querySelector('main');
    }
    if (!container) {
        container = document.body;
    }
    
    // Inserir no topo do container encontrado
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
    }
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

</script>
{% endblock %}
