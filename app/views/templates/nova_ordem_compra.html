{% extends "base.html" %}

{% block title %}Nova Ordem de Compra{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- CabeÃ§alho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-file-earmark-text text-primary"></i>
                        Nova Ordem de Compra
                    </h1>
                    <p class="text-muted mb-0">Preencha os dados para criar uma nova ordem de compra</p>
                </div>
                <a href="/ordem-compra" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>

            <!-- FormulÃ¡rio -->
            <form id="ordemForm">
                <div class="row">
                    <!-- Dados BÃ¡sicos -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-info-circle text-primary"></i>
                                    Dados BÃ¡sicos
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="numeroOrdem" class="form-label">NÃºmero da Ordem</label>
                                            <input type="text" class="form-control" id="numeroOrdem" placeholder="Auto-gerado se vazio">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="dataOrdem" class="form-label">Data da Ordem *</label>
                                            <input type="date" class="form-control" id="dataOrdem" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="dataEntregaPrevista" class="form-label">Data Entrega Prevista</label>
                                            <input type="date" class="form-control" id="dataEntregaPrevista">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="status" class="form-label">Status</label>
                                            <select class="form-select" id="status">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_cotacao">Em CotaÃ§Ã£o</option>
                                                <option value="aprovada">Aprovada</option>
                                                <option value="rejeitada">Rejeitada</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="entregue">Entregue</option>
                                                <option value="cancelada">Cancelada</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fornecedor -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-truck text-primary"></i>
                                    Fornecedor
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="fornecedorSearch" class="form-label">Fornecedor</label>
                                            <div class="position-relative">
                                                <input type="text" class="form-control" id="fornecedorSearch" placeholder="Digite para buscar fornecedor..." autocomplete="off">
                                                <input type="hidden" id="fornecedorId" value="">
                                                <div id="fornecedorDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                                    <!-- Resultados da busca aparecerÃ£o aqui -->
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">Digite para buscar fornecedores cadastrados</small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="condicoesPagamento" class="form-label">CondiÃ§Ãµes de Pagamento</label>
                                            <input type="text" class="form-control" id="condicoesPagamento" placeholder="Ex: 30 dias">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="prazoEntrega" class="form-label">Prazo de Entrega</label>
                                            <input type="text" class="form-control" id="prazoEntrega" placeholder="Ex: 15 dias Ãºteis">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Moeda -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-currency-exchange text-primary"></i>
                                    Moeda
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="moeda" class="form-label">Moeda</label>
                                            <select class="form-select" id="moeda" onchange="updateCotacaoField()">
                                                <option value="BRL">ðŸ‡§ðŸ‡· Real (BRL)</option>
                                                <option value="USD">ðŸ‡ºðŸ‡¸ DÃ³lar Americano (USD)</option>
                                                <option value="CNY">ðŸ‡¨ðŸ‡³ Yuan ChinÃªs (CNY)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cotacaoMoeda" class="form-label">CotaÃ§Ã£o da Moeda</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="cotacaoMoeda" step="0.0001" min="0" value="1.0000" onchange="updateValores()">
                                                <span class="input-group-text">BRL</span>
                                            </div>
                                            <small class="form-text text-muted">Taxa de cÃ¢mbio para 1 unidade da moeda selecionada em Reais</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Itens da Ordem -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-list-ul text-primary"></i>
                                    Itens da Ordem
                                </h5>
                                <div>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="openProductSelector()">
                                        <i class="bi bi-search"></i> Selecionar Produtos
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addItem()">
                                        <i class="bi bi-plus"></i> Adicionar Manual
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm" id="itensTable">
                                        <thead>
                                            <tr>
                                                <th width="80">Imagem</th>
                                                <th>Produto</th>
                                                <th>SKU</th>
                                                <th>Qtd</th>
                                                <th>Valor Unit. (<span class="moeda-sigla">R$</span>)</th>
                                                <th>Total</th>
                                                <th>URL</th>
                                                <th width="50"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Itens serÃ£o adicionados dinamicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ObservaÃ§Ãµes e Resumo -->
                    <div class="col-12">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-chat-text text-primary"></i>
                                            ObservaÃ§Ãµes
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="observacoes" class="form-label">ObservaÃ§Ãµes Gerais</label>
                                            <textarea class="form-control" id="observacoes" rows="4" placeholder="ObservaÃ§Ãµes gerais da ordem..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-calculator text-primary"></i>
                                            Resumo Financeiro
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <span>Subtotal:</span>
                                            <span id="subtotal">R$ 0,00</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Desconto:</span>
                                            <span id="desconto">R$ 0,00</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total:</span>
                                            <span id="total">R$ 0,00</span>
                                        </div>
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Total em Reais:</span>
                                            <span id="totalBRL">R$ 0,00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BotÃµes de AÃ§Ã£o -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <a href="/ordem-compra" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="button" class="btn btn-primary" onclick="saveOrdem()">
                                <i class="bi bi-check-circle"></i> Salvar Ordem
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal SeleÃ§Ã£o de Produtos -->
<div class="modal fade" id="productSelectorModal" tabindex="-1" aria-labelledby="productSelectorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productSelectorModalLabel">Selecionar Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros de busca -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="productSearch" placeholder="Buscar por nome ou SKU..." onkeyup="searchProducts()">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100" onclick="searchProducts()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de produtos -->
                <div class="row" id="productsList">
                    <!-- Produtos serÃ£o carregados aqui -->
                </div>
                
                <!-- PaginaÃ§Ã£o -->
                <nav aria-label="PaginaÃ§Ã£o de produtos">
                    <ul class="pagination justify-content-center" id="productsPagination">
                        <!-- PaginaÃ§Ã£o serÃ¡ carregada aqui -->
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedProducts()">
                    <i class="bi bi-plus"></i> Adicionar Selecionados
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let fornecedorSearchTimeout;

// InicializaÃ§Ã£o
document.addEventListener('DOMContentLoaded', function() {
    setTodayDate();
    updateCotacaoField();
});

function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dataOrdem').value = today;
}

// Autocomplete fornecedores
document.getElementById('fornecedorSearch').addEventListener('input', function() {
    const query = this.value.trim();
    const dropdown = document.getElementById('fornecedorDropdown');
    const fornecedorIdInput = document.getElementById('fornecedorId');
    
    if (fornecedorSearchTimeout) {
        clearTimeout(fornecedorSearchTimeout);
    }
    
    if (query === '') {
        fornecedorIdInput.value = '';
        dropdown.style.display = 'none';
        return;
    }
    
    fornecedorSearchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/fornecedores/search?q=${encodeURIComponent(query)}&limit=10`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                displayFornecedorResults(data.fornecedores);
            }
        } catch (error) {
            console.error('Erro ao buscar fornecedores:', error);
        }
    }, 300);
});

function displayFornecedorResults(fornecedores) {
    const dropdown = document.getElementById('fornecedorDropdown');
    dropdown.innerHTML = '';
    
    if (fornecedores.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item-text">Nenhum fornecedor encontrado</div>';
    } else {
        fornecedores.forEach(fornecedor => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="fw-bold">${fornecedor.nome}</div>
                <small class="text-muted">${fornecedor.cnpj || ''}</small>
            `;
            item.onclick = () => selectFornecedor(fornecedor);
            dropdown.appendChild(item);
        });
    }
    
    dropdown.style.display = 'block';
}

function selectFornecedor(fornecedor) {
    const fornecedorSearchInput = document.getElementById('fornecedorSearch');
    const fornecedorIdInput = document.getElementById('fornecedorId');
    const dropdown = document.getElementById('fornecedorDropdown');
    
    fornecedorSearchInput.value = fornecedor.display_name;
    fornecedorIdInput.value = fornecedor.id;
    dropdown.style.display = 'none';
}

// FunÃ§Ãµes de moeda
function updateCotacaoField() {
    const moeda = document.getElementById('moeda').value;
    const cotacaoInput = document.getElementById('cotacaoMoeda');
    const cotacaoLabel = document.querySelector('#cotacaoMoeda + .input-group-text');
    
    // Atualizar siglas das moedas em todos os lugares
    const moedaSymbol = getMoedaSymbol(moeda);
    document.querySelectorAll('.moeda-sigla').forEach(element => {
        element.textContent = moedaSymbol;
    });
    
    if (moeda === 'BRL') {
        cotacaoInput.value = '1.0000';
        cotacaoInput.disabled = true;
        cotacaoLabel.textContent = 'BRL';
    } else {
        cotacaoInput.disabled = false;
        cotacaoLabel.textContent = 'BRL';
        if (moeda === 'USD') {
            cotacaoInput.placeholder = 'Ex: 5.20';
        } else if (moeda === 'CNY') {
            cotacaoInput.placeholder = 'Ex: 0.72';
        }
    }
    
    updateValores();
}

function getMoedaSymbol(moeda) {
    const symbols = {
        'BRL': 'R$',
        'USD': 'US$',
        'CNY': 'Â¥'
    };
    return symbols[moeda] || 'R$';
}

function getMoedaName(moeda) {
    const names = {
        'BRL': 'Real',
        'USD': 'DÃ³lar',
        'CNY': 'Yuan'
    };
    return names[moeda] || 'Real';
}

// SeleÃ§Ã£o de produtos
let selectedProducts = [];
let allProducts = [];
let searchTimeout;

function openProductSelector() {
    const modal = new bootstrap.Modal(document.getElementById('productSelectorModal'));
    modal.show();
    loadProducts();
}

async function loadProducts() {
    try {
        const response = await fetch('/api/internal-products/list?limit=1000&offset=0&search=', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            allProducts = data.products || [];
            displayProducts(allProducts);
        } else {
            console.error('Erro ao carregar produtos:', response.status);
            displayProducts([]);
        }
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        displayProducts([]);
    }
}

function displayProducts(products) {
    const container = document.getElementById('productsList');
    container.innerHTML = '';
    
    if (products.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted">Nenhum produto encontrado</div>';
        return;
    }
    
    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'col-md-4 mb-3';
        productCard.innerHTML = `
            <div class="card h-100 product-card" data-product-id="${product.id}">
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input product-checkbox" type="checkbox" value="${product.id}" id="product_${product.id}">
                        <label class="form-check-label" for="product_${product.id}">
                            <strong>Selecionar</strong>
                        </label>
                    </div>
                    <div class="text-center mb-2">
                        <img src="${product.main_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik00MCA0MEM0Ni4wNzE0IDQwIDUxIDM1LjA3MTQgNTEgMjlDNTAgMjIuOTI4NiA0Ni4wNzE0IDE4IDQwIDE4QzMzLjkyODYgMTggMzAgMjIuOTI4NiAzMCAyOUMzMCAzNS4wNzE0IDMzLjkyODYgNDAgNDAgNDBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik00MCA0NkM0Ni4wNzE0IDQ2IDUxIDQxLjA3MTQgNTEgMzVDNTAgMjguOTI4NiA0Ni4wNzE0IDI0IDQwIDI0QzMzLjkyODYgMjQgMzAgMjguOTI4NiAzMCAzNUMzMCA0MS4wNzE0IDMzLjkyODYgNDYgNDAgNDZaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" 
                             class="img-thumbnail" 
                             style="width: 80px; height: 80px; object-fit: cover;"
                             alt="${product.name}">
                    </div>
                    <h6 class="card-title">${product.name}</h6>
                    <p class="card-text small text-muted">SKU: ${product.internal_sku || 'N/A'}</p>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Quantidade:</label>
                            <input type="number" class="form-control form-control-sm product-quantity" 
                                   step="0.001" min="0" value="1" data-product-id="${product.id}">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Valor Unit. (<span class="moeda-sigla">R$</span>):</label>
                            <input type="number" class="form-control form-control-sm product-price" 
                                   step="0.01" min="0" value="0" placeholder="0.00" data-product-id="${product.id}">
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(productCard);
    });
}

function searchProducts() {
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        
        let filteredProducts = allProducts.filter(product => {
            const matchesSearch = !searchTerm || 
                product.name.toLowerCase().includes(searchTerm) ||
                (product.internal_sku && product.internal_sku.toLowerCase().includes(searchTerm)) ||
                (product.description && product.description.toLowerCase().includes(searchTerm));
            
            return matchesSearch;
        });
        
        displayProducts(filteredProducts);
    }, 300);
}

function addSelectedProducts() {
    const checkboxes = document.querySelectorAll('.product-checkbox:checked');
    console.log('Checkboxes selecionados:', checkboxes.length);
    
    checkboxes.forEach(checkbox => {
        const productId = parseInt(checkbox.value);
        const product = allProducts.find(p => p.id === productId);
        const quantityInput = document.querySelector(`.product-quantity[data-product-id="${productId}"]`);
        const priceInput = document.querySelector(`.product-price[data-product-id="${productId}"]`);
        
        console.log('Produto encontrado:', product);
        console.log('Quantidade:', quantityInput?.value);
        console.log('PreÃ§o:', priceInput?.value);
        
        if (product && quantityInput && priceInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            
            console.log('Quantidade parseada:', quantity);
            console.log('PreÃ§o parseado:', price);
            
            if (quantity > 0) {
                console.log('Adicionando produto Ã  ordem:', product.name);
                addProductToOrder(product, quantity, price);
            } else {
                console.log('Quantidade deve ser maior que 0');
            }
        } else {
            console.log('Produto, quantidade ou preÃ§o nÃ£o encontrados');
        }
    });
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productSelectorModal'));
    modal.hide();
}

function addProductToOrder(product, quantity, price) {
    console.log('addProductToOrder chamada com:', { product: product.name, quantity, price });
    const tbody = document.querySelector('#itensTable tbody');
    console.log('Tbody encontrado:', tbody);
    const row = document.createElement('tr');
    const total = quantity * price;
    console.log('Total calculado:', total);
    
    row.innerHTML = `
        <td>
            <img src="${product.main_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" 
                 class="img-thumbnail" 
                 style="width: 40px; height: 40px; object-fit: cover;"
                 alt="${product.name}">
        </td>
        <td>
            <div class="fw-bold">${product.name}</div>
        </td>
        <td>${product.internal_sku || 'N/A'}</td>
        <td><input type="number" class="form-control form-control-sm quantidade" step="0.001" min="0" value="${quantity}" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-unitario" step="0.01" min="0" value="${price}" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-total" step="0.01" value="${total.toFixed(2)}" readonly></td>
        <td><input type="url" class="form-control form-control-sm" placeholder="URL do produto"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
    `;
    console.log('HTML da linha criado');
    tbody.appendChild(row);
    console.log('Linha adicionada ao tbody');
    updateResumo();
    console.log('Resumo atualizado');
}

// Itens da ordem (manual)
function addItem() {
    const tbody = document.querySelector('#itensTable tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo=" 
                 class="img-thumbnail" 
                 style="width: 40px; height: 40px; object-fit: cover;"
                 alt="Sem imagem">
        </td>
        <td><input type="text" class="form-control form-control-sm" placeholder="Nome do produto"></td>
        <td><input type="text" class="form-control form-control-sm" placeholder="SKU"></td>
        <td><input type="number" class="form-control form-control-sm quantidade" step="0.001" min="0" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-unitario" step="0.01" min="0" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-total" step="0.01" readonly></td>
        <td><input type="url" class="form-control form-control-sm" placeholder="URL do produto"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(row);
}

function removeItem(button) {
    button.closest('tr').remove();
    updateResumo();
}

function calculateItemTotal(input) {
    const row = input.closest('tr');
    const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
    const valorUnitario = parseFloat(row.querySelector('.valor-unitario').value) || 0;
    const valorTotal = quantidade * valorUnitario;
    
    row.querySelector('.valor-total').value = valorTotal.toFixed(2);
    updateResumo();
}

function updateResumo() {
    const rows = document.querySelectorAll('#itensTable tbody tr');
    let subtotal = 0;
    
    rows.forEach(row => {
        const valorTotal = parseFloat(row.querySelector('.valor-total').value) || 0;
        subtotal += valorTotal;
    });
    
    const desconto = 0; // Implementar campo de desconto se necessÃ¡rio
    const total = subtotal - desconto;
    
    // Obter moeda e cotaÃ§Ã£o
    const moeda = document.getElementById('moeda').value;
    const cotacao = parseFloat(document.getElementById('cotacaoMoeda').value) || 1;
    
    // Calcular total em reais
    const totalBRL = total * cotacao;
    
    // Atualizar exibiÃ§Ã£o - valores principais na moeda selecionada
    const moedaSymbol = getMoedaSymbol(moeda);
    document.getElementById('subtotal').textContent = `${moedaSymbol} ${subtotal.toFixed(2).replace('.', ',')}`;
    document.getElementById('desconto').textContent = `${moedaSymbol} ${desconto.toFixed(2).replace('.', ',')}`;
    document.getElementById('total').textContent = `${moedaSymbol} ${total.toFixed(2).replace('.', ',')}`;
    
    // Valor convertido em reais (sempre em fonte menor)
    document.getElementById('totalBRL').textContent = `R$ ${totalBRL.toFixed(2).replace('.', ',')}`;
}

function getItensData() {
    const rows = document.querySelectorAll('#itensTable tbody tr');
    const itens = [];
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const produtoNome = cells[1].querySelector('input') ? cells[1].querySelector('input').value : cells[1].textContent.trim();
        const produtoDescricao = cells[1].querySelector('small') ? cells[1].querySelector('small').textContent.trim() : '';
        const produtoCodigo = cells[2].textContent.trim();
        const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
        const valorUnitario = parseFloat(row.querySelector('.valor-unitario').value) || 0;
        const valorTotal = parseFloat(row.querySelector('.valor-total').value) || 0;
        const url = cells[6].querySelector('input') ? cells[6].querySelector('input').value : '';
        
        if (produtoNome && quantidade > 0) {
            itens.push({
                produto_nome: produtoNome,
                produto_descricao: produtoDescricao,
                produto_codigo: produtoCodigo,
                quantidade: quantidade,
                valor_unitario: valorUnitario,
                valor_total: valorTotal,
                url: url
            });
        }
    });
    
    return itens;
}

// Salvar ordem
async function saveOrdem() {
    const formData = {
        numero_ordem: document.getElementById('numeroOrdem').value,
        data_ordem: document.getElementById('dataOrdem').value,
        data_entrega_prevista: document.getElementById('dataEntregaPrevista').value,
        status: document.getElementById('status').value,
        fornecedor_id: document.getElementById('fornecedorId').value || null,
        condicoes_pagamento: document.getElementById('condicoesPagamento').value,
        prazo_entrega: document.getElementById('prazoEntrega').value,
        observacoes: document.getElementById('observacoes').value,
        moeda: document.getElementById('moeda').value,
        cotacao_moeda: parseFloat(document.getElementById('cotacaoMoeda').value) || 1,
        itens: getItensData()
    };
    
    try {
        const response = await fetch('/api/ordem-compra', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('Ordem de compra criada com sucesso!');
            window.location.href = '/ordem-compra';
        } else {
            const error = await response.json();
            alert('Erro: ' + (error.detail || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao salvar ordem de compra');
    }
}

// Fechar dropdown ao clicar fora
document.addEventListener('click', function(event) {
    const fornecedorContainer = document.querySelector('#fornecedorSearch').closest('.position-relative');
    if (!fornecedorContainer.contains(event.target)) {
        document.getElementById('fornecedorDropdown').style.display = 'none';
    }
});
</script>
{% endblock %}
