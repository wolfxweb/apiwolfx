{% extends "base.html" %}

{% block title %}{% if is_editing %}Editar Ordem de Compra{% else %}Nova Ordem de Compra{% endif %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Cabe√ßalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                <h1 class="h3 mb-0">
                    <i class="bi bi-file-earmark-text text-primary"></i>
                    {% if is_editing %}Editar Ordem de Compra{% else %}Nova Ordem de Compra{% endif %}
                </h1>
                    <p class="text-muted mb-0">{% if is_editing %}Edite os dados da ordem de compra{% else %}Preencha os dados para criar uma nova ordem de compra{% endif %}</p>
                </div>
                <a href="/ordem-compra" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>

            <!-- Formul√°rio -->
            <form id="ordemForm">
                <div class="row">
                    <!-- Dados B√°sicos -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-file-text text-primary"></i>
                                    Dados B√°sicos
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Informa√ß√µes da Ordem -->
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="numeroOrdem" class="form-label">N√∫mero da Ordem</label>
                                            <input type="text" class="form-control" id="numeroOrdem" placeholder="Auto-gerado se vazio" {% if is_editing %}readonly{% endif %}>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="dataOrdem" class="form-label">Data da Ordem *</label>
                                            <input type="date" class="form-control" id="dataOrdem" required>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="dataEntregaPrevista" class="form-label">Data Entrega Prevista</label>
                                            <input type="date" class="form-control" id="dataEntregaPrevista">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="status" class="form-label">Status</label>
                                            <select class="form-select" id="status">
                                                <option value="pendente">Pendente</option>
                                                <option value="em_cotacao">Em Cota√ß√£o</option>
                                                <option value="aprovada">Aprovada</option>
                                                <option value="rejeitada">Rejeitada</option>
                                                <option value="em_andamento">Em Andamento</option>
                                                <option value="entregue">Entregue</option>
                                                <option value="cancelada">Cancelada</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fornecedor -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="fornecedorSearch" class="form-label">Fornecedor</label>
                                            <div class="position-relative">
                                                <input type="text" class="form-control" id="fornecedorSearch" placeholder="Digite para buscar fornecedor..." autocomplete="off">
                                                <input type="hidden" id="fornecedorId" value="">
                                                <div id="fornecedorDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                                    <!-- Resultados da busca aparecer√£o aqui -->
                                                </div>
                                            </div>
                                            <small class="form-text text-muted">Digite para buscar fornecedores cadastrados</small>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="condicoesPagamento" class="form-label">Condi√ß√µes de Pagamento</label>
                                            <input type="text" class="form-control" id="condicoesPagamento" placeholder="Ex: 30 dias">
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="prazoEntrega" class="form-label">Prazo de Entrega</label>
                                            <input type="text" class="form-control" id="prazoEntrega" placeholder="Ex: 15 dias √∫teis">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Moeda e Tipo -->
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="tipoOrdem" class="form-label">Tipo de Ordem</label>
                                            <select class="form-select" id="tipoOrdem" onchange="toggleCamposInternacionais()">
                                                <option value="nacional">üè† Nacional</option>
                                                <option value="internacional">üåç Internacional</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="moeda" class="form-label">Moeda</label>
                                            <select class="form-select" id="moeda" onchange="updateCotacaoField()">
                                                <option value="BRL">üáßüá∑ Real (BRL)</option>
                                                <option value="USD">üá∫üá∏ D√≥lar Americano (USD)</option>
                                                <option value="CNY">üá®üá≥ Yuan Chin√™s (CNY)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cotacaoMoeda" class="form-label">Cota√ß√£o da Moeda</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="cotacaoMoeda" step="0.0001" min="0" value="1.0000" onchange="updateValores()">
                                                <span class="input-group-text">BRL</span>
                                            </div>
                                            <small class="form-text text-muted">Taxa de c√¢mbio para 1 unidade da moeda selecionada em Reais</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Campos Internacionais -->
                                <div id="camposInternacionais" style="display: none;">
                                    <hr class="my-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-globe"></i> Campos para Ordens Internacionais
                                    </h6>
                                    
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="comissaoAgente" class="form-label">Comiss√£o Agente de Compras</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="comissaoAgente" step="0.01" min="0" max="100" value="0.00">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                                <small class="form-text text-muted">Percentual do valor do pedido</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="valorTransporte" class="form-label">Valor do Transporte</label>
                                                <div class="input-group">
                                                    <span class="input-group-text moeda-sigla">R$</span>
                                                    <input type="number" class="form-control" id="valorTransporte" step="0.01" min="0" value="0.00">
                                                </div>
                                                <small class="form-text text-muted">Custo do transporte internacional</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="percentualImportacao" class="form-label">Percentual de Impostos de Importa√ß√£o</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="percentualImportacao" step="0.01" min="0" max="100" value="0.00">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                                <small class="form-text text-muted">Percentual de impostos sobre importa√ß√£o</small>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="taxasAdicionais" class="form-label">Taxas Adicionais</label>
                                                <div class="input-group">
                                                    <span class="input-group-text moeda-sigla">R$</span>
                                                    <input type="number" class="form-control" id="taxasAdicionais" step="0.01" min="0" value="0.00">
                                                </div>
                                                <small class="form-text text-muted">Taxas adicionais de importa√ß√£o</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="alert alert-info">
                                                <i class="bi bi-info-circle"></i>
                                                <strong>Informa√ß√£o:</strong> Os impostos de importa√ß√£o ser√£o calculados automaticamente com base no percentual informado e no valor total dos itens.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Itens da Ordem -->
                    <div class="col-12">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-list-ul text-primary"></i>
                                    Itens da Ordem
                                </h5>
                                <div>
                                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="openProductSelector()">
                                        <i class="bi bi-search"></i> Selecionar Produtos
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addItem()">
                                        <i class="bi bi-plus"></i> Adicionar Manual
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm" id="itensTable">
                        <thead>
                            <tr>
                                <th width="80">Imagem</th>
                                <th>Produto</th>
                                <th>Descri√ß√£o Item Fornecedor</th>
                                <th>Qtd</th>
                                <th>Valor Unit. (<span class="moeda-sigla">R$</span>)</th>
                                <th>Total</th>
                                <th>URL</th>
                                <th width="50"></th>
                            </tr>
                        </thead>
                                        <tbody>
                                            <!-- Itens ser√£o adicionados dinamicamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Observa√ß√µes e Resumo -->
                    <div class="col-12">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-chat-text text-primary"></i>
                                            Observa√ß√µes
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="observacoes" class="form-label">Observa√ß√µes Gerais</label>
                                            <textarea class="form-control" id="observacoes" rows="4" placeholder="Observa√ß√µes gerais da ordem..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-calculator text-primary"></i>
                                            Resumo Financeiro
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <span>Subtotal:</span>
                                            <span id="subtotal">R$ 0,00</span>
                                        </div>
                                        
                                        <!-- Campos Internacionais (condicionais) -->
                                        <div id="resumoInternacional" style="display: none;">
                                            <hr>
                                            <div class="d-flex justify-content-between">
                                                <span>Comiss√£o Agente:</span>
                                                <span id="comissaoValor">R$ 0,00</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Valor Transporte:</span>
                                                <span id="freteValor">R$ 0,00</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Impostos Importa√ß√£o:</span>
                                                <span id="impostosValor">R$ 0,00</span>
                                            </div>
                                            <div class="d-flex justify-content-between">
                                                <span>Taxas Adicionais:</span>
                                                <span id="taxasAdicionaisValor">R$ 0,00</span>
                                            </div>
                                        </div>
                                        
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total:</span>
                                            <span id="total">R$ 0,00</span>
                                        </div>
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Total em Reais:</span>
                                            <span id="totalBRL">R$ 0,00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√µes de A√ß√£o -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <a href="/ordem-compra" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="button" class="btn btn-primary" onclick="saveOrdem()">
                                <i class="bi bi-check-circle"></i> Salvar Ordem
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sele√ß√£o de Produtos -->
<div class="modal fade" id="productSelectorModal" tabindex="-1" aria-labelledby="productSelectorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productSelectorModalLabel">Selecionar Produtos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros de busca -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="productSearch" placeholder="Buscar por nome ou SKU..." onkeyup="searchProducts()">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary w-100" onclick="searchProducts()">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de produtos -->
                <div class="row" id="productsList">
                    <!-- Produtos ser√£o carregados aqui -->
                </div>
                
                <!-- Pagina√ß√£o -->
                <nav aria-label="Pagina√ß√£o de produtos">
                    <ul class="pagination justify-content-center" id="productsPagination">
                        <!-- Pagina√ß√£o ser√° carregada aqui -->
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedProducts()">
                    <i class="bi bi-plus"></i> Adicionar Selecionados
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let fornecedorSearchTimeout;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    setTodayDate();
    updateCotacaoField();
    
    // Se estiver editando, carregar dados
    {% if is_editing and ordem_data %}
    loadOrdemData({{ ordem_data | tojson }});
    {% endif %}
    
    // Adicionar listener para mudan√ßa de moeda
    document.getElementById('moeda').addEventListener('change', function() {
        updateCotacaoField();
        updateResumo();
    });
    
    // Adicionar listener para mudan√ßa de cota√ß√£o
    document.getElementById('cotacaoMoeda').addEventListener('input', function() {
        updateResumo();
    });
});

function setTodayDate() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dataOrdem').value = today;
}

// Carregar dados da ordem para edi√ß√£o
function loadOrdemData(ordemData) {
    console.log('Carregando dados da ordem:', ordemData);
    
    // Preencher campos b√°sicos
    document.getElementById('numeroOrdem').value = ordemData.numero_ordem || '';
    document.getElementById('dataOrdem').value = ordemData.data_ordem || '';
    document.getElementById('dataEntregaPrevista').value = ordemData.data_entrega_prevista || '';
    document.getElementById('status').value = ordemData.status || 'pendente';
    document.getElementById('moeda').value = ordemData.moeda || 'BRL';
    document.getElementById('cotacaoMoeda').value = ordemData.cotacao_moeda || 1;
    document.getElementById('condicoesPagamento').value = ordemData.condicoes_pagamento || '';
    document.getElementById('prazoEntrega').value = ordemData.prazo_entrega || '';
    document.getElementById('observacoes').value = ordemData.observacoes || '';
    
    // Preencher fornecedor
    if (ordemData.fornecedor_id) {
        document.getElementById('fornecedorSearch').value = ordemData.fornecedor_nome || '';
        document.getElementById('fornecedorId').value = ordemData.fornecedor_id;
    }
    
    // Atualizar cota√ß√£o e moeda
    updateCotacaoField();
    
    // Carregar itens
    console.log('Verificando itens:', ordemData.itens);
    if (ordemData.itens && ordemData.itens.length > 0) {
        console.log('Chamando loadItensData com', ordemData.itens.length, 'itens');
        loadItensData(ordemData.itens);
    } else {
        console.log('Nenhum item encontrado para carregar');
    }
    
    // Atualizar resumo
    updateResumo();
}

// Carregar itens da ordem
function loadItensData(itens) {
    console.log('loadItensData chamada com:', itens);
    const tbody = document.querySelector('#itensTable tbody');
    console.log('tbody encontrado:', tbody);
    tbody.innerHTML = ''; // Limpar itens existentes
    
    console.log('Processando', itens.length, 'itens');
    itens.forEach((item, index) => {
        console.log(`Processando item ${index}:`, item);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <img src="${item.produto_imagem || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" 
                     class="img-thumbnail" 
                     style="width: 40px; height: 40px; object-fit: cover;"
                     alt="${item.produto_nome}"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='">
            </td>
            <td>
                <div class="fw-bold">${item.produto_nome}</div>
                <small class="text-muted">SKU: ${item.produto_codigo || 'N/A'}</small>
            </td>
            <td><input type="text" class="form-control form-control-sm" placeholder="Descri√ß√£o do item fornecedor" value="${item.descricao_fornecedor || ''}"></td>
            <td><input type="number" class="form-control form-control-sm quantidade" step="0.001" min="0" value="${item.quantidade}" onchange="calculateItemTotal(this)"></td>
            <td><input type="number" class="form-control form-control-sm valor-unitario" step="0.01" min="0" value="${item.valor_unitario}" onchange="calculateItemTotal(this)"></td>
            <td><input type="text" class="form-control form-control-sm valor-total" value="${item.valor_total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" data-numeric-value="${item.valor_total}" readonly></td>
            <td><input type="url" class="form-control form-control-sm" placeholder="URL do produto" value="${item.url || ''}"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
        `;
        tbody.appendChild(row);
    });
    
    // Atualizar resumo ap√≥s carregar todos os itens
    updateResumo();
}

// Autocomplete fornecedores
document.getElementById('fornecedorSearch').addEventListener('input', function() {
    const query = this.value.trim();
    const dropdown = document.getElementById('fornecedorDropdown');
    const fornecedorIdInput = document.getElementById('fornecedorId');
    
    if (fornecedorSearchTimeout) {
        clearTimeout(fornecedorSearchTimeout);
    }
    
    if (query === '') {
        fornecedorIdInput.value = '';
        dropdown.style.display = 'none';
        return;
    }
    
    fornecedorSearchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/fornecedores/search?q=${encodeURIComponent(query)}&limit=10`, {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                displayFornecedorResults(data.fornecedores);
            }
        } catch (error) {
            console.error('Erro ao buscar fornecedores:', error);
        }
    }, 300);
});

function displayFornecedorResults(fornecedores) {
    const dropdown = document.getElementById('fornecedorDropdown');
    dropdown.innerHTML = '';
    
    if (fornecedores.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item-text">Nenhum fornecedor encontrado</div>';
    } else {
        fornecedores.forEach(fornecedor => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="fw-bold">${fornecedor.nome}</div>
                <small class="text-muted">${fornecedor.cnpj || ''}</small>
            `;
            item.onclick = () => selectFornecedor(fornecedor);
            dropdown.appendChild(item);
        });
    }
    
    dropdown.style.display = 'block';
}

function selectFornecedor(fornecedor) {
    const fornecedorSearchInput = document.getElementById('fornecedorSearch');
    const fornecedorIdInput = document.getElementById('fornecedorId');
    const dropdown = document.getElementById('fornecedorDropdown');
    
    fornecedorSearchInput.value = fornecedor.display_name;
    fornecedorIdInput.value = fornecedor.id;
    dropdown.style.display = 'none';
}

// Fun√ß√µes de moeda
function updateCotacaoField() {
    const moeda = document.getElementById('moeda').value;
    const cotacaoInput = document.getElementById('cotacaoMoeda');
    const cotacaoLabel = document.querySelector('#cotacaoMoeda + .input-group-text');
    
    // Atualizar siglas das moedas em todos os lugares
    const moedaSymbol = getMoedaSymbol(moeda);
    document.querySelectorAll('.moeda-sigla').forEach(element => {
        element.textContent = moedaSymbol;
    });
    
    if (moeda === 'BRL') {
        cotacaoInput.value = '1.0000';
        cotacaoInput.disabled = true;
        cotacaoLabel.textContent = 'BRL';
    } else {
        cotacaoInput.disabled = false;
        cotacaoLabel.textContent = 'BRL';
        if (moeda === 'USD') {
            cotacaoInput.placeholder = 'Ex: 5.20';
        } else if (moeda === 'CNY') {
            cotacaoInput.placeholder = 'Ex: 0.72';
        }
    }
    
    // Atualizar resumo financeiro quando mudar moeda
    updateResumo();
}

function getMoedaSymbol(moeda) {
    const symbols = {
        'BRL': 'R$',
        'USD': 'US$',
        'CNY': '¬•'
    };
    return symbols[moeda] || 'R$';
}

function getMoedaName(moeda) {
    const names = {
        'BRL': 'Real',
        'USD': 'D√≥lar',
        'CNY': 'Yuan'
    };
    return names[moeda] || 'Real';
}

// Formata√ß√£o brasileira de moedas
function formatarMoeda(valor, moeda = 'BRL') {
    const moedaSymbol = getMoedaSymbol(moeda);
    return `${moedaSymbol} ${valor.toLocaleString('pt-BR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    })}`;
}

function formatarValor(valor) {
    return valor.toLocaleString('pt-BR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
}

// Sele√ß√£o de produtos
let selectedProducts = [];
let allProducts = [];
let searchTimeout;

function openProductSelector() {
    const modal = new bootstrap.Modal(document.getElementById('productSelectorModal'));
    modal.show();
    loadProducts();
}

async function loadProducts() {
    try {
        const response = await fetch('/api/internal-products/list?limit=1000&offset=0&search=', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            allProducts = data.products || [];
            displayProducts(allProducts);
        } else {
            console.error('Erro ao carregar produtos:', response.status);
            displayProducts([]);
        }
    } catch (error) {
        console.error('Erro ao carregar produtos:', error);
        displayProducts([]);
    }
}

function displayProducts(products) {
    const container = document.getElementById('productsList');
    container.innerHTML = '';
    
    if (products.length === 0) {
        container.innerHTML = '<div class="col-12 text-center text-muted">Nenhum produto encontrado</div>';
        return;
    }
    
    products.forEach(product => {
        const productCard = document.createElement('div');
        productCard.className = 'col-md-4 mb-3';
        productCard.innerHTML = `
            <div class="card h-100 product-card" data-product-id="${product.id}">
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input product-checkbox" type="checkbox" value="${product.id}" id="product_${product.id}">
                        <label class="form-check-label" for="product_${product.id}">
                            <strong>Selecionar</strong>
                        </label>
                    </div>
                    <div class="text-center mb-2">
                        <img src="${product.main_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik00MCA0MEM0Ni4wNzE0IDQwIDUxIDM1LjA3MTQgNTEgMjlDNTAgMjIuOTI4NiA0Ni4wNzE0IDE4IDQwIDE4QzMzLjkyODYgMTggMzAgMjIuOTI4NiAzMCAyOUMzMCAzNS4wNzE0IDMzLjkyODYgNDAgNDAgNDBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik00MCA0NkM0Ni4wNzE0IDQ2IDUxIDQxLjA3MTQgNTEgMzVDNTAgMjguOTI4NiA0Ni4wNzE0IDI0IDQwIDI0QzMzLjkyODYgMjQgMzAgMjguOTI4NiAzMCAzNUMzMCA0MS4wNzE0IDMzLjkyODYgNDYgNDAgNDZaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" 
                             class="img-thumbnail" 
                             style="width: 80px; height: 80px; object-fit: cover;"
                             alt="${product.name}">
                    </div>
                    <h6 class="card-title">${product.name}</h6>
                    <p class="card-text small text-muted">SKU: ${product.internal_sku || 'N/A'}</p>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label small">Quantidade:</label>
                            <input type="number" class="form-control form-control-sm product-quantity" 
                                   step="0.001" min="0" value="1" data-product-id="${product.id}">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Valor Unit. (<span class="moeda-sigla">R$</span>):</label>
                            <input type="number" class="form-control form-control-sm product-price" 
                                   step="0.01" min="0" value="0" placeholder="0.00" data-product-id="${product.id}">
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.appendChild(productCard);
    });
}

function searchProducts() {
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    searchTimeout = setTimeout(() => {
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        
        let filteredProducts = allProducts.filter(product => {
            const matchesSearch = !searchTerm || 
                product.name.toLowerCase().includes(searchTerm) ||
                (product.internal_sku && product.internal_sku.toLowerCase().includes(searchTerm)) ||
                (product.description && product.description.toLowerCase().includes(searchTerm));
            
            return matchesSearch;
        });
        
        displayProducts(filteredProducts);
    }, 300);
}

function addSelectedProducts() {
    const checkboxes = document.querySelectorAll('.product-checkbox:checked');
    console.log('Checkboxes selecionados:', checkboxes.length);
    
    checkboxes.forEach(checkbox => {
        const productId = parseInt(checkbox.value);
        const product = allProducts.find(p => p.id === productId);
        const quantityInput = document.querySelector(`.product-quantity[data-product-id="${productId}"]`);
        const priceInput = document.querySelector(`.product-price[data-product-id="${productId}"]`);
        
        console.log('Produto encontrado:', product);
        console.log('Quantidade:', quantityInput?.value);
        console.log('Pre√ßo:', priceInput?.value);
        
        if (product && quantityInput && priceInput) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            
            console.log('Quantidade parseada:', quantity);
            console.log('Pre√ßo parseado:', price);
            
            if (quantity > 0) {
                console.log('Adicionando produto √† ordem:', product.name);
                addProductToOrder(product, quantity, price);
            } else {
                console.log('Quantidade deve ser maior que 0');
            }
        } else {
            console.log('Produto, quantidade ou pre√ßo n√£o encontrados');
        }
    });
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productSelectorModal'));
    modal.hide();
}

function addProductToOrder(product, quantity, price) {
    console.log('addProductToOrder chamada com:', { product: product.name, quantity, price });
    const tbody = document.querySelector('#itensTable tbody');
    console.log('Tbody encontrado:', tbody);
    const row = document.createElement('tr');
    const total = quantity * price;
    console.log('Total calculado:', total);
    
    row.innerHTML = `
        <td>
            <img src="${product.main_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" 
                 class="img-thumbnail" 
                 style="width: 40px; height: 40px; object-fit: cover;"
                 alt="${product.name}">
        </td>
        <td>
            <div class="fw-bold">${product.name}</div>
            <small class="text-muted">SKU: ${product.internal_sku || 'N/A'}</small>
        </td>
        <td><input type="text" class="form-control form-control-sm" placeholder="Descri√ß√£o do item fornecedor"></td>
        <td><input type="number" class="form-control form-control-sm quantidade" step="0.001" min="0" value="${quantity}" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-unitario" step="0.01" min="0" value="${price}" onchange="calculateItemTotal(this)"></td>
        <td><input type="text" class="form-control form-control-sm valor-total" value="${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" data-numeric-value="${total}" readonly></td>
        <td><input type="url" class="form-control form-control-sm" placeholder="URL do produto"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
    `;
    console.log('HTML da linha criado');
    tbody.appendChild(row);
    console.log('Linha adicionada ao tbody');
    updateResumo();
    console.log('Resumo atualizado');
}

// Itens da ordem (manual)
function addItem() {
    const tbody = document.querySelector('#itensTable tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>
            <img src="${product.main_image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='}" 
                 class="img-thumbnail" 
                 style="width: 40px; height: 40px; object-fit: cover;"
                 alt="${product.name}"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yMCAyMEMyMy4zMTM3IDIwIDI2IDE3LjMxMzcgMjYgMTNDMjYgOS42ODYyOSAyMy4zMTM3IDcgMjAgN0MxNi42ODYzIDcgMTQgOS42ODYyOSAxNCAxM0MxNCAxNy4zMTM3IDE2LjY4NjMgMjAgMjAgMjBaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yMCAyM0MyMy4zMTM3IDIzIDI2IDIwLjMxMzcgMjYgMTdDMjYgMTMuNjg2MyAyMy4zMTM3IDExIDIwIDExQzE2LjY4NjMgMTEgMTQgMTMuNjg2MyAxNCAxN0MxNCAyMC4zMTM3IDE2LjY4NjMgMjMgMjAgMjNaIiBmaWxsPSIjOUNBM0FGIi8+Cjwvc3ZnPgo='">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm" placeholder="Nome do produto">
            <small class="text-muted">SKU: <input type="text" class="form-control form-control-sm mt-1" placeholder="C√≥digo do produto" style="width: 120px; display: inline-block;"></small>
        </td>
        <td><input type="text" class="form-control form-control-sm" placeholder="Descri√ß√£o do item fornecedor"></td>
        <td><input type="number" class="form-control form-control-sm quantidade" step="0.001" min="0" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-unitario" step="0.01" min="0" onchange="calculateItemTotal(this)"></td>
        <td><input type="number" class="form-control form-control-sm valor-total" step="0.01" readonly></td>
        <td><input type="url" class="form-control form-control-sm" placeholder="URL do produto"></td>
        <td><button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(this)"><i class="bi bi-trash"></i></button></td>
    `;
    tbody.appendChild(row);
}

function removeItem(button) {
    button.closest('tr').remove();
    updateResumo();
}

function calculateItemTotal(input) {
    const row = input.closest('tr');
    const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
    const valorUnitario = parseFloat(row.querySelector('.valor-unitario').value) || 0;
    const valorTotal = quantidade * valorUnitario;
    
    // Armazenar valor num√©rico em um atributo data para uso posterior
    row.querySelector('.valor-total').setAttribute('data-numeric-value', valorTotal);
    
    // Formatar valor total no padr√£o brasileiro para exibi√ß√£o
    row.querySelector('.valor-total').value = valorTotal.toLocaleString('pt-BR', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
    });
    updateResumo();
}

function updateResumo() {
    console.log('updateResumo chamada');
    const rows = document.querySelectorAll('#itensTable tbody tr');
    let subtotal = 0;
    
    rows.forEach(row => {
        // Usar o valor num√©rico armazenado no atributo data
        const valorTotalElement = row.querySelector('.valor-total');
        const valorTotal = parseFloat(valorTotalElement.getAttribute('data-numeric-value')) || 0;
        subtotal += valorTotal;
    });
    
    const subtotalComDesconto = subtotal;
    
    // Obter moeda e cota√ß√£o
    const moeda = document.getElementById('moeda').value;
    const cotacao = parseFloat(document.getElementById('cotacaoMoeda').value) || 1;
    
    // Verificar se √© ordem internacional
    const tipoOrdem = document.getElementById('tipoOrdem').value;
    let comissao = 0;
    let frete = 0;
    let taxasAdicionais = 0;
    let valorBaseImpostos = subtotalComDesconto;
    let impostos = 0;
    let total = subtotalComDesconto;
    
    // Mostrar/ocultar se√ß√£o internacional no resumo
    const resumoInternacional = document.getElementById('resumoInternacional');
    if (tipoOrdem === 'internacional') {
        resumoInternacional.style.display = 'block';
        
        // Calcular comiss√£o (percentual do subtotal)
        const percentualComissao = parseFloat(document.getElementById('comissaoAgente').value) || 0;
        comissao = subtotalComDesconto * (percentualComissao / 100);
        
        // Obter valor do frete
        frete = parseFloat(document.getElementById('valorTransporte').value) || 0;
        
        // Obter taxas adicionais
        taxasAdicionais = parseFloat(document.getElementById('taxasAdicionais').value) || 0;
        
        // Valor base para c√°lculo de impostos = produtos + comiss√£o + frete + taxas adicionais
        valorBaseImpostos = subtotalComDesconto + comissao + frete + taxasAdicionais;
        
        // Calcular impostos sobre o valor base
        const percentualImpostos = parseFloat(document.getElementById('percentualImportacao').value) || 0;
        impostos = valorBaseImpostos * (percentualImpostos / 100);
        
        // Total final = produtos + comiss√£o + frete + taxas adicionais + impostos
        total = valorBaseImpostos + impostos;
        
        // Atualizar valores no resumo
        const moedaSymbol = getMoedaSymbol(moeda);
        document.getElementById('comissaoValor').textContent = `${moedaSymbol} ${comissao.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('freteValor').textContent = `${moedaSymbol} ${frete.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('impostosValor').textContent = `${moedaSymbol} ${impostos.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('taxasAdicionaisValor').textContent = `${moedaSymbol} ${taxasAdicionais.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    } else {
        resumoInternacional.style.display = 'none';
    }
    
    console.log('C√°lculos:', {
        subtotal: subtotal,
        comissao: comissao,
        frete: frete,
        valorBaseImpostos: valorBaseImpostos,
        impostos: impostos,
        total: total
    });
    
    // Calcular total em reais
    const totalBRL = total * cotacao;
    
    // Atualizar exibi√ß√£o - valores principais na moeda selecionada
    const moedaSymbol = getMoedaSymbol(moeda);
    document.getElementById('subtotal').textContent = `${moedaSymbol} ${subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    document.getElementById('total').textContent = `${moedaSymbol} ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    
    // Valor convertido em reais (sempre em fonte menor)
    document.getElementById('totalBRL').textContent = `R$ ${totalBRL.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    
    console.log('Resumo atualizado:', {
        subtotal: `${moedaSymbol} ${subtotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        total: `${moedaSymbol} ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`,
        totalBRL: `R$ ${totalBRL.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`
    });
}

function getItensData() {
    const rows = document.querySelectorAll('#itensTable tbody tr');
    const itens = [];
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        
        // Detectar se √© produto interno (com .fw-bold) ou manual (com input)
        const isProdutoInterno = cells[1].querySelector('.fw-bold');
        const produtoNome = isProdutoInterno ? 
            cells[1].querySelector('.fw-bold').textContent.trim() : 
            cells[1].querySelector('input').value;
        const produtoCodigo = isProdutoInterno ? 
            cells[1].querySelector('small').textContent.replace('SKU: ', '').trim() : 
            cells[1].querySelector('small input').value;
        const produtoImagem = cells[0].querySelector('img').src;
        const descricaoFornecedor = cells[2].querySelector('input').value;
        const quantidade = parseFloat(row.querySelector('.quantidade').value) || 0;
        const valorUnitario = parseFloat(row.querySelector('.valor-unitario').value) || 0;
        // Usar o valor num√©rico armazenado no atributo data
        const valorTotalElement = row.querySelector('.valor-total');
        const valorTotal = parseFloat(valorTotalElement.getAttribute('data-numeric-value')) || 0;
        const url = cells[6].querySelector('input').value;
        
        if (produtoNome && quantidade > 0) {
            itens.push({
                produto_nome: produtoNome,
                produto_codigo: produtoCodigo,
                produto_imagem: produtoImagem,
                descricao_fornecedor: descricaoFornecedor,
                quantidade: quantidade,
                valor_unitario: valorUnitario,
                valor_total: valorTotal,
                url: url
            });
        }
    });
    
    return itens;
}

// Salvar ordem
async function saveOrdem() {
    const formData = {
        numero_ordem: document.getElementById('numeroOrdem').value,
        data_ordem: document.getElementById('dataOrdem').value,
        data_entrega_prevista: document.getElementById('dataEntregaPrevista').value,
        status: document.getElementById('status').value,
        fornecedor_id: document.getElementById('fornecedorId').value || null,
        condicoes_pagamento: document.getElementById('condicoesPagamento').value,
        prazo_entrega: document.getElementById('prazoEntrega').value,
        observacoes: document.getElementById('observacoes').value,
        moeda: document.getElementById('moeda').value,
        cotacao_moeda: parseFloat(document.getElementById('cotacaoMoeda').value) || 1,
        tipo_ordem: document.getElementById('tipoOrdem').value,
        comissao_agente: parseFloat(document.getElementById('comissaoAgente').value) || 0,
        valor_transporte: parseFloat(document.getElementById('valorTransporte').value) || 0,
        percentual_importacao: parseFloat(document.getElementById('percentualImportacao').value) || 0,
        taxas_adicionais: parseFloat(document.getElementById('taxasAdicionais').value) || 0,
        itens: getItensData()
    };
    
    // Detectar se est√° editando
    const isEditing = {% if is_editing %}true{% else %}false{% endif %};
    const ordemId = {% if is_editing and ordem_data %}{{ ordem_data.id }}{% else %}null{% endif %};
    
    try {
        const url = isEditing ? `/api/ordem-compra/${ordemId}` : '/api/ordem-compra';
        const method = isEditing ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const result = await response.json();
            const message = isEditing ? 'Ordem de compra atualizada com sucesso!' : 'Ordem de compra criada com sucesso!';
            showToast(message, 'success');
            setTimeout(() => {
                window.location.href = '/ordem-compra';
            }, 1500);
        } else {
            const error = await response.json();
            showToast('Erro: ' + (error.detail || 'Erro desconhecido'), 'error');
        }
    } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao salvar ordem de compra', 'error');
    }
}

function showToast(message, type = 'info') {
    // Criar toast se n√£o existir
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
    
    const toastHtml = `
        <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white">
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Sucesso' : type === 'error' ? 'Erro' : 'Informa√ß√£o'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    // Remover o toast do DOM ap√≥s ser escondido
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Fun√ß√£o para mostrar/ocultar campos internacionais
function toggleCamposInternacionais() {
    const tipoOrdem = document.getElementById('tipoOrdem').value;
    const camposInternacionais = document.getElementById('camposInternacionais');
    
    if (tipoOrdem === 'internacional') {
        camposInternacionais.style.display = 'block';
        // Atualizar s√≠mbolos de moeda nos campos internacionais
        updateMoedaSymbols();
    } else {
        camposInternacionais.style.display = 'none';
        // Limpar campos internacionais quando ocultar
        document.getElementById('comissaoAgente').value = '0.00';
        document.getElementById('valorTransporte').value = '0.00';
        document.getElementById('percentualImportacao').value = '0.00';
        document.getElementById('taxasAdicionais').value = '0.00';
    }
    
    // Atualizar resumo financeiro
    updateResumo();
}

// Fun√ß√£o para atualizar s√≠mbolos de moeda nos campos internacionais
function updateMoedaSymbols() {
    const moeda = document.getElementById('moeda').value;
    const moedaSymbols = document.querySelectorAll('.moeda-sigla');
    
    moedaSymbols.forEach(symbol => {
        symbol.textContent = getMoedaSymbol(moeda);
    });
}

// Adicionar event listeners para campos internacionais
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para campos que afetam o resumo financeiro
    const camposInternacionais = [
        'comissaoAgente',
        'valorTransporte', 
        'percentualImportacao',
        'taxasAdicionais'
    ];
    
    camposInternacionais.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            campo.addEventListener('input', updateResumo);
            campo.addEventListener('change', updateResumo);
        }
    });
});

// Fechar dropdown ao clicar fora
document.addEventListener('click', function(event) {
    const fornecedorContainer = document.querySelector('#fornecedorSearch').closest('.position-relative');
    if (!fornecedorContainer.contains(event.target)) {
        document.getElementById('fornecedorDropdown').style.display = 'none';
    }
});
</script>
{% endblock %}
