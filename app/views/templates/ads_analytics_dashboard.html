{% extends "base.html" %}

{% block title %}Analytics & Performance - GVMIA{% endblock %}

{% block content %}
<style>
/* Tooltips alinhados √† esquerda */
.tooltip-inner {
    text-align: left !important;
    max-width: 300px !important;
}

/* Loading skeleton */
.loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
</style>

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">üìä Dashboard de Vendas</h1>
                    <p class="text-muted mb-0">
                        An√°lise completa de performance de todos os produtos
                    </p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div class="row mb-4" id="alerts-container">
        <!-- Alerts ser√£o inseridos aqui dinamicamente -->
    </div>

    <!-- Filtro de M√™s e Ano -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <label class="form-label mb-0 fw-bold">Per√≠odo:</label>
                        </div>
                        <div class="col-auto">
                            <select class="form-select form-select-sm" id="month-selector" onchange="applyMonthYearFilter()">
                                <option value="1">Janeiro</option>
                                <option value="2">Fevereiro</option>
                                <option value="3">Mar√ßo</option>
                                <option value="4">Abril</option>
                                <option value="5">Maio</option>
                                <option value="6">Junho</option>
                                <option value="7">Julho</option>
                                <option value="8">Agosto</option>
                                <option value="9">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select class="form-select form-select-sm" id="year-selector" onchange="applyMonthYearFilter()">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4 g-3">
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-currency-dollar text-success fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">
                        Receita Total
                        <i class="bi bi-question-circle-fill text-secondary" 
                           style="font-size: 0.85rem; cursor: help;"
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           title="Receita l√≠quida j√° descontando cancelamentos e devolu√ß√µes"></i>
                    </h6>
                    <h3 class="mb-0" id="kpi-revenue">R$ 0,00</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-box-seam text-primary fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Produtos Vendidos</h6>
                    <h3 class="mb-0" id="kpi-quantity">0</h3>
                    <small class="text-muted" id="kpi-quantity-info">unidades</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-cart-check text-info fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Total de Pedidos</h6>
                    <h3 class="mb-0" id="kpi-orders">0</h3>
                    <small class="text-muted" id="kpi-orders-info">pedidos</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-graph-up text-warning fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Ticket M√©dio</h6>
                    <h3 class="mb-0" id="kpi-avg-ticket">R$ 0,00</h3>
                    <small class="text-muted" id="kpi-avg-info">por pedido</small>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Adicionais -->
    <div class="row mb-4 g-3" id="additional-kpis-section">
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-x-circle text-warning display-6"></i>
                    <h6 class="text-muted mt-2 mb-1">
                        Vendas Canceladas
                        <i class="bi bi-question-circle-fill text-secondary" 
                           style="font-size: 0.85rem; cursor: help;"
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           title="S√£o vendas que foram pagas ‚Üí entregues ‚Üí devolvidas ‚Üí reembolsadas"></i>
                    </h6>
                    <h3 class="mb-0 text-warning" id="kpi-cancelled-value">R$ 0,00</h3>
                    <p class="text-muted mb-0">
                        <span id="kpi-cancelled-count">0</span> pedidos
                    </p>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-danger">
                <div class="card-body text-center">
                    <i class="bi bi-arrow-return-left text-danger display-6"></i>
                    <h6 class="text-muted mt-2 mb-1">
                        Devolu√ß√µes
                        <i class="bi bi-question-circle-fill text-secondary" 
                           style="font-size: 0.85rem; cursor: help;"
                           data-bs-toggle="tooltip" 
                           data-bs-placement="top"
                           title="Vendas em que compradores abriram reclama√ß√£o (claim) solicitando devolu√ß√£o. Pode virar media√ß√£o (mediation) quando o MercadoLibre interv√©m para resolver o problema."></i>
                    </h6>
                    <h3 class="mb-0 text-danger" id="kpi-returns-value">R$ 0,00</h3>
                    <p class="text-muted mb-0">
                        <span id="kpi-returns-count">0</span> devolu√ß√µes
                    </p>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="bi bi-eye text-info display-6"></i>
                    <h6 class="text-muted mt-2 mb-1">Visitas</h6>
                    <h3 class="mb-0 text-info" id="kpi-visits">0</h3>
                    <p class="text-muted mb-0">
                        visualiza√ß√µes
                    </p>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up text-success display-6"></i>
                    <h6 class="text-muted mt-2 mb-1">Taxa de Convers√£o</h6>
                    <h3 class="mb-0 text-success" id="kpi-conversion">0%</h3>
                    <p class="text-muted mb-0">
                        vendas / visitas
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Custos e Margens -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üí∞ An√°lise de Custos e Margens</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Coluna Esquerda - Custos -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Dedu√ß√µes</h6>
                            
                            <!-- Comiss√µes ML -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Comiss√µes ML</div>
                                    <small class="text-muted" id="ml-fees-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="ml-fees-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Fretes -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Fretes</div>
                                    <small class="text-muted" id="shipping-fees-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="shipping-fees-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Descontos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Descontos</div>
                                    <small class="text-muted" id="discounts-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="discounts-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Custo dos Produtos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Custo dos Produtos</div>
                                    <small class="text-muted" id="product-cost-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="product-cost-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Impostos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Impostos</div>
                                    <small class="text-muted" id="taxes-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <span class="text-muted me-1" style="cursor: pointer; font-size: 0.8em;" data-bs-toggle="collapse" data-bs-target="#taxes-breakdown" aria-expanded="false" aria-controls="taxes-breakdown" title="Clique para ver o detalhamento de cada imposto (IR, CSLL, PIS, COFINS, ICMS, ISS) baseado no regime tribut√°rio da sua empresa">
                                        <i class="bi bi-info-circle"></i>
                                    </span>
                                    <strong class="text-danger" id="taxes-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Detalhamento dos Impostos (Collapsible) -->
                            <div class="collapse" id="taxes-breakdown">
                                <div class="card card-body bg-light mb-3">
                                    <h6 class="text-muted mb-3">Detalhamento dos Impostos</h6>
                                    <div id="taxes-breakdown-content">
                                        <!-- Conte√∫do ser√° preenchido via JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Outros Custos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Outros Custos</div>
                                    <small class="text-muted" id="other-costs-detail">R$ 0,00/un (0.0%)</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="other-costs-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Marketing -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="text-danger">
                                        (-) Marketing
                                        <i class="bi bi-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="Custo de Product Ads do Mercado Livre distribu√≠do proporcionalmente entre os pedidos do per√≠odo. Este valor vem da API de Billing do ML."
                                           style="cursor: help; font-size: 0.85em;"></i>
                                    </div>
                                    <small class="text-muted" id="marketing-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="marketing-value">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna Direita - Resultado -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Resultado Final</h6>
                            
                            <!-- Receita Bruta -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="fw-bold">Receita Bruta</div>
                                </div>
                                <div class="text-end">
                                    <strong class="fs-5" id="gross-revenue">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Total de Custos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">Total de Custos</div>
                                    <small class="text-muted" id="total-costs-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="total-costs-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Lucro L√≠quido -->
                            <div class="bg-success bg-opacity-10 p-3 rounded mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <div class="fw-bold text-success fs-5">(=) Lucro L√≠quido</div>
                                        <small class="text-success" id="net-profit-margin">0.0% margem l√≠quida</small>
                                    </div>
                                    <div class="text-end">
                                        <h3 class="mb-0 text-success" id="net-profit-value">R$ 0,00</h3>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lucro M√©dio por Pedido -->
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold">Lucro M√©dio por Pedido</div>
                                        <small class="text-muted" id="avg-profit-detail">0 pedidos</small>
                                    </div>
                                    <div class="text-end">
                                        <h4 class="mb-0 text-info" id="avg-profit-value">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto (80/20) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìä An√°lise de Pareto - Produtos que Representam 80% do Faturamento</h5>
                        <span class="badge bg-info" id="pareto-products-count">0 produtos</span>
                    </div>
                    <small class="text-muted">Princ√≠pio 80/20: poucos produtos geralmente representam a maior parte da receita</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Receita</th>
                                            <th class="text-end">% Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-table-body">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <i class="bi bi-graph-up display-4"></i>
                                                <p class="mt-2">Carregando an√°lise...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <canvas id="paretoChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto - Produtos que Representam 15% do Faturamento -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìä An√°lise de Pareto - Produtos que Representam 15% do Faturamento</h5>
                        <span class="badge bg-warning" id="pareto-15-products-count">0 produtos</span>
                    </div>
                    <small class="text-muted">Produtos de m√©dia import√¢ncia: representam 15% do faturamento total</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Receita</th>
                                            <th class="text-end">%</th>
                                            <th class="text-end">Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-15-table-body">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-3">
                                                <i class="bi bi-graph-up display-4"></i>
                                                <p class="mt-2">Carregando an√°lise 15%...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="pareto15Chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto - Produtos que Representam 5% do Faturamento -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìä An√°lise de Pareto - Produtos que Representam 5% do Faturamento</h5>
                        <span class="badge bg-danger" id="pareto-5-products-count">0 produtos</span>
                    </div>
                    <small class="text-muted">Produtos de baixa import√¢ncia: representam 5% do faturamento total</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Receita</th>
                                            <th class="text-end">%</th>
                                            <th class="text-end">Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-5-table-body">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-3">
                                                <i class="bi bi-graph-up display-4"></i>
                                                <p class="mt-2">Carregando an√°lise 5%...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <div class="chart-container" style="position: relative; height: 400px;">
                                <canvas id="pareto5Chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto por Quantidade -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì¶ An√°lise de Pareto - Produtos que Representam 80% da Quantidade Vendida</h5>
                        <span class="badge bg-success" id="pareto-quantity-count">0 produtos</span>
                    </div>
                    <small class="text-muted">Princ√≠pio 80/20: poucos produtos geralmente representam a maior parte das vendas em quantidade</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Quantidade</th>
                                            <th class="text-end">% Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-quantity-table-body">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <i class="bi bi-box-seam display-4"></i>
                                                <p class="mt-2">Carregando an√°lise...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <canvas id="paretoQuantityChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto por Lucro -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üí∞ An√°lise de Pareto - Produtos que Mais Geraram Lucro (80%)</h5>
                        <span class="badge bg-light text-success" id="pareto-profit-count">0 produtos</span>
                    </div>
                    <small>Produtos ordenados por lucro l√≠quido (receita - custos)</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Lucro</th>
                                            <th class="text-end">Margem</th>
                                            <th class="text-end">% Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-profit-table-body">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="bi bi-currency-dollar display-4"></i>
                                                <p class="mt-2">Carregando an√°lise...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <canvas id="paretoProfitChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Produtos com MENOR Lucro -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">‚ö†Ô∏è Cauda Longa - Produtos com Menor Faturamento (20%)</h5>
                        <span class="badge bg-light text-danger" id="low-profit-count">0 produtos</span>
                    </div>
                    <small>Produtos que MENOS faturam: representam apenas 20% do faturamento total (podem precisar revis√£o)</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Lucro</th>
                                            <th class="text-end">Margem</th>
                                            <th class="text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="low-profit-table-body">
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="bi bi-exclamation-triangle display-4"></i>
                                                <p class="mt-2">Carregando an√°lise...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <canvas id="lowProfitChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Produtos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üèÜ Top 10 Mais Vendidos</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush" id="top-sold-products">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-trophy display-4"></i>
                            <p class="mt-2">Carregando ranking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üí∞ Top 10 Maior Receita</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush" id="top-revenue-products">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-cash-stack display-4"></i>
                            <p class="mt-2">Carregando ranking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
    <div class="d-flex flex-column justify-content-center align-items-center h-100">
        <div class="spinner-border text-light mb-3" style="width: 4rem; height: 4rem;" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <h4 class="text-light">Carregando Analytics...</h4>
        <p class="text-light-50">Aguarde enquanto buscamos os dados mais recentes</p>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Vari√°veis globais
let mlAccounts = [];
let currentPage = 1;
let currentFilters = {};
let paretoChart = null;
let paretoQuantityChart = null;
let paretoProfitChart = null;
let lowProfitChart = null;
let pareto15Chart = null;
let pareto5Chart = null;

// Fun√ß√µes de loading
function showLoading() {
    document.getElementById('loading-overlay').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// Fun√ß√£o para mostrar loading skeleton nos campos
function showLoadingSkeleton() {
    const skeletonText = '<span class="loading-skeleton" style="display: inline-block; width: 80px; height: 1.2em; border-radius: 4px;"></span>';
    const skeletonTextLarge = '<span class="loading-skeleton" style="display: inline-block; width: 120px; height: 1.2em; border-radius: 4px;"></span>';
    
    // Aplicar skeleton APENAS nos campos de VALORES (n√£o nos textos descritivos)
    const valueFields = [
        'kpi-revenue', 'kpi-quantity', 
        'kpi-orders', 'kpi-avg-ticket', 'kpi-visits', 'kpi-conversion',
        'kpi-cancelled-value', 'kpi-cancelled-count', 'kpi-returns-value', 'kpi-returns-count',
        // Campos de Custos e Margens
        'ml-fees-value', 'ml-fees-percent', 'shipping-fees-value', 'shipping-fees-percent',
        'discounts-value', 'discounts-percent', 'product-cost-value', 'product-cost-percent',
        'taxes-value', 'taxes-percent', 'other-costs-value', 'other-costs-detail',
        'marketing-value', 'marketing-percent', 'gross-revenue', 'total-costs-value',
        'total-costs-percent', 'net-profit-value', 'net-profit-margin', 'avg-profit-value', 'avg-profit-detail'
    ];
    
    // Aplicar skeleton apenas nos campos de valores
    valueFields.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            // Usar skeleton maior para valores monet√°rios
            const isMonetary = id.includes('revenue') || id.includes('ticket') || 
                              id.includes('cancelled-value') || id.includes('returns-value') ||
                              id.includes('-value') || id.includes('gross-revenue') ||
                              id.includes('net-profit-value') || id.includes('avg-profit-value');
            element.innerHTML = isMonetary ? skeletonTextLarge : skeletonText;
        }
    });
}

// Fun√ß√£o para esconder loading skeleton
function hideLoadingSkeleton() {
    // Remover skeleton dos campos de valores
    const valueFields = [
        'kpi-revenue', 'kpi-quantity', 
        'kpi-orders', 'kpi-avg-ticket', 'kpi-visits', 'kpi-conversion',
        'kpi-cancelled-value', 'kpi-cancelled-count', 'kpi-returns-value', 'kpi-returns-count',
        // Campos de Custos e Margens
        'ml-fees-value', 'ml-fees-percent', 'shipping-fees-value', 'shipping-fees-percent',
        'discounts-value', 'discounts-percent', 'product-cost-value', 'product-cost-percent',
        'taxes-value', 'taxes-percent', 'other-costs-value', 'other-costs-detail',
        'marketing-value', 'marketing-percent', 'gross-revenue', 'total-costs-value',
        'total-costs-percent', 'net-profit-value', 'net-profit-margin', 'avg-profit-value', 'avg-profit-detail'
    ];
    
    // Limpar skeleton dos campos
    valueFields.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.innerHTML.includes('loading-skeleton')) {
            element.innerHTML = ''; // Ser√° preenchido pelas fun√ß√µes de update
        }
    });
}
let dashboardCosts = {}; // Armazenar custos do dashboard

// Fun√ß√£o para formatar valores em reais (padr√£o brasileiro)
function formatBRL(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

// Fun√ß√£o para formatar n√∫meros (sem s√≠mbolo de moeda)
function formatNumber(value) {
    return new Intl.NumberFormat('pt-BR').format(value);
}

// Fun√ß√£o para mostrar alertas
function showAlert(type, message) {
    const alertsContainer = document.getElementById('alerts-container');
    const alertId = 'alert-' + Date.now();
    
    const alertHTML = `
        <div class="col-12">
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    alertsContainer.innerHTML = alertHTML;
    
    // Auto-remover ap√≥s 5 segundos
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Carregar contas ML
// Fun√ß√£o loadMLAccounts removida - n√£o √© mais necess√°ria

// Aplicar filtro de m√™s e ano
function applyMonthYearFilter() {
    const month = document.getElementById('month-selector').value;
    const year = document.getElementById('year-selector').value;
    
    if (!month || !year) {
        alert('Por favor, selecione o m√™s e o ano.');
        return;
    }
    
    // Atualizar display do per√≠odo
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    
    
    // Carregar dados do dashboard com per√≠odo espec√≠fico
    loadDashboardWithMonthYear(month, year);
}

// Carregar dados do dashboard com m√™s e ano espec√≠ficos
function loadDashboardWithMonthYear(month, year) {
    // Mostrar loading
    showLoading();
    showLoadingSkeleton();
    
    // Construir URL da API com m√™s e ano
    const apiUrl = `/api/analytics/sales-dashboard?month=${month}&year=${year}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => {
        // Verificar se n√£o est√° autenticado
        if (response.status === 401) {
            window.location.href = '/login';
            return Promise.reject('not_authenticated');
        }
        
        return response.json();
    })
    .then(data => {
        if (data.success) {
            updateKPIs(data.kpis);
            updateCostsAndMargins(data.costs, data.profit, data.kpis);
            updateTopProducts(data.top_products);
            updateCurvaABC(data.pareto_analysis, data.kpis, data.costs);
            hideLoadingSkeleton();
        } else {
            showAlert('error', `Erro ao carregar dados: ${data.error || 'Erro desconhecido'}`);
            hideLoadingSkeleton();
        }
    })
    .catch(error => {
        if (error !== 'not_authenticated') {
            console.error('Erro ao carregar dados:', error);
            showAlert('error', 'Erro ao carregar dados do dashboard');
        }
        hideLoadingSkeleton();
    });
}

// Carregar dados do dashboard (fun√ß√£o gen√©rica)
function loadDashboard() {
    // Usar m√™s e ano atuais como padr√£o
    const month = document.getElementById('month-selector').value;
    const year = document.getElementById('year-selector').value;
    loadDashboardWithMonthYear(month, year);
}


// Carregar top produtos com filtros
function loadTopProducts() {
    const urlParams = new URLSearchParams(window.location.search);
    const period = urlParams.get('period') || '30';
    const search = urlParams.get('search') || '';
    
    let apiUrl = '/api/analytics/top-products?limit=10';
    if (period) apiUrl += `&period=${period}`;
    if (search) apiUrl += `&search=${encodeURIComponent(search)}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 401) {
            window.location.href = '/login';
            return Promise.reject('not_authenticated');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            renderTopProductsReal(data.top_sold, data.top_revenue);
        }
    })
    .catch(error => {
        if (error !== 'not_authenticated') {
            
        }
    });
}

// Carregar resumo de contas
function loadAccountsSummary() {
    fetch('/api/analytics/accounts-summary', {
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 401) {
            window.location.href = '/login';
            return Promise.reject('not_authenticated');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            renderAccountsSummaryReal(data.accounts);
        }
    })
    .catch(error => {
        if (error !== 'not_authenticated') {
            
        }
    });
}

// Renderizar produtos na tabela (REMOVIDO - card de produtos foi removido)
function renderProducts(products) {
    // Card removido - fun√ß√£o n√£o utilizada
    return;
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-5">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-2">Nenhum produto encontrado</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = products.map(product => {
        const price = parseFloat(product.price) || 0;
        const soldQty = product.quantity || 0;
        const revenue = price * soldQty;
        
        const statusClass = product.status === 'active' ? 'success' : 
                           product.status === 'paused' ? 'warning' : 'secondary';
        const statusText = product.status === 'active' ? 'Ativo' :
                          product.status === 'paused' ? 'Pausado' : 'Inativo';
        
        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${product.thumbnail ? 
                            `<img src="${product.thumbnail}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">` :
                            `<div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="bi bi-image text-muted"></i>
                            </div>`
                        }
                        <div>
                            <div class="fw-medium">${product.title.substring(0, 60)}${product.title.length > 60 ? '...' : ''}</div>
                            <small class="text-muted">ID: ${product.ml_item_id}</small>
                        </div>
                    </div>
                </td>
                <td class="text-end">
                    <strong>${formatBRL(price)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${formatNumber(product.available_quantity || 0)}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-${statusClass}">${statusText}</span>
                </td>
                <td class="text-end">
                    <strong class="text-primary">${formatNumber(soldQty)}</strong>
                </td>
                <td class="text-end">
                    <strong class="text-success">${formatBRL(revenue)}</strong>
                </td>
                <td class="text-center">
                    <a href="/ml/products/analysis/${product.id}" class="btn btn-sm btn-outline-primary" title="Ver An√°lise">
                        <i class="bi bi-graph-up"></i>
                    </a>
                </td>
            </tr>
        `;
    }).join('');
}

// Atualizar custos e margens
function updateCostsAndMargins(costs, profit, kpis) {
    // Receita Bruta
    const grossRevenueEl = document.getElementById('gross-revenue');
    if (grossRevenueEl) {
        grossRevenueEl.textContent = formatBRL(kpis.total_revenue);
    }
    
    // Custos individuais
    const mlFeesEl = document.getElementById('ml-fees-value');
    if (mlFeesEl) {
        mlFeesEl.textContent = formatBRL(costs.ml_fees);
    }
    
    const mlFeesPercentEl = document.getElementById('ml-fees-percent');
    if (mlFeesPercentEl) {
        mlFeesPercentEl.textContent = `${costs.ml_fees_percent.toFixed(1)}%`;
    }
    
    const shippingFeesEl = document.getElementById('shipping-fees-value');
    if (shippingFeesEl) {
        shippingFeesEl.textContent = formatBRL(costs.shipping_fees);
    }
    
    const shippingFeesPercentEl = document.getElementById('shipping-fees-percent');
    if (shippingFeesPercentEl) {
        shippingFeesPercentEl.textContent = `${costs.shipping_fees_percent.toFixed(1)}%`;
    }
    
    const discountsEl = document.getElementById('discounts-value');
    if (discountsEl) {
        discountsEl.textContent = formatBRL(costs.discounts);
    }
    
    const discountsPercentEl = document.getElementById('discounts-percent');
    if (discountsPercentEl) {
        discountsPercentEl.textContent = `${costs.discounts_percent.toFixed(1)}%`;
    }
    
    const productCostEl = document.getElementById('product-cost-value');
    if (productCostEl) {
        productCostEl.textContent = formatBRL(costs.product_cost);
        console.log('‚úÖ Custo Produtos atualizado:', formatBRL(costs.product_cost));
    } else {
        
    }
    
    const productCostPercentEl = document.getElementById('product-cost-percent');
    if (productCostPercentEl) {
        productCostPercentEl.textContent = `${costs.product_cost_percent.toFixed(1)}%`;
    }
    
    const taxesEl = document.getElementById('taxes-value');
    if (taxesEl) {
        taxesEl.textContent = formatBRL(costs.taxes);
        console.log('‚úÖ Impostos atualizado:', formatBRL(costs.taxes));
    } else {
        
    }
    
    const taxesPercentEl = document.getElementById('taxes-percent');
    if (taxesPercentEl) {
        taxesPercentEl.textContent = `${costs.taxes_percent.toFixed(1)}%`;
    }
    
    // Atualizar detalhamento dos impostos
    updateTaxesBreakdown(costs.taxes_breakdown);
    
    const otherCostsEl = document.getElementById('other-costs-value');
    if (otherCostsEl) {
        otherCostsEl.textContent = formatBRL(costs.other_costs);
        console.log('‚úÖ Outros Custos atualizado:', formatBRL(costs.other_costs));
    } else {
        
    }
    
    const otherCostsDetailEl = document.getElementById('other-costs-detail');
    if (otherCostsDetailEl) {
        otherCostsDetailEl.textContent = `${formatBRL(costs.other_costs_per_unit)}/un (${costs.other_costs_percent.toFixed(1)}%)`;
    }
    
    const marketingEl = document.getElementById('marketing-value');
    if (marketingEl) {
        marketingEl.textContent = formatBRL(costs.marketing_cost);
        console.log('‚úÖ Marketing atualizado:', formatBRL(costs.marketing_cost));
    } else {
        
    }
    
    const marketingPercentEl = document.getElementById('marketing-percent');
    if (marketingPercentEl) {
        marketingPercentEl.textContent = `${costs.marketing_percent.toFixed(1)}%`;
    }
    
    // Total de custos
    const totalCostsEl = document.getElementById('total-costs-value');
    if (totalCostsEl) {
        totalCostsEl.textContent = formatBRL(costs.total_costs);
        console.log('‚úÖ Total Custos atualizado:', formatBRL(costs.total_costs));
    } else {
        
    }
    
    const totalCostsPercentEl = document.getElementById('total-costs-percent');
    if (totalCostsPercentEl) {
        totalCostsPercentEl.textContent = `${costs.total_costs_percent.toFixed(1)}%`;
    }
    
    // Lucro L√≠quido
    const netProfitEl = document.getElementById('net-profit-value');
    if (netProfitEl) {
        netProfitEl.textContent = formatBRL(profit.net_profit);
        console.log('‚úÖ Lucro L√≠quido atualizado:', formatBRL(profit.net_profit));
    } else {
        
    }
    
    const netProfitMarginEl = document.getElementById('net-profit-margin');
    if (netProfitMarginEl) {
        netProfitMarginEl.textContent = `${profit.net_margin.toFixed(1)}% margem l√≠quida`;
    }
    
    // Lucro M√©dio por Pedido
    const avgProfitEl = document.getElementById('avg-profit-value');
    if (avgProfitEl) {
        avgProfitEl.textContent = formatBRL(profit.avg_profit_per_order);
        console.log('‚úÖ Lucro M√©dio atualizado:', formatBRL(profit.avg_profit_per_order));
    } else {
        
    }
    
    const avgProfitDetailEl = document.getElementById('avg-profit-detail');
    if (avgProfitDetailEl) {
        avgProfitDetailEl.textContent = `${formatNumber(kpis.total_orders)} pedidos`;
    }

}

// Atualizar KPIs
function updateKPIs(kpis) {
    // Atualizar KPIs com dados j√° calculados
    document.getElementById('kpi-revenue').textContent = formatBRL(kpis.total_revenue || 0);
    document.getElementById('kpi-quantity').textContent = formatNumber(kpis.total_sold || 0);
    document.getElementById('kpi-orders').textContent = formatNumber(kpis.total_orders || 0);
    document.getElementById('kpi-avg-ticket').textContent = formatBRL(kpis.avg_ticket || 0);
    
    // Atualizar KPIs adicionais
    document.getElementById('kpi-cancelled-value').textContent = formatBRL(kpis.cancelled_value || 0);
    document.getElementById('kpi-cancelled-count').textContent = formatNumber(kpis.cancelled_orders || 0);
    document.getElementById('kpi-returns-value').textContent = formatBRL(kpis.returns_value || 0);
    document.getElementById('kpi-returns-count').textContent = formatNumber(kpis.returns_count || 0);
    document.getElementById('kpi-visits').textContent = formatNumber(kpis.total_visits || 0);
    
    // Calcular e exibir taxa de convers√£o
    const conversionRate = kpis.total_visits > 0 
        ? ((kpis.total_sold / kpis.total_visits) * 100).toFixed(2)
        : 0;
    document.getElementById('kpi-conversion').textContent = conversionRate + '%';
}

// Atualizar top produtos
function updateTopProducts(topProducts) {
    if (!topProducts) {
        console.log('updateTopProducts: Nenhum dado de top produtos recebido');
        return;
    }
    
    // Se topProducts √© um array de produtos, usar renderTopProducts
    if (Array.isArray(topProducts)) {
        renderTopProducts(topProducts);
    } 
    // Se topProducts tem estrutura {top_sold, top_revenue}, usar renderTopProductsReal
    else if (topProducts.top_sold && topProducts.top_revenue) {
        renderTopProductsReal(topProducts.top_sold, topProducts.top_revenue);
    }
    else {
        console.log('updateTopProducts: Estrutura de dados n√£o reconhecida:', topProducts);
    }
}

// Atualizar curva ABC
function updateCurvaABC(paretoAnalysis, kpis, costs) {
    if (!paretoAnalysis) {
        console.log('updateCurvaABC: Nenhum dado de an√°lise de Pareto recebido');
        return;
    }
    
    console.log('updateCurvaABC: Dados recebidos:', paretoAnalysis);
    
    // Se paretoAnalysis tem dados, renderizar an√°lise de Pareto
    if (paretoAnalysis.revenue_80_percent && paretoAnalysis.revenue_80_percent.length > 0) {
        console.log('updateCurvaABC: Renderizando an√°lise de receita (80%)');
        renderParetoAnalysis(paretoAnalysis.revenue_80_percent);
    }
    
    if (paretoAnalysis.quantity_80_percent && paretoAnalysis.quantity_80_percent.length > 0) {
        console.log('updateCurvaABC: Renderizando an√°lise de quantidade (80%)');
        renderParetoQuantityAnalysis(paretoAnalysis.quantity_80_percent);
    }
    
    if (paretoAnalysis.profit_80_percent && paretoAnalysis.profit_80_percent.length > 0) {
        console.log('updateCurvaABC: Renderizando an√°lise de lucro (80%)');
        renderParetoProfitAnalysis(paretoAnalysis.profit_80_percent, kpis, costs);
    }
    
    // Renderizar cauda longa (20%)
    if (paretoAnalysis.tail_20_percent && paretoAnalysis.tail_20_percent.length > 0) {
        console.log('updateCurvaABC: Renderizando cauda longa (20%)');
        renderLowProfitAnalysis(paretoAnalysis.tail_20_percent, kpis, costs);
    }
    
    // Renderizar an√°lise 15% do faturamento
    if (paretoAnalysis.revenue_80_percent && paretoAnalysis.revenue_80_percent.length > 0) {
        console.log('updateCurvaABC: Renderizando an√°lise 15%');
        renderPareto15Analysis(paretoAnalysis.revenue_80_percent, kpis);
    }
    
    // Renderizar an√°lise 5% do faturamento
    if (paretoAnalysis.revenue_80_percent && paretoAnalysis.revenue_80_percent.length > 0) {
        console.log('updateCurvaABC: Renderizando an√°lise 5%');
        renderPareto5Analysis(paretoAnalysis.revenue_80_percent, kpis);
    }
}

// Renderizar top produtos com dados reais da API
// Renderizar an√°lise de Pareto (80/20)
function renderParetoAnalysis(products) {
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.revenue > 0);
    
    if (productsWithSales.length === 0) {
        document.getElementById('pareto-table-body').innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-graph-up display-4"></i>
                    <p class="mt-2">Nenhum produto com vendas no per√≠odo</p>
                </td>
            </tr>
        `;
        document.getElementById('pareto-products-count').textContent = '0 produtos';
        return;
    }
    
    // Ordenar por receita (maior para menor)
    const sortedProducts = [...productsWithSales].sort((a, b) => b.revenue - a.revenue);
    
    // Calcular receita total
    const totalRevenue = sortedProducts.reduce((sum, p) => sum + p.revenue, 0);
    
    // Calcular percentual acumulado e encontrar produtos que representam 80%
    let accumulatedPercentage = 0;
    const paretoProducts = [];
    
    for (const product of sortedProducts) {
        const productPercentage = (product.revenue / totalRevenue) * 100;
        accumulatedPercentage += productPercentage;
        
        paretoProducts.push({
            ...product,
            percentage: productPercentage,
            accumulatedPercentage: accumulatedPercentage
        });
        
        // Parar quando atingir 80%
        if (accumulatedPercentage >= 80) {
            break;
        }
    }
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-table-body');
    tbody.innerHTML = paretoProducts.map((product, index) => `
        <tr class="${product.accumulatedPercentage <= 80 ? 'table-warning' : ''}">
            <td><span class="badge bg-primary">${index + 1}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${product.title}">
                    ${product.title}
                </div>
                <small class="text-muted">${product.ml_item_id}</small>
            </td>
            <td class="text-end">
                <strong>${formatBRL(product.revenue)}</strong>
                <br><small class="text-muted">${product.percentage.toFixed(1)}%</small>
            </td>
            <td class="text-end">
                <span class="badge ${product.accumulatedPercentage >= 80 ? 'bg-success' : 'bg-info'}">
                    ${product.accumulatedPercentage.toFixed(1)}%
                </span>
            </td>
        </tr>
    `).join('');
    
    // Atualizar contador
    document.getElementById('pareto-products-count').textContent = `${paretoProducts.length} produtos (${(paretoProducts.length / sortedProducts.length * 100).toFixed(0)}% do total)`;
    
    // Renderizar gr√°fico
    renderParetoChart(paretoProducts);
}

// Renderizar gr√°fico de Pareto
function renderParetoChart(paretoProducts) {
    const ctx = document.getElementById('paretoChart');
    
    // Destruir gr√°fico anterior se existir
    if (paretoChart) {
        paretoChart.destroy();
    }
    
    // Dados para o gr√°fico
    const labels = paretoProducts.map((p, i) => `#${i + 1}`);
    const revenues = paretoProducts.map(p => p.revenue);
    const accumulatedPercentages = paretoProducts.map(p => p.accumulatedPercentage);
    
    paretoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Receita (R$)',
                    data: revenues,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: '% Acumulado',
                    data: accumulatedPercentages,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto (Princ√≠pio 80/20)',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatBRL(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Receita (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '% Acumulado'
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Renderizar an√°lise de Pareto por quantidade (80/20)
function renderParetoQuantityAnalysis(products) {
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.quantity > 0);
    
    if (productsWithSales.length === 0) {
        document.getElementById('pareto-quantity-table-body').innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-box-seam display-4"></i>
                    <p class="mt-2">Nenhum produto com vendas no per√≠odo</p>
                </td>
            </tr>
        `;
        document.getElementById('pareto-quantity-count').textContent = '0 produtos';
        return;
    }
    
    // Ordenar por quantidade vendida (maior para menor)
    const sortedProducts = [...productsWithSales].sort((a, b) => b.quantity - a.quantity);
    
    // Calcular quantidade total
    const totalQuantity = sortedProducts.reduce((sum, p) => sum + p.quantity, 0);
    
    // Calcular percentual acumulado e encontrar produtos que representam 80%
    let accumulatedPercentage = 0;
    const paretoProducts = [];
    
    for (const product of sortedProducts) {
        const productPercentage = (product.quantity / totalQuantity) * 100;
        accumulatedPercentage += productPercentage;
        
        paretoProducts.push({
            ...product,
            percentage: productPercentage,
            accumulatedPercentage: accumulatedPercentage
        });
        
        // Parar quando atingir 80%
        if (accumulatedPercentage >= 80) {
            break;
        }
    }
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-quantity-table-body');
    tbody.innerHTML = paretoProducts.map((product, index) => `
        <tr class="${product.accumulatedPercentage <= 80 ? 'table-success' : ''}">
            <td><span class="badge bg-success">${index + 1}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${product.title}">
                    ${product.title}
                </div>
                <small class="text-muted">${product.ml_item_id}</small>
            </td>
            <td class="text-end">
                <strong>${formatNumber(product.quantity)} un</strong>
                <br><small class="text-muted">${product.percentage.toFixed(1)}%</small>
            </td>
            <td class="text-end">
                <span class="badge ${product.accumulatedPercentage >= 80 ? 'bg-success' : 'bg-info'}">
                    ${product.accumulatedPercentage.toFixed(1)}%
                </span>
            </td>
        </tr>
    `).join('');
    
    // Atualizar contador
    document.getElementById('pareto-quantity-count').textContent = `${paretoProducts.length} produtos (${(paretoProducts.length / sortedProducts.length * 100).toFixed(0)}% do total)`;
    
    // Renderizar gr√°fico
    renderParetoQuantityChart(paretoProducts);
}

// Renderizar gr√°fico de Pareto por quantidade
function renderParetoQuantityChart(paretoProducts) {
    const ctx = document.getElementById('paretoQuantityChart');
    
    // Destruir gr√°fico anterior se existir
    if (paretoQuantityChart) {
        paretoQuantityChart.destroy();
    }
    
    // Dados para o gr√°fico
    const labels = paretoProducts.map((p, i) => `#${i + 1}`);
    const quantities = paretoProducts.map(p => p.quantity);
    const accumulatedPercentages = paretoProducts.map(p => p.accumulatedPercentage);
    
    paretoQuantityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Quantidade',
                    data: quantities,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: '% Acumulado',
                    data: accumulatedPercentages,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto - Quantidade (Princ√≠pio 80/20)',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatNumber(context.parsed.y) + ' un';
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Quantidade (unidades)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value) + ' un';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '% Acumulado'
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Renderizar an√°lise de Pareto por lucro (80/20)
function renderParetoProfitAnalysis(products, kpis, costs) {
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.revenue > 0);
    
    if (productsWithSales.length === 0) {
        document.getElementById('pareto-profit-table-body').innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-currency-dollar display-4"></i>
                    <p class="mt-2">Nenhum produto com vendas no per√≠odo</p>
                </td>
            </tr>
        `;
        document.getElementById('pareto-profit-count').textContent = '0 produtos';
        return;
    }
    
    const totalRevenue = kpis.total_revenue;
    
    // Calcular lucro para cada produto
    const productsWithProfit = productsWithSales.map(product => {
        const productRevenue = product.revenue;
        const productQuantity = product.quantity;
        
        // Calcular custos proporcionais
        const mlFees = (costs.ml_fees / totalRevenue) * productRevenue;
        const shippingFees = (costs.shipping_fees / totalRevenue) * productRevenue;
        const discounts = (costs.discounts / totalRevenue) * productRevenue;
        const productCost = (costs.product_cost / totalRevenue) * productRevenue;
        const taxes = (costs.taxes / totalRevenue) * productRevenue;
        const otherCosts = costs.other_costs_per_unit * productQuantity;
        const marketingCost = (costs.marketing_cost / totalRevenue) * productRevenue;
        
        const totalCosts = mlFees + shippingFees + discounts + productCost + taxes + otherCosts + marketingCost;
        const profit = productRevenue - totalCosts;
        const margin = (profit / productRevenue) * 100;
        
        return {
            ...product,
            profit: profit,
            margin: margin,
            costs: totalCosts
        };
    });
    
    // Ordenar por lucro (maior para menor)
    const sortedProducts = productsWithProfit.sort((a, b) => b.profit - a.profit);
    
    // Calcular lucro total
    const totalProfit = sortedProducts.reduce((sum, p) => sum + p.profit, 0);
    
    // Calcular percentual acumulado e encontrar produtos que representam 80%
    let accumulatedPercentage = 0;
    const paretoProducts = [];
    
    for (const product of sortedProducts) {
        const productPercentage = (product.profit / totalProfit) * 100;
        accumulatedPercentage += productPercentage;
        
        paretoProducts.push({
            ...product,
            percentage: productPercentage,
            accumulatedPercentage: accumulatedPercentage
        });
        
        // Parar quando atingir 80%
        if (accumulatedPercentage >= 80) {
            break;
        }
    }
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-profit-table-body');
    tbody.innerHTML = paretoProducts.map((product, index) => {
        const profitClass = product.profit >= 0 ? 'text-success' : 'text-danger';
        const marginClass = product.margin >= 0 ? 'text-success' : 'text-danger';
        
        return `
        <tr class="${product.accumulatedPercentage <= 80 ? 'table-success' : ''}">
            <td><span class="badge bg-success">${index + 1}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 150px;" title="${product.title}">
                    ${product.title}
                </div>
                <small class="text-muted">${product.ml_item_id}</small>
            </td>
            <td class="text-end">
                <strong class="${profitClass}">${formatBRL(product.profit)}</strong>
                <br><small class="text-muted">${formatBRL(product.revenue)} receita</small>
            </td>
            <td class="text-end">
                <span class="badge ${product.margin >= 30 ? 'bg-success' : product.margin >= 15 ? 'bg-warning' : 'bg-danger'}">
                    ${product.margin.toFixed(1)}%
                </span>
            </td>
            <td class="text-end">
                <span class="badge ${product.accumulatedPercentage >= 80 ? 'bg-success' : 'bg-info'}">
                    ${product.accumulatedPercentage.toFixed(1)}%
                </span>
            </td>
        </tr>
        `;
    }).join('');
    
    // Atualizar contador
    document.getElementById('pareto-profit-count').textContent = `${paretoProducts.length} produtos (${(paretoProducts.length / sortedProducts.length * 100).toFixed(0)}% do total)`;
    
    // Renderizar gr√°fico
    renderParetoProfitChart(paretoProducts);
}

// Renderizar gr√°fico de Pareto por lucro
function renderParetoProfitChart(paretoProducts) {
    const ctx = document.getElementById('paretoProfitChart');
    
    // Destruir gr√°fico anterior se existir
    if (paretoProfitChart) {
        paretoProfitChart.destroy();
    }
    
    // Dados para o gr√°fico
    const labels = paretoProducts.map((p, i) => `#${i + 1}`);
    const profits = paretoProducts.map(p => p.profit);
    const accumulatedPercentages = paretoProducts.map(p => p.accumulatedPercentage);
    
    paretoProfitChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Lucro (R$)',
                    data: profits,
                    backgroundColor: profits.map(p => p >= 0 ? 'rgba(40, 167, 69, 0.5)' : 'rgba(220, 53, 69, 0.5)'),
                    borderColor: profits.map(p => p >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'),
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: '% Acumulado',
                    data: accumulatedPercentages,
                    borderColor: 'rgba(255, 193, 7, 1)',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto - Lucro (Princ√≠pio 80/20)',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatBRL(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Lucro (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '% Acumulado'
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Renderizar an√°lise dos produtos com MENOR faturamento (cauda longa)
function renderLowProfitAnalysis(products, kpis, costs) {
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.revenue > 0);
    
    if (productsWithSales.length === 0) {
        document.getElementById('low-profit-table-body').innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-exclamation-triangle display-4"></i>
                    <p class="mt-2">Nenhum produto com vendas no per√≠odo</p>
                </td>
            </tr>
        `;
        document.getElementById('low-profit-count').textContent = '0 produtos';
        return;
    }
    
    const totalRevenue = kpis.total_revenue;
    
    // Calcular lucro para cada produto
    const productsWithProfit = productsWithSales.map(product => {
        const productRevenue = product.revenue;
        const productQuantity = product.quantity;
        
        // Calcular custos proporcionais
        const mlFees = (costs.ml_fees / totalRevenue) * productRevenue;
        const shippingFees = (costs.shipping_fees / totalRevenue) * productRevenue;
        const discounts = (costs.discounts / totalRevenue) * productRevenue;
        const productCost = (costs.product_cost / totalRevenue) * productRevenue;
        const taxes = (costs.taxes / totalRevenue) * productRevenue;
        const otherCosts = costs.other_costs_per_unit * productQuantity;
        const marketingCost = (costs.marketing_cost / totalRevenue) * productRevenue;
        
        const totalCosts = mlFees + shippingFees + discounts + productCost + taxes + otherCosts + marketingCost;
        const profit = productRevenue - totalCosts;
        const margin = (profit / productRevenue) * 100;
        
        return {
            ...product,
            profit: profit,
            margin: margin,
            costs: totalCosts
        };
    });
    
    // Ordenar por RECEITA (MENOR para MAIOR - produtos com menor faturamento primeiro)
    const sortedProducts = productsWithProfit.sort((a, b) => a.revenue - b.revenue);
    
    // MESMA L√ìGICA das outras an√°lises de Pareto:
    // Somar receitas at√© atingir 20% do faturamento total (cauda longa)
    let accumulatedPercentage = 0;
    const lowRevenueProducts = [];
    
    for (const product of sortedProducts) {
        const productPercentage = (product.revenue / totalRevenue) * 100;
        accumulatedPercentage += productPercentage;
        
        lowRevenueProducts.push({
            ...product,
            percentage: productPercentage,
            accumulatedPercentage: accumulatedPercentage
        });
        
        // Parar quando atingir 20% do faturamento total
        if (accumulatedPercentage >= 20) {
            break;
        }
    }
    
    // Renderizar tabela
    const tbody = document.getElementById('low-profit-table-body');
    tbody.innerHTML = lowRevenueProducts.map((product, index) => {
        const profitClass = product.profit >= 0 ? 'text-warning' : 'text-danger';
        let statusBadge = '';
        let statusText = '';
        
        if (product.profit < 0) {
            statusBadge = 'bg-danger';
            statusText = 'PREJU√çZO';
        } else if (product.margin < 10) {
            statusBadge = 'bg-danger';
            statusText = 'CR√çTICO';
        } else if (product.margin < 20) {
            statusBadge = 'bg-warning';
            statusText = 'ATEN√á√ÉO';
        } else {
            statusBadge = 'bg-info';
            statusText = 'BAIXO';
        }
        
        return `
        <tr class="${product.profit < 0 ? 'table-danger' : product.accumulatedPercentage <= 80 ? 'table-warning' : ''}">
            <td><span class="badge ${statusBadge}">${index + 1}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 150px;" title="${product.title}">
                    ${product.title}
                </div>
                <small class="text-muted">${product.ml_item_id}</small>
                <br><small class="text-info">${formatNumber(product.quantity)} vendidos</small>
            </td>
            <td class="text-end">
                <strong class="${profitClass}">${formatBRL(product.profit)}</strong>
                <br><small class="text-muted">${formatBRL(product.revenue)} receita</small>
            </td>
            <td class="text-end">
                <span class="badge ${product.margin < 10 ? 'bg-danger' : 'bg-warning'}">
                    ${product.margin.toFixed(1)}%
                </span>
            </td>
            <td class="text-center">
                <span class="badge ${statusBadge}">
                    ${statusText}
                </span>
                <br><small class="text-muted">${product.accumulatedPercentage.toFixed(1)}% acum.</small>
            </td>
        </tr>
        `;
    }).join('');
    
    // Contar produtos com preju√≠zo
    const productsWithLoss = lowRevenueProducts.filter(p => p.profit < 0).length;
    const lowMarginProducts = lowRevenueProducts.filter(p => p.margin < 20).length;
    
    // Calcular percentual do total
    const percentOfTotal = (lowRevenueProducts.length / sortedProducts.length * 100).toFixed(0);
    
    // Atualizar contador
    let countText = `${lowRevenueProducts.length} produtos (${percentOfTotal}% do total - representam 20% do faturamento)`;
    document.getElementById('low-profit-count').textContent = countText;
    
    // Renderizar gr√°fico
    renderLowProfitChart(lowRevenueProducts);
}

// Renderizar gr√°fico de produtos com menor faturamento
function renderLowProfitChart(lowRevenueProducts) {
    const ctx = document.getElementById('lowProfitChart');
    
    // Destruir gr√°fico anterior se existir
    if (lowProfitChart) {
        lowProfitChart.destroy();
    }
    
    // Dados para o gr√°fico
    const labels = lowRevenueProducts.map((p, i) => `#${i + 1}`);
    const revenues = lowRevenueProducts.map(p => p.revenue);
    const margins = lowRevenueProducts.map(p => p.margin);
    
    lowProfitChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Receita (R$)',
                    data: revenues,
                    backgroundColor: 'rgba(220, 53, 69, 0.5)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: 'Margem (%)',
                    data: margins,
                    borderColor: 'rgba(111, 66, 193, 1)',
                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Cauda Longa - Produtos com Menor Faturamento (20%)',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatBRL(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Receita (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Margem (%)'
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function renderTopProductsReal(topSold, topRevenue) {
    // Top vendidos
    const topSoldContainer = document.getElementById('top-sold-products');
    topSoldContainer.innerHTML = topSold.length > 0 ? topSold.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.ml_item_id}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">${formatNumber(product.quantity)} un</div>
                    <small class="text-muted">${formatBRL(product.price)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhum produto vendido</div>';
    
    // Top receita
    const topRevenueContainer = document.getElementById('top-revenue-products');
    topRevenueContainer.innerHTML = topRevenue.length > 0 ? topRevenue.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.quantity} vendidos</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">${formatBRL(product.revenue)}</div>
                    <small class="text-muted">@ ${formatBRL(product.price)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhuma receita gerada</div>';
}

// Renderizar resumo de contas com dados reais
function renderAccountsSummaryReal(accounts) {
    try {
        const tbody = document.getElementById('accounts-summary-body');
        
        if (!tbody) {
            console.log('‚ÑπÔ∏è Resumo de contas n√£o est√° sendo exibido (elemento n√£o encontrado)');
            return;
        }
    
    if (accounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">
                    Nenhuma conta ML dispon√≠vel
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = accounts.map(account => `
        <tr>
            <td>
                <div>
                    <div class="fw-medium">${account.nickname}</div>
                    <small class="text-muted">${account.email}</small>
                </div>
            </td>
            <td class="text-end"><span class="badge bg-info">${formatNumber(account.active_products)}</span></td>
            <td class="text-end"><span class="badge bg-primary">${formatNumber(account.total_sold)}</span></td>
            <td class="text-end"><strong class="text-success">${formatBRL(account.total_revenue)}</strong></td>
            <td class="text-end"><strong>${formatBRL(account.avg_ticket)}</strong></td>
        </tr>
    `).join('');
    } catch (error) {
        
    }
}

// Renderizar top produtos (fun√ß√£o antiga - manter para compatibilidade)
function renderTopProducts(products) {
    // Top vendidos
    const topSold = [...products]
        .filter(p => p.quantity > 0)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 10);
    
    const topSoldContainer = document.getElementById('top-sold-products');
    topSoldContainer.innerHTML = topSold.length > 0 ? topSold.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.ml_item_id}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">${product.quantity} un</div>
                    <small class="text-muted">R$ ${parseFloat(product.price).toFixed(2)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhum produto vendido</div>';
    
    // Top receita
    const topRevenue = [...products]
        .map(p => ({
            ...p,
            revenue: (parseFloat(p.price) || 0) * (p.quantity || 0)
        }))
        .filter(p => p.revenue > 0)
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 10);
    
    const topRevenueContainer = document.getElementById('top-revenue-products');
    topRevenueContainer.innerHTML = topRevenue.length > 0 ? topRevenue.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.quantity} vendidos</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">R$ ${product.revenue.toFixed(2)}</div>
                    <small class="text-muted">@ R$ ${parseFloat(product.price).toFixed(2)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhuma receita gerada</div>';
}

// Renderizar an√°lise de Pareto 15%
function renderPareto15Analysis(products, kpis) {
    console.log('renderPareto15Analysis: Iniciando renderiza√ß√£o da an√°lise 15%');
    
    if (!products || products.length === 0) {
        console.log('renderPareto15Analysis: Nenhum produto recebido');
        return;
    }
    
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.revenue > 0);
    
    if (productsWithSales.length === 0) {
        console.log('renderPareto15Analysis: Nenhum produto com vendas');
        return;
    }
    
    // Ordenar por receita (maior para menor)
    const sortedProducts = [...productsWithSales].sort((a, b) => b.revenue - a.revenue);
    
    // Calcular receita total
    const totalRevenue = sortedProducts.reduce((sum, p) => sum + p.revenue, 0);
    
    // Encontrar produtos que representam 15% do faturamento (80% a 95%)
    const pareto15Products = [];
    let cumulativePercentage = 0;
    
    for (const product of sortedProducts) {
        const productPercentage = (product.revenue / totalRevenue) * 100;
        cumulativePercentage += productPercentage;
        
        if (cumulativePercentage > 80 && cumulativePercentage <= 95) {
            pareto15Products.push({
                ...product,
                percentage: productPercentage,
                cumulativePercentage: cumulativePercentage
            });
        }
    }
    
    console.log(`renderPareto15Analysis: ${pareto15Products.length} produtos encontrados`);
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-15-table-body');
    if (pareto15Products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">
                    <i class="bi bi-info-circle display-4"></i>
                    <p class="mt-2">Nenhum produto na faixa de 15%</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pareto15Products.map((product, index) => `
            <tr class="table-warning">
                <td><span class="badge bg-warning">${index + 1}</span></td>
                <td>
                    <div class="text-truncate" style="max-width: 200px;" title="${product.title}">
                        ${product.title}
                    </div>
                    <small class="text-muted">${product.ml_item_id}</small>
                </td>
                <td class="text-end">
                    <strong>${formatBRL(product.revenue)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-warning">${product.percentage.toFixed(1)}%</span>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${product.cumulativePercentage.toFixed(1)}%</span>
                </td>
            </tr>
        `).join('');
    }
    
    // Atualizar contador
    document.getElementById('pareto-15-products-count').textContent = `${pareto15Products.length} produtos`;
    
    // Renderizar gr√°fico
    renderPareto15Chart(pareto15Products);
}

// Renderizar an√°lise de Pareto 5%
function renderPareto5Analysis(products, kpis) {
    console.log('renderPareto5Analysis: Iniciando renderiza√ß√£o da an√°lise 5%');
    
    if (!products || products.length === 0) {
        console.log('renderPareto5Analysis: Nenhum produto recebido');
        return;
    }
    
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.revenue > 0);
    
    if (productsWithSales.length === 0) {
        console.log('renderPareto5Analysis: Nenhum produto com vendas');
        return;
    }
    
    // Ordenar por receita (maior para menor)
    const sortedProducts = [...productsWithSales].sort((a, b) => b.revenue - a.revenue);
    
    // Calcular receita total
    const totalRevenue = sortedProducts.reduce((sum, p) => sum + p.revenue, 0);
    
    // Encontrar produtos que representam 5% do faturamento (95% a 100%)
    const pareto5Products = [];
    let cumulativePercentage = 0;
    
    for (const product of sortedProducts) {
        const productPercentage = (product.revenue / totalRevenue) * 100;
        cumulativePercentage += productPercentage;
        
        if (cumulativePercentage > 95) {
            pareto5Products.push({
                ...product,
                percentage: productPercentage,
                cumulativePercentage: cumulativePercentage
            });
        }
    }
    
    console.log(`renderPareto5Analysis: ${pareto5Products.length} produtos encontrados`);
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-5-table-body');
    if (pareto5Products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">
                    <i class="bi bi-info-circle display-4"></i>
                    <p class="mt-2">Nenhum produto na faixa de 5%</p>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pareto5Products.map((product, index) => `
            <tr class="table-danger">
                <td><span class="badge bg-danger">${index + 1}</span></td>
                <td>
                    <div class="text-truncate" style="max-width: 200px;" title="${product.title}">
                        ${product.title}
                    </div>
                    <small class="text-muted">${product.ml_item_id}</small>
                </td>
                <td class="text-end">
                    <strong>${formatBRL(product.revenue)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-danger">${product.percentage.toFixed(1)}%</span>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${product.cumulativePercentage.toFixed(1)}%</span>
                </td>
            </tr>
        `).join('');
    }
    
    // Atualizar contador
    document.getElementById('pareto-5-products-count').textContent = `${pareto5Products.length} produtos`;
    
    // Renderizar gr√°fico
    renderPareto5Chart(pareto5Products);
}

// Renderizar gr√°fico de Pareto 15%
function renderPareto15Chart(products) {
    const ctx = document.getElementById('pareto15Chart');
    
    // Destruir gr√°fico anterior se existir
    if (pareto15Chart) {
        pareto15Chart.destroy();
    }
    
    if (!products || products.length === 0) {
        return;
    }
    
    // Dados para o gr√°fico
    const labels = products.map((p, i) => `#${i + 1}`);
    const revenues = products.map(p => p.revenue);
    const percentages = products.map(p => p.percentage);
    
    pareto15Chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Receita (R$)',
                    data: revenues,
                    backgroundColor: 'rgba(255, 193, 7, 0.5)',
                    borderColor: 'rgba(255, 193, 7, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: 'Percentual (%)',
                    data: percentages,
                    borderColor: 'rgba(111, 66, 193, 1)',
                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto - 15% do Faturamento',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatBRL(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Receita (R$)'
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBRL(value);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Percentual (%)'
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Renderizar gr√°fico de Pareto 5%
function renderPareto5Chart(products) {
    const ctx = document.getElementById('pareto5Chart');
    
    // Destruir gr√°fico anterior se existir
    if (pareto5Chart) {
        pareto5Chart.destroy();
    }
    
    if (!products || products.length === 0) {
        return;
    }
    
    // Dados para o gr√°fico
    const labels = products.map((p, i) => `#${i + 1}`);
    const revenues = products.map(p => p.revenue);
    const percentages = products.map(p => p.percentage);
    
    pareto5Chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Receita (R$)',
                    data: revenues,
                    backgroundColor: 'rgba(220, 53, 69, 0.5)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: 'Percentual (%)',
                    data: percentages,
                    borderColor: 'rgba(111, 66, 193, 1)',
                    backgroundColor: 'rgba(111, 66, 193, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto - 5% do Faturamento',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatBRL(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Receita (R$)'
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatBRL(value);
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Percentual (%)'
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(0) + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Fun√ß√£o antiga de renderizar resumo por conta (mantida para compatibilidade)
function renderAccountsSummary() {
    // Removida - agora usa renderAccountsSummaryReal
    
}

// Atualizar pagina√ß√£o (removida - dashboard mostra todos os produtos filtrados)
function updatePagination(page, limit, total, hasNext, hasPrev) {
    const container = document.getElementById('pagination-container');
    // Ocultar pagina√ß√£o pois mostramos todos os produtos
    container.innerHTML = '';
}

// Restaurar filtros da URL
function restoreFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    const period = urlParams.get('period');
    if (period) {
        document.getElementById('periodFilter').value = period;
        toggleCustomPeriod();
    }
    
    const search = urlParams.get('search');
    if (search) {
        document.getElementById('search_filter').value = search;
    }
    
    const dateFrom = urlParams.get('date_from');
    if (dateFrom) {
        document.getElementById('date-from').value = dateFrom;
    }
    
    const dateTo = urlParams.get('date_to');
    if (dateTo) {
        document.getElementById('date-to').value = dateTo;
    }
}

// Fun√ß√£o para mostrar/ocultar per√≠odo personalizado
function toggleCustomPeriod() {
    const periodFilter = document.getElementById('periodFilter').value;
    const customPeriodRow = document.getElementById('customPeriodRow');
    const customPeriodRow2 = document.getElementById('customPeriodRow2');
    
    if (periodFilter === 'custom') {
        customPeriodRow.style.display = 'block';
        customPeriodRow2.style.display = 'block';
    } else {
        customPeriodRow.style.display = 'none';
        customPeriodRow2.style.display = 'none';
    }
}

// Aplicar filtros
function applyFilters() {
    const filters = {
        period: document.getElementById('periodFilter').value,
        search: document.getElementById('search_filter').value
    };
    
    if (filters.period === 'custom') {
        filters.date_from = document.getElementById('date-from').value;
        filters.date_to = document.getElementById('date-to').value;
    }
    
    // Atualizar URL sem recarregar
    const url = new URL(window.location);
    Object.keys(filters).forEach(key => {
        if (filters[key]) {
            url.searchParams.set(key, filters[key]);
        } else {
            url.searchParams.delete(key);
        }
    });
    
    window.history.pushState({}, '', url);
    loadDashboard();
    loadTopProducts(); // Atualizar Top 10 com os novos filtros
}

// Limpar filtros
function clearFilters() {
    document.getElementById('periodFilter').value = '30';
    document.getElementById('search_filter').value = '';
    document.getElementById('date-from').value = '';
    document.getElementById('date-to').value = '';
    
    // Ocultar per√≠odo personalizado
    document.getElementById('customPeriodRow').style.display = 'none';
    document.getElementById('customPeriodRow2').style.display = 'none';
    
    const url = new URL(window.location);
    url.search = '';
    window.history.pushState({}, '', url);
    
    loadDashboard();
    loadTopProducts(); // Atualizar Top 10 sem filtros
}

// Renderizar top produtos
function renderTopProductsReal(topSold, topRevenue) {
    // Renderizar top mais vendidos
    const topSoldContainer = document.getElementById('top-sold-products');
    if (topSold && topSold.length > 0) {
        topSoldContainer.innerHTML = topSold.map((product, index) => `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${index < 3 ? 'warning' : 'secondary'} me-2">#${index + 1}</span>
                            <div>
                                <div class="fw-bold">${product.title}</div>
                                <small class="text-muted">
                                    ${formatNumber(product.quantity)} unidades vendidas
                                    ${product.cumulative_percent ? ` ‚Ä¢ ${product.cumulative_percent.toFixed(1)}% acum.` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">${formatBRL(product.revenue)}</div>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        topSoldContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4"></i>
                <p class="mt-2">Nenhum produto vendido</p>
            </div>
        `;
    }
    
    // Renderizar top maior receita
    const topRevenueContainer = document.getElementById('top-revenue-products');
    if (topRevenue && topRevenue.length > 0) {
        topRevenueContainer.innerHTML = topRevenue.map((product, index) => `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${index < 3 ? 'success' : 'secondary'} me-2">#${index + 1}</span>
                            <div>
                                <div class="fw-bold">${product.title}</div>
                                <small class="text-muted">
                                    ${formatNumber(product.quantity)} unidades
                                    ${product.cumulative_percent ? ` ‚Ä¢ ${product.cumulative_percent.toFixed(1)}% acum.` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">${formatBRL(product.revenue)}</div>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        topRevenueContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="bi bi-inbox display-4"></i>
                <p class="mt-2">Nenhuma receita gerada</p>
            </div>
        `;
    }
}

// Atualizar dados
function refreshData() {
    showAlert('info', 'üîÑ Atualizando dados...');
    loadDashboard();
    loadTopProducts();
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {

    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Mostrar skeleton inicial
    showLoadingSkeleton();
    
    restoreFiltersFromURL();
    loadDashboard();
    loadTopProducts(); // Carregar top produtos
});

// Fun√ß√£o para atualizar detalhamento dos impostos
function updateTaxesBreakdown(taxesBreakdown) {
    const container = document.getElementById('taxes-breakdown-content');
    
    if (!taxesBreakdown || Object.keys(taxesBreakdown).length === 0) {
        container.innerHTML = '<p class="text-muted mb-0">Nenhum imposto configurado</p>';
        return;
    }
    
    let html = '';
    
    // Ordenar impostos por valor (maior para menor)
    const sortedTaxes = Object.values(taxesBreakdown).sort((a, b) => b.valor - a.valor);
    
    sortedTaxes.forEach(tax => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                <div>
                    <div class="text-danger small">${tax.name}</div>
                    <small class="text-muted">${tax.aliquota.toFixed(2)}%</small>
                </div>
                <div class="text-end">
                    <strong class="text-danger">${formatBRL(tax.valor)}</strong>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// CSS espec√≠fico para garantir layout responsivo dos KPIs
const kpiStyle = document.createElement('style');
kpiStyle.textContent = `
    /* KPIs em grid responsivo */
    .row.g-3 > [class*="col-"] {
        margin-bottom: 1rem;
    }
    
    /* Em telas pequenas, KPIs ficam em 2 colunas */
    @media (max-width: 767.98px) {
        .row.g-3 > .col-12.col-sm-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }
    
    /* Em telas m√©dias e grandes, KPIs ficam em 4 colunas */
    @media (min-width: 768px) {
        .row.g-3 > .col-12.col-sm-6.col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
        }
    }
    
    /* Garantir que os cards n√£o estourem */
    .card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
`;
document.head.appendChild(kpiStyle);

// Configurar m√™s atual como padr√£o
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // 1-12
    const currentYear = now.getFullYear();
    
    // Definir valores padr√£o
    document.getElementById('month-selector').value = currentMonth;
    document.getElementById('year-selector').value = currentYear;
    
    // Atualizar display do per√≠odo
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];
    
    // Carregar dashboard inicial
    loadDashboard();
});

// Fun√ß√£o para aplicar filtros r√°pidos
function applyQuickFilter(filterType) {
    const now = new Date();
    let days = 30; // Padr√£o
    let periodDisplay = '√öltimos 30 dias';
    
    switch(filterType) {
        case 'current_month':
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            days = Math.ceil((lastDay - firstDay) / (1000 * 60 * 60 * 24)) + 1;
            periodDisplay = `Este M√™s (${now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })})`;
            break;
        case 'last_month':
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthLastDay = new Date(now.getFullYear(), now.getMonth(), 0);
            days = Math.ceil((lastMonthLastDay - lastMonth) / (1000 * 60 * 60 * 24)) + 1;
            periodDisplay = `M√™s Passado (${lastMonth.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })})`;
            break;
        case 'last_3_months':
            days = 90;
            periodDisplay = '√öltimos 3 Meses';
            break;
        case 'last_6_months':
            days = 180;
            periodDisplay = '√öltimos 6 Meses';
            break;
        case 'current_year':
            const yearStart = new Date(now.getFullYear(), 0, 1);
            days = Math.ceil((now - yearStart) / (1000 * 60 * 60 * 24)) + 1;
            periodDisplay = `Este Ano (${now.getFullYear()})`;
            break;
    }
    
    
    // Carregar dados do dashboard com per√≠odo customizado
    loadDashboard();
}

// Fun√ß√£o para aplicar filtro de m√™s/ano (simplificada)
function applyMonthYearFilter() {
    // Usar filtro padr√£o do per√≠odo
    loadDashboard();
}

// Fun√ß√£o para aplicar filtro personalizado
function applyCustomRange() {
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    
    if (!dateFrom || !dateTo) {
        alert('Por favor, selecione as datas de in√≠cio e fim.');
        return;
    }
    
    const startDate = new Date(dateFrom);
    const endDate = new Date(dateTo);
    
    if (startDate > endDate) {
        alert('A data de in√≠cio deve ser anterior √† data de fim.');
        return;
    }
    
    
    // Calcular dias do per√≠odo
    const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    
    // Carregar dados do dashboard com per√≠odo customizado
    loadDashboard();
}
</script>

</div> <!-- Fechamento do container-fluid -->

{% endblock %}
