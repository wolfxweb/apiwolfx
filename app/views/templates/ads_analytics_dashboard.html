{% extends "base.html" %}

{% block title %}Analytics & Performance{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">üìä Dashboard de Vendas</h1>
                    <p class="text-muted mb-0">
                        An√°lise completa de performance de todos os produtos
                    </p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="bi bi-arrow-clockwise"></i> Atualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div class="row mb-4" id="alerts-container">
        <!-- Alerts ser√£o inseridos aqui dinamicamente -->
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="ml_account_filter" class="form-label">Conta ML</label>
                            <select id="ml_account_filter" class="form-select">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="period_filter" class="form-label">Per√≠odo</label>
                            <select id="period_filter" class="form-select" onchange="handlePeriodChange()">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="15">√öltimos 15 dias</option>
                                <option value="30" selected>√öltimos 30 dias</option>
                                <option value="60">√öltimos 60 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-2" id="date_from_container" style="display: none;">
                            <label for="date_from" class="form-label">Data Inicial</label>
                            <input type="date" id="date_from" class="form-control">
                        </div>
                        <div class="col-md-2" id="date_to_container" style="display: none;">
                            <label for="date_to" class="form-label">Data Final</label>
                            <input type="date" id="date_to" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label for="search_filter" class="form-label">Buscar Produto</label>
                            <input type="text" id="search_filter" class="form-control" placeholder="Nome ou SKU...">
                        </div>
                        <div class="col-md-2 d-flex align-items-end gap-2">
                            <button type="button" class="btn btn-primary flex-fill" onclick="applyFilters()">
                                <i class="bi bi-search"></i> Aplicar
                            </button>
                            <button type="button" class="btn btn-outline-secondary flex-fill" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-currency-dollar text-success fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Receita Total</h6>
                    <h3 class="mb-0" id="kpi-revenue">R$ 0,00</h3>
                    <small class="text-success" id="kpi-revenue-growth">+0%</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-box-seam text-primary fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Produtos Vendidos</h6>
                    <h3 class="mb-0" id="kpi-quantity">0</h3>
                    <small class="text-muted" id="kpi-quantity-info">unidades</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-cart-check text-info fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Total de Pedidos</h6>
                    <h3 class="mb-0" id="kpi-orders">0</h3>
                    <small class="text-muted" id="kpi-orders-info">pedidos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="bi bi-graph-up text-warning fs-1"></i>
                    </div>
                    <h6 class="text-muted mb-1">Ticket M√©dio</h6>
                    <h3 class="mb-0" id="kpi-avg-ticket">R$ 0,00</h3>
                    <small class="text-muted" id="kpi-avg-info">por pedido</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Custos e Margens -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üí∞ An√°lise de Custos e Margens</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Coluna Esquerda - Custos -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Dedu√ß√µes</h6>
                            
                            <!-- Comiss√µes ML -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Comiss√µes ML</div>
                                    <small class="text-muted" id="ml-fees-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="ml-fees-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Fretes -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Fretes</div>
                                    <small class="text-muted" id="shipping-fees-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="shipping-fees-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Descontos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Descontos</div>
                                    <small class="text-muted" id="discounts-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="discounts-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Custo dos Produtos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Custo dos Produtos</div>
                                    <small class="text-muted" id="product-cost-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="product-cost-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Impostos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Impostos</div>
                                    <small class="text-muted" id="taxes-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="taxes-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Outros Custos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">(-) Outros Custos</div>
                                    <small class="text-muted" id="other-costs-detail">R$ 0,00/un (0.0%)</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="other-costs-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Marketing -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <div class="text-danger">(-) Marketing</div>
                                    <small class="text-muted" id="marketing-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="marketing-value">R$ 0,00</strong>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Coluna Direita - Resultado -->
                        <div class="col-md-6">
                            <h6 class="text-muted mb-3">Resultado Final</h6>
                            
                            <!-- Receita Bruta -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="fw-bold">Receita Bruta</div>
                                </div>
                                <div class="text-end">
                                    <strong class="fs-5" id="gross-revenue">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Total de Custos -->
                            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                                <div>
                                    <div class="text-danger">Total de Custos</div>
                                    <small class="text-muted" id="total-costs-percent">0.0%</small>
                                </div>
                                <div class="text-end">
                                    <strong class="text-danger" id="total-costs-value">R$ 0,00</strong>
                                </div>
                            </div>
                            
                            <!-- Lucro L√≠quido -->
                            <div class="bg-success bg-opacity-10 p-3 rounded mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <div class="fw-bold text-success fs-5">(=) Lucro L√≠quido Final</div>
                                        <small class="text-success" id="net-profit-margin">0.0% margem l√≠quida</small>
                                    </div>
                                    <div class="text-end">
                                        <h3 class="mb-0 text-success" id="net-profit-value">R$ 0,00</h3>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lucro M√©dio por Pedido -->
                            <div class="bg-info bg-opacity-10 p-3 rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold">Lucro M√©dio por Pedido</div>
                                        <small class="text-muted" id="avg-profit-detail">0 pedidos</small>
                                    </div>
                                    <div class="text-end">
                                        <h4 class="mb-0 text-info" id="avg-profit-value">R$ 0,00</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto (80/20) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üìä An√°lise de Pareto - Produtos que Representam 80% do Faturamento</h5>
                        <span class="badge bg-info" id="pareto-products-count">0 produtos</span>
                    </div>
                    <small class="text-muted">Princ√≠pio 80/20: poucos produtos geralmente representam a maior parte da receita</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Receita</th>
                                            <th class="text-end">% Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-table-body">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <i class="bi bi-graph-up display-4"></i>
                                                <p class="mt-2">Carregando an√°lise...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <canvas id="paretoChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- An√°lise de Pareto por Quantidade -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">üì¶ An√°lise de Pareto - Produtos que Representam 80% da Quantidade Vendida</h5>
                        <span class="badge bg-success" id="pareto-quantity-count">0 produtos</span>
                    </div>
                    <small class="text-muted">Princ√≠pio 80/20: poucos produtos geralmente representam a maior parte das vendas em quantidade</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Tabela -->
                        <div class="col-md-6">
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Produto</th>
                                            <th class="text-end">Quantidade</th>
                                            <th class="text-end">% Acum.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pareto-quantity-table-body">
                                        <tr>
                                            <td colspan="4" class="text-center text-muted py-4">
                                                <i class="bi bi-box-seam display-4"></i>
                                                <p class="mt-2">Carregando an√°lise...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Gr√°fico -->
                        <div class="col-md-6">
                            <canvas id="paretoQuantityChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Produtos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üèÜ Top 10 Mais Vendidos</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush" id="top-sold-products">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-trophy display-4"></i>
                            <p class="mt-2">Carregando ranking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">üí∞ Top 10 Maior Receita</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush" id="top-revenue-products">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-cash-stack display-4"></i>
                            <p class="mt-2">Carregando ranking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Vari√°veis globais
let mlAccounts = [];
let currentPage = 1;
let currentFilters = {};
let paretoChart = null;
let paretoQuantityChart = null;

// Fun√ß√£o para formatar valores em reais (padr√£o brasileiro)
function formatBRL(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

// Fun√ß√£o para formatar n√∫meros (sem s√≠mbolo de moeda)
function formatNumber(value) {
    return new Intl.NumberFormat('pt-BR').format(value);
}

// Fun√ß√£o para mostrar alertas
function showAlert(type, message) {
    const alertsContainer = document.getElementById('alerts-container');
    const alertId = 'alert-' + Date.now();
    
    const alertHTML = `
        <div class="col-12">
            <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    alertsContainer.innerHTML = alertHTML;
    
    // Auto-remover ap√≥s 5 segundos
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Carregar contas ML
function loadMLAccounts() {
    fetch('/ml/products/api/accounts', {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mlAccounts = data.accounts;
            
            const select = document.getElementById('ml_account_filter');
            select.innerHTML = '<option value="">Todas as contas</option>';
            
            data.accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.id;
                option.textContent = `${account.nickname} (${account.email})`;
                select.appendChild(option);
            });
            
            console.log('‚úÖ Contas ML carregadas:', data.accounts.length);
        }
    })
    .catch(error => {
        console.error('Erro ao carregar contas ML:', error);
    });
}

// Lidar com mudan√ßa de per√≠odo
function handlePeriodChange() {
    const period = document.getElementById('period_filter').value;
    const dateFromContainer = document.getElementById('date_from_container');
    const dateToContainer = document.getElementById('date_to_container');
    
    if (period === 'custom') {
        dateFromContainer.style.display = 'block';
        dateToContainer.style.display = 'block';
    } else {
        dateFromContainer.style.display = 'none';
        dateToContainer.style.display = 'none';
    }
}

// Carregar dados do dashboard
function loadDashboardData(page = 1) {
    currentPage = page;
    
    const urlParams = new URLSearchParams(window.location.search);
    
    const filters = {
        ml_account_id: urlParams.get('ml_account_id') || '',
        period: urlParams.get('period') || '30',
        search: urlParams.get('search') || ''
    };
    
    currentFilters = filters;
    
    // Construir URL da API de analytics
    let apiUrl = `/api/analytics/sales-dashboard?period=${filters.period}`;
    if (filters.ml_account_id) apiUrl += `&ml_account_id=${filters.ml_account_id}`;
    if (filters.search) apiUrl += `&search=${encodeURIComponent(filters.search)}`;
    
    console.log('üìä Carregando dados do dashboard:', apiUrl);
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Dados carregados:', data);
            
            // Atualizar KPIs com dados reais
            document.getElementById('kpi-revenue').textContent = formatBRL(data.kpis.total_revenue);
            document.getElementById('kpi-quantity').textContent = formatNumber(data.kpis.total_sold);
            document.getElementById('kpi-orders').textContent = formatNumber(data.kpis.total_orders);
            document.getElementById('kpi-avg-ticket').textContent = formatBRL(data.kpis.avg_ticket);
            
            // Atualizar custos e margens
            updateCostsAndMargins(data.costs, data.profit, data.kpis);
            
            // Renderizar an√°lise de Pareto por receita (80/20)
            renderParetoAnalysis(data.products);
            
            // Renderizar an√°lise de Pareto por quantidade (80/20)
            renderParetoQuantityAnalysis(data.products);
            
            // Renderizar top produtos com dados reais
            loadTopProducts();
            
            // Renderizar resumo de contas
            loadAccountsSummary();
            
        } else {
            console.error('Erro ao carregar dados:', data.error);
            showAlert('danger', 'Erro ao carregar dados do dashboard');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showAlert('danger', 'Erro ao carregar dados');
    });
}

// Carregar top produtos com filtros
function loadTopProducts() {
    const urlParams = new URLSearchParams(window.location.search);
    const ml_account_id = urlParams.get('ml_account_id') || '';
    const period = urlParams.get('period') || '30';
    const search = urlParams.get('search') || '';
    
    let apiUrl = '/api/analytics/top-products?limit=10';
    if (ml_account_id) apiUrl += `&ml_account_id=${ml_account_id}`;
    if (period) apiUrl += `&period=${period}`;
    if (search) apiUrl += `&search=${encodeURIComponent(search)}`;
    
    fetch(apiUrl, {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderTopProductsReal(data.top_sold, data.top_revenue);
        }
    })
    .catch(error => {
        console.error('Erro ao carregar top produtos:', error);
    });
}

// Carregar resumo de contas
function loadAccountsSummary() {
    fetch('/api/analytics/accounts-summary', {
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderAccountsSummaryReal(data.accounts);
        }
    })
    .catch(error => {
        console.error('Erro ao carregar resumo de contas:', error);
    });
}

// Renderizar produtos na tabela (REMOVIDO - card de produtos foi removido)
function renderProducts(products) {
    // Card removido - fun√ß√£o n√£o utilizada
    return;
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-5">
                    <i class="bi bi-inbox display-4"></i>
                    <p class="mt-2">Nenhum produto encontrado</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = products.map(product => {
        const price = parseFloat(product.price) || 0;
        const soldQty = product.sold_quantity || 0;
        const revenue = price * soldQty;
        
        const statusClass = product.status === 'active' ? 'success' : 
                           product.status === 'paused' ? 'warning' : 'secondary';
        const statusText = product.status === 'active' ? 'Ativo' :
                          product.status === 'paused' ? 'Pausado' : 'Inativo';
        
        return `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${product.thumbnail ? 
                            `<img src="${product.thumbnail}" class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">` :
                            `<div class="bg-light rounded me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="bi bi-image text-muted"></i>
                            </div>`
                        }
                        <div>
                            <div class="fw-medium">${product.title.substring(0, 60)}${product.title.length > 60 ? '...' : ''}</div>
                            <small class="text-muted">ID: ${product.ml_item_id}</small>
                        </div>
                    </div>
                </td>
                <td class="text-end">
                    <strong>${formatBRL(price)}</strong>
                </td>
                <td class="text-end">
                    <span class="badge bg-info">${formatNumber(product.available_quantity || 0)}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-${statusClass}">${statusText}</span>
                </td>
                <td class="text-end">
                    <strong class="text-primary">${formatNumber(soldQty)}</strong>
                </td>
                <td class="text-end">
                    <strong class="text-success">${formatBRL(revenue)}</strong>
                </td>
                <td class="text-center">
                    <a href="/ml/products/analysis/${product.id}" class="btn btn-sm btn-outline-primary" title="Ver An√°lise">
                        <i class="bi bi-graph-up"></i>
                    </a>
                </td>
            </tr>
        `;
    }).join('');
}

// Atualizar custos e margens
function updateCostsAndMargins(costs, profit, kpis) {
    // Receita Bruta
    document.getElementById('gross-revenue').textContent = formatBRL(kpis.total_revenue);
    
    // Custos individuais
    document.getElementById('ml-fees-value').textContent = formatBRL(costs.ml_fees);
    document.getElementById('ml-fees-percent').textContent = `${costs.ml_fees_percent.toFixed(1)}%`;
    
    document.getElementById('shipping-fees-value').textContent = formatBRL(costs.shipping_fees);
    document.getElementById('shipping-fees-percent').textContent = `${costs.shipping_fees_percent.toFixed(1)}%`;
    
    document.getElementById('discounts-value').textContent = formatBRL(costs.discounts);
    document.getElementById('discounts-percent').textContent = `${costs.discounts_percent.toFixed(1)}%`;
    
    document.getElementById('product-cost-value').textContent = formatBRL(costs.product_cost);
    document.getElementById('product-cost-percent').textContent = `${costs.product_cost_percent.toFixed(1)}%`;
    
    document.getElementById('taxes-value').textContent = formatBRL(costs.taxes);
    document.getElementById('taxes-percent').textContent = `${costs.taxes_percent.toFixed(1)}%`;
    
    document.getElementById('other-costs-value').textContent = formatBRL(costs.other_costs);
    document.getElementById('other-costs-detail').textContent = `${formatBRL(costs.other_costs_per_unit)}/un (${costs.other_costs_percent.toFixed(1)}%)`;
    
    document.getElementById('marketing-value').textContent = formatBRL(costs.marketing_cost);
    document.getElementById('marketing-percent').textContent = `${costs.marketing_percent.toFixed(1)}%`;
    
    // Total de custos
    document.getElementById('total-costs-value').textContent = formatBRL(costs.total_costs);
    document.getElementById('total-costs-percent').textContent = `${costs.total_costs_percent.toFixed(1)}%`;
    
    // Lucro L√≠quido
    document.getElementById('net-profit-value').textContent = formatBRL(profit.net_profit);
    document.getElementById('net-profit-margin').textContent = `${profit.net_margin.toFixed(1)}% margem l√≠quida`;
    
    // Lucro M√©dio por Pedido
    document.getElementById('avg-profit-value').textContent = formatBRL(profit.avg_profit_per_order);
    document.getElementById('avg-profit-detail').textContent = `${formatNumber(kpis.total_orders)} pedidos`;
}

// Atualizar KPIs
function updateKPIs(products) {
    let totalRevenue = 0;
    let totalSold = 0;
    let productsWithSales = 0;
    
    products.forEach(product => {
        const price = parseFloat(product.price) || 0;
        const soldQty = product.sold_quantity || 0;
        
        totalRevenue += price * soldQty;
        totalSold += soldQty;
        if (soldQty > 0) productsWithSales++;
    });
    
    const avgTicket = productsWithSales > 0 ? totalRevenue / productsWithSales : 0;
    
    document.getElementById('kpi-revenue').textContent = formatBRL(totalRevenue);
    document.getElementById('kpi-quantity').textContent = formatNumber(totalSold);
    document.getElementById('kpi-orders').textContent = formatNumber(productsWithSales);
    document.getElementById('kpi-avg-ticket').textContent = formatBRL(avgTicket);
}

// Renderizar top produtos com dados reais da API
// Renderizar an√°lise de Pareto (80/20)
function renderParetoAnalysis(products) {
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.revenue > 0);
    
    if (productsWithSales.length === 0) {
        document.getElementById('pareto-table-body').innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-graph-up display-4"></i>
                    <p class="mt-2">Nenhum produto com vendas no per√≠odo</p>
                </td>
            </tr>
        `;
        document.getElementById('pareto-products-count').textContent = '0 produtos';
        return;
    }
    
    // Ordenar por receita (maior para menor)
    const sortedProducts = [...productsWithSales].sort((a, b) => b.revenue - a.revenue);
    
    // Calcular receita total
    const totalRevenue = sortedProducts.reduce((sum, p) => sum + p.revenue, 0);
    
    // Calcular percentual acumulado e encontrar produtos que representam 80%
    let accumulatedPercentage = 0;
    const paretoProducts = [];
    
    for (const product of sortedProducts) {
        const productPercentage = (product.revenue / totalRevenue) * 100;
        accumulatedPercentage += productPercentage;
        
        paretoProducts.push({
            ...product,
            percentage: productPercentage,
            accumulatedPercentage: accumulatedPercentage
        });
        
        // Parar quando atingir 80%
        if (accumulatedPercentage >= 80) {
            break;
        }
    }
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-table-body');
    tbody.innerHTML = paretoProducts.map((product, index) => `
        <tr class="${product.accumulatedPercentage <= 80 ? 'table-warning' : ''}">
            <td><span class="badge bg-primary">${index + 1}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${product.title}">
                    ${product.title}
                </div>
                <small class="text-muted">${product.ml_item_id}</small>
            </td>
            <td class="text-end">
                <strong>${formatBRL(product.revenue)}</strong>
                <br><small class="text-muted">${product.percentage.toFixed(1)}%</small>
            </td>
            <td class="text-end">
                <span class="badge ${product.accumulatedPercentage >= 80 ? 'bg-success' : 'bg-info'}">
                    ${product.accumulatedPercentage.toFixed(1)}%
                </span>
            </td>
        </tr>
    `).join('');
    
    // Atualizar contador
    document.getElementById('pareto-products-count').textContent = `${paretoProducts.length} produtos (${(paretoProducts.length / sortedProducts.length * 100).toFixed(0)}% do total)`;
    
    // Renderizar gr√°fico
    renderParetoChart(paretoProducts);
}

// Renderizar gr√°fico de Pareto
function renderParetoChart(paretoProducts) {
    const ctx = document.getElementById('paretoChart');
    
    // Destruir gr√°fico anterior se existir
    if (paretoChart) {
        paretoChart.destroy();
    }
    
    // Dados para o gr√°fico
    const labels = paretoProducts.map((p, i) => `#${i + 1}`);
    const revenues = paretoProducts.map(p => p.revenue);
    const accumulatedPercentages = paretoProducts.map(p => p.accumulatedPercentage);
    
    paretoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Receita (R$)',
                    data: revenues,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: '% Acumulado',
                    data: accumulatedPercentages,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto (Princ√≠pio 80/20)',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatBRL(context.parsed.y);
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Receita (R$)'
                    },
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR');
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '% Acumulado'
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

// Renderizar an√°lise de Pareto por quantidade (80/20)
function renderParetoQuantityAnalysis(products) {
    // Filtrar apenas produtos com vendas
    const productsWithSales = products.filter(p => p.sold_quantity > 0);
    
    if (productsWithSales.length === 0) {
        document.getElementById('pareto-quantity-table-body').innerHTML = `
            <tr>
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-box-seam display-4"></i>
                    <p class="mt-2">Nenhum produto com vendas no per√≠odo</p>
                </td>
            </tr>
        `;
        document.getElementById('pareto-quantity-count').textContent = '0 produtos';
        return;
    }
    
    // Ordenar por quantidade vendida (maior para menor)
    const sortedProducts = [...productsWithSales].sort((a, b) => b.sold_quantity - a.sold_quantity);
    
    // Calcular quantidade total
    const totalQuantity = sortedProducts.reduce((sum, p) => sum + p.sold_quantity, 0);
    
    // Calcular percentual acumulado e encontrar produtos que representam 80%
    let accumulatedPercentage = 0;
    const paretoProducts = [];
    
    for (const product of sortedProducts) {
        const productPercentage = (product.sold_quantity / totalQuantity) * 100;
        accumulatedPercentage += productPercentage;
        
        paretoProducts.push({
            ...product,
            percentage: productPercentage,
            accumulatedPercentage: accumulatedPercentage
        });
        
        // Parar quando atingir 80%
        if (accumulatedPercentage >= 80) {
            break;
        }
    }
    
    // Renderizar tabela
    const tbody = document.getElementById('pareto-quantity-table-body');
    tbody.innerHTML = paretoProducts.map((product, index) => `
        <tr class="${product.accumulatedPercentage <= 80 ? 'table-success' : ''}">
            <td><span class="badge bg-success">${index + 1}</span></td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${product.title}">
                    ${product.title}
                </div>
                <small class="text-muted">${product.ml_item_id}</small>
            </td>
            <td class="text-end">
                <strong>${formatNumber(product.sold_quantity)} un</strong>
                <br><small class="text-muted">${product.percentage.toFixed(1)}%</small>
            </td>
            <td class="text-end">
                <span class="badge ${product.accumulatedPercentage >= 80 ? 'bg-success' : 'bg-info'}">
                    ${product.accumulatedPercentage.toFixed(1)}%
                </span>
            </td>
        </tr>
    `).join('');
    
    // Atualizar contador
    document.getElementById('pareto-quantity-count').textContent = `${paretoProducts.length} produtos (${(paretoProducts.length / sortedProducts.length * 100).toFixed(0)}% do total)`;
    
    // Renderizar gr√°fico
    renderParetoQuantityChart(paretoProducts);
}

// Renderizar gr√°fico de Pareto por quantidade
function renderParetoQuantityChart(paretoProducts) {
    const ctx = document.getElementById('paretoQuantityChart');
    
    // Destruir gr√°fico anterior se existir
    if (paretoQuantityChart) {
        paretoQuantityChart.destroy();
    }
    
    // Dados para o gr√°fico
    const labels = paretoProducts.map((p, i) => `#${i + 1}`);
    const quantities = paretoProducts.map(p => p.sold_quantity);
    const accumulatedPercentages = paretoProducts.map(p => p.accumulatedPercentage);
    
    paretoQuantityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'Quantidade',
                    data: quantities,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    yAxisID: 'y'
                },
                {
                    type: 'line',
                    label: '% Acumulado',
                    data: accumulatedPercentages,
                    borderColor: 'rgba(255, 159, 64, 1)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    borderWidth: 2,
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'An√°lise de Pareto - Quantidade (Princ√≠pio 80/20)',
                    font: {
                        size: 14,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                if (context.datasetIndex === 0) {
                                    label += formatNumber(context.parsed.y) + ' un';
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Quantidade (unidades)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatNumber(value) + ' un';
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '% Acumulado'
                    },
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function renderTopProductsReal(topSold, topRevenue) {
    // Top vendidos
    const topSoldContainer = document.getElementById('top-sold-products');
    topSoldContainer.innerHTML = topSold.length > 0 ? topSold.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.ml_item_id}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">${formatNumber(product.sold_quantity)} un</div>
                    <small class="text-muted">${formatBRL(product.price)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhum produto vendido</div>';
    
    // Top receita
    const topRevenueContainer = document.getElementById('top-revenue-products');
    topRevenueContainer.innerHTML = topRevenue.length > 0 ? topRevenue.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.sold_quantity} vendidos</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">${formatBRL(product.revenue)}</div>
                    <small class="text-muted">@ ${formatBRL(product.price)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhuma receita gerada</div>';
}

// Renderizar resumo de contas com dados reais
function renderAccountsSummaryReal(accounts) {
    const tbody = document.getElementById('accounts-summary-body');
    
    if (accounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted py-3">
                    Nenhuma conta ML dispon√≠vel
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = accounts.map(account => `
        <tr>
            <td>
                <div>
                    <div class="fw-medium">${account.nickname}</div>
                    <small class="text-muted">${account.email}</small>
                </div>
            </td>
            <td class="text-end"><span class="badge bg-info">${formatNumber(account.active_products)}</span></td>
            <td class="text-end"><span class="badge bg-primary">${formatNumber(account.total_sold)}</span></td>
            <td class="text-end"><strong class="text-success">${formatBRL(account.total_revenue)}</strong></td>
            <td class="text-end"><strong>${formatBRL(account.avg_ticket)}</strong></td>
        </tr>
    `).join('');
}

// Renderizar top produtos (fun√ß√£o antiga - manter para compatibilidade)
function renderTopProducts(products) {
    // Top vendidos
    const topSold = [...products]
        .filter(p => p.sold_quantity > 0)
        .sort((a, b) => b.sold_quantity - a.sold_quantity)
        .slice(0, 10);
    
    const topSoldContainer = document.getElementById('top-sold-products');
    topSoldContainer.innerHTML = topSold.length > 0 ? topSold.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.ml_item_id}</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-primary">${product.sold_quantity} un</div>
                    <small class="text-muted">R$ ${parseFloat(product.price).toFixed(2)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhum produto vendido</div>';
    
    // Top receita
    const topRevenue = [...products]
        .map(p => ({
            ...p,
            revenue: (parseFloat(p.price) || 0) * (p.sold_quantity || 0)
        }))
        .filter(p => p.revenue > 0)
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 10);
    
    const topRevenueContainer = document.getElementById('top-revenue-products');
    topRevenueContainer.innerHTML = topRevenue.length > 0 ? topRevenue.map((product, index) => `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-success rounded-circle me-2" style="width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        ${index + 1}
                    </span>
                    <div>
                        <div class="fw-medium">${product.title.substring(0, 40)}...</div>
                        <small class="text-muted">${product.sold_quantity} vendidos</small>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold text-success">R$ ${product.revenue.toFixed(2)}</div>
                    <small class="text-muted">@ R$ ${parseFloat(product.price).toFixed(2)}</small>
                </div>
            </div>
        </div>
    `).join('') : '<div class="text-center text-muted py-3">Nenhuma receita gerada</div>';
}

// Fun√ß√£o antiga de renderizar resumo por conta (mantida para compatibilidade)
function renderAccountsSummary() {
    // Removida - agora usa renderAccountsSummaryReal
    console.log('‚úÖ Usando renderAccountsSummaryReal ao inv√©s desta fun√ß√£o');
}

// Atualizar pagina√ß√£o (removida - dashboard mostra todos os produtos filtrados)
function updatePagination(page, limit, total, hasNext, hasPrev) {
    const container = document.getElementById('pagination-container');
    // Ocultar pagina√ß√£o pois mostramos todos os produtos
    container.innerHTML = '';
}

// Restaurar filtros da URL
function restoreFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    
    const mlAccountId = urlParams.get('ml_account_id');
    if (mlAccountId) {
        document.getElementById('ml_account_filter').value = mlAccountId;
    }
    
    const period = urlParams.get('period');
    if (period) {
        document.getElementById('period_filter').value = period;
        handlePeriodChange();
    }
    
    const search = urlParams.get('search');
    if (search) {
        document.getElementById('search_filter').value = search;
    }
}

// Aplicar filtros
function applyFilters() {
    const filters = {
        ml_account_id: document.getElementById('ml_account_filter').value,
        period: document.getElementById('period_filter').value,
        search: document.getElementById('search_filter').value
    };
    
    if (filters.period === 'custom') {
        filters.date_from = document.getElementById('date_from').value;
        filters.date_to = document.getElementById('date_to').value;
    }
    
    // Atualizar URL sem recarregar
    const url = new URL(window.location);
    Object.keys(filters).forEach(key => {
        if (filters[key]) {
            url.searchParams.set(key, filters[key]);
        } else {
            url.searchParams.delete(key);
        }
    });
    
    window.history.pushState({}, '', url);
    loadDashboardData(1);
    loadTopProducts(); // Atualizar Top 10 com os novos filtros
}

// Limpar filtros
function clearFilters() {
    document.getElementById('ml_account_filter').value = '';
    document.getElementById('period_filter').value = '30';
    document.getElementById('search_filter').value = '';
    handlePeriodChange();
    
    const url = new URL(window.location);
    url.search = '';
    window.history.pushState({}, '', url);
    
    loadDashboardData(1);
    loadTopProducts(); // Atualizar Top 10 sem filtros
}

// Atualizar dados
function refreshData() {
    showAlert('info', 'üîÑ Atualizando dados...');
    loadDashboardData(currentPage);
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Dashboard de Vendas carregado');
    restoreFiltersFromURL();
    loadMLAccounts();
    loadDashboardData(1);
});
</script>

{% endblock %}
