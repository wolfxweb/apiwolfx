{% extends "base.html" %}

{% block title %}Perguntas - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-question-circle"></i> Perguntas do Mercado Livre</h2>
                    <p class="text-muted mb-0">Gerencie e responda perguntas dos seus produtos</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="syncQuestions()">
                        <i class="bi bi-arrow-clockwise"></i> Sincronizar Perguntas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">

                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="status_filter" class="form-label">Status</label>
                            <select class="form-select" id="status_filter" onchange="loadQuestions()">
                                <option value="">Todas</option>
                                <option value="UNANSWERED">N√£o Respondidas</option>
                                <option value="ANSWERED">Respondidas</option>
                                <option value="CLOSED_UNANSWERED">Fechadas sem Resposta</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="account_filter" class="form-label">Conta ML</label>
                            <select class="form-select" id="account_filter" onchange="loadQuestions()">
                                <option value="">Todas as contas</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="search_filter" class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="search_filter" placeholder="Buscar por produto, pergunta..." onkeyup="debounceSearch()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Perguntas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
   
                <div class="card-body">
                    <span id="questions-count" class="badge bg-primary">Carregando...</span>
                    <div id="loading-message" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2 text-muted">Carregando perguntas...</p>
                    </div>
                    <div id="questions-container" style="display: none;">
                        <!-- Perguntas ser√£o inseridas aqui -->
                    </div>
                    <div id="empty-message" style="display: none;" class="text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-muted mt-3">Nenhuma pergunta encontrada</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gen√©rico para Mensagens -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="messageModalHeader">
                <h5 class="modal-title" id="messageModalLabel">
                    <i class="bi" id="messageModalIcon"></i> <span id="messageModalTitle">Mensagem</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Mensagem ser√° inserida aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="bi bi-question-circle"></i> Confirmar
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Mensagem ser√° inserida aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmModalBtn">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Sincroniza√ß√£o (com detalhes) -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" id="syncModalHeader">
                <h5 class="modal-title" id="syncModalLabel">
                    <i class="bi" id="syncModalIcon"></i> Sincroniza√ß√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="syncModalBody">
                <!-- Detalhes da sincroniza√ß√£o ser√£o inseridos aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
let searchTimeout = null;

// Carregar perguntas ao abrir a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    loadQuestions();
    loadAccounts();
});

// Fun√ß√£o para mostrar mensagem gen√©rica
function showMessage(type, title, message) {
    const modal = document.getElementById('messageModal');
    const modalHeader = document.getElementById('messageModalHeader');
    const modalTitle = document.getElementById('messageModalTitle');
    const modalIcon = document.getElementById('messageModalIcon');
    const modalBody = document.getElementById('messageModalBody');
    
    // Limpar classes anteriores
    modalHeader.className = 'modal-header';
    modalIcon.className = 'bi me-2';
    
    if (type === 'success') {
        modalHeader.classList.add('bg-success', 'text-white');
        modalIcon.classList.add('bi-check-circle-fill', 'text-white');
        modalTitle.textContent = title || 'Sucesso';
    } else if (type === 'error') {
        modalHeader.classList.add('bg-danger', 'text-white');
        modalIcon.classList.add('bi-x-circle-fill', 'text-white');
        modalTitle.textContent = title || 'Erro';
    } else if (type === 'warning') {
        modalHeader.classList.add('bg-warning', 'text-dark');
        modalIcon.classList.add('bi-exclamation-triangle-fill', 'text-dark');
        modalTitle.textContent = title || 'Aten√ß√£o';
    } else {
        modalHeader.classList.add('bg-info', 'text-white');
        modalIcon.classList.add('bi-info-circle-fill', 'text-white');
        modalTitle.textContent = title || 'Informa√ß√£o';
    }
    
    modalBody.innerHTML = `<p class="mb-0">${escapeHtml(message)}</p>`;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Fun√ß√£o para confirmar a√ß√£o
function showConfirm(message, onConfirm) {
    const modal = document.getElementById('confirmModal');
    const modalBody = document.getElementById('confirmModalBody');
    const confirmBtn = document.getElementById('confirmModalBtn');
    
    modalBody.innerHTML = `<p class="mb-0">${escapeHtml(message)}</p>`;
    
    // Remover listeners anteriores
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    // Adicionar novo listener
    newConfirmBtn.addEventListener('click', function() {
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
        if (onConfirm) onConfirm();
    });
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// Fun√ß√£o para mostrar modal de sincroniza√ß√£o
function showSyncModal(type, title, message, details = null) {
    const modal = document.getElementById('syncModal');
    const modalLabel = document.getElementById('syncModalLabel');
    const modalHeader = document.getElementById('syncModalHeader');
    const modalBody = document.getElementById('syncModalBody');
    const modalIcon = document.getElementById('syncModalIcon');
    
    // Limpar classes anteriores
    modalHeader.className = 'modal-header';
    modalIcon.className = 'bi me-2';
    
    if (type === 'success') {
        modalHeader.classList.add('bg-success', 'text-white');
        modalIcon.classList.add('bi-check-circle-fill', 'text-white');
        modalLabel.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i> ' + title;
    } else {
        modalHeader.classList.add('bg-danger', 'text-white');
        modalIcon.classList.add('bi-x-circle-fill', 'text-white');
        modalLabel.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i> ' + title;
    }
    
    // Construir conte√∫do do body
    let bodyContent = `<p class="mb-3">${escapeHtml(message)}</p>`;
    
    if (details && type === 'success') {
        if (details.total !== undefined || details.saved !== undefined || details.errors !== undefined) {
            bodyContent += '<hr class="my-3">';
            bodyContent += '<h6 class="mb-3">üìä Resumo Geral:</h6>';
            bodyContent += '<div class="row g-2 mb-3">';
            if (details.total !== undefined) {
                bodyContent += `
                    <div class="col-4">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="h5 mb-0 text-primary">${details.total}</div>
                            <small class="text-muted">Total de perguntas</small>
                        </div>
                    </div>
                `;
            }
            if (details.saved !== undefined) {
                bodyContent += `
                    <div class="col-4">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="h5 mb-0 text-success">${details.saved}</div>
                            <small class="text-muted">Perguntas salvas</small>
                        </div>
                    </div>
                `;
            }
            if (details.errors !== undefined && details.errors > 0) {
                bodyContent += `
                    <div class="col-4">
                        <div class="text-center p-2 bg-light rounded">
                            <div class="h5 mb-0 text-danger">${details.errors}</div>
                            <small class="text-muted">Erros</small>
                        </div>
                    </div>
                `;
            }
            bodyContent += '</div>';
        }
        
        if (details.accounts_synced && details.accounts_synced.length > 0) {
            bodyContent += '<hr class="my-3">';
            bodyContent += '<h6 class="mb-2">üìã Por Conta:</h6>';
            bodyContent += '<ul class="list-group">';
            details.accounts_synced.forEach(acc => {
                bodyContent += `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${escapeHtml(acc.nickname || 'Conta')}</strong></span>
                        <span class="badge bg-success rounded-pill">${acc.saved || 0} salvas</span>
                    </li>
                `;
            });
            bodyContent += '</ul>';
        }
        
        if (details.accounts_failed && details.accounts_failed.length > 0) {
            bodyContent += '<hr class="my-3">';
            bodyContent += '<h6 class="mb-2 text-danger">‚ö†Ô∏è Contas com erro:</h6>';
            bodyContent += '<ul class="list-group">';
            details.accounts_failed.forEach(acc => {
                bodyContent += `
                    <li class="list-group-item">
                        <strong>${escapeHtml(acc.nickname || 'Conta')}</strong><br>
                        <small class="text-danger">${escapeHtml(acc.error || 'Erro desconhecido')}</small>
                    </li>
                `;
            });
            bodyContent += '</ul>';
        }
    }
    
    modalBody.innerHTML = bodyContent;
    
    // Mostrar modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function debounceSearch() {
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    searchTimeout = setTimeout(() => {
        loadQuestions();
    }, 500);
}

async function loadAccounts() {
    try {
            const response = await fetch('/api/accounts', {
            credentials: 'include'
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        const selector = document.getElementById('account_filter');
        
        if (data && Array.isArray(data)) {
            selector.innerHTML = '<option value="">Todas as contas</option>' +
                data.map(acc => 
                    `<option value="${acc.id}">${acc.nickname || acc.email || acc.ml_user_id}</option>`
                ).join('');
        } else if (data && data.accounts && Array.isArray(data.accounts)) {
            selector.innerHTML = '<option value="">Todas as contas</option>' +
                data.accounts.map(acc => 
                    `<option value="${acc.id}">${acc.nickname || acc.email || acc.ml_user_id}</option>`
                ).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar contas:', error);
    }
}

async function loadQuestions() {
    const status = document.getElementById('status_filter')?.value || '';
    const mlAccountId = document.getElementById('account_filter')?.value || '';
    const search = document.getElementById('search_filter')?.value.trim() || '';
    
    const params = new URLSearchParams();
    if (status) params.append('status', status);
    if (mlAccountId) params.append('ml_account_id', mlAccountId);
    
    const url = `/api/questions?${params.toString()}`;
    
    document.getElementById('loading-message').style.display = 'block';
    document.getElementById('questions-container').style.display = 'none';
    document.getElementById('empty-message').style.display = 'none';
    
    try {
        const response = await fetch(url, {
            credentials: 'include'
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        
        document.getElementById('loading-message').style.display = 'none';
        
        if (data.success && data.questions && data.questions.length > 0) {
            // Filtrar por busca local se necess√°rio
            let questions = data.questions;
            if (search) {
                const searchLower = search.toLowerCase();
                questions = questions.filter(q => 
                    (q.question_text && q.question_text.toLowerCase().includes(searchLower)) ||
                    (q.item_title && q.item_title.toLowerCase().includes(searchLower)) ||
                    (q.buyer_nickname && q.buyer_nickname.toLowerCase().includes(searchLower))
                );
            }
            
            if (questions.length === 0) {
                document.getElementById('empty-message').style.display = 'block';
                document.getElementById('questions-count').textContent = '0 perguntas';
                return;
            }
            
            document.getElementById('questions-container').style.display = 'block';
            document.getElementById('questions-count').textContent = `${questions.length} pergunta(s)`;
            
            renderQuestions(questions);
        } else {
            document.getElementById('empty-message').style.display = 'block';
            document.getElementById('questions-count').textContent = '0 perguntas';
        }
    } catch (error) {
        console.error('Erro ao carregar perguntas:', error);
        document.getElementById('loading-message').style.display = 'none';
        document.getElementById('empty-message').style.display = 'block';
    }
}

function renderQuestions(questions) {
    const container = document.getElementById('questions-container');
    
    container.innerHTML = questions.map(q => {
        const statusBadge = {
            'UNANSWERED': '<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-circle"></i> N√£o Respondida</span>',
            'ANSWERED': '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Respondida</span>',
            'CLOSED_UNANSWERED': '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Fechada</span>'
        }[q.status] || '<span class="badge bg-secondary">' + q.status + '</span>';
        
        const questionDate = q.question_date ? new Date(q.question_date).toLocaleString('pt-BR') : 'N/A';
        const answeredDate = q.answered_at ? new Date(q.answered_at).toLocaleString('pt-BR') : null;
        
        return `
            <div class="card mb-3 ${q.status === 'UNANSWERED' ? 'border-warning' : ''}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-1 text-center">
                            ${q.item_thumbnail ? 
                                `<img src="${q.item_thumbnail}" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;" alt="${q.item_title || ''}">` :
                                `<div class="bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-image text-muted"></i></div>`
                            }
                        </div>
                        <div class="col-md-8">
                            <h6 class="mb-1">
                                ${q.item_title || 'Produto sem t√≠tulo'}
                            </h6>
                            <p class="mb-2"><strong>Pergunta:</strong> ${escapeHtml(q.question_text || 'N/A')}</p>
                            ${q.answer_text ? 
                                `<p class="mb-1 text-success"><strong>Resposta:</strong> ${escapeHtml(q.answer_text)}</p>` : 
                                ''
                            }
                            <small class="text-muted">
                                <i class="bi bi-person"></i> ${q.buyer_nickname || 'Comprador'} | 
                                <i class="bi bi-calendar"></i> ${questionDate}
                                ${answeredDate ? ` | <i class="bi bi-check"></i> Respondida em ${answeredDate}` : ''}
                            </small>
                        </div>
                        <div class="col-md-3 text-end">
                            ${statusBadge}
                            <div class="mt-2">
                                <div class="btn-group btn-group-sm w-100" role="group">
                                    ${q.status === 'UNANSWERED' ? 
                                        `<a class="btn btn-primary" href="/ml/questions/${q.id}">
                                            <i class="bi bi-reply"></i>
                                        </a>` :
                                        `<a class="btn btn-outline-secondary" href="/ml/questions/${q.id}">
                                            <i class="bi bi-eye"></i>
                                        </a>`
                                    }
                                    ${q.ml_item_id ? 
                                        `<a class="btn btn-outline-secondary" href="https://produto.mercadolivre.com.br/MLB-${q.ml_item_id.replace('MLB', '')}" target="_blank" rel="noopener noreferrer">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>` :
                                        ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function openConversationFromQuestion(accountId, buyerId, questionId, itemId) {
    if (!accountId || !buyerId) {
        showMessage('warning', 'Conversa indispon√≠vel', 'N√£o encontramos os dados necess√°rios para abrir a conversa desse comprador.');
        return;
    }

    const params = new URLSearchParams();
    params.append('ml_account_id', accountId);
    params.append('buyer_id', buyerId);
    if (questionId) params.append('question_id', questionId);
    if (itemId) params.append('item_id', itemId);

    window.open(`/ml/messages?${params.toString()}`, '_blank', 'noopener,noreferrer');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function syncQuestions() {
    const mlAccountId = document.getElementById('account_filter')?.value;
    const statusFilter = document.getElementById('status_filter')?.value;
    
    // Se n√£o selecionou conta, sincroniza todas as contas da empresa
    const syncMessage = mlAccountId 
        ? 'Deseja sincronizar as perguntas desta conta com o Mercado Livre? Isso pode levar alguns minutos.'
        : 'Deseja sincronizar as perguntas de TODAS as contas ML com o Mercado Livre? Isso pode levar alguns minutos.';
    
    showConfirm(syncMessage, () => {
        performSync(mlAccountId, statusFilter);
    });
}

async function performSync(mlAccountId, statusFilter) {
    // Mostrar loading
    const syncButton = document.querySelector('button[onclick="syncQuestions()"]');
    const originalText = syncButton ? syncButton.innerHTML : '';
    if (syncButton) {
        syncButton.disabled = true;
        syncButton.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i> Sincronizando...';
    }
    
    try {
        const requestBody = {};
        if (mlAccountId) {
            requestBody.ml_account_id = parseInt(mlAccountId);
        }
        if (statusFilter) {
            requestBody.status = statusFilter;
        }
        
        const response = await fetch('/api/questions/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify(requestBody)
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        
        // Restaurar bot√£o
        if (syncButton) {
            syncButton.disabled = false;
            syncButton.innerHTML = originalText;
        }
        
        if (data.success) {
            showSyncModal('success', 'Sincroniza√ß√£o conclu√≠da', 'Perguntas sincronizadas com sucesso!', {
                total: data.total || 0,
                saved: data.saved || 0,
                errors: data.errors || 0,
                accounts_synced: data.accounts_synced || [],
                accounts_failed: data.accounts_failed || []
            });
            loadQuestions(); // Recarregar lista
        } else {
            showSyncModal('error', 'Erro na sincroniza√ß√£o', data.error || 'Erro desconhecido ao sincronizar perguntas.');
        }
    } catch (error) {
        console.error('Erro ao sincronizar:', error);
        if (syncButton) {
            syncButton.disabled = false;
            syncButton.innerHTML = originalText;
        }
        showSyncModal('error', 'Erro na sincroniza√ß√£o', 'Erro ao sincronizar perguntas: ' + error.message);
    }
}
</script>
{% endblock %}

