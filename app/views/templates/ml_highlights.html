{% extends "base.html" %}

{% block title %}Mais Vendidos - Mercado Livre{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-trophy-fill"></i> Mais Vendidos do Mercado Livre</h2>
            <p class="text-muted">Consulte os 20 produtos mais vendidos por categoria</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Categoria:</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="category-search" placeholder="Digite para buscar categoria (ex: Veículos, Acessórios...)" autocomplete="off">
                                <input type="hidden" id="category-id" value="">
                                <div id="category-dropdown" class="dropdown-menu w-100" style="display: none; max-height: 300px; overflow-y: auto; z-index: 1000;">
                                    <!-- Resultados da busca aparecerão aqui -->
                                </div>
                            </div>
                            <small class="text-muted">Digite para buscar categorias e subcategorias do Mercado Livre</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Atributo (opcional):</label>
                            <select class="form-select" id="attribute-filter">
                                <option value="">Nenhum</option>
                                <option value="BRAND">Marca</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Valor do Atributo:</label>
                            <input type="text" class="form-control" id="attribute-value" placeholder="ID do atributo">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary" onclick="loadHighlights()">
                                <i class="bi bi-search"></i> Buscar Mais Vendidos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados -->
    <div id="results-container" style="display: none;">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ol"></i> Top 20 Mais Vendidos</h5>
                    </div>
                    <div class="card-body">
                        <div id="highlights-content">
                            <!-- Conteúdo será inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensagem de erro -->
    <div id="error-container" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="alert alert-danger">
                <h5><i class="bi bi-exclamation-triangle"></i> Erro</h5>
                <p id="error-message"></p>
            </div>
        </div>
    </div>

<style>
    /* Estilos para o autocomplete de categorias */
    #category-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 2px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .category-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s;
    }
    
    .category-item:hover {
        background-color: #f8f9fa;
    }
    
    .category-item:last-child {
        border-bottom: none;
    }
    
    .category-item .fw-bold {
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    .category-item small {
        display: block;
        color: #6c757d;
        font-size: 0.875rem;
    }
    
    .position-relative {
        position: relative;
    }
</style>
</div>

<script>
// Variável global para armazenar todas as categorias
let allCategoriesData = [];
let categorySearchTimeout = null;

// Carregar categorias ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    setupCategoryAutocomplete();
});

async function loadCategories() {
    try {
        const response = await fetch('/api/ml/highlights/categories', {
            credentials: 'include'
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        
        if (!data.success) {
            console.error('Erro ao carregar categorias:', data.error);
            return;
        }
        
        allCategoriesData = data.categories || [];
        
        // Preparar path_from_root como string para cada categoria
        allCategoriesData.forEach(cat => {
            const path = cat.path_from_root || [];
            if (Array.isArray(path) && path.length > 0) {
                cat.full_path = path.map(p => p.name || p.id || p).join(' → ');
            } else {
                cat.full_path = cat.name || cat.id || '';
            }
        });
        
        console.log(`Categorias carregadas: ${allCategoriesData.length}`);
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
    }
}

function setupCategoryAutocomplete() {
    const searchInput = document.getElementById('category-search');
    const hiddenInput = document.getElementById('category-id');
    const dropdown = document.getElementById('category-dropdown');
    
    if (!searchInput || !hiddenInput || !dropdown) return;
    
    // Event listener para digitação
    searchInput.addEventListener('input', function() {
        const query = this.value.trim().toLowerCase();
        
        // Limpar timeout anterior
        if (categorySearchTimeout) {
            clearTimeout(categorySearchTimeout);
        }
        
        // Aguardar 200ms antes de buscar (debounce)
        categorySearchTimeout = setTimeout(() => {
            if (query.length >= 2) {
                searchCategories(query);
            } else {
                hideCategoryDropdown();
                hiddenInput.value = '';
            }
        }, 200);
    });
    
    // Event listener para seleção de item
    dropdown.addEventListener('click', function(e) {
        const item = e.target.closest('.category-item');
        if (item) {
            const categoryId = item.dataset.categoryId;
            const categoryName = item.dataset.categoryName;
            const categoryPath = item.dataset.categoryPath;
            
            hiddenInput.value = categoryId;
            searchInput.value = categoryPath || categoryName;
            hideCategoryDropdown();
        }
    });
    
    // Fechar dropdown ao clicar fora
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            hideCategoryDropdown();
        }
    });
}

function searchCategories(query) {
    const dropdown = document.getElementById('category-dropdown');
    if (!dropdown || allCategoriesData.length === 0) return;
    
    // Filtrar categorias que contenham o termo de busca
    const filtered = allCategoriesData.filter(cat => {
        const name = (cat.name || '').toLowerCase();
        const fullPath = (cat.full_path || '').toLowerCase();
        const id = (cat.id || '').toLowerCase();
        
        return name.includes(query) || fullPath.includes(query) || id.includes(query);
    });
    
    // Ordenar por relevância (nome primeiro, depois path completo)
    filtered.sort((a, b) => {
        const aName = (a.name || '').toLowerCase();
        const bName = (b.name || '').toLowerCase();
        
        // Priorizar matches no nome
        const aNameMatch = aName.includes(query);
        const bNameMatch = bName.includes(query);
        
        if (aNameMatch && !bNameMatch) return -1;
        if (!aNameMatch && bNameMatch) return 1;
        
        // Depois ordenar por nome
        return aName.localeCompare(bName);
    });
    
    // Limitar a 50 resultados
    const limited = filtered.slice(0, 50);
    
    if (limited.length === 0) {
        dropdown.innerHTML = '<div class="dropdown-item-text text-muted">Nenhuma categoria encontrada</div>';
        showCategoryDropdown();
        return;
    }
    
    // Construir HTML dos resultados
    let html = '';
    limited.forEach(cat => {
        const name = cat.name || cat.id || 'Sem nome';
        const fullPath = cat.full_path || name;
        const categoryId = cat.id || '';
        
        // Destacar o termo de busca no nome (opcional - pode remover se não quiser)
        const highlightedName = highlightText(name, query);
        
        html += `
            <div class="category-item dropdown-item" 
                 data-category-id="${escapeHtml(categoryId)}"
                 data-category-name="${escapeHtml(name)}"
                 data-category-path="${escapeHtml(fullPath)}"
                 style="cursor: pointer;">
                <div class="fw-bold">${highlightedName}</div>
                <small class="text-muted">${escapeHtml(fullPath)}</small>
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
    showCategoryDropdown();
}

function showCategoryDropdown() {
    const dropdown = document.getElementById('category-dropdown');
    if (dropdown) {
        dropdown.style.display = 'block';
    }
}

function hideCategoryDropdown() {
    const dropdown = document.getElementById('category-dropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function highlightText(text, query) {
    if (!query || !text) return escapeHtml(text);
    
    const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
    return escapeHtml(text).replace(regex, '<mark>$1</mark>');
}

function escapeRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

async function loadHighlights() {
    const categoryId = document.getElementById('category-id')?.value.trim();
    const attribute = document.getElementById('attribute-filter')?.value;
    const attributeValue = document.getElementById('attribute-value')?.value.trim();
    
    if (!categoryId) {
        alert('Por favor, selecione uma categoria');
        return;
    }
    
    // Mostrar loading
    const resultsContainer = document.getElementById('results-container');
    const errorContainer = document.getElementById('error-container');
    const highlightsContent = document.getElementById('highlights-content');
    
    resultsContainer.style.display = 'none';
    errorContainer.style.display = 'none';
    
    highlightsContent.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Carregando mais vendidos...</p></div>';
    resultsContainer.style.display = 'block';
    
    try {
        let url = `/api/ml/highlights/category/${categoryId}`;
        const params = new URLSearchParams();
        if (attribute && attributeValue) {
            params.append('attribute', attribute);
            params.append('attribute_value', attributeValue);
        }
        if (params.toString()) {
            url += '?' + params.toString();
        }
        
        const response = await fetch(url, {
            credentials: 'include'
        });
        
        if (response.status === 401) {
            window.location.href = '/auth/login';
            return;
        }
        
        const data = await response.json();
        
        console.log('Dados recebidos:', data); // Debug
        
        if (!data.success) {
            errorContainer.style.display = 'block';
            document.getElementById('error-message').textContent = data.error || 'Erro ao carregar mais vendidos';
            resultsContainer.style.display = 'none';
            return;
        }
        
        const highlights = data.highlights || [];
        console.log('Highlights:', highlights); // Debug
        console.log('Primeiro produto:', highlights[0]); // Debug
        
        if (highlights.length === 0) {
            highlightsContent.innerHTML = '<p class="text-muted text-center py-4">Nenhum resultado encontrado.</p>';
            return;
        }
        
        // Renderizar resultados
        highlightsContent.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 60px;">#</th>
                            <th style="width: 100px;">Imagem</th>
                            <th>Produto</th>
                            <th class="text-end">Preço</th>
                            <th class="text-center">Vendidos</th>
                            <th class="text-center">Visitas</th>
                            <th class="text-center">Tipo</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${highlights.map(item => {
                            const title = item.title || 'N/A';
                            const thumbnail = item.thumbnail || '';
                            const price = parseFloat(item.price || 0);
                            const soldQty = parseInt(item.sold_quantity || 0);
                            const visits = parseInt(item.visits || 0);
                            const permalink = item.permalink || '';
                            const itemId = item.id || '';
                            const sellerNick = item.seller_nickname || '';
                            const itemType = item.type || 'ITEM';
                            
                            return `
                            <tr>
                                <td><strong class="text-primary">${item.position || ''}</strong></td>
                                <td>
                                    ${thumbnail ? `<img src="${thumbnail}" class="img-thumbnail" style="width: 80px; height: 80px; object-fit: cover;" alt="${title}" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'bg-light d-flex align-items-center justify-content-center\\' style=\\'width: 80px; height: 80px;\\'><i class=\\'bi bi-image text-muted\\'></i></div>';" />` : '<div class="bg-light d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;"><i class="bi bi-image text-muted"></i></div>'}
                                </td>
                                <td>
                                    <strong>${title}</strong><br>
                                    <small class="text-muted">ID: ${itemId}</small>
                                    ${sellerNick ? `<br><small class="text-muted"><i class="bi bi-person"></i> ${sellerNick}</small>` : ''}
                                </td>
                                <td class="text-end">
                                    <strong class="text-success">R$ ${price.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">${soldQty.toLocaleString('pt-BR')}</span>
                                </td>
                                <td class="text-center">
                                    ${visits > 0 ? `<span class="badge bg-warning text-dark">${visits.toLocaleString('pt-BR')}</span>` : '<span class="text-muted">-</span>'}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-${itemType === 'PRODUCT' ? 'primary' : 'secondary'}">${itemType}</span>
                                </td>
                                <td class="text-center">
                                    ${permalink ? `<a href="${permalink}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="bi bi-box-arrow-up-right"></i> Ver no ML</a>` : '-'}
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
    } catch (error) {
        console.error('Erro ao carregar mais vendidos:', error);
        errorContainer.style.display = 'block';
        document.getElementById('error-message').textContent = 'Erro ao carregar dados: ' + error.message;
        resultsContainer.style.display = 'none';
    }
}
</script>
{% endblock %}

