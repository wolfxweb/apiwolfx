{% extends "base.html" %}

{% block title %}Contas Bancárias - GIVM{% endblock %}

{% block extra_css %}
<style>
    .account-card {
        transition: transform 0.2s ease-in-out;
    }
    .account-card:hover {
        transform: translateY(-2px);
    }
    .balance-positive {
        color: #28a745;
    }
    .balance-negative {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="bi bi-bank text-primary"></i>
                    Contas Bancárias
                </h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newAccountModal">
                    <i class="bi bi-plus-circle"></i> Nova Conta
                </button>
            </div>
        </div>
    </div>
    
    <!-- Lista de Contas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome da Conta</th>
                                    <th>Tipo</th>
                                    <th>Banco</th>
                                    <th>Agência/Conta</th>
                                    <th>Saldo Atual</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTable">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Conta -->
<div class="modal fade" id="newAccountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Conta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newAccountForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome da Conta</label>
                        <input type="text" class="form-control" name="account_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="account_type" required>
                            <option value="bank">Conta Bancária</option>
                            <option value="cash">Caixa</option>
                            <option value="credit_card">Cartão de Crédito</option>
                            <option value="investment">Investimento</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Banco</label>
                        <input type="text" class="form-control" name="bank_name">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Agência</label>
                                <input type="text" class="form-control" name="agency">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Conta</label>
                                <input type="text" class="form-control" name="account_number">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Saldo Inicial</label>
                        <input type="number" class="form-control" name="initial_balance" step="0.01" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrição</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Conta</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Carregar contas
    async function loadAccounts() {
        try {
            const response = await fetch('/api/financial/accounts');
            const accounts = await response.json();
            
            const tbody = document.getElementById('accountsTable');
            
            if (accounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhuma conta encontrada</td></tr>';
                return;
            }
            
            tbody.innerHTML = accounts.map(account => `
                <tr>
                    <td><strong>${account.account_name}</strong></td>
                    <td><span class="badge bg-secondary">${getAccountTypeLabel(account.account_type)}</span></td>
                    <td>${account.bank_name || '-'}</td>
                    <td>${account.agency || '-'} / ${account.account_number || '-'}</td>
                    <td><strong class="${account.current_balance >= 0 ? 'balance-positive' : 'balance-negative'}">R$ ${account.current_balance.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td>
                    <td><span class="badge ${account.is_active ? 'bg-success' : 'bg-secondary'}">${account.is_active ? 'Ativa' : 'Inativa'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editAccount(${account.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount(${account.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
        } catch (error) {
            console.error('❌ Erro ao carregar contas:', error);
            document.getElementById('accountsTable').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar contas</td></tr>';
        }
    }
    
    function getAccountTypeLabel(type) {
        const labels = {
            'bank': 'Bancária',
            'cash': 'Caixa',
            'credit_card': 'Cartão',
            'investment': 'Investimento'
        };
        return labels[type] || type;
    }
    
    // Criar nova conta
    document.getElementById('newAccountForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/api/financial/accounts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('newAccountModal')).hide();
                e.target.reset();
                loadAccounts();
                showAlert('success', '✅ Conta criada com sucesso!');
            } else {
                showAlert('danger', '❌ Erro: ' + result.message);
            }
        } catch (error) {
            console.error('❌ Erro ao criar conta:', error);
            showAlert('danger', '❌ Erro ao criar conta');
        }
    });
    
    function editAccount(accountId) {
        showAlert('info', 'Funcionalidade de edição em desenvolvimento');
    }
    
    function deleteAccount(accountId) {
        if (confirm('Tem certeza que deseja excluir esta conta?')) {
            showAlert('info', 'Funcionalidade de exclusão em desenvolvimento');
        }
    }
    
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-remove após 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Carregar dados quando a página carregar
    document.addEventListener('DOMContentLoaded', loadAccounts);
</script>
{% endblock %}
