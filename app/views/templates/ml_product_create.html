{% extends "base.html" %}

{% set editing = is_edit|default(False) %}

{% block title %}{{ 'Editar' if editing else 'Cadastrar' }} Produto no Mercado Livre - {{ user.company.name }}{% endblock %}

{% block head %}
<!-- Cache buster v3 - Novo sistema de imagens + debug atributos -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    .product-image-thumbnail {
        width: 100px;
        height: 100px;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid #dee2e6;
        transition: all 0.3s;
    }
    
    .product-image-thumbnail:hover {
        border-color: #0d6efd;
        transform: scale(1.05);
    }
    
    .image-item {
        position: relative;
        display: inline-block;
        margin-right: 10px;
        margin-bottom: 10px;
    }
    
    .remove-image-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #dc3545;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .remove-image-btn:hover {
        background: #c82333;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        {% if editing %}
            <i class="bi bi-pencil-square"></i> Editar Produto do Mercado Livre
        {% else %}
            <i class="bi bi-plus-square"></i> Cadastrar Produto no Mercado Livre
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/ml/products" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Alerta de feedback -->
<div id="alertContainer"></div>

<!-- Card √∫nico com formul√°rio -->
<div class="card">
    <div class="card-body">
        <form id="productForm">
            {% if editing %}
            <input type="hidden" id="product_id" value="{{ product.id }}">
            {% endif %}
            
            <h5 class="mb-3">Informa√ß√µes B√°sicas</h5>
            
            <!-- Seletor de Conta ML -->
            <div class="mb-3">
                <label for="ml_account_id" class="form-label required-field">Conta do Mercado Livre</label>
                <select class="form-select" id="ml_account_id" name="ml_account_id" required>
                    <option value="">Carregando contas...</option>
                </select>
                <div class="form-text">
                    Escolha a conta onde o produto ser√° publicado
                </div>
            </div>

            {% if editing %}
            <div class="mb-3">
                <label for="status" class="form-label">Status do an√∫ncio</label>
                <select class="form-select" id="status" name="status">
                    {% for option in status_options %}
                    <option value="{{ option.value }}" {% if product.status and product.status|lower == option.value %}selected{% endif %}>{{ option.label }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Defina se o an√∫ncio deve ficar ativo, pausado ou encerrado.</div>
            </div>
            {% else %}
            <input type="hidden" name="status" value="active">
            {% endif %}
            
            <!-- T√≠tulo -->
            <div class="mb-3">
                <label for="title" class="form-label required-field">T√≠tulo do An√∫ncio</label>
                <input type="text" class="form-control" id="title" name="title" 
                       placeholder="Ex: Notebook Dell Inspiron 15 Core i7 16GB RAM 512GB SSD"
                       maxlength="60" required>
                <div class="form-text">
                    <span id="titleCount">0</span>/60 caracteres
                </div>
            </div>
            
            <!-- Categoria com busca inteligente -->
            <div class="mb-3">
                <label class="form-label required-field">Categoria</label>
                
                <div class="form-text text-muted mb-2">
                    <i class="bi bi-lightbulb"></i> Escolha uma das op√ß√µes abaixo para selecionar a categoria
                </div>
                
                <!-- Op√ß√µes de sele√ß√£o -->
                <div class="btn-group mb-2" role="group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="searchCategoryBtn">
                        <i class="bi bi-magic"></i> Sugerir Automaticamente
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="browseCategoryBtn">
                        <i class="bi bi-folder-fill"></i> Navegar por Categorias
                    </button>
                </div>
                
                <!-- Loading spinner -->
                <div id="categoryLoading" class="text-center d-none my-2">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <span class="ms-2 text-muted">Carregando categorias...</span>
                </div>
                
                <!-- Breadcrumb de navega√ß√£o -->
                <nav id="categoryBreadcrumb" class="d-none" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#" onclick="loadRootCategories(); return false;">Categorias</a></li>
                    </ol>
                </nav>
                
                <!-- Lista de sugest√µes/navega√ß√£o -->
                <div id="categorySuggestions" class="list-group mb-2" style="display: none;"></div>
                
                <!-- Campo oculto para category_id (valor final) -->
                <input type="hidden" id="category_id" name="category_id" required value="{% if editing and product.category_id %}{{ product.category_id }}{% endif %}">
                
                <!-- Categoria selecionada -->
                <div id="selectedCategory" class="alert alert-light border mt-2 {% if editing and product.category_id %}{% else %}d-none{% endif %}">
                    <i class="bi bi-check-circle text-success"></i> <strong>Categoria selecionada:</strong>
                    <span id="selectedCategoryName">{% if editing %}{{ product.category_name or product.category_id }}{% endif %}</span>
                    <span class="badge bg-secondary ms-1" id="selectedCategoryId">{% if editing %}{{ product.category_id }}{% endif %}</span>
                </div>
            </div>
            
            <div class="step-section" data-step="4">
                <hr class="my-4">
                <h5 class="mb-3"><i class="bi bi-list-check"></i> Identificadores e Caracter√≠sticas</h5>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="gtin" class="form-label required-field">EAN / GTIN</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="gtin" name="gtin" 
                                   placeholder="Ex: 7891234567890"
                                   pattern="[0-9]{8,14}"
                                   maxlength="14"
                                   title="C√≥digo de barras de 8 a 14 d√≠gitos">
                            <button class="btn btn-outline-secondary" type="button" id="generateGtinBtn" title="Gerar c√≥digo EAN-13 v√°lido">
                                <i class="bi bi-arrow-repeat"></i> Gerar
                            </button>
                        </div>
                        <div class="form-text">
                            C√≥digo de barras do produto (EAN-13, EAN-8, UPC, etc.)
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="seller_custom_field" class="form-label">C√≥digo (SKU)</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="seller_custom_field" name="seller_custom_field" 
                                   placeholder="Ex: ESP32-S3-N16R8"
                                   maxlength="46">
                            <button class="btn btn-outline-secondary" type="button" id="generateSkuBtn" title="Gerar SKU autom√°tico">
                                <i class="bi bi-gear"></i> G/A
                            </button>
                        </div>
                        <div class="form-text">
                            SKU para identificar o produto e vincular nas suas notas fiscais
                        </div>
                    </div>
                </div>
                
                <div id="attributesContainer" class="d-none mb-3">
                    <hr class="my-4">
                    <h5 class="mb-3"><i class="bi bi-list-check"></i> Caracter√≠sticas do Produto</h5>
                    
                    <div id="mainAttributesSection" class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-star-fill"></i> Caracter√≠sticas Principais
                            <span class="badge bg-danger ms-2">Obrigat√≥rias</span>
                        </h6>
                        <span id="mainAttrCount" class="visually-hidden">0</span>
                        <div id="mainAttributesFields"></div>
                    </div>
                    
                    <div id="secondaryAttributesSection" class="mb-4">
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-list-ul"></i> Caracter√≠sticas Secund√°rias
                            <span class="badge bg-secondary ms-2">Opcionais</span>
                        </h6>
                        <span id="secondaryAttrCount" class="visually-hidden">0</span>
                        <div id="secondaryAttributesFields"></div>
                    </div>
                </div>
            </div>
            
            <!-- Condi√ß√£o e Tipo de An√∫ncio -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="condition" class="form-label required-field">Condi√ß√£o</label>
                    <select class="form-select" id="condition" name="condition" required>
                        <option value="">Selecione...</option>
                        <option value="new">Novo</option>
                        <option value="used">Usado</option>
                        <option value="not_specified">N√£o especificado</option>
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="listing_type_id" class="form-label required-field">Tipo de An√∫ncio</label>
                    <select class="form-select" id="listing_type_id" name="listing_type_id" required>
                        <option value="">Selecione...</option>
                        <option value="gold_special">Cl√°ssico</option>
                        <option value="gold_pro">Premium</option>
                        <option value="free">Gratuito</option>
                    </select>
                </div>
            </div>
            
            <hr class="my-4">
            <h5 class="mb-3">Envio e Log√≠stica</h5>
            
            <!-- Modo de Envio -->
            <div class="mb-3">
                <label for="shipping_mode" class="form-label required-field">Modo de Envio</label>
                <select class="form-select" id="shipping_mode" name="shipping_mode" required>
                    <option value="">Selecione...</option>
                    <option value="me2" selected>Mercado Envios (Recomendado)</option>
                    <option value="custom">Envio Personalizado</option>
                    <option value="not_specified">N√£o Especificado (combinar com comprador)</option>
                </select>
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> Mercado Envios gerencia toda a log√≠stica automaticamente
                </div>
            </div>
            
            <!-- Frete Gr√°tis -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="free_shipping" name="free_shipping" checked>
                    <label class="form-check-label" for="free_shipping">
                        <strong>Frete Gr√°tis</strong> (aumenta as vendas)
                    </label>
                </div>
            </div>
            
            <!-- Dimens√µes e Peso -->
            <div class="mb-3">
                <label class="form-label">Dimens√µes e Peso do Pacote</label>
                <div class="form-text mb-2">
                    <i class="bi bi-box"></i> Necess√°rio para calcular o frete. Informe as medidas da embalagem.
                </div>
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <input type="number" class="form-control" id="package_length" name="package_length" 
                               placeholder="Comprimento (cm)" min="1" step="0.1">
                        <small class="text-muted">Comprimento</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="number" class="form-control" id="package_width" name="package_width" 
                               placeholder="Largura (cm)" min="1" step="0.1">
                        <small class="text-muted">Largura</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="number" class="form-control" id="package_height" name="package_height" 
                               placeholder="Altura (cm)" min="1" step="0.1">
                        <small class="text-muted">Altura</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="number" class="form-control" id="package_weight" name="package_weight" 
                               placeholder="Peso (g)" min="1" step="1">
                        <small class="text-muted">Peso em gramas</small>
                    </div>
                </div>
            </div>
            
            <hr class="my-4">
            <h5 class="mb-3">Pre√ßo e Estoque</h5>
            
            <!-- Pre√ßo e Quantidade -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="price" class="form-label required-field">Pre√ßo (R$)</label>
                    <input type="number" class="form-control" id="price" name="price" min="0" step="0.01" required>
                    <div class="form-text">Informe o pre√ßo unit√°rio do an√∫ncio.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="available_quantity" class="form-label required-field">Quantidade Dispon√≠vel</label>
                    <input type="number" class="form-control" id="available_quantity" name="available_quantity" min="0" step="1" required>
                    <div class="form-text">Informe o estoque dispon√≠vel. Para an√∫ncios com varia√ß√µes, ser√° utilizado o somat√≥rio.</div>
                </div>
            </div>

            <div class="mb-4 d-none" id="variationsContainer">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <label class="form-label mb-1">Varia√ß√µes do An√∫ncio</label>
                        <div class="text-muted small" id="variationAttributesSummary"></div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="hasVariationsToggle">
                        <label class="form-check-label" for="hasVariationsToggle">Este produto possui varia√ß√µes</label>
                    </div>
                </div>

                <div id="variationsDetails" class="mt-3 d-none">
                    <div class="alert alert-info py-2" id="variationAttributesInfo"></div>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Total de varia√ß√µes: <span id="variationsCount">0</span></strong>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addVariationBtn">
                                <i class="bi bi-plus-circle"></i> Adicionar varia√ß√£o
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="duplicateVariationBtn" disabled>
                                <i class="bi bi-files"></i> Duplicar √∫ltima
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle mb-0" id="variationsTable">
                            <thead class="table-light">
                                <tr id="variationsTableHeader">
                                    <th scope="col">Varia√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="variationsTableBody">
                                <tr class="text-center text-muted">
                                    <td colspan="5">Ative as varia√ß√µes e clique em "Adicionar varia√ß√£o".</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <input type="hidden" id="has_variations_input" name="has_variations" value="false">
            <input type="hidden" id="variations_json" name="variations_json" value="">
            
            <!-- Descri√ß√£o -->
            <div class="mb-3">
                <label for="description" class="form-label">Descri√ß√£o do Produto</label>
                <textarea class="form-control" id="description" name="description" 
                          rows="6" placeholder="Descreva as caracter√≠sticas do produto..."></textarea>
            </div>
            
            <!-- SKU e Garantia -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label required-field">Garantia</label>
                    <div class="border rounded p-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="warranty_type" id="warranty_none"
                                   value="none" data-label="Sem garantia (Voc√™ n√£o oferece garantia)" checked>
                            <label class="form-check-label" for="warranty_none">
                                Sem garantia (Voc√™ n√£o oferece garantia)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="warranty_type" id="warranty_seller"
                                   value="seller" data-label="Garantia do vendedor">
                            <label class="form-check-label" for="warranty_seller">
                                Garantia do vendedor
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="warranty_type" id="warranty_factory"
                                   value="factory" data-label="Garantia de f√°brica">
                            <label class="form-check-label" for="warranty_factory">
                                Garantia de f√°brica
                            </label>
                        </div>
                    </div>

                    <div id="warrantyDurationGroup" class="mt-3 d-none">
                        <label class="form-label">Tempo de garantia</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="warranty_duration_value" name="warranty_duration_value"
                                   placeholder="Quantidade" min="0" max="999">
                            <select class="form-select" id="warranty_duration_unit" name="warranty_duration_unit" style="max-width: 140px;">
                                <option value="">Selecione...</option>
                                <option value="dias">Dias</option>
                                <option value="meses">Meses</option>
                                <option value="anos">Anos</option>
                            </select>
                        </div>
                        <small class="text-muted">Informe o tempo total oferecido quando houver garantia.</small>
                    </div>

                    <input type="hidden" id="warranty" name="warranty">
                </div>
            </div>
            
            <hr class="my-4">
            <h5 class="mb-3">Imagens do Produto</h5>
            
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Adicione at√© 12 imagens. A primeira ser√° a foto principal.
            </div>
            
            <!-- Input oculto para m√∫ltiplas imagens -->
            <input type="file" id="imageInput" class="d-none" accept="image/*" multiple onchange="handleImageSelect(event)">
            
            <!-- Bot√£o de adicionar imagens -->
            <button type="button" class="btn btn-primary mb-3" onclick="document.getElementById('imageInput').click()">
                <i class="bi bi-plus-circle"></i> Adicionar Imagens
            </button>
            
            <!-- Container de thumbnails -->
            <div id="imageContainer" class="d-flex flex-wrap"></div>
            
            <hr class="my-4">
            
            <!-- Bot√µes de a√ß√£o -->
            <div class="d-flex justify-content-end gap-2">
                <a href="/ml/products" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    {% if editing %}
                    <i class="bi bi-check-circle"></i> Salvar altera√ß√µes
                    {% else %}
                    <i class="bi bi-check-circle"></i> Publicar no Mercado Livre
                    {% endif %}
                </button>
            </div>
            
        </form>
    </div>
</div>

<!-- Modal de varia√ß√µes -->
<div class="modal fade" id="variationModal" tabindex="-1" aria-labelledby="variationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="variationModalLabel">Adicionar varia√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="variationModalAttributes" class="row g-3"></div>
                <hr>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Pre√ßo (R$)</label>
                        <input type="number" class="form-control" id="variation_price" min="0" step="0.01">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estoque</label>
                        <input type="number" class="form-control" id="variation_stock" min="0" step="1">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">SKU da varia√ß√£o</label>
                        <input type="text" class="form-control" id="variation_sku" maxlength="46">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">GTIN / EAN</label>
                        <input type="text" class="form-control" id="variation_gtin" maxlength="14" placeholder="Opcional">
                        <div class="form-text">Informe se cada varia√ß√£o possui GTIN pr√≥prio.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Observa√ß√µes</label>
                        <textarea class="form-control" id="variation_notes" rows="1" placeholder="Opcional"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="saveVariationBtn">
                    <i class="bi bi-check-circle"></i> Salvar varia√ß√£o
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const isEditMode = {{ 'true' if editing else 'false' }};
const initialProductData = {{ product_json | tojson if editing else 'null' }};
const initialWarrantyContext = {{ warranty_context | tojson if editing else 'null' }};
const initialCategoryAttributes = {{ category_attributes | tojson if editing else 'null' }};
console.log('üß≠ initialCategoryAttributes', initialCategoryAttributes);

console.log('üìÑ Script iniciado - ANTES do DOMContentLoaded', { isEditMode, initialProductData });

let uploadedImages = [];
let attributePrefillMap = {};
let variationAttributes = [];
let variationsList = [];
let variationModalInstance = null;
let currentVariationEditingId = null;

function getActiveImageCount() {
    return uploadedImages.filter(item => item !== null).length;
}

window.updateWarrantySummary = function updateWarrantySummary() {
    const warrantyHiddenInput = document.getElementById('warranty');
    const warrantyDurationGroup = document.getElementById('warrantyDurationGroup');
    const warrantyDurationValue = document.getElementById('warranty_duration_value');
    const warrantyDurationUnit = document.getElementById('warranty_duration_unit');
    const selectedTypeInput = document.querySelector('input[name="warranty_type"]:checked');

    if (!warrantyHiddenInput || !selectedTypeInput) {
        return;
    }

    const typeLabel = selectedTypeInput.dataset.label || '';
    const typeValue = selectedTypeInput.value || 'none';
    const requiresDuration = ['seller', 'factory'].includes(typeValue);

    if (warrantyDurationGroup) {
        if (requiresDuration) {
            warrantyDurationGroup.classList.remove('d-none');
            if (warrantyDurationValue) warrantyDurationValue.required = true;
            if (warrantyDurationUnit) warrantyDurationUnit.required = true;
        } else {
            warrantyDurationGroup.classList.add('d-none');
            if (warrantyDurationValue) {
                warrantyDurationValue.required = false;
                warrantyDurationValue.value = '';
            }
            if (warrantyDurationUnit) {
                warrantyDurationUnit.required = false;
                warrantyDurationUnit.value = '';
            }
        }
    }

    let summary = typeLabel;
    if (requiresDuration && warrantyDurationValue && warrantyDurationUnit && warrantyDurationValue.value && warrantyDurationUnit.value) {
        const unitLabel = warrantyDurationUnit.options[warrantyDurationUnit.selectedIndex]?.text || warrantyDurationUnit.value;
        summary = `${typeLabel} - ${warrantyDurationValue.value} ${unitLabel}`;
    }

    warrantyHiddenInput.value = summary;
};

// Garantir que o DOM esteja carregado antes de vincular eventos
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOMContentLoaded disparado - P√°gina de cadastro de produto carregada');
    console.log('Tentando encontrar bot√£o searchCategoryBtn...');
    
    // ========== CARREGAR CONTAS ML ==========
    async function loadMLAccounts() {
        try {
            const response = await fetch('/ml/products/api/accounts', {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error('Erro ao carregar contas');
            }
            
            const data = await response.json();
            const accountSelect = document.getElementById('ml_account_id');
            
            if (data.success && data.accounts && data.accounts.length > 0) {
                accountSelect.innerHTML = '<option value="">Selecione uma conta...</option>';
                
                data.accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = `${account.nickname} (${account.email})`;
                    if (account.is_primary) {
                        option.textContent += ' ‚≠ê Principal';
                        if (!isEditMode) {
                            option.selected = true;
                        }
                    }
                    accountSelect.appendChild(option);
                });
                
                if (isEditMode && initialProductData?.ml_account_id) {
                    accountSelect.value = String(initialProductData.ml_account_id);
                }

                console.log(`‚úÖ ${data.accounts.length} conta(s) ML carregada(s)`);
            } else {
                accountSelect.innerHTML = '<option value="">Nenhuma conta encontrada</option>';
                showAlert('warning', '‚ö†Ô∏è Nenhuma conta do Mercado Livre encontrada. <a href="/ml/accounts">Conecte uma conta</a> primeiro.');
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar contas ML:', error);
            const accountSelect = document.getElementById('ml_account_id');
            accountSelect.innerHTML = '<option value="">Erro ao carregar contas</option>';
            showAlert('danger', '‚ùå Erro ao carregar contas do Mercado Livre. Recarregue a p√°gina.');
        }
    }
    
    // Carregar contas ao iniciar
    const accountsPromise = loadMLAccounts();
    
    // ========== GERAR GTIN (EAN-13) ==========
    function generateEAN13() {
        // Gerar 12 d√≠gitos aleat√≥rios (come√ßando com 789 para Brasil)
        let code = '789' + Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
        
        // Calcular d√≠gito verificador
        let sum = 0;
        for (let i = 0; i < 12; i++) {
            let digit = parseInt(code[i]);
            // Multiplica por 1 se posi√ß√£o √≠mpar, por 3 se posi√ß√£o par (contando da direita)
            sum += (i % 2 === 0) ? digit : digit * 3;
        }
        
        // D√≠gito verificador = 10 - (soma % 10), ou 0 se der 10
        let checkDigit = (10 - (sum % 10)) % 10;
        
        return code + checkDigit;
    }
    
    document.getElementById('generateGtinBtn').addEventListener('click', function() {
        const gtinInput = document.getElementById('gtin');
        const newGtin = generateEAN13();
        gtinInput.value = newGtin;
        
        // Feedback visual
        gtinInput.classList.add('border-success');
        setTimeout(() => {
            gtinInput.classList.remove('border-success');
        }, 1000);
        
        console.log('‚úÖ GTIN/EAN-13 gerado:', newGtin);
    });
    
    // ========== GERAR SKU AUTOM√ÅTICO (G/A) ==========
    function generateAutoSKU() {
        // Gera SKU baseado em timestamp + random (ex: SKU-2025110812345-ABC)
        const timestamp = Date.now().toString().slice(-10);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        return `SKU-${timestamp}-${random}`;
    }
    
    document.getElementById('generateSkuBtn').addEventListener('click', function() {
        const skuInput = document.getElementById('seller_custom_field');
        const newSku = generateAutoSKU();
        skuInput.value = newSku;
        
        // Feedback visual
        skuInput.classList.add('border-success');
        setTimeout(() => {
            skuInput.classList.remove('border-success');
        }, 1000);
        
        console.log('‚úÖ SKU autom√°tico gerado:', newSku);
    });
    
    // Contador de caracteres do t√≠tulo
    document.getElementById('title').addEventListener('input', function() {
        document.getElementById('titleCount').textContent = this.value.length;
    });
    
    // ========== GARANTIA ==========
    const warrantyTypeInputs = document.querySelectorAll('input[name="warranty_type"]');
    warrantyTypeInputs.forEach((input) => {
        input.addEventListener('change', updateWarrantySummary);
    });

    const warrantyDurationValue = document.getElementById('warranty_duration_value');
    if (warrantyDurationValue) {
        warrantyDurationValue.addEventListener('input', updateWarrantySummary);
    }

    const warrantyDurationUnit = document.getElementById('warranty_duration_unit');
    if (warrantyDurationUnit) {
        warrantyDurationUnit.addEventListener('change', updateWarrantySummary);
    }

    if (isEditMode) {
        accountsPromise.then(() => initializeEditMode());
    }

    updateWarrantySummary();

    // ========== BUSCA DE CATEGORIA ==========
    // Bot√£o de busca de categoria - usa o t√≠tulo do an√∫ncio automaticamente
    const searchCategoryBtn = document.getElementById('searchCategoryBtn');
    if (searchCategoryBtn) {
        console.log('‚úÖ Bot√£o de busca de categoria encontrado');
        searchCategoryBtn.addEventListener('click', async function() {
            console.log('üîç Bot√£o clicado!');
    const titleInput = document.getElementById('title');
    const searchQuery = titleInput.value.trim();
    
    if (!searchQuery) {
        showAlert('warning', '‚ö†Ô∏è Por favor, digite o t√≠tulo do produto primeiro para sugerir categorias.');
        titleInput.focus();
        return;
    }
    
    // Mostrar loading
    document.getElementById('categoryLoading').classList.remove('d-none');
    document.getElementById('categorySuggestions').style.display = 'none';
    document.getElementById('selectedCategory').classList.add('d-none');
    
    try {
        console.log('üîç Buscando categorias para:', searchQuery);
        
        const response = await fetch(`/ml/products/categories/predict?q=${encodeURIComponent(searchQuery)}&limit=5`, {
            credentials: 'include'
        });
        
        const data = await response.json();
        
        document.getElementById('categoryLoading').classList.add('d-none');
        
        if (data.success && data.suggestions && data.suggestions.length > 0) {
            console.log('‚úÖ Encontradas', data.suggestions.length, 'categorias');
            displayCategorySuggestions(data.suggestions);
        } else {
            showAlert('info', 'üìã Nenhuma categoria encontrada. Tente ajustar o t√≠tulo do produto.');
        }
    } catch (error) {
        console.error('‚ùå Erro ao buscar categorias:', error);
        document.getElementById('categoryLoading').classList.add('d-none');
        showAlert('danger', '‚ùå Erro ao buscar categorias. Tente novamente.');
    }
        });
    } else {
        console.error('‚ùå Bot√£o de busca de categoria n√£o encontrado!');
    }
    
    // Bot√£o de navegar por categorias
    const browseCategoryBtn = document.getElementById('browseCategoryBtn');
    if (browseCategoryBtn) {
        console.log('‚úÖ Bot√£o de navegar categorias encontrado');
        browseCategoryBtn.addEventListener('click', function() {
            console.log('üìÇ Navega√ß√£o manual iniciada');
            loadRootCategories();
        });
    } else {
        console.error('‚ùå Bot√£o de navegar categorias n√£o encontrado!');
    }

    variationModalInstance = new bootstrap.Modal(document.getElementById('variationModal'));

    const hasVariationsToggle = document.getElementById('hasVariationsToggle');
    if (hasVariationsToggle) {
        hasVariationsToggle.addEventListener('change', onToggleVariations);
    }

    document.getElementById('addVariationBtn')?.addEventListener('click', () => openVariationModal());
    document.getElementById('duplicateVariationBtn')?.addEventListener('click', duplicateLastVariation);
    document.getElementById('saveVariationBtn')?.addEventListener('click', saveVariationFromModal);

}); // Fecha o DOMContentLoaded

async function initializeEditMode() {
    if (!isEditMode || !initialProductData) {
        return;
    }

    console.log('‚úèÔ∏è Inicializando modo edi√ß√£o', initialProductData);

    const titleInput = document.getElementById('title');
    if (titleInput) {
        titleInput.value = initialProductData.title || '';
        document.getElementById('titleCount').textContent = titleInput.value.length;
    }

    const priceInput = document.getElementById('price');
    if (priceInput && initialProductData.price) {
        const numericPrice = parseFloat(String(initialProductData.price).replace(',', '.'));
        if (!Number.isNaN(numericPrice)) {
            priceInput.value = numericPrice.toFixed(2);
        } else {
            priceInput.value = initialProductData.price;
        }
    }

    const quantityInput = document.getElementById('available_quantity');
    if (quantityInput && initialProductData.available_quantity !== undefined && initialProductData.available_quantity !== null) {
        quantityInput.value = initialProductData.available_quantity;
    }

    const descriptionInput = document.getElementById('description');
    if (descriptionInput) {
        descriptionInput.value = initialProductData.description || '';
    }

    const listingTypeSelect = document.getElementById('listing_type_id');
    if (listingTypeSelect && initialProductData.listing_type_id) {
        listingTypeSelect.value = initialProductData.listing_type_id;
    }

    const conditionSelect = document.getElementById('condition');
    if (conditionSelect && initialProductData.condition) {
        conditionSelect.value = initialProductData.condition;
    }

    const statusSelect = document.getElementById('status');
    if (statusSelect && initialProductData.status) {
        statusSelect.value = String(initialProductData.status).toLowerCase();
    }

    const skuInput = document.getElementById('seller_custom_field');
    if (skuInput) {
        skuInput.value = initialProductData.seller_custom_field || initialProductData.seller_sku || '';
    }

    const warrantyHiddenInput = document.getElementById('warranty');
    if (warrantyHiddenInput && initialProductData.warranty) {
        warrantyHiddenInput.value = initialProductData.warranty;
    }

    const shipping = initialProductData.shipping || {};
    const shippingModeSelect = document.getElementById('shipping_mode');
    if (shippingModeSelect && shipping.mode) {
        shippingModeSelect.value = shipping.mode;
    }

    const freeShippingCheckbox = document.getElementById('free_shipping');
    if (freeShippingCheckbox) {
        freeShippingCheckbox.checked = Boolean(initialProductData.free_shipping);
    }

    if (shipping.dimensions) {
        const [dimensionsPart, weightPart] = shipping.dimensions.split(',');
        if (dimensionsPart) {
            const [length, width, height] = dimensionsPart.split('x');
            const lengthInput = document.getElementById('package_length');
            const widthInput = document.getElementById('package_width');
            const heightInput = document.getElementById('package_height');
            if (lengthInput && length) lengthInput.value = length;
            if (widthInput && width) widthInput.value = width;
            if (heightInput && height) heightInput.value = height;
        }
        if (weightPart) {
            const weightInput = document.getElementById('package_weight');
            if (weightInput) weightInput.value = weightPart;
        }
    }

    seedExistingImages(initialProductData.pictures || []);

    if (initialWarrantyContext) {
        const typeRadio = document.querySelector(`input[name="warranty_type"][value="${initialWarrantyContext.type || 'none'}"]`);
        if (typeRadio) {
            typeRadio.checked = true;
        }
        const durationValueInput = document.getElementById('warranty_duration_value');
        if (durationValueInput && initialWarrantyContext.duration_value) {
            durationValueInput.value = initialWarrantyContext.duration_value;
        }
        const durationUnitSelect = document.getElementById('warranty_duration_unit');
        if (durationUnitSelect && initialWarrantyContext.duration_unit) {
            durationUnitSelect.value = initialWarrantyContext.duration_unit;
        }
    }

    updateWarrantySummary();

    const prefillMap = {};
    (initialProductData.attributes || []).forEach(attr => {
        if (attr && attr.id) {
            prefillMap[attr.id] = attr;
        }
    });

    const gtinField = document.getElementById('gtin');
    const mpnField = document.getElementById('mpn');
    if (gtinField) {
        const gtinAttr = prefillMap['GTIN'] || prefillMap['EAN'] || prefillMap['UPC'] || null;
        if (gtinAttr) {
            gtinField.value = gtinAttr.value_name || gtinAttr.value_id || '';
        }
    }
    if (mpnField && prefillMap['MPN']) {
        mpnField.value = prefillMap['MPN'].value_name || prefillMap['MPN'].value_id || '';
    }

    if (initialProductData.category_id) {
        let categoryName = initialProductData.category_name || initialProductData.category_id;
        let pathFromRoot = null;

        const categoryDetails = await fetchCategoryDetails(initialProductData.category_id);
        if (categoryDetails) {
            if (categoryDetails.name) {
                categoryName = categoryDetails.name;
            }
            if (Array.isArray(categoryDetails.path_from_root)) {
                pathFromRoot = buildPathFromRoot(categoryDetails.path_from_root);
            }
        }

        await selectCategory(
            initialProductData.category_id,
            categoryName,
            prefillMap,
            pathFromRoot,
            initialCategoryAttributes
        );
    }

    prefillVariationsFromApi(initialProductData.variations || []);

    updateAttributeCounts();
}

// ========== FUN√á√ïES GLOBAIS ==========

// Vari√°vel global para controlar o caminho de navega√ß√£o
let categoryPath = [];

// Carregar categorias principais
async function loadRootCategories() {
    categoryPath = [];
    document.getElementById('categoryLoading').classList.remove('d-none');
    document.getElementById('categorySuggestions').style.display = 'none';
    document.getElementById('selectedCategory').classList.add('d-none');
    document.getElementById('categoryBreadcrumb').classList.add('d-none');
    
    try {
        const response = await fetch('/ml/products/categories', {
            credentials: 'include'
        });
        
        const data = await response.json();
        
        document.getElementById('categoryLoading').classList.add('d-none');
        
        if (data.success && data.categories) {
            displayCategoriesTree(data.categories, true);
        } else {
            showAlert('danger', '‚ùå Erro ao carregar categorias principais.');
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar categorias:', error);
        document.getElementById('categoryLoading').classList.add('d-none');
        showAlert('danger', '‚ùå Erro ao carregar categorias.');
    }
}

async function fetchCategoryDetails(categoryId) {
    try {
        const response = await fetch(`/ml/products/categories/${categoryId}`, {
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            return null;
        }

        const data = await response.json();
        if (!data.success || !data.category) {
            return null;
        }

        return data.category;
    } catch (error) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar detalhes da categoria', categoryId, error);
        return null;
    }
}

function buildPathFromRoot(pathArray) {
    if (!Array.isArray(pathArray)) {
        return [];
    }

    return pathArray.map(node => ({
        id: node.id,
        name: node.name
    }));
}

// Carregar subcategorias
async function loadCategoryChildren(categoryId, categoryName) {
    document.getElementById('categoryLoading').classList.remove('d-none');
    document.getElementById('categorySuggestions').style.display = 'none';
    
    try {
        const response = await fetch(`/ml/products/categories/${categoryId}`, {
            credentials: 'include'
        });
        
        const data = await response.json();
        
        document.getElementById('categoryLoading').classList.add('d-none');
        
        if (data.success && data.category) {
            const category = data.category;
            
            // Adicionar ao caminho de navega√ß√£o
            categoryPath.push({ id: categoryId, name: categoryName });
            
            // Se tem subcategorias, mostrar
            if (category.children_categories && category.children_categories.length > 0) {
                updateBreadcrumb();
                displayCategoriesTree(category.children_categories, false);
            } else {
                // √â categoria final, selecionar automaticamente
                selectCategory(categoryId, categoryName);
            }
        } else {
            showAlert('danger', '‚ùå Erro ao carregar subcategorias.');
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar subcategorias:', error);
        document.getElementById('categoryLoading').classList.add('d-none');
        showAlert('danger', '‚ùå Erro ao carregar subcategorias.');
    }
}

// Exibir √°rvore de categorias
function displayCategoriesTree(categories, isRoot = false) {
    const container = document.getElementById('categorySuggestions');
    container.innerHTML = '';
    
    categories.forEach((cat) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        
        item.innerHTML = `
            <span>${cat.name}</span>
            <i class="bi bi-chevron-right text-muted"></i>
        `;
        
        item.addEventListener('click', function() {
            loadCategoryChildren(cat.id, cat.name);
        });
        
        container.appendChild(item);
    });
    
    container.style.display = 'block';
}

// Atualizar breadcrumb
function updateBreadcrumb() {
    const breadcrumb = document.getElementById('categoryBreadcrumb');
    const ol = breadcrumb.querySelector('ol');
    
    // Limpar breadcrumb exceto o primeiro item
    ol.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="loadRootCategories(); return false;">Categorias</a></li>';
    
    // Adicionar itens do caminho
    categoryPath.forEach((path, index) => {
        const li = document.createElement('li');
        li.className = 'breadcrumb-item';
        
        if (index === categoryPath.length - 1) {
            li.classList.add('active');
            li.textContent = path.name;
        } else {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = path.name;
            a.onclick = function() {
                navigateToPath(index);
                return false;
            };
            li.appendChild(a);
        }
        
        ol.appendChild(li);
    });
    
    breadcrumb.classList.remove('d-none');
}

// Navegar para um ponto espec√≠fico do caminho
function navigateToPath(index) {
    if (index === -1) {
        loadRootCategories();
    } else {
        const targetCategory = categoryPath[index];
        categoryPath = categoryPath.slice(0, index + 1);
        loadCategoryChildren(targetCategory.id, targetCategory.name);
    }
}
// Exibir sugest√µes de categoria (modo autom√°tico)
function displayCategorySuggestions(suggestions) {
    const container = document.getElementById('categorySuggestions');
    container.innerHTML = '';
    document.getElementById('categoryBreadcrumb').classList.add('d-none');
    
    suggestions.forEach((suggestion, index) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        
        // Destacar a primeira sugest√£o (mais relevante) com borda
        if (index === 0) {
            item.classList.add('border-success');
            item.style.borderWidth = '2px';
        }
        
        const content = document.createElement('div');
        content.innerHTML = `
            <strong>${suggestion.category_name}</strong>
            ${index === 0 ? '<span class="badge bg-success ms-2">Recomendada</span>' : ''}
            <br>
            <small class="text-muted">ID: ${suggestion.category_id}</small>
            ${suggestion.domain_name ? `<br><small class="text-secondary"><i class="bi bi-tag"></i> ${suggestion.domain_name}</small>` : ''}
        `;
        
        const icon = document.createElement('i');
        icon.className = 'bi bi-check-circle text-muted';
        
        item.appendChild(content);
        item.appendChild(icon);
        
        item.addEventListener('click', function() {
            selectCategory(suggestion.category_id, suggestion.category_name);
        });
        
        container.appendChild(item);
    });
    
    container.style.display = 'block';
}

// Selecionar categoria
async function selectCategory(categoryId, categoryName, prefillValues = null, pathFromRoot = null, prefetchedAttributes = null) {
    // Preencher campo oculto
    document.getElementById('category_id').value = categoryId;

    attributePrefillMap = prefillValues || {};
    
    // Mostrar categoria selecionada
    document.getElementById('selectedCategoryName').textContent = categoryName;
    document.getElementById('selectedCategoryId').textContent = categoryId;
    document.getElementById('selectedCategory').classList.remove('d-none');

    if (Array.isArray(pathFromRoot) && pathFromRoot.length > 0) {
        categoryPath = pathFromRoot.map(node => ({ id: node.id, name: node.name }));
        updateBreadcrumb();
    } else {
        categoryPath = [];
        document.getElementById('categoryBreadcrumb').classList.add('d-none');
    }
    
    // Ocultar sugest√µes
    document.getElementById('categorySuggestions').style.display = 'none';
    
    console.log('‚úÖ Categoria selecionada:', categoryId, '-', categoryName);
    
    if (prefetchedAttributes && (prefetchedAttributes.main_attributes || prefetchedAttributes.other_attributes)) {
        variationAttributes = prefetchedAttributes.variation_attributes || [];
        renderCategoryAttributes(
            prefetchedAttributes.main_attributes || [],
            prefetchedAttributes.other_attributes || []
        );
        setupVariationAttributesUI();
    }

    await loadCategoryAttributes(categoryId);
}

function renderCategoryAttributes(mainAttributes, otherAttributes) {
    const attributesContainer = document.getElementById('attributesContainer');
    const mainAttributesFields = document.getElementById('mainAttributesFields');
    const secondaryAttributesFields = document.getElementById('secondaryAttributesFields');
    const mainAttrCount = document.getElementById('mainAttrCount');
    const secondaryAttrCount = document.getElementById('secondaryAttrCount');

    attributesContainer.classList.remove('d-none');

    if (Array.isArray(mainAttributes) && mainAttributes.length > 0) {
        mainAttributesFields.innerHTML = '';
        mainAttributes.forEach(attr => {
            const fieldHtml = createAttributeField(attr, true);
            if (fieldHtml) {
                mainAttributesFields.insertAdjacentHTML('beforeend', fieldHtml);
            }
        });
        mainAttrCount.textContent = '0';
    } else {
        mainAttributesFields.innerHTML = '<p class="text-muted"><i class="bi bi-check-circle"></i> Nenhuma caracter√≠stica principal obrigat√≥ria para esta categoria.</p>';
        mainAttrCount.textContent = '0';
    }

    if (Array.isArray(otherAttributes) && otherAttributes.length > 0) {
        secondaryAttributesFields.innerHTML = '';
        otherAttributes.forEach(attr => {
            const fieldHtml = createAttributeField(attr, false);
            if (fieldHtml) {
                secondaryAttributesFields.insertAdjacentHTML('beforeend', fieldHtml);
            }
        });
        secondaryAttrCount.textContent = '0';
    } else {
        secondaryAttributesFields.innerHTML = '<p class="text-muted"><i class="bi bi-info-circle"></i> Nenhuma caracter√≠stica secund√°ria dispon√≠vel para esta categoria.</p>';
        secondaryAttrCount.textContent = '0';
    }

    addAttributeCountListeners();
    updateAttributeCounts();
}

async function loadCategoryAttributes(categoryId) {
    console.log('üîç Buscando atributos para categoria:', categoryId);

    const mainAttributesFields = document.getElementById('mainAttributesFields');
    const secondaryAttributesFields = document.getElementById('secondaryAttributesFields');

    mainAttributesFields.innerHTML = '<div class="text-center text-muted my-3"><span class="spinner-border spinner-border-sm"></span> Carregando caracter√≠sticas principais...</div>';
    secondaryAttributesFields.innerHTML = '<div class="text-center text-muted my-3"><span class="spinner-border spinner-border-sm"></span> Carregando caracter√≠sticas secund√°rias...</div>';

    try {
        const response = await fetch(`/ml/products/categories/${categoryId}/attributes`, {
            method: 'GET',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`Erro ${response.status} ao buscar atributos`);
        }

        const data = await response.json();
        if (!data.success) {
            throw new Error(data.error || 'Erro ao buscar atributos');
        }

        variationAttributes = data.variation_attributes || [];
        console.log('üì¶ variationAttributes carregados:', variationAttributes);
        setupVariationAttributesUI();
        renderCategoryAttributes(data.main_attributes || [], data.other_attributes || []);

    } catch (error) {
        console.error('‚ùå Erro ao carregar atributos:', error);
        mainAttributesFields.innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                N√£o foi poss√≠vel carregar as caracter√≠sticas desta categoria: ${error.message}
            </div>
        `;
        secondaryAttributesFields.innerHTML = '';
    }
}

// Adicionar listeners para contar atributos preenchidos
function addAttributeCountListeners() {
    const mainInputs = document.querySelectorAll('#mainAttributesFields input, #mainAttributesFields select');
    const secondaryInputs = document.querySelectorAll('#secondaryAttributesFields input, #secondaryAttributesFields select');
    
    mainInputs.forEach(input => {
        input.addEventListener('change', updateAttributeCounts);
        input.addEventListener('input', updateAttributeCounts);
    });
    
    secondaryInputs.forEach(input => {
        input.addEventListener('change', updateAttributeCounts);
        input.addEventListener('input', updateAttributeCounts);
    });
}

// Atualizar contadores de atributos preenchidos
function updateAttributeCounts() {
    // Contar principais
    const mainInputs = document.querySelectorAll('#mainAttributesFields input, #mainAttributesFields select');
    let mainFilled = 0;
    mainInputs.forEach(input => {
        if (input.value && input.value.trim() !== '' && input.value !== 'Selecione...') {
            mainFilled++;
        }
    });
    document.getElementById('mainAttrCount').textContent = mainFilled;
    
    // Contar secund√°rios
    const secondaryInputs = document.querySelectorAll('#secondaryAttributesFields input, #secondaryAttributesFields select');
    let secondaryFilled = 0;
    secondaryInputs.forEach(input => {
        if (input.value && input.value.trim() !== '' && input.value !== 'Selecione...') {
            secondaryFilled++;
        }
    });
    document.getElementById('secondaryAttrCount').textContent = secondaryFilled;
}

function fillAttributeWithGTIN(fieldId) {
    const gtinInput = document.getElementById('gtin');
    const target = document.getElementById(fieldId);

    if (!target) {
        return;
    }

    if (!gtinInput || !gtinInput.value) {
        showAlert('warning', 'Preencha o campo GTIN antes de copiar para as caracter√≠sticas.');
        gtinInput?.focus();
        return;
    }

    target.value = gtinInput.value;
    target.dispatchEvent(new Event('input', { bubbles: true }));
    target.classList.add('border-success');
    setTimeout(() => target.classList.remove('border-success'), 800);

    updateAttributeCounts();
}

// Criar campo HTML baseado no tipo de atributo
function createAttributeField(attribute, isMainAttribute = false) {
    const fieldId = `attr_${attribute.id}`;
    const tags = attribute.tags || {};
    const tagsArray = Array.isArray(tags) ? tags : null;
    const tagsObject = !tagsArray ? tags : {};

    const existingAttr = attributePrefillMap ? attributePrefillMap[attribute.id] : null;
    const sanitizeValue = (val) => val ? String(val).replace(/"/g, '&quot;') : '';
    const existingValueId = existingAttr?.value_id || '';
    const existingValueName = existingAttr?.value_name || '';
    const existingStruct = existingAttr?.value_struct || null;

    const hasRequiredTag = attribute.__is_required === true
        || attribute.required === true
        || (tagsArray ? tagsArray.includes('required') : false)
        || (tagsObject && (tagsObject.required || tagsObject.mandatory || tagsObject.catalog_required));

    const isRequired = isMainAttribute || hasRequiredTag;
    const requiredClass = isRequired ? 'required-field' : '';
    const requiredAttr = isRequired ? 'required' : '';
    let valueMode = 'name';
    const hint = attribute.hint || 'Por favor, inclua este dado para que seus compradores tenham mais informa√ß√µes para te escolher.';
    const attributeIdUpper = attribute.id ? attribute.id.toUpperCase() : '';
    const attributeNameLower = attribute.name ? attribute.name.toLowerCase() : '';

    if (attributeIdUpper.includes('GTIN')) {
        return '';
    }

    const isUniversalCodeAttribute = attributeIdUpper.includes('UNIVERSAL') ||
        attributeNameLower.includes('c√≥digo universal de produto');
    const isModelAttribute = attributeIdUpper.includes('MODEL') || attributeNameLower === 'modelo';

    if (isUniversalCodeAttribute) {
        valueMode = 'name';
        return `
            <div class="mb-3 border-bottom pb-3">
                <label for="${fieldId}" class="form-label ${requiredClass}">
                    ${attribute.name}
                    ${isRequired ? ' <span class="text-danger">(obrigat√≥rio)</span>' : ''}
                </label>
                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="${fieldId}" 
                               name="attr_${attribute.id}" 
                               placeholder="Copie o GTIN acima ou informe outro c√≥digo"
                               maxlength="14"
                               value="${sanitizeValue(existingValueName)}"
                               ${requiredAttr}>
                    </div>
                    <div class="col-md-4 d-grid">
                        <button type="button" class="btn btn-outline-secondary" onclick="fillAttributeWithGTIN('${fieldId}')">
                            Usar GTIN preenchido acima
                        </button>
                    </div>
                </div>
                <input type="hidden" name="attr_mode_${attribute.id}" value="${valueMode}">
                <input type="hidden" name="attr_type_${attribute.id}" value="${attribute.value_type || ''}">
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> Pode ser um EAN, UPC ou outro GTIN. Este campo ser√° enviado como caracter√≠stica da categoria.
                </div>
            </div>
        `;
    }

    if (isModelAttribute) {
        valueMode = 'name';
        return `
            <div class="mb-3 border-bottom pb-3">
                <label for="${fieldId}" class="form-label ${requiredClass}">
                    ${attribute.name}
                    ${isRequired ? ' <span class="text-danger">(obrigat√≥rio)</span>' : ''}
                </label>
                <input type="text" class="form-control" id="${fieldId}" 
                       name="attr_${attribute.id}" 
                       placeholder="Informe o modelo exato do produto"
                       maxlength="120"
                       value="${sanitizeValue(existingValueName)}"
                       ${requiredAttr}>
                <input type="hidden" name="attr_mode_${attribute.id}" value="${valueMode}">
                <input type="hidden" name="attr_type_${attribute.id}" value="${attribute.value_type || ''}">
                ${!isRequired ? `
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="${fieldId}_na" 
                               onchange="toggleNotApplicable('${fieldId}', this.checked)">
                        <label class="form-check-label text-muted" for="${fieldId}_na">
                            N√£o se aplica
                        </label>
                    </div>
                ` : ''}
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> Por favor, inclua este dado para que seus compradores tenham mais informa√ß√µes para te escolher.
                </div>
            </div>
        `;
    }

    let fieldHTML = `
        <div class="mb-3 border-bottom pb-3">
            <label for="${fieldId}" class="form-label ${requiredClass}">
                ${attribute.name}
                ${isRequired ? ' <span class="text-danger">(obrigat√≥rio)</span>' : ''}
            </label>
    `;
    
    // Se tem valores predefinidos (select dropdown)
    if (attribute.values && attribute.values.length > 0) {
        valueMode = 'id';
        fieldHTML += `
            <select class="form-select" id="${fieldId}" name="attr_${attribute.id}" ${requiredAttr}>
                <option value="">Selecione...</option>
        `;
        
        attribute.values.forEach(value => {
            const selected = value.id === existingValueId ? 'selected' : '';
            fieldHTML += `<option value="${value.id}" ${selected}>${value.name}</option>`;
        });
        
        fieldHTML += `</select>`;
    } 
    // N√∫mero com unidade (ex: 240 MHz, 512 KB)
    else if (attribute.value_type === 'number_unit') {
        valueMode = 'name';
        const unitId = `${fieldId}_unit`;
        let defaultNumber = '';
        let defaultUnit = '';
        if (existingStruct && typeof existingStruct.number !== 'undefined') {
            defaultNumber = existingStruct.number;
            defaultUnit = existingStruct.unit || '';
        } else if (existingValueName) {
            const regex = /(\d+[\.,]?\d*)\s*(.+)?/;
            const match = existingValueName.match(regex);
            if (match) {
                defaultNumber = match[1].replace(',', '.');
                defaultUnit = match[2]?.trim() || '';
            }
        }
        fieldHTML += `
            <div class="row g-2">
                <div class="col-md-6">
                    <input type="number" class="form-control" id="${fieldId}" 
                           name="attr_${attribute.id}" 
                           placeholder="Ex: 240"
                           value="${sanitizeValue(defaultNumber)}"
                           step="0.01"
                           ${requiredAttr}>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="${unitId}" name="attr_${attribute.id}_unit" ${requiredAttr}>
                        <option value="">Selecione...</option>
        `;
        
        if (attribute.allowed_units) {
            attribute.allowed_units.forEach(unit => {
                const selected = unit.id === defaultUnit || unit.name === defaultUnit ? 'selected' : '';
                fieldHTML += `<option value="${unit.id}" ${selected}>${unit.name}</option>`;
            });
        }
        
        fieldHTML += `
                    </select>
                </div>
            </div>
        `;
        if (attribute.allowed_units && attribute.allowed_units.length > 0) {
            fieldHTML += `<small class="text-muted">Unidades sugeridas: ${attribute.allowed_units.map(u => u.name).join(', ')}</small>`;
        }
    }
    // N√∫mero simples
    else if (attribute.value_type === 'number') {
        valueMode = 'name';
        fieldHTML += `
            <input type="number" class="form-control" id="${fieldId}" 
                   name="attr_${attribute.id}" 
                   placeholder="Digite o valor"
                   step="any"
                   value="${sanitizeValue(existingValueName)}"
                   ${requiredAttr}>
        `;
    }
    // Boolean (Sim/N√£o)
    else if (attribute.value_type === 'boolean') {
        valueMode = 'name';
        let boolChecked = false;
        if (typeof existingValueName === 'string') {
            const normalized = existingValueName.toLowerCase();
            boolChecked = ['true', 'sim', 'yes', '1'].includes(normalized);
        } else if (existingValueName) {
            boolChecked = Boolean(existingValueName);
        }
        fieldHTML += `
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="${fieldId}" name="attr_${attribute.id}" ${boolChecked ? 'checked' : ''}>
                <label class="form-check-label" for="${fieldId}">
                    ${hint}
                </label>
            </div>
        `;
    }
    // Texto padr√£o (string, list)
    else {
        valueMode = 'name';
        fieldHTML += `
            <input type="text" class="form-control" id="${fieldId}" 
                   name="attr_${attribute.id}" 
                   placeholder="Ex: ${attribute.value_type === 'number' ? '100' : 'Azul'}"
                   value="${sanitizeValue(existingValueName)}"
                   ${requiredAttr}>
        `;
    }
    
    fieldHTML += `<input type="hidden" name="attr_mode_${attribute.id}" value="${valueMode}">`;
    fieldHTML += `<input type="hidden" name="attr_type_${attribute.id}" value="${attribute.value_type || ''}">`;
    
    // Bot√£o "N√£o se aplica" para atributos opcionais
    if (!isRequired) {
        fieldHTML += `
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="${fieldId}_na" 
                       onchange="toggleNotApplicable('${fieldId}', this.checked)">
                <label class="form-check-label text-muted" for="${fieldId}_na">
                    N√£o se aplica
                </label>
            </div>
        `;
    }
    
    // Dica/hint
    if (hint && hint !== attribute.name) {
        fieldHTML += `<div class="form-text"><i class="bi bi-info-circle"></i> ${hint}</div>`;
    }
    
    fieldHTML += `</div>`;
    
    return fieldHTML;
}

// Toggle "N√£o se aplica" para atributos opcionais
function toggleNotApplicable(fieldId, isChecked) {
    const field = document.getElementById(fieldId);
    const unitField = document.getElementById(`${fieldId}_unit`);
    
    if (isChecked) {
        field.value = '';
        field.disabled = true;
        field.removeAttribute('required');
        if (unitField) {
            unitField.value = '';
            unitField.disabled = true;
        }
    } else {
        field.disabled = false;
        if (unitField) {
            unitField.disabled = false;
        }
    }
    
    updateAttributeCounts();
}

// Upload de imagens - NOVO SISTEMA
function handleImageSelect(event) {
    const files = Array.from(event.target.files || []);
    const currentCount = getActiveImageCount();

    if (currentCount + files.length > 12) {
        showAlert('warning', `‚ö†Ô∏è Voc√™ pode adicionar no m√°ximo 12 imagens. Atualmente voc√™ tem ${currentCount} imagens.`);
        return;
    }

    files.forEach(file => {
        if (!file.type.startsWith('image/')) {
            showAlert('warning', `‚ö†Ô∏è O arquivo ${file.name} n√£o √© uma imagem v√°lida.`);
            return;
        }

        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
            showAlert('warning', `‚ö†Ô∏è ${file.name} ultrapassa o limite de 10 MB.`);
            return;
        }

        const validTypes = ['image/jpeg', 'image/png'];
        if (!validTypes.includes(file.type)) {
            showAlert('warning', `‚ö†Ô∏è ${file.name} precisa estar em JPEG ou PNG.`);
            return;
        }

        const imageObj = { type: 'file', file };
        let slotIndex = uploadedImages.findIndex(item => item === null);
        if (slotIndex === -1) {
            slotIndex = uploadedImages.length;
            uploadedImages.push(imageObj);
        } else {
            uploadedImages[slotIndex] = imageObj;
        }

        renderImageThumbnail(imageObj, slotIndex);
    });

    if (event.target) {
        event.target.value = '';
    }

    console.log(`‚úÖ ${files.length} imagem(ns) adicionada(s). Total: ${getActiveImageCount()}`);
}

function renderImageThumbnail(imageObj, index) {
    const container = document.getElementById('imageContainer');
    if (!container) return;

    const existingItem = document.getElementById(`image-item-${index}`);
    if (existingItem) {
        existingItem.remove();
    }

    const createThumbnail = (src) => {
        const imageDiv = document.createElement('div');
        imageDiv.className = 'image-item';
        imageDiv.id = `image-item-${index}`;

        const badges = [];
        if (index === 0) {
         //   badges.push('<div class="badge bg-primary position-absolute bottom-0 start-0 m-1">Principal</div>');
        }
        if (imageObj.type === 'existing') {
      //      badges.push('<div class="badge bg-info position-absolute top-0 start-0 m-1">Atual</div>');
        }

        imageDiv.innerHTML = `
            <img src="${src}" class="rounded img-thumbnail product-image-thumbnail" alt="Imagem ${index + 1}" style="width: 200px; height: 200px;">
            <button type="button" class="remove-image-btn" onclick="removeImage(${index})">√ó</button>
            ${badges.join('')}
        `;

        container.appendChild(imageDiv);
    };

    if (imageObj.type === 'file') {
        const reader = new FileReader();
        reader.onload = (e) => createThumbnail(e.target.result);
        reader.readAsDataURL(imageObj.file);
    } else if (imageObj.type === 'existing' && imageObj.source) {
        createThumbnail(imageObj.source);
    }
}

function removeImage(index) {
    const imageItem = document.getElementById(`image-item-${index}`);
    if (imageItem) {
        imageItem.remove();
    }

    uploadedImages[index] = null;

    console.log(`üóëÔ∏è Imagem ${index} removida`);
}

function seedExistingImages(pictures) {
    if (!Array.isArray(pictures)) {
        return;
    }

    const container = document.getElementById('imageContainer');
    if (container) {
        container.innerHTML = '';
    }

    uploadedImages = [];

    pictures.slice(0, 12).forEach((picture, idx) => {
        const source = picture?.secure_url || picture?.url || picture?.source || null;
        if (!source) {
            return;
        }

        const imageObj = { type: 'existing', source };
        uploadedImages.push(imageObj);
        renderImageThumbnail(imageObj, idx);
    });

    console.log(`üì∑ Imagens existentes carregadas: ${getActiveImageCount()}`);
}

// Submiss√£o do formul√°rio
document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Validar campos obrigat√≥rios
    const requiredFields = this.querySelectorAll('[required]');
    let isValid = true;
    let firstInvalidField = null;
    
    requiredFields.forEach(field => {
        if (!field.value || field.value.trim() === '') {
            field.classList.add('is-invalid');
            isValid = false;
            if (!firstInvalidField) {
                firstInvalidField = field;
            }
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        showAlert('danger', '‚ùå Por favor, preencha todos os campos obrigat√≥rios (marcados com *)');
        if (firstInvalidField) {
            firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalidField.focus();
        }
        return;
    }
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = isEditMode
        ? '<span class="spinner-border spinner-border-sm"></span> Salvando...'
        : '<span class="spinner-border spinner-border-sm"></span> Publicando...';
 
    try {
        const formData = new FormData(this);
        
        const hasVariationsEnabled = document.getElementById('hasVariationsToggle')?.checked;

        if (hasVariationsEnabled) {
            if (variationsList.length === 0) {
                showAlert('danger', 'Adicione pelo menos uma varia√ß√£o ou desative o controle de varia√ß√µes.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = isEditMode
                    ? '<i class="bi bi-check-circle"></i> Salvar altera√ß√µes'
                    : '<i class="bi bi-check-circle"></i> Publicar no Mercado Livre';
                return;
            }

            const variationsHidden = document.getElementById('variations_json');
            const hasVariationsInput = document.getElementById('has_variations_input');
            variationsHidden.value = JSON.stringify(variationsList);
            hasVariationsInput.value = 'true';

            const totalQuantity = variationsList.reduce((sum, variation) => sum + (Number(variation.available_quantity) || 0), 0);
            const mainPrice = variationsList.find(v => v.price !== null && v.price !== undefined)?.price;
            formData.set('available_quantity', totalQuantity || formData.get('available_quantity') || 0);
            if (mainPrice !== undefined && mainPrice !== null) {
                formData.set('price', mainPrice);
            }
        } else {
            document.getElementById('variations_json').value = '';
            document.getElementById('has_variations_input').value = 'false';
        }
        
        // Coletar atributos din√¢micos (caracter√≠sticas do produto)
        const attributes = [];
        const attributeInputs = document.querySelectorAll('[name^="attribute_"]');
        
        attributeInputs.forEach(input => {
            const attributeId = input.name.replace('attribute_', '');
            const value = input.value.trim();
            
            // Adicionar apenas se o campo foi preenchido
            if (value && value !== '') {
                attributes.push({
                    id: attributeId,
                    value_name: value
                });
            }
        });
        
        if (attributes.length > 0) {
            formData.append('attributes', JSON.stringify(attributes));
        }

        uploadedImages.forEach((imageObj) => {
            if (!imageObj) {
                return;
            }
            if (imageObj.type === 'file' && imageObj.file) {
                formData.append('images', imageObj.file);
            } else if (imageObj.type === 'existing' && imageObj.source) {
                formData.append('existing_images', imageObj.source);
            }
        });
        
        console.log('üì§ Enviando produto...', { isEditMode });

        const productId = document.getElementById('product_id')?.value || (initialProductData?.id ?? '');
        const submitUrl = isEditMode && productId
            ? `/ml/products/edit/${productId}`
            : '/ml/products/create';

        const response = await fetch(submitUrl, {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
            const successMessage = isEditMode
                ? (data.message || '‚úÖ An√∫ncio atualizado com sucesso!')
                : `‚úÖ Produto publicado com sucesso! ID: ${data.item_id}`;
            showAlert('success', successMessage);
            setTimeout(() => {
                window.location.href = '/ml/products';
            }, 2000);
        } else {
            const errorMessage = data.error || (isEditMode ? 'Erro ao atualizar an√∫ncio.' : 'Erro ao publicar produto');
            showAlert('danger', errorMessage);
            submitBtn.disabled = false;
            submitBtn.innerHTML = isEditMode
                ? '<i class="bi bi-check-circle"></i> Salvar altera√ß√µes'
                : '<i class="bi bi-check-circle"></i> Publicar no Mercado Livre';
        }
        
    } catch (error) {
        console.error('Erro ao publicar produto:', error);
        const genericError = isEditMode ? 'Erro ao atualizar an√∫ncio. Tente novamente.' : 'Erro ao publicar produto. Tente novamente.';
        showAlert('danger', genericError);
        submitBtn.disabled = false;
        submitBtn.innerHTML = isEditMode
            ? '<i class="bi bi-check-circle"></i> Salvar altera√ß√µes'
            : '<i class="bi bi-check-circle"></i> Publicar no Mercado Livre';
    }
});

// Fun√ß√£o auxiliar para exibir alertas
function showAlert(type, message) {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alert);
    
    // Rolar para o topo
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Auto-remover ap√≥s 5s
    setTimeout(() => alert.remove(), 5000);
}

function setupVariationAttributesUI() {
    const container = document.getElementById('variationsContainer');
    const toggle = document.getElementById('hasVariationsToggle');
    const info = document.getElementById('variationAttributesInfo');
    const summary = document.getElementById('variationAttributesSummary');
    const duplicateBtn = document.getElementById('duplicateVariationBtn');

    if (!container || !toggle || !info || !summary) {
        return;
    }

    console.log('üîé setupVariationAttributesUI - atributos:', variationAttributes);

    if (!Array.isArray(variationAttributes) || variationAttributes.length === 0) {
        container.classList.add('d-none');
        toggle.checked = false;
        toggle.disabled = true;
        document.getElementById('variationsDetails')?.classList.add('d-none');
        variationsList = [];
        renderVariationsTable();
        updateVariationHiddenField();
        if (duplicateBtn) duplicateBtn.disabled = true;
        return;
    }

    container.classList.remove('d-none');
    toggle.disabled = false;

    const attrNames = variationAttributes.map(attr => attr.name || attr.id);
    summary.textContent = `Dispon√≠vel para matrizar por: ${attrNames.join(', ')}`;

    const attrChips = variationAttributes.map(attr => {
        const tags = attr.tags || {};
        const required = attr.required || tags.mandatory || tags.required;
        const badgeClass = required ? 'bg-danger' : 'bg-primary';
        return `<span class="badge ${badgeClass} me-1">${attr.name || attr.id}</span>`;
    }).join('');
    info.innerHTML = `Defina pelo menos um valor para cada caracter√≠stica marcada. ${attrChips}`;

    renderVariationsTable();
    updateVariationHiddenField();
    if (duplicateBtn) {
        duplicateBtn.disabled = variationsList.length === 0;
    }
}

function onToggleVariations(event) {
    const enabled = event.target.checked;
    const details = document.getElementById('variationsDetails');
    const hasVariationsInput = document.getElementById('has_variations_input');

    if (!Array.isArray(variationAttributes) || variationAttributes.length === 0) {
        showAlert('warning', 'Esta categoria n√£o suporta varia√ß√µes.');
        event.target.checked = false;
        details?.classList.add('d-none');
        hasVariationsInput.value = 'false';
        updateVariationHiddenField();
        return;
    }

    if (details) {
        details.classList.toggle('d-none', !enabled);
    }
    hasVariationsInput.value = enabled ? 'true' : 'false';
    updateVariationHiddenField();
}

function generateUUID() {
    if (window.crypto?.randomUUID) {
        return window.crypto.randomUUID();
    }
    return `var-${Math.random().toString(36).substring(2, 10)}-${Date.now()}`;
}

function openVariationModal(variationId = null) {
    if (!Array.isArray(variationAttributes) || variationAttributes.length === 0) {
        showAlert('warning', 'Nenhum atributo de varia√ß√£o dispon√≠vel para esta categoria.');
        return;
    }

    currentVariationEditingId = variationId;
    const modalTitle = document.getElementById('variationModalLabel');
    const attributesContainer = document.getElementById('variationModalAttributes');
    attributesContainer.innerHTML = '';

    const existingVariation = variationsList.find(v => v.local_id === variationId);

    variationAttributes.forEach(attr => {
        const col = document.createElement('div');
        col.className = 'col-md-6';

        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = attr.name || attr.id;
        if (attr.required) {
            label.innerHTML += ' <span class="text-danger">*</span>';
        }

        col.appendChild(label);

        const existingCombination = existingVariation?.attribute_combinations?.find(c => c.id === attr.id);
        const attrValues = Array.isArray(attr.values) ? attr.values : [];

        if (attrValues.length > 0) {
            const select = document.createElement('select');
            select.className = 'form-select variation-attribute-input';
            select.dataset.attributeId = attr.id;
            select.dataset.attributeName = attr.name || attr.id;
            select.innerHTML = '<option value="">Selecione...</option>';

            attrValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value.id || value.name;
                option.textContent = value.name || value.id;
                option.dataset.valueId = value.id || '';
                option.dataset.valueName = value.name || value.id;
                select.appendChild(option);
            });

            if (existingCombination) {
                let matched = false;
                if (existingCombination.value_id) {
                    select.value = existingCombination.value_id;
                    matched = true;
                }
                if (!matched && existingCombination.value_name) {
                    const foundOption = Array.from(select.options).find(opt => opt.dataset.valueName === existingCombination.value_name);
                    if (foundOption) {
                        select.value = foundOption.value;
                        matched = true;
                    }
                }
                if (!matched && existingCombination.value_name) {
                    const newOption = document.createElement('option');
                    newOption.value = existingCombination.value_name;
                    newOption.textContent = `${existingCombination.value_name} (custom)`;
                    newOption.dataset.valueName = existingCombination.value_name;
                    select.appendChild(newOption);
                    select.value = newOption.value;
                }
            }

            col.appendChild(select);
        } else {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control variation-attribute-input';
            input.dataset.attributeId = attr.id;
            input.dataset.attributeName = attr.name || attr.id;
            if (existingCombination?.value_name) {
                input.value = existingCombination.value_name;
            }
            col.appendChild(input);
        }

        attributesContainer.appendChild(col);
    });

    const priceInput = document.getElementById('variation_price');
    const stockInput = document.getElementById('variation_stock');
    const skuInput = document.getElementById('variation_sku');
    const gtinInput = document.getElementById('variation_gtin');
    const notesInput = document.getElementById('variation_notes');

    priceInput.value = existingVariation?.price ?? '';
    stockInput.value = existingVariation?.available_quantity ?? '';
    skuInput.value = existingVariation?.seller_custom_field ?? '';
    gtinInput.value = existingVariation?.gtin ?? '';
    notesInput.value = existingVariation?.notes ?? '';

    if (modalTitle) {
        modalTitle.textContent = variationId ? 'Editar varia√ß√£o' : 'Adicionar varia√ß√£o';
    }

    variationModalInstance?.show();
}

function buildVariationCombinationKey(combinationEntries) {
    return combinationEntries
        .map(entry => `${entry.id}:${entry.value_id || entry.value_name || ''}`)
        .sort()
        .join('|');
}

function saveVariationFromModal() {
    const attributeInputs = document.querySelectorAll('.variation-attribute-input');
    const combinations = [];

    attributeInputs.forEach(input => {
        const attrId = input.dataset.attributeId;
        const attrName = input.dataset.attributeName;
        const isSelect = input.tagName === 'SELECT';
        const value = input.value?.trim();

        if (!value) {
            return;
        }

        const entry = { id: attrId };
        if (isSelect) {
            const selectedOption = input.selectedOptions[0];
            if (selectedOption?.dataset.valueId) {
                entry.value_id = selectedOption.dataset.valueId;
            }
            entry.value_name = selectedOption?.dataset.valueName || selectedOption?.text || value;
        } else {
            entry.value_name = value;
        }

        if (!entry.value_id && !entry.value_name) {
            entry.value_name = value;
        }

        entry.name = attrName;
        combinations.push(entry);
    });

    if (combinations.length !== variationAttributes.length) {
        showAlert('warning', 'Preencha todas as caracter√≠sticas da varia√ß√£o.');
        return;
    }

    const combinationKey = buildVariationCombinationKey(combinations);
    const duplicate = variationsList.find(v => buildVariationCombinationKey(v.attribute_combinations) === combinationKey && v.local_id !== currentVariationEditingId);
    if (duplicate) {
        showAlert('warning', 'J√° existe uma varia√ß√£o com essa combina√ß√£o de atributos.');
        return;
    }

    const priceValue = document.getElementById('variation_price').value;
    const stockValue = document.getElementById('variation_stock').value;
    const skuValue = document.getElementById('variation_sku').value?.trim();
    const gtinValue = document.getElementById('variation_gtin').value?.trim();
    const notesValue = document.getElementById('variation_notes').value?.trim();

    const existingVariation = currentVariationEditingId
        ? variationsList.find(v => v.local_id === currentVariationEditingId)
        : null;

    const preservedAttributes = existingVariation?.attributes
        ? existingVariation.attributes.filter(attr => attr.id !== 'GTIN')
        : [];

    const variationData = {
        local_id: currentVariationEditingId || generateUUID(),
        ml_variation_id: null,
        attribute_combinations: combinations,
        price: priceValue ? parseFloat(priceValue) : null,
        available_quantity: stockValue ? parseInt(stockValue, 10) : 0,
        seller_custom_field: skuValue || null,
        gtin: gtinValue || null,
        notes: notesValue || null,
        attributes: preservedAttributes,
    };

    if (gtinValue) {
        variationData.attributes.push({ id: 'GTIN', value_name: gtinValue });
    }

    if (currentVariationEditingId) {
        const index = variationsList.findIndex(v => v.local_id === currentVariationEditingId);
        if (index >= 0) {
            variationData.ml_variation_id = variationsList[index].ml_variation_id || null;
            variationData.status = variationsList[index].status || null;
            variationData.__marked_for_deletion = variationsList[index].__marked_for_deletion || false;
            variationsList[index] = variationData;
        }
    } else {
        variationsList.push(variationData);
    }

    renderVariationsTable();
    updateVariationHiddenField();
    variationModalInstance?.hide();
    document.getElementById('duplicateVariationBtn').disabled = variationsList.length === 0;
}

function duplicateLastVariation() {
    if (variationsList.length === 0) {
        return;
    }
    const lastVariation = variationsList[variationsList.length - 1];
    const duplicated = JSON.parse(JSON.stringify(lastVariation));
    duplicated.local_id = generateUUID();
    duplicated.ml_variation_id = null;
    duplicated.status = null;
    duplicated.__marked_for_deletion = false;
    variationsList.push(duplicated);
    renderVariationsTable();
    updateVariationHiddenField();
}

function deleteVariation(localId) {
    const variation = variationsList.find(v => v.local_id === localId);
    if (!variation) {
        return;
    }

    if (variation.ml_variation_id) {
        variation.available_quantity = 0;
        variation.status = 'not_available';
        variation.__marked_for_deletion = true;
        showAlert('info', 'A varia√ß√£o ser√° desativada no Mercado Livre (estoque zero).');
    } else {
        variationsList = variationsList.filter(v => v.local_id !== localId);
    }

    renderVariationsTable();
    updateVariationHiddenField();
    const duplicateBtn = document.getElementById('duplicateVariationBtn');
    if (duplicateBtn) {
        duplicateBtn.disabled = variationsList.length === 0;
    }
}

function editVariation(localId) {
    const variation = variationsList.find(v => v.local_id === localId);
    if (!variation) {
        return;
    }
    openVariationModal(localId);
    document.getElementById('variationModalLabel').textContent = 'Editar varia√ß√£o';
    const priceInput = document.getElementById('variation_price');
    const stockInput = document.getElementById('variation_stock');
    const skuInput = document.getElementById('variation_sku');
    const gtinInput = document.getElementById('variation_gtin');
    const notesInput = document.getElementById('variation_notes');

    priceInput.value = variation.price ?? '';
    stockInput.value = variation.available_quantity ?? '';
    skuInput.value = variation.seller_custom_field ?? '';
    gtinInput.value = variation.gtin ?? '';
    notesInput.value = variation.notes ?? '';
}

function renderVariationsTable() {
    const headerRow = document.getElementById('variationsTableHeader');
    const body = document.getElementById('variationsTableBody');
    const duplicateBtn = document.getElementById('duplicateVariationBtn');

    if (!headerRow || !body) {
        return;
    }

    headerRow.innerHTML = '';
    const attributeHeader = document.createElement('th');
    attributeHeader.textContent = 'Combina√ß√£o';
    headerRow.appendChild(attributeHeader);

    const priceHeader = document.createElement('th');
    priceHeader.textContent = 'Pre√ßo (R$)';
    headerRow.appendChild(priceHeader);

    const stockHeader = document.createElement('th');
    stockHeader.textContent = 'Estoque';
    headerRow.appendChild(stockHeader);

    const skuHeader = document.createElement('th');
    skuHeader.textContent = 'SKU';
    headerRow.appendChild(skuHeader);

    const gtinHeader = document.createElement('th');
    gtinHeader.textContent = 'GTIN';
    headerRow.appendChild(gtinHeader);

    const actionsHeader = document.createElement('th');
    actionsHeader.className = 'text-end';
    actionsHeader.textContent = 'A√ß√µes';
    headerRow.appendChild(actionsHeader);

    if (!variationsList.length) {
        body.innerHTML = '<tr class="text-center text-muted"><td colspan="6">Nenhuma varia√ß√£o cadastrada.</td></tr>';
        document.getElementById('variationsCount').textContent = '0';
        if (duplicateBtn) duplicateBtn.disabled = true;
        return;
    }

    body.innerHTML = '';
    variationsList.forEach(variation => {
        const row = document.createElement('tr');

        const combinationCell = document.createElement('td');
        const comboText = variation.attribute_combinations
            .map(combo => `${combo.name || combo.id}: ${combo.value_name || combo.value_id || ''}`)
            .join('<br>');
        let combinationHtml = comboText || '<span class="text-muted">-</span>';
        if (variation.__marked_for_deletion) {
            combinationHtml += '<div><span class="badge bg-warning text-dark mt-1">Ser√° desativada</span></div>';
        }
        combinationCell.innerHTML = combinationHtml;
        row.appendChild(combinationCell);

        const priceCell = document.createElement('td');
        priceCell.textContent = variation.price !== null && variation.price !== undefined
            ? Number(variation.price).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })
            : '--';
        row.appendChild(priceCell);

        const stockCell = document.createElement('td');
        stockCell.textContent = variation.available_quantity ?? '--';
        row.appendChild(stockCell);

        const skuCell = document.createElement('td');
        skuCell.textContent = variation.seller_custom_field || '--';
        row.appendChild(skuCell);

        const gtinCell = document.createElement('td');
        gtinCell.textContent = variation.gtin || '--';
        row.appendChild(gtinCell);

        const actionsCell = document.createElement('td');
        actionsCell.className = 'text-end';
        actionsCell.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" onclick="editVariation('${variation.local_id}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteVariation('${variation.local_id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
        row.appendChild(actionsCell);

        body.appendChild(row);
    });

    document.getElementById('variationsCount').textContent = variationsList.length;
    if (duplicateBtn) duplicateBtn.disabled = variationsList.length === 0;
}

function updateVariationHiddenField() {
    const variationsHidden = document.getElementById('variations_json');
    const hasInput = document.getElementById('has_variations_input');
    const toggle = document.getElementById('hasVariationsToggle');

    if (!variationsHidden || !hasInput || !toggle) {
        return;
    }

    if (toggle.checked && variationsList.length > 0) {
        variationsHidden.value = JSON.stringify(variationsList);
        hasInput.value = 'true';
    } else {
        variationsHidden.value = '';
        hasInput.value = 'false';
    }
}

function prefillVariationsFromApi(apiVariations) {
    if (!Array.isArray(apiVariations) || apiVariations.length === 0) {
        return;
    }

    const toggle = document.getElementById('hasVariationsToggle');
    const details = document.getElementById('variationsDetails');
    const hasInput = document.getElementById('has_variations_input');

    if (toggle) {
        toggle.checked = true;
    }
    if (details) {
        details.classList.remove('d-none');
    }
    if (hasInput) {
        hasInput.value = 'true';
    }

    variationsList = apiVariations.map(variation => {
        const combos = Array.isArray(variation.attribute_combinations)
            ? variation.attribute_combinations.map(combo => ({
                id: combo.id,
                name: combo.name || combo.id,
                value_id: combo.value_id || null,
                value_name: combo.value_name || combo.value_id || '',
            }))
            : [];

        const attributes = Array.isArray(variation.attributes)
            ? variation.attributes
            : [];

        const gtinAttr = attributes.find(attr => ['GTIN', 'EAN', 'UPC', 'BARCODE'].includes(attr.id || attr.name));

        return {
            local_id: variation.id ? String(variation.id) : generateUUID(),
            ml_variation_id: variation.id ? String(variation.id) : null,
            attribute_combinations: combos,
            price: variation.price !== undefined && variation.price !== null ? Number(variation.price) : null,
            available_quantity: variation.available_quantity !== undefined && variation.available_quantity !== null
                ? Number(variation.available_quantity)
                : 0,
            seller_custom_field: variation.seller_custom_field || null,
            gtin: gtinAttr?.value_name || null,
            notes: null,
            attributes: attributes,
            status: variation.status || null,
        };
    });

    renderVariationsTable();
    updateVariationHiddenField();
    document.getElementById('duplicateVariationBtn').disabled = variationsList.length === 0;
}
</script>
{% endblock %}

