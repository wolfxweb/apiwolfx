{% extends "base.html" %}

{% block title %}Perfil do Usuário - CELX{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Perfil do Usuário</h2>
                <a href="/dashboard" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>
    
    <!-- Card Único com todas as informações -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <!-- Informações Pessoais -->
                    <div class="mb-4">
                        <h5 class="mb-3">Informações Pessoais</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Nome Completo</p>
                                <p class="mb-0"><strong>{{ user.first_name }} {{ user.last_name }}</strong></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Email</p>
                                <p class="mb-0"><strong>{{ user.email }}</strong></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Função</p>
                                <p class="mb-0"><span class="badge bg-secondary">{{ user.role }}</span></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">ID</p>
                                <p class="mb-0"><strong>{{ user.id }}</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Plano & Assinatura -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="mb-0">Plano & Assinatura</h5>
                            {% if subscription %}
                            <a href="/auth/plans" class="btn btn-outline-primary btn-sm">Gerenciar</a>
                            {% else %}
                            <a href="/auth/plans" class="btn btn-primary btn-sm">Assinar</a>
                            {% endif %}
                        </div>
                        {% if subscription %}
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Plano Atual</p>
                                <p class="mb-0"><strong>{{ subscription.plan_name or 'N/A' }}</strong></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Valor</p>
                                <p class="mb-0"><strong>{{ subscription.price|brl }}</strong></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Status</p>
                                <p class="mb-0">
                                    {% if subscription.is_trial %}
                                        <span class="badge bg-warning">Trial</span>
                                    {% else %}
                                        <span class="badge bg-success">Ativo</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Vencimento</p>
                                <p class="mb-0">
                                    {% if subscription.ends_at %}
                                        <strong>{{ subscription.ends_at.strftime('%d/%m/%Y') }}</strong>
                                    {% elif subscription.trial_ends_at %}
                                        <span class="text-warning">{{ subscription.trial_ends_at.strftime('%d/%m/%Y') }} (Trial)</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-warning mb-0">
                            Nenhuma assinatura ativa. <a href="/auth/plans" class="alert-link">Assine agora</a> para começar.
                        </div>
                        {% endif %}
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Informações da Empresa -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="mb-0">Informações da Empresa</h5>
                            <a href="/auth/company/edit" class="btn btn-outline-secondary btn-sm">Editar</a>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Nome</p>
                                <p class="mb-0"><strong>{{ company.name or 'N/A' }}</strong></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Status</p>
                                <p class="mb-0">
                                    {% if company.status %}
                                        {% if company.status == 'active' %}
                                            <span class="badge bg-success">Ativo</span>
                                        {% elif company.status == 'trial' %}
                                            <span class="badge bg-warning">Trial</span>
                                        {% elif company.status == 'suspended' %}
                                            <span class="badge bg-danger">Suspenso</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ company.status|title }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Domínio</p>
                                <p class="mb-0"><strong>{{ company.domain or 'N/A' }}</strong></p>
                            </div>
                            <div class="col-md-3 mb-3">
                                <p class="mb-1 text-muted small">Criada em</p>
                                <p class="mb-0">
                                    {% if company.created_at %}
                                        {% if company.created_at is string %}
                                            <strong>{{ company.created_at[:10] }}</strong>
                                        {% else %}
                                            <strong>{{ company.created_at.strftime('%d/%m/%Y') }}</strong>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        
                        {% if company.razao_social or company.nome_fantasia or company.cnpj %}
                        <div class="row mt-3 pt-3 border-top">
                            <div class="col-md-4 mb-3">
                                {% if company.razao_social %}
                                    <p class="mb-1 text-muted small">Razão Social</p>
                                    <p class="mb-0"><strong>{{ company.razao_social }}</strong></p>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {% if company.nome_fantasia %}
                                    <p class="mb-1 text-muted small">Nome Fantasia</p>
                                    <p class="mb-0"><strong>{{ company.nome_fantasia }}</strong></p>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                {% if company.cnpj %}
                                    <p class="mb-1 text-muted small">CNPJ</p>
                                    <p class="mb-0"><strong>{{ company.cnpj }}</strong></p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if company.cep or company.endereco or company.cidade %}
                        <div class="row mt-3 pt-3 border-top">
                            <div class="col-md-6 mb-3">
                                {% if company.endereco %}
                                    <p class="mb-1 text-muted small">Endereço</p>
                                    <p class="mb-0"><strong>{{ company.endereco }}{% if company.numero %}, {{ company.numero }}{% endif %}</strong></p>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {% if company.cidade %}
                                    <p class="mb-1 text-muted small">Cidade</p>
                                    <p class="mb-0"><strong>{{ company.cidade }}{% if company.estado %} - {{ company.estado }}{% endif %}</strong></p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="row mt-3 pt-3 border-top">
                            <div class="col-md-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Pedidos ML como Contas a Receber</strong>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="mlOrdersSwitch" 
                                               {% if company.ml_orders_as_receivables %}checked{% endif %}
                                               onchange="toggleMLOrdersReceivables(this)">
                                        <label class="form-check-label" for="mlOrdersSwitch">
                                            {% if company.ml_orders_as_receivables %}
                                                <span class="text-success">Ativado</span>
                                            {% else %}
                                                <span class="text-muted">Desativado</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <!-- Histórico de Pagamentos -->
                    <div>
                        <h5 class="mb-3">Histórico de Pagamentos</h5>
                        <div id="payments-loading" class="text-center py-4">
                            <div class="spinner-border text-secondary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-2 text-muted">Carregando pagamentos...</p>
                        </div>
                        
                        <div id="payments-content" style="display: none;"></div>
                        
                        <div id="no-payments-message" style="display: none;" class="text-center py-4">
                            <p class="text-muted mb-0">Nenhum pagamento encontrado.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUserPayments();
});

async function loadUserPayments() {
    try {
        const response = await fetch('/api/payments/my-payments');
        const data = await response.json();
        
        document.getElementById('payments-loading').style.display = 'none';
        
        if (data.payments && data.payments.length > 0) {
            displayPaymentsTable(data.payments);
        } else {
            document.getElementById('no-payments-message').style.display = 'block';
        }
        
    } catch (error) {
        console.error('Erro ao carregar pagamentos:', error);
        document.getElementById('payments-loading').style.display = 'none';
        document.getElementById('no-payments-message').style.display = 'block';
    }
}

function displayPaymentsTable(payments) {
    const container = document.getElementById('payments-content');
    
    let html = `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th>Plano</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Método</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    payments.forEach(payment => {
        const date = new Date(payment.created_at).toLocaleDateString('pt-BR');
        const statusClass = getStatusClass(payment.status);
        const statusIcon = getStatusIcon(payment.status);
        
        html += `
            <tr>
                <td>${date}</td>
                <td><span class="badge bg-secondary">${payment.plan_name || payment.description}</span></td>
                <td><strong>R$ ${payment.amount.toFixed(2)}</strong></td>
                <td><span class="badge bg-${statusClass}">${statusIcon} ${payment.status.toUpperCase()}</span></td>
                <td><small class="text-muted">${payment.payment_method || 'N/A'}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" onclick="viewPaymentDetails('${payment.mp_payment_id || payment.id}')">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
    container.style.display = 'block';
}

function getStatusClass(status) {
    switch(status) {
        case 'approved': return 'success';
        case 'pending': return 'warning';
        case 'rejected': case 'cancelled': return 'danger';
        default: return 'secondary';
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'approved': return '<i class="bi bi-check-circle"></i>';
        case 'pending': return '<i class="bi bi-clock"></i>';
        case 'rejected': case 'cancelled': return '<i class="bi bi-x-circle"></i>';
        default: return '<i class="bi bi-question-circle"></i>';
    }
}

function viewPaymentDetails(paymentId) {
    alert(`Detalhes do pagamento ${paymentId}\n\nEm desenvolvimento - será implementado em breve!`);
}

function toggleMLOrdersReceivables(switchElement) {
    const isChecked = switchElement.checked;
    const label = switchElement.nextElementSibling.querySelector('span');
    
    switchElement.disabled = true;
    label.textContent = 'Alterando...';
    
    fetch('/api/company/toggle-ml-orders-receivables', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.ml_orders_as_receivables) {
                label.textContent = 'Ativado';
                label.className = 'text-success';
            } else {
                label.textContent = 'Desativado';
                label.className = 'text-muted';
            }
            showNotification('Configuração alterada com sucesso!', 'success');
        } else {
            switchElement.checked = !isChecked;
            label.textContent = isChecked ? 'Desativado' : 'Ativado';
            label.className = isChecked ? 'text-muted' : 'text-success';
            showNotification('Erro ao alterar configuração: ' + (data.error || 'Erro desconhecido'), 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        switchElement.checked = !isChecked;
        label.textContent = isChecked ? 'Desativado' : 'Ativado';
        label.className = isChecked ? 'text-muted' : 'text-success';
        showNotification('Erro de conexão. Tente novamente.', 'error');
    })
    .finally(() => {
        switchElement.disabled = false;
    });
}

function showNotification(message, type = 'info') {
    if (window.MLAPI && window.MLAPI.showNotification) {
        window.MLAPI.showNotification(message, type);
    } else {
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
}
</script>
{% endblock %}
