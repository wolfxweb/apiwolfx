{% extends "base.html" %}

{% block title %}Chat com IA - CELX{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow: hidden;
    }
    
    .chat-container {
        height: calc(100vh - 80px);
        display: flex;
        flex-direction: column;
    }
    
    .conversations-sidebar {
        width: 300px;
        border-right: 1px solid #dee2e6;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    
    .conversations-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        background-color: white;
    }
    
    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
    }
    
    .conversation-item {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
        background-color: white;
        border: 1px solid #dee2e6;
    }
    
    .conversation-item:hover {
        background-color: #e9ecef;
    }
    
    .conversation-item.active {
        background-color: #e7f3ff;
        border-color: #0d6efd;
    }
    
    .conversation-title {
        font-weight: 600;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .conversation-meta {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        background-color: white;
    }
    
    .chat-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        background-color: white;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message-content {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }
    
    .message.user .message-content {
        background-color: #0d6efd;
        color: white;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message.assistant .message-content {
        background-color: white;
        color: #212529;
        border: 1px solid #dee2e6;
        border-bottom-left-radius: 0.25rem;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
        padding: 0 0.5rem;
    }
    
    .chat-input-area {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        background-color: white;
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .new-chat-btn {
        width: 100%;
        margin-bottom: 1rem;
    }
    
    .assistant-selector {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="d-flex h-100">
        <!-- Sidebar de Conversas -->
        <div class="conversations-sidebar">
            <div class="conversations-header">
                <button class="btn btn-primary new-chat-btn" onclick="startNewChat()">
                    <i class="bi bi-plus-circle"></i> Nova Conversa
                </button>
                <div class="assistant-selector">
                    <select class="form-select form-select-sm" id="assistantFilter" onchange="loadConversations()">
                        <option value="">Todos os Agentes</option>
                    </select>
                </div>
            </div>
            <div class="conversations-list" id="conversationsList">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Área de Chat -->
        <div class="chat-area flex-grow-1">
            <!-- Estado vazio -->
            <div class="empty-state" id="emptyState">
                <i class="bi bi-chat-left-text"></i>
                <h4>Selecione uma conversa</h4>
                <p class="text-muted">Escolha uma conversa da lista ao lado ou inicie uma nova</p>
            </div>
            
            <!-- Chat ativo -->
            <div id="chatActive" style="display: none; height: 100%; flex-direction: column;">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" id="chatAssistantName">
                                <i class="bi bi-robot"></i> Agente
                            </h5>
                            <small class="text-muted" id="chatThreadInfo"></small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrentConversation()" title="Deletar conversa">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Mensagens serão inseridas aqui -->
                </div>
                
                <div class="chat-input-area">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               id="chatInput" 
                               placeholder="Digite sua mensagem..."
                               onkeypress="if(event.key === 'Enter') sendMessage()">
                        <button class="btn btn-primary" id="sendBtn" onclick="sendMessage()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Remoção -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Remoção</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmDeleteMessage">Tem certeza que deseja deletar esta conversa?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteYesBtn">Remover</button>
            </div>
        </div>
    </div>
    </div>

<script>
let currentThreadId = null;
let currentAssistantId = null;
let conversations = [];

// Carregar conversas e agentes ao iniciar
document.addEventListener('DOMContentLoaded', function() {
    loadAssistants();
    loadConversations();
});

// Carregar lista de agentes disponíveis
async function loadAssistants() {
    try {
        const response = await fetch('/api/openai/assistants/available?active_only=true', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.assistants) {
                const select = document.getElementById('assistantFilter');
                select.innerHTML = '<option value="">Todos os Agentes</option>';
                data.assistants.forEach(assistant => {
                    const option = document.createElement('option');
                    option.value = assistant.id;
                    option.textContent = assistant.name;
                    select.appendChild(option);
                });
            }
        }
    } catch (error) {
        console.error('Erro ao carregar agentes:', error);
    }
}

// Carregar lista de conversas
async function loadConversations() {
    const assistantFilter = document.getElementById('assistantFilter').value;
    const assistantId = assistantFilter ? parseInt(assistantFilter) : null;
    
    try {
        const url = assistantId 
            ? `/api/openai/assistants/threads?assistant_id=${assistantId}`
            : '/api/openai/assistants/threads';
            
        const response = await fetch(url, {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.threads) {
                conversations = data.threads;
                renderConversationsList();
            } else {
                document.getElementById('conversationsList').innerHTML = 
                    '<div class="text-center py-4 text-muted">Nenhuma conversa encontrada</div>';
            }
        }
    } catch (error) {
        console.error('Erro ao carregar conversas:', error);
        document.getElementById('conversationsList').innerHTML = 
            '<div class="text-center py-4 text-danger">Erro ao carregar conversas</div>';
    }
}

// Renderizar lista de conversas
function renderConversationsList() {
    const container = document.getElementById('conversationsList');
    
    if (conversations.length === 0) {
        container.innerHTML = '<div class="text-center py-4 text-muted">Nenhuma conversa encontrada</div>';
        return;
    }
    
    // Ordenar por mais recentes primeiro (last_message_at ou created_at)
    const sorted = [...conversations].sort((a, b) => {
        const da = new Date(a.last_message_at || a.created_at);
        const db = new Date(b.last_message_at || b.created_at);
        return db - da;
    });

    container.innerHTML = sorted.map(conv => {
        const date = conv.last_message_at 
            ? new Date(conv.last_message_at).toLocaleDateString('pt-BR')
            : new Date(conv.created_at).toLocaleDateString('pt-BR');
        
        const rawTitle = (conv.title && typeof conv.title === 'string') ? conv.title : 'Nova conversa';
        const displayTitle = rawTitle.length > 15 ? rawTitle.slice(0, 15) + '...' : rawTitle;
        
        return `
            <div class="conversation-item ${conv.thread_id === currentThreadId ? 'active' : ''}" 
                 onclick="loadConversation('${conv.thread_id}', ${conv.assistant_id})">
                <div>
                    <div class="conversation-title">${escapeHtml(displayTitle)}</div>
                    <div class="conversation-meta">
                        <div>${escapeHtml(conv.assistant_name)}</div>
                        <div>${conv.message_count} mensagens • ${date}</div>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-2">
                    <button class="btn btn-sm btn-outline-danger" title="Remover conversa" onclick="deleteConversation(event, '${conv.thread_id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Carregar uma conversa específica
async function loadConversation(threadId, assistantId) {
    currentThreadId = threadId;
    currentAssistantId = assistantId;
    
    try {
        const response = await fetch(`/api/openai/assistants/threads/${threadId}/messages`, {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Mostrar área de chat
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('chatActive').style.display = 'flex';
                
                // Atualizar header
                document.getElementById('chatAssistantName').innerHTML = 
                    `<i class="bi bi-robot"></i> ${escapeHtml(data.thread.assistant_name)}`;
                
                // Carregar mensagens
                renderMessages(data.messages);
                
                // Atualizar lista de conversas (marcar ativa)
                renderConversationsList();
                
                // Scroll para última mensagem
                scrollToBottom();
            }
        }
    } catch (error) {
        console.error('Erro ao carregar conversa:', error);
        showNotification('Erro ao carregar conversa', 'error');
    }
}

// Renderizar mensagens
function renderMessages(messages) {
    const container = document.getElementById('chatMessages');
    
    // Filtrar apenas mensagens de usuário e assistente (ignorar system)
    const userMessages = messages.filter(m => m.role !== 'system');
    
    container.innerHTML = userMessages.map(msg => {
        const date = new Date(msg.created_at);
        const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        
        return `
            <div class="message ${msg.role}">
                <div>
                    <div class="message-content">${formatMessage(msg.content)}</div>
                    <div class="message-time">${timeStr}</div>
                </div>
            </div>
        `;
    }).join('');
    
    scrollToBottom();
}

// Formatar mensagem (suporta markdown básico)
function formatMessage(content) {
    // Escapar HTML primeiro
    let formatted = escapeHtml(content);
    
    // Converter quebras de linha
    formatted = formatted.replace(/\n/g, '<br>');
    
    // Converter markdown básico
    formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');
    formatted = formatted.replace(/`(.+?)`/g, '<code>$1</code>');
    
    return formatted;
}

// Escapar HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Scroll para última mensagem
function scrollToBottom() {
    const container = document.getElementById('chatMessages');
    container.scrollTop = container.scrollHeight;
}

// Enviar mensagem
async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (!currentAssistantId) {
        showNotification('Por favor, selecione um agente primeiro', 'error');
        return;
    }
    
    // Desabilitar input
    input.disabled = true;
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    // Adicionar mensagem do usuário na interface
    addMessageToChat('user', message);
    input.value = '';
    
    try {
        const response = await fetch('/api/openai/assistants/use/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
                assistant_id: currentAssistantId,
                message: message,
                thread_id: currentThreadId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Adicionar resposta do assistente
            addMessageToChat('assistant', result.response);
            
            // Atualizar thread_id se for nova conversa
            if (result.thread_id && !currentThreadId) {
                currentThreadId = result.thread_id;
                // Recarregar lista de conversas
                loadConversations();
            }
        } else {
            showNotification('Erro: ' + (result.error || 'Erro desconhecido'), 'error');
        }
    } catch (error) {
        console.error('Erro ao enviar mensagem:', error);
        showNotification('Erro ao enviar mensagem', 'error');
    } finally {
        // Reabilitar input
        input.disabled = false;
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-send"></i>';
        input.focus();
    }
}

// Adicionar mensagem ao chat
function addMessageToChat(role, content) {
    const container = document.getElementById('chatMessages');
    const date = new Date();
    const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    messageDiv.innerHTML = `
        <div>
            <div class="message-content">${formatMessage(content)}</div>
            <div class="message-time">${timeStr}</div>
        </div>
    `;
    
    container.appendChild(messageDiv);
    scrollToBottom();
}

// Iniciar nova conversa
async function startNewChat() {
    // Buscar agentes disponíveis
    try {
        const response = await fetch('/api/openai/assistants/available?active_only=true', {
            credentials: 'include'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.assistants && data.assistants.length > 0) {
                // Se houver apenas um agente, usar ele
                if (data.assistants.length === 1) {
                    currentAssistantId = data.assistants[0].id;
                    currentThreadId = null;
                    showChatArea();
                } else {
                    // Mostrar modal para selecionar agente
                    showAgentSelectionModal(data.assistants);
                }
            } else {
                showNotification('Nenhum agente disponível', 'error');
            }
        }
    } catch (error) {
        console.error('Erro ao iniciar nova conversa:', error);
        showNotification('Erro ao iniciar nova conversa', 'error');
    }
}

// Mostrar área de chat
function showChatArea() {
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('chatActive').style.display = 'flex';
    
    if (currentAssistantId) {
        // Buscar nome do agente
        fetch('/api/openai/assistants/available?active_only=true', {
            credentials: 'include'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.assistants) {
                const assistant = data.assistants.find(a => a.id === currentAssistantId);
                if (assistant) {
                    document.getElementById('chatAssistantName').innerHTML = 
                        `<i class="bi bi-robot"></i> ${escapeHtml(assistant.name)}`;
                }
            }
        });
    }
    
    // Limpar mensagens
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('chatInput').focus();
}

// Modal de seleção de agente
function showAgentSelectionModal(assistants) {
    const modalHtml = `
        <div class="modal fade" id="agentSelectionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Selecione um Agente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${assistants.map(a => `
                            <div class="card mb-2" style="cursor: pointer;" onclick="selectAgent(${a.id})">
                                <div class="card-body">
                                    <h6 class="card-title">${escapeHtml(a.name)}</h6>
                                    <p class="card-text text-muted small">${escapeHtml(a.description || 'Sem descrição')}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remover modal existente
    const existing = document.getElementById('agentSelectionModal');
    if (existing) existing.remove();
    
    // Adicionar modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('agentSelectionModal'));
    modal.show();
    
    // Remover modal após fechar
    document.getElementById('agentSelectionModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Selecionar agente
function selectAgent(assistantId) {
    currentAssistantId = assistantId;
    currentThreadId = null;
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('agentSelectionModal'));
    if (modal) modal.hide();
    
    showChatArea();
    showNotification('Nova conversa iniciada', 'success');
}

// Deletar conversa atual
async function deleteCurrentConversation() {
    if (!currentThreadId) return;
    
    const confirmed = await showConfirmModal('Tem certeza que deseja deletar esta conversa?');
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/openai/assistants/threads/${currentThreadId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (response.ok) {
            showNotification('Conversa deletada com sucesso', 'success');
            currentThreadId = null;
            currentAssistantId = null;
            
            // Mostrar estado vazio
            document.getElementById('emptyState').style.display = 'flex';
            document.getElementById('chatActive').style.display = 'none';
            
            // Recarregar lista
            loadConversations();
        } else {
            showNotification('Erro ao deletar conversa', 'error');
        }
    } catch (error) {
        console.error('Erro ao deletar conversa:', error);
        showNotification('Erro ao deletar conversa', 'error');
    }
}

// Mostrar notificação
function showNotification(message, type = 'info') {
    // Usar toast do Bootstrap se disponível
    if (typeof showToast === 'function') {
        showToast(message, type);
    } else {
        alert(message);
    }
}

// Remover conversa a partir do card
async function deleteConversation(event, threadId) {
    event.stopPropagation();
    event.preventDefault();
    
    if (!threadId) return;
    const confirmed = await showConfirmModal('Tem certeza que deseja deletar esta conversa?');
    if (!confirmed) return;
    
    try {
        const response = await fetch(`/api/openai/assistants/threads/${threadId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (response.ok) {
            // Se a conversa deletada é a atual, limpar painel
            if (currentThreadId === threadId) {
                currentThreadId = null;
                document.getElementById('emptyState').style.display = 'flex';
                document.getElementById('chatActive').style.display = 'none';
            }
            showNotification('Conversa removida', 'success');
            loadConversations();
        } else {
            showNotification('Erro ao remover conversa', 'error');
        }
    } catch (error) {
        console.error('Erro ao remover conversa:', error);
        showNotification('Erro ao remover conversa', 'error');
    }
}

// Modal de confirmação genérico (retorna Promise<boolean>)
function showConfirmModal(message) {
    return new Promise((resolve) => {
        const modalEl = document.getElementById('confirmDeleteModal');
        const messageEl = document.getElementById('confirmDeleteMessage');
        const yesBtn = document.getElementById('confirmDeleteYesBtn');
        
        if (messageEl) messageEl.textContent = message || 'Confirmar ação?';
        
        // Garantir que não haja múltiplos listeners
        const newYesBtn = yesBtn.cloneNode(true);
        yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
        
        const modal = new bootstrap.Modal(modalEl);
        
        newYesBtn.addEventListener('click', () => {
            modal.hide();
            resolve(true);
        }, { once: true });
        
        modalEl.addEventListener('hidden.bs.modal', function handler() {
            modalEl.removeEventListener('hidden.bs.modal', handler);
            // Se foi fechado sem confirmar
            resolve(false);
        }, { once: true });
        
        modal.show();
    });
}
</script>
{% endblock %}

