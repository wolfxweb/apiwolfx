{% extends "base.html" %}

{% block title %}Dashboard Financeiro - GIVM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-speedometer2"></i> Dashboard Financeiro</h1>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <!-- Período -->
            <div class="col-12 col-md-4">
                <label for="periodFilter" class="form-label">Período</label>
                <select class="form-select" id="periodFilter" onchange="toggleCustomPeriod(); loadKPIsOnly();">
                    <option value="">Todos os períodos</option>
                    <option value="today">Hoje</option>
                    <option value="this_week">Esta semana</option>
                    <option value="this_month" selected>Este mês</option>
                    <option value="last_month">Mês anterior</option>
                    <option value="next_month">Próximo mês</option>
                    <option value="next_30_days">Próximos 30 dias</option>
                    <option value="next_60_days">Próximos 60 dias</option>
                    <option value="next_90_days">Próximos 90 dias</option>
                    <option value="this_year">Este ano</option>
                    <option value="custom">Período personalizado</option>
                </select>
            </div>
            
            <!-- Filtros de categoria e centro de custo removidos -->
            
            <!-- Período personalizado (oculto por padrão) -->
            <div class="col-12 col-md-3" id="customPeriodRow" style="display: none;">
                <label for="dateFrom" class="form-label">Data inicial</label>
                <input type="date" class="form-control" id="dateFrom" onchange="loadKPIsOnly()">
            </div>
            <div class="col-12 col-md-3" id="customPeriodRow2" style="display: none;">
                <label for="dateTo" class="form-label">Data final</label>
                <input type="date" class="form-control" id="dateTo" onchange="loadKPIsOnly()">
            </div>
            
            <!-- Ações -->
            <div class="col-12 col-md-2">
                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Limpar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resumo Financeiro -->
<div class="row mb-4">
    <!-- Texto informativo sobre Fluxo de Caixa -->
    <div class="col-12">
        <div class="alert alert-info mb-3" id="cashflow-info" style="cursor: pointer;" onclick="this.style.display='none'">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-info-circle"></i>
                    <strong>Fluxo de Caixa:</strong> Estes indicadores representam o movimento real de dinheiro (entradas e saídas) no período selecionado. 
                    <strong>Receitas Recebidas</strong>: valores que realmente entraram no caixa. 
                    <strong>Despesas Pagas</strong>: valores que realmente saíram do caixa.
                </div>
                
                <i class="bi bi-x-circle ms-2"></i>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Receitas Recebidas
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Valor total das receitas já recebidas no período (contas a receber pagas + pedidos ML recebidos)"></i>
                        </h6>
                        <h4 class="mb-0" id="receivedRevenue">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Receitas Pendentes
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Valor total das receitas ainda não recebidas com vencimento no período"></i>
                        </h6>
                        <h4 class="mb-0" id="pendingRevenue">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Despesas Pagas
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Valor total das despesas já pagas no período"></i>
                        </h6>
                        <h4 class="mb-0" id="paidExpenses">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Despesas Pendentes
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Valor total das despesas ainda não pagas com vencimento no período"></i>
                        </h6>
                        <h4 class="mb-0" id="pendingExpenses">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumo Consolidado -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white" id="monthlyProfitCard" style="background: linear-gradient(135deg, #28a745, #20c997);">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Resultado Projetado
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="Diferença entre receitas totais e despesas totais do período"></i>
                        </h6>
                        <h4 class="mb-0" id="monthlyProfit">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-graph-up fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white" id="cashFlowCard" style="background: linear-gradient(135deg, #6c757d, #495057);">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Resultado Real
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="FLUXO DE CAIXA REAL: Mostra a diferença entre o dinheiro que realmente entrou (receitas recebidas) e o que realmente saiu (despesas pagas) do caixa no período. Este é o movimento efetivo de dinheiro, não o faturamento."></i>
                        </h6>
                        <h4 class="mb-0" id="cashFlow">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-cash-coin fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white" id="currentBalanceCard" style="background: linear-gradient(135deg, #007bff, #0056b3);">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">
                            Projeção de Caixa
                            <i class="bi bi-question-circle" data-bs-toggle="tooltip" data-bs-placement="top" title="PROJEÇÃO DE CAIXA: Calcula quanto você terá no caixa considerando: Saldo atual + Receitas pendentes - Despesas pendentes. Mostra a situação futura do seu fluxo de caixa."></i>
                        </h6>
                        <h4 class="mb-0" id="currentBalance">R$ 0,00</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-wallet2 fs-1"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Seção DRE -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
  
            <div class="card-body">
                <!-- Texto informativo sobre DRE -->
                <div class="alert alert-success mb-3" id="dre-info" style="cursor: pointer;" onclick="this.style.display='none'">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-graph-up"></i>
                            <strong>Demonstração de Resultados:</strong> Apresenta o <strong>faturamento</strong> com base nas datas de vencimento das contas a receber e na <strong>data de emissão dos pedidos do Mercado Livre</strong>. 
                            As <strong>despesas</strong> são consideradas de acordo com suas datas de vencimento (quando deveriam ser pagas). 
                            Esta é uma visão contábil do negócio, diferente do fluxo de caixa.
                        </div>
                        
                        <i class="bi bi-x-circle ms-2"></i>
                    </div>
                </div>
                
                <!-- Gráfico de linha -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div style="height: 400px;">
                            <canvas id="dreChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="dre-loading" class="text-center py-3" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando dados do DRE...</p>
                </div>
                
                <div id="dre-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar dados do DRE
                </div>
                
                <div id="dre-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> Demonstração de Resultados</h6>
                        <small class="text-muted">Receitas e despesas por período</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-start">Descrição</th>
                                    <th class="text-center" id="months-header">
                                        <!-- Cabeçalhos dos meses serão inseridos aqui -->
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="dre-tbody">
                                <!-- Dados serão inseridos aqui via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Tabela de Contas Financeiras -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="bi bi-credit-card"></i> Contas Financeiras</h6>
                            <small class="text-muted">Resumo das contas da empresa</small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-striped table-sm mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th class="text-start">Conta</th>
                                        <th class="text-center">Saldo/Fatura</th>
                                        <th class="text-center">Limite</th>
                                        <th class="text-center">Vencimento</th>
                                        <th class="text-center">Ação</th>
                                    </tr>
                                </thead>
                                <tbody id="financial-accounts-tbody">
                                    <!-- Dados serão inseridos aqui via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção Receitas e Despesas por Categoria - Lado a Lado -->
<div class="row mt-4">
    <!-- Receitas por Categoria -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">

            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-6 col-md-4">
                        <label for="revenueMonthFilter" class="form-label">Mês</label>
                        <select class="form-select" id="revenueMonthFilter" onchange="loadRevenuesByCategory()">
                            <option value="">Todos os meses</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-4">
                        <label for="revenueTypeFilter" class="form-label">Tipo</label>
                        <select class="form-select" id="revenueTypeFilter" onchange="loadRevenuesByCategory()">
                            <option value="">Todos os tipos</option>
                            <option value="paid">Recebidas</option>
                            <option value="pending">Pendentes</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-4">
                        <label for="revenueComparisonMode" class="form-label">Modo</label>
                        <select class="form-select" id="revenueComparisonMode" onchange="toggleRevenueComparisonMode()">
                            <option value="single">Período Único</option>
                            <option value="compare">Comparar Períodos</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filtros de Comparação -->
                <div id="revenueComparisonFilters" class="row mb-3" style="display: none;">
                    <div class="col-6 col-md-6">
                        <label for="revenuePeriod1Filter" class="form-label">Período 1</label>
                        <select class="form-select" id="revenuePeriod1Filter" onchange="loadRevenuesByCategory()">
                            <option value="">Selecione o período</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="revenuePeriod2Filter" class="form-label">Período 2</label>
                        <select class="form-select" id="revenuePeriod2Filter" onchange="loadRevenuesByCategory()">
                            <option value="">Selecione o período</option>
                        </select>
                    </div>
                </div>
                
                <!-- Gráfico -->
                <div class="row">
                    <div class="col-12">
                        <div style="height: 350px;">
                            <canvas id="revenuesByCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Legenda -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div id="revenue-legend">
                            <!-- Legenda será inserida aqui -->
                        </div>
                    </div>
                </div>
                
                <div id="revenue-loading" class="text-center py-3" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando dados por categoria...</p>
                </div>
                
                <div id="revenue-initial" class="text-center py-5" style="display: none;">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Selecione os filtros para visualizar o gráfico</h5>
                    <p class="text-muted">Escolha o centro de custo, mês e tipo para começar</p>
                </div>
                
                <div id="revenue-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar dados por categoria
                </div>
            </div>
        </div>
    </div>
    
    <!-- Despesas por Categoria -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">

            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-6 col-md-3">
                        <label for="categoryCostCenterFilter" class="form-label">Centro de Custo</label>
                        <select class="form-select" id="categoryCostCenterFilter" onchange="loadExpensesByCategory()">
                            <option value="">Todos os centros de custo</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label for="categoryMonthFilter" class="form-label">Mês</label>
                        <select class="form-select" id="categoryMonthFilter" onchange="loadExpensesByCategory()">
                            <option value="">Todos os meses</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label for="categoryTypeFilter" class="form-label">Tipo</label>
                        <select class="form-select" id="categoryTypeFilter" onchange="loadExpensesByCategory()">
                            <option value="">Todos os tipos</option>
                            <option value="paid">Pagas</option>
                            <option value="pending">Pendentes</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <label for="comparisonMode" class="form-label">Modo</label>
                        <select class="form-select" id="comparisonMode" onchange="toggleComparisonMode()">
                            <option value="single">Período Único</option>
                            <option value="compare">Comparar Períodos</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filtros de Comparação (ocultos por padrão) -->
                <div id="comparisonFilters" class="row mb-3" style="display: none;">
                    <div class="col-6 col-md-6">
                        <label for="period1Filter" class="form-label">Período 1</label>
                        <select class="form-select" id="period1Filter" onchange="loadExpensesByCategory()">
                            <option value="">Selecione o período</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-6">
                        <label for="period2Filter" class="form-label">Período 2</label>
                        <select class="form-select" id="period2Filter" onchange="loadExpensesByCategory()">
                            <option value="">Selecione o período</option>
                        </select>
                    </div>
                </div>
                
                <!-- Gráfico de rosca -->
                <div class="row">
                    <div class="col-12">
                        <div style="height: 350px;">
                            <canvas id="expensesByCategoryChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Legenda -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div id="category-legend">
                            <!-- Legenda será inserida aqui -->
                        </div>
                    </div>
                </div>
                
                <div id="category-loading" class="text-center py-3" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Carregando dados por categoria...</p>
                </div>
                
                <div id="category-error" class="alert alert-danger" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar dados por categoria
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seção Análise de Planejamento vs Real -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Título -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Análise de Evolução: Planejamento vs Real</h6>
                    <small class="text-muted">Comparação entre planejado e realizado</small>
                </div>
                
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="planningYearFilter" class="form-label">Ano do Planejamento</label>
                        <select class="form-select" id="planningYearFilter" onchange="loadPlanningAnalysis()">
                            <option value="">Selecione o ano</option>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                </div>

                <!-- Loading -->
                <div id="planning-analysis-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2">Carregando análise de planejamento...</p>
                </div>

                <!-- Erro -->
                <div id="planning-analysis-error" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Erro:</strong> <span id="planning-analysis-error-message"></span>
                </div>

                <!-- Conteúdo da Análise -->
                <div id="planning-analysis-content" style="display: none;">
                    <!-- Resumo Executivo -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-clipboard-data"></i> Resumo Executivo</h6>
                        <small class="text-muted">Comparação entre planejado e realizado</small>
                    </div>
                    <div class="row mb-4" id="planning-summary">
                        <!-- Resumo será preenchido aqui -->
                    </div>

                    <!-- Gráfico de Comparação -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Evolução Planejado vs Real</h6>
                        <small class="text-muted">Gráfico de comparação mensal</small>
                    </div>
                    <div class="row mb-4">
                        <div class="col-12">
                            <div style="height: 400px;">
                                <canvas id="planningComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela Detalhada -->
                    <div class="d-flex justify-content-between align-items-center mb-3 mt-4">
                        <h6 class="mb-0"><i class="bi bi-table"></i> Comparação Detalhada</h6>
                        <small class="text-muted">Dados mensais detalhados</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Mês</th>
                                    <th class="text-end">Planejado</th>
                                    <th class="text-end">Mercado Livre</th>
                                    <th class="text-end">Contas a Receber</th>
                                    <th class="text-end">Total Real</th>
                                    <th class="text-end">Diferença</th>
                                    <th class="text-end">% Atingido</th>
                                    <th class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="planning-comparison-table">
                                <!-- Dados serão preenchidos aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seções removidas: Gráfico de Receitas vs Despesas e Top Categorias -->

<!-- Seções removidas: Contas a Receber e Contas a Pagar -->

<!-- Seção removida: Ações Rápidas -->

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Variáveis globais
let dashboardData = {};
let revenueExpensesChart = null;
let categoriesChart = null;

// Variáveis para receitas por categoria
let revenuesByCategoryChart = null;
let revenuesByCategoryData = null;
let revenuesByCategoryData2 = null; // Para comparação
let revenueFiltersData = null;

// Carregar dados ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados do dashboard
    loadDashboardData();
    
    // Inicializar tooltips do Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Função para mostrar spinner de loading (APENAS NOS KPIs)
function showLoadingSpinner() {
    console.log('🔄 Mostrando spinner APENAS nos KPIs...');
    
    // Mostrar spinner apenas nos valores dos cards (não quebrar a estrutura)
    const cardValues = ['receivedRevenue', 'pendingRevenue', 'paidExpenses', 'pendingExpenses', 'monthlyProfit', 'currentBalance', 'cashFlow'];
    cardValues.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            console.log(`🔄 Mostrando spinner para: ${id}`);
            element.innerHTML = '<div class="spinner-border spinner-border-sm text-light" role="status"><span class="visually-hidden">Carregando...</span></div>';
        }
    });
    
    // GARANTIR: Não afetar gráficos de forma alguma
    console.log('✅ Spinner mostrado apenas nos KPIs - gráficos não afetados');
}

// Função para esconder spinner de loading (APENAS NOS KPIs)
function hideLoadingSpinner() {
    // Os valores dos KPIs serão atualizados pela função updateDashboardStats()
    // Não precisa fazer nada aqui, pois os spinners serão substituídos pelos valores reais
}

// Função para carregar APENAS KPIs (sem afetar gráficos)
async function loadKPIsOnly() {
    try {
        console.log('🔄 Atualizando APENAS KPIs (gráficos permanecem)...');
        
        // Mostrar spinner apenas nos KPIs
        showLoadingSpinner();
        
        const periodFilter = document.getElementById('periodFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        // Construir parâmetros da URL - APENAS PARA KPIs
        const params = new URLSearchParams();
        params.append('period', periodFilter);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        
        const response = await fetch(`/api/financial/dashboard?${params.toString()}`, {
            credentials: 'include'
        });
        if (response.ok) {
            dashboardData = await response.json();
            hideLoadingSpinner();
            updateDashboardStats();
            console.log('✅ KPIs atualizados - gráficos mantidos');
        } else {
            hideLoadingSpinner();
            showAlert('Erro ao carregar dados do dashboard', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        hideLoadingSpinner();
        showAlert('Erro ao carregar dados do dashboard', 'danger');
    }
}

// Função para carregar dados do dashboard (APENAS KPIs - COM FILTRO DE PERÍODO)
async function loadDashboardData() {
    try {
        // Mostrar spinner
        showLoadingSpinner();
        
        const periodFilter = document.getElementById('periodFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        // Construir parâmetros da URL - APENAS PARA KPIs
        const params = new URLSearchParams();
        params.append('period', periodFilter);
        if (dateFrom) params.append('date_from', dateFrom);
        if (dateTo) params.append('date_to', dateTo);
        
        // Filtros de categoria e centro de custo removidos
        
        const response = await fetch(`/api/financial/dashboard?${params.toString()}`, {
            credentials: 'include'
        });
        if (response.ok) {
            dashboardData = await response.json();
            hideLoadingSpinner(); // Esconder spinner antes de atualizar
            updateDashboardStats();
        } else {
            hideLoadingSpinner(); // Esconder spinner mesmo em caso de erro
            showAlert('Erro ao carregar dados do dashboard', 'danger');
        }
    } catch (error) {
        console.error('Erro:', error);
        hideLoadingSpinner(); // Esconder spinner em caso de erro
        showAlert('Erro ao carregar dados do dashboard', 'danger');
    }
}

// Função para atualizar estatísticas do dashboard
function updateDashboardStats() {
    console.log('📊 Atualizando estatísticas dos KPIs...');
    const data = dashboardData;
    
    // Receitas
    document.getElementById('receivedRevenue').textContent = 'R$ ' + (data.received_revenue || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('pendingRevenue').textContent = 'R$ ' + (data.pending_revenue || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    
    // Despesas
    document.getElementById('paidExpenses').textContent = 'R$ ' + (data.paid_expenses || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('pendingExpenses').textContent = 'R$ ' + (data.pending_expenses || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    
    // Resumo consolidado
    document.getElementById('monthlyProfit').textContent = 'R$ ' + (data.monthly_profit || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('currentBalance').textContent = 'R$ ' + (data.current_balance || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    document.getElementById('cashFlow').textContent = 'R$ ' + (data.cash_flow || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2});
    
    // Mudar cores dinamicamente baseado nos valores
    updateCardColors(data);
    
    console.log('✅ KPIs atualizados com sucesso');
}

function updateCardColors(data) {
    // Lucro do Mês - Verde se positivo, vermelho se negativo
    const monthlyProfitCard = document.getElementById('monthlyProfitCard');
    const monthlyProfit = data.monthly_profit || 0;
    if (monthlyProfit >= 0) {
        monthlyProfitCard.style.background = 'linear-gradient(135deg, #28a745, #20c997)'; // Verde
    } else {
        monthlyProfitCard.style.background = 'linear-gradient(135deg, #dc3545, #c82333)'; // Vermelho
    }
    
    // Resultado Real - Verde se positivo, vermelho se negativo
    const cashFlowCard = document.getElementById('cashFlowCard');
    const cashFlow = data.cash_flow || 0;
    if (cashFlow >= 0) {
        cashFlowCard.style.background = 'linear-gradient(135deg, #28a745, #20c997)'; // Verde
    } else {
        cashFlowCard.style.background = 'linear-gradient(135deg, #dc3545, #c82333)'; // Vermelho
    }
    
    // Projeção de Caixa - Verde se positivo, vermelho se negativo
    const currentBalanceCard = document.getElementById('currentBalanceCard');
    const currentBalance = data.current_balance || 0;
    if (currentBalance >= 0) {
        currentBalanceCard.style.background = 'linear-gradient(135deg, #28a745, #20c997)'; // Verde
    } else {
        currentBalanceCard.style.background = 'linear-gradient(135deg, #dc3545, #c82333)'; // Vermelho
    }
}

// Função removida: createCharts

// Função removida: createRevenueExpensesChart

// Função removida: createCategoriesChart

// Função removida: updateTables

// Funções removidas: updateReceivablesTable, updatePayablesTable

// Funções auxiliares
function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
}

function getStatusBadgeClass(status) {
    switch (status) {
        case 'pending': return 'bg-warning';
        case 'paid': return 'bg-success';
        case 'received': return 'bg-success';
        case 'overdue': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getStatusLabel(status) {
    switch (status) {
        case 'pending': return 'Pendente';
        case 'paid': return 'Pago';
        case 'received': return 'Recebido';
        case 'overdue': return 'Vencido';
        default: return status;
    }
}

// Função para limpar filtros
function clearFilters() {
    document.getElementById('periodFilter').value = 'this_month';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    
    // Ocultar período personalizado
    document.getElementById('customPeriodRow').style.display = 'none';
    document.getElementById('customPeriodRow2').style.display = 'none';
    
    loadDashboardData();
}

// Função para mostrar/ocultar período personalizado
function toggleCustomPeriod() {
    const periodFilter = document.getElementById('periodFilter').value;
    const customPeriodRow = document.getElementById('customPeriodRow');
    const customPeriodRow2 = document.getElementById('customPeriodRow2');
    
    if (periodFilter === 'custom') {
        customPeriodRow.style.display = 'block';
        customPeriodRow2.style.display = 'block';
    } else {
        customPeriodRow.style.display = 'none';
        customPeriodRow2.style.display = 'none';
    }
}

function showAlert(message, type) {
    // Criar alerta Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Tentar encontrar container adequado
    let container = document.querySelector('.container-fluid');
    if (!container) {
        container = document.querySelector('.container');
    }
    if (!container) {
        container = document.querySelector('main');
    }
    if (!container) {
        container = document.body;
    }
    
    // Inserir no topo do container encontrado
    if (container) {
        container.insertBefore(alertDiv, container.firstChild);
    }
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Funções para DRE
let dreData = null;

// Função para carregar dados do DRE (SEM FILTRO DE PERÍODO - TODOS OS DADOS)
async function loadDreData() {
    try {
        // Mostrar loading do DRE
        document.getElementById('dre-loading').style.display = 'block';
        document.getElementById('dre-error').style.display = 'none';
        document.getElementById('dre-content').style.display = 'none';

        // DRE sempre carrega TODOS os dados (sem filtro de período)
        const response = await fetch('/api/financial/dre', {
            credentials: 'include'
        });
        if (!response.ok) {
            throw new Error('Erro ao carregar dados do DRE');
        }

        dreData = await response.json();
        console.log('DRE Data recebida (TODOS OS DADOS):', dreData);
        console.log('Meses:', dreData.months);
        console.log('Dados:', dreData.data);
        document.getElementById('dre-loading').style.display = 'none';
        document.getElementById('dre-content').style.display = 'block';
        renderDreTable();
        createDreChart();
        
        // REMOVIDO: Loading do gráfico DRE
        document.getElementById('dre-content').style.display = 'block';
        
        // Carregar contas financeiras
        await loadFinancialAccounts();
    } catch (error) {
        console.error('Erro ao carregar DRE:', error);
        // REMOVIDO: Loading do gráfico DRE
        document.getElementById('dre-error').style.display = 'block';
    }
}

// Função para carregar contas financeiras
async function loadFinancialAccounts() {
    try {
        console.log('🚀 Carregando contas financeiras...');
        const response = await fetch('/api/financial/accounts', {
            credentials: 'include'
        });
        
        console.log('📡 Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`Erro ao carregar contas financeiras: ${response.status}`);
        }
        
        const accountsData = await response.json();
        console.log('📊 Dados das contas recebidos:', accountsData);
        renderFinancialAccountsTable(accountsData);
        
    } catch (error) {
        console.error('❌ Erro ao carregar contas financeiras:', error);
    }
}

// Função para renderizar tabela de contas financeiras
function renderFinancialAccountsTable(accounts) {
    const tbody = document.getElementById('financial-accounts-tbody');
    tbody.innerHTML = '';
    
    if (!accounts || accounts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <i class="bi bi-info-circle"></i> Nenhuma conta financeira encontrada
                </td>
            </tr>
        `;
        return;
    }
    
    accounts.forEach(account => {
        const row = document.createElement('tr');
        
        // Determinar se é cartão de crédito
        const isCreditCard = account.account_type && 
            account.account_type.toLowerCase().includes('credit') ||
            account.account_type.toLowerCase().includes('cartão') ||
            account.account_type.toLowerCase().includes('cartao');
        
        // Determinar cor do saldo
        let balanceClass = '';
        if (isCreditCard) {
            balanceClass = account.current_balance > 0 ? 'text-danger' : 'text-success';
        } else {
            balanceClass = account.current_balance >= 0 ? 'text-success' : 'text-danger';
        }
        
        // Formatar limite
        const limitText = account.limit_amount && account.limit_amount > 0 ? 
            formatCurrency(account.limit_amount) : '-';
        
        // Data de vencimento (para cartões)
        let dueDateText = '-';
        if (isCreditCard && account.invoice_due_day) {
            const today = new Date();
            const dueDay = account.invoice_due_day;
            let dueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
            if (dueDate < today) {
                dueDate = new Date(today.getFullYear(), today.getMonth() + 1, dueDay);
            }
            dueDateText = dueDate.toLocaleDateString('pt-BR');
        }
        
        // Nome da conta
        const accountName = account.account_name || account.bank_name || 'Conta';
        const accountType = account.account_type || 'Conta Corrente';
        
        row.innerHTML = `
            <td>
                <strong>${accountName}</strong>
                <br><small class="text-muted">${accountType}</small>
            </td>
            <td class="text-center ${balanceClass}">
                <strong>${formatCurrency(account.current_balance)}</strong>
                ${isCreditCard ? '<br><small class="text-muted">Fatura Atual</small>' : ''}
            </td>
            <td class="text-center">${limitText}</td>
            <td class="text-center">${dueDateText}</td>
            <td class="text-center">
                <a href="/financial/account-transactions/${account.id}" 
                   class="btn btn-sm btn-outline-primary" 
                   target="_blank">
                    <i class="bi bi-eye"></i> Ver Transações
                </a>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function renderDreTable() {
    if (!dreData || !dreData.data) return;

    const tbody = document.getElementById('dre-tbody');
    const monthsHeader = document.getElementById('months-header');
    tbody.innerHTML = '';

    // Criar cabeçalhos dos meses
    const monthsHeaderRow = monthsHeader.parentElement;
    monthsHeaderRow.innerHTML = `
        <th class="text-start">Descrição</th>
        ${dreData.months.map(month => 
            `<th class="text-center">${month}</th>`
        ).join('')}
    `;

    // Dados já estão consolidados na nova estrutura
    const data = dreData.data;

    // Criar linhas de receitas e despesas
    const revenueRow = document.createElement('tr');
    revenueRow.innerHTML = `
        <td class="fw-bold text-success">RECEITAS</td>
        ${dreData.months.map((month, index) => {
            const isFuture = index < 3; // Primeiros 3 meses são futuros
            const bgClass = isFuture ? 'bg-warning' : '';
            return `<td class="text-end text-success fw-bold ${bgClass}">${formatCurrency(data.RECEITAS.total[month])}</td>`;
        }).join('')}
    `;
    tbody.appendChild(revenueRow);

    const receivablesRow = document.createElement('tr');
    receivablesRow.innerHTML = `
        <td style="padding-left: 2rem;">Contas a Receber</td>
        ${dreData.months.map((month, index) => {
            const isFuture = index < 3; // Primeiros 3 meses são futuros
            const bgClass = isFuture ? 'bg-warning' : '';
            return `<td class="text-end ${bgClass}">${formatCurrency(data.RECEITAS['Contas a Receber'][month])}</td>`;
        }).join('')}
    `;
    tbody.appendChild(receivablesRow);

    const mlRow = document.createElement('tr');
    mlRow.innerHTML = `
        <td style="padding-left: 2rem;">Mercado Livre</td>
        ${dreData.months.map((month, index) => {
            const isFuture = index < 3; // Primeiros 3 meses são futuros
            const bgClass = isFuture ? 'bg-warning' : '';
            return `<td class="text-end ${bgClass}">${formatCurrency(data.RECEITAS['Mercado Livre'][month])}</td>`;
        }).join('')}
    `;
    tbody.appendChild(mlRow);

    // Linha em branco
    const blankRow = document.createElement('tr');
    blankRow.innerHTML = `
        <td></td>
        ${dreData.months.map(() => `<td></td>`).join('')}
    `;
    tbody.appendChild(blankRow);

    const expensesRow = document.createElement('tr');
    expensesRow.innerHTML = `
        <td class="fw-bold text-danger">DESPESAS</td>
        ${dreData.months.map(month => 
            `<td class="text-end text-danger fw-bold">${formatCurrency(data.DESPESAS.total[month])}</td>`
        ).join('')}
    `;
    tbody.appendChild(expensesRow);

    // Adicionar linha específica para Taxas Mercado Livre
    if (data.DESPESAS['Taxas Mercado Livre']) {
        const mlFeesRow = document.createElement('tr');
        mlFeesRow.innerHTML = `
            <td style="padding-left: 2rem;">Taxas Mercado Livre</td>
            ${dreData.months.map(month => 
                `<td class="text-end">${formatCurrency(data.DESPESAS['Taxas Mercado Livre'][month] || 0)}</td>`
            ).join('')}
        `;
        tbody.appendChild(mlFeesRow);
    }

    // Adicionar linhas por centro de custo
    if (dreData.cost_centers) {
        Object.keys(dreData.cost_centers).forEach(ccName => {
            const ccRow = document.createElement('tr');
            ccRow.innerHTML = `
                <td style="padding-left: 2rem;">${ccName}</td>
                ${dreData.months.map(month => 
                    `<td class="text-end">${formatCurrency(dreData.cost_centers[ccName][month] || 0)}</td>`
                ).join('')}
            `;
            tbody.appendChild(ccRow);
        });
    }

    // Linha em branco
    const blankRow2 = document.createElement('tr');
    blankRow2.innerHTML = `
        <td></td>
        ${dreData.months.map(() => `<td></td>`).join('')}
    `;
    tbody.appendChild(blankRow2);

    const resultRow = document.createElement('tr');
    resultRow.className = '';
    resultRow.innerHTML = `
        <td class="fw-bold">RESULTADO</td>
        ${dreData.months.map((month, index) => {
            const result = data.RESULTADO.total[month];
            const isFuture = index < 3; // Primeiros 3 meses são futuros
            const colorClass = result >= 0 ? 'text-success' : 'text-danger';
            const bgClass = isFuture ? 'bg-warning' : '';
            return `<td class="text-end fw-bold ${colorClass} ${bgClass}">${formatCurrency(result)}</td>`;
        }).join('')}
    `;
    tbody.appendChild(resultRow);
}

function formatCurrency(value) {
    if (value === 0) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value);
}

function exportDreToExcel() {
    if (!dreData) {
        alert('Nenhum dado disponível para exportar');
        return;
    }

    // Preparar dados para Excel
    const excelData = [];
    
    // Cabeçalho
    excelData.push(['Centro de Custo', 'Mês', 'Receitas - Contas a Receber', 'Receitas - Mercado Livre', 'Total Receitas', 'Despesas', 'Resultado']);
    
    // Dados
    dreData.dre_data.forEach(center => {
        center.months.forEach(monthData => {
            excelData.push([
                center.cost_center_name,
                monthData.name,
                monthData.receivables_revenue,
                monthData.ml_revenue,
                monthData.total_revenue,
                monthData.expenses,
                monthData.result
            ]);
        });
    });

    // Criar workbook
    const ws = XLSX.utils.aoa_to_sheet(excelData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'DRE');

    // Exportar
    XLSX.writeFile(wb, `DRE_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// Variáveis para gráfico de despesas por categoria
let expensesByCategoryChart = null;
let expensesByCategoryData = null;
let expensesByCategoryData2 = null; // Para comparação
let filtersData = null;

// Variáveis para análise de planejamento
let planningComparisonChart = null;
let planningAnalysisData = null;

// Função para carregar filtros disponíveis
async function loadExpensesFilters() {
    try {
        const response = await fetch('/api/financial/expenses-filters', {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Erro ao carregar filtros');
        }

        filtersData = await response.json();
        console.log('Filtros carregados:', filtersData);
        
        // Popular combo de centros de custo
        const costCenterSelect = document.getElementById('categoryCostCenterFilter');
        costCenterSelect.innerHTML = '<option value="">Todos os centros de custo</option>';
        filtersData.cost_centers.forEach(cc => {
            const option = document.createElement('option');
            option.value = cc;
            option.textContent = cc;
            costCenterSelect.appendChild(option);
        });
        
        // Popular combo de meses
        const monthSelect = document.getElementById('categoryMonthFilter');
        monthSelect.innerHTML = '<option value="">Todos os meses</option>';
        filtersData.months.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            if (month === filtersData.current_month) {
                option.selected = true;
            }
            monthSelect.appendChild(option);
        });
        
        // Popular combos de comparação
        populateComparisonFilters();
        
    } catch (error) {
        console.error('Erro ao carregar filtros:', error);
    }
}

// Função para popular filtros de comparação
function populateComparisonFilters() {
    if (!filtersData) return;
    
    const period1Select = document.getElementById('period1Filter');
    const period2Select = document.getElementById('period2Filter');
    
    // Limpar opções
    period1Select.innerHTML = '<option value="">Selecione o período</option>';
    period2Select.innerHTML = '<option value="">Selecione o período</option>';
    
    // Adicionar meses disponíveis
    filtersData.months.forEach(month => {
        const option1 = document.createElement('option');
        option1.value = month;
        option1.textContent = month;
        period1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = month;
        option2.textContent = month;
        period2Select.appendChild(option2);
    });
}

// Função para alternar modo de comparação
function toggleComparisonMode() {
    const comparisonMode = document.getElementById('comparisonMode').value;
    const comparisonFilters = document.getElementById('comparisonFilters');
    
    if (comparisonMode === 'compare') {
        comparisonFilters.style.display = 'block';
        // Não carregar dados ainda, aguardar seleção dos períodos
    } else {
        comparisonFilters.style.display = 'none';
        // Limpar dados de comparação
        expensesByCategoryData2 = null;
        // Carregar dados do modo único
        loadExpensesByCategory();
    }
}

// Função para carregar dados de despesas por categoria (SEM FILTRO DE PERÍODO - TODOS OS DADOS)
async function loadExpensesByCategory() {
    try {
        // Mostrar loading das despesas
        document.getElementById('category-loading').style.display = 'block';
        document.getElementById('category-error').style.display = 'none';

        const comparisonMode = document.getElementById('comparisonMode').value;
        
        if (comparisonMode === 'compare') {
            // Modo comparação - carregar dois períodos
            await loadComparisonData();
            
            // Se não há dados de comparação, não criar gráfico
            if (!expensesByCategoryData || !expensesByCategoryData2) {
                // REMOVIDO: Loading do gráfico de despesas
                return;
            }
        } else {
            // Modo único - carregar TODOS os dados (sem filtro de período)
            await loadSinglePeriodData();
        }
        
        createExpensesByCategoryChart();
        // Esconder loading e mostrar gráfico
        document.getElementById('category-loading').style.display = 'none';
        document.getElementById('expensesByCategoryChart').parentElement.style.display = 'block';
    } catch (error) {
        console.error('Erro ao carregar dados por categoria:', error);
        // Esconder loading e mostrar erro
        document.getElementById('category-loading').style.display = 'none';
        document.getElementById('category-error').style.display = 'block';
    }
}

// Função para carregar dados de período único
async function loadSinglePeriodData() {
    const costCenter = document.getElementById('categoryCostCenterFilter').value;
    const month = document.getElementById('categoryMonthFilter').value;
    const type = document.getElementById('categoryTypeFilter').value;

    const params = new URLSearchParams();
    if (costCenter) params.append('cost_center', costCenter);
    if (month) params.append('month', month);
    if (type) params.append('type', type);

    const response = await fetch(`/api/financial/expenses-by-category?${params}`, {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    if (!response.ok) {
        throw new Error('Erro ao carregar dados por categoria');
    }

    expensesByCategoryData = await response.json();
    expensesByCategoryData2 = null; // Limpar dados de comparação
    console.log('Dados por categoria recebidos:', expensesByCategoryData);
}

// Função para carregar dados de comparação
async function loadComparisonData() {
    const costCenter = document.getElementById('categoryCostCenterFilter').value;
    const type = document.getElementById('categoryTypeFilter').value;
    const period1 = document.getElementById('period1Filter').value;
    const period2 = document.getElementById('period2Filter').value;

    if (!period1 || !period2) {
        console.log('Aguardando seleção dos períodos para comparação...');
        return; // Não fazer nada se os períodos não estão selecionados
    }

    // Carregar período 1
    const params1 = new URLSearchParams();
    if (costCenter) params1.append('cost_center', costCenter);
    if (period1) params1.append('month', period1);
    if (type) params1.append('type', type);

    const response1 = await fetch(`/api/financial/expenses-by-category?${params1}`, {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    if (!response1.ok) {
        throw new Error('Erro ao carregar dados do período 1');
    }

    expensesByCategoryData = await response1.json();
    expensesByCategoryData.period = period1;

    // Carregar período 2
    const params2 = new URLSearchParams();
    if (costCenter) params2.append('cost_center', costCenter);
    if (period2) params2.append('month', period2);
    if (type) params2.append('type', type);

    const response2 = await fetch(`/api/financial/expenses-by-category?${params2}`, {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    if (!response2.ok) {
        throw new Error('Erro ao carregar dados do período 2');
    }

    expensesByCategoryData2 = await response2.json();
    expensesByCategoryData2.period = period2;
    
    console.log('Dados de comparação carregados:', {
        periodo1: expensesByCategoryData,
        periodo2: expensesByCategoryData2
    });
}

// Função para criar gráfico de rosca das despesas por categoria
function createExpensesByCategoryChart() {
    if (!expensesByCategoryData || !expensesByCategoryData.categories) return;

    const ctx = document.getElementById('expensesByCategoryChart').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (expensesByCategoryChart) {
        expensesByCategoryChart.destroy();
    }

    const comparisonMode = document.getElementById('comparisonMode').value;
    
    if (comparisonMode === 'compare' && expensesByCategoryData2) {
        // Modo comparação - gráfico de barras
        createComparisonChart(ctx);
    } else {
        // Modo único - gráfico de rosca
        createSingleChart(ctx);
    }
}

// Função para criar gráfico único (rosca)
function createSingleChart(ctx) {
    const categories = expensesByCategoryData.categories;
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    const colors = generateColors(labels.length);
    
    const legendHtml = labels.map((label, index) => `
        <div class="d-flex align-items-center mb-2">
            <div class="me-2" style="width: 12px; height: 12px; background-color: ${colors[index]}; border-radius: 2px;"></div>
            <small>${label}: ${formatCurrency(data[index])}</small>
        </div>
    `).join('');

    document.getElementById('category-legend').innerHTML = legendHtml;

    expensesByCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Despesas por Categoria',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: '#333'
                },
                legend: {
                    display: false // Usamos nossa própria legenda
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// Função para criar gráfico de comparação (barras)
function createComparisonChart(ctx) {
    const categories1 = expensesByCategoryData.categories;
    const categories2 = expensesByCategoryData2.categories;
    const total1 = expensesByCategoryData.total;
    const total2 = expensesByCategoryData2.total;
    
    // Combinar todas as categorias
    const allCategories = new Set([...Object.keys(categories1), ...Object.keys(categories2)]);
    const labels = Array.from(allCategories);
    
    // Preparar dados
    const data1 = labels.map(cat => categories1[cat] || 0);
    const data2 = labels.map(cat => categories2[cat] || 0);
    
    expensesByCategoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: `Período 1 (${expensesByCategoryData.period})`,
                    data: data1,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: `Período 2 (${expensesByCategoryData2.period})`,
                    data: data2,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Comparação de Despesas por Categoria',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: '#333'
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const total = context.dataset.label.includes('Período 1') ? total1 : total2;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.dataset.label}: ${context.label} - ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
    
    // Criar legenda de comparação
    createComparisonLegend(labels, data1, data2, total1, total2);
}

// Função para criar legenda de comparação
function createComparisonLegend(labels, data1, data2, total1, total2) {
    const legendHtml = labels.map((label, index) => {
        const value1 = data1[index];
        const value2 = data2[index];
        const diff = value2 - value1;
        const diffPercent = value1 > 0 ? ((diff / value1) * 100).toFixed(1) : 0;
        const diffClass = diff > 0 ? 'text-danger' : diff < 0 ? 'text-success' : '';
        const diffIcon = diff > 0 ? '↗️' : diff < 0 ? '↘️' : '➡️';
        
        return `
            <div class="d-flex align-items-center mb-2">
                <div class="me-2" style="width: 12px; height: 12px; background-color: rgba(54, 162, 235, 0.8); border-radius: 2px;"></div>
                <div class="me-2" style="width: 12px; height: 12px; background-color: rgba(255, 99, 132, 0.8); border-radius: 2px;"></div>
                <small>
                    <strong>${label}:</strong><br>
                    P1: ${formatCurrency(value1)} | P2: ${formatCurrency(value2)}<br>
                    <span class="${diffClass}">${diffIcon} ${formatCurrency(Math.abs(diff))} (${diffPercent}%)</span>
                </small>
            </div>
        `;
    }).join('');

    document.getElementById('category-legend').innerHTML = legendHtml;
}

// Função para gerar cores dinamicamente
function generateColors(count) {
    const colors = [];
    const baseColors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    
    for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
    }
    
    return colors;
}

// ==================== FUNÇÕES PARA RECEITAS POR CATEGORIA ====================

// Função para carregar filtros de receitas
async function loadRevenueFilters() {
    console.log('🚀 Carregando filtros de Receitas por Categoria...');
    try {
        const response = await fetch('/api/financial/revenues-filters', {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Erro ao carregar filtros');
        }

        revenueFiltersData = await response.json();
        console.log('Filtros de receitas carregados:', revenueFiltersData);
        
        // Desabilitar eventos onchange temporariamente para evitar duplo carregamento
        const monthSelect = document.getElementById('revenueMonthFilter');
        const typeSelect = document.getElementById('revenueTypeFilter');
        
        // Remover onchange temporariamente
        monthSelect.removeAttribute('onchange');
        typeSelect.removeAttribute('onchange');
        
        // Popular combo de meses
        monthSelect.innerHTML = '<option value="">Todos os meses</option>';
        revenueFiltersData.months.forEach(month => {
            const option = document.createElement('option');
            option.value = month;
            option.textContent = month;
            if (month === revenueFiltersData.current_month) {
                option.selected = true;
            }
            monthSelect.appendChild(option);
        });
        
        // Popular combos de comparação
        populateRevenueComparisonFilters();
        
        // Reabilitar eventos onchange após um pequeno delay
        setTimeout(() => {
            monthSelect.setAttribute('onchange', 'loadRevenuesByCategory()');
            typeSelect.setAttribute('onchange', 'loadRevenuesByCategory()');
        }, 100);
        
        console.log('✅ Filtros de receitas carregados com sucesso!');
        
    } catch (error) {
        console.error('Erro ao carregar filtros de receitas:', error);
    }
}

// Função para popular filtros de comparação de receitas
function populateRevenueComparisonFilters() {
    if (!revenueFiltersData) return;
    
    const period1Select = document.getElementById('revenuePeriod1Filter');
    const period2Select = document.getElementById('revenuePeriod2Filter');
    
    // Limpar opções existentes
    period1Select.innerHTML = '<option value="">Selecione o período</option>';
    period2Select.innerHTML = '<option value="">Selecione o período</option>';
    
    // Adicionar meses disponíveis
    revenueFiltersData.months.forEach(month => {
        const option1 = document.createElement('option');
        option1.value = month;
        option1.textContent = month;
        period1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = month;
        option2.textContent = month;
        period2Select.appendChild(option2);
    });
}

// Função para alternar modo de comparação de receitas
function toggleRevenueComparisonMode() {
    const comparisonMode = document.getElementById('revenueComparisonMode').value;
    const comparisonFilters = document.getElementById('revenueComparisonFilters');
    
    if (comparisonMode === 'compare') {
        comparisonFilters.style.display = 'block';
    } else {
        comparisonFilters.style.display = 'none';
        // Limpar dados de comparação
        revenuesByCategoryData2 = null;
        // Carregar dados do modo único
        loadRevenuesByCategory();
    }
}

// Função para carregar dados de receitas por categoria (SEM FILTRO DE PERÍODO - TODOS OS DADOS)
async function loadRevenuesByCategory() {
    console.log('🚀 Iniciando carregamento de Receitas por Categoria (TODOS OS DADOS)...');
    try {
        // Mostrar loading das receitas
        document.getElementById('revenue-loading').style.display = 'block';
        document.getElementById('revenue-legend').innerHTML = '';
        document.getElementById('revenue-error').style.display = 'none';
        document.getElementById('revenue-initial').style.display = 'none';
        
        const comparisonMode = document.getElementById('revenueComparisonMode').value;
        
        if (comparisonMode === 'compare') {
            await loadRevenueComparisonData();
        } else {
            await loadSingleRevenueData();
        }
        
        // Esconder loading e mostrar gráfico
        document.getElementById('revenue-loading').style.display = 'none';
        document.getElementById('revenuesByCategoryChart').parentElement.style.display = 'block';
        
        console.log('✅ Receitas por Categoria carregado com sucesso (TODOS OS DADOS)!');
        
    } catch (error) {
        console.error('Erro ao carregar dados por categoria:', error);
        // REMOVIDO: Loading do gráfico de receitas
        document.getElementById('revenue-error').style.display = 'block';
    }
}

// Função para carregar dados de um período único
async function loadSingleRevenueData() {
    const month = document.getElementById('revenueMonthFilter').value;
    const type = document.getElementById('revenueTypeFilter').value;
    
    const params = new URLSearchParams();
    if (month) params.append('month', month);
    if (type) params.append('type', type);
    
    const response = await fetch(`/api/financial/revenues-by-category?${params}`, {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    if (!response.ok) {
        throw new Error('Erro ao carregar dados');
    }
    
    revenuesByCategoryData = await response.json();
    revenuesByCategoryData2 = null; // Limpar dados de comparação
    
    createRevenuesByCategoryChart();
}

// Função para carregar dados de comparação
async function loadRevenueComparisonData() {
    const type = document.getElementById('revenueTypeFilter').value;
    const period1 = document.getElementById('revenuePeriod1Filter').value;
    const period2 = document.getElementById('revenuePeriod2Filter').value;
    
    if (!period1 || !period2) {
        console.log('Períodos não selecionados para comparação');
        // Limpar dados e mostrar mensagem
        revenuesByCategoryData = null;
        revenuesByCategoryData2 = null;
        document.getElementById('revenue-legend').innerHTML = '<p class="text-muted text-center">Selecione ambos os períodos para comparação</p>';
        return;
    }
    
    // Carregar período 1
    const params1 = new URLSearchParams();
    if (period1) params1.append('month', period1);
    if (type) params1.append('type', type);
    
    const response1 = await fetch(`/api/financial/revenues-by-category?${params1}`, {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    if (!response1.ok) {
        throw new Error('Erro ao carregar dados do período 1');
    }
    
    revenuesByCategoryData = await response1.json();
    revenuesByCategoryData.period = period1;
    
    // Carregar período 2
    const params2 = new URLSearchParams();
    if (period2) params2.append('month', period2);
    if (type) params2.append('type', type);
    
    const response2 = await fetch(`/api/financial/revenues-by-category?${params2}`, {
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    });
    
    if (!response2.ok) {
        throw new Error('Erro ao carregar dados do período 2');
    }
    
    revenuesByCategoryData2 = await response2.json();
    revenuesByCategoryData2.period = period2;
    
    console.log('Dados de comparação de receitas carregados:', {
        periodo1: revenuesByCategoryData,
        periodo2: revenuesByCategoryData2
    });
    
    // Criar gráfico de comparação
    createRevenuesByCategoryChart();
}

// Função para criar gráfico de receitas por categoria
function createRevenuesByCategoryChart() {
    const canvas = document.getElementById('revenuesByCategoryChart');
    if (!canvas) {
        console.error('Canvas revenuesByCategoryChart não encontrado');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Destruir gráfico existente
    if (revenuesByCategoryChart) {
        revenuesByCategoryChart.destroy();
    }
    
    const comparisonMode = document.getElementById('revenueComparisonMode').value;
    
    if (comparisonMode === 'compare' && revenuesByCategoryData && revenuesByCategoryData2) {
        createRevenueComparisonChart(ctx);
    } else if (revenuesByCategoryData) {
        createSingleRevenueChart(ctx);
    }
}

// Função para criar gráfico único (rosca)
function createSingleRevenueChart(ctx) {
    const categories = revenuesByCategoryData.categories;
    const total = revenuesByCategoryData.total;
    
    if (total === 0) {
        // Mostrar mensagem quando não há dados
        document.getElementById('revenue-legend').innerHTML = '<p class="text-muted text-center">Nenhuma receita encontrada para os filtros selecionados</p>';
        return;
    }
    
    const labels = Object.keys(categories);
    const data = Object.values(categories);
    const colors = generateColors(labels.length);
    
    revenuesByCategoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Receitas por Categoria',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: '#333'
                },
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Criar legenda personalizada
    createRevenueLegend(labels, data, total);
}

// Função para criar gráfico de comparação (barras)
function createRevenueComparisonChart(ctx) {
    const categories1 = revenuesByCategoryData.categories;
    const categories2 = revenuesByCategoryData2.categories;
    const total1 = revenuesByCategoryData.total;
    const total2 = revenuesByCategoryData2.total;
    
    // Combinar todas as categorias
    const allCategories = new Set([...Object.keys(categories1), ...Object.keys(categories2)]);
    const labels = Array.from(allCategories);
    
    const data1 = labels.map(cat => categories1[cat] || 0);
    const data2 = labels.map(cat => categories2[cat] || 0);
    
    revenuesByCategoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: `Período 1 (${revenuesByCategoryData.period})`,
                    data: data1,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: `Período 2 (${revenuesByCategoryData2.period})`,
                    data: data2,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Comparação de Receitas por Categoria',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: '#333'
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            const total = context.dataset.label.includes('Período 1') ? total1 : total2;
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                            return `${context.dataset.label}: ${context.label} - ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
    
    // Criar legenda de comparação
    createRevenueComparisonLegend(labels, data1, data2, total1, total2);
}

// Função para criar legenda de receitas
function createRevenueLegend(labels, data, total) {
    const legendHtml = labels.map((label, index) => {
        const value = data[index];
        const percentage = ((value / total) * 100).toFixed(1);
        const color = generateColors(labels.length)[index];
        
        return `
            <div class="d-flex align-items-center mb-2">
                <div class="me-2" style="width: 12px; height: 12px; background-color: ${color}; border-radius: 2px;"></div>
                <small>
                    <strong>${label}:</strong> ${formatCurrency(value)} (${percentage}%)
                </small>
            </div>
        `;
    }).join('');
    
    document.getElementById('revenue-legend').innerHTML = legendHtml;
}

// Função para criar legenda de comparação de receitas
function createRevenueComparisonLegend(labels, data1, data2, total1, total2) {
    const legendHtml = labels.map((label, index) => {
        const value1 = data1[index];
        const value2 = data2[index];
        const diff = value2 - value1;
        const diffPercent = value1 > 0 ? ((diff / value1) * 100).toFixed(1) : 0;
        const diffClass = diff > 0 ? 'text-success' : diff < 0 ? 'text-danger' : '';
        const diffIcon = diff > 0 ? '↗️' : diff < 0 ? '↘️' : '➡️';
        
        return `
            <div class="d-flex align-items-center mb-2">
                <div class="me-2" style="width: 12px; height: 12px; background-color: rgba(54, 162, 235, 0.8); border-radius: 2px;"></div>
                <div class="me-2" style="width: 12px; height: 12px; background-color: rgba(255, 99, 132, 0.8); border-radius: 2px;"></div>
                <small>
                    <strong>${label}:</strong><br>
                    P1: ${formatCurrency(value1)} | P2: ${formatCurrency(value2)}<br>
                    <span class="${diffClass}">${diffIcon} ${formatCurrency(Math.abs(diff))} (${diffPercent}%)</span>
                </small>
            </div>
        `;
    }).join('');
    
    document.getElementById('revenue-legend').innerHTML = legendHtml;
}

// Carregar dados automaticamente quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // ========================================
    // SEPARAÇÃO DE RESPONSABILIDADES:
    // ========================================
    // 1. KPIs (loadDashboardData) - COM filtro de período
    // 2. Gráficos (loadDreData, loadExpensesByCategory, loadRevenuesByCategory) - SEM filtro de período
    
    // Carregar todos os gráficos em paralelo - SEM filtro de período
    loadDreData();
    
    // Carregar dados por categoria imediatamente (sem esperar filtros)
    loadExpensesByCategory();
    loadRevenuesByCategory();
    
    // Carregar filtros em paralelo (não bloqueia os gráficos)
    loadExpensesFilters();
    loadRevenueFilters();
    
    // Carregar análise de planejamento após um delay
    setTimeout(() => {
        const yearFilter = document.getElementById('planningYearFilter');
        if (yearFilter && yearFilter.value) {
            loadPlanningAnalysis();
        }
    }, 3000);
});

// =====================================================
// FUNÇÕES PARA ANÁLISE DE PLANEJAMENTO
// =====================================================

// Função para carregar análise de planejamento
async function loadPlanningAnalysis() {
    const year = document.getElementById('planningYearFilter').value;
    
    if (!year) {
        showPlanningError('Selecione um ano para análise');
        return;
    }
    
    try {
        showPlanningLoading();
        
        // Usar valores padrão: todos os meses e métrica "revenue"
        const params = new URLSearchParams();
        params.append('year', year);
        params.append('metric', 'revenue');
        
        const response = await fetch(`/api/financial/planning-analysis?${params}`, {
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('Erro ao carregar análise de planejamento');
        }
        
        planningAnalysisData = await response.json();
        console.log('Dados de análise de planejamento:', planningAnalysisData);
        
        renderPlanningAnalysis();
        hidePlanningLoading();
        
    } catch (error) {
        console.error('Erro ao carregar análise de planejamento:', error);
        showPlanningError('Erro ao carregar análise de planejamento');
    }
}

// Função para mostrar loading da análise
function showPlanningLoading() {
    document.getElementById('planning-analysis-loading').style.display = 'block';
    document.getElementById('planning-analysis-error').style.display = 'none';
    document.getElementById('planning-analysis-content').style.display = 'none';
}

// Função para esconder loading da análise
function hidePlanningLoading() {
    document.getElementById('planning-analysis-loading').style.display = 'none';
    document.getElementById('planning-analysis-content').style.display = 'block';
}

// Função para mostrar erro da análise
function showPlanningError(message) {
    document.getElementById('planning-analysis-loading').style.display = 'none';
    document.getElementById('planning-analysis-content').style.display = 'none';
    document.getElementById('planning-analysis-error').style.display = 'block';
    document.getElementById('planning-analysis-error-message').textContent = message;
}

// Função para renderizar análise de planejamento
function renderPlanningAnalysis() {
    if (!planningAnalysisData || !planningAnalysisData.success) {
        showPlanningError('Dados de planejamento não encontrados');
        return;
    }
    
    const data = planningAnalysisData.data;
    
    // Renderizar resumo executivo
    renderPlanningSummary(data.summary);
    
    // Renderizar gráfico de comparação
    renderPlanningChart(data.chart);
    
    // Renderizar tabela detalhada
    renderPlanningTable(data.table);
}

// Função para renderizar resumo executivo
function renderPlanningSummary(summary) {
    const summaryContainer = document.getElementById('planning-summary');
    
    // Verificar se temos dados detalhados (ML + Receivables)
    const hasDetailedData = summary.total_ml !== undefined && summary.total_receivables !== undefined;
    
    let summaryHtml = '';
    
    if (hasDetailedData) {
        // Resumo detalhado com ML e Contas a Receber - 3 por linha
        summaryHtml = `
            <!-- Primeira linha -->
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="card-title text-success">Planejado</h6>
                        <h4 class="text-success">${formatCurrency(summary.total_planned)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="card-title text-info">Mercado Livre</h6>
                        <h4 class="text-info">${formatCurrency(summary.total_ml)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h6 class="card-title text-warning">Contas a Receber</h6>
                        <h4 class="text-warning">${formatCurrency(summary.total_receivables)}</h4>
                    </div>
                </div>
            </div>
            
            <!-- Segunda linha -->
            <div class="col-md-4 mt-2">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="card-title text-primary">Total Real</h6>
                        <h4 class="text-primary">${formatCurrency(summary.total_real)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mt-2">
                <div class="card border-secondary">
                    <div class="card-body text-center">
                        <h6 class="card-title text-secondary">Diferença</h6>
                        <h4 class="text-secondary">${formatCurrency(summary.difference)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mt-2">
                <div class="card border-dark">
                    <div class="card-body text-center">
                        <h6 class="card-title text-dark">% Atingido</h6>
                        <h4 class="text-dark">${summary.percentage_achieved.toFixed(1)}%</h4>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Resumo padrão
        summaryHtml = `
            <div class="col-md-3">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h6 class="card-title text-success">Total Planejado</h6>
                        <h4 class="text-success">${formatCurrency(summary.total_planned)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h6 class="card-title text-info">Total Real</h6>
                        <h4 class="text-info">${formatCurrency(summary.total_real)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h6 class="card-title text-warning">Diferença</h6>
                        <h4 class="text-warning">${formatCurrency(summary.difference)}</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-primary">
                    <div class="card-body text-center">
                        <h6 class="card-title text-primary">% Atingido</h6>
                        <h4 class="text-primary">${summary.percentage_achieved.toFixed(1)}%</h4>
                    </div>
                </div>
            </div>
        `;
    }
    
    summaryContainer.innerHTML = summaryHtml;
}

// Função para renderizar gráfico de comparação
function renderPlanningChart(chartData) {
    const ctx = document.getElementById('planningComparisonChart').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (planningComparisonChart) {
        planningComparisonChart.destroy();
    }
    
    // Verificar se temos dados separados (ML + Receivables)
    const hasDetailedData = chartData.ml && chartData.receivables;
    
    let datasets = [];
    
    if (hasDetailedData) {
        // Gráfico com 3 colunas: Planejado, Mercado Livre, Contas a Receber
        datasets = [
            {
                label: 'Planejado',
                data: chartData.planned,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            },
            {
                label: 'Mercado Livre',
                data: chartData.ml,
                backgroundColor: 'rgba(75, 192, 192, 0.8)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            },
            {
                label: 'Contas a Receber',
                data: chartData.receivables,
                backgroundColor: 'rgba(255, 159, 64, 0.8)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }
        ];
    } else {
        // Gráfico padrão: Planejado vs Real
        datasets = [
            {
                label: 'Planejado',
                data: chartData.planned,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            },
            {
                label: 'Real',
                data: chartData.real,
                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }
        ];
    }
    
    planningComparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Comparação Planejado vs Real',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: '#333'
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

    // Função para renderizar tabela detalhada
    function renderPlanningTable(tableData) {
        const tbody = document.getElementById('planning-comparison-table');
        
        // Verificar se temos dados detalhados (ML + Receivables)
        const hasDetailedData = tableData.length > 0 && tableData[0].ml !== undefined;
        
        // Calcular totais
        let totalPlanned = 0;
        let totalML = 0;
        let totalReceivables = 0;
        let totalReal = 0;
        let totalDifference = 0;
        tableData.forEach(row => {
            totalPlanned += row.planned || 0;
            if (hasDetailedData) {
                totalML += row.ml || 0;
                totalReceivables += row.receivables || 0;
                totalReal += row.total_real || 0;
            } else {
                totalReal += row.real || 0;
            }
            totalDifference += row.difference || 0;
        });
        
        // Calcular percentual total (Total Real / Total Planejado)
        const totalPercentage = totalPlanned > 0 ? (totalReal / totalPlanned) * 100 : 0;
        
        let tableHtml = '';
        tableData.forEach(row => {
            const statusClass = row.percentage_achieved >= 100 ? 'success' : 
                               row.percentage_achieved >= 80 ? 'warning' : 'danger';
            const statusIcon = row.percentage_achieved >= 100 ? 'bi-check-circle' : 
                              row.percentage_achieved >= 80 ? 'bi-exclamation-triangle' : 'bi-x-circle';
            
            if (hasDetailedData) {
                // Tabela com colunas separadas para ML e Contas a Receber
                tableHtml += `
                    <tr>
                        <td>${row.month}</td>
                        <td class="text-end">${formatCurrency(row.planned)}</td>
                        <td class="text-end">${formatCurrency(row.ml || 0)}</td>
                        <td class="text-end">${formatCurrency(row.receivables || 0)}</td>
                        <td class="text-end">${formatCurrency(row.total_real || 0)}</td>
                        <td class="text-end ${row.difference >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(row.difference)}
                        </td>
                        <td class="text-end">${row.percentage_achieved.toFixed(1)}%</td>
                        <td class="text-center">
                            <span class="badge bg-${statusClass}">
                                <i class="bi ${statusIcon}"></i>
                            </span>
                        </td>
                    </tr>
                `;
            } else {
                // Tabela padrão
                tableHtml += `
                    <tr>
                        <td>${row.month}</td>
                        <td class="text-end">${formatCurrency(row.planned)}</td>
                        <td class="text-end">${formatCurrency(row.real)}</td>
                        <td class="text-end ${row.difference >= 0 ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(row.difference)}
                        </td>
                        <td class="text-end">${row.percentage_achieved.toFixed(1)}%</td>
                        <td class="text-center">
                            <span class="badge bg-${statusClass}">
                                <i class="bi ${statusIcon}"></i>
                            </span>
                        </td>
                    </tr>
                `;
            }
        });
        
        // Adicionar linha de totais
        if (hasDetailedData) {
            tableHtml += `
                <tr class="table-dark fw-bold">
                    <td><strong>TOTAL</strong></td>
                    <td class="text-end"><strong>${formatCurrency(totalPlanned)}</strong></td>
                    <td class="text-end"><strong>${formatCurrency(totalML)}</strong></td>
                    <td class="text-end"><strong>${formatCurrency(totalReceivables)}</strong></td>
                    <td class="text-end"><strong>${formatCurrency(totalReal)}</strong></td>
                    <td class="text-end text-white">
                        <strong>${formatCurrency(totalDifference)}</strong>
                    </td>
                    <td class="text-end"><strong>${totalPercentage.toFixed(1)}%</strong></td>
                    <td class="text-center">
                        <span class="badge bg-dark">
                            <i class="bi bi-calculator"></i>
                        </span>
                    </td>
                </tr>
            `;
        } else {
            tableHtml += `
                <tr class="table-dark fw-bold">
                    <td><strong>TOTAL</strong></td>
                    <td class="text-end"><strong>${formatCurrency(totalPlanned)}</strong></td>
                    <td class="text-end"><strong>${formatCurrency(totalReal)}</strong></td>
                    <td class="text-end text-white">
                        <strong>${formatCurrency(totalDifference)}</strong>
                    </td>
                    <td class="text-end"><strong>${totalPercentage.toFixed(1)}%</strong></td>
                    <td class="text-center">
                        <span class="badge bg-dark">
                            <i class="bi bi-calculator"></i>
                        </span>
                    </td>
                </tr>
            `;
        }
        
        tbody.innerHTML = tableHtml;
    }
</script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let dreChart = null;

function createDreChart() {
    if (!dreData || !dreData.data) return;

    const ctx = document.getElementById('dreChart').getContext('2d');
    
    // Destruir gráfico anterior se existir
    if (dreChart) {
        dreChart.destroy();
    }

    const data = dreData.data;
    const months = dreData.months;
    
    // Preparar dados para o gráfico
    const receitasData = months.map(month => data.RECEITAS.total[month] || 0);
    const despesasData = months.map(month => data.DESPESAS.total[month] || 0);
    const saldoData = months.map(month => data.RESULTADO.total[month] || 0);

    dreChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: months,
            datasets: [
                {
                    label: 'Receitas',
                    data: receitasData,
                    borderColor: 'rgb(40, 167, 69)',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'Despesas',
                    data: despesasData,
                    borderColor: 'rgb(220, 53, 69)',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'Saldo',
                    data: saldoData,
                    borderColor: 'rgb(0, 123, 255)',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Evolução Financeira - Receitas, Despesas e Saldo'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Meses'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}
</script>
{% endblock %}
