{% extends "base.html" %}

{% block title %}Detalhes do Produto - {{ product.title }}{% endblock %}

{% block content %}
<div class="container-fluid">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/ml/products">Anúncios ML</a></li>
                <li class="breadcrumb-item active" aria-current="page">Detalhes do Produto</li>
            </ol>
        </nav>

        <!-- Header do Produto -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="h3 mb-2">{{ product.title }}</h1>
                        <p class="text-muted mb-3">{{ product.subtitle }}</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{{ product.permalink }}" target="_blank" class="btn btn-primary">
                            <i class="bi bi-box-arrow-up-right"></i> Ver no Mercado Livre
                        </a>
                        <a href="/ml/products" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Coluna Esquerda - Imagens -->
            <div class="col-lg-4 mb-4">
                <!-- Imagens -->
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-images"></i> Imagens do Produto
                            {% if product.pictures and product.pictures|length > 0 %}
                            <span class="badge bg-light text-dark ms-2">{{ product.pictures|length }}</span>
                            {% endif %}
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if product.pictures and product.pictures|length > 0 %}
                        <div class="row g-2">
                            {% for picture in product.pictures %}
                            <div class="col-6">
                                <div class="position-relative">
                                    <img src="{{ picture.secure_url }}" 
                                         class="img-fluid rounded border" 
                                         alt="Imagem {{ loop.index }}"
                                         style="cursor: pointer;"
                                         onclick="window.open('{{ picture.secure_url }}', '_blank')">
                                    
                                    {% set max_width = picture.max_size.split('x')[0]|int if picture.max_size and 'x' in picture.max_size else 0 %}
                                    {% set max_height = picture.max_size.split('x')[1]|int if picture.max_size and 'x' in picture.max_size else 0 %}
                                    
                                    <div class="mt-1 small text-center">
                                        {% if max_width >= 1200 and max_height >= 1200 %}
                                        <span class="badge bg-success w-100">
                                            <i class="bi bi-check-circle"></i> Ideal
                                        </span>
                                        {% elif max_width >= 800 or max_height >= 800 %}
                                        <span class="badge bg-warning w-100">
                                            <i class="bi bi-exclamation-triangle"></i> OK
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger w-100">
                                            <i class="bi bi-x-circle"></i> Pequena
                                        </span>
                                        {% endif %}
                                        <small class="d-block text-muted mt-1">{{ picture.max_size }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="alert alert-info small mt-3 mb-0">
                            <strong>Tamanhos recomendados pelo ML:</strong><br>
                            <span class="badge bg-success">Ideal</span> 1200x1200px ou maior<br>
                            <span class="badge bg-warning">OK</span> 800px ou maior (ativa zoom)<br>
                            <span class="badge bg-danger">Pequena</span> Menos que 800px
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-image" style="font-size: 3rem;"></i>
                            <p class="mt-2 mb-0">Nenhuma imagem disponível</p>
                        </div>
                        {% endif %}
                        
                        <a href="{{ product.permalink }}" target="_blank" class="btn btn-outline-primary btn-sm w-100 mt-3">
                            <i class="bi bi-box-arrow-up-right"></i> Ver no Mercado Livre
                        </a>
                    </div>
                </div>
                
                <!-- Status de Saúde do Anúncio -->
                {% if product.health %}
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-heart-pulse"></i> Saúde do Anúncio</h6>
                    </div>
                    <div class="card-body">
                        <pre class="mb-0 small">{{ product.health | tojson(indent=2) }}</pre>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Coluna Direita - Informações -->
            <div class="col-lg-8">
                <!-- Informações Básicas -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informações Básicas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Preço:</strong> 
                                {% if product.original_price and product.original_price != product.price %}
                                    <div class="d-flex flex-column">
                                        <span class="h5 text-success fw-bold">R$ {{ product.price }}</span>
                                        <span class="text-decoration-line-through text-muted small">R$ {{ product.original_price }}</span>
                                        <span class="badge bg-danger small">
                                            -{{ (((product.original_price|float - product.price|float) / product.original_price|float) * 100)|round }}%
                                        </span>
                                    </div>
                                {% elif product.base_price and product.base_price != product.price %}
                                    <div class="d-flex flex-column">
                                        <span class="h5 text-success fw-bold">R$ {{ product.price }}</span>
                                        <span class="text-decoration-line-through text-muted small">R$ {{ product.base_price }}</span>
                                        <span class="badge bg-warning text-dark small">
                                            -{{ (((product.base_price|float - product.price|float) / product.base_price|float) * 100)|round }}%
                                        </span>
                                    </div>
                                {% else %}
                                    <span class="h5 text-primary">R$ {{ product.price }}</span>
                                {% endif %}
                                <small class="text-muted">{{ product.currency_id }}</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Estoque:</strong> 
                                <span class="badge bg-success">
                                    {{ product.available_quantity }} unidades
                                </span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Vendidos:</strong> {{ product.sold_quantity }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Condição:</strong> {{ product.condition }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Tipo de Listagem:</strong> 
                                <span class="badge bg-warning">{{ product.listing_type_id }}</span>
                                <small class="text-muted d-block">
                                    <span id="listing-description">{{ product.listing_type_id }}</span>
                                </small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Modo de Compra:</strong> 
                                <span class="badge bg-info">{{ product.buying_mode }}</span>
                                <small class="text-muted d-block">Comprar Agora (sem leilão)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Descrição do Anúncio -->
                {% if product.description %}
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-file-text"></i> Descrição do Anúncio</h6>
                    </div>
                    <div class="card-body">
                        <div class="description-content" style="white-space: pre-wrap; line-height: 1.6;">
                            {{ product.description }}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Informações de Categoria -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="bi bi-tags"></i> Categoria</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>ID da Categoria:</strong> {{ product.category_id }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Nome:</strong> 
                                <span class="text-muted">Placas de Microcontroladores</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Envio -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="bi bi-truck"></i> Informações de Envio</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Tipo de Envio:</strong> 
                                <span class="badge bg-info">{{ product.shipping.shipping_type }}</span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Logistic Type:</strong> {{ product.shipping.logistic_type }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Frete Grátis:</strong> 
                                <span class="badge bg-secondary">
                                    Não
                                </span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Retirada Local:</strong> 
                                <span class="badge bg-secondary">
                                    Não
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Catálogo -->
                {% if product.catalog_product_id %}
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="bi bi-book"></i> Informações de Catálogo</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>É de Catálogo:</strong> 
                                <span class="badge bg-success">Sim</span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>ID do Catálogo:</strong> 
                                <code>{{ product.catalog_product_id }}</code>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Garantia e Termos de Venda -->
                {% if product.sale_terms or product.warranty or product.video_id %}
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-shield-check"></i> Garantia e Termos de Venda</h6>
                    </div>
                    <div class="card-body">
                        {% if product.sale_terms %}
                        <div class="mb-3">
                            <strong>Termos de Venda:</strong>
                            <ul class="mt-2">
                            {% for term in product.sale_terms %}
                                <li><strong>{{ term.name }}:</strong> {{ term.value_name }}</li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        {% if product.warranty %}
                        <div class="mb-3">
                            <strong>Garantia:</strong>
                            <p class="mt-1">{{ product.warranty }}</p>
                        </div>
                        {% endif %}
                        
                        {% if product.video_id %}
                        <div class="mb-3">
                            <strong>Vídeo do Produto:</strong>
                            <div class="ratio ratio-16x9 mt-2">
                                <iframe src="https://www.youtube.com/embed/{{ product.video_id }}" 
                                        title="Vídeo do Produto" allowfullscreen></iframe>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Atributos do Produto -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-list-ul"></i> Atributos e Características Técnicas</h6>
                    </div>
                    <div class="card-body">
                        {% if product.attributes %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <tbody>
                                {% for attr in product.attributes %}
                                    <tr>
                                        <td width="40%"><strong>{{ attr.name }}</strong></td>
                                        <td>
                                            {% if attr.value_name %}
                                                {{ attr.value_name }}
                                            {% elif attr.value_struct %}
                                                {{ attr.value_struct.number }} {{ attr.value_struct.unit }}
                                            {% else %}
                                                {{ attr.value_id }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">Nenhum atributo disponível</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Variações -->
                {% if product.variations and product.variations|length > 0 %}
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="bi bi-collection"></i> Variações ({{ product.variations|length }})</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Atributos</th>
                                        <th>Preço</th>
                                        <th>Estoque</th>
                                        <th>Vendidos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                {% for variation in product.variations %}
                                    <tr>
                                        <td><code>{{ variation.id }}</code></td>
                                        <td>
                                            {% if variation.attribute_combinations %}
                                                {% for combo in variation.attribute_combinations %}
                                                    <span class="badge bg-secondary">
                                                        {{ combo.name }}: {{ combo.value_name }}
                                                    </span>
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if variation.price %}
                                                R$ {{ variation.price }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ variation.available_quantity }}</td>
                                        <td>{{ variation.sold_quantity }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Informações Técnicas -->
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="bi bi-gear"></i> Informações Técnicas</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>ID do Produto:</strong> {{ product.ml_item_id }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>ID do Vendedor:</strong> {{ product.seller_id }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>SKU:</strong> {{ product.seller_sku }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Última Sincronização:</strong> {{ product.last_sync }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Criado em:</strong> {{ product.created_at }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Atualizado em:</strong> {{ product.updated_at }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>User Product ID:</strong> {{ product.user_product_id }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Family ID:</strong> {{ product.family_id }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Função para definir descrição dinâmica do tipo de listagem
    function setListingDescription() {
        const listingType = '{{ product.listing_type_id }}';
        const descriptionElement = document.getElementById('listing-description');
        
        const descriptions = {
            'gold_special': 'Anúncio Premium (Gold Special)',
            'gold_pro': 'Anúncio Gold Pro',
            'gold': 'Anúncio Gold',
            'silver': 'Anúncio Silver',
            'bronze': 'Anúncio Bronze',
            'free': 'Anúncio Gratuito',
            'classified': 'Classificado',
            'auction': 'Leilão'
        };
        
        const description = descriptions[listingType] || listingType;
        descriptionElement.textContent = description;
    }
    
    // Executar quando a página carregar
    document.addEventListener('DOMContentLoaded', setListingDescription);
    </script>
{% endblock %}
