{% extends "base.html" %}
{% block title %}Publicidade - Mercado Livre{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-2">üì¢ Publicidade - Product Ads</h1>
            <p class="text-muted mb-0">Gerencie suas campanhas de publicidade no Mercado Livre</p>
        </div>
        <div class="col-md-4 text-end d-flex align-items-center justify-content-end">
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="acoesDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-gear-fill"></i> A√ß√µes
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="acoesDropdown">
                    <li>
                        <a class="dropdown-item" href="#" onclick="openCreateCampaignModal(); return false;">
                            <i class="bi bi-plus-circle text-success"></i> Nova Campanha
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="syncCampaigns(); return false;">
                            <i class="bi bi-cloud-download text-primary"></i> Sincronizar do ML
                        </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item" href="#" onclick="loadData(); return false;">
                            <i class="bi bi-arrow-clockwise text-secondary"></i> Atualizar
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Filtro de Per√≠odo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Per√≠odo de An√°lise -->
                        <div class="col-md-6">
                            <label for="period-filter" class="form-label">Per√≠odo de An√°lise</label>
                            <select class="form-select" id="period-filter" onchange="handlePeriodChange()">
                                <option value="current-month" selected>M√™s Atual</option>
                                <option value="30">√öltimos 30 dias</option>
                                <option value="60">√öltimos 60 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                                <option value="custom">Per√≠odo personalizado</option>
                            </select>
                        </div>
                        
                        <!-- Status das Campanhas -->
                        <div class="col-md-3">
                            <label for="campaign-status-filter" class="form-label">Status das Campanhas</label>
                            <select class="form-select" id="campaign-status-filter" onchange="filterCampaigns()">
                                <option value="active" selected>Somente Ativas</option>
                                <option value="paused">Somente Pausadas</option>
                                <option value="all">Todas</option>
                            </select>
                        </div>
                        
                        <!-- Bot√£o Limpar -->
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Campos de data personalizada (oculto por padr√£o) -->
                    <div class="row g-3 mt-2" id="custom-date-fields" style="display: none;">
                        <div class="col-md-4">
                            <label for="custom-date-from" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="custom-date-from">
                        </div>
                        <div class="col-md-4">
                            <label for="custom-date-to" class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="custom-date-to">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="applyCustomPeriod()">
                                <i class="bi bi-check-circle"></i> Aplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted" id="campaigns-label">Campanhas Ativas</h6>
                    <h3 id="active-campaigns"><div class="spinner-border spinner-border-sm"></div></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Investimento Total</h6>
                    <h3 id="total-investment"><div class="spinner-border spinner-border-sm"></div></h3>

                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">ROAS M√©dio</h6>
                    <h3 id="avg-roas"><div class="spinner-border spinner-border-sm"></div></h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Receita Gerada</h6>
                    <h3 id="total-revenue"><div class="spinner-border spinner-border-sm"></div></h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card">
                <div class="card-body">
                    <canvas id="investmentChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <canvas id="roasChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Campanhas -->
    <div class="row">
        <div class="col-12">
            <div class="card">

                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nome</th>
                                    <th>Status</th>
                                    <th>Or√ßamento Di√°rio</th>
                                    <th>Gasto</th>
                                    <th>Cliques</th>
                                    <th>ROAS</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="campaigns-table-body">
                                <tr>
                                    <td colspan="7" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Campanha -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Campanha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCampaignForm">
                    <div class="mb-3">
                        <label class="form-label">Nome da Campanha</label>
                        <input type="text" class="form-control" id="campaign-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or√ßamento Di√°rio (R$)</label>
                        <input type="number" class="form-control" id="campaign-budget" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Lance</label>
                        <select class="form-select" id="campaign-bid-type">
                            <option value="auto">Autom√°tico</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status Inicial</label>
                        <select class="form-select" id="campaign-status">
                            <option value="paused">Pausada</option>
                            <option value="active">Ativa</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createCampaign()">Criar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================
let investmentChart = null;
let roasChart = null;
let currentPeriod = { type: 30 }; // Padr√£o: √∫ltimos 30 dias
let allCampaigns = []; // Armazena todas as campanhas para filtro

document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    initDateFields();
    loadData();
    // Atualizar dados a cada 5 minutos
    setInterval(loadData, 300000);
});

// ============================================================================
// FILTRO DE PER√çODO
// ============================================================================
function handlePeriodChange() {
    const periodFilter = document.getElementById('period-filter');
    const period = periodFilter.value;
    const customFields = document.getElementById('custom-date-fields');
    
    if (period === 'custom') {
        // Mostrar campos de data personalizada
        customFields.style.display = 'block';
        currentPeriod = { type: 'custom' };
    } else {
        // Esconder campos de data personalizada
        customFields.style.display = 'none';
        
        // Definir per√≠odo
        if (period === 'current-month') {
            currentPeriod = { type: 'current-month' };
        } else {
            currentPeriod = { type: parseInt(period) };
        }
        
        // Recarregar dados
        loadData();
    }
}

function initDateFields() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('custom-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('custom-date-to').value = today.toISOString().split('T')[0];
    
    // Definir data m√°xima como hoje
    document.getElementById('custom-date-to').max = today.toISOString().split('T')[0];
}

function applyCustomPeriod() {
    const dateFrom = document.getElementById('custom-date-from').value;
    const dateTo = document.getElementById('custom-date-to').value;
    
    if (!dateFrom || !dateTo) {
        showToast('Por favor, selecione ambas as datas', 'warning');
        return;
    }
    
    if (dateFrom > dateTo) {
        showToast('Data inicial n√£o pode ser maior que a data final', 'warning');
        return;
    }
    
    currentPeriod = { type: 'custom', dateFrom, dateTo };
    
    // Recarregar dados
    loadData();
}

function getPeriodParams() {
    const today = new Date();
    let dateFrom, dateTo;
    
    if (currentPeriod.type === 'custom') {
        dateFrom = currentPeriod.dateFrom;
        dateTo = currentPeriod.dateTo;
    } else if (currentPeriod.type === 'current-month') {
        // Primeiro dia do m√™s atual
        dateFrom = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        dateTo = today.toISOString().split('T')[0];
    } else {
        // √öltimos N dias
        const daysAgo = new Date();
        daysAgo.setDate(today.getDate() - currentPeriod.type);
        dateFrom = daysAgo.toISOString().split('T')[0];
        dateTo = today.toISOString().split('T')[0];
    }
    
    return { dateFrom, dateTo };
}

// ============================================================================
// UTILIT√ÅRIOS
// ============================================================================
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value || 0);
}

function showToast(message, type = 'info') {
    // Toast simples - pode ser melhorado com biblioteca
    alert(message);
}

// ============================================================================
// CARREGAMENTO DE DADOS
// ============================================================================
async function loadData() {
    // Carregar campanhas primeiro
    await loadCampaigns();
    // Os KPIs e gr√°ficos ser√£o atualizados pelo filterCampaigns() que √© chamado dentro de loadCampaigns()
}

async function loadMetrics() {
    try {
        const token = getCookie('session_token');
        const { dateFrom, dateTo } = getPeriodParams();
        
        const response = await fetch(`/ml/advertising/metrics?date_from=${dateFrom}&date_to=${dateTo}`, {
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        if (data.success && data.metrics) {
            updateKPIs(data.metrics);
        }
    } catch (error) {
        console.error('Erro ao carregar m√©tricas:', error);
    }
}

function updateKPIs(metrics) {
    // Atualizar label e contagem de campanhas
    if (metrics.campaigns_label) {
        document.getElementById('campaigns-label').textContent = metrics.campaigns_label;
    }
    document.getElementById('active-campaigns').textContent = metrics.campaigns_count || metrics.active_campaigns || 0;
    
    document.getElementById('total-investment').textContent = formatCurrency(metrics.total_investment);
    document.getElementById('avg-roas').textContent = (metrics.avg_roas || 0).toFixed(2) + 'x';
    document.getElementById('total-revenue').textContent = formatCurrency(metrics.total_revenue);
}

async function loadCampaigns() {
    const tbody = document.getElementById('campaigns-table-body');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> Carregando...</td></tr>';
    
    try {
        const token = getCookie('session_token');
        const response = await fetch('/ml/advertising/campaigns', {
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        if (data.success) {
            allCampaigns = data.campaigns || []; // Salvar todas as campanhas
            filterCampaigns(); // Aplicar filtro
        } else {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Erro: ${data.error}</td></tr>`;
        }
    } catch (error) {
        console.error('Erro ao carregar campanhas:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar campanhas</td></tr>';
    }
}

function filterCampaigns() {
    const filterValue = document.getElementById('campaign-status-filter').value;
    let filteredCampaigns = [];
    
    if (filterValue === 'all') {
        filteredCampaigns = allCampaigns;
    } else if (filterValue === 'active') {
        filteredCampaigns = allCampaigns.filter(c => c.status === 'active');
    } else if (filterValue === 'paused') {
        filteredCampaigns = allCampaigns.filter(c => c.status === 'paused' || c.status === 'inactive');
    }
    
    // Atualizar tabela
    displayCampaigns(filteredCampaigns);
    
    // Atualizar KPIs e gr√°ficos com m√©tricas do per√≠odo
    updateKPIsAndChartsForPeriod(filteredCampaigns);
}

async function updateKPIsAndChartsForPeriod(filteredCampaigns) {
    try {
        const token = getCookie('session_token');
        const { dateFrom, dateTo } = getPeriodParams();
        const statusFilter = document.getElementById('campaign-status-filter').value;
        
        // Buscar m√©tricas agregadas do per√≠odo com filtro de status
        const response = await fetch(`/ml/advertising/metrics?date_from=${dateFrom}&date_to=${dateTo}&status=${statusFilter}`, {
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        if (data.success && data.metrics) {
            const metrics = data.metrics;
            
            // Atualizar KPIs (incluindo label din√¢mico)
            if (metrics.campaigns_label) {
                document.getElementById('campaigns-label').textContent = metrics.campaigns_label;
            }
            document.getElementById('active-campaigns').textContent = metrics.campaigns_count || metrics.active_campaigns || 0;
            document.getElementById('total-investment').textContent = formatCurrency(metrics.total_investment);
            document.getElementById('avg-roas').textContent = (metrics.avg_roas || 0).toFixed(2) + 'x';
            document.getElementById('total-revenue').textContent = formatCurrency(metrics.total_revenue);
            
            // Atualizar gr√°ficos
            updateChartsFromMetrics(metrics, filteredCampaigns);
        }
    } catch (error) {
        console.error('Erro ao atualizar KPIs e gr√°ficos:', error);
        // Fallback: usar dados das campanhas carregadas
        updateKPIsFromCampaigns(filteredCampaigns);
        updateChartsFromCampaigns(filteredCampaigns);
    }
}

function updateChartsFromMetrics(metrics, filteredCampaigns) {
    // Atualizar gr√°fico de Investimento vs Retorno
    if (investmentChart) {
        investmentChart.data.labels = ['Per√≠odo'];
        investmentChart.data.datasets[0].data = [metrics.total_investment || 0];
        investmentChart.data.datasets[1].data = [metrics.total_revenue || 0];
        investmentChart.update();
    }
    
    // Atualizar gr√°fico de ROAS por campanha (usa dados das campanhas filtradas)
    if (roasChart && filteredCampaigns.length > 0) {
        const topCampaigns = filteredCampaigns
            .filter(c => c.roas && c.roas > 0)
            .sort((a, b) => b.roas - a.roas)
            .slice(0, 5); // Top 5
        
        if (topCampaigns.length > 0) {
            roasChart.data.labels = topCampaigns.map(c => c.name || 'N/A');
            roasChart.data.datasets[0].data = topCampaigns.map(c => c.roas || 0);
            roasChart.update();
        } else {
            roasChart.data.labels = ['Sem dados'];
            roasChart.data.datasets[0].data = [0];
            roasChart.update();
        }
    }
}

function clearFilters() {
    // Resetar per√≠odo para M√™s Atual
    document.getElementById('period-filter').value = 'current-month';
    currentPeriod = { type: 'current-month' };
    
    // Resetar status para Somente Ativas
    document.getElementById('campaign-status-filter').value = 'active';
    
    // Esconder campos de data personalizada
    document.getElementById('custom-date-fields').style.display = 'none';
    
    // Limpar campos de data
    document.getElementById('custom-date-from').value = '';
    document.getElementById('custom-date-to').value = '';
    
    // Recarregar dados
    loadData();
}

function updateKPIsFromCampaigns(campaigns) {
    // Obter filtro atual
    const statusFilter = document.getElementById('campaign-status-filter').value;
    
    // Contar campanhas conforme filtro
    let campaignsCount = campaigns.length;
    let campaignsLabel = 'Total de Campanhas';
    
    if (statusFilter === 'active') {
        campaignsCount = campaigns.filter(c => c.status === 'active').length;
        campaignsLabel = 'Campanhas Ativas';
    } else if (statusFilter === 'paused') {
        campaignsCount = campaigns.filter(c => c.status === 'paused' || c.status === 'inactive').length;
        campaignsLabel = 'Campanhas Pausadas';
    }
    
    // Somar m√©tricas
    let totalSpent = 0;
    let totalRevenue = 0;
    
    campaigns.forEach(c => {
        totalSpent += c.total_spent || 0;
        totalRevenue += c.total_revenue || 0;
    });
    
    // Calcular ROAS m√©dio
    const avgRoas = totalSpent > 0 ? totalRevenue / totalSpent : 0;
    
    // Atualizar interface
    document.getElementById('campaigns-label').textContent = campaignsLabel;
    document.getElementById('active-campaigns').textContent = campaignsCount;
    document.getElementById('total-investment').textContent = formatCurrency(totalSpent);
    document.getElementById('avg-roas').textContent = avgRoas.toFixed(2) + 'x';
    document.getElementById('total-revenue').textContent = formatCurrency(totalRevenue);
}

function updateChartsFromCampaigns(campaigns) {
    // Atualizar gr√°fico de Investimento vs Retorno
    if (investmentChart && campaigns.length > 0) {
        let totalInvestment = 0;
        let totalRevenue = 0;
        
        campaigns.forEach(c => {
            totalInvestment += c.total_spent || 0;
            totalRevenue += c.total_revenue || 0;
        });
        
        investmentChart.data.labels = ['Per√≠odo'];
        investmentChart.data.datasets[0].data = [totalInvestment];
        investmentChart.data.datasets[1].data = [totalRevenue];
        investmentChart.update();
    }
    
    // Atualizar gr√°fico de ROAS por campanha
    if (roasChart && campaigns.length > 0) {
        const topCampaigns = campaigns
            .filter(c => c.roas && c.roas > 0)
            .sort((a, b) => b.roas - a.roas)
            .slice(0, 5); // Top 5
        
        if (topCampaigns.length > 0) {
            roasChart.data.labels = topCampaigns.map(c => c.name || 'N/A');
            roasChart.data.datasets[0].data = topCampaigns.map(c => c.roas || 0);
            roasChart.update();
        } else {
            roasChart.data.labels = ['Sem dados'];
            roasChart.data.datasets[0].data = [0];
            roasChart.update();
        }
    }
}

function displayCampaigns(campaigns) {
    const tbody = document.getElementById('campaigns-table-body');
    
    if (!campaigns || campaigns.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">Nenhuma campanha encontrada</p>
                    <button class="btn btn-sm btn-success" onclick="syncCampaigns()">
                        <i class="bi bi-cloud-download"></i> Sincronizar do ML
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = campaigns.map(c => {
        const statusColor = c.status === 'active' ? 'success' : 
                           c.status === 'paused' ? 'warning' : 'secondary';
        const statusText = c.status === 'active' ? 'Ativa' : 
                          c.status === 'paused' ? 'Pausada' : c.status;
        
        return `
            <tr>
                <td>
                    <strong>${c.name || 'N/A'}</strong>
                    <br><small class="text-muted">${c.id || ''}</small>
                </td>
                <td><span class="badge bg-${statusColor}">${statusText}</span></td>
                <td>${formatCurrency(c.daily_budget)}</td>
                <td>${formatCurrency(c.total_spent)}</td>
                <td>${(c.total_clicks || 0).toLocaleString('pt-BR')}</td>
                <td>
                    <strong>${(c.roas || 0).toFixed(2)}x</strong>
                    ${c.total_impressions ? `<br><small class="text-muted">${c.total_impressions.toLocaleString('pt-BR')} impress√µes</small>` : ''}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewCampaignDetails('${c.id}')" title="Ver detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteCampaign('${c.id}')" title="Deletar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// ============================================================================
// SINCRONIZA√á√ÉO
// ============================================================================
async function syncCampaigns() {
    // Criar overlay de loading
    const overlay = document.createElement('div');
    overlay.id = 'sync-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    `;
    
    overlay.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px;">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Sincronizando...</span>
            </div>
            <h5 class="mb-2">üîÑ Sincronizando Campanhas</h5>
            <p class="text-muted mb-0">Aguarde enquanto buscamos os dados do Mercado Livre...</p>
            <p class="text-muted mt-2"><small id="sync-timer">0s</small></p>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Contador de tempo
    let seconds = 0;
    const timerInterval = setInterval(() => {
        seconds++;
        const timerEl = document.getElementById('sync-timer');
        if (timerEl) {
            timerEl.textContent = `${seconds}s`;
        }
    }, 1000);
    
    try {
        const token = getCookie('session_token');
        const response = await fetch('/ml/advertising/campaigns/sync', {
            method: 'POST',
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        // Remover overlay de loading
        clearInterval(timerInterval);
        
        if (data.success) {
            // Atualizar overlay para mostrar resultado de sucesso
            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; max-width: 500px;">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="mb-3">‚úÖ Sincroniza√ß√£o Conclu√≠da!</h4>
                    <div class="text-start mb-4">
                        <p class="mb-2"><strong>‚è±Ô∏è Tempo:</strong> ${seconds}s</p>
                        <p class="mb-2"><strong>üìä Campanhas:</strong> ${data.campaigns_synced || 0} sincronizada(s)</p>
                        <p class="mb-2"><strong>üì¶ Produtos:</strong> ${data.products_synced || 0} sincronizado(s)</p>
                        <p class="mb-2"><strong>üìà M√©tricas:</strong> ${data.metrics_synced || 0} sincronizada(s)</p>
                    </div>
                    <button class="btn btn-primary" onclick="closeSyncModal()">
                        <i class="bi bi-check-lg"></i> Fechar
                    </button>
                </div>
            `;
            
            // Adicionar fun√ß√£o global para fechar o modal
            window.closeSyncModal = async function() {
                document.body.removeChild(overlay);
                delete window.closeSyncModal;
                await loadData();
            };
        } else {
            // Atualizar overlay para mostrar erro
            overlay.innerHTML = `
                <div style="background: white; padding: 40px; border-radius: 10px; text-align: center; max-width: 500px;">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="mb-3">‚ùå Erro na Sincroniza√ß√£o</h4>
                    <p class="text-muted mb-4">${data.error}</p>
                    <button class="btn btn-secondary" onclick="closeSyncModal()">
                        Fechar
                    </button>
                </div>
            `;
            
            window.closeSyncModal = function() {
                document.body.removeChild(overlay);
                delete window.closeSyncModal;
            };
        }
    } catch (error) {
        // Remover overlay em caso de erro
        clearInterval(timerInterval);
        const overlayEl = document.getElementById('sync-overlay');
        if (overlayEl) {
            document.body.removeChild(overlayEl);
        }
        console.error('Erro na sincroniza√ß√£o:', error);
        showToast('‚ùå Erro ao sincronizar campanhas', 'error');
    }
}

// ============================================================================
// MODAL CRIAR CAMPANHA
// ============================================================================
function openCreateCampaignModal() {
    const modal = new bootstrap.Modal(document.getElementById('createCampaignModal'));
    document.getElementById('createCampaignForm').reset();
    modal.show();
}

async function createCampaign() {
    const token = getCookie('session_token');
    const data = {
        name: document.getElementById('campaign-name').value,
        budget: parseFloat(document.getElementById('campaign-budget').value),
        bid_type: document.getElementById('campaign-bid-type').value,
        status: document.getElementById('campaign-status').value
    };
    
    if (!data.name || !data.budget) {
        showToast('‚ùå Preencha todos os campos obrigat√≥rios', 'error');
        return;
    }
    
    try {
        const response = await fetch('/ml/advertising/campaigns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Cookie': `session_token=${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Campanha criada com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
            await loadData();
        } else {
            showToast(`‚ùå Erro: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erro ao criar campanha:', error);
        showToast('‚ùå Erro ao criar campanha', 'error');
    }
}

// ============================================================================
// GR√ÅFICOS COM CHART.JS
// ============================================================================
function initCharts() {
    // Gr√°fico de Investimento vs Retorno
    const investmentCtx = document.getElementById('investmentChart');
    if (investmentCtx) {
        investmentChart = new Chart(investmentCtx, {
            type: 'bar',
            data: {
                labels: ['Per√≠odo'],
                datasets: [
                    {
                        label: 'Investimento',
                        data: [0],
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Retorno (Receita)',
                        data: [0],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        stacked: false,
                    },
                    y: {
                        stacked: false,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'üìà Investimento vs Retorno',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gr√°fico de ROAS por Campanha
    const roasCtx = document.getElementById('roasChart');
    if (roasCtx) {
        roasChart = new Chart(roasCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'ROAS',
                    data: [],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2) + 'x';
                            }
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'üìä ROAS por Campanha',
                        font: {
                            size: 16,
                            weight: 'bold'
                        },
                        padding: {
                            top: 10,
                            bottom: 20
                        }
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'ROAS: ' + context.parsed.x.toFixed(2) + 'x';
                            }
                        }
                    }
                }
            }
        });
    }
}

async function updateCharts() {
    try {
        const token = getCookie('session_token');
        const { dateFrom, dateTo } = getPeriodParams();
        
        // Buscar dados de m√©tricas com filtro de per√≠odo
        const [metricsRes, campaignsRes] = await Promise.all([
            fetch(`/ml/advertising/metrics?date_from=${dateFrom}&date_to=${dateTo}`, {
                headers: { 'Cookie': `session_token=${token}` }
            }),
            fetch('/ml/advertising/campaigns', {
                headers: { 'Cookie': `session_token=${token}` }
            })
        ]);
        
        const metricsData = await metricsRes.json();
        const campaignsData = await campaignsRes.json();
        
        // Atualizar gr√°fico de Investimento vs Retorno com dados agregados do per√≠odo
        if (metricsData.success && metricsData.metrics && investmentChart) {
            const metrics = metricsData.metrics;
            
            investmentChart.data.labels = ['Per√≠odo'];
            investmentChart.data.datasets[0].data = [metrics.total_investment || 0];
            investmentChart.data.datasets[1].data = [metrics.total_revenue || 0];
            investmentChart.update();
            
            console.log('üìä Gr√°fico atualizado:', {
                investimento: metrics.total_investment,
                receita: metrics.total_revenue
            });
        }
        
        // Atualizar gr√°fico de ROAS por campanha (usa dados completos das campanhas)
        if (campaignsData.success && campaignsData.campaigns && roasChart) {
            const campaigns = campaignsData.campaigns
                .filter(c => c.roas && c.roas > 0)
                .sort((a, b) => b.roas - a.roas)
                .slice(0, 5); // Top 5 campanhas
            
            if (campaigns.length > 0) {
                roasChart.data.labels = campaigns.map(c => c.name || 'N/A');
                roasChart.data.datasets[0].data = campaigns.map(c => c.roas || 0);
                roasChart.update();
            } else {
                // Se n√£o houver campanhas com ROAS, mostrar mensagem
                roasChart.data.labels = ['Sem dados'];
                roasChart.data.datasets[0].data = [0];
                roasChart.update();
            }
        }
    } catch (error) {
        console.error('Erro ao atualizar gr√°ficos:', error);
    }
}

// ============================================================================
// A√á√ïES DE CAMPANHA
// ============================================================================
function viewCampaignDetails(campaignId) {
    window.location.href = `/ml/advertising/campaigns/${campaignId}/details`;
}

async function deleteCampaign(campaignId) {
    if (!confirm('‚ö†Ô∏è Deseja realmente deletar esta campanha?')) return;
    
    const token = getCookie('session_token');
    try {
        const response = await fetch(`/ml/advertising/campaigns/${campaignId}`, {
            method: 'DELETE',
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Campanha deletada com sucesso!', 'success');
            await loadData();
        } else {
            showToast(`‚ùå Erro: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erro ao deletar:', error);
        showToast('‚ùå Erro ao deletar campanha', 'error');
    }
}
</script>
{% endblock %}


