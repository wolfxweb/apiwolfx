{% extends "base.html" %}
{% block title %}Publicidade - Mercado Livre{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-3">üì¢ Publicidade - Product Ads</h1>
            <p class="text-muted">Gerencie suas campanhas de publicidade no Mercado Livre</p>
        </div>
    </div>

    <!-- Filtro de Per√≠odo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="mb-3">üìÖ Per√≠odo de An√°lise</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriod('current-month')" id="btn-current-month">
                                    M√™s Atual
                                </button>
                                <button type="button" class="btn btn-outline-primary active" onclick="setPeriod(30)" id="btn-30">
                                    30 dias
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriod(60)" id="btn-60">
                                    60 dias
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="setPeriod(90)" id="btn-90">
                                    90 dias
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="toggleCustomPeriod()" id="btn-custom">
                                    Personalizado
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i>
                                <span id="period-display">√öltimos 30 dias</span>
                            </small>
                        </div>
                    </div>
                    
                    <!-- Campos de data personalizada (oculto por padr√£o) -->
                    <div class="row mt-3" id="custom-date-fields" style="display: none;">
                        <div class="col-md-4">
                            <label class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="custom-date-from">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="custom-date-to">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button class="btn btn-primary w-100" onclick="applyCustomPeriod()">
                                <i class="bi bi-check-circle"></i> Aplicar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Campanhas Ativas</h6>
                    <h3 id="active-campaigns">0</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Investimento Total</h6>
                    <h3 id="total-investment">R$ 0,00</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">ROAS M√©dio</h6>
                    <h3 id="avg-roas">0.0x</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="text-muted">Receita Gerada</h6>
                    <h3 id="total-revenue">R$ 0,00</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üìà Investimento vs Retorno (<span id="chart-period-text">√öltimos 30 dias</span>)</h6>
                </div>
                <div class="card-body">
                    <canvas id="investmentChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">üìä ROAS por Campanha</h6>
                </div>
                <div class="card-body">
                    <canvas id="roasChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- A√ß√µes -->
    <div class="row mb-4">
        <div class="col-12">
            <button class="btn btn-primary" onclick="openCreateCampaignModal()">
                <i class="bi bi-plus-circle"></i> Nova Campanha
            </button>
            <button class="btn btn-success" onclick="syncCampaigns()" id="sync-btn">
                <i class="bi bi-cloud-download"></i> Sincronizar do ML
            </button>
            <button class="btn btn-outline-secondary" onclick="loadData()">
                <i class="bi bi-arrow-clockwise"></i> Atualizar
            </button>
        </div>
    </div>

    <!-- Lista de Campanhas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Campanhas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Status</th>
                                    <th>Or√ßamento Di√°rio</th>
                                    <th>Gasto</th>
                                    <th>Cliques</th>
                                    <th>ROAS</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="campaigns-table-body">
                                <tr>
                                    <td colspan="7" class="text-center">Carregando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nova Campanha -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Campanha</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCampaignForm">
                    <div class="mb-3">
                        <label class="form-label">Nome da Campanha</label>
                        <input type="text" class="form-control" id="campaign-name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Or√ßamento Di√°rio (R$)</label>
                        <input type="number" class="form-control" id="campaign-budget" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo de Lance</label>
                        <select class="form-select" id="campaign-bid-type">
                            <option value="auto">Autom√°tico</option>
                            <option value="manual">Manual</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status Inicial</label>
                        <select class="form-select" id="campaign-status">
                            <option value="paused">Pausada</option>
                            <option value="active">Ativa</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="createCampaign()">Criar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// INICIALIZA√á√ÉO
// ============================================================================
let investmentChart = null;
let roasChart = null;
let currentPeriod = { type: 30 }; // Padr√£o: √∫ltimos 30 dias

document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    initDateFields();
    loadData();
    // Atualizar dados a cada 5 minutos
    setInterval(loadData, 300000);
});

// ============================================================================
// FILTRO DE PER√çODO
// ============================================================================
function setPeriod(period) {
    // Remover classe 'active' de todos os bot√µes
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Esconder campos de data customizada
    document.getElementById('custom-date-fields').style.display = 'none';
    
    // Ativar bot√£o clicado
    let buttonId;
    let displayText;
    
    if (period === 'current-month') {
        buttonId = 'btn-current-month';
        displayText = 'M√™s Atual';
        currentPeriod = { type: 'current-month' };
    } else {
        buttonId = `btn-${period}`;
        displayText = `√öltimos ${period} dias`;
        currentPeriod = { type: period };
    }
    
    document.getElementById(buttonId).classList.add('active');
    document.getElementById('period-display').textContent = displayText;
    document.getElementById('chart-period-text').textContent = displayText;
    
    // Recarregar dados
    loadData();
}

function toggleCustomPeriod() {
    // Remover classe 'active' de todos os bot√µes
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Ativar bot√£o de personalizado
    document.getElementById('btn-custom').classList.add('active');
    
    // Mostrar campos de data
    const customFields = document.getElementById('custom-date-fields');
    customFields.style.display = customFields.style.display === 'none' ? 'flex' : 'none';
}

function initDateFields() {
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('custom-date-from').value = thirtyDaysAgo.toISOString().split('T')[0];
    document.getElementById('custom-date-to').value = today.toISOString().split('T')[0];
    
    // Definir data m√°xima como hoje
    document.getElementById('custom-date-to').max = today.toISOString().split('T')[0];
}

function applyCustomPeriod() {
    const dateFrom = document.getElementById('custom-date-from').value;
    const dateTo = document.getElementById('custom-date-to').value;
    
    if (!dateFrom || !dateTo) {
        showToast('Por favor, selecione ambas as datas', 'warning');
        return;
    }
    
    if (dateFrom > dateTo) {
        showToast('Data inicial n√£o pode ser maior que a data final', 'warning');
        return;
    }
    
    currentPeriod = { type: 'custom', dateFrom, dateTo };
    
    // Atualizar texto de exibi√ß√£o
    const from = new Date(dateFrom).toLocaleDateString('pt-BR');
    const to = new Date(dateTo).toLocaleDateString('pt-BR');
    const displayText = `${from} - ${to}`;
    document.getElementById('period-display').textContent = displayText;
    document.getElementById('chart-period-text').textContent = displayText;
    
    // Recarregar dados
    loadData();
}

function getPeriodParams() {
    const today = new Date();
    let dateFrom, dateTo;
    
    if (currentPeriod.type === 'custom') {
        dateFrom = currentPeriod.dateFrom;
        dateTo = currentPeriod.dateTo;
    } else if (currentPeriod.type === 'current-month') {
        // Primeiro dia do m√™s atual
        dateFrom = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        dateTo = today.toISOString().split('T')[0];
    } else {
        // √öltimos N dias
        const daysAgo = new Date();
        daysAgo.setDate(today.getDate() - currentPeriod.type);
        dateFrom = daysAgo.toISOString().split('T')[0];
        dateTo = today.toISOString().split('T')[0];
    }
    
    return { dateFrom, dateTo };
}

// ============================================================================
// UTILIT√ÅRIOS
// ============================================================================
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

function formatCurrency(value) {
    return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    }).format(value || 0);
}

function showToast(message, type = 'info') {
    // Toast simples - pode ser melhorado com biblioteca
    alert(message);
}

// ============================================================================
// CARREGAMENTO DE DADOS
// ============================================================================
async function loadData() {
    await Promise.all([
        loadMetrics(),
        loadCampaigns()
    ]);
    updateCharts();
}

async function loadMetrics() {
    try {
        const token = getCookie('session_token');
        const { dateFrom, dateTo } = getPeriodParams();
        
        const response = await fetch(`/ml/advertising/metrics?date_from=${dateFrom}&date_to=${dateTo}`, {
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        if (data.success && data.metrics) {
            updateKPIs(data.metrics);
        }
    } catch (error) {
        console.error('Erro ao carregar m√©tricas:', error);
    }
}

function updateKPIs(metrics) {
    document.getElementById('active-campaigns').textContent = metrics.active_campaigns || 0;
    document.getElementById('total-investment').textContent = formatCurrency(metrics.total_investment);
    document.getElementById('avg-roas').textContent = (metrics.avg_roas || 0).toFixed(2) + 'x';
    document.getElementById('total-revenue').textContent = formatCurrency(metrics.total_revenue);
}

async function loadCampaigns() {
    const tbody = document.getElementById('campaigns-table-body');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div> Carregando...</td></tr>';
    
    try {
        const token = getCookie('session_token');
        const response = await fetch('/ml/advertising/campaigns', {
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        if (data.success) {
            displayCampaigns(data.campaigns || []);
        } else {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Erro: ${data.error}</td></tr>`;
        }
    } catch (error) {
        console.error('Erro ao carregar campanhas:', error);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Erro ao carregar campanhas</td></tr>';
    }
}

function displayCampaigns(campaigns) {
    const tbody = document.getElementById('campaigns-table-body');
    
    if (!campaigns || campaigns.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">Nenhuma campanha encontrada</p>
                    <button class="btn btn-sm btn-success" onclick="syncCampaigns()">
                        <i class="bi bi-cloud-download"></i> Sincronizar do ML
                    </button>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = campaigns.map(c => {
        const statusColor = c.status === 'active' ? 'success' : 
                           c.status === 'paused' ? 'warning' : 'secondary';
        const statusText = c.status === 'active' ? 'Ativa' : 
                          c.status === 'paused' ? 'Pausada' : c.status;
        
        return `
            <tr>
                <td>
                    <strong>${c.name || 'N/A'}</strong>
                    <br><small class="text-muted">${c.id || ''}</small>
                </td>
                <td><span class="badge bg-${statusColor}">${statusText}</span></td>
                <td>${formatCurrency(c.daily_budget)}</td>
                <td>${formatCurrency(c.total_spent)}</td>
                <td>${(c.total_clicks || 0).toLocaleString('pt-BR')}</td>
                <td>
                    <strong>${(c.roas || 0).toFixed(2)}x</strong>
                    ${c.total_impressions ? `<br><small class="text-muted">${c.total_impressions.toLocaleString('pt-BR')} impress√µes</small>` : ''}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewCampaignDetails('${c.id}')" title="Ver detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteCampaign('${c.id}')" title="Deletar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// ============================================================================
// SINCRONIZA√á√ÉO
// ============================================================================
async function syncCampaigns() {
    const btn = document.getElementById('sync-btn');
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sincronizando...';
    
    try {
        const token = getCookie('session_token');
        const response = await fetch('/ml/advertising/campaigns/sync', {
            method: 'POST',
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        const data = await response.json();
        
        if (data.success) {
            const campaignsMsg = `${data.campaigns_synced || 0} campanha(s)`;
            const productsMsg = data.products_synced ? `, ${data.products_synced} produto(s)` : '';
            showToast(`‚úÖ Sincroniza√ß√£o conclu√≠da! ${campaignsMsg}${productsMsg} sincronizado(s).`, 'success');
            await loadData();
        } else {
            showToast(`‚ùå Erro: ${data.error}`, 'error');
        }
    } catch (error) {
        console.error('Erro na sincroniza√ß√£o:', error);
        showToast('‚ùå Erro ao sincronizar campanhas', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

// ============================================================================
// MODAL CRIAR CAMPANHA
// ============================================================================
function openCreateCampaignModal() {
    const modal = new bootstrap.Modal(document.getElementById('createCampaignModal'));
    document.getElementById('createCampaignForm').reset();
    modal.show();
}

async function createCampaign() {
    const token = getCookie('session_token');
    const data = {
        name: document.getElementById('campaign-name').value,
        budget: parseFloat(document.getElementById('campaign-budget').value),
        bid_type: document.getElementById('campaign-bid-type').value,
        status: document.getElementById('campaign-status').value
    };
    
    if (!data.name || !data.budget) {
        showToast('‚ùå Preencha todos os campos obrigat√≥rios', 'error');
        return;
    }
    
    try {
        const response = await fetch('/ml/advertising/campaigns', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Cookie': `session_token=${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Campanha criada com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createCampaignModal')).hide();
            await loadData();
        } else {
            showToast(`‚ùå Erro: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erro ao criar campanha:', error);
        showToast('‚ùå Erro ao criar campanha', 'error');
    }
}

// ============================================================================
// GR√ÅFICOS COM CHART.JS
// ============================================================================
function initCharts() {
    // Gr√°fico de Investimento vs Retorno
    const investmentCtx = document.getElementById('investmentChart');
    if (investmentCtx) {
        investmentChart = new Chart(investmentCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Investimento',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Retorno',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Gr√°fico de ROAS por Campanha
    const roasCtx = document.getElementById('roasChart');
    if (roasCtx) {
        roasChart = new Chart(roasCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'ROAS',
                    data: [],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toFixed(2) + 'x';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'ROAS: ' + context.parsed.x.toFixed(2) + 'x';
                            }
                        }
                    }
                }
            }
        });
    }
}

async function updateCharts() {
    try {
        const token = getCookie('session_token');
        
        // Buscar dados de m√©tricas e campanhas
        const [metricsRes, campaignsRes] = await Promise.all([
            fetch('/ml/advertising/metrics', {
                headers: { 'Cookie': `session_token=${token}` }
            }),
            fetch('/ml/advertising/campaigns', {
                headers: { 'Cookie': `session_token=${token}` }
            })
        ]);
        
        const metricsData = await metricsRes.json();
        const campaignsData = await campaignsRes.json();
        
        // Atualizar gr√°fico de Investimento vs Retorno com dados das campanhas
        if (campaignsData.success && campaignsData.campaigns && investmentChart) {
            const campaigns = campaignsData.campaigns;
            
            // Somar investimento e retorno de todas as campanhas
            let totalInvestment = 0;
            let totalRevenue = 0;
            
            campaigns.forEach(c => {
                totalInvestment += c.total_spent || 0;
                totalRevenue += c.total_revenue || 0;
            });
            
            investmentChart.data.labels = ['√öltimos 30 dias'];
            investmentChart.data.datasets[0].data = [totalInvestment];
            investmentChart.data.datasets[1].data = [totalRevenue];
            investmentChart.update();
        }
        
        // Atualizar gr√°fico de ROAS por campanha
        if (campaignsData.success && campaignsData.campaigns) {
            const campaigns = campaignsData.campaigns
                .filter(c => c.roas && c.roas > 0)
                .sort((a, b) => b.roas - a.roas)
                .slice(0, 5); // Top 5 campanhas
            
            if (roasChart && campaigns.length > 0) {
                roasChart.data.labels = campaigns.map(c => c.name || 'N/A');
                roasChart.data.datasets[0].data = campaigns.map(c => c.roas || 0);
                roasChart.update();
            } else if (roasChart) {
                // Se n√£o houver campanhas com ROAS, mostrar mensagem
                roasChart.data.labels = ['Sem dados'];
                roasChart.data.datasets[0].data = [0];
                roasChart.update();
            }
        }
    } catch (error) {
        console.error('Erro ao atualizar gr√°ficos:', error);
    }
}

// ============================================================================
// A√á√ïES DE CAMPANHA
// ============================================================================
function viewCampaignDetails(campaignId) {
    showToast('Detalhes da campanha (em desenvolvimento)', 'info');
    console.log('Ver detalhes:', campaignId);
}

async function deleteCampaign(campaignId) {
    if (!confirm('‚ö†Ô∏è Deseja realmente deletar esta campanha?')) return;
    
    const token = getCookie('session_token');
    try {
        const response = await fetch(`/ml/advertising/campaigns/${campaignId}`, {
            method: 'DELETE',
            headers: {
                'Cookie': `session_token=${token}`
            }
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('‚úÖ Campanha deletada com sucesso!', 'success');
            await loadData();
        } else {
            showToast(`‚ùå Erro: ${result.error}`, 'error');
        }
    } catch (error) {
        console.error('Erro ao deletar:', error);
        showToast('‚ùå Erro ao deletar campanha', 'error');
    }
}
</script>
{% endblock %}


