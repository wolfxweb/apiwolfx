version: '3.8'

services:
  # API FastAPI
  api:
    build: .
    container_name: apiwolfx-api
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:97452c28f62db6d77be083917b698660@pgadmin.wolfx.com.br:5432/comercial}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - ML_APP_ID=${ML_APP_ID:-3821568023399477}
      - ML_CLIENT_SECRET=${ML_CLIENT_SECRET:-3gDZs9aLX9jmm64MCXPmdSIaCf7rBRHa}
      - ML_REDIRECT_URI=${ML_REDIRECT_URI:-https://53b830f49c00.ngrok-free.app/api/callback}
      - ML_NOTIFICATION_URL=${ML_NOTIFICATION_URL:-https://53b830f49c00.ngrok-free.app/api/notifications}
      # URLs Mercado Pago
      - MP_SUCCESS_URL=${MP_SUCCESS_URL:-https://53b830f49c00.ngrok-free.app/payment/success}
      - MP_FAILURE_URL=${MP_FAILURE_URL:-https://53b830f49c00.ngrok-free.app/payment/failure}
      - MP_PENDING_URL=${MP_PENDING_URL:-https://53b830f49c00.ngrok-free.app/payment/pending}
      - MP_WEBHOOK_URL=${MP_WEBHOOK_URL:-https://53b830f49c00.ngrok-free.app/api/payments/webhooks/mercadopago}
      # Credenciais Mercado Pago / OpenAI devem ser definidas no .env local
      - MP_ACCESS_TOKEN=${MP_ACCESS_TOKEN}
      - MP_PUBLIC_KEY=${MP_PUBLIC_KEY}
      - MP_WEBHOOK_SECRET=${MP_WEBHOOK_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - ./public:/app/public
    networks:
      - apiwolfx-network
    restart: unless-stopped


  # phpMyAdmin - REMOVIDO (usando PostgreSQL externo)
  # phpmyadmin:
  #   image: phpmyadmin/phpmyadmin:latest
  #   container_name: apiwolfx-phpmyadmin
  #   environment:
  #     PMA_HOST: db
  #     PMA_PORT: 3306
  #     PMA_USER: root
  #     PMA_PASSWORD: password
  #     MYSQL_ROOT_PASSWORD: password
  #   ports:
  #     - "8080:80"
  #   depends_on:
  #     - db
  #   networks:
  #     - apiwolfx-network
  #   restart: unless-stopped

  # ngrok (opcional)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: apiwolfx-ngrok
    command: "http api:8000"
    depends_on:
      - api
    networks:
      - apiwolfx-network
    restart: unless-stopped
    profiles:
      - ngrok


networks:
  apiwolfx-network:
    driver: bridge
